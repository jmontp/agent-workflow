<!DOCTYPE html>
<html>
<head>
    <title>Discord Chat Send Issue Diagnostic</title>
    <style>
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #1e1e1e;
            color: #e0e0e0;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        code {
            background: #000;
            padding: 2px 5px;
            border-radius: 3px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        #results {
            white-space: pre-wrap;
            font-family: monospace;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: 2px solid #444;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>üîç Discord Chat Send Issue Diagnostic</h1>
    
    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="runDiagnostic()">üöÄ Run Full Diagnostic</button>
        <button onclick="injectDebugCode()">üíâ Inject Debug Code</button>
        <button onclick="simulateSend()">üì§ Simulate Send</button>
        <button onclick="checkSocketIO()">üîå Check SocketIO</button>
        <button onclick="clearResults()">üßπ Clear Results</button>
    </div>
    
    <iframe id="testFrame" src="http://localhost:5000"></iframe>
    
    <div class="test-section">
        <h2>Diagnostic Results</h2>
        <div id="results"></div>
    </div>
    
    <script>
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            }[type] || '‚Ä¢';
            
            results.innerHTML += `<span class="${type}">[${timestamp}] ${prefix} ${message}</span>\n`;
            results.scrollTop = results.scrollHeight;
        }
        
        function clearResults() {
            results.innerHTML = '';
            log('Results cleared', 'info');
        }
        
        async function runDiagnostic() {
            log('Starting comprehensive diagnostic...', 'info');
            
            const frame = document.getElementById('testFrame');
            const frameDoc = frame.contentDocument || frame.contentWindow.document;
            const frameWin = frame.contentWindow;
            
            // Test 1: Check if elements exist
            log('\n=== Element Existence Test ===', 'info');
            const elements = {
                'chat-input-field': frameDoc.getElementById('chat-input-field'),
                'chat-send-btn': frameDoc.getElementById('chat-send-btn'),
                'chat-messages': frameDoc.getElementById('chat-messages'),
                'chat-panel': frameDoc.getElementById('chat-panel')
            };
            
            for (const [id, element] of Object.entries(elements)) {
                if (element) {
                    log(`Element #${id} found`, 'success');
                } else {
                    log(`Element #${id} NOT FOUND`, 'error');
                }
            }
            
            // Test 2: Check DiscordChat instance
            log('\n=== DiscordChat Instance Test ===', 'info');
            if (frameWin.discordChat) {
                log('window.discordChat exists', 'success');
                log(`User ID: ${frameWin.discordChat.userId}`, 'info');
                log(`Socket connected: ${frameWin.discordChat.socket?.connected}`, 'info');
            } else {
                log('window.discordChat NOT FOUND', 'error');
                
                // Check if class exists
                if (frameWin.DiscordChat) {
                    log('DiscordChat class exists but no instance', 'warning');
                } else {
                    log('DiscordChat class NOT FOUND', 'error');
                }
            }
            
            // Test 3: Check event listeners
            log('\n=== Event Listener Test ===', 'info');
            const input = elements['chat-input-field'];
            const button = elements['chat-send-btn'];
            
            if (input && button) {
                // Get current states
                log(`Input value: "${input.value}"`, 'info');
                log(`Button disabled: ${button.disabled}`, 'info');
                
                // Test input event
                input.value = 'Test message';
                input.dispatchEvent(new Event('input', { bubbles: true }));
                
                setTimeout(() => {
                    log(`After input event - Button disabled: ${button.disabled}`, 
                        button.disabled ? 'error' : 'success');
                }, 100);
            }
            
            // Test 4: Check for JavaScript errors
            log('\n=== JavaScript Error Check ===', 'info');
            frameWin.addEventListener('error', (e) => {
                log(`JS Error: ${e.message} at ${e.filename}:${e.lineno}`, 'error');
            });
            
            // Test 5: Check Socket.IO
            log('\n=== Socket.IO Test ===', 'info');
            if (frameWin.io) {
                log('Socket.IO library loaded', 'success');
                
                // Check for any sockets
                const sockets = frameWin.io.sockets || [];
                log(`Active sockets: ${Object.keys(sockets).length}`, 'info');
            } else {
                log('Socket.IO library NOT LOADED', 'error');
            }
        }
        
        function injectDebugCode() {
            log('Injecting debug code into frame...', 'info');
            
            const frame = document.getElementById('testFrame');
            const frameWin = frame.contentWindow;
            
            // Inject comprehensive debug code
            const debugCode = `
                console.log('üîç Debug injection started');
                
                // Override sendMessage to log calls
                if (window.discordChat) {
                    const originalSend = window.discordChat.sendMessage.bind(window.discordChat);
                    window.discordChat.sendMessage = function() {
                        console.log('üì§ sendMessage called!');
                        console.log('Arguments:', arguments);
                        console.log('Socket connected:', this.socket?.connected);
                        return originalSend.apply(this, arguments);
                    };
                    console.log('‚úÖ sendMessage override installed');
                }
                
                // Log all click events on send button
                const sendBtn = document.getElementById('chat-send-btn');
                if (sendBtn) {
                    sendBtn.addEventListener('click', (e) => {
                        console.log('üñ±Ô∏è Send button clicked!', e);
                        console.log('Button disabled:', e.target.disabled);
                    }, true);
                    console.log('‚úÖ Click listener added to send button');
                }
                
                // Log all socket emissions
                if (window.discordChat && window.discordChat.socket) {
                    const originalEmit = window.discordChat.socket.emit;
                    window.discordChat.socket.emit = function(event, data) {
                        console.log('üì° Socket emit:', event, data);
                        return originalEmit.apply(this, arguments);
                    };
                    console.log('‚úÖ Socket emit override installed');
                }
                
                // Monitor input changes
                const input = document.getElementById('chat-input-field');
                if (input) {
                    input.addEventListener('input', (e) => {
                        console.log('‚å®Ô∏è Input changed:', e.target.value);
                        const btn = document.getElementById('chat-send-btn');
                        console.log('Button disabled after input:', btn?.disabled);
                    });
                }
                
                console.log('‚úÖ Debug injection complete');
            `;
            
            try {
                frameWin.eval(debugCode);
                log('Debug code injected successfully', 'success');
                log('Check browser console (F12) for debug output', 'info');
            } catch (e) {
                log(`Failed to inject debug code: ${e.message}`, 'error');
            }
        }
        
        function simulateSend() {
            log('Simulating send action...', 'info');
            
            const frame = document.getElementById('testFrame');
            const frameDoc = frame.contentDocument;
            const frameWin = frame.contentWindow;
            
            const input = frameDoc.getElementById('chat-input-field');
            const button = frameDoc.getElementById('chat-send-btn');
            
            if (!input || !button) {
                log('Required elements not found', 'error');
                return;
            }
            
            // Set input value
            input.value = 'Test message from diagnostic';
            input.dispatchEvent(new Event('input', { bubbles: true }));
            
            setTimeout(() => {
                log(`Input value set to: "${input.value}"`, 'success');
                log(`Button disabled: ${button.disabled}`, button.disabled ? 'error' : 'info');
                
                if (!button.disabled) {
                    log('Clicking send button...', 'info');
                    button.click();
                    
                    setTimeout(() => {
                        log(`Input value after click: "${input.value}"`, 'info');
                        log('Check if message appeared in chat', 'info');
                    }, 500);
                } else {
                    log('Button is disabled, cannot click', 'error');
                    
                    // Try to force enable and click
                    log('Forcing button enable...', 'warning');
                    button.disabled = false;
                    button.click();
                }
            }, 100);
        }
        
        function checkSocketIO() {
            log('Checking Socket.IO connection...', 'info');
            
            const frame = document.getElementById('testFrame');
            const frameWin = frame.contentWindow;
            
            if (!frameWin.io) {
                log('Socket.IO not loaded', 'error');
                return;
            }
            
            // Try to access the socket directly
            if (frameWin.discordChat && frameWin.discordChat.socket) {
                const socket = frameWin.discordChat.socket;
                log(`Socket ID: ${socket.id}`, 'info');
                log(`Socket connected: ${socket.connected}`, socket.connected ? 'success' : 'error');
                log(`Socket disconnected: ${socket.disconnected}`, 'info');
                
                // Try to emit a test message
                try {
                    socket.emit('chat_command', {
                        message: 'Test from diagnostic',
                        user_id: 'diagnostic_test',
                        username: 'Diagnostic',
                        session_id: null,
                        project_name: 'default'
                    });
                    log('Test message emitted', 'success');
                } catch (e) {
                    log(`Failed to emit: ${e.message}`, 'error');
                }
            } else {
                log('No socket found on discordChat instance', 'error');
            }
        }
        
        // Auto-run diagnostic after page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('Page loaded, waiting for iframe...', 'info');
                setTimeout(runDiagnostic, 2000);
            }, 1000);
        });
    </script>
</body>
</html>