
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Human-In-The-Loop orchestration framework for AI-assisted software development" name="description"/>
<meta content="AI Agent Workflow Team" name="author"/>
<link href="https://jmontp.github.io/agent-workflow/architecture/context-algorithms/" rel="canonical"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>Context Management Algorithms and Research - AI Agent TDD-Scrum Workflow</title>
<link href="../../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="blue" data-md-color-primary="blue" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#context-management-algorithms-and-research">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="AI Agent TDD-Scrum Workflow" class="md-header__button md-logo" data-md-component="logo" href="../.." title="AI Agent TDD-Scrum Workflow">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            AI Agent TDD-Scrum Workflow
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Context Management Algorithms and Research
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="blue" data-md-color-media="" data-md-color-primary="blue" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="blue" data-md-color-media="" data-md-color-primary="blue" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/jmontp/agent-workflow" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    jmontp/agent-workflow
  </div>
</a>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../getting-started/quick-start/">
          
  
  
  Getting Started

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../user-guide/hitl-commands/">
          
  
  
  User Guide

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../concepts/overview/">
          
  
  
  Concepts

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../advanced/context/">
          
  
  
  Advanced

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../overview/">
          
  
  
  Architecture

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../development/contributing/">
          
  
  
  Development

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../deployment/discord-setup/">
          
  
  
  Deployment

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="AI Agent TDD-Scrum Workflow" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="AI Agent TDD-Scrum Workflow">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    AI Agent TDD-Scrum Workflow
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/jmontp/agent-workflow" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    jmontp/agent-workflow
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Getting Started
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting-started/quick-start/">
<span class="md-ellipsis">
    Quick Start
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting-started/installation/">
<span class="md-ellipsis">
    Installation
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting-started/configuration/">
<span class="md-ellipsis">
    Configuration
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    User Guide
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/hitl-commands/">
<span class="md-ellipsis">
    HITL Commands
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/state-machine/">
<span class="md-ellipsis">
    State Machine
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/tdd-workflow/">
<span class="md-ellipsis">
    TDD Workflow
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/project-setup/">
<span class="md-ellipsis">
    Project Setup
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/workflow-sequences/">
<span class="md-ellipsis">
    Workflow Sequences
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/user-profile/">
<span class="md-ellipsis">
    User Profile
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/troubleshooting/">
<span class="md-ellipsis">
    Troubleshooting
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/faq/">
<span class="md-ellipsis">
    FAQ
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-ellipsis">
    Concepts
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../concepts/overview/">
<span class="md-ellipsis">
    System Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../concepts/security/">
<span class="md-ellipsis">
    Security Model
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
<span class="md-ellipsis">
    Advanced
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Advanced
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../advanced/context/">
<span class="md-ellipsis">
    Context Diagram
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../advanced/architecture-detailed/">
<span class="md-ellipsis">
    Detailed Architecture
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../advanced/container/">
<span class="md-ellipsis">
    Container Architecture
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../advanced/component/">
<span class="md-ellipsis">
    System Components
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../advanced/data-flow/">
<span class="md-ellipsis">
    Data Flow
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../advanced/orchestration-repo/">
<span class="md-ellipsis">
    Orchestration Repository
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../advanced/project-repo/">
<span class="md-ellipsis">
    Project Repository
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../advanced/security-implementation/">
<span class="md-ellipsis">
    Security Implementation
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../advanced/testing/">
<span class="md-ellipsis">
    Testing Strategy
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../advanced/code/">
<span class="md-ellipsis">
    Code Structure
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
<span class="md-ellipsis">
    Architecture
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../overview/">
<span class="md-ellipsis">
    System Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../context-management-system/">
<span class="md-ellipsis">
    Context Management
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../parallel-tdd-architecture/">
<span class="md-ellipsis">
    Parallel TDD Design
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
<span class="md-ellipsis">
    Development
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_7_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_7">
<span class="md-nav__icon md-icon"></span>
            Development
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../development/contributing/">
<span class="md-ellipsis">
    Contributing
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../development/api-reference/">
<span class="md-ellipsis">
    API Reference
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
<span class="md-ellipsis">
    Deployment
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_8_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_8">
<span class="md-nav__icon md-icon"></span>
            Deployment
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../deployment/discord-setup/">
<span class="md-ellipsis">
    Discord Setup
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../deployment/production/">
<span class="md-ellipsis">
    Production Deployment
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../deployment/github-pages/">
<span class="md-ellipsis">
    GitHub Pages
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      Overview
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#relevance-scoring-algorithm">
<span class="md-ellipsis">
      Relevance Scoring Algorithm
    </span>
</a>
<nav aria-label="Relevance Scoring Algorithm" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#multi-factor-relevance-scoring">
<span class="md-ellipsis">
      Multi-Factor Relevance Scoring
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#component-algorithms">
<span class="md-ellipsis">
      Component Algorithms
    </span>
</a>
<nav aria-label="Component Algorithms" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#direct-mention-scoring">
<span class="md-ellipsis">
      Direct Mention Scoring
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dependency-analysis-scoring">
<span class="md-ellipsis">
      Dependency Analysis Scoring
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#historical-relevance-scoring">
<span class="md-ellipsis">
      Historical Relevance Scoring
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#semantic-similarity-scoring">
<span class="md-ellipsis">
      Semantic Similarity Scoring
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#content-compression-algorithms">
<span class="md-ellipsis">
      Content Compression Algorithms
    </span>
</a>
<nav aria-label="Content Compression Algorithms" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#adaptive-python-code-compression">
<span class="md-ellipsis">
      Adaptive Python Code Compression
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#test-file-compression">
<span class="md-ellipsis">
      Test File Compression
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#token-budget-allocation-algorithm">
<span class="md-ellipsis">
      Token Budget Allocation Algorithm
    </span>
</a>
<nav aria-label="Token Budget Allocation Algorithm" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#dynamic-budget-allocation">
<span class="md-ellipsis">
      Dynamic Budget Allocation
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dependency-analysis-algorithm">
<span class="md-ellipsis">
      Dependency Analysis Algorithm
    </span>
</a>
<nav aria-label="Dependency Analysis Algorithm" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#static-dependency-analysis">
<span class="md-ellipsis">
      Static Dependency Analysis
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#caching-and-performance-algorithms">
<span class="md-ellipsis">
      Caching and Performance Algorithms
    </span>
</a>
<nav aria-label="Caching and Performance Algorithms" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#intelligent-cache-management">
<span class="md-ellipsis">
      Intelligent Cache Management
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="context-management-algorithms-and-research">Context Management Algorithms and Research<a class="headerlink" href="#context-management-algorithms-and-research" title="Permanent link">¶</a></h1>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">¶</a></h2>
<p>This document details the core algorithms powering the Context Management System, including relevance scoring, content compression, dependency analysis, and token optimization. Each algorithm is designed to address specific challenges in managing context for AI agents while respecting token limitations.</p>
<h2 id="relevance-scoring-algorithm">Relevance Scoring Algorithm<a class="headerlink" href="#relevance-scoring-algorithm" title="Permanent link">¶</a></h2>
<h3 id="multi-factor-relevance-scoring">Multi-Factor Relevance Scoring<a class="headerlink" href="#multi-factor-relevance-scoring" title="Permanent link">¶</a></h3>
<p>The relevance scoring algorithm combines multiple factors to determine how relevant a file is to the current task context.</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span> <span class="nf">calculate_relevance_score</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">TDDTask</span><span class="p">,</span> 
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>                            <span class="n">context</span><span class="p">:</span> <span class="n">ContextRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="sd">"""</span>
<a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="sd">    Calculate multi-factor relevance score (0.0 to 1.0)</span>
<a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="sd">    Factors:</span>
<a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="sd">    - Direct mention (40% weight): File explicitly referenced in task</span>
<a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="sd">    - Dependency analysis (25% weight): Code dependencies and imports</span>
<a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="sd">    - Historical relevance (20% weight): Past usage patterns</span>
<a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="sd">    - Semantic similarity (10% weight): Content similarity to task</span>
<a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="sd">    - TDD phase relevance (5% weight): Phase-specific importance</span>
<a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    """</span>
<a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="c1"># Factor 1: Direct mention in task description or files</span>
<a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="n">direct_mention_score</span> <span class="o">=</span> <span class="n">calculate_direct_mention_score</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
<a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="c1"># Factor 2: Static dependency analysis</span>
<a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="n">dependency_score</span> <span class="o">=</span> <span class="n">calculate_dependency_score</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">source_files</span><span class="p">)</span>
<a href="#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a>
<a href="#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="c1"># Factor 3: Historical usage patterns</span>
<a href="#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="n">historical_score</span> <span class="o">=</span> <span class="n">calculate_historical_relevance</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">agent_type</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">story_id</span><span class="p">)</span>
<a href="#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a href="#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="c1"># Factor 4: Semantic content similarity</span>
<a href="#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">semantic_score</span> <span class="o">=</span> <span class="n">calculate_semantic_similarity</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
<a href="#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a href="#__codelineno-0-26" id="__codelineno-0-26" name="__codelineno-0-26"></a>    <span class="c1"># Factor 5: TDD phase-specific relevance</span>
<a href="#__codelineno-0-27" id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="n">phase_score</span> <span class="o">=</span> <span class="n">calculate_phase_relevance</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">current_state</span><span class="p">)</span>
<a href="#__codelineno-0-28" id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a href="#__codelineno-0-29" id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="c1"># Weighted combination</span>
<a href="#__codelineno-0-30" id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">total_score</span> <span class="o">=</span> <span class="p">(</span>
<a href="#__codelineno-0-31" id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="mf">0.40</span> <span class="o">*</span> <span class="n">direct_mention_score</span> <span class="o">+</span>
<a href="#__codelineno-0-32" id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="mf">0.25</span> <span class="o">*</span> <span class="n">dependency_score</span> <span class="o">+</span>
<a href="#__codelineno-0-33" id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="mf">0.20</span> <span class="o">*</span> <span class="n">historical_score</span> <span class="o">+</span>
<a href="#__codelineno-0-34" id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="mf">0.10</span> <span class="o">*</span> <span class="n">semantic_score</span> <span class="o">+</span>
<a href="#__codelineno-0-35" id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="mf">0.05</span> <span class="o">*</span> <span class="n">phase_score</span>
<a href="#__codelineno-0-36" id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="p">)</span>
<a href="#__codelineno-0-37" id="__codelineno-0-37" name="__codelineno-0-37"></a>
<a href="#__codelineno-0-38" id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="c1"># Apply boost factors</span>
<a href="#__codelineno-0-39" id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="n">boost_factor</span> <span class="o">=</span> <span class="n">calculate_boost_factors</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
<a href="#__codelineno-0-40" id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a href="#__codelineno-0-41" id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">total_score</span> <span class="o">*</span> <span class="n">boost_factor</span><span class="p">)</span>
</code></pre></div>
<h3 id="component-algorithms">Component Algorithms<a class="headerlink" href="#component-algorithms" title="Permanent link">¶</a></h3>
<h4 id="direct-mention-scoring">Direct Mention Scoring<a class="headerlink" href="#direct-mention-scoring" title="Permanent link">¶</a></h4>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">def</span> <span class="nf">calculate_direct_mention_score</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">TDDTask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="sd">"""Calculate score based on direct mentions of file in task context"""</span>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>    <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a>    <span class="c1"># Check if file is explicitly mentioned in task description</span>
<a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>    <span class="k">if</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">description</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
<a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>        <span class="n">score</span> <span class="o">+=</span> <span class="mf">0.8</span>
<a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>
<a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>    <span class="c1"># Check if file is in task source files</span>
<a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>    <span class="k">if</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">source_files</span><span class="p">:</span>
<a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a>        <span class="n">score</span> <span class="o">+=</span> <span class="mf">1.0</span>
<a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a>
<a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a>    <span class="c1"># Check if file is in test files</span>
<a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a>    <span class="k">if</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">test_files</span><span class="p">:</span>
<a href="#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a>        <span class="n">score</span> <span class="o">+=</span> <span class="mf">0.9</span>
<a href="#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a>
<a href="#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a>    <span class="c1"># Check for file name mentions in acceptance criteria</span>
<a href="#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a>    <span class="k">for</span> <span class="n">criteria</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">acceptance_criteria</span><span class="p">:</span>
<a href="#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="ow">in</span> <span class="n">criteria</span><span class="p">:</span>
<a href="#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a>            <span class="n">score</span> <span class="o">+=</span> <span class="mf">0.6</span>
<a href="#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a>
<a href="#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a>    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span>
</code></pre></div>
<h4 id="dependency-analysis-scoring">Dependency Analysis Scoring<a class="headerlink" href="#dependency-analysis-scoring" title="Permanent link">¶</a></h4>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">def</span> <span class="nf">calculate_dependency_score</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">source_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="sd">"""Calculate relevance based on code dependencies"""</span>
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a>    <span class="c1"># Get direct dependencies (imports)</span>
<a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a>    <span class="n">direct_deps</span> <span class="o">=</span> <span class="n">get_direct_dependencies</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a>
<a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a>    <span class="c1"># Get reverse dependencies (what imports this file)</span>
<a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a>    <span class="n">reverse_deps</span> <span class="o">=</span> <span class="n">get_reverse_dependencies</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<a href="#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a>
<a href="#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a>    <span class="c1"># Calculate overlap with task source files</span>
<a href="#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a>    <span class="n">source_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">source_files</span><span class="p">)</span>
<a href="#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a>
<a href="#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a>    <span class="c1"># Score based on direct dependencies overlap</span>
<a href="#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a>    <span class="n">direct_overlap</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">direct_deps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">source_set</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">direct_deps</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<a href="#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a>
<a href="#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a>    <span class="c1"># Score based on reverse dependencies overlap</span>
<a href="#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a>    <span class="n">reverse_overlap</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">reverse_deps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">source_set</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reverse_deps</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<a href="#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a>
<a href="#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a>    <span class="c1"># Calculate transitive dependency score</span>
<a href="#__codelineno-2-20" id="__codelineno-2-20" name="__codelineno-2-20"></a>    <span class="n">transitive_score</span> <span class="o">=</span> <span class="n">calculate_transitive_dependency_score</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">source_files</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<a href="#__codelineno-2-21" id="__codelineno-2-21" name="__codelineno-2-21"></a>
<a href="#__codelineno-2-22" id="__codelineno-2-22" name="__codelineno-2-22"></a>    <span class="c1"># Weighted combination</span>
<a href="#__codelineno-2-23" id="__codelineno-2-23" name="__codelineno-2-23"></a>    <span class="n">dependency_score</span> <span class="o">=</span> <span class="p">(</span>
<a href="#__codelineno-2-24" id="__codelineno-2-24" name="__codelineno-2-24"></a>        <span class="mf">0.5</span> <span class="o">*</span> <span class="n">direct_overlap</span> <span class="o">+</span>
<a href="#__codelineno-2-25" id="__codelineno-2-25" name="__codelineno-2-25"></a>        <span class="mf">0.3</span> <span class="o">*</span> <span class="n">reverse_overlap</span> <span class="o">+</span>
<a href="#__codelineno-2-26" id="__codelineno-2-26" name="__codelineno-2-26"></a>        <span class="mf">0.2</span> <span class="o">*</span> <span class="n">transitive_score</span>
<a href="#__codelineno-2-27" id="__codelineno-2-27" name="__codelineno-2-27"></a>    <span class="p">)</span>
<a href="#__codelineno-2-28" id="__codelineno-2-28" name="__codelineno-2-28"></a>
<a href="#__codelineno-2-29" id="__codelineno-2-29" name="__codelineno-2-29"></a>    <span class="k">return</span> <span class="n">dependency_score</span>
<a href="#__codelineno-2-30" id="__codelineno-2-30" name="__codelineno-2-30"></a>
<a href="#__codelineno-2-31" id="__codelineno-2-31" name="__codelineno-2-31"></a><span class="k">def</span> <span class="nf">get_direct_dependencies</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a href="#__codelineno-2-32" id="__codelineno-2-32" name="__codelineno-2-32"></a><span class="w">    </span><span class="sd">"""Extract direct dependencies from Python file"""</span>
<a href="#__codelineno-2-33" id="__codelineno-2-33" name="__codelineno-2-33"></a>    <span class="k">try</span><span class="p">:</span>
<a href="#__codelineno-2-34" id="__codelineno-2-34" name="__codelineno-2-34"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a href="#__codelineno-2-35" id="__codelineno-2-35" name="__codelineno-2-35"></a>            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a href="#__codelineno-2-36" id="__codelineno-2-36" name="__codelineno-2-36"></a>
<a href="#__codelineno-2-37" id="__codelineno-2-37" name="__codelineno-2-37"></a>        <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<a href="#__codelineno-2-38" id="__codelineno-2-38" name="__codelineno-2-38"></a>        <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-2-39" id="__codelineno-2-39" name="__codelineno-2-39"></a>
<a href="#__codelineno-2-40" id="__codelineno-2-40" name="__codelineno-2-40"></a>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
<a href="#__codelineno-2-41" id="__codelineno-2-41" name="__codelineno-2-41"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Import</span><span class="p">):</span>
<a href="#__codelineno-2-42" id="__codelineno-2-42" name="__codelineno-2-42"></a>                <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
<a href="#__codelineno-2-43" id="__codelineno-2-43" name="__codelineno-2-43"></a>                    <span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alias</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<a href="#__codelineno-2-44" id="__codelineno-2-44" name="__codelineno-2-44"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ImportFrom</span><span class="p">):</span>
<a href="#__codelineno-2-45" id="__codelineno-2-45" name="__codelineno-2-45"></a>                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">module</span><span class="p">:</span>
<a href="#__codelineno-2-46" id="__codelineno-2-46" name="__codelineno-2-46"></a>                    <span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">module</span><span class="p">)</span>
<a href="#__codelineno-2-47" id="__codelineno-2-47" name="__codelineno-2-47"></a>
<a href="#__codelineno-2-48" id="__codelineno-2-48" name="__codelineno-2-48"></a>        <span class="c1"># Convert module names to file paths</span>
<a href="#__codelineno-2-49" id="__codelineno-2-49" name="__codelineno-2-49"></a>        <span class="k">return</span> <span class="n">resolve_module_paths</span><span class="p">(</span><span class="n">dependencies</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
<a href="#__codelineno-2-50" id="__codelineno-2-50" name="__codelineno-2-50"></a>
<a href="#__codelineno-2-51" id="__codelineno-2-51" name="__codelineno-2-51"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a href="#__codelineno-2-52" id="__codelineno-2-52" name="__codelineno-2-52"></a>        <span class="k">return</span> <span class="p">[]</span>
</code></pre></div>
<h4 id="historical-relevance-scoring">Historical Relevance Scoring<a class="headerlink" href="#historical-relevance-scoring" title="Permanent link">¶</a></h4>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">def</span> <span class="nf">calculate_historical_relevance</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">agent_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">story_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="sd">"""Calculate relevance based on historical usage patterns"""</span>
<a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>
<a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>    <span class="c1"># Get historical access patterns</span>
<a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>    <span class="n">access_history</span> <span class="o">=</span> <span class="n">get_file_access_history</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">agent_type</span><span class="p">)</span>
<a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>
<a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>    <span class="c1"># Get similar story patterns</span>
<a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a>    <span class="n">similar_stories</span> <span class="o">=</span> <span class="n">get_similar_story_files</span><span class="p">(</span><span class="n">story_id</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
<a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a>
<a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a>    <span class="c1"># Calculate access frequency score</span>
<a href="#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>    <span class="n">frequency_score</span> <span class="o">=</span> <span class="n">calculate_access_frequency_score</span><span class="p">(</span><span class="n">access_history</span><span class="p">)</span>
<a href="#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a>
<a href="#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>    <span class="c1"># Calculate recency score (more recent = higher score)</span>
<a href="#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a>    <span class="n">recency_score</span> <span class="o">=</span> <span class="n">calculate_recency_score</span><span class="p">(</span><span class="n">access_history</span><span class="p">)</span>
<a href="#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a>
<a href="#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a>    <span class="c1"># Calculate similar story score</span>
<a href="#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a>    <span class="n">similarity_score</span> <span class="o">=</span> <span class="n">calculate_story_similarity_score</span><span class="p">(</span><span class="n">similar_stories</span><span class="p">)</span>
<a href="#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a>
<a href="#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a>    <span class="c1"># Weighted combination</span>
<a href="#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a>    <span class="n">historical_score</span> <span class="o">=</span> <span class="p">(</span>
<a href="#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a>        <span class="mf">0.4</span> <span class="o">*</span> <span class="n">frequency_score</span> <span class="o">+</span>
<a href="#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a>        <span class="mf">0.3</span> <span class="o">*</span> <span class="n">recency_score</span> <span class="o">+</span>
<a href="#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a>        <span class="mf">0.3</span> <span class="o">*</span> <span class="n">similarity_score</span>
<a href="#__codelineno-3-24" id="__codelineno-3-24" name="__codelineno-3-24"></a>    <span class="p">)</span>
<a href="#__codelineno-3-25" id="__codelineno-3-25" name="__codelineno-3-25"></a>
<a href="#__codelineno-3-26" id="__codelineno-3-26" name="__codelineno-3-26"></a>    <span class="k">return</span> <span class="n">historical_score</span>
<a href="#__codelineno-3-27" id="__codelineno-3-27" name="__codelineno-3-27"></a>
<a href="#__codelineno-3-28" id="__codelineno-3-28" name="__codelineno-3-28"></a><span class="k">def</span> <span class="nf">calculate_access_frequency_score</span><span class="p">(</span><span class="n">access_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a href="#__codelineno-3-29" id="__codelineno-3-29" name="__codelineno-3-29"></a><span class="w">    </span><span class="sd">"""Score based on how frequently file has been accessed"""</span>
<a href="#__codelineno-3-30" id="__codelineno-3-30" name="__codelineno-3-30"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">access_history</span><span class="p">:</span>
<a href="#__codelineno-3-31" id="__codelineno-3-31" name="__codelineno-3-31"></a>        <span class="k">return</span> <span class="mf">0.0</span>
<a href="#__codelineno-3-32" id="__codelineno-3-32" name="__codelineno-3-32"></a>
<a href="#__codelineno-3-33" id="__codelineno-3-33" name="__codelineno-3-33"></a>    <span class="c1"># Count accesses in different time windows</span>
<a href="#__codelineno-3-34" id="__codelineno-3-34" name="__codelineno-3-34"></a>    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a href="#__codelineno-3-35" id="__codelineno-3-35" name="__codelineno-3-35"></a>
<a href="#__codelineno-3-36" id="__codelineno-3-36" name="__codelineno-3-36"></a>    <span class="n">recent_accesses</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">access</span> <span class="ow">in</span> <span class="n">access_history</span> 
<a href="#__codelineno-3-37" id="__codelineno-3-37" name="__codelineno-3-37"></a>                         <span class="k">if</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">access</span><span class="p">[</span><span class="s1">'timestamp'</span><span class="p">])</span><span class="o">.</span><span class="n">days</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)</span>
<a href="#__codelineno-3-38" id="__codelineno-3-38" name="__codelineno-3-38"></a>    <span class="n">total_accesses</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">access_history</span><span class="p">)</span>
<a href="#__codelineno-3-39" id="__codelineno-3-39" name="__codelineno-3-39"></a>
<a href="#__codelineno-3-40" id="__codelineno-3-40" name="__codelineno-3-40"></a>    <span class="c1"># Normalize based on total project activity</span>
<a href="#__codelineno-3-41" id="__codelineno-3-41" name="__codelineno-3-41"></a>    <span class="n">project_activity</span> <span class="o">=</span> <span class="n">get_project_activity_baseline</span><span class="p">()</span>
<a href="#__codelineno-3-42" id="__codelineno-3-42" name="__codelineno-3-42"></a>
<a href="#__codelineno-3-43" id="__codelineno-3-43" name="__codelineno-3-43"></a>    <span class="n">frequency_ratio</span> <span class="o">=</span> <span class="n">total_accesses</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">project_activity</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a href="#__codelineno-3-44" id="__codelineno-3-44" name="__codelineno-3-44"></a>    <span class="n">recency_boost</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">recent_accesses</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># Boost for recent activity</span>
<a href="#__codelineno-3-45" id="__codelineno-3-45" name="__codelineno-3-45"></a>
<a href="#__codelineno-3-46" id="__codelineno-3-46" name="__codelineno-3-46"></a>    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">frequency_ratio</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">recency_boost</span><span class="p">))</span>
</code></pre></div>
<h4 id="semantic-similarity-scoring">Semantic Similarity Scoring<a class="headerlink" href="#semantic-similarity-scoring" title="Permanent link">¶</a></h4>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">def</span> <span class="nf">calculate_semantic_similarity</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">task_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">    </span><span class="sd">"""Calculate semantic similarity between file content and task description"""</span>
<a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>
<a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>    <span class="c1"># Extract key content from file</span>
<a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a>    <span class="n">file_content</span> <span class="o">=</span> <span class="n">extract_file_summary</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a>
<a href="#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>    <span class="c1"># Use sentence embeddings for similarity</span>
<a href="#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a>    <span class="n">task_embedding</span> <span class="o">=</span> <span class="n">get_sentence_embedding</span><span class="p">(</span><span class="n">task_description</span><span class="p">)</span>
<a href="#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a>    <span class="n">file_embedding</span> <span class="o">=</span> <span class="n">get_sentence_embedding</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
<a href="#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a>
<a href="#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a>    <span class="c1"># Calculate cosine similarity</span>
<a href="#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a>    <span class="n">similarity</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">task_embedding</span><span class="p">,</span> <span class="n">file_embedding</span><span class="p">)</span>
<a href="#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a>
<a href="#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a>    <span class="c1"># Apply content type boosts</span>
<a href="#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a>    <span class="n">content_boost</span> <span class="o">=</span> <span class="n">get_content_type_boost</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">task_description</span><span class="p">)</span>
<a href="#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a>
<a href="#__codelineno-4-17" id="__codelineno-4-17" name="__codelineno-4-17"></a>    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">similarity</span> <span class="o">*</span> <span class="n">content_boost</span><span class="p">)</span>
<a href="#__codelineno-4-18" id="__codelineno-4-18" name="__codelineno-4-18"></a>
<a href="#__codelineno-4-19" id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="k">def</span> <span class="nf">extract_file_summary</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a href="#__codelineno-4-20" id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="w">    </span><span class="sd">"""Extract meaningful summary from file for semantic analysis"""</span>
<a href="#__codelineno-4-21" id="__codelineno-4-21" name="__codelineno-4-21"></a>
<a href="#__codelineno-4-22" id="__codelineno-4-22" name="__codelineno-4-22"></a>    <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'.py'</span><span class="p">):</span>
<a href="#__codelineno-4-23" id="__codelineno-4-23" name="__codelineno-4-23"></a>        <span class="k">return</span> <span class="n">extract_python_summary</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<a href="#__codelineno-4-24" id="__codelineno-4-24" name="__codelineno-4-24"></a>    <span class="k">elif</span> <span class="n">file_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'.md'</span><span class="p">):</span>
<a href="#__codelineno-4-25" id="__codelineno-4-25" name="__codelineno-4-25"></a>        <span class="k">return</span> <span class="n">extract_markdown_summary</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<a href="#__codelineno-4-26" id="__codelineno-4-26" name="__codelineno-4-26"></a>    <span class="k">elif</span> <span class="n">file_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s1">'.yml'</span><span class="p">,</span> <span class="s1">'.yaml'</span><span class="p">)):</span>
<a href="#__codelineno-4-27" id="__codelineno-4-27" name="__codelineno-4-27"></a>        <span class="k">return</span> <span class="n">extract_yaml_summary</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<a href="#__codelineno-4-28" id="__codelineno-4-28" name="__codelineno-4-28"></a>    <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-4-29" id="__codelineno-4-29" name="__codelineno-4-29"></a>        <span class="k">return</span> <span class="n">extract_generic_summary</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<a href="#__codelineno-4-30" id="__codelineno-4-30" name="__codelineno-4-30"></a>
<a href="#__codelineno-4-31" id="__codelineno-4-31" name="__codelineno-4-31"></a><span class="k">def</span> <span class="nf">extract_python_summary</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a href="#__codelineno-4-32" id="__codelineno-4-32" name="__codelineno-4-32"></a><span class="w">    </span><span class="sd">"""Extract Python file summary including docstrings and key elements"""</span>
<a href="#__codelineno-4-33" id="__codelineno-4-33" name="__codelineno-4-33"></a>    <span class="k">try</span><span class="p">:</span>
<a href="#__codelineno-4-34" id="__codelineno-4-34" name="__codelineno-4-34"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a href="#__codelineno-4-35" id="__codelineno-4-35" name="__codelineno-4-35"></a>            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a href="#__codelineno-4-36" id="__codelineno-4-36" name="__codelineno-4-36"></a>
<a href="#__codelineno-4-37" id="__codelineno-4-37" name="__codelineno-4-37"></a>        <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<a href="#__codelineno-4-38" id="__codelineno-4-38" name="__codelineno-4-38"></a>        <span class="n">summary_parts</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-4-39" id="__codelineno-4-39" name="__codelineno-4-39"></a>
<a href="#__codelineno-4-40" id="__codelineno-4-40" name="__codelineno-4-40"></a>        <span class="c1"># Extract module docstring</span>
<a href="#__codelineno-4-41" id="__codelineno-4-41" name="__codelineno-4-41"></a>        <span class="k">if</span> <span class="n">ast</span><span class="o">.</span><span class="n">get_docstring</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
<a href="#__codelineno-4-42" id="__codelineno-4-42" name="__codelineno-4-42"></a>            <span class="n">summary_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">get_docstring</span><span class="p">(</span><span class="n">tree</span><span class="p">))</span>
<a href="#__codelineno-4-43" id="__codelineno-4-43" name="__codelineno-4-43"></a>
<a href="#__codelineno-4-44" id="__codelineno-4-44" name="__codelineno-4-44"></a>        <span class="c1"># Extract class and function names and docstrings</span>
<a href="#__codelineno-4-45" id="__codelineno-4-45" name="__codelineno-4-45"></a>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
<a href="#__codelineno-4-46" id="__codelineno-4-46" name="__codelineno-4-46"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">)):</span>
<a href="#__codelineno-4-47" id="__codelineno-4-47" name="__codelineno-4-47"></a>                <span class="n">summary_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<a href="#__codelineno-4-48" id="__codelineno-4-48" name="__codelineno-4-48"></a>                <span class="k">if</span> <span class="n">ast</span><span class="o">.</span><span class="n">get_docstring</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
<a href="#__codelineno-4-49" id="__codelineno-4-49" name="__codelineno-4-49"></a>                    <span class="n">summary_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">get_docstring</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
<a href="#__codelineno-4-50" id="__codelineno-4-50" name="__codelineno-4-50"></a>
<a href="#__codelineno-4-51" id="__codelineno-4-51" name="__codelineno-4-51"></a>        <span class="c1"># Extract comments</span>
<a href="#__codelineno-4-52" id="__codelineno-4-52" name="__codelineno-4-52"></a>        <span class="n">comments</span> <span class="o">=</span> <span class="n">extract_comments</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<a href="#__codelineno-4-53" id="__codelineno-4-53" name="__codelineno-4-53"></a>        <span class="n">summary_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">comments</span><span class="p">)</span>
<a href="#__codelineno-4-54" id="__codelineno-4-54" name="__codelineno-4-54"></a>
<a href="#__codelineno-4-55" id="__codelineno-4-55" name="__codelineno-4-55"></a>        <span class="k">return</span> <span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary_parts</span><span class="p">)</span>
<a href="#__codelineno-4-56" id="__codelineno-4-56" name="__codelineno-4-56"></a>
<a href="#__codelineno-4-57" id="__codelineno-4-57" name="__codelineno-4-57"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a href="#__codelineno-4-58" id="__codelineno-4-58" name="__codelineno-4-58"></a>        <span class="k">return</span> <span class="s2">""</span>
</code></pre></div>
<h2 id="content-compression-algorithms">Content Compression Algorithms<a class="headerlink" href="#content-compression-algorithms" title="Permanent link">¶</a></h2>
<h3 id="adaptive-python-code-compression">Adaptive Python Code Compression<a class="headerlink" href="#adaptive-python-code-compression" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">def</span> <span class="nf">compress_python_code</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_tokens</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
<a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a>                        <span class="n">preserve_structure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CompressionResult</span><span class="p">:</span>
<a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">    </span><span class="sd">"""</span>
<a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="sd">    Compress Python code while preserving semantic meaning and structure</span>
<a href="#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a>
<a href="#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="sd">    Compression Strategy:</span>
<a href="#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="sd">    1. Parse AST to understand code structure</span>
<a href="#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="sd">    2. Identify critical elements (classes, functions, key logic)</span>
<a href="#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="sd">    3. Remove or summarize non-critical elements</span>
<a href="#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="sd">    4. Reconstruct code with preserved structure</span>
<a href="#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="sd">    """</span>
<a href="#__codelineno-5-12" id="__codelineno-5-12" name="__codelineno-5-12"></a>
<a href="#__codelineno-5-13" id="__codelineno-5-13" name="__codelineno-5-13"></a>    <span class="n">original_tokens</span> <span class="o">=</span> <span class="n">estimate_tokens</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<a href="#__codelineno-5-14" id="__codelineno-5-14" name="__codelineno-5-14"></a>
<a href="#__codelineno-5-15" id="__codelineno-5-15" name="__codelineno-5-15"></a>    <span class="k">if</span> <span class="n">original_tokens</span> <span class="o">&lt;=</span> <span class="n">target_tokens</span><span class="p">:</span>
<a href="#__codelineno-5-16" id="__codelineno-5-16" name="__codelineno-5-16"></a>        <span class="k">return</span> <span class="n">CompressionResult</span><span class="p">(</span>
<a href="#__codelineno-5-17" id="__codelineno-5-17" name="__codelineno-5-17"></a>            <span class="n">compressed_content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
<a href="#__codelineno-5-18" id="__codelineno-5-18" name="__codelineno-5-18"></a>            <span class="n">original_tokens</span><span class="o">=</span><span class="n">original_tokens</span><span class="p">,</span>
<a href="#__codelineno-5-19" id="__codelineno-5-19" name="__codelineno-5-19"></a>            <span class="n">compressed_tokens</span><span class="o">=</span><span class="n">original_tokens</span><span class="p">,</span>
<a href="#__codelineno-5-20" id="__codelineno-5-20" name="__codelineno-5-20"></a>            <span class="n">compression_ratio</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
<a href="#__codelineno-5-21" id="__codelineno-5-21" name="__codelineno-5-21"></a>            <span class="n">semantic_preservation_score</span><span class="o">=</span><span class="mf">1.0</span>
<a href="#__codelineno-5-22" id="__codelineno-5-22" name="__codelineno-5-22"></a>        <span class="p">)</span>
<a href="#__codelineno-5-23" id="__codelineno-5-23" name="__codelineno-5-23"></a>
<a href="#__codelineno-5-24" id="__codelineno-5-24" name="__codelineno-5-24"></a>    <span class="c1"># Parse code into AST</span>
<a href="#__codelineno-5-25" id="__codelineno-5-25" name="__codelineno-5-25"></a>    <span class="k">try</span><span class="p">:</span>
<a href="#__codelineno-5-26" id="__codelineno-5-26" name="__codelineno-5-26"></a>        <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<a href="#__codelineno-5-27" id="__codelineno-5-27" name="__codelineno-5-27"></a>    <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
<a href="#__codelineno-5-28" id="__codelineno-5-28" name="__codelineno-5-28"></a>        <span class="c1"># Fallback to line-based compression for invalid syntax</span>
<a href="#__codelineno-5-29" id="__codelineno-5-29" name="__codelineno-5-29"></a>        <span class="k">return</span> <span class="n">compress_python_lines</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">target_tokens</span><span class="p">)</span>
<a href="#__codelineno-5-30" id="__codelineno-5-30" name="__codelineno-5-30"></a>
<a href="#__codelineno-5-31" id="__codelineno-5-31" name="__codelineno-5-31"></a>    <span class="c1"># Analyze code elements</span>
<a href="#__codelineno-5-32" id="__codelineno-5-32" name="__codelineno-5-32"></a>    <span class="n">elements</span> <span class="o">=</span> <span class="n">analyze_code_elements</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
<a href="#__codelineno-5-33" id="__codelineno-5-33" name="__codelineno-5-33"></a>
<a href="#__codelineno-5-34" id="__codelineno-5-34" name="__codelineno-5-34"></a>    <span class="c1"># Determine compression strategy based on target ratio</span>
<a href="#__codelineno-5-35" id="__codelineno-5-35" name="__codelineno-5-35"></a>    <span class="n">target_ratio</span> <span class="o">=</span> <span class="n">target_tokens</span> <span class="o">/</span> <span class="n">original_tokens</span>
<a href="#__codelineno-5-36" id="__codelineno-5-36" name="__codelineno-5-36"></a>    <span class="n">compression_strategy</span> <span class="o">=</span> <span class="n">select_compression_strategy</span><span class="p">(</span><span class="n">target_ratio</span><span class="p">)</span>
<a href="#__codelineno-5-37" id="__codelineno-5-37" name="__codelineno-5-37"></a>
<a href="#__codelineno-5-38" id="__codelineno-5-38" name="__codelineno-5-38"></a>    <span class="c1"># Apply compression strategy</span>
<a href="#__codelineno-5-39" id="__codelineno-5-39" name="__codelineno-5-39"></a>    <span class="n">compressed_tree</span> <span class="o">=</span> <span class="n">apply_compression_strategy</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="n">compression_strategy</span><span class="p">)</span>
<a href="#__codelineno-5-40" id="__codelineno-5-40" name="__codelineno-5-40"></a>
<a href="#__codelineno-5-41" id="__codelineno-5-41" name="__codelineno-5-41"></a>    <span class="c1"># Reconstruct code</span>
<a href="#__codelineno-5-42" id="__codelineno-5-42" name="__codelineno-5-42"></a>    <span class="n">compressed_content</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">compressed_tree</span><span class="p">)</span>
<a href="#__codelineno-5-43" id="__codelineno-5-43" name="__codelineno-5-43"></a>    <span class="n">compressed_tokens</span> <span class="o">=</span> <span class="n">estimate_tokens</span><span class="p">(</span><span class="n">compressed_content</span><span class="p">)</span>
<a href="#__codelineno-5-44" id="__codelineno-5-44" name="__codelineno-5-44"></a>
<a href="#__codelineno-5-45" id="__codelineno-5-45" name="__codelineno-5-45"></a>    <span class="c1"># Calculate semantic preservation score</span>
<a href="#__codelineno-5-46" id="__codelineno-5-46" name="__codelineno-5-46"></a>    <span class="n">semantic_score</span> <span class="o">=</span> <span class="n">calculate_semantic_preservation</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">compressed_content</span><span class="p">)</span>
<a href="#__codelineno-5-47" id="__codelineno-5-47" name="__codelineno-5-47"></a>
<a href="#__codelineno-5-48" id="__codelineno-5-48" name="__codelineno-5-48"></a>    <span class="k">return</span> <span class="n">CompressionResult</span><span class="p">(</span>
<a href="#__codelineno-5-49" id="__codelineno-5-49" name="__codelineno-5-49"></a>        <span class="n">compressed_content</span><span class="o">=</span><span class="n">compressed_content</span><span class="p">,</span>
<a href="#__codelineno-5-50" id="__codelineno-5-50" name="__codelineno-5-50"></a>        <span class="n">original_tokens</span><span class="o">=</span><span class="n">original_tokens</span><span class="p">,</span>
<a href="#__codelineno-5-51" id="__codelineno-5-51" name="__codelineno-5-51"></a>        <span class="n">compressed_tokens</span><span class="o">=</span><span class="n">compressed_tokens</span><span class="p">,</span>
<a href="#__codelineno-5-52" id="__codelineno-5-52" name="__codelineno-5-52"></a>        <span class="n">compression_ratio</span><span class="o">=</span><span class="n">original_tokens</span> <span class="o">/</span> <span class="n">compressed_tokens</span><span class="p">,</span>
<a href="#__codelineno-5-53" id="__codelineno-5-53" name="__codelineno-5-53"></a>        <span class="n">semantic_preservation_score</span><span class="o">=</span><span class="n">semantic_score</span>
<a href="#__codelineno-5-54" id="__codelineno-5-54" name="__codelineno-5-54"></a>    <span class="p">)</span>
<a href="#__codelineno-5-55" id="__codelineno-5-55" name="__codelineno-5-55"></a>
<a href="#__codelineno-5-56" id="__codelineno-5-56" name="__codelineno-5-56"></a><span class="k">def</span> <span class="nf">analyze_code_elements</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">]:</span>
<a href="#__codelineno-5-57" id="__codelineno-5-57" name="__codelineno-5-57"></a><span class="w">    </span><span class="sd">"""Analyze and categorize code elements by importance"""</span>
<a href="#__codelineno-5-58" id="__codelineno-5-58" name="__codelineno-5-58"></a>    <span class="n">elements</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-5-59" id="__codelineno-5-59" name="__codelineno-5-59"></a>        <span class="s1">'critical'</span><span class="p">:</span> <span class="p">[],</span>      <span class="c1"># Core classes, main functions</span>
<a href="#__codelineno-5-60" id="__codelineno-5-60" name="__codelineno-5-60"></a>        <span class="s1">'important'</span><span class="p">:</span> <span class="p">[],</span>     <span class="c1"># Helper functions, key methods</span>
<a href="#__codelineno-5-61" id="__codelineno-5-61" name="__codelineno-5-61"></a>        <span class="s1">'standard'</span><span class="p">:</span> <span class="p">[],</span>      <span class="c1"># Regular methods, properties</span>
<a href="#__codelineno-5-62" id="__codelineno-5-62" name="__codelineno-5-62"></a>        <span class="s1">'optional'</span><span class="p">:</span> <span class="p">[],</span>      <span class="c1"># Comments, docstrings, debug code</span>
<a href="#__codelineno-5-63" id="__codelineno-5-63" name="__codelineno-5-63"></a>        <span class="s1">'removable'</span><span class="p">:</span> <span class="p">[]</span>      <span class="c1"># Dead code, unused imports</span>
<a href="#__codelineno-5-64" id="__codelineno-5-64" name="__codelineno-5-64"></a>    <span class="p">}</span>
<a href="#__codelineno-5-65" id="__codelineno-5-65" name="__codelineno-5-65"></a>
<a href="#__codelineno-5-66" id="__codelineno-5-66" name="__codelineno-5-66"></a>    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
<a href="#__codelineno-5-67" id="__codelineno-5-67" name="__codelineno-5-67"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">):</span>
<a href="#__codelineno-5-68" id="__codelineno-5-68" name="__codelineno-5-68"></a>            <span class="n">importance</span> <span class="o">=</span> <span class="n">classify_class_importance</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a href="#__codelineno-5-69" id="__codelineno-5-69" name="__codelineno-5-69"></a>            <span class="n">elements</span><span class="p">[</span><span class="n">importance</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a href="#__codelineno-5-70" id="__codelineno-5-70" name="__codelineno-5-70"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
<a href="#__codelineno-5-71" id="__codelineno-5-71" name="__codelineno-5-71"></a>            <span class="n">importance</span> <span class="o">=</span> <span class="n">classify_function_importance</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a href="#__codelineno-5-72" id="__codelineno-5-72" name="__codelineno-5-72"></a>            <span class="n">elements</span><span class="p">[</span><span class="n">importance</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a href="#__codelineno-5-73" id="__codelineno-5-73" name="__codelineno-5-73"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Import</span><span class="p">):</span>
<a href="#__codelineno-5-74" id="__codelineno-5-74" name="__codelineno-5-74"></a>            <span class="k">if</span> <span class="n">is_unused_import</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
<a href="#__codelineno-5-75" id="__codelineno-5-75" name="__codelineno-5-75"></a>                <span class="n">elements</span><span class="p">[</span><span class="s1">'removable'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a href="#__codelineno-5-76" id="__codelineno-5-76" name="__codelineno-5-76"></a>            <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-5-77" id="__codelineno-5-77" name="__codelineno-5-77"></a>                <span class="n">elements</span><span class="p">[</span><span class="s1">'standard'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a href="#__codelineno-5-78" id="__codelineno-5-78" name="__codelineno-5-78"></a>
<a href="#__codelineno-5-79" id="__codelineno-5-79" name="__codelineno-5-79"></a>    <span class="k">return</span> <span class="n">elements</span>
<a href="#__codelineno-5-80" id="__codelineno-5-80" name="__codelineno-5-80"></a>
<a href="#__codelineno-5-81" id="__codelineno-5-81" name="__codelineno-5-81"></a><span class="k">def</span> <span class="nf">select_compression_strategy</span><span class="p">(</span><span class="n">target_ratio</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a href="#__codelineno-5-82" id="__codelineno-5-82" name="__codelineno-5-82"></a><span class="w">    </span><span class="sd">"""Select compression strategy based on target compression ratio"""</span>
<a href="#__codelineno-5-83" id="__codelineno-5-83" name="__codelineno-5-83"></a>    <span class="k">if</span> <span class="n">target_ratio</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
<a href="#__codelineno-5-84" id="__codelineno-5-84" name="__codelineno-5-84"></a>        <span class="k">return</span> <span class="s1">'conservative'</span>  <span class="c1"># Remove only comments and dead code</span>
<a href="#__codelineno-5-85" id="__codelineno-5-85" name="__codelineno-5-85"></a>    <span class="k">elif</span> <span class="n">target_ratio</span> <span class="o">&gt;</span> <span class="mf">0.6</span><span class="p">:</span>
<a href="#__codelineno-5-86" id="__codelineno-5-86" name="__codelineno-5-86"></a>        <span class="k">return</span> <span class="s1">'moderate'</span>      <span class="c1"># Remove optional elements, compress docstrings</span>
<a href="#__codelineno-5-87" id="__codelineno-5-87" name="__codelineno-5-87"></a>    <span class="k">elif</span> <span class="n">target_ratio</span> <span class="o">&gt;</span> <span class="mf">0.4</span><span class="p">:</span>
<a href="#__codelineno-5-88" id="__codelineno-5-88" name="__codelineno-5-88"></a>        <span class="k">return</span> <span class="s1">'aggressive'</span>    <span class="c1"># Keep only critical and important elements</span>
<a href="#__codelineno-5-89" id="__codelineno-5-89" name="__codelineno-5-89"></a>    <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-5-90" id="__codelineno-5-90" name="__codelineno-5-90"></a>        <span class="k">return</span> <span class="s1">'extreme'</span>       <span class="c1"># Keep only critical elements, summarize everything else</span>
<a href="#__codelineno-5-91" id="__codelineno-5-91" name="__codelineno-5-91"></a>
<a href="#__codelineno-5-92" id="__codelineno-5-92" name="__codelineno-5-92"></a><span class="k">def</span> <span class="nf">apply_compression_strategy</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">elements</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
<a href="#__codelineno-5-93" id="__codelineno-5-93" name="__codelineno-5-93"></a><span class="w">    </span><span class="sd">"""Apply selected compression strategy to AST"""</span>
<a href="#__codelineno-5-94" id="__codelineno-5-94" name="__codelineno-5-94"></a>
<a href="#__codelineno-5-95" id="__codelineno-5-95" name="__codelineno-5-95"></a>    <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">'conservative'</span><span class="p">:</span>
<a href="#__codelineno-5-96" id="__codelineno-5-96" name="__codelineno-5-96"></a>        <span class="k">return</span> <span class="n">compress_conservative</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">elements</span><span class="p">)</span>
<a href="#__codelineno-5-97" id="__codelineno-5-97" name="__codelineno-5-97"></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">'moderate'</span><span class="p">:</span>
<a href="#__codelineno-5-98" id="__codelineno-5-98" name="__codelineno-5-98"></a>        <span class="k">return</span> <span class="n">compress_moderate</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">elements</span><span class="p">)</span>
<a href="#__codelineno-5-99" id="__codelineno-5-99" name="__codelineno-5-99"></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">'aggressive'</span><span class="p">:</span>
<a href="#__codelineno-5-100" id="__codelineno-5-100" name="__codelineno-5-100"></a>        <span class="k">return</span> <span class="n">compress_aggressive</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">elements</span><span class="p">)</span>
<a href="#__codelineno-5-101" id="__codelineno-5-101" name="__codelineno-5-101"></a>    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">'extreme'</span><span class="p">:</span>
<a href="#__codelineno-5-102" id="__codelineno-5-102" name="__codelineno-5-102"></a>        <span class="k">return</span> <span class="n">compress_extreme</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">elements</span><span class="p">)</span>
<a href="#__codelineno-5-103" id="__codelineno-5-103" name="__codelineno-5-103"></a>
<a href="#__codelineno-5-104" id="__codelineno-5-104" name="__codelineno-5-104"></a>    <span class="k">return</span> <span class="n">tree</span>
<a href="#__codelineno-5-105" id="__codelineno-5-105" name="__codelineno-5-105"></a>
<a href="#__codelineno-5-106" id="__codelineno-5-106" name="__codelineno-5-106"></a><span class="k">def</span> <span class="nf">compress_conservative</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">,</span> <span class="n">elements</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">:</span>
<a href="#__codelineno-5-107" id="__codelineno-5-107" name="__codelineno-5-107"></a><span class="w">    </span><span class="sd">"""Conservative compression: remove only non-essential elements"""</span>
<a href="#__codelineno-5-108" id="__codelineno-5-108" name="__codelineno-5-108"></a>    <span class="n">transformer</span> <span class="o">=</span> <span class="n">ConservativeTransformer</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
<a href="#__codelineno-5-109" id="__codelineno-5-109" name="__codelineno-5-109"></a>    <span class="k">return</span> <span class="n">transformer</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
<a href="#__codelineno-5-110" id="__codelineno-5-110" name="__codelineno-5-110"></a>
<a href="#__codelineno-5-111" id="__codelineno-5-111" name="__codelineno-5-111"></a><span class="k">class</span> <span class="nc">ConservativeTransformer</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeTransformer</span><span class="p">):</span>
<a href="#__codelineno-5-112" id="__codelineno-5-112" name="__codelineno-5-112"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">):</span>
<a href="#__codelineno-5-113" id="__codelineno-5-113" name="__codelineno-5-113"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="n">elements</span>
<a href="#__codelineno-5-114" id="__codelineno-5-114" name="__codelineno-5-114"></a>
<a href="#__codelineno-5-115" id="__codelineno-5-115" name="__codelineno-5-115"></a>    <span class="k">def</span> <span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<a href="#__codelineno-5-116" id="__codelineno-5-116" name="__codelineno-5-116"></a>        <span class="c1"># Remove docstrings but keep function structure</span>
<a href="#__codelineno-5-117" id="__codelineno-5-117" name="__codelineno-5-117"></a>        <span class="k">if</span> <span class="n">ast</span><span class="o">.</span><span class="n">get_docstring</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
<a href="#__codelineno-5-118" id="__codelineno-5-118" name="__codelineno-5-118"></a>            <span class="n">node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="n">stmt</span> <span class="k">for</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span> 
<a href="#__codelineno-5-119" id="__codelineno-5-119" name="__codelineno-5-119"></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">)</span> <span class="ow">or</span> 
<a href="#__codelineno-5-120" id="__codelineno-5-120" name="__codelineno-5-120"></a>                        <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">)]</span>
<a href="#__codelineno-5-121" id="__codelineno-5-121" name="__codelineno-5-121"></a>
<a href="#__codelineno-5-122" id="__codelineno-5-122" name="__codelineno-5-122"></a>        <span class="c1"># Remove comments (handled at line level)</span>
<a href="#__codelineno-5-123" id="__codelineno-5-123" name="__codelineno-5-123"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a href="#__codelineno-5-124" id="__codelineno-5-124" name="__codelineno-5-124"></a>
<a href="#__codelineno-5-125" id="__codelineno-5-125" name="__codelineno-5-125"></a>    <span class="k">def</span> <span class="nf">visit_Import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<a href="#__codelineno-5-126" id="__codelineno-5-126" name="__codelineno-5-126"></a>        <span class="c1"># Remove unused imports</span>
<a href="#__codelineno-5-127" id="__codelineno-5-127" name="__codelineno-5-127"></a>        <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">'removable'</span><span class="p">]:</span>
<a href="#__codelineno-5-128" id="__codelineno-5-128" name="__codelineno-5-128"></a>            <span class="k">return</span> <span class="kc">None</span>
<a href="#__codelineno-5-129" id="__codelineno-5-129" name="__codelineno-5-129"></a>        <span class="k">return</span> <span class="n">node</span>
</code></pre></div>
<h3 id="test-file-compression">Test File Compression<a class="headerlink" href="#test-file-compression" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">def</span> <span class="nf">compress_test_file</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_tokens</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CompressionResult</span><span class="p">:</span>
<a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">    </span><span class="sd">"""</span>
<a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="sd">    Compress test files while preserving test intent and assertions</span>
<a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a>
<a href="#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="sd">    Strategy:</span>
<a href="#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="sd">    1. Preserve all test method signatures</span>
<a href="#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="sd">    2. Preserve all assertions</span>
<a href="#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="sd">    3. Compress setup/teardown code</span>
<a href="#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="sd">    4. Summarize test data and mocks</span>
<a href="#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="sd">    """</span>
<a href="#__codelineno-6-11" id="__codelineno-6-11" name="__codelineno-6-11"></a>
<a href="#__codelineno-6-12" id="__codelineno-6-12" name="__codelineno-6-12"></a>    <span class="n">original_tokens</span> <span class="o">=</span> <span class="n">estimate_tokens</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<a href="#__codelineno-6-13" id="__codelineno-6-13" name="__codelineno-6-13"></a>
<a href="#__codelineno-6-14" id="__codelineno-6-14" name="__codelineno-6-14"></a>    <span class="k">if</span> <span class="n">original_tokens</span> <span class="o">&lt;=</span> <span class="n">target_tokens</span><span class="p">:</span>
<a href="#__codelineno-6-15" id="__codelineno-6-15" name="__codelineno-6-15"></a>        <span class="k">return</span> <span class="n">CompressionResult</span><span class="p">(</span>
<a href="#__codelineno-6-16" id="__codelineno-6-16" name="__codelineno-6-16"></a>            <span class="n">compressed_content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
<a href="#__codelineno-6-17" id="__codelineno-6-17" name="__codelineno-6-17"></a>            <span class="n">original_tokens</span><span class="o">=</span><span class="n">original_tokens</span><span class="p">,</span>
<a href="#__codelineno-6-18" id="__codelineno-6-18" name="__codelineno-6-18"></a>            <span class="n">compressed_tokens</span><span class="o">=</span><span class="n">original_tokens</span><span class="p">,</span>
<a href="#__codelineno-6-19" id="__codelineno-6-19" name="__codelineno-6-19"></a>            <span class="n">compression_ratio</span><span class="o">=</span><span class="mf">1.0</span>
<a href="#__codelineno-6-20" id="__codelineno-6-20" name="__codelineno-6-20"></a>        <span class="p">)</span>
<a href="#__codelineno-6-21" id="__codelineno-6-21" name="__codelineno-6-21"></a>
<a href="#__codelineno-6-22" id="__codelineno-6-22" name="__codelineno-6-22"></a>    <span class="k">try</span><span class="p">:</span>
<a href="#__codelineno-6-23" id="__codelineno-6-23" name="__codelineno-6-23"></a>        <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<a href="#__codelineno-6-24" id="__codelineno-6-24" name="__codelineno-6-24"></a>    <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
<a href="#__codelineno-6-25" id="__codelineno-6-25" name="__codelineno-6-25"></a>        <span class="k">return</span> <span class="n">compress_test_lines</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">target_tokens</span><span class="p">)</span>
<a href="#__codelineno-6-26" id="__codelineno-6-26" name="__codelineno-6-26"></a>
<a href="#__codelineno-6-27" id="__codelineno-6-27" name="__codelineno-6-27"></a>    <span class="c1"># Identify test structure</span>
<a href="#__codelineno-6-28" id="__codelineno-6-28" name="__codelineno-6-28"></a>    <span class="n">test_structure</span> <span class="o">=</span> <span class="n">analyze_test_structure</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
<a href="#__codelineno-6-29" id="__codelineno-6-29" name="__codelineno-6-29"></a>
<a href="#__codelineno-6-30" id="__codelineno-6-30" name="__codelineno-6-30"></a>    <span class="c1"># Compress based on test elements</span>
<a href="#__codelineno-6-31" id="__codelineno-6-31" name="__codelineno-6-31"></a>    <span class="n">compressed_tree</span> <span class="o">=</span> <span class="n">compress_test_elements</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">test_structure</span><span class="p">,</span> <span class="n">target_tokens</span><span class="p">)</span>
<a href="#__codelineno-6-32" id="__codelineno-6-32" name="__codelineno-6-32"></a>
<a href="#__codelineno-6-33" id="__codelineno-6-33" name="__codelineno-6-33"></a>    <span class="n">compressed_content</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">compressed_tree</span><span class="p">)</span>
<a href="#__codelineno-6-34" id="__codelineno-6-34" name="__codelineno-6-34"></a>    <span class="n">compressed_tokens</span> <span class="o">=</span> <span class="n">estimate_tokens</span><span class="p">(</span><span class="n">compressed_content</span><span class="p">)</span>
<a href="#__codelineno-6-35" id="__codelineno-6-35" name="__codelineno-6-35"></a>
<a href="#__codelineno-6-36" id="__codelineno-6-36" name="__codelineno-6-36"></a>    <span class="k">return</span> <span class="n">CompressionResult</span><span class="p">(</span>
<a href="#__codelineno-6-37" id="__codelineno-6-37" name="__codelineno-6-37"></a>        <span class="n">compressed_content</span><span class="o">=</span><span class="n">compressed_content</span><span class="p">,</span>
<a href="#__codelineno-6-38" id="__codelineno-6-38" name="__codelineno-6-38"></a>        <span class="n">original_tokens</span><span class="o">=</span><span class="n">original_tokens</span><span class="p">,</span>
<a href="#__codelineno-6-39" id="__codelineno-6-39" name="__codelineno-6-39"></a>        <span class="n">compressed_tokens</span><span class="o">=</span><span class="n">compressed_tokens</span><span class="p">,</span>
<a href="#__codelineno-6-40" id="__codelineno-6-40" name="__codelineno-6-40"></a>        <span class="n">compression_ratio</span><span class="o">=</span><span class="n">original_tokens</span> <span class="o">/</span> <span class="n">compressed_tokens</span>
<a href="#__codelineno-6-41" id="__codelineno-6-41" name="__codelineno-6-41"></a>    <span class="p">)</span>
<a href="#__codelineno-6-42" id="__codelineno-6-42" name="__codelineno-6-42"></a>
<a href="#__codelineno-6-43" id="__codelineno-6-43" name="__codelineno-6-43"></a><span class="k">def</span> <span class="nf">analyze_test_structure</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<a href="#__codelineno-6-44" id="__codelineno-6-44" name="__codelineno-6-44"></a><span class="w">    </span><span class="sd">"""Analyze test file structure and categorize elements"""</span>
<a href="#__codelineno-6-45" id="__codelineno-6-45" name="__codelineno-6-45"></a>    <span class="n">structure</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-6-46" id="__codelineno-6-46" name="__codelineno-6-46"></a>        <span class="s1">'test_methods'</span><span class="p">:</span> <span class="p">[],</span>
<a href="#__codelineno-6-47" id="__codelineno-6-47" name="__codelineno-6-47"></a>        <span class="s1">'setup_methods'</span><span class="p">:</span> <span class="p">[],</span>
<a href="#__codelineno-6-48" id="__codelineno-6-48" name="__codelineno-6-48"></a>        <span class="s1">'helper_methods'</span><span class="p">:</span> <span class="p">[],</span>
<a href="#__codelineno-6-49" id="__codelineno-6-49" name="__codelineno-6-49"></a>        <span class="s1">'assertions'</span><span class="p">:</span> <span class="p">[],</span>
<a href="#__codelineno-6-50" id="__codelineno-6-50" name="__codelineno-6-50"></a>        <span class="s1">'test_data'</span><span class="p">:</span> <span class="p">[],</span>
<a href="#__codelineno-6-51" id="__codelineno-6-51" name="__codelineno-6-51"></a>        <span class="s1">'imports'</span><span class="p">:</span> <span class="p">[]</span>
<a href="#__codelineno-6-52" id="__codelineno-6-52" name="__codelineno-6-52"></a>    <span class="p">}</span>
<a href="#__codelineno-6-53" id="__codelineno-6-53" name="__codelineno-6-53"></a>
<a href="#__codelineno-6-54" id="__codelineno-6-54" name="__codelineno-6-54"></a>    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
<a href="#__codelineno-6-55" id="__codelineno-6-55" name="__codelineno-6-55"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
<a href="#__codelineno-6-56" id="__codelineno-6-56" name="__codelineno-6-56"></a>            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'test_'</span><span class="p">):</span>
<a href="#__codelineno-6-57" id="__codelineno-6-57" name="__codelineno-6-57"></a>                <span class="n">structure</span><span class="p">[</span><span class="s1">'test_methods'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a href="#__codelineno-6-58" id="__codelineno-6-58" name="__codelineno-6-58"></a>                <span class="c1"># Extract assertions from test method</span>
<a href="#__codelineno-6-59" id="__codelineno-6-59" name="__codelineno-6-59"></a>                <span class="n">assertions</span> <span class="o">=</span> <span class="n">extract_assertions</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a href="#__codelineno-6-60" id="__codelineno-6-60" name="__codelineno-6-60"></a>                <span class="n">structure</span><span class="p">[</span><span class="s1">'assertions'</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">assertions</span><span class="p">)</span>
<a href="#__codelineno-6-61" id="__codelineno-6-61" name="__codelineno-6-61"></a>            <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'setUp'</span><span class="p">,</span> <span class="s1">'tearDown'</span><span class="p">,</span> <span class="s1">'setUpClass'</span><span class="p">,</span> <span class="s1">'tearDownClass'</span><span class="p">]:</span>
<a href="#__codelineno-6-62" id="__codelineno-6-62" name="__codelineno-6-62"></a>                <span class="n">structure</span><span class="p">[</span><span class="s1">'setup_methods'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a href="#__codelineno-6-63" id="__codelineno-6-63" name="__codelineno-6-63"></a>            <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-6-64" id="__codelineno-6-64" name="__codelineno-6-64"></a>                <span class="n">structure</span><span class="p">[</span><span class="s1">'helper_methods'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a href="#__codelineno-6-65" id="__codelineno-6-65" name="__codelineno-6-65"></a>
<a href="#__codelineno-6-66" id="__codelineno-6-66" name="__codelineno-6-66"></a>    <span class="k">return</span> <span class="n">structure</span>
<a href="#__codelineno-6-67" id="__codelineno-6-67" name="__codelineno-6-67"></a>
<a href="#__codelineno-6-68" id="__codelineno-6-68" name="__codelineno-6-68"></a><span class="k">def</span> <span class="nf">extract_assertions</span><span class="p">(</span><span class="n">test_method</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">stmt</span><span class="p">]:</span>
<a href="#__codelineno-6-69" id="__codelineno-6-69" name="__codelineno-6-69"></a><span class="w">    </span><span class="sd">"""Extract assertion statements from test method"""</span>
<a href="#__codelineno-6-70" id="__codelineno-6-70" name="__codelineno-6-70"></a>    <span class="n">assertions</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-6-71" id="__codelineno-6-71" name="__codelineno-6-71"></a>
<a href="#__codelineno-6-72" id="__codelineno-6-72" name="__codelineno-6-72"></a>    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">test_method</span><span class="p">):</span>
<a href="#__codelineno-6-73" id="__codelineno-6-73" name="__codelineno-6-73"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">):</span>
<a href="#__codelineno-6-74" id="__codelineno-6-74" name="__codelineno-6-74"></a>            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">)</span> <span class="ow">and</span> 
<a href="#__codelineno-6-75" id="__codelineno-6-75" name="__codelineno-6-75"></a>                <span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'assert'</span><span class="p">)):</span>
<a href="#__codelineno-6-76" id="__codelineno-6-76" name="__codelineno-6-76"></a>                <span class="n">assertions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a href="#__codelineno-6-77" id="__codelineno-6-77" name="__codelineno-6-77"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assert</span><span class="p">):</span>
<a href="#__codelineno-6-78" id="__codelineno-6-78" name="__codelineno-6-78"></a>            <span class="n">assertions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a href="#__codelineno-6-79" id="__codelineno-6-79" name="__codelineno-6-79"></a>
<a href="#__codelineno-6-80" id="__codelineno-6-80" name="__codelineno-6-80"></a>    <span class="k">return</span> <span class="n">assertions</span>
</code></pre></div>
<h2 id="token-budget-allocation-algorithm">Token Budget Allocation Algorithm<a class="headerlink" href="#token-budget-allocation-algorithm" title="Permanent link">¶</a></h2>
<h3 id="dynamic-budget-allocation">Dynamic Budget Allocation<a class="headerlink" href="#dynamic-budget-allocation" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">def</span> <span class="nf">calculate_optimal_budget</span><span class="p">(</span><span class="n">total_tokens</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
<a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a>                           <span class="n">context_components</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<a href="#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a>                           <span class="n">agent_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a href="#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a>                           <span class="n">tdd_phase</span><span class="p">:</span> <span class="n">TDDState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenBudget</span><span class="p">:</span>
<a href="#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">    </span><span class="sd">"""</span>
<a href="#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="sd">    Calculate optimal token budget allocation based on:</span>
<a href="#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="sd">    - Available content in each category</span>
<a href="#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="sd">    - Agent type preferences</span>
<a href="#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="sd">    - TDD phase requirements</span>
<a href="#__codelineno-7-10" id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="sd">    - Historical usage patterns</span>
<a href="#__codelineno-7-11" id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="sd">    """</span>
<a href="#__codelineno-7-12" id="__codelineno-7-12" name="__codelineno-7-12"></a>
<a href="#__codelineno-7-13" id="__codelineno-7-13" name="__codelineno-7-13"></a>    <span class="c1"># Base allocation percentages by agent type</span>
<a href="#__codelineno-7-14" id="__codelineno-7-14" name="__codelineno-7-14"></a>    <span class="n">base_allocations</span> <span class="o">=</span> <span class="n">get_agent_base_allocations</span><span class="p">(</span><span class="n">agent_type</span><span class="p">)</span>
<a href="#__codelineno-7-15" id="__codelineno-7-15" name="__codelineno-7-15"></a>
<a href="#__codelineno-7-16" id="__codelineno-7-16" name="__codelineno-7-16"></a>    <span class="c1"># Adjust allocations based on TDD phase</span>
<a href="#__codelineno-7-17" id="__codelineno-7-17" name="__codelineno-7-17"></a>    <span class="n">phase_adjustments</span> <span class="o">=</span> <span class="n">get_phase_adjustments</span><span class="p">(</span><span class="n">tdd_phase</span><span class="p">)</span>
<a href="#__codelineno-7-18" id="__codelineno-7-18" name="__codelineno-7-18"></a>
<a href="#__codelineno-7-19" id="__codelineno-7-19" name="__codelineno-7-19"></a>    <span class="c1"># Apply adjustments</span>
<a href="#__codelineno-7-20" id="__codelineno-7-20" name="__codelineno-7-20"></a>    <span class="n">adjusted_allocations</span> <span class="o">=</span> <span class="n">apply_allocation_adjustments</span><span class="p">(</span><span class="n">base_allocations</span><span class="p">,</span> <span class="n">phase_adjustments</span><span class="p">)</span>
<a href="#__codelineno-7-21" id="__codelineno-7-21" name="__codelineno-7-21"></a>
<a href="#__codelineno-7-22" id="__codelineno-7-22" name="__codelineno-7-22"></a>    <span class="c1"># Calculate actual needs vs available content</span>
<a href="#__codelineno-7-23" id="__codelineno-7-23" name="__codelineno-7-23"></a>    <span class="n">component_needs</span> <span class="o">=</span> <span class="n">calculate_component_needs</span><span class="p">(</span><span class="n">context_components</span><span class="p">)</span>
<a href="#__codelineno-7-24" id="__codelineno-7-24" name="__codelineno-7-24"></a>
<a href="#__codelineno-7-25" id="__codelineno-7-25" name="__codelineno-7-25"></a>    <span class="c1"># Optimize allocation based on needs</span>
<a href="#__codelineno-7-26" id="__codelineno-7-26" name="__codelineno-7-26"></a>    <span class="n">optimized_budget</span> <span class="o">=</span> <span class="n">optimize_budget_allocation</span><span class="p">(</span>
<a href="#__codelineno-7-27" id="__codelineno-7-27" name="__codelineno-7-27"></a>        <span class="n">total_tokens</span><span class="p">,</span> <span class="n">adjusted_allocations</span><span class="p">,</span> <span class="n">component_needs</span>
<a href="#__codelineno-7-28" id="__codelineno-7-28" name="__codelineno-7-28"></a>    <span class="p">)</span>
<a href="#__codelineno-7-29" id="__codelineno-7-29" name="__codelineno-7-29"></a>
<a href="#__codelineno-7-30" id="__codelineno-7-30" name="__codelineno-7-30"></a>    <span class="k">return</span> <span class="n">optimized_budget</span>
<a href="#__codelineno-7-31" id="__codelineno-7-31" name="__codelineno-7-31"></a>
<a href="#__codelineno-7-32" id="__codelineno-7-32" name="__codelineno-7-32"></a><span class="k">def</span> <span class="nf">get_agent_base_allocations</span><span class="p">(</span><span class="n">agent_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<a href="#__codelineno-7-33" id="__codelineno-7-33" name="__codelineno-7-33"></a><span class="w">    </span><span class="sd">"""Get base allocation percentages for different agent types"""</span>
<a href="#__codelineno-7-34" id="__codelineno-7-34" name="__codelineno-7-34"></a>    <span class="n">allocations</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-7-35" id="__codelineno-7-35" name="__codelineno-7-35"></a>        <span class="s1">'DesignAgent'</span><span class="p">:</span> <span class="p">{</span>
<a href="#__codelineno-7-36" id="__codelineno-7-36" name="__codelineno-7-36"></a>            <span class="s1">'core_context'</span><span class="p">:</span> <span class="mf">0.30</span><span class="p">,</span>
<a href="#__codelineno-7-37" id="__codelineno-7-37" name="__codelineno-7-37"></a>            <span class="s1">'dependencies'</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span>
<a href="#__codelineno-7-38" id="__codelineno-7-38" name="__codelineno-7-38"></a>            <span class="s1">'historical'</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>
<a href="#__codelineno-7-39" id="__codelineno-7-39" name="__codelineno-7-39"></a>            <span class="s1">'agent_memory'</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span>
<a href="#__codelineno-7-40" id="__codelineno-7-40" name="__codelineno-7-40"></a>            <span class="s1">'documentation'</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span>
<a href="#__codelineno-7-41" id="__codelineno-7-41" name="__codelineno-7-41"></a>            <span class="s1">'buffer'</span><span class="p">:</span> <span class="mf">0.05</span>
<a href="#__codelineno-7-42" id="__codelineno-7-42" name="__codelineno-7-42"></a>        <span class="p">},</span>
<a href="#__codelineno-7-43" id="__codelineno-7-43" name="__codelineno-7-43"></a>        <span class="s1">'QAAgent'</span><span class="p">:</span> <span class="p">{</span>
<a href="#__codelineno-7-44" id="__codelineno-7-44" name="__codelineno-7-44"></a>            <span class="s1">'core_context'</span><span class="p">:</span> <span class="mf">0.45</span><span class="p">,</span>  <span class="c1"># Tests need more specific context</span>
<a href="#__codelineno-7-45" id="__codelineno-7-45" name="__codelineno-7-45"></a>            <span class="s1">'dependencies'</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span>
<a href="#__codelineno-7-46" id="__codelineno-7-46" name="__codelineno-7-46"></a>            <span class="s1">'historical'</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span>
<a href="#__codelineno-7-47" id="__codelineno-7-47" name="__codelineno-7-47"></a>            <span class="s1">'agent_memory'</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span>
<a href="#__codelineno-7-48" id="__codelineno-7-48" name="__codelineno-7-48"></a>            <span class="s1">'documentation'</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
<a href="#__codelineno-7-49" id="__codelineno-7-49" name="__codelineno-7-49"></a>            <span class="s1">'buffer'</span><span class="p">:</span> <span class="mf">0.05</span>
<a href="#__codelineno-7-50" id="__codelineno-7-50" name="__codelineno-7-50"></a>        <span class="p">},</span>
<a href="#__codelineno-7-51" id="__codelineno-7-51" name="__codelineno-7-51"></a>        <span class="s1">'CodeAgent'</span><span class="p">:</span> <span class="p">{</span>
<a href="#__codelineno-7-52" id="__codelineno-7-52" name="__codelineno-7-52"></a>            <span class="s1">'core_context'</span><span class="p">:</span> <span class="mf">0.40</span><span class="p">,</span>
<a href="#__codelineno-7-53" id="__codelineno-7-53" name="__codelineno-7-53"></a>            <span class="s1">'dependencies'</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>  <span class="c1"># Code needs more dependency context</span>
<a href="#__codelineno-7-54" id="__codelineno-7-54" name="__codelineno-7-54"></a>            <span class="s1">'historical'</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span>
<a href="#__codelineno-7-55" id="__codelineno-7-55" name="__codelineno-7-55"></a>            <span class="s1">'agent_memory'</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span>
<a href="#__codelineno-7-56" id="__codelineno-7-56" name="__codelineno-7-56"></a>            <span class="s1">'documentation'</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
<a href="#__codelineno-7-57" id="__codelineno-7-57" name="__codelineno-7-57"></a>            <span class="s1">'buffer'</span><span class="p">:</span> <span class="mf">0.05</span>
<a href="#__codelineno-7-58" id="__codelineno-7-58" name="__codelineno-7-58"></a>        <span class="p">},</span>
<a href="#__codelineno-7-59" id="__codelineno-7-59" name="__codelineno-7-59"></a>        <span class="s1">'DataAgent'</span><span class="p">:</span> <span class="p">{</span>
<a href="#__codelineno-7-60" id="__codelineno-7-60" name="__codelineno-7-60"></a>            <span class="s1">'core_context'</span><span class="p">:</span> <span class="mf">0.35</span><span class="p">,</span>
<a href="#__codelineno-7-61" id="__codelineno-7-61" name="__codelineno-7-61"></a>            <span class="s1">'dependencies'</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span>
<a href="#__codelineno-7-62" id="__codelineno-7-62" name="__codelineno-7-62"></a>            <span class="s1">'historical'</span><span class="p">:</span> <span class="mf">0.30</span><span class="p">,</span>    <span class="c1"># Data analysis benefits from historical patterns</span>
<a href="#__codelineno-7-63" id="__codelineno-7-63" name="__codelineno-7-63"></a>            <span class="s1">'agent_memory'</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span>
<a href="#__codelineno-7-64" id="__codelineno-7-64" name="__codelineno-7-64"></a>            <span class="s1">'documentation'</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
<a href="#__codelineno-7-65" id="__codelineno-7-65" name="__codelineno-7-65"></a>            <span class="s1">'buffer'</span><span class="p">:</span> <span class="mf">0.05</span>
<a href="#__codelineno-7-66" id="__codelineno-7-66" name="__codelineno-7-66"></a>        <span class="p">}</span>
<a href="#__codelineno-7-67" id="__codelineno-7-67" name="__codelineno-7-67"></a>    <span class="p">}</span>
<a href="#__codelineno-7-68" id="__codelineno-7-68" name="__codelineno-7-68"></a>
<a href="#__codelineno-7-69" id="__codelineno-7-69" name="__codelineno-7-69"></a>    <span class="k">return</span> <span class="n">allocations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agent_type</span><span class="p">,</span> <span class="n">allocations</span><span class="p">[</span><span class="s1">'CodeAgent'</span><span class="p">])</span>
<a href="#__codelineno-7-70" id="__codelineno-7-70" name="__codelineno-7-70"></a>
<a href="#__codelineno-7-71" id="__codelineno-7-71" name="__codelineno-7-71"></a><span class="k">def</span> <span class="nf">get_phase_adjustments</span><span class="p">(</span><span class="n">tdd_phase</span><span class="p">:</span> <span class="n">TDDState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<a href="#__codelineno-7-72" id="__codelineno-7-72" name="__codelineno-7-72"></a><span class="w">    </span><span class="sd">"""Get allocation adjustments based on TDD phase"""</span>
<a href="#__codelineno-7-73" id="__codelineno-7-73" name="__codelineno-7-73"></a>    <span class="n">adjustments</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-7-74" id="__codelineno-7-74" name="__codelineno-7-74"></a>        <span class="n">TDDState</span><span class="o">.</span><span class="n">DESIGN</span><span class="p">:</span> <span class="p">{</span>
<a href="#__codelineno-7-75" id="__codelineno-7-75" name="__codelineno-7-75"></a>            <span class="s1">'documentation'</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>  <span class="c1"># Boost documentation for design</span>
<a href="#__codelineno-7-76" id="__codelineno-7-76" name="__codelineno-7-76"></a>            <span class="s1">'historical'</span><span class="p">:</span> <span class="mf">1.3</span><span class="p">,</span>     <span class="c1"># Boost historical patterns</span>
<a href="#__codelineno-7-77" id="__codelineno-7-77" name="__codelineno-7-77"></a>            <span class="s1">'dependencies'</span><span class="p">:</span> <span class="mf">0.8</span>    <span class="c1"># Reduce dependency focus</span>
<a href="#__codelineno-7-78" id="__codelineno-7-78" name="__codelineno-7-78"></a>        <span class="p">},</span>
<a href="#__codelineno-7-79" id="__codelineno-7-79" name="__codelineno-7-79"></a>        <span class="n">TDDState</span><span class="o">.</span><span class="n">TEST_RED</span><span class="p">:</span> <span class="p">{</span>
<a href="#__codelineno-7-80" id="__codelineno-7-80" name="__codelineno-7-80"></a>            <span class="s1">'core_context'</span><span class="p">:</span> <span class="mf">1.4</span><span class="p">,</span>   <span class="c1"># Boost current context for test writing</span>
<a href="#__codelineno-7-81" id="__codelineno-7-81" name="__codelineno-7-81"></a>            <span class="s1">'agent_memory'</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span>   <span class="c1"># Boost memory for test patterns</span>
<a href="#__codelineno-7-82" id="__codelineno-7-82" name="__codelineno-7-82"></a>            <span class="s1">'dependencies'</span><span class="p">:</span> <span class="mf">0.9</span>    <span class="c1"># Slight reduction in dependencies</span>
<a href="#__codelineno-7-83" id="__codelineno-7-83" name="__codelineno-7-83"></a>        <span class="p">},</span>
<a href="#__codelineno-7-84" id="__codelineno-7-84" name="__codelineno-7-84"></a>        <span class="n">TDDState</span><span class="o">.</span><span class="n">CODE_GREEN</span><span class="p">:</span> <span class="p">{</span>
<a href="#__codelineno-7-85" id="__codelineno-7-85" name="__codelineno-7-85"></a>            <span class="s1">'dependencies'</span><span class="p">:</span> <span class="mf">1.4</span><span class="p">,</span>   <span class="c1"># Boost dependencies for implementation</span>
<a href="#__codelineno-7-86" id="__codelineno-7-86" name="__codelineno-7-86"></a>            <span class="s1">'core_context'</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span>   <span class="c1"># Boost current context</span>
<a href="#__codelineno-7-87" id="__codelineno-7-87" name="__codelineno-7-87"></a>            <span class="s1">'historical'</span><span class="p">:</span> <span class="mf">0.8</span>      <span class="c1"># Reduce historical patterns</span>
<a href="#__codelineno-7-88" id="__codelineno-7-88" name="__codelineno-7-88"></a>        <span class="p">},</span>
<a href="#__codelineno-7-89" id="__codelineno-7-89" name="__codelineno-7-89"></a>        <span class="n">TDDState</span><span class="o">.</span><span class="n">REFACTOR</span><span class="p">:</span> <span class="p">{</span>
<a href="#__codelineno-7-90" id="__codelineno-7-90" name="__codelineno-7-90"></a>            <span class="s1">'historical'</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>     <span class="c1"># Boost historical patterns for best practices</span>
<a href="#__codelineno-7-91" id="__codelineno-7-91" name="__codelineno-7-91"></a>            <span class="s1">'agent_memory'</span><span class="p">:</span> <span class="mf">1.3</span><span class="p">,</span>   <span class="c1"># Boost memory for refactoring patterns</span>
<a href="#__codelineno-7-92" id="__codelineno-7-92" name="__codelineno-7-92"></a>            <span class="s1">'core_context'</span><span class="p">:</span> <span class="mf">1.1</span>    <span class="c1"># Slight boost to current context</span>
<a href="#__codelineno-7-93" id="__codelineno-7-93" name="__codelineno-7-93"></a>        <span class="p">},</span>
<a href="#__codelineno-7-94" id="__codelineno-7-94" name="__codelineno-7-94"></a>        <span class="n">TDDState</span><span class="o">.</span><span class="n">COMMIT</span><span class="p">:</span> <span class="p">{</span>
<a href="#__codelineno-7-95" id="__codelineno-7-95" name="__codelineno-7-95"></a>            <span class="s1">'core_context'</span><span class="p">:</span> <span class="mf">1.3</span><span class="p">,</span>   <span class="c1"># Boost current context for commit validation</span>
<a href="#__codelineno-7-96" id="__codelineno-7-96" name="__codelineno-7-96"></a>            <span class="s1">'dependencies'</span><span class="p">:</span> <span class="mf">1.1</span><span class="p">,</span>   <span class="c1"># Slight boost for integration validation</span>
<a href="#__codelineno-7-97" id="__codelineno-7-97" name="__codelineno-7-97"></a>            <span class="s1">'agent_memory'</span><span class="p">:</span> <span class="mf">0.9</span>    <span class="c1"># Slight reduction in memory</span>
<a href="#__codelineno-7-98" id="__codelineno-7-98" name="__codelineno-7-98"></a>        <span class="p">}</span>
<a href="#__codelineno-7-99" id="__codelineno-7-99" name="__codelineno-7-99"></a>    <span class="p">}</span>
<a href="#__codelineno-7-100" id="__codelineno-7-100" name="__codelineno-7-100"></a>
<a href="#__codelineno-7-101" id="__codelineno-7-101" name="__codelineno-7-101"></a>    <span class="k">return</span> <span class="n">adjustments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tdd_phase</span><span class="p">,</span> <span class="p">{})</span>
<a href="#__codelineno-7-102" id="__codelineno-7-102" name="__codelineno-7-102"></a>
<a href="#__codelineno-7-103" id="__codelineno-7-103" name="__codelineno-7-103"></a><span class="k">def</span> <span class="nf">optimize_budget_allocation</span><span class="p">(</span><span class="n">total_tokens</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
<a href="#__codelineno-7-104" id="__codelineno-7-104" name="__codelineno-7-104"></a>                             <span class="n">base_allocations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
<a href="#__codelineno-7-105" id="__codelineno-7-105" name="__codelineno-7-105"></a>                             <span class="n">component_needs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">TokenBudget</span><span class="p">:</span>
<a href="#__codelineno-7-106" id="__codelineno-7-106" name="__codelineno-7-106"></a><span class="w">    </span><span class="sd">"""</span>
<a href="#__codelineno-7-107" id="__codelineno-7-107" name="__codelineno-7-107"></a><span class="sd">    Optimize budget allocation by redistributing unused allocations</span>
<a href="#__codelineno-7-108" id="__codelineno-7-108" name="__codelineno-7-108"></a><span class="sd">    and handling over-allocations</span>
<a href="#__codelineno-7-109" id="__codelineno-7-109" name="__codelineno-7-109"></a><span class="sd">    """</span>
<a href="#__codelineno-7-110" id="__codelineno-7-110" name="__codelineno-7-110"></a>
<a href="#__codelineno-7-111" id="__codelineno-7-111" name="__codelineno-7-111"></a>    <span class="c1"># Calculate initial allocations</span>
<a href="#__codelineno-7-112" id="__codelineno-7-112" name="__codelineno-7-112"></a>    <span class="n">initial_budget</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-7-113" id="__codelineno-7-113" name="__codelineno-7-113"></a>    <span class="k">for</span> <span class="n">component</span><span class="p">,</span> <span class="n">percentage</span> <span class="ow">in</span> <span class="n">base_allocations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a href="#__codelineno-7-114" id="__codelineno-7-114" name="__codelineno-7-114"></a>        <span class="n">initial_budget</span><span class="p">[</span><span class="n">component</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_tokens</span> <span class="o">*</span> <span class="n">percentage</span><span class="p">)</span>
<a href="#__codelineno-7-115" id="__codelineno-7-115" name="__codelineno-7-115"></a>
<a href="#__codelineno-7-116" id="__codelineno-7-116" name="__codelineno-7-116"></a>    <span class="c1"># Identify over and under allocations</span>
<a href="#__codelineno-7-117" id="__codelineno-7-117" name="__codelineno-7-117"></a>    <span class="n">adjustments</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-7-118" id="__codelineno-7-118" name="__codelineno-7-118"></a>    <span class="n">unused_tokens</span> <span class="o">=</span> <span class="mi">0</span>
<a href="#__codelineno-7-119" id="__codelineno-7-119" name="__codelineno-7-119"></a>    <span class="n">needed_tokens</span> <span class="o">=</span> <span class="mi">0</span>
<a href="#__codelineno-7-120" id="__codelineno-7-120" name="__codelineno-7-120"></a>
<a href="#__codelineno-7-121" id="__codelineno-7-121" name="__codelineno-7-121"></a>    <span class="k">for</span> <span class="n">component</span><span class="p">,</span> <span class="n">allocated</span> <span class="ow">in</span> <span class="n">initial_budget</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a href="#__codelineno-7-122" id="__codelineno-7-122" name="__codelineno-7-122"></a>        <span class="n">needed</span> <span class="o">=</span> <span class="n">component_needs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a href="#__codelineno-7-123" id="__codelineno-7-123" name="__codelineno-7-123"></a>
<a href="#__codelineno-7-124" id="__codelineno-7-124" name="__codelineno-7-124"></a>        <span class="k">if</span> <span class="n">needed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a href="#__codelineno-7-125" id="__codelineno-7-125" name="__codelineno-7-125"></a>            <span class="c1"># No content available, free up allocation</span>
<a href="#__codelineno-7-126" id="__codelineno-7-126" name="__codelineno-7-126"></a>            <span class="n">unused_tokens</span> <span class="o">+=</span> <span class="n">allocated</span>
<a href="#__codelineno-7-127" id="__codelineno-7-127" name="__codelineno-7-127"></a>            <span class="n">adjustments</span><span class="p">[</span><span class="n">component</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<a href="#__codelineno-7-128" id="__codelineno-7-128" name="__codelineno-7-128"></a>        <span class="k">elif</span> <span class="n">needed</span> <span class="o">&lt;</span> <span class="n">allocated</span><span class="p">:</span>
<a href="#__codelineno-7-129" id="__codelineno-7-129" name="__codelineno-7-129"></a>            <span class="c1"># Less content than allocation, free up excess</span>
<a href="#__codelineno-7-130" id="__codelineno-7-130" name="__codelineno-7-130"></a>            <span class="n">excess</span> <span class="o">=</span> <span class="n">allocated</span> <span class="o">-</span> <span class="n">needed</span>
<a href="#__codelineno-7-131" id="__codelineno-7-131" name="__codelineno-7-131"></a>            <span class="n">unused_tokens</span> <span class="o">+=</span> <span class="n">excess</span>
<a href="#__codelineno-7-132" id="__codelineno-7-132" name="__codelineno-7-132"></a>            <span class="n">adjustments</span><span class="p">[</span><span class="n">component</span><span class="p">]</span> <span class="o">=</span> <span class="n">needed</span>
<a href="#__codelineno-7-133" id="__codelineno-7-133" name="__codelineno-7-133"></a>        <span class="k">elif</span> <span class="n">needed</span> <span class="o">&gt;</span> <span class="n">allocated</span><span class="p">:</span>
<a href="#__codelineno-7-134" id="__codelineno-7-134" name="__codelineno-7-134"></a>            <span class="c1"># More content than allocation, track need</span>
<a href="#__codelineno-7-135" id="__codelineno-7-135" name="__codelineno-7-135"></a>            <span class="n">deficit</span> <span class="o">=</span> <span class="n">needed</span> <span class="o">-</span> <span class="n">allocated</span>
<a href="#__codelineno-7-136" id="__codelineno-7-136" name="__codelineno-7-136"></a>            <span class="n">needed_tokens</span> <span class="o">+=</span> <span class="n">deficit</span>
<a href="#__codelineno-7-137" id="__codelineno-7-137" name="__codelineno-7-137"></a>            <span class="n">adjustments</span><span class="p">[</span><span class="n">component</span><span class="p">]</span> <span class="o">=</span> <span class="n">allocated</span>
<a href="#__codelineno-7-138" id="__codelineno-7-138" name="__codelineno-7-138"></a>        <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-7-139" id="__codelineno-7-139" name="__codelineno-7-139"></a>            <span class="c1"># Perfect match</span>
<a href="#__codelineno-7-140" id="__codelineno-7-140" name="__codelineno-7-140"></a>            <span class="n">adjustments</span><span class="p">[</span><span class="n">component</span><span class="p">]</span> <span class="o">=</span> <span class="n">allocated</span>
<a href="#__codelineno-7-141" id="__codelineno-7-141" name="__codelineno-7-141"></a>
<a href="#__codelineno-7-142" id="__codelineno-7-142" name="__codelineno-7-142"></a>    <span class="c1"># Redistribute unused tokens to components that need more</span>
<a href="#__codelineno-7-143" id="__codelineno-7-143" name="__codelineno-7-143"></a>    <span class="k">if</span> <span class="n">unused_tokens</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">needed_tokens</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a href="#__codelineno-7-144" id="__codelineno-7-144" name="__codelineno-7-144"></a>        <span class="n">redistribution_ratio</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">unused_tokens</span> <span class="o">/</span> <span class="n">needed_tokens</span><span class="p">)</span>
<a href="#__codelineno-7-145" id="__codelineno-7-145" name="__codelineno-7-145"></a>
<a href="#__codelineno-7-146" id="__codelineno-7-146" name="__codelineno-7-146"></a>        <span class="k">for</span> <span class="n">component</span><span class="p">,</span> <span class="n">allocated</span> <span class="ow">in</span> <span class="n">adjustments</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a href="#__codelineno-7-147" id="__codelineno-7-147" name="__codelineno-7-147"></a>            <span class="n">needed</span> <span class="o">=</span> <span class="n">component_needs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a href="#__codelineno-7-148" id="__codelineno-7-148" name="__codelineno-7-148"></a>            <span class="k">if</span> <span class="n">needed</span> <span class="o">&gt;</span> <span class="n">allocated</span><span class="p">:</span>
<a href="#__codelineno-7-149" id="__codelineno-7-149" name="__codelineno-7-149"></a>                <span class="n">additional</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">needed</span> <span class="o">-</span> <span class="n">allocated</span><span class="p">)</span> <span class="o">*</span> <span class="n">redistribution_ratio</span><span class="p">)</span>
<a href="#__codelineno-7-150" id="__codelineno-7-150" name="__codelineno-7-150"></a>                <span class="n">adjustments</span><span class="p">[</span><span class="n">component</span><span class="p">]</span> <span class="o">+=</span> <span class="n">additional</span>
<a href="#__codelineno-7-151" id="__codelineno-7-151" name="__codelineno-7-151"></a>                <span class="n">unused_tokens</span> <span class="o">-=</span> <span class="n">additional</span>
<a href="#__codelineno-7-152" id="__codelineno-7-152" name="__codelineno-7-152"></a>
<a href="#__codelineno-7-153" id="__codelineno-7-153" name="__codelineno-7-153"></a>    <span class="c1"># Any remaining unused tokens go to buffer</span>
<a href="#__codelineno-7-154" id="__codelineno-7-154" name="__codelineno-7-154"></a>    <span class="n">adjustments</span><span class="p">[</span><span class="s1">'buffer'</span><span class="p">]</span> <span class="o">=</span> <span class="n">adjustments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'buffer'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">unused_tokens</span>
<a href="#__codelineno-7-155" id="__codelineno-7-155" name="__codelineno-7-155"></a>
<a href="#__codelineno-7-156" id="__codelineno-7-156" name="__codelineno-7-156"></a>    <span class="k">return</span> <span class="n">TokenBudget</span><span class="p">(</span>
<a href="#__codelineno-7-157" id="__codelineno-7-157" name="__codelineno-7-157"></a>        <span class="n">total_budget</span><span class="o">=</span><span class="n">total_tokens</span><span class="p">,</span>
<a href="#__codelineno-7-158" id="__codelineno-7-158" name="__codelineno-7-158"></a>        <span class="n">core_context</span><span class="o">=</span><span class="n">adjustments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'core_context'</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a href="#__codelineno-7-159" id="__codelineno-7-159" name="__codelineno-7-159"></a>        <span class="n">dependencies</span><span class="o">=</span><span class="n">adjustments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'dependencies'</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a href="#__codelineno-7-160" id="__codelineno-7-160" name="__codelineno-7-160"></a>        <span class="n">agent_memory</span><span class="o">=</span><span class="n">adjustments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'agent_memory'</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a href="#__codelineno-7-161" id="__codelineno-7-161" name="__codelineno-7-161"></a>        <span class="n">metadata</span><span class="o">=</span><span class="n">adjustments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'documentation'</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a href="#__codelineno-7-162" id="__codelineno-7-162" name="__codelineno-7-162"></a>        <span class="n">buffer</span><span class="o">=</span><span class="n">adjustments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'buffer'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a href="#__codelineno-7-163" id="__codelineno-7-163" name="__codelineno-7-163"></a>    <span class="p">)</span>
</code></pre></div>
<h2 id="dependency-analysis-algorithm">Dependency Analysis Algorithm<a class="headerlink" href="#dependency-analysis-algorithm" title="Permanent link">¶</a></h2>
<h3 id="static-dependency-analysis">Static Dependency Analysis<a class="headerlink" href="#static-dependency-analysis" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">def</span> <span class="nf">build_dependency_graph</span><span class="p">(</span><span class="n">project_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">    </span><span class="sd">"""</span>
<a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="sd">    Build comprehensive dependency graph for project</span>
<a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a>
<a href="#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="sd">    Returns:</span>
<a href="#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="sd">        Dict mapping file paths to sets of their dependencies</span>
<a href="#__codelineno-8-7" id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="sd">    """</span>
<a href="#__codelineno-8-8" id="__codelineno-8-8" name="__codelineno-8-8"></a>
<a href="#__codelineno-8-9" id="__codelineno-8-9" name="__codelineno-8-9"></a>    <span class="n">dependency_graph</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-8-10" id="__codelineno-8-10" name="__codelineno-8-10"></a>
<a href="#__codelineno-8-11" id="__codelineno-8-11" name="__codelineno-8-11"></a>    <span class="c1"># Find all Python files</span>
<a href="#__codelineno-8-12" id="__codelineno-8-12" name="__codelineno-8-12"></a>    <span class="n">python_files</span> <span class="o">=</span> <span class="n">find_python_files</span><span class="p">(</span><span class="n">project_path</span><span class="p">)</span>
<a href="#__codelineno-8-13" id="__codelineno-8-13" name="__codelineno-8-13"></a>
<a href="#__codelineno-8-14" id="__codelineno-8-14" name="__codelineno-8-14"></a>    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">python_files</span><span class="p">:</span>
<a href="#__codelineno-8-15" id="__codelineno-8-15" name="__codelineno-8-15"></a>        <span class="n">dependencies</span> <span class="o">=</span> <span class="n">extract_file_dependencies</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">project_path</span><span class="p">)</span>
<a href="#__codelineno-8-16" id="__codelineno-8-16" name="__codelineno-8-16"></a>        <span class="n">dependency_graph</span><span class="p">[</span><span class="n">file_path</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">dependencies</span><span class="p">)</span>
<a href="#__codelineno-8-17" id="__codelineno-8-17" name="__codelineno-8-17"></a>
<a href="#__codelineno-8-18" id="__codelineno-8-18" name="__codelineno-8-18"></a>    <span class="c1"># Add reverse dependencies</span>
<a href="#__codelineno-8-19" id="__codelineno-8-19" name="__codelineno-8-19"></a>    <span class="n">reverse_graph</span> <span class="o">=</span> <span class="n">build_reverse_dependencies</span><span class="p">(</span><span class="n">dependency_graph</span><span class="p">)</span>
<a href="#__codelineno-8-20" id="__codelineno-8-20" name="__codelineno-8-20"></a>
<a href="#__codelineno-8-21" id="__codelineno-8-21" name="__codelineno-8-21"></a>    <span class="k">return</span> <span class="p">{</span>
<a href="#__codelineno-8-22" id="__codelineno-8-22" name="__codelineno-8-22"></a>        <span class="s1">'forward'</span><span class="p">:</span> <span class="n">dependency_graph</span><span class="p">,</span>
<a href="#__codelineno-8-23" id="__codelineno-8-23" name="__codelineno-8-23"></a>        <span class="s1">'reverse'</span><span class="p">:</span> <span class="n">reverse_graph</span>
<a href="#__codelineno-8-24" id="__codelineno-8-24" name="__codelineno-8-24"></a>    <span class="p">}</span>
<a href="#__codelineno-8-25" id="__codelineno-8-25" name="__codelineno-8-25"></a>
<a href="#__codelineno-8-26" id="__codelineno-8-26" name="__codelineno-8-26"></a><span class="k">def</span> <span class="nf">extract_file_dependencies</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">project_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a href="#__codelineno-8-27" id="__codelineno-8-27" name="__codelineno-8-27"></a><span class="w">    </span><span class="sd">"""Extract dependencies from a single Python file"""</span>
<a href="#__codelineno-8-28" id="__codelineno-8-28" name="__codelineno-8-28"></a>
<a href="#__codelineno-8-29" id="__codelineno-8-29" name="__codelineno-8-29"></a>    <span class="k">try</span><span class="p">:</span>
<a href="#__codelineno-8-30" id="__codelineno-8-30" name="__codelineno-8-30"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">'utf-8'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a href="#__codelineno-8-31" id="__codelineno-8-31" name="__codelineno-8-31"></a>            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a href="#__codelineno-8-32" id="__codelineno-8-32" name="__codelineno-8-32"></a>
<a href="#__codelineno-8-33" id="__codelineno-8-33" name="__codelineno-8-33"></a>        <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<a href="#__codelineno-8-34" id="__codelineno-8-34" name="__codelineno-8-34"></a>        <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-8-35" id="__codelineno-8-35" name="__codelineno-8-35"></a>
<a href="#__codelineno-8-36" id="__codelineno-8-36" name="__codelineno-8-36"></a>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
<a href="#__codelineno-8-37" id="__codelineno-8-37" name="__codelineno-8-37"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Import</span><span class="p">):</span>
<a href="#__codelineno-8-38" id="__codelineno-8-38" name="__codelineno-8-38"></a>                <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
<a href="#__codelineno-8-39" id="__codelineno-8-39" name="__codelineno-8-39"></a>                    <span class="n">dep_path</span> <span class="o">=</span> <span class="n">resolve_import_path</span><span class="p">(</span><span class="n">alias</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">project_root</span><span class="p">)</span>
<a href="#__codelineno-8-40" id="__codelineno-8-40" name="__codelineno-8-40"></a>                    <span class="k">if</span> <span class="n">dep_path</span><span class="p">:</span>
<a href="#__codelineno-8-41" id="__codelineno-8-41" name="__codelineno-8-41"></a>                        <span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dep_path</span><span class="p">)</span>
<a href="#__codelineno-8-42" id="__codelineno-8-42" name="__codelineno-8-42"></a>
<a href="#__codelineno-8-43" id="__codelineno-8-43" name="__codelineno-8-43"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">ImportFrom</span><span class="p">):</span>
<a href="#__codelineno-8-44" id="__codelineno-8-44" name="__codelineno-8-44"></a>                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">module</span><span class="p">:</span>
<a href="#__codelineno-8-45" id="__codelineno-8-45" name="__codelineno-8-45"></a>                    <span class="n">dep_path</span> <span class="o">=</span> <span class="n">resolve_import_path</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">project_root</span><span class="p">)</span>
<a href="#__codelineno-8-46" id="__codelineno-8-46" name="__codelineno-8-46"></a>                    <span class="k">if</span> <span class="n">dep_path</span><span class="p">:</span>
<a href="#__codelineno-8-47" id="__codelineno-8-47" name="__codelineno-8-47"></a>                        <span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dep_path</span><span class="p">)</span>
<a href="#__codelineno-8-48" id="__codelineno-8-48" name="__codelineno-8-48"></a>
<a href="#__codelineno-8-49" id="__codelineno-8-49" name="__codelineno-8-49"></a>        <span class="k">return</span> <span class="n">dependencies</span>
<a href="#__codelineno-8-50" id="__codelineno-8-50" name="__codelineno-8-50"></a>
<a href="#__codelineno-8-51" id="__codelineno-8-51" name="__codelineno-8-51"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a href="#__codelineno-8-52" id="__codelineno-8-52" name="__codelineno-8-52"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Could not analyze dependencies for </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-8-53" id="__codelineno-8-53" name="__codelineno-8-53"></a>        <span class="k">return</span> <span class="p">[]</span>
<a href="#__codelineno-8-54" id="__codelineno-8-54" name="__codelineno-8-54"></a>
<a href="#__codelineno-8-55" id="__codelineno-8-55" name="__codelineno-8-55"></a><span class="k">def</span> <span class="nf">resolve_import_path</span><span class="p">(</span><span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">source_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">project_root</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a href="#__codelineno-8-56" id="__codelineno-8-56" name="__codelineno-8-56"></a><span class="w">    </span><span class="sd">"""Resolve import module name to actual file path"""</span>
<a href="#__codelineno-8-57" id="__codelineno-8-57" name="__codelineno-8-57"></a>
<a href="#__codelineno-8-58" id="__codelineno-8-58" name="__codelineno-8-58"></a>    <span class="c1"># Handle relative imports</span>
<a href="#__codelineno-8-59" id="__codelineno-8-59" name="__codelineno-8-59"></a>    <span class="k">if</span> <span class="n">module_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'.'</span><span class="p">):</span>
<a href="#__codelineno-8-60" id="__codelineno-8-60" name="__codelineno-8-60"></a>        <span class="k">return</span> <span class="n">resolve_relative_import</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">source_file</span><span class="p">,</span> <span class="n">project_root</span><span class="p">)</span>
<a href="#__codelineno-8-61" id="__codelineno-8-61" name="__codelineno-8-61"></a>
<a href="#__codelineno-8-62" id="__codelineno-8-62" name="__codelineno-8-62"></a>    <span class="c1"># Handle absolute imports within project</span>
<a href="#__codelineno-8-63" id="__codelineno-8-63" name="__codelineno-8-63"></a>    <span class="k">if</span> <span class="n">is_project_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">project_root</span><span class="p">):</span>
<a href="#__codelineno-8-64" id="__codelineno-8-64" name="__codelineno-8-64"></a>        <span class="k">return</span> <span class="n">resolve_project_import</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">project_root</span><span class="p">)</span>
<a href="#__codelineno-8-65" id="__codelineno-8-65" name="__codelineno-8-65"></a>
<a href="#__codelineno-8-66" id="__codelineno-8-66" name="__codelineno-8-66"></a>    <span class="c1"># External dependencies (not resolved to file paths)</span>
<a href="#__codelineno-8-67" id="__codelineno-8-67" name="__codelineno-8-67"></a>    <span class="k">return</span> <span class="kc">None</span>
<a href="#__codelineno-8-68" id="__codelineno-8-68" name="__codelineno-8-68"></a>
<a href="#__codelineno-8-69" id="__codelineno-8-69" name="__codelineno-8-69"></a><span class="k">def</span> <span class="nf">calculate_transitive_dependencies</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a href="#__codelineno-8-70" id="__codelineno-8-70" name="__codelineno-8-70"></a>                                    <span class="n">dependency_graph</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> 
<a href="#__codelineno-8-71" id="__codelineno-8-71" name="__codelineno-8-71"></a>                                    <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a href="#__codelineno-8-72" id="__codelineno-8-72" name="__codelineno-8-72"></a><span class="w">    </span><span class="sd">"""Calculate transitive dependencies up to max_depth"""</span>
<a href="#__codelineno-8-73" id="__codelineno-8-73" name="__codelineno-8-73"></a>
<a href="#__codelineno-8-74" id="__codelineno-8-74" name="__codelineno-8-74"></a>    <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a href="#__codelineno-8-75" id="__codelineno-8-75" name="__codelineno-8-75"></a>    <span class="n">to_visit</span> <span class="o">=</span> <span class="p">[(</span><span class="n">file_path</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
<a href="#__codelineno-8-76" id="__codelineno-8-76" name="__codelineno-8-76"></a>    <span class="n">transitive_deps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a href="#__codelineno-8-77" id="__codelineno-8-77" name="__codelineno-8-77"></a>
<a href="#__codelineno-8-78" id="__codelineno-8-78" name="__codelineno-8-78"></a>    <span class="k">while</span> <span class="n">to_visit</span><span class="p">:</span>
<a href="#__codelineno-8-79" id="__codelineno-8-79" name="__codelineno-8-79"></a>        <span class="n">current_file</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">to_visit</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a href="#__codelineno-8-80" id="__codelineno-8-80" name="__codelineno-8-80"></a>
<a href="#__codelineno-8-81" id="__codelineno-8-81" name="__codelineno-8-81"></a>        <span class="k">if</span> <span class="n">current_file</span> <span class="ow">in</span> <span class="n">visited</span> <span class="ow">or</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="n">max_depth</span><span class="p">:</span>
<a href="#__codelineno-8-82" id="__codelineno-8-82" name="__codelineno-8-82"></a>            <span class="k">continue</span>
<a href="#__codelineno-8-83" id="__codelineno-8-83" name="__codelineno-8-83"></a>
<a href="#__codelineno-8-84" id="__codelineno-8-84" name="__codelineno-8-84"></a>        <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">current_file</span><span class="p">)</span>
<a href="#__codelineno-8-85" id="__codelineno-8-85" name="__codelineno-8-85"></a>
<a href="#__codelineno-8-86" id="__codelineno-8-86" name="__codelineno-8-86"></a>        <span class="c1"># Get direct dependencies</span>
<a href="#__codelineno-8-87" id="__codelineno-8-87" name="__codelineno-8-87"></a>        <span class="n">direct_deps</span> <span class="o">=</span> <span class="n">dependency_graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">current_file</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
<a href="#__codelineno-8-88" id="__codelineno-8-88" name="__codelineno-8-88"></a>
<a href="#__codelineno-8-89" id="__codelineno-8-89" name="__codelineno-8-89"></a>        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">direct_deps</span><span class="p">:</span>
<a href="#__codelineno-8-90" id="__codelineno-8-90" name="__codelineno-8-90"></a>            <span class="k">if</span> <span class="n">dep</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
<a href="#__codelineno-8-91" id="__codelineno-8-91" name="__codelineno-8-91"></a>                <span class="n">transitive_deps</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
<a href="#__codelineno-8-92" id="__codelineno-8-92" name="__codelineno-8-92"></a>                <span class="n">to_visit</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dep</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a href="#__codelineno-8-93" id="__codelineno-8-93" name="__codelineno-8-93"></a>
<a href="#__codelineno-8-94" id="__codelineno-8-94" name="__codelineno-8-94"></a>    <span class="k">return</span> <span class="n">transitive_deps</span>
<a href="#__codelineno-8-95" id="__codelineno-8-95" name="__codelineno-8-95"></a>
<a href="#__codelineno-8-96" id="__codelineno-8-96" name="__codelineno-8-96"></a><span class="k">def</span> <span class="nf">calculate_dependency_impact_score</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a href="#__codelineno-8-97" id="__codelineno-8-97" name="__codelineno-8-97"></a>                                    <span class="n">dependency_graph</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a href="#__codelineno-8-98" id="__codelineno-8-98" name="__codelineno-8-98"></a><span class="w">    </span><span class="sd">"""</span>
<a href="#__codelineno-8-99" id="__codelineno-8-99" name="__codelineno-8-99"></a><span class="sd">    Calculate impact score based on how many files depend on this file</span>
<a href="#__codelineno-8-100" id="__codelineno-8-100" name="__codelineno-8-100"></a><span class="sd">    Higher score = more files depend on this file</span>
<a href="#__codelineno-8-101" id="__codelineno-8-101" name="__codelineno-8-101"></a><span class="sd">    """</span>
<a href="#__codelineno-8-102" id="__codelineno-8-102" name="__codelineno-8-102"></a>
<a href="#__codelineno-8-103" id="__codelineno-8-103" name="__codelineno-8-103"></a>    <span class="n">reverse_deps</span> <span class="o">=</span> <span class="n">dependency_graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'reverse'</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
<a href="#__codelineno-8-104" id="__codelineno-8-104" name="__codelineno-8-104"></a>
<a href="#__codelineno-8-105" id="__codelineno-8-105" name="__codelineno-8-105"></a>    <span class="c1"># Calculate direct impact</span>
<a href="#__codelineno-8-106" id="__codelineno-8-106" name="__codelineno-8-106"></a>    <span class="n">direct_impact</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reverse_deps</span><span class="p">)</span>
<a href="#__codelineno-8-107" id="__codelineno-8-107" name="__codelineno-8-107"></a>
<a href="#__codelineno-8-108" id="__codelineno-8-108" name="__codelineno-8-108"></a>    <span class="c1"># Calculate transitive impact (files that depend on dependents)</span>
<a href="#__codelineno-8-109" id="__codelineno-8-109" name="__codelineno-8-109"></a>    <span class="n">transitive_impact</span> <span class="o">=</span> <span class="mi">0</span>
<a href="#__codelineno-8-110" id="__codelineno-8-110" name="__codelineno-8-110"></a>    <span class="k">for</span> <span class="n">dep_file</span> <span class="ow">in</span> <span class="n">reverse_deps</span><span class="p">:</span>
<a href="#__codelineno-8-111" id="__codelineno-8-111" name="__codelineno-8-111"></a>        <span class="n">transitive_deps</span> <span class="o">=</span> <span class="n">dependency_graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'reverse'</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dep_file</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
<a href="#__codelineno-8-112" id="__codelineno-8-112" name="__codelineno-8-112"></a>        <span class="n">transitive_impact</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">transitive_deps</span><span class="p">)</span>
<a href="#__codelineno-8-113" id="__codelineno-8-113" name="__codelineno-8-113"></a>
<a href="#__codelineno-8-114" id="__codelineno-8-114" name="__codelineno-8-114"></a>    <span class="c1"># Normalize impact score</span>
<a href="#__codelineno-8-115" id="__codelineno-8-115" name="__codelineno-8-115"></a>    <span class="n">max_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'forward'</span><span class="p">,</span> <span class="p">{}))</span>
<a href="#__codelineno-8-116" id="__codelineno-8-116" name="__codelineno-8-116"></a>    <span class="k">if</span> <span class="n">max_files</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a href="#__codelineno-8-117" id="__codelineno-8-117" name="__codelineno-8-117"></a>        <span class="k">return</span> <span class="mf">0.0</span>
<a href="#__codelineno-8-118" id="__codelineno-8-118" name="__codelineno-8-118"></a>
<a href="#__codelineno-8-119" id="__codelineno-8-119" name="__codelineno-8-119"></a>    <span class="c1"># Weight direct impact more heavily than transitive</span>
<a href="#__codelineno-8-120" id="__codelineno-8-120" name="__codelineno-8-120"></a>    <span class="n">total_impact</span> <span class="o">=</span> <span class="n">direct_impact</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">transitive_impact</span><span class="p">)</span>
<a href="#__codelineno-8-121" id="__codelineno-8-121" name="__codelineno-8-121"></a>    <span class="n">normalized_score</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">total_impact</span> <span class="o">/</span> <span class="n">max_files</span><span class="p">)</span>
<a href="#__codelineno-8-122" id="__codelineno-8-122" name="__codelineno-8-122"></a>
<a href="#__codelineno-8-123" id="__codelineno-8-123" name="__codelineno-8-123"></a>    <span class="k">return</span> <span class="n">normalized_score</span>
</code></pre></div>
<h2 id="caching-and-performance-algorithms">Caching and Performance Algorithms<a class="headerlink" href="#caching-and-performance-algorithms" title="Permanent link">¶</a></h2>
<h3 id="intelligent-cache-management">Intelligent Cache Management<a class="headerlink" href="#intelligent-cache-management" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="k">class</span> <span class="nc">IntelligentCache</span><span class="p">:</span>
<a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">    </span><span class="sd">"""</span>
<a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="sd">    Intelligent caching system with predictive pre-loading and adaptive eviction</span>
<a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="sd">    """</span>
<a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a>
<a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_size_mb</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">):</span>
<a href="#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_size_mb</span> <span class="o">=</span> <span class="n">max_size_mb</span>
<a href="#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">access_patterns</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-9-10" id="__codelineno-9-10" name="__codelineno-9-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prediction_model</span> <span class="o">=</span> <span class="n">CachePredictor</span><span class="p">()</span>
<a href="#__codelineno-9-11" id="__codelineno-9-11" name="__codelineno-9-11"></a>
<a href="#__codelineno-9-12" id="__codelineno-9-12" name="__codelineno-9-12"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">ContextRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AgentContext</span><span class="p">]:</span>
<a href="#__codelineno-9-13" id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w">        </span><span class="sd">"""Get context from cache with pattern learning"""</span>
<a href="#__codelineno-9-14" id="__codelineno-9-14" name="__codelineno-9-14"></a>
<a href="#__codelineno-9-15" id="__codelineno-9-15" name="__codelineno-9-15"></a>        <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_cache_key</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a href="#__codelineno-9-16" id="__codelineno-9-16" name="__codelineno-9-16"></a>
<a href="#__codelineno-9-17" id="__codelineno-9-17" name="__codelineno-9-17"></a>        <span class="c1"># Record access pattern</span>
<a href="#__codelineno-9-18" id="__codelineno-9-18" name="__codelineno-9-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">record_access_pattern</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
<a href="#__codelineno-9-19" id="__codelineno-9-19" name="__codelineno-9-19"></a>
<a href="#__codelineno-9-20" id="__codelineno-9-20" name="__codelineno-9-20"></a>        <span class="c1"># Check cache</span>
<a href="#__codelineno-9-21" id="__codelineno-9-21" name="__codelineno-9-21"></a>        <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
<a href="#__codelineno-9-22" id="__codelineno-9-22" name="__codelineno-9-22"></a>            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
<a href="#__codelineno-9-23" id="__codelineno-9-23" name="__codelineno-9-23"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_context_valid</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<a href="#__codelineno-9-24" id="__codelineno-9-24" name="__codelineno-9-24"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">update_access_time</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
<a href="#__codelineno-9-25" id="__codelineno-9-25" name="__codelineno-9-25"></a>                <span class="k">return</span> <span class="n">context</span>
<a href="#__codelineno-9-26" id="__codelineno-9-26" name="__codelineno-9-26"></a>
<a href="#__codelineno-9-27" id="__codelineno-9-27" name="__codelineno-9-27"></a>        <span class="k">return</span> <span class="kc">None</span>
<a href="#__codelineno-9-28" id="__codelineno-9-28" name="__codelineno-9-28"></a>
<a href="#__codelineno-9-29" id="__codelineno-9-29" name="__codelineno-9-29"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">store_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">ContextRequest</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">AgentContext</span><span class="p">):</span>
<a href="#__codelineno-9-30" id="__codelineno-9-30" name="__codelineno-9-30"></a><span class="w">        </span><span class="sd">"""Store context with intelligent eviction"""</span>
<a href="#__codelineno-9-31" id="__codelineno-9-31" name="__codelineno-9-31"></a>
<a href="#__codelineno-9-32" id="__codelineno-9-32" name="__codelineno-9-32"></a>        <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_cache_key</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a href="#__codelineno-9-33" id="__codelineno-9-33" name="__codelineno-9-33"></a>
<a href="#__codelineno-9-34" id="__codelineno-9-34" name="__codelineno-9-34"></a>        <span class="c1"># Check if we need to evict items</span>
<a href="#__codelineno-9-35" id="__codelineno-9-35" name="__codelineno-9-35"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_evict</span><span class="p">():</span>
<a href="#__codelineno-9-36" id="__codelineno-9-36" name="__codelineno-9-36"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">intelligent_eviction</span><span class="p">()</span>
<a href="#__codelineno-9-37" id="__codelineno-9-37" name="__codelineno-9-37"></a>
<a href="#__codelineno-9-38" id="__codelineno-9-38" name="__codelineno-9-38"></a>        <span class="c1"># Store context</span>
<a href="#__codelineno-9-39" id="__codelineno-9-39" name="__codelineno-9-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span>
<a href="#__codelineno-9-40" id="__codelineno-9-40" name="__codelineno-9-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_cache_metadata</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a href="#__codelineno-9-41" id="__codelineno-9-41" name="__codelineno-9-41"></a>
<a href="#__codelineno-9-42" id="__codelineno-9-42" name="__codelineno-9-42"></a>        <span class="c1"># Trigger predictive caching</span>
<a href="#__codelineno-9-43" id="__codelineno-9-43" name="__codelineno-9-43"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictive_cache_warming</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a href="#__codelineno-9-44" id="__codelineno-9-44" name="__codelineno-9-44"></a>
<a href="#__codelineno-9-45" id="__codelineno-9-45" name="__codelineno-9-45"></a>    <span class="k">def</span> <span class="nf">generate_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">ContextRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a href="#__codelineno-9-46" id="__codelineno-9-46" name="__codelineno-9-46"></a><span class="w">        </span><span class="sd">"""Generate cache key considering context factors"""</span>
<a href="#__codelineno-9-47" id="__codelineno-9-47" name="__codelineno-9-47"></a>
<a href="#__codelineno-9-48" id="__codelineno-9-48" name="__codelineno-9-48"></a>        <span class="c1"># Include factors that affect context relevance</span>
<a href="#__codelineno-9-49" id="__codelineno-9-49" name="__codelineno-9-49"></a>        <span class="n">factors</span> <span class="o">=</span> <span class="p">[</span>
<a href="#__codelineno-9-50" id="__codelineno-9-50" name="__codelineno-9-50"></a>            <span class="n">request</span><span class="o">.</span><span class="n">agent_type</span><span class="p">,</span>
<a href="#__codelineno-9-51" id="__codelineno-9-51" name="__codelineno-9-51"></a>            <span class="n">request</span><span class="o">.</span><span class="n">story_id</span><span class="p">,</span>
<a href="#__codelineno-9-52" id="__codelineno-9-52" name="__codelineno-9-52"></a>            <span class="n">request</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">current_state</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a href="#__codelineno-9-53" id="__codelineno-9-53" name="__codelineno-9-53"></a>            <span class="nb">hash</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">source_files</span><span class="p">))),</span>
<a href="#__codelineno-9-54" id="__codelineno-9-54" name="__codelineno-9-54"></a>            <span class="nb">hash</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">test_files</span><span class="p">))),</span>
<a href="#__codelineno-9-55" id="__codelineno-9-55" name="__codelineno-9-55"></a>            <span class="n">request</span><span class="o">.</span><span class="n">compression_level</span>
<a href="#__codelineno-9-56" id="__codelineno-9-56" name="__codelineno-9-56"></a>        <span class="p">]</span>
<a href="#__codelineno-9-57" id="__codelineno-9-57" name="__codelineno-9-57"></a>
<a href="#__codelineno-9-58" id="__codelineno-9-58" name="__codelineno-9-58"></a>        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">factors</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<a href="#__codelineno-9-59" id="__codelineno-9-59" name="__codelineno-9-59"></a>
<a href="#__codelineno-9-60" id="__codelineno-9-60" name="__codelineno-9-60"></a>    <span class="k">def</span> <span class="nf">is_context_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">AgentContext</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">ContextRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a href="#__codelineno-9-61" id="__codelineno-9-61" name="__codelineno-9-61"></a><span class="w">        </span><span class="sd">"""Check if cached context is still valid"""</span>
<a href="#__codelineno-9-62" id="__codelineno-9-62" name="__codelineno-9-62"></a>
<a href="#__codelineno-9-63" id="__codelineno-9-63" name="__codelineno-9-63"></a>        <span class="c1"># Check context age</span>
<a href="#__codelineno-9-64" id="__codelineno-9-64" name="__codelineno-9-64"></a>        <span class="n">context_age</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">context</span><span class="o">.</span><span class="n">created_at</span>
<a href="#__codelineno-9-65" id="__codelineno-9-65" name="__codelineno-9-65"></a>        <span class="k">if</span> <span class="n">context_age</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">):</span>
<a href="#__codelineno-9-66" id="__codelineno-9-66" name="__codelineno-9-66"></a>            <span class="k">return</span> <span class="kc">False</span>
<a href="#__codelineno-9-67" id="__codelineno-9-67" name="__codelineno-9-67"></a>
<a href="#__codelineno-9-68" id="__codelineno-9-68" name="__codelineno-9-68"></a>        <span class="c1"># Check if source files have changed</span>
<a href="#__codelineno-9-69" id="__codelineno-9-69" name="__codelineno-9-69"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">have_files_changed</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">source_files</span><span class="p">):</span>
<a href="#__codelineno-9-70" id="__codelineno-9-70" name="__codelineno-9-70"></a>            <span class="k">return</span> <span class="kc">False</span>
<a href="#__codelineno-9-71" id="__codelineno-9-71" name="__codelineno-9-71"></a>
<a href="#__codelineno-9-72" id="__codelineno-9-72" name="__codelineno-9-72"></a>        <span class="c1"># Check if task requirements have significantly changed</span>
<a href="#__codelineno-9-73" id="__codelineno-9-73" name="__codelineno-9-73"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_task_changed_significantly</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">task_hash</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">task</span><span class="p">):</span>
<a href="#__codelineno-9-74" id="__codelineno-9-74" name="__codelineno-9-74"></a>            <span class="k">return</span> <span class="kc">False</span>
<a href="#__codelineno-9-75" id="__codelineno-9-75" name="__codelineno-9-75"></a>
<a href="#__codelineno-9-76" id="__codelineno-9-76" name="__codelineno-9-76"></a>        <span class="k">return</span> <span class="kc">True</span>
<a href="#__codelineno-9-77" id="__codelineno-9-77" name="__codelineno-9-77"></a>
<a href="#__codelineno-9-78" id="__codelineno-9-78" name="__codelineno-9-78"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">intelligent_eviction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-9-79" id="__codelineno-9-79" name="__codelineno-9-79"></a><span class="w">        </span><span class="sd">"""Evict cache items using intelligent strategy"""</span>
<a href="#__codelineno-9-80" id="__codelineno-9-80" name="__codelineno-9-80"></a>
<a href="#__codelineno-9-81" id="__codelineno-9-81" name="__codelineno-9-81"></a>        <span class="c1"># Calculate eviction scores for all cached items</span>
<a href="#__codelineno-9-82" id="__codelineno-9-82" name="__codelineno-9-82"></a>        <span class="n">eviction_scores</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-9-83" id="__codelineno-9-83" name="__codelineno-9-83"></a>
<a href="#__codelineno-9-84" id="__codelineno-9-84" name="__codelineno-9-84"></a>        <span class="k">for</span> <span class="n">cache_key</span><span class="p">,</span> <span class="n">context</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a href="#__codelineno-9-85" id="__codelineno-9-85" name="__codelineno-9-85"></a>            <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_eviction_score</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a href="#__codelineno-9-86" id="__codelineno-9-86" name="__codelineno-9-86"></a>            <span class="n">eviction_scores</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>
<a href="#__codelineno-9-87" id="__codelineno-9-87" name="__codelineno-9-87"></a>
<a href="#__codelineno-9-88" id="__codelineno-9-88" name="__codelineno-9-88"></a>        <span class="c1"># Sort by eviction score (higher = more likely to evict)</span>
<a href="#__codelineno-9-89" id="__codelineno-9-89" name="__codelineno-9-89"></a>        <span class="n">sorted_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">eviction_scores</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a href="#__codelineno-9-90" id="__codelineno-9-90" name="__codelineno-9-90"></a>
<a href="#__codelineno-9-91" id="__codelineno-9-91" name="__codelineno-9-91"></a>        <span class="c1"># Evict items until we're under the size limit</span>
<a href="#__codelineno-9-92" id="__codelineno-9-92" name="__codelineno-9-92"></a>        <span class="n">current_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cache_size_mb</span><span class="p">()</span>
<a href="#__codelineno-9-93" id="__codelineno-9-93" name="__codelineno-9-93"></a>        <span class="n">target_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_size_mb</span> <span class="o">*</span> <span class="mf">0.8</span>  <span class="c1"># Leave 20% buffer</span>
<a href="#__codelineno-9-94" id="__codelineno-9-94" name="__codelineno-9-94"></a>
<a href="#__codelineno-9-95" id="__codelineno-9-95" name="__codelineno-9-95"></a>        <span class="k">for</span> <span class="n">cache_key</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">sorted_items</span><span class="p">:</span>
<a href="#__codelineno-9-96" id="__codelineno-9-96" name="__codelineno-9-96"></a>            <span class="k">if</span> <span class="n">current_size</span> <span class="o">&lt;=</span> <span class="n">target_size</span><span class="p">:</span>
<a href="#__codelineno-9-97" id="__codelineno-9-97" name="__codelineno-9-97"></a>                <span class="k">break</span>
<a href="#__codelineno-9-98" id="__codelineno-9-98" name="__codelineno-9-98"></a>
<a href="#__codelineno-9-99" id="__codelineno-9-99" name="__codelineno-9-99"></a>            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
<a href="#__codelineno-9-100" id="__codelineno-9-100" name="__codelineno-9-100"></a>            <span class="n">current_size</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_context_size_mb</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a href="#__codelineno-9-101" id="__codelineno-9-101" name="__codelineno-9-101"></a>
<a href="#__codelineno-9-102" id="__codelineno-9-102" name="__codelineno-9-102"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Evicted cache item </span><span class="si">{</span><span class="n">cache_key</span><span class="si">}</span><span class="s2"> (score: </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
<a href="#__codelineno-9-103" id="__codelineno-9-103" name="__codelineno-9-103"></a>
<a href="#__codelineno-9-104" id="__codelineno-9-104" name="__codelineno-9-104"></a>    <span class="k">def</span> <span class="nf">calculate_eviction_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">AgentContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a href="#__codelineno-9-105" id="__codelineno-9-105" name="__codelineno-9-105"></a><span class="w">        </span><span class="sd">"""Calculate eviction score (higher = more likely to evict)"""</span>
<a href="#__codelineno-9-106" id="__codelineno-9-106" name="__codelineno-9-106"></a>
<a href="#__codelineno-9-107" id="__codelineno-9-107" name="__codelineno-9-107"></a>        <span class="c1"># Factor 1: Age (older = higher eviction score)</span>
<a href="#__codelineno-9-108" id="__codelineno-9-108" name="__codelineno-9-108"></a>        <span class="n">age_hours</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">context</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span>
<a href="#__codelineno-9-109" id="__codelineno-9-109" name="__codelineno-9-109"></a>        <span class="n">age_score</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">age_hours</span> <span class="o">/</span> <span class="mi">24</span><span class="p">)</span>  <span class="c1"># Normalize to 24 hours</span>
<a href="#__codelineno-9-110" id="__codelineno-9-110" name="__codelineno-9-110"></a>
<a href="#__codelineno-9-111" id="__codelineno-9-111" name="__codelineno-9-111"></a>        <span class="c1"># Factor 2: Access frequency (less frequent = higher eviction score)</span>
<a href="#__codelineno-9-112" id="__codelineno-9-112" name="__codelineno-9-112"></a>        <span class="n">access_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_patterns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'count'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a href="#__codelineno-9-113" id="__codelineno-9-113" name="__codelineno-9-113"></a>        <span class="n">max_access</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'count'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_patterns</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a href="#__codelineno-9-114" id="__codelineno-9-114" name="__codelineno-9-114"></a>        <span class="n">frequency_score</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">access_count</span> <span class="o">/</span> <span class="n">max_access</span><span class="p">)</span>
<a href="#__codelineno-9-115" id="__codelineno-9-115" name="__codelineno-9-115"></a>
<a href="#__codelineno-9-116" id="__codelineno-9-116" name="__codelineno-9-116"></a>        <span class="c1"># Factor 3: Size (larger = higher eviction score for equal other factors)</span>
<a href="#__codelineno-9-117" id="__codelineno-9-117" name="__codelineno-9-117"></a>        <span class="n">size_mb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_context_size_mb</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a href="#__codelineno-9-118" id="__codelineno-9-118" name="__codelineno-9-118"></a>        <span class="n">max_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">estimate_context_size_mb</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a href="#__codelineno-9-119" id="__codelineno-9-119" name="__codelineno-9-119"></a>        <span class="n">size_score</span> <span class="o">=</span> <span class="n">size_mb</span> <span class="o">/</span> <span class="n">max_size</span>
<a href="#__codelineno-9-120" id="__codelineno-9-120" name="__codelineno-9-120"></a>
<a href="#__codelineno-9-121" id="__codelineno-9-121" name="__codelineno-9-121"></a>        <span class="c1"># Factor 4: Prediction score (less likely to be accessed = higher eviction score)</span>
<a href="#__codelineno-9-122" id="__codelineno-9-122" name="__codelineno-9-122"></a>        <span class="n">prediction_score</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_model</span><span class="o">.</span><span class="n">predict_access_probability</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
<a href="#__codelineno-9-123" id="__codelineno-9-123" name="__codelineno-9-123"></a>
<a href="#__codelineno-9-124" id="__codelineno-9-124" name="__codelineno-9-124"></a>        <span class="c1"># Weighted combination</span>
<a href="#__codelineno-9-125" id="__codelineno-9-125" name="__codelineno-9-125"></a>        <span class="n">eviction_score</span> <span class="o">=</span> <span class="p">(</span>
<a href="#__codelineno-9-126" id="__codelineno-9-126" name="__codelineno-9-126"></a>            <span class="mf">0.3</span> <span class="o">*</span> <span class="n">age_score</span> <span class="o">+</span>
<a href="#__codelineno-9-127" id="__codelineno-9-127" name="__codelineno-9-127"></a>            <span class="mf">0.3</span> <span class="o">*</span> <span class="n">frequency_score</span> <span class="o">+</span>
<a href="#__codelineno-9-128" id="__codelineno-9-128" name="__codelineno-9-128"></a>            <span class="mf">0.2</span> <span class="o">*</span> <span class="n">size_score</span> <span class="o">+</span>
<a href="#__codelineno-9-129" id="__codelineno-9-129" name="__codelineno-9-129"></a>            <span class="mf">0.2</span> <span class="o">*</span> <span class="n">prediction_score</span>
<a href="#__codelineno-9-130" id="__codelineno-9-130" name="__codelineno-9-130"></a>        <span class="p">)</span>
<a href="#__codelineno-9-131" id="__codelineno-9-131" name="__codelineno-9-131"></a>
<a href="#__codelineno-9-132" id="__codelineno-9-132" name="__codelineno-9-132"></a>        <span class="k">return</span> <span class="n">eviction_score</span>
<a href="#__codelineno-9-133" id="__codelineno-9-133" name="__codelineno-9-133"></a>
<a href="#__codelineno-9-134" id="__codelineno-9-134" name="__codelineno-9-134"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">predictive_cache_warming</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">ContextRequest</span><span class="p">):</span>
<a href="#__codelineno-9-135" id="__codelineno-9-135" name="__codelineno-9-135"></a><span class="w">        </span><span class="sd">"""Pre-warm cache with likely future requests"""</span>
<a href="#__codelineno-9-136" id="__codelineno-9-136" name="__codelineno-9-136"></a>
<a href="#__codelineno-9-137" id="__codelineno-9-137" name="__codelineno-9-137"></a>        <span class="c1"># Predict likely next requests based on current request</span>
<a href="#__codelineno-9-138" id="__codelineno-9-138" name="__codelineno-9-138"></a>        <span class="n">predicted_requests</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_model</span><span class="o">.</span><span class="n">predict_next_requests</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a href="#__codelineno-9-139" id="__codelineno-9-139" name="__codelineno-9-139"></a>
<a href="#__codelineno-9-140" id="__codelineno-9-140" name="__codelineno-9-140"></a>        <span class="k">for</span> <span class="n">predicted_request</span> <span class="ow">in</span> <span class="n">predicted_requests</span><span class="p">:</span>
<a href="#__codelineno-9-141" id="__codelineno-9-141" name="__codelineno-9-141"></a>            <span class="n">cache_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_cache_key</span><span class="p">(</span><span class="n">predicted_request</span><span class="p">)</span>
<a href="#__codelineno-9-142" id="__codelineno-9-142" name="__codelineno-9-142"></a>
<a href="#__codelineno-9-143" id="__codelineno-9-143" name="__codelineno-9-143"></a>            <span class="c1"># Only pre-warm if not already cached and high confidence</span>
<a href="#__codelineno-9-144" id="__codelineno-9-144" name="__codelineno-9-144"></a>            <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="ow">and</span> <span class="n">predicted_request</span><span class="o">.</span><span class="n">confidence</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">:</span>
<a href="#__codelineno-9-145" id="__codelineno-9-145" name="__codelineno-9-145"></a>                <span class="k">try</span><span class="p">:</span>
<a href="#__codelineno-9-146" id="__codelineno-9-146" name="__codelineno-9-146"></a>                    <span class="c1"># Prepare context in background</span>
<a href="#__codelineno-9-147" id="__codelineno-9-147" name="__codelineno-9-147"></a>                    <span class="n">context</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_manager</span><span class="o">.</span><span class="n">prepare_context</span><span class="p">(</span><span class="n">predicted_request</span><span class="p">)</span>
<a href="#__codelineno-9-148" id="__codelineno-9-148" name="__codelineno-9-148"></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_context</span><span class="p">(</span><span class="n">predicted_request</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a href="#__codelineno-9-149" id="__codelineno-9-149" name="__codelineno-9-149"></a>
<a href="#__codelineno-9-150" id="__codelineno-9-150" name="__codelineno-9-150"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Pre-warmed cache for predicted request: </span><span class="si">{</span><span class="n">cache_key</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-9-151" id="__codelineno-9-151" name="__codelineno-9-151"></a>
<a href="#__codelineno-9-152" id="__codelineno-9-152" name="__codelineno-9-152"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a href="#__codelineno-9-153" id="__codelineno-9-153" name="__codelineno-9-153"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to pre-warm cache: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-9-154" id="__codelineno-9-154" name="__codelineno-9-154"></a>
<a href="#__codelineno-9-155" id="__codelineno-9-155" name="__codelineno-9-155"></a><span class="k">class</span> <span class="nc">CachePredictor</span><span class="p">:</span>
<a href="#__codelineno-9-156" id="__codelineno-9-156" name="__codelineno-9-156"></a><span class="w">    </span><span class="sd">"""Predict future cache access patterns"""</span>
<a href="#__codelineno-9-157" id="__codelineno-9-157" name="__codelineno-9-157"></a>
<a href="#__codelineno-9-158" id="__codelineno-9-158" name="__codelineno-9-158"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-9-159" id="__codelineno-9-159" name="__codelineno-9-159"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pattern_history</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-9-160" id="__codelineno-9-160" name="__codelineno-9-160"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transition_matrix</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-9-161" id="__codelineno-9-161" name="__codelineno-9-161"></a>
<a href="#__codelineno-9-162" id="__codelineno-9-162" name="__codelineno-9-162"></a>    <span class="k">def</span> <span class="nf">predict_access_probability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a href="#__codelineno-9-163" id="__codelineno-9-163" name="__codelineno-9-163"></a><span class="w">        </span><span class="sd">"""Predict probability that cache_key will be accessed soon"""</span>
<a href="#__codelineno-9-164" id="__codelineno-9-164" name="__codelineno-9-164"></a>
<a href="#__codelineno-9-165" id="__codelineno-9-165" name="__codelineno-9-165"></a>        <span class="c1"># Use simple frequency-based prediction for now</span>
<a href="#__codelineno-9-166" id="__codelineno-9-166" name="__codelineno-9-166"></a>        <span class="c1"># Can be enhanced with ML models</span>
<a href="#__codelineno-9-167" id="__codelineno-9-167" name="__codelineno-9-167"></a>
<a href="#__codelineno-9-168" id="__codelineno-9-168" name="__codelineno-9-168"></a>        <span class="n">recent_accesses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_recent_access_patterns</span><span class="p">()</span>
<a href="#__codelineno-9-169" id="__codelineno-9-169" name="__codelineno-9-169"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">recent_accesses</span><span class="p">:</span>
<a href="#__codelineno-9-170" id="__codelineno-9-170" name="__codelineno-9-170"></a>            <span class="k">return</span> <span class="mf">0.5</span>  <span class="c1"># Default probability</span>
<a href="#__codelineno-9-171" id="__codelineno-9-171" name="__codelineno-9-171"></a>
<a href="#__codelineno-9-172" id="__codelineno-9-172" name="__codelineno-9-172"></a>        <span class="c1"># Count how often this key appears in recent patterns</span>
<a href="#__codelineno-9-173" id="__codelineno-9-173" name="__codelineno-9-173"></a>        <span class="n">appearances</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">recent_accesses</span> <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">)</span>
<a href="#__codelineno-9-174" id="__codelineno-9-174" name="__codelineno-9-174"></a>        <span class="n">probability</span> <span class="o">=</span> <span class="n">appearances</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">recent_accesses</span><span class="p">)</span>
<a href="#__codelineno-9-175" id="__codelineno-9-175" name="__codelineno-9-175"></a>
<a href="#__codelineno-9-176" id="__codelineno-9-176" name="__codelineno-9-176"></a>        <span class="k">return</span> <span class="n">probability</span>
<a href="#__codelineno-9-177" id="__codelineno-9-177" name="__codelineno-9-177"></a>
<a href="#__codelineno-9-178" id="__codelineno-9-178" name="__codelineno-9-178"></a>    <span class="k">def</span> <span class="nf">predict_next_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_request</span><span class="p">:</span> <span class="n">ContextRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ContextRequest</span><span class="p">]:</span>
<a href="#__codelineno-9-179" id="__codelineno-9-179" name="__codelineno-9-179"></a><span class="w">        </span><span class="sd">"""Predict likely next context requests"""</span>
<a href="#__codelineno-9-180" id="__codelineno-9-180" name="__codelineno-9-180"></a>
<a href="#__codelineno-9-181" id="__codelineno-9-181" name="__codelineno-9-181"></a>        <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-9-182" id="__codelineno-9-182" name="__codelineno-9-182"></a>
<a href="#__codelineno-9-183" id="__codelineno-9-183" name="__codelineno-9-183"></a>        <span class="c1"># Pattern 1: Same agent, next TDD phase</span>
<a href="#__codelineno-9-184" id="__codelineno-9-184" name="__codelineno-9-184"></a>        <span class="n">next_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_next_tdd_phase</span><span class="p">(</span><span class="n">current_request</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">current_state</span><span class="p">)</span>
<a href="#__codelineno-9-185" id="__codelineno-9-185" name="__codelineno-9-185"></a>        <span class="k">if</span> <span class="n">next_phase</span><span class="p">:</span>
<a href="#__codelineno-9-186" id="__codelineno-9-186" name="__codelineno-9-186"></a>            <span class="n">predicted_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_predicted_request</span><span class="p">(</span>
<a href="#__codelineno-9-187" id="__codelineno-9-187" name="__codelineno-9-187"></a>                <span class="n">current_request</span><span class="p">,</span> <span class="n">tdd_phase</span><span class="o">=</span><span class="n">next_phase</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="mf">0.8</span>
<a href="#__codelineno-9-188" id="__codelineno-9-188" name="__codelineno-9-188"></a>            <span class="p">)</span>
<a href="#__codelineno-9-189" id="__codelineno-9-189" name="__codelineno-9-189"></a>            <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predicted_request</span><span class="p">)</span>
<a href="#__codelineno-9-190" id="__codelineno-9-190" name="__codelineno-9-190"></a>
<a href="#__codelineno-9-191" id="__codelineno-9-191" name="__codelineno-9-191"></a>        <span class="c1"># Pattern 2: Different agent, same phase (parallel work)</span>
<a href="#__codelineno-9-192" id="__codelineno-9-192" name="__codelineno-9-192"></a>        <span class="k">for</span> <span class="n">agent_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'DesignAgent'</span><span class="p">,</span> <span class="s1">'QAAgent'</span><span class="p">,</span> <span class="s1">'CodeAgent'</span><span class="p">,</span> <span class="s1">'DataAgent'</span><span class="p">]:</span>
<a href="#__codelineno-9-193" id="__codelineno-9-193" name="__codelineno-9-193"></a>            <span class="k">if</span> <span class="n">agent_type</span> <span class="o">!=</span> <span class="n">current_request</span><span class="o">.</span><span class="n">agent_type</span><span class="p">:</span>
<a href="#__codelineno-9-194" id="__codelineno-9-194" name="__codelineno-9-194"></a>                <span class="n">predicted_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_predicted_request</span><span class="p">(</span>
<a href="#__codelineno-9-195" id="__codelineno-9-195" name="__codelineno-9-195"></a>                    <span class="n">current_request</span><span class="p">,</span> <span class="n">agent_type</span><span class="o">=</span><span class="n">agent_type</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="mf">0.6</span>
<a href="#__codelineno-9-196" id="__codelineno-9-196" name="__codelineno-9-196"></a>                <span class="p">)</span>
<a href="#__codelineno-9-197" id="__codelineno-9-197" name="__codelineno-9-197"></a>                <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predicted_request</span><span class="p">)</span>
<a href="#__codelineno-9-198" id="__codelineno-9-198" name="__codelineno-9-198"></a>
<a href="#__codelineno-9-199" id="__codelineno-9-199" name="__codelineno-9-199"></a>        <span class="c1"># Pattern 3: Same agent, related story</span>
<a href="#__codelineno-9-200" id="__codelineno-9-200" name="__codelineno-9-200"></a>        <span class="n">related_stories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_related_stories</span><span class="p">(</span><span class="n">current_request</span><span class="o">.</span><span class="n">story_id</span><span class="p">)</span>
<a href="#__codelineno-9-201" id="__codelineno-9-201" name="__codelineno-9-201"></a>        <span class="k">for</span> <span class="n">story_id</span> <span class="ow">in</span> <span class="n">related_stories</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>  <span class="c1"># Limit to top 2 related</span>
<a href="#__codelineno-9-202" id="__codelineno-9-202" name="__codelineno-9-202"></a>            <span class="n">predicted_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_predicted_request</span><span class="p">(</span>
<a href="#__codelineno-9-203" id="__codelineno-9-203" name="__codelineno-9-203"></a>                <span class="n">current_request</span><span class="p">,</span> <span class="n">story_id</span><span class="o">=</span><span class="n">story_id</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="mf">0.4</span>
<a href="#__codelineno-9-204" id="__codelineno-9-204" name="__codelineno-9-204"></a>            <span class="p">)</span>
<a href="#__codelineno-9-205" id="__codelineno-9-205" name="__codelineno-9-205"></a>            <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predicted_request</span><span class="p">)</span>
<a href="#__codelineno-9-206" id="__codelineno-9-206" name="__codelineno-9-206"></a>
<a href="#__codelineno-9-207" id="__codelineno-9-207" name="__codelineno-9-207"></a>        <span class="k">return</span> <span class="n">predictions</span>
</code></pre></div>
<p>This comprehensive set of algorithms provides the foundation for intelligent context management, covering relevance scoring, content compression, dependency analysis, and caching strategies. Each algorithm is designed to be configurable and extensible, allowing for continuous improvement based on real-world usage patterns.</p>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.path", "navigation.top", "search.highlight", "search.suggest", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
<script src="../../js/mermaid-zoom.js"></script>
</body>
</html>