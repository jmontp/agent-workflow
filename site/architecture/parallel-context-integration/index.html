
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Human-In-The-Loop orchestration framework for AI-assisted software development" name="description"/>
<meta content="AI Agent Workflow Team" name="author"/>
<link href="https://jmontp.github.io/agent-workflow/architecture/parallel-context-integration/" rel="canonical"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.14" name="generator"/>
<title>Parallel Context Management Integration - AI Agent TDD-Scrum Workflow</title>
<link href="../../assets/stylesheets/main.342714a4.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="blue" data-md-color-primary="blue" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#parallel-context-management-integration">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="AI Agent TDD-Scrum Workflow" class="md-header__button md-logo" data-md-component="logo" href="../.." title="AI Agent TDD-Scrum Workflow">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            AI Agent TDD-Scrum Workflow
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Parallel Context Management Integration
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="blue" data-md-color-media="" data-md-color-primary="blue" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="blue" data-md-color-media="" data-md-color-primary="blue" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/jmontp/agent-workflow" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    jmontp/agent-workflow
  </div>
</a>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../getting-started/quick-start/">
          
  
  
  Getting Started

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../user-guide/hitl-commands/">
          
  
  
  User Guide

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../concepts/overview/">
          
  
  
  Concepts

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../advanced/context/">
          
  
  
  Advanced

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../overview/">
          
  
  
  Architecture

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../development/contributing/">
          
  
  
  Development

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../deployment/discord-setup/">
          
  
  
  Deployment

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="AI Agent TDD-Scrum Workflow" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="AI Agent TDD-Scrum Workflow">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    AI Agent TDD-Scrum Workflow
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/jmontp/agent-workflow" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
</div>
<div class="md-source__repository">
    jmontp/agent-workflow
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Getting Started
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting-started/quick-start/">
<span class="md-ellipsis">
    Quick Start
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting-started/installation/">
<span class="md-ellipsis">
    Installation
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting-started/configuration/">
<span class="md-ellipsis">
    Configuration
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    User Guide
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/hitl-commands/">
<span class="md-ellipsis">
    HITL Commands
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/state-machine/">
<span class="md-ellipsis">
    State Machine
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/tdd-workflow/">
<span class="md-ellipsis">
    TDD Workflow
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/project-setup/">
<span class="md-ellipsis">
    Project Setup
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/workflow-sequences/">
<span class="md-ellipsis">
    Workflow Sequences
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/user-profile/">
<span class="md-ellipsis">
    User Profile
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/troubleshooting/">
<span class="md-ellipsis">
    Troubleshooting
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../user-guide/faq/">
<span class="md-ellipsis">
    FAQ
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-ellipsis">
    Concepts
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../concepts/overview/">
<span class="md-ellipsis">
    System Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../concepts/security/">
<span class="md-ellipsis">
    Security Model
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
<span class="md-ellipsis">
    Advanced
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Advanced
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../advanced/context/">
<span class="md-ellipsis">
    Context Diagram
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../advanced/architecture-detailed/">
<span class="md-ellipsis">
    Detailed Architecture
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../advanced/container/">
<span class="md-ellipsis">
    Container Architecture
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../advanced/component/">
<span class="md-ellipsis">
    System Components
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../advanced/data-flow/">
<span class="md-ellipsis">
    Data Flow
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../advanced/orchestration-repo/">
<span class="md-ellipsis">
    Orchestration Repository
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../advanced/project-repo/">
<span class="md-ellipsis">
    Project Repository
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../advanced/security-implementation/">
<span class="md-ellipsis">
    Security Implementation
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../advanced/testing/">
<span class="md-ellipsis">
    Testing Strategy
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../advanced/code/">
<span class="md-ellipsis">
    Code Structure
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
<span class="md-ellipsis">
    Architecture
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../overview/">
<span class="md-ellipsis">
    System Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../context-management-system/">
<span class="md-ellipsis">
    Context Management
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../parallel-tdd-architecture/">
<span class="md-ellipsis">
    Parallel TDD Design
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
<span class="md-ellipsis">
    Development
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_7_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_7">
<span class="md-nav__icon md-icon"></span>
            Development
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../development/contributing/">
<span class="md-ellipsis">
    Contributing
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../development/api-reference/">
<span class="md-ellipsis">
    API Reference
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
<span class="md-ellipsis">
    Deployment
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_8_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_8">
<span class="md-nav__icon md-icon"></span>
            Deployment
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../deployment/discord-setup/">
<span class="md-ellipsis">
    Discord Setup
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../deployment/production/">
<span class="md-ellipsis">
    Production Deployment
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../deployment/github-pages/">
<span class="md-ellipsis">
    GitHub Pages
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#executive-summary">
<span class="md-ellipsis">
      Executive Summary
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#parallel-context-architecture">
<span class="md-ellipsis">
      Parallel Context Architecture
    </span>
</a>
<nav aria-label="Parallel Context Architecture" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-multi-context-coordination">
<span class="md-ellipsis">
      1. Multi-Context Coordination
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-token-budget-management-for-parallel-execution">
<span class="md-ellipsis">
      2. Token Budget Management for Parallel Execution
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-context-sharing-and-coordination">
<span class="md-ellipsis">
      3. Context Sharing and Coordination
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-context-optimization-for-parallel-execution">
<span class="md-ellipsis">
      4. Context Optimization for Parallel Execution
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-performance-monitoring-and-metrics">
<span class="md-ellipsis">
      5. Performance Monitoring and Metrics
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="parallel-context-management-integration">Parallel Context Management Integration<a class="headerlink" href="#parallel-context-management-integration" title="Permanent link">¶</a></h1>
<h2 id="executive-summary">Executive Summary<a class="headerlink" href="#executive-summary" title="Permanent link">¶</a></h2>
<p>This document specifies the integration of the Context Management System (CMS) with parallel TDD execution. The system provides intelligent context isolation, optimized token distribution, and sophisticated context sharing mechanisms that enable efficient parallel development while maintaining context quality and relevance.</p>
<h2 id="parallel-context-architecture">Parallel Context Architecture<a class="headerlink" href="#parallel-context-architecture" title="Permanent link">¶</a></h2>
<h3 id="1-multi-context-coordination">1. Multi-Context Coordination<a class="headerlink" href="#1-multi-context-coordination" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">class</span> <span class="nc">ParallelContextManager</span><span class="p">:</span>
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">    </span><span class="sd">"""Central coordinator for context across parallel TDD cycles"""</span>
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>
<a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_context_manager</span><span class="p">:</span> <span class="n">ContextManager</span><span class="p">):</span>
<a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_context</span> <span class="o">=</span> <span class="n">base_context_manager</span>
<a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">isolated_contexts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">IsolatedCycleContext</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shared_knowledge_base</span> <span class="o">=</span> <span class="n">SharedKnowledgeBase</span><span class="p">()</span>
<a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">token_budget_manager</span> <span class="o">=</span> <span class="n">ParallelTokenBudgetManager</span><span class="p">()</span>
<a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">context_optimizer</span> <span class="o">=</span> <span class="n">ParallelContextOptimizer</span><span class="p">()</span>
<a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dependency_tracker</span> <span class="o">=</span> <span class="n">ContextDependencyTracker</span><span class="p">()</span>
<a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">create_cycle_context</span><span class="p">(</span>
<a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>        <span class="bp">self</span><span class="p">,</span> 
<a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="n">cycle_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="n">story</span><span class="p">:</span> <span class="n">Story</span><span class="p">,</span>
<a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="n">parallel_group</span><span class="p">:</span> <span class="n">ParallelGroup</span>
<a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IsolatedCycleContext</span><span class="p">:</span>
<a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">        </span><span class="sd">"""Create optimally isolated context for a TDD cycle"""</span>
<a href="#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a>
<a href="#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a>        <span class="c1"># Calculate optimal token allocation</span>
<a href="#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a>        <span class="n">token_allocation</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_budget_manager</span><span class="o">.</span><span class="n">allocate_for_cycle</span><span class="p">(</span>
<a href="#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a>            <span class="n">cycle_id</span><span class="p">,</span> <span class="n">parallel_group</span>
<a href="#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="p">)</span>
<a href="#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a>
<a href="#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="c1"># Determine context scope based on story analysis</span>
<a href="#__codelineno-0-26" id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="n">context_scope</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_context_scope</span><span class="p">(</span><span class="n">story</span><span class="p">,</span> <span class="n">parallel_group</span><span class="p">)</span>
<a href="#__codelineno-0-27" id="__codelineno-0-27" name="__codelineno-0-27"></a>
<a href="#__codelineno-0-28" id="__codelineno-0-28" name="__codelineno-0-28"></a>        <span class="c1"># Create isolated context</span>
<a href="#__codelineno-0-29" id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="n">context</span> <span class="o">=</span> <span class="n">IsolatedCycleContext</span><span class="p">(</span>
<a href="#__codelineno-0-30" id="__codelineno-0-30" name="__codelineno-0-30"></a>            <span class="n">cycle_id</span><span class="o">=</span><span class="n">cycle_id</span><span class="p">,</span>
<a href="#__codelineno-0-31" id="__codelineno-0-31" name="__codelineno-0-31"></a>            <span class="n">story_id</span><span class="o">=</span><span class="n">story</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a href="#__codelineno-0-32" id="__codelineno-0-32" name="__codelineno-0-32"></a>            <span class="n">token_budget</span><span class="o">=</span><span class="n">token_allocation</span><span class="p">,</span>
<a href="#__codelineno-0-33" id="__codelineno-0-33" name="__codelineno-0-33"></a>            <span class="n">scope</span><span class="o">=</span><span class="n">context_scope</span><span class="p">,</span>
<a href="#__codelineno-0-34" id="__codelineno-0-34" name="__codelineno-0-34"></a>            <span class="n">shared_knowledge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_knowledge_base</span><span class="o">.</span><span class="n">get_readonly_view</span><span class="p">()</span>
<a href="#__codelineno-0-35" id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="p">)</span>
<a href="#__codelineno-0-36" id="__codelineno-0-36" name="__codelineno-0-36"></a>
<a href="#__codelineno-0-37" id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="c1"># Populate with story-specific context</span>
<a href="#__codelineno-0-38" id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_populate_story_context</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">story</span><span class="p">)</span>
<a href="#__codelineno-0-39" id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a href="#__codelineno-0-40" id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="c1"># Apply parallel-specific optimizations</span>
<a href="#__codelineno-0-41" id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_optimizer</span><span class="o">.</span><span class="n">optimize_for_parallel</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">parallel_group</span><span class="p">)</span>
<a href="#__codelineno-0-42" id="__codelineno-0-42" name="__codelineno-0-42"></a>
<a href="#__codelineno-0-43" id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="c1"># Set up dependency tracking</span>
<a href="#__codelineno-0-44" id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependency_tracker</span><span class="o">.</span><span class="n">track_context_dependencies</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">parallel_group</span><span class="p">)</span>
<a href="#__codelineno-0-45" id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a href="#__codelineno-0-46" id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">isolated_contexts</span><span class="p">[</span><span class="n">cycle_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span>
<a href="#__codelineno-0-47" id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="k">return</span> <span class="n">context</span>
<a href="#__codelineno-0-48" id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a href="#__codelineno-0-49" id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_analyze_context_scope</span><span class="p">(</span>
<a href="#__codelineno-0-50" id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="bp">self</span><span class="p">,</span> 
<a href="#__codelineno-0-51" id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="n">story</span><span class="p">:</span> <span class="n">Story</span><span class="p">,</span> 
<a href="#__codelineno-0-52" id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="n">parallel_group</span><span class="p">:</span> <span class="n">ParallelGroup</span>
<a href="#__codelineno-0-53" id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ContextScope</span><span class="p">:</span>
<a href="#__codelineno-0-54" id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="w">        </span><span class="sd">"""Analyze optimal context scope to minimize conflicts and maximize relevance"""</span>
<a href="#__codelineno-0-55" id="__codelineno-0-55" name="__codelineno-0-55"></a>
<a href="#__codelineno-0-56" id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="c1"># Base scope from story requirements</span>
<a href="#__codelineno-0-57" id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="n">base_files</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_story_files</span><span class="p">(</span><span class="n">story</span><span class="p">)</span>
<a href="#__codelineno-0-58" id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="n">base_dependencies</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_dependencies</span><span class="p">(</span><span class="n">base_files</span><span class="p">)</span>
<a href="#__codelineno-0-59" id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a href="#__codelineno-0-60" id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="c1"># Expand scope based on parallel execution needs</span>
<a href="#__codelineno-0-61" id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="n">parallel_considerations</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_parallel_scope_needs</span><span class="p">(</span>
<a href="#__codelineno-0-62" id="__codelineno-0-62" name="__codelineno-0-62"></a>            <span class="n">story</span><span class="p">,</span> <span class="n">parallel_group</span>
<a href="#__codelineno-0-63" id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="p">)</span>
<a href="#__codelineno-0-64" id="__codelineno-0-64" name="__codelineno-0-64"></a>
<a href="#__codelineno-0-65" id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="c1"># Calculate conflict boundaries with other cycles</span>
<a href="#__codelineno-0-66" id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="n">conflict_boundaries</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_conflict_boundaries</span><span class="p">(</span>
<a href="#__codelineno-0-67" id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="n">story</span><span class="p">,</span> <span class="n">parallel_group</span>
<a href="#__codelineno-0-68" id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="p">)</span>
<a href="#__codelineno-0-69" id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a href="#__codelineno-0-70" id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="c1"># Optimize scope to balance completeness vs isolation</span>
<a href="#__codelineno-0-71" id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="n">optimized_scope</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_context_scope</span><span class="p">(</span>
<a href="#__codelineno-0-72" id="__codelineno-0-72" name="__codelineno-0-72"></a>            <span class="n">base_files</span><span class="p">,</span> <span class="n">base_dependencies</span><span class="p">,</span> <span class="n">parallel_considerations</span><span class="p">,</span> <span class="n">conflict_boundaries</span>
<a href="#__codelineno-0-73" id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="p">)</span>
<a href="#__codelineno-0-74" id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a href="#__codelineno-0-75" id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="k">return</span> <span class="n">ContextScope</span><span class="p">(</span>
<a href="#__codelineno-0-76" id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="n">core_files</span><span class="o">=</span><span class="n">optimized_scope</span><span class="o">.</span><span class="n">core_files</span><span class="p">,</span>
<a href="#__codelineno-0-77" id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="n">dependency_files</span><span class="o">=</span><span class="n">optimized_scope</span><span class="o">.</span><span class="n">dependency_files</span><span class="p">,</span>
<a href="#__codelineno-0-78" id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="n">test_files</span><span class="o">=</span><span class="n">optimized_scope</span><span class="o">.</span><span class="n">test_files</span><span class="p">,</span>
<a href="#__codelineno-0-79" id="__codelineno-0-79" name="__codelineno-0-79"></a>            <span class="n">documentation_files</span><span class="o">=</span><span class="n">optimized_scope</span><span class="o">.</span><span class="n">documentation_files</span><span class="p">,</span>
<a href="#__codelineno-0-80" id="__codelineno-0-80" name="__codelineno-0-80"></a>            <span class="n">exclusion_patterns</span><span class="o">=</span><span class="n">optimized_scope</span><span class="o">.</span><span class="n">exclusions</span><span class="p">,</span>
<a href="#__codelineno-0-81" id="__codelineno-0-81" name="__codelineno-0-81"></a>            <span class="n">max_file_count</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">optimized_scope</span><span class="o">.</span><span class="n">file_count</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>  <span class="c1"># Parallel limit</span>
<a href="#__codelineno-0-82" id="__codelineno-0-82" name="__codelineno-0-82"></a>            <span class="n">isolation_level</span><span class="o">=</span><span class="n">optimized_scope</span><span class="o">.</span><span class="n">isolation_level</span>
<a href="#__codelineno-0-83" id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="p">)</span>
<a href="#__codelineno-0-84" id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a href="#__codelineno-0-85" id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_optimize_context_scope</span><span class="p">(</span>
<a href="#__codelineno-0-86" id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="bp">self</span><span class="p">,</span>
<a href="#__codelineno-0-87" id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="n">base_files</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a href="#__codelineno-0-88" id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="n">dependencies</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
<a href="#__codelineno-0-89" id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="n">parallel_needs</span><span class="p">:</span> <span class="n">ParallelScopeAnalysis</span><span class="p">,</span>
<a href="#__codelineno-0-90" id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="n">boundaries</span><span class="p">:</span> <span class="n">ConflictBoundaries</span>
<a href="#__codelineno-0-91" id="__codelineno-0-91" name="__codelineno-0-91"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OptimizedScope</span><span class="p">:</span>
<a href="#__codelineno-0-92" id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="w">        </span><span class="sd">"""Optimize context scope for parallel execution"""</span>
<a href="#__codelineno-0-93" id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a href="#__codelineno-0-94" id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="c1"># Start with base files</span>
<a href="#__codelineno-0-95" id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="n">core_files</span> <span class="o">=</span> <span class="n">base_files</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a href="#__codelineno-0-96" id="__codelineno-0-96" name="__codelineno-0-96"></a>
<a href="#__codelineno-0-97" id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="c1"># Add critical dependencies</span>
<a href="#__codelineno-0-98" id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="n">critical_deps</span> <span class="o">=</span> <span class="n">dependencies</span> <span class="o">&amp;</span> <span class="n">parallel_needs</span><span class="o">.</span><span class="n">critical_dependencies</span>
<a href="#__codelineno-0-99" id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="n">core_files</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">critical_deps</span><span class="p">)</span>
<a href="#__codelineno-0-100" id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a href="#__codelineno-0-101" id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="c1"># Remove files that would cause conflicts</span>
<a href="#__codelineno-0-102" id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="n">conflicting_files</span> <span class="o">=</span> <span class="n">core_files</span> <span class="o">&amp;</span> <span class="n">boundaries</span><span class="o">.</span><span class="n">conflicting_files</span>
<a href="#__codelineno-0-103" id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="k">if</span> <span class="n">conflicting_files</span><span class="p">:</span>
<a href="#__codelineno-0-104" id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="c1"># Try to find alternative context for conflicting files</span>
<a href="#__codelineno-0-105" id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="n">alternatives</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_alternative_context</span><span class="p">(</span><span class="n">conflicting_files</span><span class="p">)</span>
<a href="#__codelineno-0-106" id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="n">core_files</span> <span class="o">=</span> <span class="p">(</span><span class="n">core_files</span> <span class="o">-</span> <span class="n">conflicting_files</span><span class="p">)</span> <span class="o">|</span> <span class="n">alternatives</span>
<a href="#__codelineno-0-107" id="__codelineno-0-107" name="__codelineno-0-107"></a>
<a href="#__codelineno-0-108" id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="c1"># Add parallel-specific requirements</span>
<a href="#__codelineno-0-109" id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="k">if</span> <span class="n">parallel_needs</span><span class="o">.</span><span class="n">requires_shared_state</span><span class="p">:</span>
<a href="#__codelineno-0-110" id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="n">shared_state_files</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_shared_state_files</span><span class="p">(</span><span class="n">parallel_needs</span><span class="p">)</span>
<a href="#__codelineno-0-111" id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="n">core_files</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">shared_state_files</span><span class="p">)</span>
<a href="#__codelineno-0-112" id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a href="#__codelineno-0-113" id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="c1"># Limit scope to fit token budget</span>
<a href="#__codelineno-0-114" id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">core_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">parallel_needs</span><span class="o">.</span><span class="n">max_files_for_budget</span><span class="p">:</span>
<a href="#__codelineno-0-115" id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="n">core_files</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prioritize_files_for_budget</span><span class="p">(</span>
<a href="#__codelineno-0-116" id="__codelineno-0-116" name="__codelineno-0-116"></a>                <span class="n">core_files</span><span class="p">,</span> <span class="n">parallel_needs</span><span class="o">.</span><span class="n">max_files_for_budget</span>
<a href="#__codelineno-0-117" id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="p">)</span>
<a href="#__codelineno-0-118" id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a href="#__codelineno-0-119" id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="k">return</span> <span class="n">OptimizedScope</span><span class="p">(</span>
<a href="#__codelineno-0-120" id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="n">core_files</span><span class="o">=</span><span class="n">core_files</span><span class="p">,</span>
<a href="#__codelineno-0-121" id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="n">dependency_files</span><span class="o">=</span><span class="n">dependencies</span> <span class="o">-</span> <span class="n">core_files</span><span class="p">,</span>
<a href="#__codelineno-0-122" id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="n">test_files</span><span class="o">=</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_test_files_for_scope</span><span class="p">(</span><span class="n">core_files</span><span class="p">),</span>
<a href="#__codelineno-0-123" id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="n">documentation_files</span><span class="o">=</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_docs_for_scope</span><span class="p">(</span><span class="n">core_files</span><span class="p">),</span>
<a href="#__codelineno-0-124" id="__codelineno-0-124" name="__codelineno-0-124"></a>            <span class="n">exclusions</span><span class="o">=</span><span class="n">boundaries</span><span class="o">.</span><span class="n">exclusion_patterns</span><span class="p">,</span>
<a href="#__codelineno-0-125" id="__codelineno-0-125" name="__codelineno-0-125"></a>            <span class="n">file_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">core_files</span><span class="p">),</span>
<a href="#__codelineno-0-126" id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="n">isolation_level</span><span class="o">=</span><span class="n">parallel_needs</span><span class="o">.</span><span class="n">recommended_isolation</span>
<a href="#__codelineno-0-127" id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="p">)</span>
<a href="#__codelineno-0-128" id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a href="#__codelineno-0-129" id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="k">class</span> <span class="nc">IsolatedCycleContext</span><span class="p">:</span>
<a href="#__codelineno-0-130" id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="w">    </span><span class="sd">"""Context isolated for a specific TDD cycle with parallel optimization"""</span>
<a href="#__codelineno-0-131" id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a href="#__codelineno-0-132" id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
<a href="#__codelineno-0-133" id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="bp">self</span><span class="p">,</span> 
<a href="#__codelineno-0-134" id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="n">cycle_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a href="#__codelineno-0-135" id="__codelineno-0-135" name="__codelineno-0-135"></a>        <span class="n">story_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a href="#__codelineno-0-136" id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="n">token_budget</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a href="#__codelineno-0-137" id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="n">scope</span><span class="p">:</span> <span class="n">ContextScope</span><span class="p">,</span>
<a href="#__codelineno-0-138" id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="n">shared_knowledge</span><span class="p">:</span> <span class="n">ReadOnlyKnowledgeView</span>
<a href="#__codelineno-0-139" id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="p">):</span>
<a href="#__codelineno-0-140" id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cycle_id</span> <span class="o">=</span> <span class="n">cycle_id</span>
<a href="#__codelineno-0-141" id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">story_id</span> <span class="o">=</span> <span class="n">story_id</span>
<a href="#__codelineno-0-142" id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">token_budget</span> <span class="o">=</span> <span class="n">token_budget</span>
<a href="#__codelineno-0-143" id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokens_used</span> <span class="o">=</span> <span class="mi">0</span>
<a href="#__codelineno-0-144" id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="n">scope</span>
<a href="#__codelineno-0-145" id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shared_knowledge</span> <span class="o">=</span> <span class="n">shared_knowledge</span>
<a href="#__codelineno-0-146" id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a href="#__codelineno-0-147" id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="c1"># Context caches for performance</span>
<a href="#__codelineno-0-148" id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_content_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-0-149" id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">compressed_content_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-0-150" id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">relevance_scores</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-0-151" id="__codelineno-0-151" name="__codelineno-0-151"></a>
<a href="#__codelineno-0-152" id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="c1"># Parallel-specific features</span>
<a href="#__codelineno-0-153" id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">context_updates</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ContextUpdate</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-0-154" id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dependency_changes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DependencyChange</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-0-155" id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shared_context_keys</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a href="#__codelineno-0-156" id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a href="#__codelineno-0-157" id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_context_for_agent</span><span class="p">(</span>
<a href="#__codelineno-0-158" id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="bp">self</span><span class="p">,</span> 
<a href="#__codelineno-0-159" id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="n">agent_type</span><span class="p">:</span> <span class="n">AgentType</span><span class="p">,</span> 
<a href="#__codelineno-0-160" id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="n">task</span><span class="p">:</span> <span class="n">TDDTask</span>
<a href="#__codelineno-0-161" id="__codelineno-0-161" name="__codelineno-0-161"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentContext</span><span class="p">:</span>
<a href="#__codelineno-0-162" id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="w">        </span><span class="sd">"""Get optimized context for specific agent and task"""</span>
<a href="#__codelineno-0-163" id="__codelineno-0-163" name="__codelineno-0-163"></a>
<a href="#__codelineno-0-164" id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="c1"># Calculate agent-specific context needs</span>
<a href="#__codelineno-0-165" id="__codelineno-0-165" name="__codelineno-0-165"></a>        <span class="n">context_needs</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_agent_context_needs</span><span class="p">(</span><span class="n">agent_type</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
<a href="#__codelineno-0-166" id="__codelineno-0-166" name="__codelineno-0-166"></a>
<a href="#__codelineno-0-167" id="__codelineno-0-167" name="__codelineno-0-167"></a>        <span class="c1"># Get relevant files within scope</span>
<a href="#__codelineno-0-168" id="__codelineno-0-168" name="__codelineno-0-168"></a>        <span class="n">relevant_files</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relevant_files</span><span class="p">(</span><span class="n">context_needs</span><span class="p">)</span>
<a href="#__codelineno-0-169" id="__codelineno-0-169" name="__codelineno-0-169"></a>
<a href="#__codelineno-0-170" id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="c1"># Apply context compression to fit token budget</span>
<a href="#__codelineno-0-171" id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="n">compressed_context</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compress_context_for_agent</span><span class="p">(</span>
<a href="#__codelineno-0-172" id="__codelineno-0-172" name="__codelineno-0-172"></a>            <span class="n">relevant_files</span><span class="p">,</span> <span class="n">agent_type</span><span class="p">,</span> <span class="n">context_needs</span>
<a href="#__codelineno-0-173" id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="p">)</span>
<a href="#__codelineno-0-174" id="__codelineno-0-174" name="__codelineno-0-174"></a>
<a href="#__codelineno-0-175" id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="c1"># Add shared knowledge relevant to task</span>
<a href="#__codelineno-0-176" id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="n">shared_context</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_relevant_shared_knowledge</span><span class="p">(</span>
<a href="#__codelineno-0-177" id="__codelineno-0-177" name="__codelineno-0-177"></a>            <span class="n">agent_type</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">context_needs</span>
<a href="#__codelineno-0-178" id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="p">)</span>
<a href="#__codelineno-0-179" id="__codelineno-0-179" name="__codelineno-0-179"></a>
<a href="#__codelineno-0-180" id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="c1"># Combine into agent context</span>
<a href="#__codelineno-0-181" id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="n">agent_context</span> <span class="o">=</span> <span class="n">AgentContext</span><span class="p">(</span>
<a href="#__codelineno-0-182" id="__codelineno-0-182" name="__codelineno-0-182"></a>            <span class="n">cycle_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cycle_id</span><span class="p">,</span>
<a href="#__codelineno-0-183" id="__codelineno-0-183" name="__codelineno-0-183"></a>            <span class="n">agent_type</span><span class="o">=</span><span class="n">agent_type</span><span class="p">,</span>
<a href="#__codelineno-0-184" id="__codelineno-0-184" name="__codelineno-0-184"></a>            <span class="n">task_id</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a href="#__codelineno-0-185" id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="n">files</span><span class="o">=</span><span class="n">compressed_context</span><span class="o">.</span><span class="n">files</span><span class="p">,</span>
<a href="#__codelineno-0-186" id="__codelineno-0-186" name="__codelineno-0-186"></a>            <span class="n">shared_knowledge</span><span class="o">=</span><span class="n">shared_context</span><span class="p">,</span>
<a href="#__codelineno-0-187" id="__codelineno-0-187" name="__codelineno-0-187"></a>            <span class="n">metadata</span><span class="o">=</span><span class="n">compressed_context</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
<a href="#__codelineno-0-188" id="__codelineno-0-188" name="__codelineno-0-188"></a>            <span class="n">token_count</span><span class="o">=</span><span class="n">compressed_context</span><span class="o">.</span><span class="n">token_count</span><span class="p">,</span>
<a href="#__codelineno-0-189" id="__codelineno-0-189" name="__codelineno-0-189"></a>            <span class="n">relevance_score</span><span class="o">=</span><span class="n">compressed_context</span><span class="o">.</span><span class="n">overall_relevance</span>
<a href="#__codelineno-0-190" id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="p">)</span>
<a href="#__codelineno-0-191" id="__codelineno-0-191" name="__codelineno-0-191"></a>
<a href="#__codelineno-0-192" id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="c1"># Update usage tracking</span>
<a href="#__codelineno-0-193" id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokens_used</span> <span class="o">+=</span> <span class="n">agent_context</span><span class="o">.</span><span class="n">token_count</span>
<a href="#__codelineno-0-194" id="__codelineno-0-194" name="__codelineno-0-194"></a>
<a href="#__codelineno-0-195" id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="k">return</span> <span class="n">agent_context</span>
<a href="#__codelineno-0-196" id="__codelineno-0-196" name="__codelineno-0-196"></a>
<a href="#__codelineno-0-197" id="__codelineno-0-197" name="__codelineno-0-197"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_compress_context_for_agent</span><span class="p">(</span>
<a href="#__codelineno-0-198" id="__codelineno-0-198" name="__codelineno-0-198"></a>        <span class="bp">self</span><span class="p">,</span>
<a href="#__codelineno-0-199" id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="n">relevant_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RelevantFile</span><span class="p">],</span>
<a href="#__codelineno-0-200" id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="n">agent_type</span><span class="p">:</span> <span class="n">AgentType</span><span class="p">,</span>
<a href="#__codelineno-0-201" id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="n">context_needs</span><span class="p">:</span> <span class="n">ContextNeeds</span>
<a href="#__codelineno-0-202" id="__codelineno-0-202" name="__codelineno-0-202"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CompressedContext</span><span class="p">:</span>
<a href="#__codelineno-0-203" id="__codelineno-0-203" name="__codelineno-0-203"></a><span class="w">        </span><span class="sd">"""Apply intelligent compression for agent type and parallel constraints"""</span>
<a href="#__codelineno-0-204" id="__codelineno-0-204" name="__codelineno-0-204"></a>
<a href="#__codelineno-0-205" id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="c1"># Calculate available token budget</span>
<a href="#__codelineno-0-206" id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="n">remaining_budget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_budget</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens_used</span>
<a href="#__codelineno-0-207" id="__codelineno-0-207" name="__codelineno-0-207"></a>        <span class="n">agent_budget</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">remaining_budget</span><span class="p">,</span> <span class="n">context_needs</span><span class="o">.</span><span class="n">preferred_token_count</span><span class="p">)</span>
<a href="#__codelineno-0-208" id="__codelineno-0-208" name="__codelineno-0-208"></a>
<a href="#__codelineno-0-209" id="__codelineno-0-209" name="__codelineno-0-209"></a>        <span class="c1"># Apply agent-specific compression strategies</span>
<a href="#__codelineno-0-210" id="__codelineno-0-210" name="__codelineno-0-210"></a>        <span class="n">compression_strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_compression_strategy</span><span class="p">(</span><span class="n">agent_type</span><span class="p">)</span>
<a href="#__codelineno-0-211" id="__codelineno-0-211" name="__codelineno-0-211"></a>
<a href="#__codelineno-0-212" id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="n">compressed_files</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-0-213" id="__codelineno-0-213" name="__codelineno-0-213"></a>        <span class="n">total_tokens</span> <span class="o">=</span> <span class="mi">0</span>
<a href="#__codelineno-0-214" id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a href="#__codelineno-0-215" id="__codelineno-0-215" name="__codelineno-0-215"></a>        <span class="c1"># Process files in order of relevance</span>
<a href="#__codelineno-0-216" id="__codelineno-0-216" name="__codelineno-0-216"></a>        <span class="n">sorted_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">relevant_files</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">relevance_score</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a href="#__codelineno-0-217" id="__codelineno-0-217" name="__codelineno-0-217"></a>
<a href="#__codelineno-0-218" id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">sorted_files</span><span class="p">:</span>
<a href="#__codelineno-0-219" id="__codelineno-0-219" name="__codelineno-0-219"></a>            <span class="k">if</span> <span class="n">total_tokens</span> <span class="o">&gt;=</span> <span class="n">agent_budget</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">:</span>  <span class="c1"># Leave 10% buffer</span>
<a href="#__codelineno-0-220" id="__codelineno-0-220" name="__codelineno-0-220"></a>                <span class="k">break</span>
<a href="#__codelineno-0-221" id="__codelineno-0-221" name="__codelineno-0-221"></a>
<a href="#__codelineno-0-222" id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="c1"># Apply compression based on file type and agent needs</span>
<a href="#__codelineno-0-223" id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="k">if</span> <span class="n">file_info</span><span class="o">.</span><span class="n">file_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compressed_content_cache</span><span class="p">:</span>
<a href="#__codelineno-0-224" id="__codelineno-0-224" name="__codelineno-0-224"></a>                <span class="n">compressed_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compressed_content_cache</span><span class="p">[</span><span class="n">file_info</span><span class="o">.</span><span class="n">file_path</span><span class="p">]</span>
<a href="#__codelineno-0-225" id="__codelineno-0-225" name="__codelineno-0-225"></a>            <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-0-226" id="__codelineno-0-226" name="__codelineno-0-226"></a>                <span class="n">compressed_content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">compression_strategy</span><span class="o">.</span><span class="n">compress_file</span><span class="p">(</span>
<a href="#__codelineno-0-227" id="__codelineno-0-227" name="__codelineno-0-227"></a>                    <span class="n">file_info</span><span class="p">,</span> <span class="n">context_needs</span>
<a href="#__codelineno-0-228" id="__codelineno-0-228" name="__codelineno-0-228"></a>                <span class="p">)</span>
<a href="#__codelineno-0-229" id="__codelineno-0-229" name="__codelineno-0-229"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">compressed_content_cache</span><span class="p">[</span><span class="n">file_info</span><span class="o">.</span><span class="n">file_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">compressed_content</span>
<a href="#__codelineno-0-230" id="__codelineno-0-230" name="__codelineno-0-230"></a>
<a href="#__codelineno-0-231" id="__codelineno-0-231" name="__codelineno-0-231"></a>            <span class="n">file_tokens</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_tokens</span><span class="p">(</span><span class="n">compressed_content</span><span class="p">)</span>
<a href="#__codelineno-0-232" id="__codelineno-0-232" name="__codelineno-0-232"></a>
<a href="#__codelineno-0-233" id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="k">if</span> <span class="n">total_tokens</span> <span class="o">+</span> <span class="n">file_tokens</span> <span class="o">&lt;=</span> <span class="n">agent_budget</span><span class="p">:</span>
<a href="#__codelineno-0-234" id="__codelineno-0-234" name="__codelineno-0-234"></a>                <span class="n">compressed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CompressedFile</span><span class="p">(</span>
<a href="#__codelineno-0-235" id="__codelineno-0-235" name="__codelineno-0-235"></a>                    <span class="n">path</span><span class="o">=</span><span class="n">file_info</span><span class="o">.</span><span class="n">file_path</span><span class="p">,</span>
<a href="#__codelineno-0-236" id="__codelineno-0-236" name="__codelineno-0-236"></a>                    <span class="n">content</span><span class="o">=</span><span class="n">compressed_content</span><span class="p">,</span>
<a href="#__codelineno-0-237" id="__codelineno-0-237" name="__codelineno-0-237"></a>                    <span class="n">original_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">file_info</span><span class="o">.</span><span class="n">content</span><span class="p">),</span>
<a href="#__codelineno-0-238" id="__codelineno-0-238" name="__codelineno-0-238"></a>                    <span class="n">compressed_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">compressed_content</span><span class="p">),</span>
<a href="#__codelineno-0-239" id="__codelineno-0-239" name="__codelineno-0-239"></a>                    <span class="n">compression_ratio</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">compressed_content</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_info</span><span class="o">.</span><span class="n">content</span><span class="p">),</span>
<a href="#__codelineno-0-240" id="__codelineno-0-240" name="__codelineno-0-240"></a>                    <span class="n">relevance</span><span class="o">=</span><span class="n">file_info</span><span class="o">.</span><span class="n">relevance_score</span><span class="p">,</span>
<a href="#__codelineno-0-241" id="__codelineno-0-241" name="__codelineno-0-241"></a>                    <span class="n">tokens</span><span class="o">=</span><span class="n">file_tokens</span>
<a href="#__codelineno-0-242" id="__codelineno-0-242" name="__codelineno-0-242"></a>                <span class="p">))</span>
<a href="#__codelineno-0-243" id="__codelineno-0-243" name="__codelineno-0-243"></a>                <span class="n">total_tokens</span> <span class="o">+=</span> <span class="n">file_tokens</span>
<a href="#__codelineno-0-244" id="__codelineno-0-244" name="__codelineno-0-244"></a>
<a href="#__codelineno-0-245" id="__codelineno-0-245" name="__codelineno-0-245"></a>        <span class="k">return</span> <span class="n">CompressedContext</span><span class="p">(</span>
<a href="#__codelineno-0-246" id="__codelineno-0-246" name="__codelineno-0-246"></a>            <span class="n">files</span><span class="o">=</span><span class="n">compressed_files</span><span class="p">,</span>
<a href="#__codelineno-0-247" id="__codelineno-0-247" name="__codelineno-0-247"></a>            <span class="n">metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_context_metadata</span><span class="p">(</span><span class="n">compressed_files</span><span class="p">),</span>
<a href="#__codelineno-0-248" id="__codelineno-0-248" name="__codelineno-0-248"></a>            <span class="n">token_count</span><span class="o">=</span><span class="n">total_tokens</span><span class="p">,</span>
<a href="#__codelineno-0-249" id="__codelineno-0-249" name="__codelineno-0-249"></a>            <span class="n">compression_stats</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_calculate_compression_stats</span><span class="p">(</span><span class="n">compressed_files</span><span class="p">),</span>
<a href="#__codelineno-0-250" id="__codelineno-0-250" name="__codelineno-0-250"></a>            <span class="n">overall_relevance</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">relevance</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">compressed_files</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">compressed_files</span><span class="p">)</span>
<a href="#__codelineno-0-251" id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="p">)</span>
</code></pre></div>
<h3 id="2-token-budget-management-for-parallel-execution">2. Token Budget Management for Parallel Execution<a class="headerlink" href="#2-token-budget-management-for-parallel-execution" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">class</span> <span class="nc">ParallelTokenBudgetManager</span><span class="p">:</span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="sd">"""Intelligent token budget allocation across parallel cycles"""</span>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total_budget</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200000</span><span class="p">):</span>
<a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">total_budget</span> <span class="o">=</span> <span class="n">total_budget</span>
<a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">system_reserve</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_budget</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># 10% system reserve</span>
<a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">available_budget</span> <span class="o">=</span> <span class="n">total_budget</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_reserve</span>
<a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>
<a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allocations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TokenAllocation</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">usage_history</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">TokenUsage</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">predictive_model</span> <span class="o">=</span> <span class="n">TokenUsagePredictionModel</span><span class="p">()</span>
<a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a>
<a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">allocate_for_cycle</span><span class="p">(</span>
<a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a>        <span class="bp">self</span><span class="p">,</span> 
<a href="#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a>        <span class="n">cycle_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a href="#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a>        <span class="n">parallel_group</span><span class="p">:</span> <span class="n">ParallelGroup</span>
<a href="#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenAllocation</span><span class="p">:</span>
<a href="#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">        </span><span class="sd">"""Allocate optimal token budget for a cycle in parallel group"""</span>
<a href="#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a>
<a href="#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a>        <span class="c1"># Analyze current allocations</span>
<a href="#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a>        <span class="n">current_allocations</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocations</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_active</span><span class="p">()]</span>
<a href="#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a>        <span class="n">active_cycles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_allocations</span><span class="p">)</span>
<a href="#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a>
<a href="#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a>        <span class="c1"># Predict usage for this cycle</span>
<a href="#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a>        <span class="n">predicted_usage</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictive_model</span><span class="o">.</span><span class="n">predict_cycle_usage</span><span class="p">(</span>
<a href="#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a>            <span class="n">cycle_id</span><span class="p">,</span> <span class="n">parallel_group</span>
<a href="#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a>        <span class="p">)</span>
<a href="#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a>
<a href="#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a>        <span class="c1"># Calculate base allocation</span>
<a href="#__codelineno-1-30" id="__codelineno-1-30" name="__codelineno-1-30"></a>        <span class="n">base_allocation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_base_allocation</span><span class="p">(</span>
<a href="#__codelineno-1-31" id="__codelineno-1-31" name="__codelineno-1-31"></a>            <span class="n">active_cycles</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">predicted_usage</span>
<a href="#__codelineno-1-32" id="__codelineno-1-32" name="__codelineno-1-32"></a>        <span class="p">)</span>
<a href="#__codelineno-1-33" id="__codelineno-1-33" name="__codelineno-1-33"></a>
<a href="#__codelineno-1-34" id="__codelineno-1-34" name="__codelineno-1-34"></a>        <span class="c1"># Apply intelligent adjustments</span>
<a href="#__codelineno-1-35" id="__codelineno-1-35" name="__codelineno-1-35"></a>        <span class="n">adjusted_allocation</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_intelligent_adjustments</span><span class="p">(</span>
<a href="#__codelineno-1-36" id="__codelineno-1-36" name="__codelineno-1-36"></a>            <span class="n">base_allocation</span><span class="p">,</span> <span class="n">cycle_id</span><span class="p">,</span> <span class="n">parallel_group</span><span class="p">,</span> <span class="n">predicted_usage</span>
<a href="#__codelineno-1-37" id="__codelineno-1-37" name="__codelineno-1-37"></a>        <span class="p">)</span>
<a href="#__codelineno-1-38" id="__codelineno-1-38" name="__codelineno-1-38"></a>
<a href="#__codelineno-1-39" id="__codelineno-1-39" name="__codelineno-1-39"></a>        <span class="c1"># Ensure we don't exceed available budget</span>
<a href="#__codelineno-1-40" id="__codelineno-1-40" name="__codelineno-1-40"></a>        <span class="n">final_allocation</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_budget_compliance</span><span class="p">(</span>
<a href="#__codelineno-1-41" id="__codelineno-1-41" name="__codelineno-1-41"></a>            <span class="n">adjusted_allocation</span><span class="p">,</span> <span class="n">current_allocations</span>
<a href="#__codelineno-1-42" id="__codelineno-1-42" name="__codelineno-1-42"></a>        <span class="p">)</span>
<a href="#__codelineno-1-43" id="__codelineno-1-43" name="__codelineno-1-43"></a>
<a href="#__codelineno-1-44" id="__codelineno-1-44" name="__codelineno-1-44"></a>        <span class="n">allocation</span> <span class="o">=</span> <span class="n">TokenAllocation</span><span class="p">(</span>
<a href="#__codelineno-1-45" id="__codelineno-1-45" name="__codelineno-1-45"></a>            <span class="n">cycle_id</span><span class="o">=</span><span class="n">cycle_id</span><span class="p">,</span>
<a href="#__codelineno-1-46" id="__codelineno-1-46" name="__codelineno-1-46"></a>            <span class="n">allocated_tokens</span><span class="o">=</span><span class="n">final_allocation</span><span class="o">.</span><span class="n">tokens</span><span class="p">,</span>
<a href="#__codelineno-1-47" id="__codelineno-1-47" name="__codelineno-1-47"></a>            <span class="n">priority_multiplier</span><span class="o">=</span><span class="n">final_allocation</span><span class="o">.</span><span class="n">priority_multiplier</span><span class="p">,</span>
<a href="#__codelineno-1-48" id="__codelineno-1-48" name="__codelineno-1-48"></a>            <span class="n">phase_adjustments</span><span class="o">=</span><span class="n">final_allocation</span><span class="o">.</span><span class="n">phase_adjustments</span><span class="p">,</span>
<a href="#__codelineno-1-49" id="__codelineno-1-49" name="__codelineno-1-49"></a>            <span class="n">sharing_permissions</span><span class="o">=</span><span class="n">final_allocation</span><span class="o">.</span><span class="n">sharing_permissions</span><span class="p">,</span>
<a href="#__codelineno-1-50" id="__codelineno-1-50" name="__codelineno-1-50"></a>            <span class="n">allocated_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
<a href="#__codelineno-1-51" id="__codelineno-1-51" name="__codelineno-1-51"></a>            <span class="n">expires_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<a href="#__codelineno-1-52" id="__codelineno-1-52" name="__codelineno-1-52"></a>        <span class="p">)</span>
<a href="#__codelineno-1-53" id="__codelineno-1-53" name="__codelineno-1-53"></a>
<a href="#__codelineno-1-54" id="__codelineno-1-54" name="__codelineno-1-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">allocations</span><span class="p">[</span><span class="n">cycle_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">allocation</span>
<a href="#__codelineno-1-55" id="__codelineno-1-55" name="__codelineno-1-55"></a>        <span class="k">return</span> <span class="n">allocation</span>
<a href="#__codelineno-1-56" id="__codelineno-1-56" name="__codelineno-1-56"></a>
<a href="#__codelineno-1-57" id="__codelineno-1-57" name="__codelineno-1-57"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_apply_intelligent_adjustments</span><span class="p">(</span>
<a href="#__codelineno-1-58" id="__codelineno-1-58" name="__codelineno-1-58"></a>        <span class="bp">self</span><span class="p">,</span>
<a href="#__codelineno-1-59" id="__codelineno-1-59" name="__codelineno-1-59"></a>        <span class="n">base_allocation</span><span class="p">:</span> <span class="n">BaseAllocation</span><span class="p">,</span>
<a href="#__codelineno-1-60" id="__codelineno-1-60" name="__codelineno-1-60"></a>        <span class="n">cycle_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a href="#__codelineno-1-61" id="__codelineno-1-61" name="__codelineno-1-61"></a>        <span class="n">parallel_group</span><span class="p">:</span> <span class="n">ParallelGroup</span><span class="p">,</span>
<a href="#__codelineno-1-62" id="__codelineno-1-62" name="__codelineno-1-62"></a>        <span class="n">predicted_usage</span><span class="p">:</span> <span class="n">PredictedUsage</span>
<a href="#__codelineno-1-63" id="__codelineno-1-63" name="__codelineno-1-63"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AdjustedAllocation</span><span class="p">:</span>
<a href="#__codelineno-1-64" id="__codelineno-1-64" name="__codelineno-1-64"></a><span class="w">        </span><span class="sd">"""Apply intelligent adjustments based on multiple factors"""</span>
<a href="#__codelineno-1-65" id="__codelineno-1-65" name="__codelineno-1-65"></a>
<a href="#__codelineno-1-66" id="__codelineno-1-66" name="__codelineno-1-66"></a>        <span class="n">adjustments</span> <span class="o">=</span> <span class="n">AdjustedAllocation</span><span class="p">(</span>
<a href="#__codelineno-1-67" id="__codelineno-1-67" name="__codelineno-1-67"></a>            <span class="n">tokens</span><span class="o">=</span><span class="n">base_allocation</span><span class="o">.</span><span class="n">tokens</span><span class="p">,</span>
<a href="#__codelineno-1-68" id="__codelineno-1-68" name="__codelineno-1-68"></a>            <span class="n">priority_multiplier</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
<a href="#__codelineno-1-69" id="__codelineno-1-69" name="__codelineno-1-69"></a>            <span class="n">phase_adjustments</span><span class="o">=</span><span class="p">{},</span>
<a href="#__codelineno-1-70" id="__codelineno-1-70" name="__codelineno-1-70"></a>            <span class="n">sharing_permissions</span><span class="o">=</span><span class="nb">set</span><span class="p">()</span>
<a href="#__codelineno-1-71" id="__codelineno-1-71" name="__codelineno-1-71"></a>        <span class="p">)</span>
<a href="#__codelineno-1-72" id="__codelineno-1-72" name="__codelineno-1-72"></a>
<a href="#__codelineno-1-73" id="__codelineno-1-73" name="__codelineno-1-73"></a>        <span class="c1"># Story complexity adjustment</span>
<a href="#__codelineno-1-74" id="__codelineno-1-74" name="__codelineno-1-74"></a>        <span class="n">story_complexity</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_story_complexity</span><span class="p">(</span><span class="n">cycle_id</span><span class="p">)</span>
<a href="#__codelineno-1-75" id="__codelineno-1-75" name="__codelineno-1-75"></a>        <span class="k">if</span> <span class="n">story_complexity</span><span class="o">.</span><span class="n">complexity_score</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
<a href="#__codelineno-1-76" id="__codelineno-1-76" name="__codelineno-1-76"></a>            <span class="n">adjustments</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">adjustments</span><span class="o">.</span><span class="n">tokens</span> <span class="o">*</span> <span class="mf">1.3</span><span class="p">)</span>  <span class="c1"># 30% more for complex stories</span>
<a href="#__codelineno-1-77" id="__codelineno-1-77" name="__codelineno-1-77"></a>        <span class="k">elif</span> <span class="n">story_complexity</span><span class="o">.</span><span class="n">complexity_score</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
<a href="#__codelineno-1-78" id="__codelineno-1-78" name="__codelineno-1-78"></a>            <span class="n">adjustments</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">adjustments</span><span class="o">.</span><span class="n">tokens</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>  <span class="c1"># 20% less for simple stories</span>
<a href="#__codelineno-1-79" id="__codelineno-1-79" name="__codelineno-1-79"></a>
<a href="#__codelineno-1-80" id="__codelineno-1-80" name="__codelineno-1-80"></a>        <span class="c1"># TDD phase adjustments</span>
<a href="#__codelineno-1-81" id="__codelineno-1-81" name="__codelineno-1-81"></a>        <span class="n">adjustments</span><span class="o">.</span><span class="n">phase_adjustments</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-1-82" id="__codelineno-1-82" name="__codelineno-1-82"></a>            <span class="n">TDDState</span><span class="o">.</span><span class="n">DESIGN</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span>      <span class="c1"># Design needs more context</span>
<a href="#__codelineno-1-83" id="__codelineno-1-83" name="__codelineno-1-83"></a>            <span class="n">TDDState</span><span class="o">.</span><span class="n">TEST_RED</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>    <span class="c1"># Standard allocation</span>
<a href="#__codelineno-1-84" id="__codelineno-1-84" name="__codelineno-1-84"></a>            <span class="n">TDDState</span><span class="o">.</span><span class="n">CODE_GREEN</span><span class="p">:</span> <span class="mf">1.1</span><span class="p">,</span>  <span class="c1"># Implementation needs good context</span>
<a href="#__codelineno-1-85" id="__codelineno-1-85" name="__codelineno-1-85"></a>            <span class="n">TDDState</span><span class="o">.</span><span class="n">REFACTOR</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>    <span class="c1"># Refactoring needs less new context</span>
<a href="#__codelineno-1-86" id="__codelineno-1-86" name="__codelineno-1-86"></a>            <span class="n">TDDState</span><span class="o">.</span><span class="n">COMMIT</span><span class="p">:</span> <span class="mf">0.7</span>       <span class="c1"># Minimal context for commits</span>
<a href="#__codelineno-1-87" id="__codelineno-1-87" name="__codelineno-1-87"></a>        <span class="p">}</span>
<a href="#__codelineno-1-88" id="__codelineno-1-88" name="__codelineno-1-88"></a>
<a href="#__codelineno-1-89" id="__codelineno-1-89" name="__codelineno-1-89"></a>        <span class="c1"># Parallel coordination adjustments</span>
<a href="#__codelineno-1-90" id="__codelineno-1-90" name="__codelineno-1-90"></a>        <span class="n">coordination_needs</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_coordination_needs</span><span class="p">(</span>
<a href="#__codelineno-1-91" id="__codelineno-1-91" name="__codelineno-1-91"></a>            <span class="n">cycle_id</span><span class="p">,</span> <span class="n">parallel_group</span>
<a href="#__codelineno-1-92" id="__codelineno-1-92" name="__codelineno-1-92"></a>        <span class="p">)</span>
<a href="#__codelineno-1-93" id="__codelineno-1-93" name="__codelineno-1-93"></a>
<a href="#__codelineno-1-94" id="__codelineno-1-94" name="__codelineno-1-94"></a>        <span class="k">if</span> <span class="n">coordination_needs</span><span class="o">.</span><span class="n">requires_shared_context</span><span class="p">:</span>
<a href="#__codelineno-1-95" id="__codelineno-1-95" name="__codelineno-1-95"></a>            <span class="n">adjustments</span><span class="o">.</span><span class="n">sharing_permissions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">'shared_state'</span><span class="p">)</span>
<a href="#__codelineno-1-96" id="__codelineno-1-96" name="__codelineno-1-96"></a>            <span class="n">adjustments</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">adjustments</span><span class="o">.</span><span class="n">tokens</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">)</span>  <span class="c1"># 10% less for individual use</span>
<a href="#__codelineno-1-97" id="__codelineno-1-97" name="__codelineno-1-97"></a>
<a href="#__codelineno-1-98" id="__codelineno-1-98" name="__codelineno-1-98"></a>        <span class="k">if</span> <span class="n">coordination_needs</span><span class="o">.</span><span class="n">high_conflict_risk</span><span class="p">:</span>
<a href="#__codelineno-1-99" id="__codelineno-1-99" name="__codelineno-1-99"></a>            <span class="n">adjustments</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">adjustments</span><span class="o">.</span><span class="n">tokens</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>  <span class="c1"># 10% more for conflict resolution</span>
<a href="#__codelineno-1-100" id="__codelineno-1-100" name="__codelineno-1-100"></a>
<a href="#__codelineno-1-101" id="__codelineno-1-101" name="__codelineno-1-101"></a>        <span class="c1"># Historical usage adjustment</span>
<a href="#__codelineno-1-102" id="__codelineno-1-102" name="__codelineno-1-102"></a>        <span class="n">historical_efficiency</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_historical_efficiency</span><span class="p">(</span><span class="n">cycle_id</span><span class="p">)</span>
<a href="#__codelineno-1-103" id="__codelineno-1-103" name="__codelineno-1-103"></a>        <span class="k">if</span> <span class="n">historical_efficiency</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">:</span>  <span class="c1"># Very efficient usage</span>
<a href="#__codelineno-1-104" id="__codelineno-1-104" name="__codelineno-1-104"></a>            <span class="n">adjustments</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">adjustments</span><span class="o">.</span><span class="n">tokens</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">)</span>  <span class="c1"># Slightly reduce</span>
<a href="#__codelineno-1-105" id="__codelineno-1-105" name="__codelineno-1-105"></a>        <span class="k">elif</span> <span class="n">historical_efficiency</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">:</span>  <span class="c1"># Inefficient usage</span>
<a href="#__codelineno-1-106" id="__codelineno-1-106" name="__codelineno-1-106"></a>            <span class="n">adjustments</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">adjustments</span><span class="o">.</span><span class="n">tokens</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">)</span>  <span class="c1"># Slightly increase</span>
<a href="#__codelineno-1-107" id="__codelineno-1-107" name="__codelineno-1-107"></a>
<a href="#__codelineno-1-108" id="__codelineno-1-108" name="__codelineno-1-108"></a>        <span class="k">return</span> <span class="n">adjustments</span>
<a href="#__codelineno-1-109" id="__codelineno-1-109" name="__codelineno-1-109"></a>
<a href="#__codelineno-1-110" id="__codelineno-1-110" name="__codelineno-1-110"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">rebalance_budgets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RebalancingResult</span><span class="p">:</span>
<a href="#__codelineno-1-111" id="__codelineno-1-111" name="__codelineno-1-111"></a><span class="w">        </span><span class="sd">"""Dynamically rebalance token budgets across active cycles"""</span>
<a href="#__codelineno-1-112" id="__codelineno-1-112" name="__codelineno-1-112"></a>
<a href="#__codelineno-1-113" id="__codelineno-1-113" name="__codelineno-1-113"></a>        <span class="c1"># Analyze current usage patterns</span>
<a href="#__codelineno-1-114" id="__codelineno-1-114" name="__codelineno-1-114"></a>        <span class="n">usage_analysis</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_current_usage</span><span class="p">()</span>
<a href="#__codelineno-1-115" id="__codelineno-1-115" name="__codelineno-1-115"></a>
<a href="#__codelineno-1-116" id="__codelineno-1-116" name="__codelineno-1-116"></a>        <span class="c1"># Identify rebalancing opportunities</span>
<a href="#__codelineno-1-117" id="__codelineno-1-117" name="__codelineno-1-117"></a>        <span class="n">opportunities</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identify_rebalancing_opportunities</span><span class="p">(</span><span class="n">usage_analysis</span><span class="p">)</span>
<a href="#__codelineno-1-118" id="__codelineno-1-118" name="__codelineno-1-118"></a>
<a href="#__codelineno-1-119" id="__codelineno-1-119" name="__codelineno-1-119"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">opportunities</span><span class="p">:</span>
<a href="#__codelineno-1-120" id="__codelineno-1-120" name="__codelineno-1-120"></a>            <span class="k">return</span> <span class="n">RebalancingResult</span><span class="p">(</span><span class="n">rebalanced</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s2">"No opportunities found"</span><span class="p">)</span>
<a href="#__codelineno-1-121" id="__codelineno-1-121" name="__codelineno-1-121"></a>
<a href="#__codelineno-1-122" id="__codelineno-1-122" name="__codelineno-1-122"></a>        <span class="c1"># Execute rebalancing</span>
<a href="#__codelineno-1-123" id="__codelineno-1-123" name="__codelineno-1-123"></a>        <span class="n">rebalancing_plan</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_rebalancing_plan</span><span class="p">(</span><span class="n">opportunities</span><span class="p">)</span>
<a href="#__codelineno-1-124" id="__codelineno-1-124" name="__codelineno-1-124"></a>        <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_rebalancing</span><span class="p">(</span><span class="n">rebalancing_plan</span><span class="p">)</span>
<a href="#__codelineno-1-125" id="__codelineno-1-125" name="__codelineno-1-125"></a>
<a href="#__codelineno-1-126" id="__codelineno-1-126" name="__codelineno-1-126"></a>        <span class="k">return</span> <span class="n">RebalancingResult</span><span class="p">(</span>
<a href="#__codelineno-1-127" id="__codelineno-1-127" name="__codelineno-1-127"></a>            <span class="n">rebalanced</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a href="#__codelineno-1-128" id="__codelineno-1-128" name="__codelineno-1-128"></a>            <span class="n">cycles_adjusted</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
<a href="#__codelineno-1-129" id="__codelineno-1-129" name="__codelineno-1-129"></a>            <span class="n">tokens_redistributed</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">tokens_moved</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">),</span>
<a href="#__codelineno-1-130" id="__codelineno-1-130" name="__codelineno-1-130"></a>            <span class="n">efficiency_improvement</span><span class="o">=</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_efficiency_improvement</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<a href="#__codelineno-1-131" id="__codelineno-1-131" name="__codelineno-1-131"></a>        <span class="p">)</span>
<a href="#__codelineno-1-132" id="__codelineno-1-132" name="__codelineno-1-132"></a>
<a href="#__codelineno-1-133" id="__codelineno-1-133" name="__codelineno-1-133"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_identify_rebalancing_opportunities</span><span class="p">(</span>
<a href="#__codelineno-1-134" id="__codelineno-1-134" name="__codelineno-1-134"></a>        <span class="bp">self</span><span class="p">,</span> 
<a href="#__codelineno-1-135" id="__codelineno-1-135" name="__codelineno-1-135"></a>        <span class="n">usage_analysis</span><span class="p">:</span> <span class="n">UsageAnalysis</span>
<a href="#__codelineno-1-136" id="__codelineno-1-136" name="__codelineno-1-136"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RebalancingOpportunity</span><span class="p">]:</span>
<a href="#__codelineno-1-137" id="__codelineno-1-137" name="__codelineno-1-137"></a><span class="w">        </span><span class="sd">"""Identify token budget rebalancing opportunities"""</span>
<a href="#__codelineno-1-138" id="__codelineno-1-138" name="__codelineno-1-138"></a>        <span class="n">opportunities</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-1-139" id="__codelineno-1-139" name="__codelineno-1-139"></a>
<a href="#__codelineno-1-140" id="__codelineno-1-140" name="__codelineno-1-140"></a>        <span class="k">for</span> <span class="n">cycle_id</span><span class="p">,</span> <span class="n">usage</span> <span class="ow">in</span> <span class="n">usage_analysis</span><span class="o">.</span><span class="n">cycle_usage</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a href="#__codelineno-1-141" id="__codelineno-1-141" name="__codelineno-1-141"></a>            <span class="n">allocation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cycle_id</span><span class="p">)</span>
<a href="#__codelineno-1-142" id="__codelineno-1-142" name="__codelineno-1-142"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">allocation</span><span class="p">:</span>
<a href="#__codelineno-1-143" id="__codelineno-1-143" name="__codelineno-1-143"></a>                <span class="k">continue</span>
<a href="#__codelineno-1-144" id="__codelineno-1-144" name="__codelineno-1-144"></a>
<a href="#__codelineno-1-145" id="__codelineno-1-145" name="__codelineno-1-145"></a>            <span class="c1"># Over-allocated cycles (using much less than allocated)</span>
<a href="#__codelineno-1-146" id="__codelineno-1-146" name="__codelineno-1-146"></a>            <span class="k">if</span> <span class="n">usage</span><span class="o">.</span><span class="n">efficiency</span> <span class="o">&lt;</span> <span class="mf">0.4</span><span class="p">:</span>  <span class="c1"># Using less than 40% efficiently</span>
<a href="#__codelineno-1-147" id="__codelineno-1-147" name="__codelineno-1-147"></a>                <span class="n">tokens_to_free</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">allocation</span><span class="o">.</span><span class="n">allocated_tokens</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">)</span>
<a href="#__codelineno-1-148" id="__codelineno-1-148" name="__codelineno-1-148"></a>                <span class="n">opportunities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RebalancingOpportunity</span><span class="p">(</span>
<a href="#__codelineno-1-149" id="__codelineno-1-149" name="__codelineno-1-149"></a>                    <span class="n">cycle_id</span><span class="o">=</span><span class="n">cycle_id</span><span class="p">,</span>
<a href="#__codelineno-1-150" id="__codelineno-1-150" name="__codelineno-1-150"></a>                    <span class="nb">type</span><span class="o">=</span><span class="n">RebalancingType</span><span class="o">.</span><span class="n">REDUCE_ALLOCATION</span><span class="p">,</span>
<a href="#__codelineno-1-151" id="__codelineno-1-151" name="__codelineno-1-151"></a>                    <span class="n">tokens_available</span><span class="o">=</span><span class="n">tokens_to_free</span><span class="p">,</span>
<a href="#__codelineno-1-152" id="__codelineno-1-152" name="__codelineno-1-152"></a>                    <span class="n">confidence</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
<a href="#__codelineno-1-153" id="__codelineno-1-153" name="__codelineno-1-153"></a>                    <span class="n">reason</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Low efficiency: </span><span class="si">{</span><span class="n">usage</span><span class="o">.</span><span class="n">efficiency</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">"</span>
<a href="#__codelineno-1-154" id="__codelineno-1-154" name="__codelineno-1-154"></a>                <span class="p">))</span>
<a href="#__codelineno-1-155" id="__codelineno-1-155" name="__codelineno-1-155"></a>
<a href="#__codelineno-1-156" id="__codelineno-1-156" name="__codelineno-1-156"></a>            <span class="c1"># Under-allocated cycles (running out of tokens)</span>
<a href="#__codelineno-1-157" id="__codelineno-1-157" name="__codelineno-1-157"></a>            <span class="k">elif</span> <span class="n">usage</span><span class="o">.</span><span class="n">utilization</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">:</span>  <span class="c1"># Using more than 90% of allocation</span>
<a href="#__codelineno-1-158" id="__codelineno-1-158" name="__codelineno-1-158"></a>                <span class="n">tokens_needed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">allocation</span><span class="o">.</span><span class="n">allocated_tokens</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">)</span>
<a href="#__codelineno-1-159" id="__codelineno-1-159" name="__codelineno-1-159"></a>                <span class="n">opportunities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RebalancingOpportunity</span><span class="p">(</span>
<a href="#__codelineno-1-160" id="__codelineno-1-160" name="__codelineno-1-160"></a>                    <span class="n">cycle_id</span><span class="o">=</span><span class="n">cycle_id</span><span class="p">,</span>
<a href="#__codelineno-1-161" id="__codelineno-1-161" name="__codelineno-1-161"></a>                    <span class="nb">type</span><span class="o">=</span><span class="n">RebalancingType</span><span class="o">.</span><span class="n">INCREASE_ALLOCATION</span><span class="p">,</span>
<a href="#__codelineno-1-162" id="__codelineno-1-162" name="__codelineno-1-162"></a>                    <span class="n">tokens_needed</span><span class="o">=</span><span class="n">tokens_needed</span><span class="p">,</span>
<a href="#__codelineno-1-163" id="__codelineno-1-163" name="__codelineno-1-163"></a>                    <span class="n">confidence</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
<a href="#__codelineno-1-164" id="__codelineno-1-164" name="__codelineno-1-164"></a>                    <span class="n">reason</span><span class="o">=</span><span class="sa">f</span><span class="s2">"High utilization: </span><span class="si">{</span><span class="n">usage</span><span class="o">.</span><span class="n">utilization</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">"</span>
<a href="#__codelineno-1-165" id="__codelineno-1-165" name="__codelineno-1-165"></a>                <span class="p">))</span>
<a href="#__codelineno-1-166" id="__codelineno-1-166" name="__codelineno-1-166"></a>
<a href="#__codelineno-1-167" id="__codelineno-1-167" name="__codelineno-1-167"></a>        <span class="k">return</span> <span class="n">opportunities</span>
<a href="#__codelineno-1-168" id="__codelineno-1-168" name="__codelineno-1-168"></a>
<a href="#__codelineno-1-169" id="__codelineno-1-169" name="__codelineno-1-169"></a><span class="k">class</span> <span class="nc">TokenUsagePredictionModel</span><span class="p">:</span>
<a href="#__codelineno-1-170" id="__codelineno-1-170" name="__codelineno-1-170"></a><span class="w">    </span><span class="sd">"""ML-based prediction of token usage for cycles"""</span>
<a href="#__codelineno-1-171" id="__codelineno-1-171" name="__codelineno-1-171"></a>
<a href="#__codelineno-1-172" id="__codelineno-1-172" name="__codelineno-1-172"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-1-173" id="__codelineno-1-173" name="__codelineno-1-173"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">usage_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_usage_model</span><span class="p">()</span>
<a href="#__codelineno-1-174" id="__codelineno-1-174" name="__codelineno-1-174"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">TokenUsageFeatureExtractor</span><span class="p">()</span>
<a href="#__codelineno-1-175" id="__codelineno-1-175" name="__codelineno-1-175"></a>
<a href="#__codelineno-1-176" id="__codelineno-1-176" name="__codelineno-1-176"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">predict_cycle_usage</span><span class="p">(</span>
<a href="#__codelineno-1-177" id="__codelineno-1-177" name="__codelineno-1-177"></a>        <span class="bp">self</span><span class="p">,</span> 
<a href="#__codelineno-1-178" id="__codelineno-1-178" name="__codelineno-1-178"></a>        <span class="n">cycle_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a href="#__codelineno-1-179" id="__codelineno-1-179" name="__codelineno-1-179"></a>        <span class="n">parallel_group</span><span class="p">:</span> <span class="n">ParallelGroup</span>
<a href="#__codelineno-1-180" id="__codelineno-1-180" name="__codelineno-1-180"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PredictedUsage</span><span class="p">:</span>
<a href="#__codelineno-1-181" id="__codelineno-1-181" name="__codelineno-1-181"></a><span class="w">        </span><span class="sd">"""Predict token usage for a cycle"""</span>
<a href="#__codelineno-1-182" id="__codelineno-1-182" name="__codelineno-1-182"></a>
<a href="#__codelineno-1-183" id="__codelineno-1-183" name="__codelineno-1-183"></a>        <span class="c1"># Extract features for prediction</span>
<a href="#__codelineno-1-184" id="__codelineno-1-184" name="__codelineno-1-184"></a>        <span class="n">features</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_extractor</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span>
<a href="#__codelineno-1-185" id="__codelineno-1-185" name="__codelineno-1-185"></a>            <span class="n">cycle_id</span><span class="p">,</span> <span class="n">parallel_group</span>
<a href="#__codelineno-1-186" id="__codelineno-1-186" name="__codelineno-1-186"></a>        <span class="p">)</span>
<a href="#__codelineno-1-187" id="__codelineno-1-187" name="__codelineno-1-187"></a>
<a href="#__codelineno-1-188" id="__codelineno-1-188" name="__codelineno-1-188"></a>        <span class="c1"># Predict different aspects of usage</span>
<a href="#__codelineno-1-189" id="__codelineno-1-189" name="__codelineno-1-189"></a>        <span class="n">total_usage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">usage_model</span><span class="o">.</span><span class="n">total_usage</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">features</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<a href="#__codelineno-1-190" id="__codelineno-1-190" name="__codelineno-1-190"></a>        <span class="n">peak_usage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">usage_model</span><span class="o">.</span><span class="n">peak_usage</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">features</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<a href="#__codelineno-1-191" id="__codelineno-1-191" name="__codelineno-1-191"></a>        <span class="n">phase_distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">usage_model</span><span class="o">.</span><span class="n">phase_distribution</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">features</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<a href="#__codelineno-1-192" id="__codelineno-1-192" name="__codelineno-1-192"></a>
<a href="#__codelineno-1-193" id="__codelineno-1-193" name="__codelineno-1-193"></a>        <span class="k">return</span> <span class="n">PredictedUsage</span><span class="p">(</span>
<a href="#__codelineno-1-194" id="__codelineno-1-194" name="__codelineno-1-194"></a>            <span class="n">total_tokens</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">total_usage</span><span class="p">),</span>
<a href="#__codelineno-1-195" id="__codelineno-1-195" name="__codelineno-1-195"></a>            <span class="n">peak_tokens_per_hour</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">peak_usage</span><span class="p">),</span>
<a href="#__codelineno-1-196" id="__codelineno-1-196" name="__codelineno-1-196"></a>            <span class="n">phase_distribution</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
<a href="#__codelineno-1-197" id="__codelineno-1-197" name="__codelineno-1-197"></a>                <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">TDDState</span><span class="p">],</span> 
<a href="#__codelineno-1-198" id="__codelineno-1-198" name="__codelineno-1-198"></a>                <span class="n">phase_distribution</span>
<a href="#__codelineno-1-199" id="__codelineno-1-199" name="__codelineno-1-199"></a>            <span class="p">)),</span>
<a href="#__codelineno-1-200" id="__codelineno-1-200" name="__codelineno-1-200"></a>            <span class="n">confidence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">usage_model</span><span class="o">.</span><span class="n">confidence_score</span><span class="p">([</span><span class="n">features</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<a href="#__codelineno-1-201" id="__codelineno-1-201" name="__codelineno-1-201"></a>        <span class="p">)</span>
<a href="#__codelineno-1-202" id="__codelineno-1-202" name="__codelineno-1-202"></a>
<a href="#__codelineno-1-203" id="__codelineno-1-203" name="__codelineno-1-203"></a><span class="k">class</span> <span class="nc">TokenUsageFeatureExtractor</span><span class="p">:</span>
<a href="#__codelineno-1-204" id="__codelineno-1-204" name="__codelineno-1-204"></a><span class="w">    </span><span class="sd">"""Extract features for token usage prediction"""</span>
<a href="#__codelineno-1-205" id="__codelineno-1-205" name="__codelineno-1-205"></a>
<a href="#__codelineno-1-206" id="__codelineno-1-206" name="__codelineno-1-206"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">extract_features</span><span class="p">(</span>
<a href="#__codelineno-1-207" id="__codelineno-1-207" name="__codelineno-1-207"></a>        <span class="bp">self</span><span class="p">,</span> 
<a href="#__codelineno-1-208" id="__codelineno-1-208" name="__codelineno-1-208"></a>        <span class="n">cycle_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
<a href="#__codelineno-1-209" id="__codelineno-1-209" name="__codelineno-1-209"></a>        <span class="n">parallel_group</span><span class="p">:</span> <span class="n">ParallelGroup</span>
<a href="#__codelineno-1-210" id="__codelineno-1-210" name="__codelineno-1-210"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<a href="#__codelineno-1-211" id="__codelineno-1-211" name="__codelineno-1-211"></a><span class="w">        </span><span class="sd">"""Extract feature vector for usage prediction"""</span>
<a href="#__codelineno-1-212" id="__codelineno-1-212" name="__codelineno-1-212"></a>        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-1-213" id="__codelineno-1-213" name="__codelineno-1-213"></a>
<a href="#__codelineno-1-214" id="__codelineno-1-214" name="__codelineno-1-214"></a>        <span class="c1"># Story characteristics</span>
<a href="#__codelineno-1-215" id="__codelineno-1-215" name="__codelineno-1-215"></a>        <span class="n">story</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_story_for_cycle</span><span class="p">(</span><span class="n">cycle_id</span><span class="p">)</span>
<a href="#__codelineno-1-216" id="__codelineno-1-216" name="__codelineno-1-216"></a>        <span class="n">features</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
<a href="#__codelineno-1-217" id="__codelineno-1-217" name="__codelineno-1-217"></a>            <span class="nb">len</span><span class="p">(</span><span class="n">story</span><span class="o">.</span><span class="n">description</span><span class="p">),</span>
<a href="#__codelineno-1-218" id="__codelineno-1-218" name="__codelineno-1-218"></a>            <span class="nb">len</span><span class="p">(</span><span class="n">story</span><span class="o">.</span><span class="n">acceptance_criteria</span><span class="p">),</span>
<a href="#__codelineno-1-219" id="__codelineno-1-219" name="__codelineno-1-219"></a>            <span class="n">story</span><span class="o">.</span><span class="n">story_points</span> <span class="ow">or</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># Default to 3 if not set</span>
<a href="#__codelineno-1-220" id="__codelineno-1-220" name="__codelineno-1-220"></a>            <span class="nb">len</span><span class="p">(</span><span class="n">story</span><span class="o">.</span><span class="n">files</span> <span class="ow">or</span> <span class="p">[]),</span>
<a href="#__codelineno-1-221" id="__codelineno-1-221" name="__codelineno-1-221"></a>            <span class="n">story</span><span class="o">.</span><span class="n">priority</span>
<a href="#__codelineno-1-222" id="__codelineno-1-222" name="__codelineno-1-222"></a>        <span class="p">])</span>
<a href="#__codelineno-1-223" id="__codelineno-1-223" name="__codelineno-1-223"></a>
<a href="#__codelineno-1-224" id="__codelineno-1-224" name="__codelineno-1-224"></a>        <span class="c1"># Code complexity features</span>
<a href="#__codelineno-1-225" id="__codelineno-1-225" name="__codelineno-1-225"></a>        <span class="k">if</span> <span class="n">story</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
<a href="#__codelineno-1-226" id="__codelineno-1-226" name="__codelineno-1-226"></a>            <span class="n">complexity</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_code_complexity</span><span class="p">(</span><span class="n">story</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>
<a href="#__codelineno-1-227" id="__codelineno-1-227" name="__codelineno-1-227"></a>            <span class="n">features</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
<a href="#__codelineno-1-228" id="__codelineno-1-228" name="__codelineno-1-228"></a>                <span class="n">complexity</span><span class="o">.</span><span class="n">cyclomatic_complexity</span><span class="p">,</span>
<a href="#__codelineno-1-229" id="__codelineno-1-229" name="__codelineno-1-229"></a>                <span class="n">complexity</span><span class="o">.</span><span class="n">lines_of_code</span><span class="p">,</span>
<a href="#__codelineno-1-230" id="__codelineno-1-230" name="__codelineno-1-230"></a>                <span class="n">complexity</span><span class="o">.</span><span class="n">function_count</span><span class="p">,</span>
<a href="#__codelineno-1-231" id="__codelineno-1-231" name="__codelineno-1-231"></a>                <span class="n">complexity</span><span class="o">.</span><span class="n">class_count</span>
<a href="#__codelineno-1-232" id="__codelineno-1-232" name="__codelineno-1-232"></a>            <span class="p">])</span>
<a href="#__codelineno-1-233" id="__codelineno-1-233" name="__codelineno-1-233"></a>        <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-1-234" id="__codelineno-1-234" name="__codelineno-1-234"></a>            <span class="n">features</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>  <span class="c1"># Default values</span>
<a href="#__codelineno-1-235" id="__codelineno-1-235" name="__codelineno-1-235"></a>
<a href="#__codelineno-1-236" id="__codelineno-1-236" name="__codelineno-1-236"></a>        <span class="c1"># Parallel context features</span>
<a href="#__codelineno-1-237" id="__codelineno-1-237" name="__codelineno-1-237"></a>        <span class="n">features</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
<a href="#__codelineno-1-238" id="__codelineno-1-238" name="__codelineno-1-238"></a>            <span class="nb">len</span><span class="p">(</span><span class="n">parallel_group</span><span class="o">.</span><span class="n">cycles</span><span class="p">),</span>
<a href="#__codelineno-1-239" id="__codelineno-1-239" name="__codelineno-1-239"></a>            <span class="n">parallel_group</span><span class="o">.</span><span class="n">conflict_risk_score</span><span class="p">,</span>
<a href="#__codelineno-1-240" id="__codelineno-1-240" name="__codelineno-1-240"></a>            <span class="mi">1</span> <span class="k">if</span> <span class="n">parallel_group</span><span class="o">.</span><span class="n">requires_coordination</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
<a href="#__codelineno-1-241" id="__codelineno-1-241" name="__codelineno-1-241"></a>            <span class="n">parallel_group</span><span class="o">.</span><span class="n">shared_file_count</span>
<a href="#__codelineno-1-242" id="__codelineno-1-242" name="__codelineno-1-242"></a>        <span class="p">])</span>
<a href="#__codelineno-1-243" id="__codelineno-1-243" name="__codelineno-1-243"></a>
<a href="#__codelineno-1-244" id="__codelineno-1-244" name="__codelineno-1-244"></a>        <span class="c1"># Historical features</span>
<a href="#__codelineno-1-245" id="__codelineno-1-245" name="__codelineno-1-245"></a>        <span class="n">historical_usage</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_historical_usage</span><span class="p">(</span><span class="n">cycle_id</span><span class="p">)</span>
<a href="#__codelineno-1-246" id="__codelineno-1-246" name="__codelineno-1-246"></a>        <span class="n">features</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
<a href="#__codelineno-1-247" id="__codelineno-1-247" name="__codelineno-1-247"></a>            <span class="n">historical_usage</span><span class="o">.</span><span class="n">average_total_usage</span><span class="p">,</span>
<a href="#__codelineno-1-248" id="__codelineno-1-248" name="__codelineno-1-248"></a>            <span class="n">historical_usage</span><span class="o">.</span><span class="n">average_efficiency</span><span class="p">,</span>
<a href="#__codelineno-1-249" id="__codelineno-1-249" name="__codelineno-1-249"></a>            <span class="n">historical_usage</span><span class="o">.</span><span class="n">completion_rate</span>
<a href="#__codelineno-1-250" id="__codelineno-1-250" name="__codelineno-1-250"></a>        <span class="p">])</span>
<a href="#__codelineno-1-251" id="__codelineno-1-251" name="__codelineno-1-251"></a>
<a href="#__codelineno-1-252" id="__codelineno-1-252" name="__codelineno-1-252"></a>        <span class="c1"># Temporal features</span>
<a href="#__codelineno-1-253" id="__codelineno-1-253" name="__codelineno-1-253"></a>        <span class="n">features</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
<a href="#__codelineno-1-254" id="__codelineno-1-254" name="__codelineno-1-254"></a>            <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>  <span class="c1"># Time of day</span>
<a href="#__codelineno-1-255" id="__codelineno-1-255" name="__codelineno-1-255"></a>            <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">weekday</span><span class="p">(),</span>  <span class="c1"># Day of week</span>
<a href="#__codelineno-1-256" id="__codelineno-1-256" name="__codelineno-1-256"></a>            <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_peak_usage_time</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span>
<a href="#__codelineno-1-257" id="__codelineno-1-257" name="__codelineno-1-257"></a>        <span class="p">])</span>
<a href="#__codelineno-1-258" id="__codelineno-1-258" name="__codelineno-1-258"></a>
<a href="#__codelineno-1-259" id="__codelineno-1-259" name="__codelineno-1-259"></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
</code></pre></div>
<h3 id="3-context-sharing-and-coordination">3. Context Sharing and Coordination<a class="headerlink" href="#3-context-sharing-and-coordination" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">class</span> <span class="nc">ContextSharingCoordinator</span><span class="p">:</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="sd">"""Coordinate context sharing between parallel cycles"""</span>
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shared_contexts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SharedContext</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sharing_policies</span> <span class="o">=</span> <span class="n">ContextSharingPolicies</span><span class="p">()</span>
<a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conflict_detector</span> <span class="o">=</span> <span class="n">ContextConflictDetector</span><span class="p">()</span>
<a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a>
<a href="#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">share_context</span><span class="p">(</span>
<a href="#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a>        <span class="bp">self</span><span class="p">,</span>
<a href="#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a>        <span class="n">from_cycle</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a href="#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a>        <span class="n">to_cycle</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a href="#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a>        <span class="n">context_keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a href="#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a>        <span class="n">sharing_mode</span><span class="p">:</span> <span class="n">SharingMode</span> <span class="o">=</span> <span class="n">SharingMode</span><span class="o">.</span><span class="n">READ_ONLY</span>
<a href="#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ContextSharingResult</span><span class="p">:</span>
<a href="#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">        </span><span class="sd">"""Share specific context between cycles"""</span>
<a href="#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a>
<a href="#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a>        <span class="c1"># Validate sharing is allowed</span>
<a href="#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a>        <span class="n">validation</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_sharing</span><span class="p">(</span><span class="n">from_cycle</span><span class="p">,</span> <span class="n">to_cycle</span><span class="p">,</span> <span class="n">context_keys</span><span class="p">)</span>
<a href="#__codelineno-2-20" id="__codelineno-2-20" name="__codelineno-2-20"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">validation</span><span class="o">.</span><span class="n">allowed</span><span class="p">:</span>
<a href="#__codelineno-2-21" id="__codelineno-2-21" name="__codelineno-2-21"></a>            <span class="k">return</span> <span class="n">ContextSharingResult</span><span class="p">(</span>
<a href="#__codelineno-2-22" id="__codelineno-2-22" name="__codelineno-2-22"></a>                <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a href="#__codelineno-2-23" id="__codelineno-2-23" name="__codelineno-2-23"></a>                <span class="n">reason</span><span class="o">=</span><span class="n">validation</span><span class="o">.</span><span class="n">reason</span>
<a href="#__codelineno-2-24" id="__codelineno-2-24" name="__codelineno-2-24"></a>            <span class="p">)</span>
<a href="#__codelineno-2-25" id="__codelineno-2-25" name="__codelineno-2-25"></a>
<a href="#__codelineno-2-26" id="__codelineno-2-26" name="__codelineno-2-26"></a>        <span class="c1"># Check for conflicts</span>
<a href="#__codelineno-2-27" id="__codelineno-2-27" name="__codelineno-2-27"></a>        <span class="n">conflicts</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">conflict_detector</span><span class="o">.</span><span class="n">detect_sharing_conflicts</span><span class="p">(</span>
<a href="#__codelineno-2-28" id="__codelineno-2-28" name="__codelineno-2-28"></a>            <span class="n">from_cycle</span><span class="p">,</span> <span class="n">to_cycle</span><span class="p">,</span> <span class="n">context_keys</span>
<a href="#__codelineno-2-29" id="__codelineno-2-29" name="__codelineno-2-29"></a>        <span class="p">)</span>
<a href="#__codelineno-2-30" id="__codelineno-2-30" name="__codelineno-2-30"></a>
<a href="#__codelineno-2-31" id="__codelineno-2-31" name="__codelineno-2-31"></a>        <span class="k">if</span> <span class="n">conflicts</span><span class="p">:</span>
<a href="#__codelineno-2-32" id="__codelineno-2-32" name="__codelineno-2-32"></a>            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_sharing_conflicts</span><span class="p">(</span><span class="n">conflicts</span><span class="p">,</span> <span class="n">sharing_mode</span><span class="p">)</span>
<a href="#__codelineno-2-33" id="__codelineno-2-33" name="__codelineno-2-33"></a>
<a href="#__codelineno-2-34" id="__codelineno-2-34" name="__codelineno-2-34"></a>        <span class="c1"># Execute sharing</span>
<a href="#__codelineno-2-35" id="__codelineno-2-35" name="__codelineno-2-35"></a>        <span class="n">shared_context</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_shared_context</span><span class="p">(</span>
<a href="#__codelineno-2-36" id="__codelineno-2-36" name="__codelineno-2-36"></a>            <span class="n">from_cycle</span><span class="p">,</span> <span class="n">to_cycle</span><span class="p">,</span> <span class="n">context_keys</span><span class="p">,</span> <span class="n">sharing_mode</span>
<a href="#__codelineno-2-37" id="__codelineno-2-37" name="__codelineno-2-37"></a>        <span class="p">)</span>
<a href="#__codelineno-2-38" id="__codelineno-2-38" name="__codelineno-2-38"></a>
<a href="#__codelineno-2-39" id="__codelineno-2-39" name="__codelineno-2-39"></a>        <span class="c1"># Update both cycles</span>
<a href="#__codelineno-2-40" id="__codelineno-2-40" name="__codelineno-2-40"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_cycle_with_shared_context</span><span class="p">(</span><span class="n">to_cycle</span><span class="p">,</span> <span class="n">shared_context</span><span class="p">)</span>
<a href="#__codelineno-2-41" id="__codelineno-2-41" name="__codelineno-2-41"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_context_dependency</span><span class="p">(</span><span class="n">from_cycle</span><span class="p">,</span> <span class="n">to_cycle</span><span class="p">,</span> <span class="n">shared_context</span><span class="p">)</span>
<a href="#__codelineno-2-42" id="__codelineno-2-42" name="__codelineno-2-42"></a>
<a href="#__codelineno-2-43" id="__codelineno-2-43" name="__codelineno-2-43"></a>        <span class="k">return</span> <span class="n">ContextSharingResult</span><span class="p">(</span>
<a href="#__codelineno-2-44" id="__codelineno-2-44" name="__codelineno-2-44"></a>            <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a href="#__codelineno-2-45" id="__codelineno-2-45" name="__codelineno-2-45"></a>            <span class="n">shared_context_id</span><span class="o">=</span><span class="n">shared_context</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a href="#__codelineno-2-46" id="__codelineno-2-46" name="__codelineno-2-46"></a>            <span class="n">token_cost</span><span class="o">=</span><span class="n">shared_context</span><span class="o">.</span><span class="n">token_cost</span><span class="p">,</span>
<a href="#__codelineno-2-47" id="__codelineno-2-47" name="__codelineno-2-47"></a>            <span class="n">sharing_mode</span><span class="o">=</span><span class="n">sharing_mode</span>
<a href="#__codelineno-2-48" id="__codelineno-2-48" name="__codelineno-2-48"></a>        <span class="p">)</span>
<a href="#__codelineno-2-49" id="__codelineno-2-49" name="__codelineno-2-49"></a>
<a href="#__codelineno-2-50" id="__codelineno-2-50" name="__codelineno-2-50"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_create_shared_context</span><span class="p">(</span>
<a href="#__codelineno-2-51" id="__codelineno-2-51" name="__codelineno-2-51"></a>        <span class="bp">self</span><span class="p">,</span>
<a href="#__codelineno-2-52" id="__codelineno-2-52" name="__codelineno-2-52"></a>        <span class="n">from_cycle</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a href="#__codelineno-2-53" id="__codelineno-2-53" name="__codelineno-2-53"></a>        <span class="n">to_cycle</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a href="#__codelineno-2-54" id="__codelineno-2-54" name="__codelineno-2-54"></a>        <span class="n">context_keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a href="#__codelineno-2-55" id="__codelineno-2-55" name="__codelineno-2-55"></a>        <span class="n">sharing_mode</span><span class="p">:</span> <span class="n">SharingMode</span>
<a href="#__codelineno-2-56" id="__codelineno-2-56" name="__codelineno-2-56"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SharedContext</span><span class="p">:</span>
<a href="#__codelineno-2-57" id="__codelineno-2-57" name="__codelineno-2-57"></a><span class="w">        </span><span class="sd">"""Create shared context between cycles"""</span>
<a href="#__codelineno-2-58" id="__codelineno-2-58" name="__codelineno-2-58"></a>
<a href="#__codelineno-2-59" id="__codelineno-2-59" name="__codelineno-2-59"></a>        <span class="n">source_context</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cycle_context</span><span class="p">(</span><span class="n">from_cycle</span><span class="p">)</span>
<a href="#__codelineno-2-60" id="__codelineno-2-60" name="__codelineno-2-60"></a>        <span class="n">target_context</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cycle_context</span><span class="p">(</span><span class="n">to_cycle</span><span class="p">)</span>
<a href="#__codelineno-2-61" id="__codelineno-2-61" name="__codelineno-2-61"></a>
<a href="#__codelineno-2-62" id="__codelineno-2-62" name="__codelineno-2-62"></a>        <span class="c1"># Extract requested context elements</span>
<a href="#__codelineno-2-63" id="__codelineno-2-63" name="__codelineno-2-63"></a>        <span class="n">shared_elements</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-2-64" id="__codelineno-2-64" name="__codelineno-2-64"></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">context_keys</span><span class="p">:</span>
<a href="#__codelineno-2-65" id="__codelineno-2-65" name="__codelineno-2-65"></a>            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">source_context</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
<a href="#__codelineno-2-66" id="__codelineno-2-66" name="__codelineno-2-66"></a>                <span class="n">element</span> <span class="o">=</span> <span class="n">source_context</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<a href="#__codelineno-2-67" id="__codelineno-2-67" name="__codelineno-2-67"></a>
<a href="#__codelineno-2-68" id="__codelineno-2-68" name="__codelineno-2-68"></a>                <span class="c1"># Apply sharing transformations</span>
<a href="#__codelineno-2-69" id="__codelineno-2-69" name="__codelineno-2-69"></a>                <span class="k">if</span> <span class="n">sharing_mode</span> <span class="o">==</span> <span class="n">SharingMode</span><span class="o">.</span><span class="n">READ_ONLY</span><span class="p">:</span>
<a href="#__codelineno-2-70" id="__codelineno-2-70" name="__codelineno-2-70"></a>                    <span class="n">shared_element</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_readonly_copy</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
<a href="#__codelineno-2-71" id="__codelineno-2-71" name="__codelineno-2-71"></a>                <span class="k">elif</span> <span class="n">sharing_mode</span> <span class="o">==</span> <span class="n">SharingMode</span><span class="o">.</span><span class="n">SYNCHRONIZED</span><span class="p">:</span>
<a href="#__codelineno-2-72" id="__codelineno-2-72" name="__codelineno-2-72"></a>                    <span class="n">shared_element</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_synchronized_element</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
<a href="#__codelineno-2-73" id="__codelineno-2-73" name="__codelineno-2-73"></a>                <span class="k">else</span><span class="p">:</span>  <span class="c1"># COPY</span>
<a href="#__codelineno-2-74" id="__codelineno-2-74" name="__codelineno-2-74"></a>                    <span class="n">shared_element</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_deep_copy</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
<a href="#__codelineno-2-75" id="__codelineno-2-75" name="__codelineno-2-75"></a>
<a href="#__codelineno-2-76" id="__codelineno-2-76" name="__codelineno-2-76"></a>                <span class="n">shared_elements</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">shared_element</span>
<a href="#__codelineno-2-77" id="__codelineno-2-77" name="__codelineno-2-77"></a>
<a href="#__codelineno-2-78" id="__codelineno-2-78" name="__codelineno-2-78"></a>        <span class="c1"># Create shared context</span>
<a href="#__codelineno-2-79" id="__codelineno-2-79" name="__codelineno-2-79"></a>        <span class="n">shared_context</span> <span class="o">=</span> <span class="n">SharedContext</span><span class="p">(</span>
<a href="#__codelineno-2-80" id="__codelineno-2-80" name="__codelineno-2-80"></a>            <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">"shared_</span><span class="si">{</span><span class="n">from_cycle</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">to_cycle</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
<a href="#__codelineno-2-81" id="__codelineno-2-81" name="__codelineno-2-81"></a>            <span class="n">from_cycle</span><span class="o">=</span><span class="n">from_cycle</span><span class="p">,</span>
<a href="#__codelineno-2-82" id="__codelineno-2-82" name="__codelineno-2-82"></a>            <span class="n">to_cycle</span><span class="o">=</span><span class="n">to_cycle</span><span class="p">,</span>
<a href="#__codelineno-2-83" id="__codelineno-2-83" name="__codelineno-2-83"></a>            <span class="n">elements</span><span class="o">=</span><span class="n">shared_elements</span><span class="p">,</span>
<a href="#__codelineno-2-84" id="__codelineno-2-84" name="__codelineno-2-84"></a>            <span class="n">sharing_mode</span><span class="o">=</span><span class="n">sharing_mode</span><span class="p">,</span>
<a href="#__codelineno-2-85" id="__codelineno-2-85" name="__codelineno-2-85"></a>            <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
<a href="#__codelineno-2-86" id="__codelineno-2-86" name="__codelineno-2-86"></a>            <span class="n">token_cost</span><span class="o">=</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_sharing_token_cost</span><span class="p">(</span><span class="n">shared_elements</span><span class="p">)</span>
<a href="#__codelineno-2-87" id="__codelineno-2-87" name="__codelineno-2-87"></a>        <span class="p">)</span>
<a href="#__codelineno-2-88" id="__codelineno-2-88" name="__codelineno-2-88"></a>
<a href="#__codelineno-2-89" id="__codelineno-2-89" name="__codelineno-2-89"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shared_contexts</span><span class="p">[</span><span class="n">shared_context</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">shared_context</span>
<a href="#__codelineno-2-90" id="__codelineno-2-90" name="__codelineno-2-90"></a>        <span class="k">return</span> <span class="n">shared_context</span>
<a href="#__codelineno-2-91" id="__codelineno-2-91" name="__codelineno-2-91"></a>
<a href="#__codelineno-2-92" id="__codelineno-2-92" name="__codelineno-2-92"></a><span class="k">class</span> <span class="nc">ContextConflictDetector</span><span class="p">:</span>
<a href="#__codelineno-2-93" id="__codelineno-2-93" name="__codelineno-2-93"></a><span class="w">    </span><span class="sd">"""Detect conflicts in context sharing"""</span>
<a href="#__codelineno-2-94" id="__codelineno-2-94" name="__codelineno-2-94"></a>
<a href="#__codelineno-2-95" id="__codelineno-2-95" name="__codelineno-2-95"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">detect_sharing_conflicts</span><span class="p">(</span>
<a href="#__codelineno-2-96" id="__codelineno-2-96" name="__codelineno-2-96"></a>        <span class="bp">self</span><span class="p">,</span>
<a href="#__codelineno-2-97" id="__codelineno-2-97" name="__codelineno-2-97"></a>        <span class="n">from_cycle</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a href="#__codelineno-2-98" id="__codelineno-2-98" name="__codelineno-2-98"></a>        <span class="n">to_cycle</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a href="#__codelineno-2-99" id="__codelineno-2-99" name="__codelineno-2-99"></a>        <span class="n">context_keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a href="#__codelineno-2-100" id="__codelineno-2-100" name="__codelineno-2-100"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ContextConflict</span><span class="p">]:</span>
<a href="#__codelineno-2-101" id="__codelineno-2-101" name="__codelineno-2-101"></a><span class="w">        </span><span class="sd">"""Detect potential conflicts from context sharing"""</span>
<a href="#__codelineno-2-102" id="__codelineno-2-102" name="__codelineno-2-102"></a>        <span class="n">conflicts</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-2-103" id="__codelineno-2-103" name="__codelineno-2-103"></a>
<a href="#__codelineno-2-104" id="__codelineno-2-104" name="__codelineno-2-104"></a>        <span class="n">source_context</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cycle_context</span><span class="p">(</span><span class="n">from_cycle</span><span class="p">)</span>
<a href="#__codelineno-2-105" id="__codelineno-2-105" name="__codelineno-2-105"></a>        <span class="n">target_context</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cycle_context</span><span class="p">(</span><span class="n">to_cycle</span><span class="p">)</span>
<a href="#__codelineno-2-106" id="__codelineno-2-106" name="__codelineno-2-106"></a>
<a href="#__codelineno-2-107" id="__codelineno-2-107" name="__codelineno-2-107"></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">context_keys</span><span class="p">:</span>
<a href="#__codelineno-2-108" id="__codelineno-2-108" name="__codelineno-2-108"></a>            <span class="c1"># Check for key conflicts</span>
<a href="#__codelineno-2-109" id="__codelineno-2-109" name="__codelineno-2-109"></a>            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">target_context</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
<a href="#__codelineno-2-110" id="__codelineno-2-110" name="__codelineno-2-110"></a>                <span class="n">existing_element</span> <span class="o">=</span> <span class="n">target_context</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<a href="#__codelineno-2-111" id="__codelineno-2-111" name="__codelineno-2-111"></a>                <span class="n">shared_element</span> <span class="o">=</span> <span class="n">source_context</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<a href="#__codelineno-2-112" id="__codelineno-2-112" name="__codelineno-2-112"></a>
<a href="#__codelineno-2-113" id="__codelineno-2-113" name="__codelineno-2-113"></a>                <span class="k">if</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements_conflict</span><span class="p">(</span><span class="n">existing_element</span><span class="p">,</span> <span class="n">shared_element</span><span class="p">):</span>
<a href="#__codelineno-2-114" id="__codelineno-2-114" name="__codelineno-2-114"></a>                    <span class="n">conflicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ContextConflict</span><span class="p">(</span>
<a href="#__codelineno-2-115" id="__codelineno-2-115" name="__codelineno-2-115"></a>                        <span class="nb">type</span><span class="o">=</span><span class="n">ConflictType</span><span class="o">.</span><span class="n">KEY_COLLISION</span><span class="p">,</span>
<a href="#__codelineno-2-116" id="__codelineno-2-116" name="__codelineno-2-116"></a>                        <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
<a href="#__codelineno-2-117" id="__codelineno-2-117" name="__codelineno-2-117"></a>                        <span class="n">from_cycle</span><span class="o">=</span><span class="n">from_cycle</span><span class="p">,</span>
<a href="#__codelineno-2-118" id="__codelineno-2-118" name="__codelineno-2-118"></a>                        <span class="n">to_cycle</span><span class="o">=</span><span class="n">to_cycle</span><span class="p">,</span>
<a href="#__codelineno-2-119" id="__codelineno-2-119" name="__codelineno-2-119"></a>                        <span class="n">severity</span><span class="o">=</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_conflict_severity</span><span class="p">(</span>
<a href="#__codelineno-2-120" id="__codelineno-2-120" name="__codelineno-2-120"></a>                            <span class="n">existing_element</span><span class="p">,</span> <span class="n">shared_element</span>
<a href="#__codelineno-2-121" id="__codelineno-2-121" name="__codelineno-2-121"></a>                        <span class="p">)</span>
<a href="#__codelineno-2-122" id="__codelineno-2-122" name="__codelineno-2-122"></a>                    <span class="p">))</span>
<a href="#__codelineno-2-123" id="__codelineno-2-123" name="__codelineno-2-123"></a>
<a href="#__codelineno-2-124" id="__codelineno-2-124" name="__codelineno-2-124"></a>            <span class="c1"># Check for semantic conflicts</span>
<a href="#__codelineno-2-125" id="__codelineno-2-125" name="__codelineno-2-125"></a>            <span class="n">semantic_conflicts</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_semantic_conflicts</span><span class="p">(</span>
<a href="#__codelineno-2-126" id="__codelineno-2-126" name="__codelineno-2-126"></a>                <span class="n">key</span><span class="p">,</span> <span class="n">source_context</span><span class="p">,</span> <span class="n">target_context</span>
<a href="#__codelineno-2-127" id="__codelineno-2-127" name="__codelineno-2-127"></a>            <span class="p">)</span>
<a href="#__codelineno-2-128" id="__codelineno-2-128" name="__codelineno-2-128"></a>            <span class="n">conflicts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">semantic_conflicts</span><span class="p">)</span>
<a href="#__codelineno-2-129" id="__codelineno-2-129" name="__codelineno-2-129"></a>
<a href="#__codelineno-2-130" id="__codelineno-2-130" name="__codelineno-2-130"></a>        <span class="k">return</span> <span class="n">conflicts</span>
<a href="#__codelineno-2-131" id="__codelineno-2-131" name="__codelineno-2-131"></a>
<a href="#__codelineno-2-132" id="__codelineno-2-132" name="__codelineno-2-132"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_elements_conflict</span><span class="p">(</span>
<a href="#__codelineno-2-133" id="__codelineno-2-133" name="__codelineno-2-133"></a>        <span class="bp">self</span><span class="p">,</span> 
<a href="#__codelineno-2-134" id="__codelineno-2-134" name="__codelineno-2-134"></a>        <span class="n">element1</span><span class="p">:</span> <span class="n">ContextElement</span><span class="p">,</span> 
<a href="#__codelineno-2-135" id="__codelineno-2-135" name="__codelineno-2-135"></a>        <span class="n">element2</span><span class="p">:</span> <span class="n">ContextElement</span>
<a href="#__codelineno-2-136" id="__codelineno-2-136" name="__codelineno-2-136"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a href="#__codelineno-2-137" id="__codelineno-2-137" name="__codelineno-2-137"></a><span class="w">        </span><span class="sd">"""Check if two context elements conflict"""</span>
<a href="#__codelineno-2-138" id="__codelineno-2-138" name="__codelineno-2-138"></a>
<a href="#__codelineno-2-139" id="__codelineno-2-139" name="__codelineno-2-139"></a>        <span class="c1"># Type conflicts</span>
<a href="#__codelineno-2-140" id="__codelineno-2-140" name="__codelineno-2-140"></a>        <span class="k">if</span> <span class="n">element1</span><span class="o">.</span><span class="n">element_type</span> <span class="o">!=</span> <span class="n">element2</span><span class="o">.</span><span class="n">element_type</span><span class="p">:</span>
<a href="#__codelineno-2-141" id="__codelineno-2-141" name="__codelineno-2-141"></a>            <span class="k">return</span> <span class="kc">True</span>
<a href="#__codelineno-2-142" id="__codelineno-2-142" name="__codelineno-2-142"></a>
<a href="#__codelineno-2-143" id="__codelineno-2-143" name="__codelineno-2-143"></a>        <span class="c1"># Content conflicts (for file content)</span>
<a href="#__codelineno-2-144" id="__codelineno-2-144" name="__codelineno-2-144"></a>        <span class="k">if</span> <span class="n">element1</span><span class="o">.</span><span class="n">element_type</span> <span class="o">==</span> <span class="n">ElementType</span><span class="o">.</span><span class="n">FILE_CONTENT</span><span class="p">:</span>
<a href="#__codelineno-2-145" id="__codelineno-2-145" name="__codelineno-2-145"></a>            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_contents_conflict</span><span class="p">(</span><span class="n">element1</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">element2</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<a href="#__codelineno-2-146" id="__codelineno-2-146" name="__codelineno-2-146"></a>
<a href="#__codelineno-2-147" id="__codelineno-2-147" name="__codelineno-2-147"></a>        <span class="c1"># Version conflicts</span>
<a href="#__codelineno-2-148" id="__codelineno-2-148" name="__codelineno-2-148"></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">element1</span><span class="p">,</span> <span class="s1">'version'</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">element2</span><span class="p">,</span> <span class="s1">'version'</span><span class="p">):</span>
<a href="#__codelineno-2-149" id="__codelineno-2-149" name="__codelineno-2-149"></a>            <span class="k">return</span> <span class="n">element1</span><span class="o">.</span><span class="n">version</span> <span class="o">!=</span> <span class="n">element2</span><span class="o">.</span><span class="n">version</span>
<a href="#__codelineno-2-150" id="__codelineno-2-150" name="__codelineno-2-150"></a>
<a href="#__codelineno-2-151" id="__codelineno-2-151" name="__codelineno-2-151"></a>        <span class="k">return</span> <span class="kc">False</span>
<a href="#__codelineno-2-152" id="__codelineno-2-152" name="__codelineno-2-152"></a>
<a href="#__codelineno-2-153" id="__codelineno-2-153" name="__codelineno-2-153"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_file_contents_conflict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content2</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a href="#__codelineno-2-154" id="__codelineno-2-154" name="__codelineno-2-154"></a><span class="w">        </span><span class="sd">"""Check if file contents conflict"""</span>
<a href="#__codelineno-2-155" id="__codelineno-2-155" name="__codelineno-2-155"></a>        <span class="c1"># Use AST comparison for code files</span>
<a href="#__codelineno-2-156" id="__codelineno-2-156" name="__codelineno-2-156"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_code_file</span><span class="p">(</span><span class="n">content1</span><span class="p">):</span>
<a href="#__codelineno-2-157" id="__codelineno-2-157" name="__codelineno-2-157"></a>            <span class="k">try</span><span class="p">:</span>
<a href="#__codelineno-2-158" id="__codelineno-2-158" name="__codelineno-2-158"></a>                <span class="n">ast1</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">content1</span><span class="p">)</span>
<a href="#__codelineno-2-159" id="__codelineno-2-159" name="__codelineno-2-159"></a>                <span class="n">ast2</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">content2</span><span class="p">)</span>
<a href="#__codelineno-2-160" id="__codelineno-2-160" name="__codelineno-2-160"></a>                <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_asts_compatible</span><span class="p">(</span><span class="n">ast1</span><span class="p">,</span> <span class="n">ast2</span><span class="p">)</span>
<a href="#__codelineno-2-161" id="__codelineno-2-161" name="__codelineno-2-161"></a>            <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
<a href="#__codelineno-2-162" id="__codelineno-2-162" name="__codelineno-2-162"></a>                <span class="c1"># Fall back to text comparison</span>
<a href="#__codelineno-2-163" id="__codelineno-2-163" name="__codelineno-2-163"></a>                <span class="k">return</span> <span class="n">content1</span> <span class="o">!=</span> <span class="n">content2</span>
<a href="#__codelineno-2-164" id="__codelineno-2-164" name="__codelineno-2-164"></a>        <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-2-165" id="__codelineno-2-165" name="__codelineno-2-165"></a>            <span class="c1"># Text comparison for non-code files</span>
<a href="#__codelineno-2-166" id="__codelineno-2-166" name="__codelineno-2-166"></a>            <span class="k">return</span> <span class="n">content1</span> <span class="o">!=</span> <span class="n">content2</span>
</code></pre></div>
<h3 id="4-context-optimization-for-parallel-execution">4. Context Optimization for Parallel Execution<a class="headerlink" href="#4-context-optimization-for-parallel-execution" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">class</span> <span class="nc">ParallelContextOptimizer</span><span class="p">:</span>
<a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="sd">"""Optimize context for parallel execution efficiency"""</span>
<a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>
<a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">compression_strategies</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>            <span class="n">AgentType</span><span class="o">.</span><span class="n">DESIGN</span><span class="p">:</span> <span class="n">DesignContextCompressor</span><span class="p">(),</span>
<a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>            <span class="n">AgentType</span><span class="o">.</span><span class="n">QA</span><span class="p">:</span> <span class="n">QAContextCompressor</span><span class="p">(),</span>
<a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a>            <span class="n">AgentType</span><span class="o">.</span><span class="n">CODE</span><span class="p">:</span> <span class="n">CodeContextCompressor</span><span class="p">(),</span>
<a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a>            <span class="n">AgentType</span><span class="o">.</span><span class="n">DATA</span><span class="p">:</span> <span class="n">DataContextCompressor</span><span class="p">()</span>
<a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a>        <span class="p">}</span>
<a href="#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">deduplication_engine</span> <span class="o">=</span> <span class="n">ContextDeduplicationEngine</span><span class="p">()</span>
<a href="#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prefetch_predictor</span> <span class="o">=</span> <span class="n">ContextPrefetchPredictor</span><span class="p">()</span>
<a href="#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>
<a href="#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">optimize_for_parallel</span><span class="p">(</span>
<a href="#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a>        <span class="bp">self</span><span class="p">,</span> 
<a href="#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">IsolatedCycleContext</span><span class="p">,</span>
<a href="#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a>        <span class="n">parallel_group</span><span class="p">:</span> <span class="n">ParallelGroup</span>
<a href="#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OptimizationResult</span><span class="p">:</span>
<a href="#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">        </span><span class="sd">"""Optimize context for parallel execution"""</span>
<a href="#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a>
<a href="#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a>        <span class="n">optimizations</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a>
<a href="#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a>        <span class="c1"># Cross-cycle deduplication</span>
<a href="#__codelineno-3-24" id="__codelineno-3-24" name="__codelineno-3-24"></a>        <span class="n">dedup_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">deduplication_engine</span><span class="o">.</span><span class="n">deduplicate_across_cycles</span><span class="p">(</span>
<a href="#__codelineno-3-25" id="__codelineno-3-25" name="__codelineno-3-25"></a>            <span class="n">context</span><span class="p">,</span> <span class="n">parallel_group</span>
<a href="#__codelineno-3-26" id="__codelineno-3-26" name="__codelineno-3-26"></a>        <span class="p">)</span>
<a href="#__codelineno-3-27" id="__codelineno-3-27" name="__codelineno-3-27"></a>        <span class="k">if</span> <span class="n">dedup_result</span><span class="o">.</span><span class="n">tokens_saved</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a href="#__codelineno-3-28" id="__codelineno-3-28" name="__codelineno-3-28"></a>            <span class="n">optimizations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dedup_result</span><span class="p">)</span>
<a href="#__codelineno-3-29" id="__codelineno-3-29" name="__codelineno-3-29"></a>
<a href="#__codelineno-3-30" id="__codelineno-3-30" name="__codelineno-3-30"></a>        <span class="c1"># Predictive prefetching</span>
<a href="#__codelineno-3-31" id="__codelineno-3-31" name="__codelineno-3-31"></a>        <span class="n">prefetch_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefetch_predictor</span><span class="o">.</span><span class="n">prefetch_likely_context</span><span class="p">(</span>
<a href="#__codelineno-3-32" id="__codelineno-3-32" name="__codelineno-3-32"></a>            <span class="n">context</span><span class="p">,</span> <span class="n">parallel_group</span>
<a href="#__codelineno-3-33" id="__codelineno-3-33" name="__codelineno-3-33"></a>        <span class="p">)</span>
<a href="#__codelineno-3-34" id="__codelineno-3-34" name="__codelineno-3-34"></a>        <span class="k">if</span> <span class="n">prefetch_result</span><span class="o">.</span><span class="n">items_prefetched</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a href="#__codelineno-3-35" id="__codelineno-3-35" name="__codelineno-3-35"></a>            <span class="n">optimizations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prefetch_result</span><span class="p">)</span>
<a href="#__codelineno-3-36" id="__codelineno-3-36" name="__codelineno-3-36"></a>
<a href="#__codelineno-3-37" id="__codelineno-3-37" name="__codelineno-3-37"></a>        <span class="c1"># Compression optimization</span>
<a href="#__codelineno-3-38" id="__codelineno-3-38" name="__codelineno-3-38"></a>        <span class="n">compression_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_compression</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">parallel_group</span><span class="p">)</span>
<a href="#__codelineno-3-39" id="__codelineno-3-39" name="__codelineno-3-39"></a>        <span class="k">if</span> <span class="n">compression_result</span><span class="o">.</span><span class="n">compression_improvement</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a href="#__codelineno-3-40" id="__codelineno-3-40" name="__codelineno-3-40"></a>            <span class="n">optimizations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compression_result</span><span class="p">)</span>
<a href="#__codelineno-3-41" id="__codelineno-3-41" name="__codelineno-3-41"></a>
<a href="#__codelineno-3-42" id="__codelineno-3-42" name="__codelineno-3-42"></a>        <span class="k">return</span> <span class="n">OptimizationResult</span><span class="p">(</span>
<a href="#__codelineno-3-43" id="__codelineno-3-43" name="__codelineno-3-43"></a>            <span class="n">context_id</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">cycle_id</span><span class="p">,</span>
<a href="#__codelineno-3-44" id="__codelineno-3-44" name="__codelineno-3-44"></a>            <span class="n">optimizations</span><span class="o">=</span><span class="n">optimizations</span><span class="p">,</span>
<a href="#__codelineno-3-45" id="__codelineno-3-45" name="__codelineno-3-45"></a>            <span class="n">total_tokens_saved</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">tokens_saved</span> <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">optimizations</span><span class="p">),</span>
<a href="#__codelineno-3-46" id="__codelineno-3-46" name="__codelineno-3-46"></a>            <span class="n">performance_improvement</span><span class="o">=</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_performance_improvement</span><span class="p">(</span>
<a href="#__codelineno-3-47" id="__codelineno-3-47" name="__codelineno-3-47"></a>                <span class="n">optimizations</span>
<a href="#__codelineno-3-48" id="__codelineno-3-48" name="__codelineno-3-48"></a>            <span class="p">)</span>
<a href="#__codelineno-3-49" id="__codelineno-3-49" name="__codelineno-3-49"></a>        <span class="p">)</span>
<a href="#__codelineno-3-50" id="__codelineno-3-50" name="__codelineno-3-50"></a>
<a href="#__codelineno-3-51" id="__codelineno-3-51" name="__codelineno-3-51"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_optimize_compression</span><span class="p">(</span>
<a href="#__codelineno-3-52" id="__codelineno-3-52" name="__codelineno-3-52"></a>        <span class="bp">self</span><span class="p">,</span> 
<a href="#__codelineno-3-53" id="__codelineno-3-53" name="__codelineno-3-53"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">IsolatedCycleContext</span><span class="p">,</span>
<a href="#__codelineno-3-54" id="__codelineno-3-54" name="__codelineno-3-54"></a>        <span class="n">parallel_group</span><span class="p">:</span> <span class="n">ParallelGroup</span>
<a href="#__codelineno-3-55" id="__codelineno-3-55" name="__codelineno-3-55"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CompressionOptimization</span><span class="p">:</span>
<a href="#__codelineno-3-56" id="__codelineno-3-56" name="__codelineno-3-56"></a><span class="w">        </span><span class="sd">"""Optimize compression strategies for parallel context"""</span>
<a href="#__codelineno-3-57" id="__codelineno-3-57" name="__codelineno-3-57"></a>
<a href="#__codelineno-3-58" id="__codelineno-3-58" name="__codelineno-3-58"></a>        <span class="c1"># Analyze context usage patterns across the group</span>
<a href="#__codelineno-3-59" id="__codelineno-3-59" name="__codelineno-3-59"></a>        <span class="n">usage_patterns</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_group_usage_patterns</span><span class="p">(</span><span class="n">parallel_group</span><span class="p">)</span>
<a href="#__codelineno-3-60" id="__codelineno-3-60" name="__codelineno-3-60"></a>
<a href="#__codelineno-3-61" id="__codelineno-3-61" name="__codelineno-3-61"></a>        <span class="c1"># Identify commonly used context elements</span>
<a href="#__codelineno-3-62" id="__codelineno-3-62" name="__codelineno-3-62"></a>        <span class="n">common_elements</span> <span class="o">=</span> <span class="n">usage_patterns</span><span class="o">.</span><span class="n">common_elements</span>
<a href="#__codelineno-3-63" id="__codelineno-3-63" name="__codelineno-3-63"></a>        <span class="n">unique_elements</span> <span class="o">=</span> <span class="n">usage_patterns</span><span class="o">.</span><span class="n">unique_elements</span>
<a href="#__codelineno-3-64" id="__codelineno-3-64" name="__codelineno-3-64"></a>
<a href="#__codelineno-3-65" id="__codelineno-3-65" name="__codelineno-3-65"></a>        <span class="n">compression_improvements</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-3-66" id="__codelineno-3-66" name="__codelineno-3-66"></a>
<a href="#__codelineno-3-67" id="__codelineno-3-67" name="__codelineno-3-67"></a>        <span class="c1"># Apply aggressive compression to unique elements</span>
<a href="#__codelineno-3-68" id="__codelineno-3-68" name="__codelineno-3-68"></a>        <span class="k">for</span> <span class="n">element_key</span> <span class="ow">in</span> <span class="n">unique_elements</span><span class="p">:</span>
<a href="#__codelineno-3-69" id="__codelineno-3-69" name="__codelineno-3-69"></a>            <span class="k">if</span> <span class="n">element_key</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">core_files</span><span class="p">:</span>
<a href="#__codelineno-3-70" id="__codelineno-3-70" name="__codelineno-3-70"></a>                <span class="n">current_compression</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_current_compression_ratio</span><span class="p">(</span><span class="n">element_key</span><span class="p">)</span>
<a href="#__codelineno-3-71" id="__codelineno-3-71" name="__codelineno-3-71"></a>
<a href="#__codelineno-3-72" id="__codelineno-3-72" name="__codelineno-3-72"></a>                <span class="c1"># Try more aggressive compression</span>
<a href="#__codelineno-3-73" id="__codelineno-3-73" name="__codelineno-3-73"></a>                <span class="n">aggressive_compression</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_aggressive_compression</span><span class="p">(</span>
<a href="#__codelineno-3-74" id="__codelineno-3-74" name="__codelineno-3-74"></a>                    <span class="n">element_key</span><span class="p">,</span> <span class="n">context</span>
<a href="#__codelineno-3-75" id="__codelineno-3-75" name="__codelineno-3-75"></a>                <span class="p">)</span>
<a href="#__codelineno-3-76" id="__codelineno-3-76" name="__codelineno-3-76"></a>
<a href="#__codelineno-3-77" id="__codelineno-3-77" name="__codelineno-3-77"></a>                <span class="k">if</span> <span class="n">aggressive_compression</span><span class="o">.</span><span class="n">ratio</span> <span class="o">&gt;</span> <span class="n">current_compression</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">:</span>
<a href="#__codelineno-3-78" id="__codelineno-3-78" name="__codelineno-3-78"></a>                    <span class="n">compression_improvements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aggressive_compression</span><span class="p">)</span>
<a href="#__codelineno-3-79" id="__codelineno-3-79" name="__codelineno-3-79"></a>
<a href="#__codelineno-3-80" id="__codelineno-3-80" name="__codelineno-3-80"></a>        <span class="c1"># Apply lighter compression to common elements (for sharing)</span>
<a href="#__codelineno-3-81" id="__codelineno-3-81" name="__codelineno-3-81"></a>        <span class="k">for</span> <span class="n">element_key</span> <span class="ow">in</span> <span class="n">common_elements</span><span class="p">:</span>
<a href="#__codelineno-3-82" id="__codelineno-3-82" name="__codelineno-3-82"></a>            <span class="k">if</span> <span class="n">element_key</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">core_files</span><span class="p">:</span>
<a href="#__codelineno-3-83" id="__codelineno-3-83" name="__codelineno-3-83"></a>                <span class="n">sharing_optimized</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_for_sharing</span><span class="p">(</span>
<a href="#__codelineno-3-84" id="__codelineno-3-84" name="__codelineno-3-84"></a>                    <span class="n">element_key</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">parallel_group</span>
<a href="#__codelineno-3-85" id="__codelineno-3-85" name="__codelineno-3-85"></a>                <span class="p">)</span>
<a href="#__codelineno-3-86" id="__codelineno-3-86" name="__codelineno-3-86"></a>                <span class="n">compression_improvements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sharing_optimized</span><span class="p">)</span>
<a href="#__codelineno-3-87" id="__codelineno-3-87" name="__codelineno-3-87"></a>
<a href="#__codelineno-3-88" id="__codelineno-3-88" name="__codelineno-3-88"></a>        <span class="k">return</span> <span class="n">CompressionOptimization</span><span class="p">(</span>
<a href="#__codelineno-3-89" id="__codelineno-3-89" name="__codelineno-3-89"></a>            <span class="n">improvements</span><span class="o">=</span><span class="n">compression_improvements</span><span class="p">,</span>
<a href="#__codelineno-3-90" id="__codelineno-3-90" name="__codelineno-3-90"></a>            <span class="n">compression_improvement</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span>
<a href="#__codelineno-3-91" id="__codelineno-3-91" name="__codelineno-3-91"></a>                <span class="n">imp</span><span class="o">.</span><span class="n">improvement_ratio</span> <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="n">compression_improvements</span>
<a href="#__codelineno-3-92" id="__codelineno-3-92" name="__codelineno-3-92"></a>            <span class="p">),</span>
<a href="#__codelineno-3-93" id="__codelineno-3-93" name="__codelineno-3-93"></a>            <span class="n">tokens_saved</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">imp</span><span class="o">.</span><span class="n">tokens_saved</span> <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="n">compression_improvements</span><span class="p">)</span>
<a href="#__codelineno-3-94" id="__codelineno-3-94" name="__codelineno-3-94"></a>        <span class="p">)</span>
<a href="#__codelineno-3-95" id="__codelineno-3-95" name="__codelineno-3-95"></a>
<a href="#__codelineno-3-96" id="__codelineno-3-96" name="__codelineno-3-96"></a><span class="k">class</span> <span class="nc">ContextDeduplicationEngine</span><span class="p">:</span>
<a href="#__codelineno-3-97" id="__codelineno-3-97" name="__codelineno-3-97"></a><span class="w">    </span><span class="sd">"""Deduplicate context across parallel cycles"""</span>
<a href="#__codelineno-3-98" id="__codelineno-3-98" name="__codelineno-3-98"></a>
<a href="#__codelineno-3-99" id="__codelineno-3-99" name="__codelineno-3-99"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">deduplicate_across_cycles</span><span class="p">(</span>
<a href="#__codelineno-3-100" id="__codelineno-3-100" name="__codelineno-3-100"></a>        <span class="bp">self</span><span class="p">,</span> 
<a href="#__codelineno-3-101" id="__codelineno-3-101" name="__codelineno-3-101"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">IsolatedCycleContext</span><span class="p">,</span>
<a href="#__codelineno-3-102" id="__codelineno-3-102" name="__codelineno-3-102"></a>        <span class="n">parallel_group</span><span class="p">:</span> <span class="n">ParallelGroup</span>
<a href="#__codelineno-3-103" id="__codelineno-3-103" name="__codelineno-3-103"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DeduplicationResult</span><span class="p">:</span>
<a href="#__codelineno-3-104" id="__codelineno-3-104" name="__codelineno-3-104"></a><span class="w">        </span><span class="sd">"""Remove duplicate context across parallel cycles"""</span>
<a href="#__codelineno-3-105" id="__codelineno-3-105" name="__codelineno-3-105"></a>
<a href="#__codelineno-3-106" id="__codelineno-3-106" name="__codelineno-3-106"></a>        <span class="c1"># Analyze context overlap across cycles</span>
<a href="#__codelineno-3-107" id="__codelineno-3-107" name="__codelineno-3-107"></a>        <span class="n">overlap_analysis</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_context_overlap</span><span class="p">(</span>
<a href="#__codelineno-3-108" id="__codelineno-3-108" name="__codelineno-3-108"></a>            <span class="n">context</span><span class="p">,</span> <span class="n">parallel_group</span>
<a href="#__codelineno-3-109" id="__codelineno-3-109" name="__codelineno-3-109"></a>        <span class="p">)</span>
<a href="#__codelineno-3-110" id="__codelineno-3-110" name="__codelineno-3-110"></a>
<a href="#__codelineno-3-111" id="__codelineno-3-111" name="__codelineno-3-111"></a>        <span class="n">deduplication_actions</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-3-112" id="__codelineno-3-112" name="__codelineno-3-112"></a>
<a href="#__codelineno-3-113" id="__codelineno-3-113" name="__codelineno-3-113"></a>        <span class="c1"># Identify exact duplicates</span>
<a href="#__codelineno-3-114" id="__codelineno-3-114" name="__codelineno-3-114"></a>        <span class="n">exact_duplicates</span> <span class="o">=</span> <span class="n">overlap_analysis</span><span class="o">.</span><span class="n">exact_matches</span>
<a href="#__codelineno-3-115" id="__codelineno-3-115" name="__codelineno-3-115"></a>        <span class="k">for</span> <span class="n">duplicate_key</span><span class="p">,</span> <span class="n">cycles</span> <span class="ow">in</span> <span class="n">exact_duplicates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a href="#__codelineno-3-116" id="__codelineno-3-116" name="__codelineno-3-116"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cycles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Duplicate across multiple cycles</span>
<a href="#__codelineno-3-117" id="__codelineno-3-117" name="__codelineno-3-117"></a>                <span class="c1"># Move to shared context</span>
<a href="#__codelineno-3-118" id="__codelineno-3-118" name="__codelineno-3-118"></a>                <span class="n">sharing_action</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_move_to_shared_context</span><span class="p">(</span>
<a href="#__codelineno-3-119" id="__codelineno-3-119" name="__codelineno-3-119"></a>                    <span class="n">duplicate_key</span><span class="p">,</span> <span class="n">cycles</span><span class="p">,</span> <span class="n">context</span>
<a href="#__codelineno-3-120" id="__codelineno-3-120" name="__codelineno-3-120"></a>                <span class="p">)</span>
<a href="#__codelineno-3-121" id="__codelineno-3-121" name="__codelineno-3-121"></a>                <span class="n">deduplication_actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sharing_action</span><span class="p">)</span>
<a href="#__codelineno-3-122" id="__codelineno-3-122" name="__codelineno-3-122"></a>
<a href="#__codelineno-3-123" id="__codelineno-3-123" name="__codelineno-3-123"></a>        <span class="c1"># Identify near-duplicates that can be merged</span>
<a href="#__codelineno-3-124" id="__codelineno-3-124" name="__codelineno-3-124"></a>        <span class="n">near_duplicates</span> <span class="o">=</span> <span class="n">overlap_analysis</span><span class="o">.</span><span class="n">near_matches</span>
<a href="#__codelineno-3-125" id="__codelineno-3-125" name="__codelineno-3-125"></a>        <span class="k">for</span> <span class="n">near_duplicate_group</span> <span class="ow">in</span> <span class="n">near_duplicates</span><span class="p">:</span>
<a href="#__codelineno-3-126" id="__codelineno-3-126" name="__codelineno-3-126"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">near_duplicate_group</span><span class="o">.</span><span class="n">keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a href="#__codelineno-3-127" id="__codelineno-3-127" name="__codelineno-3-127"></a>                <span class="n">merge_action</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_near_duplicates</span><span class="p">(</span>
<a href="#__codelineno-3-128" id="__codelineno-3-128" name="__codelineno-3-128"></a>                    <span class="n">near_duplicate_group</span><span class="p">,</span> <span class="n">context</span>
<a href="#__codelineno-3-129" id="__codelineno-3-129" name="__codelineno-3-129"></a>                <span class="p">)</span>
<a href="#__codelineno-3-130" id="__codelineno-3-130" name="__codelineno-3-130"></a>                <span class="n">deduplication_actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">merge_action</span><span class="p">)</span>
<a href="#__codelineno-3-131" id="__codelineno-3-131" name="__codelineno-3-131"></a>
<a href="#__codelineno-3-132" id="__codelineno-3-132" name="__codelineno-3-132"></a>        <span class="k">return</span> <span class="n">DeduplicationResult</span><span class="p">(</span>
<a href="#__codelineno-3-133" id="__codelineno-3-133" name="__codelineno-3-133"></a>            <span class="n">actions</span><span class="o">=</span><span class="n">deduplication_actions</span><span class="p">,</span>
<a href="#__codelineno-3-134" id="__codelineno-3-134" name="__codelineno-3-134"></a>            <span class="n">tokens_saved</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">tokens_saved</span> <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">deduplication_actions</span><span class="p">),</span>
<a href="#__codelineno-3-135" id="__codelineno-3-135" name="__codelineno-3-135"></a>            <span class="n">files_deduplicated</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">deduplication_actions</span><span class="p">)</span>
<a href="#__codelineno-3-136" id="__codelineno-3-136" name="__codelineno-3-136"></a>        <span class="p">)</span>
<a href="#__codelineno-3-137" id="__codelineno-3-137" name="__codelineno-3-137"></a>
<a href="#__codelineno-3-138" id="__codelineno-3-138" name="__codelineno-3-138"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_move_to_shared_context</span><span class="p">(</span>
<a href="#__codelineno-3-139" id="__codelineno-3-139" name="__codelineno-3-139"></a>        <span class="bp">self</span><span class="p">,</span>
<a href="#__codelineno-3-140" id="__codelineno-3-140" name="__codelineno-3-140"></a>        <span class="n">context_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a href="#__codelineno-3-141" id="__codelineno-3-141" name="__codelineno-3-141"></a>        <span class="n">involved_cycles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a href="#__codelineno-3-142" id="__codelineno-3-142" name="__codelineno-3-142"></a>        <span class="n">source_context</span><span class="p">:</span> <span class="n">IsolatedCycleContext</span>
<a href="#__codelineno-3-143" id="__codelineno-3-143" name="__codelineno-3-143"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DeduplicationAction</span><span class="p">:</span>
<a href="#__codelineno-3-144" id="__codelineno-3-144" name="__codelineno-3-144"></a><span class="w">        </span><span class="sd">"""Move duplicate context to shared space"""</span>
<a href="#__codelineno-3-145" id="__codelineno-3-145" name="__codelineno-3-145"></a>
<a href="#__codelineno-3-146" id="__codelineno-3-146" name="__codelineno-3-146"></a>        <span class="c1"># Create shared context entry</span>
<a href="#__codelineno-3-147" id="__codelineno-3-147" name="__codelineno-3-147"></a>        <span class="n">shared_entry</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_shared_entry</span><span class="p">(</span><span class="n">context_key</span><span class="p">,</span> <span class="n">source_context</span><span class="p">)</span>
<a href="#__codelineno-3-148" id="__codelineno-3-148" name="__codelineno-3-148"></a>
<a href="#__codelineno-3-149" id="__codelineno-3-149" name="__codelineno-3-149"></a>        <span class="c1"># Calculate token savings</span>
<a href="#__codelineno-3-150" id="__codelineno-3-150" name="__codelineno-3-150"></a>        <span class="n">individual_cost</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_individual_context_cost</span><span class="p">(</span><span class="n">context_key</span><span class="p">)</span>
<a href="#__codelineno-3-151" id="__codelineno-3-151" name="__codelineno-3-151"></a>        <span class="n">shared_cost</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_shared_context_cost</span><span class="p">(</span><span class="n">context_key</span><span class="p">)</span>
<a href="#__codelineno-3-152" id="__codelineno-3-152" name="__codelineno-3-152"></a>        <span class="n">tokens_saved</span> <span class="o">=</span> <span class="p">(</span><span class="n">individual_cost</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">involved_cycles</span><span class="p">))</span> <span class="o">-</span> <span class="n">shared_cost</span>
<a href="#__codelineno-3-153" id="__codelineno-3-153" name="__codelineno-3-153"></a>
<a href="#__codelineno-3-154" id="__codelineno-3-154" name="__codelineno-3-154"></a>        <span class="k">return</span> <span class="n">DeduplicationAction</span><span class="p">(</span>
<a href="#__codelineno-3-155" id="__codelineno-3-155" name="__codelineno-3-155"></a>            <span class="nb">type</span><span class="o">=</span><span class="n">DeduplicationType</span><span class="o">.</span><span class="n">MOVE_TO_SHARED</span><span class="p">,</span>
<a href="#__codelineno-3-156" id="__codelineno-3-156" name="__codelineno-3-156"></a>            <span class="n">context_key</span><span class="o">=</span><span class="n">context_key</span><span class="p">,</span>
<a href="#__codelineno-3-157" id="__codelineno-3-157" name="__codelineno-3-157"></a>            <span class="n">involved_cycles</span><span class="o">=</span><span class="n">involved_cycles</span><span class="p">,</span>
<a href="#__codelineno-3-158" id="__codelineno-3-158" name="__codelineno-3-158"></a>            <span class="n">shared_entry_id</span><span class="o">=</span><span class="n">shared_entry</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a href="#__codelineno-3-159" id="__codelineno-3-159" name="__codelineno-3-159"></a>            <span class="n">tokens_saved</span><span class="o">=</span><span class="n">tokens_saved</span>
<a href="#__codelineno-3-160" id="__codelineno-3-160" name="__codelineno-3-160"></a>        <span class="p">)</span>
<a href="#__codelineno-3-161" id="__codelineno-3-161" name="__codelineno-3-161"></a>
<a href="#__codelineno-3-162" id="__codelineno-3-162" name="__codelineno-3-162"></a><span class="k">class</span> <span class="nc">ContextPrefetchPredictor</span><span class="p">:</span>
<a href="#__codelineno-3-163" id="__codelineno-3-163" name="__codelineno-3-163"></a><span class="w">    </span><span class="sd">"""Predict and prefetch likely needed context"""</span>
<a href="#__codelineno-3-164" id="__codelineno-3-164" name="__codelineno-3-164"></a>
<a href="#__codelineno-3-165" id="__codelineno-3-165" name="__codelineno-3-165"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-3-166" id="__codelineno-3-166" name="__codelineno-3-166"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">usage_patterns</span> <span class="o">=</span> <span class="n">ContextUsagePatterns</span><span class="p">()</span>
<a href="#__codelineno-3-167" id="__codelineno-3-167" name="__codelineno-3-167"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dependency_analyzer</span> <span class="o">=</span> <span class="n">ContextDependencyAnalyzer</span><span class="p">()</span>
<a href="#__codelineno-3-168" id="__codelineno-3-168" name="__codelineno-3-168"></a>
<a href="#__codelineno-3-169" id="__codelineno-3-169" name="__codelineno-3-169"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">prefetch_likely_context</span><span class="p">(</span>
<a href="#__codelineno-3-170" id="__codelineno-3-170" name="__codelineno-3-170"></a>        <span class="bp">self</span><span class="p">,</span>
<a href="#__codelineno-3-171" id="__codelineno-3-171" name="__codelineno-3-171"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">IsolatedCycleContext</span><span class="p">,</span>
<a href="#__codelineno-3-172" id="__codelineno-3-172" name="__codelineno-3-172"></a>        <span class="n">parallel_group</span><span class="p">:</span> <span class="n">ParallelGroup</span>
<a href="#__codelineno-3-173" id="__codelineno-3-173" name="__codelineno-3-173"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PrefetchResult</span><span class="p">:</span>
<a href="#__codelineno-3-174" id="__codelineno-3-174" name="__codelineno-3-174"></a><span class="w">        </span><span class="sd">"""Prefetch context likely to be needed"""</span>
<a href="#__codelineno-3-175" id="__codelineno-3-175" name="__codelineno-3-175"></a>
<a href="#__codelineno-3-176" id="__codelineno-3-176" name="__codelineno-3-176"></a>        <span class="c1"># Analyze current context usage</span>
<a href="#__codelineno-3-177" id="__codelineno-3-177" name="__codelineno-3-177"></a>        <span class="n">current_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">core_files</span><span class="p">)</span>
<a href="#__codelineno-3-178" id="__codelineno-3-178" name="__codelineno-3-178"></a>
<a href="#__codelineno-3-179" id="__codelineno-3-179" name="__codelineno-3-179"></a>        <span class="c1"># Predict likely next files based on patterns</span>
<a href="#__codelineno-3-180" id="__codelineno-3-180" name="__codelineno-3-180"></a>        <span class="n">likely_files</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_likely_files</span><span class="p">(</span>
<a href="#__codelineno-3-181" id="__codelineno-3-181" name="__codelineno-3-181"></a>            <span class="n">current_files</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">story_id</span>
<a href="#__codelineno-3-182" id="__codelineno-3-182" name="__codelineno-3-182"></a>        <span class="p">)</span>
<a href="#__codelineno-3-183" id="__codelineno-3-183" name="__codelineno-3-183"></a>
<a href="#__codelineno-3-184" id="__codelineno-3-184" name="__codelineno-3-184"></a>        <span class="c1"># Analyze dependencies that might be needed</span>
<a href="#__codelineno-3-185" id="__codelineno-3-185" name="__codelineno-3-185"></a>        <span class="n">dependency_predictions</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependency_analyzer</span><span class="o">.</span><span class="n">predict_dependencies</span><span class="p">(</span>
<a href="#__codelineno-3-186" id="__codelineno-3-186" name="__codelineno-3-186"></a>            <span class="n">current_files</span><span class="p">,</span> <span class="n">context</span>
<a href="#__codelineno-3-187" id="__codelineno-3-187" name="__codelineno-3-187"></a>        <span class="p">)</span>
<a href="#__codelineno-3-188" id="__codelineno-3-188" name="__codelineno-3-188"></a>
<a href="#__codelineno-3-189" id="__codelineno-3-189" name="__codelineno-3-189"></a>        <span class="c1"># Combine predictions</span>
<a href="#__codelineno-3-190" id="__codelineno-3-190" name="__codelineno-3-190"></a>        <span class="n">prefetch_candidates</span> <span class="o">=</span> <span class="p">(</span><span class="n">likely_files</span> <span class="o">|</span> <span class="n">dependency_predictions</span><span class="o">.</span><span class="n">likely_dependencies</span><span class="p">)</span>
<a href="#__codelineno-3-191" id="__codelineno-3-191" name="__codelineno-3-191"></a>
<a href="#__codelineno-3-192" id="__codelineno-3-192" name="__codelineno-3-192"></a>        <span class="c1"># Filter candidates that fit in remaining token budget</span>
<a href="#__codelineno-3-193" id="__codelineno-3-193" name="__codelineno-3-193"></a>        <span class="n">remaining_budget</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">token_budget</span> <span class="o">-</span> <span class="n">context</span><span class="o">.</span><span class="n">tokens_used</span>
<a href="#__codelineno-3-194" id="__codelineno-3-194" name="__codelineno-3-194"></a>        <span class="n">feasible_candidates</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_token_budget</span><span class="p">(</span>
<a href="#__codelineno-3-195" id="__codelineno-3-195" name="__codelineno-3-195"></a>            <span class="n">prefetch_candidates</span><span class="p">,</span> <span class="n">remaining_budget</span> <span class="o">*</span> <span class="mf">0.2</span>  <span class="c1"># Use max 20% for prefetch</span>
<a href="#__codelineno-3-196" id="__codelineno-3-196" name="__codelineno-3-196"></a>        <span class="p">)</span>
<a href="#__codelineno-3-197" id="__codelineno-3-197" name="__codelineno-3-197"></a>
<a href="#__codelineno-3-198" id="__codelineno-3-198" name="__codelineno-3-198"></a>        <span class="c1"># Execute prefetching</span>
<a href="#__codelineno-3-199" id="__codelineno-3-199" name="__codelineno-3-199"></a>        <span class="n">prefetch_actions</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-3-200" id="__codelineno-3-200" name="__codelineno-3-200"></a>        <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">feasible_candidates</span><span class="p">:</span>
<a href="#__codelineno-3-201" id="__codelineno-3-201" name="__codelineno-3-201"></a>            <span class="n">action</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_context_item</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a href="#__codelineno-3-202" id="__codelineno-3-202" name="__codelineno-3-202"></a>            <span class="n">prefetch_actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
<a href="#__codelineno-3-203" id="__codelineno-3-203" name="__codelineno-3-203"></a>
<a href="#__codelineno-3-204" id="__codelineno-3-204" name="__codelineno-3-204"></a>        <span class="k">return</span> <span class="n">PrefetchResult</span><span class="p">(</span>
<a href="#__codelineno-3-205" id="__codelineno-3-205" name="__codelineno-3-205"></a>            <span class="n">items_prefetched</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">prefetch_actions</span><span class="p">),</span>
<a href="#__codelineno-3-206" id="__codelineno-3-206" name="__codelineno-3-206"></a>            <span class="n">tokens_used</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">tokens_used</span> <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">prefetch_actions</span><span class="p">),</span>
<a href="#__codelineno-3-207" id="__codelineno-3-207" name="__codelineno-3-207"></a>            <span class="n">predicted_time_savings</span><span class="o">=</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_time_savings</span><span class="p">(</span><span class="n">prefetch_actions</span><span class="p">)</span>
<a href="#__codelineno-3-208" id="__codelineno-3-208" name="__codelineno-3-208"></a>        <span class="p">)</span>
</code></pre></div>
<h3 id="5-performance-monitoring-and-metrics">5. Performance Monitoring and Metrics<a class="headerlink" href="#5-performance-monitoring-and-metrics" title="Permanent link">¶</a></h3>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">class</span> <span class="nc">ParallelContextMetrics</span><span class="p">:</span>
<a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">    </span><span class="sd">"""Monitor context performance in parallel execution"""</span>
<a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>
<a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_collector</span> <span class="o">=</span> <span class="n">ContextMetricsCollector</span><span class="p">()</span>
<a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">performance_analyzer</span> <span class="o">=</span> <span class="n">ContextPerformanceAnalyzer</span><span class="p">()</span>
<a href="#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>
<a href="#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">collect_parallel_metrics</span><span class="p">(</span>
<a href="#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a>        <span class="bp">self</span><span class="p">,</span> 
<a href="#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a>        <span class="n">parallel_group</span><span class="p">:</span> <span class="n">ParallelGroup</span>
<a href="#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ParallelContextMetrics</span><span class="p">:</span>
<a href="#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">        </span><span class="sd">"""Collect comprehensive context metrics for parallel group"""</span>
<a href="#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a>
<a href="#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a>        <span class="n">metrics</span> <span class="o">=</span> <span class="n">ParallelContextMetrics</span><span class="p">(</span>
<a href="#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a>            <span class="n">group_id</span><span class="o">=</span><span class="n">parallel_group</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a href="#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a>            <span class="n">timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
<a href="#__codelineno-4-17" id="__codelineno-4-17" name="__codelineno-4-17"></a>
<a href="#__codelineno-4-18" id="__codelineno-4-18" name="__codelineno-4-18"></a>            <span class="c1"># Token usage metrics</span>
<a href="#__codelineno-4-19" id="__codelineno-4-19" name="__codelineno-4-19"></a>            <span class="n">total_tokens_allocated</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span>
<a href="#__codelineno-4-20" id="__codelineno-4-20" name="__codelineno-4-20"></a>                <span class="n">ctx</span><span class="o">.</span><span class="n">token_budget</span> <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="n">parallel_group</span><span class="o">.</span><span class="n">contexts</span>
<a href="#__codelineno-4-21" id="__codelineno-4-21" name="__codelineno-4-21"></a>            <span class="p">),</span>
<a href="#__codelineno-4-22" id="__codelineno-4-22" name="__codelineno-4-22"></a>            <span class="n">total_tokens_used</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span>
<a href="#__codelineno-4-23" id="__codelineno-4-23" name="__codelineno-4-23"></a>                <span class="n">ctx</span><span class="o">.</span><span class="n">tokens_used</span> <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="n">parallel_group</span><span class="o">.</span><span class="n">contexts</span>
<a href="#__codelineno-4-24" id="__codelineno-4-24" name="__codelineno-4-24"></a>            <span class="p">),</span>
<a href="#__codelineno-4-25" id="__codelineno-4-25" name="__codelineno-4-25"></a>            <span class="n">token_efficiency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_calculate_token_efficiency</span><span class="p">(</span><span class="n">parallel_group</span><span class="p">),</span>
<a href="#__codelineno-4-26" id="__codelineno-4-26" name="__codelineno-4-26"></a>
<a href="#__codelineno-4-27" id="__codelineno-4-27" name="__codelineno-4-27"></a>            <span class="c1"># Context sharing metrics</span>
<a href="#__codelineno-4-28" id="__codelineno-4-28" name="__codelineno-4-28"></a>            <span class="n">shared_contexts_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">parallel_group</span><span class="o">.</span><span class="n">shared_contexts</span><span class="p">),</span>
<a href="#__codelineno-4-29" id="__codelineno-4-29" name="__codelineno-4-29"></a>            <span class="n">sharing_efficiency</span><span class="o">=</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_sharing_efficiency</span><span class="p">(</span><span class="n">parallel_group</span><span class="p">),</span>
<a href="#__codelineno-4-30" id="__codelineno-4-30" name="__codelineno-4-30"></a>            <span class="n">deduplication_savings</span><span class="o">=</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_deduplication_savings</span><span class="p">(</span><span class="n">parallel_group</span><span class="p">),</span>
<a href="#__codelineno-4-31" id="__codelineno-4-31" name="__codelineno-4-31"></a>
<a href="#__codelineno-4-32" id="__codelineno-4-32" name="__codelineno-4-32"></a>            <span class="c1"># Performance metrics</span>
<a href="#__codelineno-4-33" id="__codelineno-4-33" name="__codelineno-4-33"></a>            <span class="n">average_context_prep_time</span><span class="o">=</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_avg_prep_time</span><span class="p">(</span><span class="n">parallel_group</span><span class="p">),</span>
<a href="#__codelineno-4-34" id="__codelineno-4-34" name="__codelineno-4-34"></a>            <span class="n">context_cache_hit_rate</span><span class="o">=</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_cache_hit_rate</span><span class="p">(</span><span class="n">parallel_group</span><span class="p">),</span>
<a href="#__codelineno-4-35" id="__codelineno-4-35" name="__codelineno-4-35"></a>            <span class="n">compression_efficiency</span><span class="o">=</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_compression_efficiency</span><span class="p">(</span><span class="n">parallel_group</span><span class="p">),</span>
<a href="#__codelineno-4-36" id="__codelineno-4-36" name="__codelineno-4-36"></a>
<a href="#__codelineno-4-37" id="__codelineno-4-37" name="__codelineno-4-37"></a>            <span class="c1"># Quality metrics</span>
<a href="#__codelineno-4-38" id="__codelineno-4-38" name="__codelineno-4-38"></a>            <span class="n">context_relevance_score</span><span class="o">=</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_relevance_score</span><span class="p">(</span><span class="n">parallel_group</span><span class="p">),</span>
<a href="#__codelineno-4-39" id="__codelineno-4-39" name="__codelineno-4-39"></a>            <span class="n">context_completeness_score</span><span class="o">=</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_completeness_score</span><span class="p">(</span><span class="n">parallel_group</span><span class="p">),</span>
<a href="#__codelineno-4-40" id="__codelineno-4-40" name="__codelineno-4-40"></a>            <span class="n">cross_cycle_consistency</span><span class="o">=</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_consistency_score</span><span class="p">(</span><span class="n">parallel_group</span><span class="p">)</span>
<a href="#__codelineno-4-41" id="__codelineno-4-41" name="__codelineno-4-41"></a>        <span class="p">)</span>
<a href="#__codelineno-4-42" id="__codelineno-4-42" name="__codelineno-4-42"></a>
<a href="#__codelineno-4-43" id="__codelineno-4-43" name="__codelineno-4-43"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_collector</span><span class="o">.</span><span class="n">store_metrics</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
<a href="#__codelineno-4-44" id="__codelineno-4-44" name="__codelineno-4-44"></a>        <span class="k">return</span> <span class="n">metrics</span>
<a href="#__codelineno-4-45" id="__codelineno-4-45" name="__codelineno-4-45"></a>
<a href="#__codelineno-4-46" id="__codelineno-4-46" name="__codelineno-4-46"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">_calculate_token_efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parallel_group</span><span class="p">:</span> <span class="n">ParallelGroup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a href="#__codelineno-4-47" id="__codelineno-4-47" name="__codelineno-4-47"></a><span class="w">        </span><span class="sd">"""Calculate overall token usage efficiency"""</span>
<a href="#__codelineno-4-48" id="__codelineno-4-48" name="__codelineno-4-48"></a>        <span class="n">total_allocated</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">token_budget</span> <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="n">parallel_group</span><span class="o">.</span><span class="n">contexts</span><span class="p">)</span>
<a href="#__codelineno-4-49" id="__codelineno-4-49" name="__codelineno-4-49"></a>        <span class="n">total_used</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">tokens_used</span> <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="n">parallel_group</span><span class="o">.</span><span class="n">contexts</span><span class="p">)</span>
<a href="#__codelineno-4-50" id="__codelineno-4-50" name="__codelineno-4-50"></a>
<a href="#__codelineno-4-51" id="__codelineno-4-51" name="__codelineno-4-51"></a>        <span class="k">if</span> <span class="n">total_allocated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a href="#__codelineno-4-52" id="__codelineno-4-52" name="__codelineno-4-52"></a>            <span class="k">return</span> <span class="mf">0.0</span>
<a href="#__codelineno-4-53" id="__codelineno-4-53" name="__codelineno-4-53"></a>
<a href="#__codelineno-4-54" id="__codelineno-4-54" name="__codelineno-4-54"></a>        <span class="k">return</span> <span class="n">total_used</span> <span class="o">/</span> <span class="n">total_allocated</span>
<a href="#__codelineno-4-55" id="__codelineno-4-55" name="__codelineno-4-55"></a>
<a href="#__codelineno-4-56" id="__codelineno-4-56" name="__codelineno-4-56"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">analyze_performance_bottlenecks</span><span class="p">(</span>
<a href="#__codelineno-4-57" id="__codelineno-4-57" name="__codelineno-4-57"></a>        <span class="bp">self</span><span class="p">,</span> 
<a href="#__codelineno-4-58" id="__codelineno-4-58" name="__codelineno-4-58"></a>        <span class="n">parallel_group</span><span class="p">:</span> <span class="n">ParallelGroup</span>
<a href="#__codelineno-4-59" id="__codelineno-4-59" name="__codelineno-4-59"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">PerformanceBottleneck</span><span class="p">]:</span>
<a href="#__codelineno-4-60" id="__codelineno-4-60" name="__codelineno-4-60"></a><span class="w">        </span><span class="sd">"""Identify context-related performance bottlenecks"""</span>
<a href="#__codelineno-4-61" id="__codelineno-4-61" name="__codelineno-4-61"></a>
<a href="#__codelineno-4-62" id="__codelineno-4-62" name="__codelineno-4-62"></a>        <span class="n">bottlenecks</span> <span class="o">=</span> <span class="p">[]</span>
<a href="#__codelineno-4-63" id="__codelineno-4-63" name="__codelineno-4-63"></a>
<a href="#__codelineno-4-64" id="__codelineno-4-64" name="__codelineno-4-64"></a>        <span class="c1"># Token allocation bottlenecks</span>
<a href="#__codelineno-4-65" id="__codelineno-4-65" name="__codelineno-4-65"></a>        <span class="n">token_analysis</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_token_bottlenecks</span><span class="p">(</span><span class="n">parallel_group</span><span class="p">)</span>
<a href="#__codelineno-4-66" id="__codelineno-4-66" name="__codelineno-4-66"></a>        <span class="n">bottlenecks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">token_analysis</span><span class="o">.</span><span class="n">bottlenecks</span><span class="p">)</span>
<a href="#__codelineno-4-67" id="__codelineno-4-67" name="__codelineno-4-67"></a>
<a href="#__codelineno-4-68" id="__codelineno-4-68" name="__codelineno-4-68"></a>        <span class="c1"># Context preparation bottlenecks</span>
<a href="#__codelineno-4-69" id="__codelineno-4-69" name="__codelineno-4-69"></a>        <span class="n">prep_analysis</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_preparation_bottlenecks</span><span class="p">(</span><span class="n">parallel_group</span><span class="p">)</span>
<a href="#__codelineno-4-70" id="__codelineno-4-70" name="__codelineno-4-70"></a>        <span class="n">bottlenecks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">prep_analysis</span><span class="o">.</span><span class="n">bottlenecks</span><span class="p">)</span>
<a href="#__codelineno-4-71" id="__codelineno-4-71" name="__codelineno-4-71"></a>
<a href="#__codelineno-4-72" id="__codelineno-4-72" name="__codelineno-4-72"></a>        <span class="c1"># Sharing inefficiencies</span>
<a href="#__codelineno-4-73" id="__codelineno-4-73" name="__codelineno-4-73"></a>        <span class="n">sharing_analysis</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_sharing_bottlenecks</span><span class="p">(</span><span class="n">parallel_group</span><span class="p">)</span>
<a href="#__codelineno-4-74" id="__codelineno-4-74" name="__codelineno-4-74"></a>        <span class="n">bottlenecks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sharing_analysis</span><span class="o">.</span><span class="n">bottlenecks</span><span class="p">)</span>
<a href="#__codelineno-4-75" id="__codelineno-4-75" name="__codelineno-4-75"></a>
<a href="#__codelineno-4-76" id="__codelineno-4-76" name="__codelineno-4-76"></a>        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">bottlenecks</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">impact_score</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<p>This comprehensive parallel context integration system ensures that the Context Management System works optimally with parallel TDD execution, providing intelligent token distribution, efficient context sharing, and sophisticated optimization while maintaining context quality and agent performance.</p>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.path", "navigation.top", "search.highlight", "search.suggest", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
<script src="../../js/mermaid-zoom.js"></script>
</body>
</html>