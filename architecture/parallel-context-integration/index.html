<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Complete AI agent orchestration framework with Discord integration, Test-Driven Development, and human-in-the-loop control for automated software development"><meta name=author content="AI Agent Workflow Team"><link href=https://jmontp.github.io/agent-workflow/architecture/parallel-context-integration/ rel=canonical><link href=../parallel-tdd-testing-strategy/ rel=prev><link href=../parallel-agent-pool-management/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.14"><title>ğŸ”— Context Integration - AI Agent TDD-Scrum Workflow - Complete Guide</title><link rel=stylesheet href=../../assets/stylesheets/main.342714a4.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><style>:root{.md-tag{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22M5.5%207A1.5%201.5%200%200%201%204%205.5%201.5%201.5%200%200%201%205.5%204%201.5%201.5%200%200%201%207%205.5%201.5%201.5%200%200%201%205.5%207m15.91%204.58-9-9C12.05%202.22%2011.55%202%2011%202H4c-1.11%200-2%20.89-2%202v7c0%20.55.22%201.05.59%201.41l8.99%209c.37.36.87.59%201.42.59s1.05-.23%201.41-.59l7-7c.37-.36.59-.86.59-1.41%200-.56-.23-1.06-.59-1.42%22/%3E%3C/svg%3E');}.md-tag.md-tag--html{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22m12%2017.56%204.07-1.13.55-6.1H9.38L9.2%208.3h7.6l.2-1.99H7l.56%206.01h6.89l-.23%202.58-2.22.6-2.22-.6-.14-1.66h-2l.29%203.19zM4.07%203h15.86L18.5%2019.2%2012%2021l-6.5-1.8z%22/%3E%3C/svg%3E');}.md-tag.md-tag--js{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22M3%203h18v18H3zm4.73%2015.04c.4.85%201.19%201.55%202.54%201.55%201.5%200%202.53-.8%202.53-2.55v-5.78h-1.7V17c0%20.86-.35%201.08-.9%201.08-.58%200-.82-.4-1.09-.87zm5.98-.18c.5.98%201.51%201.73%203.09%201.73%201.6%200%202.8-.83%202.8-2.36%200-1.41-.81-2.04-2.25-2.66l-.42-.18c-.73-.31-1.04-.52-1.04-1.02%200-.41.31-.73.81-.73.48%200%20.8.21%201.09.73l1.31-.87c-.55-.96-1.33-1.33-2.4-1.33-1.51%200-2.48.96-2.48%202.23%200%201.38.81%202.03%202.03%202.55l.42.18c.78.34%201.24.55%201.24%201.13%200%20.48-.45.83-1.15.83-.83%200-1.31-.43-1.67-1.03z%22/%3E%3C/svg%3E');}.md-tag.md-tag--css{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22m5%203-.65%203.34h13.59L17.5%208.5H3.92l-.66%203.33h13.59l-.76%203.81-5.48%201.81-4.75-1.81.33-1.64H2.85l-.79%204%207.85%203%209.05-3%201.2-6.03.24-1.21L21.94%203z%22/%3E%3C/svg%3E');}.md-tag.md-tag--python{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22M19.14%207.5A2.86%202.86%200%200%201%2022%2010.36v3.78A2.86%202.86%200%200%201%2019.14%2017H12c0%20.39.32.96.71.96H17v1.68a2.86%202.86%200%200%201-2.86%202.86H9.86A2.86%202.86%200%200%201%207%2019.64v-3.75a2.85%202.85%200%200%201%202.86-2.85h5.25a2.85%202.85%200%200%200%202.85-2.86V7.5zm-4.28%2011.79c-.4%200-.72.3-.72.89s.32.71.72.71a.71.71%200%200%200%20.71-.71c0-.59-.32-.89-.71-.89m-10-1.79A2.86%202.86%200%200%201%202%2014.64v-3.78A2.86%202.86%200%200%201%204.86%208H12c0-.39-.32-.96-.71-.96H7V5.36A2.86%202.86%200%200%201%209.86%202.5h4.28A2.86%202.86%200%200%201%2017%205.36v3.75a2.85%202.85%200%200%201-2.86%202.85H8.89a2.85%202.85%200%200%200-2.85%202.86v2.68zM9.14%205.71c.4%200%20.72-.3.72-.89s-.32-.71-.72-.71c-.39%200-.71.12-.71.71s.32.89.71.89%22/%3E%3C/svg%3E');}}</style><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style><link rel=stylesheet href=../../stylesheets/extra.css><link rel=stylesheet href=../../stylesheets/enhanced-navigation.css><link rel=stylesheet href=../../stylesheets/color-schemes.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config",""),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script> <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head><body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=black><input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off><input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off><label class=md-overlay for=__drawer></label><div data-md-component=skip><a href=#parallel-context-management-integration class=md-skip> Skip to content </a></div><div data-md-component=announce></div><div data-md-color-scheme=default data-md-component=outdated hidden></div><header class="md-header md-header--shadow md-header--lifted" data-md-component=header><nav class="md-header__inner md-grid" aria-label=Header><a href=../.. title="AI Agent TDD-Scrum Workflow - Complete Guide" class="md-header__button md-logo" aria-label="AI Agent TDD-Scrum Workflow - Complete Guide" data-md-component=logo><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m19 2-5 4.5v11l5-4.5zM6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5"/></svg></a><label class="md-header__button md-icon" for=__drawer><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg></label><div class=md-header__title data-md-component=header-title><div class=md-header__ellipsis><div class=md-header__topic><span class=md-ellipsis> AI Agent TDD-Scrum Workflow - Complete Guide </span></div><div class=md-header__topic data-md-component=header-topic><span class=md-ellipsis> ğŸ”— Context Integration </span></div></div></div><label class="md-header__button md-icon" for=__search><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg></label><div class=md-search data-md-component=search role=dialog><label class=md-search__overlay for=__search></label><div class=md-search__inner role=search><form class=md-search__form name=search><input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required><label class="md-search__icon md-icon" for=__search><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M15.41 16.58 10.83 12l4.58-4.59L14 6l-6 6 6 6z"/></svg></label><nav class=md-search__options aria-label=Search><a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg></a><button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></nav><div class=md-search__suggest data-md-component=search-suggest></div></form><div class=md-search__output><div class=md-search__scrollwrap tabindex=0 data-md-scrollfix><div class=md-search-result data-md-component=search-result><div class=md-search-result__meta> Initializing search </div><ol class=md-search-result__list role=presentation></ol></div></div></div></div></div><div class=md-header__source><a href=https://github.com/jmontp/agent-workflow title="Go to repository" class=md-source data-md-component=source><div class="md-source__icon md-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"/></svg></div><div class=md-source__repository> jmontp/agent-workflow </div></a></div></nav><nav class=md-tabs aria-label=Tabs data-md-component=tabs><div class=md-grid><ul class=md-tabs__list><li class=md-tabs__item><a href=../.. class=md-tabs__link> ğŸ  Home </a></li><li class=md-tabs__item><a href=../../getting-started/ class=md-tabs__link> âš¡ Getting Started </a></li><li class=md-tabs__item><a href=../../user-guide/ class=md-tabs__link> ğŸ“š User Guide </a></li><li class=md-tabs__item><a href=../../concepts/ class=md-tabs__link> ğŸ¯ Core Concepts </a></li><li class="md-tabs__item md-tabs__item--active"><a href=../ class=md-tabs__link> ğŸ—ï¸ Architecture </a></li><li class=md-tabs__item><a href=../../advanced/ class=md-tabs__link> ğŸ”¬ Advanced Topics </a></li><li class=md-tabs__item><a href=../../planning/ class=md-tabs__link> ğŸ¨ Planning & Design </a></li><li class=md-tabs__item><a href=../../development/ class=md-tabs__link> ğŸ› ï¸ Development </a></li><li class=md-tabs__item><a href=../../deployment/ class=md-tabs__link> ğŸš€ Deployment </a></li><li class=md-tabs__item><a href=../../templates/ class=md-tabs__link> ğŸ“‹ Templates </a></li><li class=md-tabs__item><a href=../../theme-integration-guide/ class=md-tabs__link> ğŸ¨ Theme Integration </a></li><li class=md-tabs__item><a href=../../archive/compliance/ class=md-tabs__link> ğŸ“ Archive </a></li></ul></div></nav></header><div class=md-container data-md-component=container><main class=md-main data-md-component=main><div class="md-main__inner md-grid"><div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation><div class=md-sidebar__scrollwrap><div class=md-sidebar__inner><nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0><label class=md-nav__title for=__drawer><a href=../.. title="AI Agent TDD-Scrum Workflow - Complete Guide" class="md-nav__button md-logo" aria-label="AI Agent TDD-Scrum Workflow - Complete Guide" data-md-component=logo><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m19 2-5 4.5v11l5-4.5zM6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5"/></svg></a> AI Agent TDD-Scrum Workflow - Complete Guide </label><div class=md-nav__source><a href=https://github.com/jmontp/agent-workflow title="Go to repository" class=md-source data-md-component=source><div class="md-source__icon md-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"/></svg></div><div class=md-source__repository> jmontp/agent-workflow </div></a></div><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../.. class=md-nav__link><span class=md-ellipsis> ğŸ  Home </span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../../getting-started/ class=md-nav__link><span class=md-ellipsis> âš¡ Getting Started </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../../user-guide/ class=md-nav__link><span class=md-ellipsis> ğŸ“š User Guide </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../../concepts/ class=md-nav__link><span class=md-ellipsis> ğŸ¯ Core Concepts </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5 checked><div class="md-nav__link md-nav__container"><a href=../ class="md-nav__link "><span class=md-ellipsis> ğŸ—ï¸ Architecture </span></a><label class="md-nav__link " for=__nav_5 id=__nav_5_label tabindex><span class="md-nav__icon md-icon"></span></label></div><nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=true><label class=md-nav__title for=__nav_5><span class="md-nav__icon md-icon"></span> ğŸ—ï¸ Architecture </label><ul class=md-nav__list data-md-scrollfix><li class="md-nav__item md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_2><label class=md-nav__link for=__nav_5_2 id=__nav_5_2_label tabindex><span class=md-ellipsis> ğŸ  System Design </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_2_label aria-expanded=false><label class=md-nav__title for=__nav_5_2><span class="md-nav__icon md-icon"></span> ğŸ  System Design </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../system-overview/ class=md-nav__link><span class=md-ellipsis> ğŸ—ï¸ System Overview </span></a></li><li class=md-nav__item><a href=../component-architecture/ class=md-nav__link><span class=md-ellipsis> ğŸ”§ Component Architecture </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5_3><label class=md-nav__link for=__nav_5_3 id=__nav_5_3_label tabindex><span class=md-ellipsis> ğŸ§  Context Management </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_3_label aria-expanded=false><label class=md-nav__title for=__nav_5_3><span class="md-nav__icon md-icon"></span> ğŸ§  Context Management </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../context-management-system/ class=md-nav__link><span class=md-ellipsis> ğŸ“Š Context System </span></a></li><li class=md-nav__item><a href=../context-api-specification/ class=md-nav__link><span class=md-ellipsis> ğŸ”Œ Context API Specification </span></a></li><li class=md-nav__item><a href=../context-algorithms/ class=md-nav__link><span class=md-ellipsis> âš™ï¸ Context Algorithms </span></a></li><li class=md-nav__item><a href=../context-evaluation-framework/ class=md-nav__link><span class=md-ellipsis> ğŸ“‹ Context Evaluation Framework </span></a></li><li class=md-nav__item><a href=../context-implementation-plan/ class=md-nav__link><span class=md-ellipsis> ğŸ› ï¸ Context Implementation Plan </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_4 checked><label class=md-nav__link for=__nav_5_4 id=__nav_5_4_label tabindex><span class=md-ellipsis> ğŸ”„ Parallel TDD System </span><span class="md-nav__icon md-icon"></span></label><nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_4_label aria-expanded=true><label class=md-nav__title for=__nav_5_4><span class="md-nav__icon md-icon"></span> ğŸ”„ Parallel TDD System </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../parallel-tdd-architecture/ class=md-nav__link><span class=md-ellipsis> ğŸ“ Design Overview </span></a></li><li class=md-nav__item><a href=../parallel-tdd-technical-specification/ class=md-nav__link><span class=md-ellipsis> ğŸ”§ Technical Specification </span></a></li><li class=md-nav__item><a href=../parallel-tdd-implementation-strategy/ class=md-nav__link><span class=md-ellipsis> ğŸ“‹ Implementation Strategy </span></a></li><li class=md-nav__item><a href=../parallel-tdd-comprehensive-implementation-plan/ class=md-nav__link><span class=md-ellipsis> ğŸ“Š Comprehensive Plan </span></a></li><li class=md-nav__item><a href=../parallel-tdd-testing-strategy/ class=md-nav__link><span class=md-ellipsis> ğŸ§ª Testing Strategy </span></a></li><li class="md-nav__item md-nav__item--active"><input class="md-nav__toggle md-toggle" type=checkbox id=__toc><label class="md-nav__link md-nav__link--active" for=__toc><span class=md-ellipsis> ğŸ”— Context Integration </span><span class="md-nav__icon md-icon"></span></label><a href=./ class="md-nav__link md-nav__link--active"><span class=md-ellipsis> ğŸ”— Context Integration </span></a><nav class="md-nav md-nav--secondary" aria-label="On this page"><label class=md-nav__title for=__toc><span class="md-nav__icon md-icon"></span> On this page </label><ul class=md-nav__list data-md-component=toc data-md-scrollfix><li class=md-nav__item><a href=#executive-summary class=md-nav__link><span class=md-ellipsis> Executive Summary </span></a></li><li class=md-nav__item><a href=#parallel-context-architecture class=md-nav__link><span class=md-ellipsis> Parallel Context Architecture </span></a><nav class=md-nav aria-label="Parallel Context Architecture"><ul class=md-nav__list><li class=md-nav__item><a href=#1-multi-context-coordination class=md-nav__link><span class=md-ellipsis> 1. Multi-Context Coordination </span></a></li><li class=md-nav__item><a href=#2-token-budget-management-for-parallel-execution class=md-nav__link><span class=md-ellipsis> 2. Token Budget Management for Parallel Execution </span></a></li><li class=md-nav__item><a href=#3-context-sharing-and-coordination class=md-nav__link><span class=md-ellipsis> 3. Context Sharing and Coordination </span></a></li><li class=md-nav__item><a href=#4-context-optimization-for-parallel-execution class=md-nav__link><span class=md-ellipsis> 4. Context Optimization for Parallel Execution </span></a></li><li class=md-nav__item><a href=#5-performance-monitoring-and-metrics class=md-nav__link><span class=md-ellipsis> 5. Performance Monitoring and Metrics </span></a></li></ul></nav></li></ul></nav></li><li class=md-nav__item><a href=../parallel-agent-pool-management/ class=md-nav__link><span class=md-ellipsis> ğŸ¤– Agent Pool Management </span></a></li><li class=md-nav__item><a href=../parallel-conflict-algorithms/ class=md-nav__link><span class=md-ellipsis> âš”ï¸ Conflict Resolution </span></a></li></ul></nav></li></ul></nav></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../../advanced/ class=md-nav__link><span class=md-ellipsis> ğŸ”¬ Advanced Topics </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../../planning/ class=md-nav__link><span class=md-ellipsis> ğŸ¨ Planning & Design </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../../development/ class=md-nav__link><span class=md-ellipsis> ğŸ› ï¸ Development </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../../deployment/ class=md-nav__link><span class=md-ellipsis> ğŸš€ Deployment </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../../templates/ class=md-nav__link><span class=md-ellipsis> ğŸ“‹ Templates </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../../theme-integration-guide/ class=md-nav__link><span class=md-ellipsis> ğŸ¨ Theme Integration </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../../archive/compliance/ class=md-nav__link><span class=md-ellipsis> ğŸ“ Archive </span><span class="md-nav__icon md-icon"></span></a></li></ul></nav></div></div></div><div class=md-content data-md-component=content><article class="md-content__inner md-typeset"><a href=https://github.com/jmontp/agent-workflow/edit/master/docs/architecture/parallel-context-integration.md title="Edit this page" class="md-content__button md-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg></a><a href=https://github.com/jmontp/agent-workflow/raw/master/docs/architecture/parallel-context-integration.md title="View source of this page" class="md-content__button md-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg></a><h1 id=parallel-context-management-integration>Parallel Context Management Integration<a class=headerlink href=#parallel-context-management-integration title="Permanent link">&para;</a></h1><h2 id=executive-summary>Executive Summary<a class=headerlink href=#executive-summary title="Permanent link">&para;</a></h2><p>This document specifies the integration of the Context Management System (CMS) with parallel TDD execution. The system provides intelligent context isolation, optimized token distribution, and sophisticated context sharing mechanisms that enable efficient parallel development while maintaining context quality and relevance.</p><h2 id=parallel-context-architecture>Parallel Context Architecture<a class=headerlink href=#parallel-context-architecture title="Permanent link">&para;</a></h2><h3 id=1-multi-context-coordination>1. Multi-Context Coordination<a class=headerlink href=#1-multi-context-coordination title="Permanent link">&para;</a></h3><div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1></a><a href=#__codelineno-0-1><span class=linenos data-linenos="  1 "></span></a><span class=k>class</span><span class=w> </span><span class=nc>ParallelContextManager</span><span class=p>:</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2></a><a href=#__codelineno-0-2><span class=linenos data-linenos="  2 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Central coordinator for context across parallel TDD cycles&quot;&quot;&quot;</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3></a><a href=#__codelineno-0-3><span class=linenos data-linenos="  3 "></span></a>    
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4></a><a href=#__codelineno-0-4><span class=linenos data-linenos="  4 "></span></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>base_context_manager</span><span class=p>:</span> <span class=n>ContextManager</span><span class=p>):</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5></a><a href=#__codelineno-0-5><span class=linenos data-linenos="  5 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>base_context</span> <span class=o>=</span> <span class=n>base_context_manager</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6></a><a href=#__codelineno-0-6><span class=linenos data-linenos="  6 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>isolated_contexts</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>IsolatedCycleContext</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7></a><a href=#__codelineno-0-7><span class=linenos data-linenos="  7 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>shared_knowledge_base</span> <span class=o>=</span> <span class=n>SharedKnowledgeBase</span><span class=p>()</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8></a><a href=#__codelineno-0-8><span class=linenos data-linenos="  8 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>token_budget_manager</span> <span class=o>=</span> <span class=n>ParallelTokenBudgetManager</span><span class=p>()</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9></a><a href=#__codelineno-0-9><span class=linenos data-linenos="  9 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>context_optimizer</span> <span class=o>=</span> <span class=n>ParallelContextOptimizer</span><span class=p>()</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10></a><a href=#__codelineno-0-10><span class=linenos data-linenos=" 10 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>dependency_tracker</span> <span class=o>=</span> <span class=n>ContextDependencyTracker</span><span class=p>()</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11></a><a href=#__codelineno-0-11><span class=linenos data-linenos=" 11 "></span></a>        
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12></a><a href=#__codelineno-0-12><span class=linenos data-linenos=" 12 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>create_cycle_context</span><span class=p>(</span>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13></a><a href=#__codelineno-0-13><span class=linenos data-linenos=" 13 "></span></a>        <span class=bp>self</span><span class=p>,</span> 
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14></a><a href=#__codelineno-0-14><span class=linenos data-linenos=" 14 "></span></a>        <span class=n>cycle_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> 
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15></a><a href=#__codelineno-0-15><span class=linenos data-linenos=" 15 "></span></a>        <span class=n>story</span><span class=p>:</span> <span class=n>Story</span><span class=p>,</span>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16></a><a href=#__codelineno-0-16><span class=linenos data-linenos=" 16 "></span></a>        <span class=n>parallel_group</span><span class=p>:</span> <span class=n>ParallelGroup</span>
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17></a><a href=#__codelineno-0-17><span class=linenos data-linenos=" 17 "></span></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>IsolatedCycleContext</span><span class=p>:</span>
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18></a><a href=#__codelineno-0-18><span class=linenos data-linenos=" 18 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Create optimally isolated context for a TDD cycle&quot;&quot;&quot;</span>
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19></a><a href=#__codelineno-0-19><span class=linenos data-linenos=" 19 "></span></a>        
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20></a><a href=#__codelineno-0-20><span class=linenos data-linenos=" 20 "></span></a>        <span class=c1># Calculate optimal token allocation</span>
</span><span id=__span-0-21><a id=__codelineno-0-21 name=__codelineno-0-21></a><a href=#__codelineno-0-21><span class=linenos data-linenos=" 21 "></span></a>        <span class=n>token_allocation</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>token_budget_manager</span><span class=o>.</span><span class=n>allocate_for_cycle</span><span class=p>(</span>
</span><span id=__span-0-22><a id=__codelineno-0-22 name=__codelineno-0-22></a><a href=#__codelineno-0-22><span class=linenos data-linenos=" 22 "></span></a>            <span class=n>cycle_id</span><span class=p>,</span> <span class=n>parallel_group</span>
</span><span id=__span-0-23><a id=__codelineno-0-23 name=__codelineno-0-23></a><a href=#__codelineno-0-23><span class=linenos data-linenos=" 23 "></span></a>        <span class=p>)</span>
</span><span id=__span-0-24><a id=__codelineno-0-24 name=__codelineno-0-24></a><a href=#__codelineno-0-24><span class=linenos data-linenos=" 24 "></span></a>        
</span><span id=__span-0-25><a id=__codelineno-0-25 name=__codelineno-0-25></a><a href=#__codelineno-0-25><span class=linenos data-linenos=" 25 "></span></a>        <span class=c1># Determine context scope based on story analysis</span>
</span><span id=__span-0-26><a id=__codelineno-0-26 name=__codelineno-0-26></a><a href=#__codelineno-0-26><span class=linenos data-linenos=" 26 "></span></a>        <span class=n>context_scope</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_analyze_context_scope</span><span class=p>(</span><span class=n>story</span><span class=p>,</span> <span class=n>parallel_group</span><span class=p>)</span>
</span><span id=__span-0-27><a id=__codelineno-0-27 name=__codelineno-0-27></a><a href=#__codelineno-0-27><span class=linenos data-linenos=" 27 "></span></a>        
</span><span id=__span-0-28><a id=__codelineno-0-28 name=__codelineno-0-28></a><a href=#__codelineno-0-28><span class=linenos data-linenos=" 28 "></span></a>        <span class=c1># Create isolated context</span>
</span><span id=__span-0-29><a id=__codelineno-0-29 name=__codelineno-0-29></a><a href=#__codelineno-0-29><span class=linenos data-linenos=" 29 "></span></a>        <span class=n>context</span> <span class=o>=</span> <span class=n>IsolatedCycleContext</span><span class=p>(</span>
</span><span id=__span-0-30><a id=__codelineno-0-30 name=__codelineno-0-30></a><a href=#__codelineno-0-30><span class=linenos data-linenos=" 30 "></span></a>            <span class=n>cycle_id</span><span class=o>=</span><span class=n>cycle_id</span><span class=p>,</span>
</span><span id=__span-0-31><a id=__codelineno-0-31 name=__codelineno-0-31></a><a href=#__codelineno-0-31><span class=linenos data-linenos=" 31 "></span></a>            <span class=n>story_id</span><span class=o>=</span><span class=n>story</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-0-32><a id=__codelineno-0-32 name=__codelineno-0-32></a><a href=#__codelineno-0-32><span class=linenos data-linenos=" 32 "></span></a>            <span class=n>token_budget</span><span class=o>=</span><span class=n>token_allocation</span><span class=p>,</span>
</span><span id=__span-0-33><a id=__codelineno-0-33 name=__codelineno-0-33></a><a href=#__codelineno-0-33><span class=linenos data-linenos=" 33 "></span></a>            <span class=n>scope</span><span class=o>=</span><span class=n>context_scope</span><span class=p>,</span>
</span><span id=__span-0-34><a id=__codelineno-0-34 name=__codelineno-0-34></a><a href=#__codelineno-0-34><span class=linenos data-linenos=" 34 "></span></a>            <span class=n>shared_knowledge</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>shared_knowledge_base</span><span class=o>.</span><span class=n>get_readonly_view</span><span class=p>()</span>
</span><span id=__span-0-35><a id=__codelineno-0-35 name=__codelineno-0-35></a><a href=#__codelineno-0-35><span class=linenos data-linenos=" 35 "></span></a>        <span class=p>)</span>
</span><span id=__span-0-36><a id=__codelineno-0-36 name=__codelineno-0-36></a><a href=#__codelineno-0-36><span class=linenos data-linenos=" 36 "></span></a>        
</span><span id=__span-0-37><a id=__codelineno-0-37 name=__codelineno-0-37></a><a href=#__codelineno-0-37><span class=linenos data-linenos=" 37 "></span></a>        <span class=c1># Populate with story-specific context</span>
</span><span id=__span-0-38><a id=__codelineno-0-38 name=__codelineno-0-38></a><a href=#__codelineno-0-38><span class=linenos data-linenos=" 38 "></span></a>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_populate_story_context</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>story</span><span class=p>)</span>
</span><span id=__span-0-39><a id=__codelineno-0-39 name=__codelineno-0-39></a><a href=#__codelineno-0-39><span class=linenos data-linenos=" 39 "></span></a>        
</span><span id=__span-0-40><a id=__codelineno-0-40 name=__codelineno-0-40></a><a href=#__codelineno-0-40><span class=linenos data-linenos=" 40 "></span></a>        <span class=c1># Apply parallel-specific optimizations</span>
</span><span id=__span-0-41><a id=__codelineno-0-41 name=__codelineno-0-41></a><a href=#__codelineno-0-41><span class=linenos data-linenos=" 41 "></span></a>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>context_optimizer</span><span class=o>.</span><span class=n>optimize_for_parallel</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>parallel_group</span><span class=p>)</span>
</span><span id=__span-0-42><a id=__codelineno-0-42 name=__codelineno-0-42></a><a href=#__codelineno-0-42><span class=linenos data-linenos=" 42 "></span></a>        
</span><span id=__span-0-43><a id=__codelineno-0-43 name=__codelineno-0-43></a><a href=#__codelineno-0-43><span class=linenos data-linenos=" 43 "></span></a>        <span class=c1># Set up dependency tracking</span>
</span><span id=__span-0-44><a id=__codelineno-0-44 name=__codelineno-0-44></a><a href=#__codelineno-0-44><span class=linenos data-linenos=" 44 "></span></a>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>dependency_tracker</span><span class=o>.</span><span class=n>track_context_dependencies</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>parallel_group</span><span class=p>)</span>
</span><span id=__span-0-45><a id=__codelineno-0-45 name=__codelineno-0-45></a><a href=#__codelineno-0-45><span class=linenos data-linenos=" 45 "></span></a>        
</span><span id=__span-0-46><a id=__codelineno-0-46 name=__codelineno-0-46></a><a href=#__codelineno-0-46><span class=linenos data-linenos=" 46 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>isolated_contexts</span><span class=p>[</span><span class=n>cycle_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>context</span>
</span><span id=__span-0-47><a id=__codelineno-0-47 name=__codelineno-0-47></a><a href=#__codelineno-0-47><span class=linenos data-linenos=" 47 "></span></a>        <span class=k>return</span> <span class=n>context</span>
</span><span id=__span-0-48><a id=__codelineno-0-48 name=__codelineno-0-48></a><a href=#__codelineno-0-48><span class=linenos data-linenos=" 48 "></span></a>        
</span><span id=__span-0-49><a id=__codelineno-0-49 name=__codelineno-0-49></a><a href=#__codelineno-0-49><span class=linenos data-linenos=" 49 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>_analyze_context_scope</span><span class=p>(</span>
</span><span id=__span-0-50><a id=__codelineno-0-50 name=__codelineno-0-50></a><a href=#__codelineno-0-50><span class=linenos data-linenos=" 50 "></span></a>        <span class=bp>self</span><span class=p>,</span> 
</span><span id=__span-0-51><a id=__codelineno-0-51 name=__codelineno-0-51></a><a href=#__codelineno-0-51><span class=linenos data-linenos=" 51 "></span></a>        <span class=n>story</span><span class=p>:</span> <span class=n>Story</span><span class=p>,</span> 
</span><span id=__span-0-52><a id=__codelineno-0-52 name=__codelineno-0-52></a><a href=#__codelineno-0-52><span class=linenos data-linenos=" 52 "></span></a>        <span class=n>parallel_group</span><span class=p>:</span> <span class=n>ParallelGroup</span>
</span><span id=__span-0-53><a id=__codelineno-0-53 name=__codelineno-0-53></a><a href=#__codelineno-0-53><span class=linenos data-linenos=" 53 "></span></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ContextScope</span><span class=p>:</span>
</span><span id=__span-0-54><a id=__codelineno-0-54 name=__codelineno-0-54></a><a href=#__codelineno-0-54><span class=linenos data-linenos=" 54 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Analyze optimal context scope to minimize conflicts and maximize relevance&quot;&quot;&quot;</span>
</span><span id=__span-0-55><a id=__codelineno-0-55 name=__codelineno-0-55></a><a href=#__codelineno-0-55><span class=linenos data-linenos=" 55 "></span></a>        
</span><span id=__span-0-56><a id=__codelineno-0-56 name=__codelineno-0-56></a><a href=#__codelineno-0-56><span class=linenos data-linenos=" 56 "></span></a>        <span class=c1># Base scope from story requirements</span>
</span><span id=__span-0-57><a id=__codelineno-0-57 name=__codelineno-0-57></a><a href=#__codelineno-0-57><span class=linenos data-linenos=" 57 "></span></a>        <span class=n>base_files</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_story_files</span><span class=p>(</span><span class=n>story</span><span class=p>)</span>
</span><span id=__span-0-58><a id=__codelineno-0-58 name=__codelineno-0-58></a><a href=#__codelineno-0-58><span class=linenos data-linenos=" 58 "></span></a>        <span class=n>base_dependencies</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_analyze_dependencies</span><span class=p>(</span><span class=n>base_files</span><span class=p>)</span>
</span><span id=__span-0-59><a id=__codelineno-0-59 name=__codelineno-0-59></a><a href=#__codelineno-0-59><span class=linenos data-linenos=" 59 "></span></a>        
</span><span id=__span-0-60><a id=__codelineno-0-60 name=__codelineno-0-60></a><a href=#__codelineno-0-60><span class=linenos data-linenos=" 60 "></span></a>        <span class=c1># Expand scope based on parallel execution needs</span>
</span><span id=__span-0-61><a id=__codelineno-0-61 name=__codelineno-0-61></a><a href=#__codelineno-0-61><span class=linenos data-linenos=" 61 "></span></a>        <span class=n>parallel_considerations</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_analyze_parallel_scope_needs</span><span class=p>(</span>
</span><span id=__span-0-62><a id=__codelineno-0-62 name=__codelineno-0-62></a><a href=#__codelineno-0-62><span class=linenos data-linenos=" 62 "></span></a>            <span class=n>story</span><span class=p>,</span> <span class=n>parallel_group</span>
</span><span id=__span-0-63><a id=__codelineno-0-63 name=__codelineno-0-63></a><a href=#__codelineno-0-63><span class=linenos data-linenos=" 63 "></span></a>        <span class=p>)</span>
</span><span id=__span-0-64><a id=__codelineno-0-64 name=__codelineno-0-64></a><a href=#__codelineno-0-64><span class=linenos data-linenos=" 64 "></span></a>        
</span><span id=__span-0-65><a id=__codelineno-0-65 name=__codelineno-0-65></a><a href=#__codelineno-0-65><span class=linenos data-linenos=" 65 "></span></a>        <span class=c1># Calculate conflict boundaries with other cycles</span>
</span><span id=__span-0-66><a id=__codelineno-0-66 name=__codelineno-0-66></a><a href=#__codelineno-0-66><span class=linenos data-linenos=" 66 "></span></a>        <span class=n>conflict_boundaries</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_conflict_boundaries</span><span class=p>(</span>
</span><span id=__span-0-67><a id=__codelineno-0-67 name=__codelineno-0-67></a><a href=#__codelineno-0-67><span class=linenos data-linenos=" 67 "></span></a>            <span class=n>story</span><span class=p>,</span> <span class=n>parallel_group</span>
</span><span id=__span-0-68><a id=__codelineno-0-68 name=__codelineno-0-68></a><a href=#__codelineno-0-68><span class=linenos data-linenos=" 68 "></span></a>        <span class=p>)</span>
</span><span id=__span-0-69><a id=__codelineno-0-69 name=__codelineno-0-69></a><a href=#__codelineno-0-69><span class=linenos data-linenos=" 69 "></span></a>        
</span><span id=__span-0-70><a id=__codelineno-0-70 name=__codelineno-0-70></a><a href=#__codelineno-0-70><span class=linenos data-linenos=" 70 "></span></a>        <span class=c1># Optimize scope to balance completeness vs isolation</span>
</span><span id=__span-0-71><a id=__codelineno-0-71 name=__codelineno-0-71></a><a href=#__codelineno-0-71><span class=linenos data-linenos=" 71 "></span></a>        <span class=n>optimized_scope</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_optimize_context_scope</span><span class=p>(</span>
</span><span id=__span-0-72><a id=__codelineno-0-72 name=__codelineno-0-72></a><a href=#__codelineno-0-72><span class=linenos data-linenos=" 72 "></span></a>            <span class=n>base_files</span><span class=p>,</span> <span class=n>base_dependencies</span><span class=p>,</span> <span class=n>parallel_considerations</span><span class=p>,</span> <span class=n>conflict_boundaries</span>
</span><span id=__span-0-73><a id=__codelineno-0-73 name=__codelineno-0-73></a><a href=#__codelineno-0-73><span class=linenos data-linenos=" 73 "></span></a>        <span class=p>)</span>
</span><span id=__span-0-74><a id=__codelineno-0-74 name=__codelineno-0-74></a><a href=#__codelineno-0-74><span class=linenos data-linenos=" 74 "></span></a>        
</span><span id=__span-0-75><a id=__codelineno-0-75 name=__codelineno-0-75></a><a href=#__codelineno-0-75><span class=linenos data-linenos=" 75 "></span></a>        <span class=k>return</span> <span class=n>ContextScope</span><span class=p>(</span>
</span><span id=__span-0-76><a id=__codelineno-0-76 name=__codelineno-0-76></a><a href=#__codelineno-0-76><span class=linenos data-linenos=" 76 "></span></a>            <span class=n>core_files</span><span class=o>=</span><span class=n>optimized_scope</span><span class=o>.</span><span class=n>core_files</span><span class=p>,</span>
</span><span id=__span-0-77><a id=__codelineno-0-77 name=__codelineno-0-77></a><a href=#__codelineno-0-77><span class=linenos data-linenos=" 77 "></span></a>            <span class=n>dependency_files</span><span class=o>=</span><span class=n>optimized_scope</span><span class=o>.</span><span class=n>dependency_files</span><span class=p>,</span>
</span><span id=__span-0-78><a id=__codelineno-0-78 name=__codelineno-0-78></a><a href=#__codelineno-0-78><span class=linenos data-linenos=" 78 "></span></a>            <span class=n>test_files</span><span class=o>=</span><span class=n>optimized_scope</span><span class=o>.</span><span class=n>test_files</span><span class=p>,</span>
</span><span id=__span-0-79><a id=__codelineno-0-79 name=__codelineno-0-79></a><a href=#__codelineno-0-79><span class=linenos data-linenos=" 79 "></span></a>            <span class=n>documentation_files</span><span class=o>=</span><span class=n>optimized_scope</span><span class=o>.</span><span class=n>documentation_files</span><span class=p>,</span>
</span><span id=__span-0-80><a id=__codelineno-0-80 name=__codelineno-0-80></a><a href=#__codelineno-0-80><span class=linenos data-linenos=" 80 "></span></a>            <span class=n>exclusion_patterns</span><span class=o>=</span><span class=n>optimized_scope</span><span class=o>.</span><span class=n>exclusions</span><span class=p>,</span>
</span><span id=__span-0-81><a id=__codelineno-0-81 name=__codelineno-0-81></a><a href=#__codelineno-0-81><span class=linenos data-linenos=" 81 "></span></a>            <span class=n>max_file_count</span><span class=o>=</span><span class=nb>min</span><span class=p>(</span><span class=n>optimized_scope</span><span class=o>.</span><span class=n>file_count</span><span class=p>,</span> <span class=mi>200</span><span class=p>),</span>  <span class=c1># Parallel limit</span>
</span><span id=__span-0-82><a id=__codelineno-0-82 name=__codelineno-0-82></a><a href=#__codelineno-0-82><span class=linenos data-linenos=" 82 "></span></a>            <span class=n>isolation_level</span><span class=o>=</span><span class=n>optimized_scope</span><span class=o>.</span><span class=n>isolation_level</span>
</span><span id=__span-0-83><a id=__codelineno-0-83 name=__codelineno-0-83></a><a href=#__codelineno-0-83><span class=linenos data-linenos=" 83 "></span></a>        <span class=p>)</span>
</span><span id=__span-0-84><a id=__codelineno-0-84 name=__codelineno-0-84></a><a href=#__codelineno-0-84><span class=linenos data-linenos=" 84 "></span></a>        
</span><span id=__span-0-85><a id=__codelineno-0-85 name=__codelineno-0-85></a><a href=#__codelineno-0-85><span class=linenos data-linenos=" 85 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>_optimize_context_scope</span><span class=p>(</span>
</span><span id=__span-0-86><a id=__codelineno-0-86 name=__codelineno-0-86></a><a href=#__codelineno-0-86><span class=linenos data-linenos=" 86 "></span></a>        <span class=bp>self</span><span class=p>,</span>
</span><span id=__span-0-87><a id=__codelineno-0-87 name=__codelineno-0-87></a><a href=#__codelineno-0-87><span class=linenos data-linenos=" 87 "></span></a>        <span class=n>base_files</span><span class=p>:</span> <span class=n>Set</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span>
</span><span id=__span-0-88><a id=__codelineno-0-88 name=__codelineno-0-88></a><a href=#__codelineno-0-88><span class=linenos data-linenos=" 88 "></span></a>        <span class=n>dependencies</span><span class=p>:</span> <span class=n>Set</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span> 
</span><span id=__span-0-89><a id=__codelineno-0-89 name=__codelineno-0-89></a><a href=#__codelineno-0-89><span class=linenos data-linenos=" 89 "></span></a>        <span class=n>parallel_needs</span><span class=p>:</span> <span class=n>ParallelScopeAnalysis</span><span class=p>,</span>
</span><span id=__span-0-90><a id=__codelineno-0-90 name=__codelineno-0-90></a><a href=#__codelineno-0-90><span class=linenos data-linenos=" 90 "></span></a>        <span class=n>boundaries</span><span class=p>:</span> <span class=n>ConflictBoundaries</span>
</span><span id=__span-0-91><a id=__codelineno-0-91 name=__codelineno-0-91></a><a href=#__codelineno-0-91><span class=linenos data-linenos=" 91 "></span></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>OptimizedScope</span><span class=p>:</span>
</span><span id=__span-0-92><a id=__codelineno-0-92 name=__codelineno-0-92></a><a href=#__codelineno-0-92><span class=linenos data-linenos=" 92 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Optimize context scope for parallel execution&quot;&quot;&quot;</span>
</span><span id=__span-0-93><a id=__codelineno-0-93 name=__codelineno-0-93></a><a href=#__codelineno-0-93><span class=linenos data-linenos=" 93 "></span></a>        
</span><span id=__span-0-94><a id=__codelineno-0-94 name=__codelineno-0-94></a><a href=#__codelineno-0-94><span class=linenos data-linenos=" 94 "></span></a>        <span class=c1># Start with base files</span>
</span><span id=__span-0-95><a id=__codelineno-0-95 name=__codelineno-0-95></a><a href=#__codelineno-0-95><span class=linenos data-linenos=" 95 "></span></a>        <span class=n>core_files</span> <span class=o>=</span> <span class=n>base_files</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span><span id=__span-0-96><a id=__codelineno-0-96 name=__codelineno-0-96></a><a href=#__codelineno-0-96><span class=linenos data-linenos=" 96 "></span></a>        
</span><span id=__span-0-97><a id=__codelineno-0-97 name=__codelineno-0-97></a><a href=#__codelineno-0-97><span class=linenos data-linenos=" 97 "></span></a>        <span class=c1># Add critical dependencies</span>
</span><span id=__span-0-98><a id=__codelineno-0-98 name=__codelineno-0-98></a><a href=#__codelineno-0-98><span class=linenos data-linenos=" 98 "></span></a>        <span class=n>critical_deps</span> <span class=o>=</span> <span class=n>dependencies</span> <span class=o>&amp;</span> <span class=n>parallel_needs</span><span class=o>.</span><span class=n>critical_dependencies</span>
</span><span id=__span-0-99><a id=__codelineno-0-99 name=__codelineno-0-99></a><a href=#__codelineno-0-99><span class=linenos data-linenos=" 99 "></span></a>        <span class=n>core_files</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>critical_deps</span><span class=p>)</span>
</span><span id=__span-0-100><a id=__codelineno-0-100 name=__codelineno-0-100></a><a href=#__codelineno-0-100><span class=linenos data-linenos="100 "></span></a>        
</span><span id=__span-0-101><a id=__codelineno-0-101 name=__codelineno-0-101></a><a href=#__codelineno-0-101><span class=linenos data-linenos="101 "></span></a>        <span class=c1># Remove files that would cause conflicts</span>
</span><span id=__span-0-102><a id=__codelineno-0-102 name=__codelineno-0-102></a><a href=#__codelineno-0-102><span class=linenos data-linenos="102 "></span></a>        <span class=n>conflicting_files</span> <span class=o>=</span> <span class=n>core_files</span> <span class=o>&amp;</span> <span class=n>boundaries</span><span class=o>.</span><span class=n>conflicting_files</span>
</span><span id=__span-0-103><a id=__codelineno-0-103 name=__codelineno-0-103></a><a href=#__codelineno-0-103><span class=linenos data-linenos="103 "></span></a>        <span class=k>if</span> <span class=n>conflicting_files</span><span class=p>:</span>
</span><span id=__span-0-104><a id=__codelineno-0-104 name=__codelineno-0-104></a><a href=#__codelineno-0-104><span class=linenos data-linenos="104 "></span></a>            <span class=c1># Try to find alternative context for conflicting files</span>
</span><span id=__span-0-105><a id=__codelineno-0-105 name=__codelineno-0-105></a><a href=#__codelineno-0-105><span class=linenos data-linenos="105 "></span></a>            <span class=n>alternatives</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_find_alternative_context</span><span class=p>(</span><span class=n>conflicting_files</span><span class=p>)</span>
</span><span id=__span-0-106><a id=__codelineno-0-106 name=__codelineno-0-106></a><a href=#__codelineno-0-106><span class=linenos data-linenos="106 "></span></a>            <span class=n>core_files</span> <span class=o>=</span> <span class=p>(</span><span class=n>core_files</span> <span class=o>-</span> <span class=n>conflicting_files</span><span class=p>)</span> <span class=o>|</span> <span class=n>alternatives</span>
</span><span id=__span-0-107><a id=__codelineno-0-107 name=__codelineno-0-107></a><a href=#__codelineno-0-107><span class=linenos data-linenos="107 "></span></a>            
</span><span id=__span-0-108><a id=__codelineno-0-108 name=__codelineno-0-108></a><a href=#__codelineno-0-108><span class=linenos data-linenos="108 "></span></a>        <span class=c1># Add parallel-specific requirements</span>
</span><span id=__span-0-109><a id=__codelineno-0-109 name=__codelineno-0-109></a><a href=#__codelineno-0-109><span class=linenos data-linenos="109 "></span></a>        <span class=k>if</span> <span class=n>parallel_needs</span><span class=o>.</span><span class=n>requires_shared_state</span><span class=p>:</span>
</span><span id=__span-0-110><a id=__codelineno-0-110 name=__codelineno-0-110></a><a href=#__codelineno-0-110><span class=linenos data-linenos="110 "></span></a>            <span class=n>shared_state_files</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_shared_state_files</span><span class=p>(</span><span class=n>parallel_needs</span><span class=p>)</span>
</span><span id=__span-0-111><a id=__codelineno-0-111 name=__codelineno-0-111></a><a href=#__codelineno-0-111><span class=linenos data-linenos="111 "></span></a>            <span class=n>core_files</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>shared_state_files</span><span class=p>)</span>
</span><span id=__span-0-112><a id=__codelineno-0-112 name=__codelineno-0-112></a><a href=#__codelineno-0-112><span class=linenos data-linenos="112 "></span></a>            
</span><span id=__span-0-113><a id=__codelineno-0-113 name=__codelineno-0-113></a><a href=#__codelineno-0-113><span class=linenos data-linenos="113 "></span></a>        <span class=c1># Limit scope to fit token budget</span>
</span><span id=__span-0-114><a id=__codelineno-0-114 name=__codelineno-0-114></a><a href=#__codelineno-0-114><span class=linenos data-linenos="114 "></span></a>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>core_files</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>parallel_needs</span><span class=o>.</span><span class=n>max_files_for_budget</span><span class=p>:</span>
</span><span id=__span-0-115><a id=__codelineno-0-115 name=__codelineno-0-115></a><a href=#__codelineno-0-115><span class=linenos data-linenos="115 "></span></a>            <span class=n>core_files</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_prioritize_files_for_budget</span><span class=p>(</span>
</span><span id=__span-0-116><a id=__codelineno-0-116 name=__codelineno-0-116></a><a href=#__codelineno-0-116><span class=linenos data-linenos="116 "></span></a>                <span class=n>core_files</span><span class=p>,</span> <span class=n>parallel_needs</span><span class=o>.</span><span class=n>max_files_for_budget</span>
</span><span id=__span-0-117><a id=__codelineno-0-117 name=__codelineno-0-117></a><a href=#__codelineno-0-117><span class=linenos data-linenos="117 "></span></a>            <span class=p>)</span>
</span><span id=__span-0-118><a id=__codelineno-0-118 name=__codelineno-0-118></a><a href=#__codelineno-0-118><span class=linenos data-linenos="118 "></span></a>            
</span><span id=__span-0-119><a id=__codelineno-0-119 name=__codelineno-0-119></a><a href=#__codelineno-0-119><span class=linenos data-linenos="119 "></span></a>        <span class=k>return</span> <span class=n>OptimizedScope</span><span class=p>(</span>
</span><span id=__span-0-120><a id=__codelineno-0-120 name=__codelineno-0-120></a><a href=#__codelineno-0-120><span class=linenos data-linenos="120 "></span></a>            <span class=n>core_files</span><span class=o>=</span><span class=n>core_files</span><span class=p>,</span>
</span><span id=__span-0-121><a id=__codelineno-0-121 name=__codelineno-0-121></a><a href=#__codelineno-0-121><span class=linenos data-linenos="121 "></span></a>            <span class=n>dependency_files</span><span class=o>=</span><span class=n>dependencies</span> <span class=o>-</span> <span class=n>core_files</span><span class=p>,</span>
</span><span id=__span-0-122><a id=__codelineno-0-122 name=__codelineno-0-122></a><a href=#__codelineno-0-122><span class=linenos data-linenos="122 "></span></a>            <span class=n>test_files</span><span class=o>=</span><span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_test_files_for_scope</span><span class=p>(</span><span class=n>core_files</span><span class=p>),</span>
</span><span id=__span-0-123><a id=__codelineno-0-123 name=__codelineno-0-123></a><a href=#__codelineno-0-123><span class=linenos data-linenos="123 "></span></a>            <span class=n>documentation_files</span><span class=o>=</span><span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_docs_for_scope</span><span class=p>(</span><span class=n>core_files</span><span class=p>),</span>
</span><span id=__span-0-124><a id=__codelineno-0-124 name=__codelineno-0-124></a><a href=#__codelineno-0-124><span class=linenos data-linenos="124 "></span></a>            <span class=n>exclusions</span><span class=o>=</span><span class=n>boundaries</span><span class=o>.</span><span class=n>exclusion_patterns</span><span class=p>,</span>
</span><span id=__span-0-125><a id=__codelineno-0-125 name=__codelineno-0-125></a><a href=#__codelineno-0-125><span class=linenos data-linenos="125 "></span></a>            <span class=n>file_count</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>core_files</span><span class=p>),</span>
</span><span id=__span-0-126><a id=__codelineno-0-126 name=__codelineno-0-126></a><a href=#__codelineno-0-126><span class=linenos data-linenos="126 "></span></a>            <span class=n>isolation_level</span><span class=o>=</span><span class=n>parallel_needs</span><span class=o>.</span><span class=n>recommended_isolation</span>
</span><span id=__span-0-127><a id=__codelineno-0-127 name=__codelineno-0-127></a><a href=#__codelineno-0-127><span class=linenos data-linenos="127 "></span></a>        <span class=p>)</span>
</span><span id=__span-0-128><a id=__codelineno-0-128 name=__codelineno-0-128></a><a href=#__codelineno-0-128><span class=linenos data-linenos="128 "></span></a>
</span><span id=__span-0-129><a id=__codelineno-0-129 name=__codelineno-0-129></a><a href=#__codelineno-0-129><span class=linenos data-linenos="129 "></span></a><span class=k>class</span><span class=w> </span><span class=nc>IsolatedCycleContext</span><span class=p>:</span>
</span><span id=__span-0-130><a id=__codelineno-0-130 name=__codelineno-0-130></a><a href=#__codelineno-0-130><span class=linenos data-linenos="130 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Context isolated for a specific TDD cycle with parallel optimization&quot;&quot;&quot;</span>
</span><span id=__span-0-131><a id=__codelineno-0-131 name=__codelineno-0-131></a><a href=#__codelineno-0-131><span class=linenos data-linenos="131 "></span></a>    
</span><span id=__span-0-132><a id=__codelineno-0-132 name=__codelineno-0-132></a><a href=#__codelineno-0-132><span class=linenos data-linenos="132 "></span></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span>
</span><span id=__span-0-133><a id=__codelineno-0-133 name=__codelineno-0-133></a><a href=#__codelineno-0-133><span class=linenos data-linenos="133 "></span></a>        <span class=bp>self</span><span class=p>,</span> 
</span><span id=__span-0-134><a id=__codelineno-0-134 name=__codelineno-0-134></a><a href=#__codelineno-0-134><span class=linenos data-linenos="134 "></span></a>        <span class=n>cycle_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> 
</span><span id=__span-0-135><a id=__codelineno-0-135 name=__codelineno-0-135></a><a href=#__codelineno-0-135><span class=linenos data-linenos="135 "></span></a>        <span class=n>story_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span><span id=__span-0-136><a id=__codelineno-0-136 name=__codelineno-0-136></a><a href=#__codelineno-0-136><span class=linenos data-linenos="136 "></span></a>        <span class=n>token_budget</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
</span><span id=__span-0-137><a id=__codelineno-0-137 name=__codelineno-0-137></a><a href=#__codelineno-0-137><span class=linenos data-linenos="137 "></span></a>        <span class=n>scope</span><span class=p>:</span> <span class=n>ContextScope</span><span class=p>,</span>
</span><span id=__span-0-138><a id=__codelineno-0-138 name=__codelineno-0-138></a><a href=#__codelineno-0-138><span class=linenos data-linenos="138 "></span></a>        <span class=n>shared_knowledge</span><span class=p>:</span> <span class=n>ReadOnlyKnowledgeView</span>
</span><span id=__span-0-139><a id=__codelineno-0-139 name=__codelineno-0-139></a><a href=#__codelineno-0-139><span class=linenos data-linenos="139 "></span></a>    <span class=p>):</span>
</span><span id=__span-0-140><a id=__codelineno-0-140 name=__codelineno-0-140></a><a href=#__codelineno-0-140><span class=linenos data-linenos="140 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>cycle_id</span> <span class=o>=</span> <span class=n>cycle_id</span>
</span><span id=__span-0-141><a id=__codelineno-0-141 name=__codelineno-0-141></a><a href=#__codelineno-0-141><span class=linenos data-linenos="141 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>story_id</span> <span class=o>=</span> <span class=n>story_id</span>
</span><span id=__span-0-142><a id=__codelineno-0-142 name=__codelineno-0-142></a><a href=#__codelineno-0-142><span class=linenos data-linenos="142 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>token_budget</span> <span class=o>=</span> <span class=n>token_budget</span>
</span><span id=__span-0-143><a id=__codelineno-0-143 name=__codelineno-0-143></a><a href=#__codelineno-0-143><span class=linenos data-linenos="143 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>tokens_used</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-144><a id=__codelineno-0-144 name=__codelineno-0-144></a><a href=#__codelineno-0-144><span class=linenos data-linenos="144 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>scope</span> <span class=o>=</span> <span class=n>scope</span>
</span><span id=__span-0-145><a id=__codelineno-0-145 name=__codelineno-0-145></a><a href=#__codelineno-0-145><span class=linenos data-linenos="145 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>shared_knowledge</span> <span class=o>=</span> <span class=n>shared_knowledge</span>
</span><span id=__span-0-146><a id=__codelineno-0-146 name=__codelineno-0-146></a><a href=#__codelineno-0-146><span class=linenos data-linenos="146 "></span></a>        
</span><span id=__span-0-147><a id=__codelineno-0-147 name=__codelineno-0-147></a><a href=#__codelineno-0-147><span class=linenos data-linenos="147 "></span></a>        <span class=c1># Context caches for performance</span>
</span><span id=__span-0-148><a id=__codelineno-0-148 name=__codelineno-0-148></a><a href=#__codelineno-0-148><span class=linenos data-linenos="148 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>file_content_cache</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span><span id=__span-0-149><a id=__codelineno-0-149 name=__codelineno-0-149></a><a href=#__codelineno-0-149><span class=linenos data-linenos="149 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>compressed_content_cache</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span><span id=__span-0-150><a id=__codelineno-0-150 name=__codelineno-0-150></a><a href=#__codelineno-0-150><span class=linenos data-linenos="150 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>relevance_scores</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>float</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span><span id=__span-0-151><a id=__codelineno-0-151 name=__codelineno-0-151></a><a href=#__codelineno-0-151><span class=linenos data-linenos="151 "></span></a>        
</span><span id=__span-0-152><a id=__codelineno-0-152 name=__codelineno-0-152></a><a href=#__codelineno-0-152><span class=linenos data-linenos="152 "></span></a>        <span class=c1># Parallel-specific features</span>
</span><span id=__span-0-153><a id=__codelineno-0-153 name=__codelineno-0-153></a><a href=#__codelineno-0-153><span class=linenos data-linenos="153 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>context_updates</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>ContextUpdate</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-0-154><a id=__codelineno-0-154 name=__codelineno-0-154></a><a href=#__codelineno-0-154><span class=linenos data-linenos="154 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>dependency_changes</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>DependencyChange</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-0-155><a id=__codelineno-0-155 name=__codelineno-0-155></a><a href=#__codelineno-0-155><span class=linenos data-linenos="155 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>shared_context_keys</span><span class=p>:</span> <span class=n>Set</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
</span><span id=__span-0-156><a id=__codelineno-0-156 name=__codelineno-0-156></a><a href=#__codelineno-0-156><span class=linenos data-linenos="156 "></span></a>        
</span><span id=__span-0-157><a id=__codelineno-0-157 name=__codelineno-0-157></a><a href=#__codelineno-0-157><span class=linenos data-linenos="157 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>get_context_for_agent</span><span class=p>(</span>
</span><span id=__span-0-158><a id=__codelineno-0-158 name=__codelineno-0-158></a><a href=#__codelineno-0-158><span class=linenos data-linenos="158 "></span></a>        <span class=bp>self</span><span class=p>,</span> 
</span><span id=__span-0-159><a id=__codelineno-0-159 name=__codelineno-0-159></a><a href=#__codelineno-0-159><span class=linenos data-linenos="159 "></span></a>        <span class=n>agent_type</span><span class=p>:</span> <span class=n>AgentType</span><span class=p>,</span> 
</span><span id=__span-0-160><a id=__codelineno-0-160 name=__codelineno-0-160></a><a href=#__codelineno-0-160><span class=linenos data-linenos="160 "></span></a>        <span class=n>task</span><span class=p>:</span> <span class=n>TDDTask</span>
</span><span id=__span-0-161><a id=__codelineno-0-161 name=__codelineno-0-161></a><a href=#__codelineno-0-161><span class=linenos data-linenos="161 "></span></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>AgentContext</span><span class=p>:</span>
</span><span id=__span-0-162><a id=__codelineno-0-162 name=__codelineno-0-162></a><a href=#__codelineno-0-162><span class=linenos data-linenos="162 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Get optimized context for specific agent and task&quot;&quot;&quot;</span>
</span><span id=__span-0-163><a id=__codelineno-0-163 name=__codelineno-0-163></a><a href=#__codelineno-0-163><span class=linenos data-linenos="163 "></span></a>        
</span><span id=__span-0-164><a id=__codelineno-0-164 name=__codelineno-0-164></a><a href=#__codelineno-0-164><span class=linenos data-linenos="164 "></span></a>        <span class=c1># Calculate agent-specific context needs</span>
</span><span id=__span-0-165><a id=__codelineno-0-165 name=__codelineno-0-165></a><a href=#__codelineno-0-165><span class=linenos data-linenos="165 "></span></a>        <span class=n>context_needs</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_analyze_agent_context_needs</span><span class=p>(</span><span class=n>agent_type</span><span class=p>,</span> <span class=n>task</span><span class=p>)</span>
</span><span id=__span-0-166><a id=__codelineno-0-166 name=__codelineno-0-166></a><a href=#__codelineno-0-166><span class=linenos data-linenos="166 "></span></a>        
</span><span id=__span-0-167><a id=__codelineno-0-167 name=__codelineno-0-167></a><a href=#__codelineno-0-167><span class=linenos data-linenos="167 "></span></a>        <span class=c1># Get relevant files within scope</span>
</span><span id=__span-0-168><a id=__codelineno-0-168 name=__codelineno-0-168></a><a href=#__codelineno-0-168><span class=linenos data-linenos="168 "></span></a>        <span class=n>relevant_files</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_relevant_files</span><span class=p>(</span><span class=n>context_needs</span><span class=p>)</span>
</span><span id=__span-0-169><a id=__codelineno-0-169 name=__codelineno-0-169></a><a href=#__codelineno-0-169><span class=linenos data-linenos="169 "></span></a>        
</span><span id=__span-0-170><a id=__codelineno-0-170 name=__codelineno-0-170></a><a href=#__codelineno-0-170><span class=linenos data-linenos="170 "></span></a>        <span class=c1># Apply context compression to fit token budget</span>
</span><span id=__span-0-171><a id=__codelineno-0-171 name=__codelineno-0-171></a><a href=#__codelineno-0-171><span class=linenos data-linenos="171 "></span></a>        <span class=n>compressed_context</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_compress_context_for_agent</span><span class=p>(</span>
</span><span id=__span-0-172><a id=__codelineno-0-172 name=__codelineno-0-172></a><a href=#__codelineno-0-172><span class=linenos data-linenos="172 "></span></a>            <span class=n>relevant_files</span><span class=p>,</span> <span class=n>agent_type</span><span class=p>,</span> <span class=n>context_needs</span>
</span><span id=__span-0-173><a id=__codelineno-0-173 name=__codelineno-0-173></a><a href=#__codelineno-0-173><span class=linenos data-linenos="173 "></span></a>        <span class=p>)</span>
</span><span id=__span-0-174><a id=__codelineno-0-174 name=__codelineno-0-174></a><a href=#__codelineno-0-174><span class=linenos data-linenos="174 "></span></a>        
</span><span id=__span-0-175><a id=__codelineno-0-175 name=__codelineno-0-175></a><a href=#__codelineno-0-175><span class=linenos data-linenos="175 "></span></a>        <span class=c1># Add shared knowledge relevant to task</span>
</span><span id=__span-0-176><a id=__codelineno-0-176 name=__codelineno-0-176></a><a href=#__codelineno-0-176><span class=linenos data-linenos="176 "></span></a>        <span class=n>shared_context</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_relevant_shared_knowledge</span><span class=p>(</span>
</span><span id=__span-0-177><a id=__codelineno-0-177 name=__codelineno-0-177></a><a href=#__codelineno-0-177><span class=linenos data-linenos="177 "></span></a>            <span class=n>agent_type</span><span class=p>,</span> <span class=n>task</span><span class=p>,</span> <span class=n>context_needs</span>
</span><span id=__span-0-178><a id=__codelineno-0-178 name=__codelineno-0-178></a><a href=#__codelineno-0-178><span class=linenos data-linenos="178 "></span></a>        <span class=p>)</span>
</span><span id=__span-0-179><a id=__codelineno-0-179 name=__codelineno-0-179></a><a href=#__codelineno-0-179><span class=linenos data-linenos="179 "></span></a>        
</span><span id=__span-0-180><a id=__codelineno-0-180 name=__codelineno-0-180></a><a href=#__codelineno-0-180><span class=linenos data-linenos="180 "></span></a>        <span class=c1># Combine into agent context</span>
</span><span id=__span-0-181><a id=__codelineno-0-181 name=__codelineno-0-181></a><a href=#__codelineno-0-181><span class=linenos data-linenos="181 "></span></a>        <span class=n>agent_context</span> <span class=o>=</span> <span class=n>AgentContext</span><span class=p>(</span>
</span><span id=__span-0-182><a id=__codelineno-0-182 name=__codelineno-0-182></a><a href=#__codelineno-0-182><span class=linenos data-linenos="182 "></span></a>            <span class=n>cycle_id</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>cycle_id</span><span class=p>,</span>
</span><span id=__span-0-183><a id=__codelineno-0-183 name=__codelineno-0-183></a><a href=#__codelineno-0-183><span class=linenos data-linenos="183 "></span></a>            <span class=n>agent_type</span><span class=o>=</span><span class=n>agent_type</span><span class=p>,</span>
</span><span id=__span-0-184><a id=__codelineno-0-184 name=__codelineno-0-184></a><a href=#__codelineno-0-184><span class=linenos data-linenos="184 "></span></a>            <span class=n>task_id</span><span class=o>=</span><span class=n>task</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-0-185><a id=__codelineno-0-185 name=__codelineno-0-185></a><a href=#__codelineno-0-185><span class=linenos data-linenos="185 "></span></a>            <span class=n>files</span><span class=o>=</span><span class=n>compressed_context</span><span class=o>.</span><span class=n>files</span><span class=p>,</span>
</span><span id=__span-0-186><a id=__codelineno-0-186 name=__codelineno-0-186></a><a href=#__codelineno-0-186><span class=linenos data-linenos="186 "></span></a>            <span class=n>shared_knowledge</span><span class=o>=</span><span class=n>shared_context</span><span class=p>,</span>
</span><span id=__span-0-187><a id=__codelineno-0-187 name=__codelineno-0-187></a><a href=#__codelineno-0-187><span class=linenos data-linenos="187 "></span></a>            <span class=n>metadata</span><span class=o>=</span><span class=n>compressed_context</span><span class=o>.</span><span class=n>metadata</span><span class=p>,</span>
</span><span id=__span-0-188><a id=__codelineno-0-188 name=__codelineno-0-188></a><a href=#__codelineno-0-188><span class=linenos data-linenos="188 "></span></a>            <span class=n>token_count</span><span class=o>=</span><span class=n>compressed_context</span><span class=o>.</span><span class=n>token_count</span><span class=p>,</span>
</span><span id=__span-0-189><a id=__codelineno-0-189 name=__codelineno-0-189></a><a href=#__codelineno-0-189><span class=linenos data-linenos="189 "></span></a>            <span class=n>relevance_score</span><span class=o>=</span><span class=n>compressed_context</span><span class=o>.</span><span class=n>overall_relevance</span>
</span><span id=__span-0-190><a id=__codelineno-0-190 name=__codelineno-0-190></a><a href=#__codelineno-0-190><span class=linenos data-linenos="190 "></span></a>        <span class=p>)</span>
</span><span id=__span-0-191><a id=__codelineno-0-191 name=__codelineno-0-191></a><a href=#__codelineno-0-191><span class=linenos data-linenos="191 "></span></a>        
</span><span id=__span-0-192><a id=__codelineno-0-192 name=__codelineno-0-192></a><a href=#__codelineno-0-192><span class=linenos data-linenos="192 "></span></a>        <span class=c1># Update usage tracking</span>
</span><span id=__span-0-193><a id=__codelineno-0-193 name=__codelineno-0-193></a><a href=#__codelineno-0-193><span class=linenos data-linenos="193 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>tokens_used</span> <span class=o>+=</span> <span class=n>agent_context</span><span class=o>.</span><span class=n>token_count</span>
</span><span id=__span-0-194><a id=__codelineno-0-194 name=__codelineno-0-194></a><a href=#__codelineno-0-194><span class=linenos data-linenos="194 "></span></a>        
</span><span id=__span-0-195><a id=__codelineno-0-195 name=__codelineno-0-195></a><a href=#__codelineno-0-195><span class=linenos data-linenos="195 "></span></a>        <span class=k>return</span> <span class=n>agent_context</span>
</span><span id=__span-0-196><a id=__codelineno-0-196 name=__codelineno-0-196></a><a href=#__codelineno-0-196><span class=linenos data-linenos="196 "></span></a>        
</span><span id=__span-0-197><a id=__codelineno-0-197 name=__codelineno-0-197></a><a href=#__codelineno-0-197><span class=linenos data-linenos="197 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>_compress_context_for_agent</span><span class=p>(</span>
</span><span id=__span-0-198><a id=__codelineno-0-198 name=__codelineno-0-198></a><a href=#__codelineno-0-198><span class=linenos data-linenos="198 "></span></a>        <span class=bp>self</span><span class=p>,</span>
</span><span id=__span-0-199><a id=__codelineno-0-199 name=__codelineno-0-199></a><a href=#__codelineno-0-199><span class=linenos data-linenos="199 "></span></a>        <span class=n>relevant_files</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>RelevantFile</span><span class=p>],</span>
</span><span id=__span-0-200><a id=__codelineno-0-200 name=__codelineno-0-200></a><a href=#__codelineno-0-200><span class=linenos data-linenos="200 "></span></a>        <span class=n>agent_type</span><span class=p>:</span> <span class=n>AgentType</span><span class=p>,</span>
</span><span id=__span-0-201><a id=__codelineno-0-201 name=__codelineno-0-201></a><a href=#__codelineno-0-201><span class=linenos data-linenos="201 "></span></a>        <span class=n>context_needs</span><span class=p>:</span> <span class=n>ContextNeeds</span>
</span><span id=__span-0-202><a id=__codelineno-0-202 name=__codelineno-0-202></a><a href=#__codelineno-0-202><span class=linenos data-linenos="202 "></span></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>CompressedContext</span><span class=p>:</span>
</span><span id=__span-0-203><a id=__codelineno-0-203 name=__codelineno-0-203></a><a href=#__codelineno-0-203><span class=linenos data-linenos="203 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Apply intelligent compression for agent type and parallel constraints&quot;&quot;&quot;</span>
</span><span id=__span-0-204><a id=__codelineno-0-204 name=__codelineno-0-204></a><a href=#__codelineno-0-204><span class=linenos data-linenos="204 "></span></a>        
</span><span id=__span-0-205><a id=__codelineno-0-205 name=__codelineno-0-205></a><a href=#__codelineno-0-205><span class=linenos data-linenos="205 "></span></a>        <span class=c1># Calculate available token budget</span>
</span><span id=__span-0-206><a id=__codelineno-0-206 name=__codelineno-0-206></a><a href=#__codelineno-0-206><span class=linenos data-linenos="206 "></span></a>        <span class=n>remaining_budget</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>token_budget</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>tokens_used</span>
</span><span id=__span-0-207><a id=__codelineno-0-207 name=__codelineno-0-207></a><a href=#__codelineno-0-207><span class=linenos data-linenos="207 "></span></a>        <span class=n>agent_budget</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>remaining_budget</span><span class=p>,</span> <span class=n>context_needs</span><span class=o>.</span><span class=n>preferred_token_count</span><span class=p>)</span>
</span><span id=__span-0-208><a id=__codelineno-0-208 name=__codelineno-0-208></a><a href=#__codelineno-0-208><span class=linenos data-linenos="208 "></span></a>        
</span><span id=__span-0-209><a id=__codelineno-0-209 name=__codelineno-0-209></a><a href=#__codelineno-0-209><span class=linenos data-linenos="209 "></span></a>        <span class=c1># Apply agent-specific compression strategies</span>
</span><span id=__span-0-210><a id=__codelineno-0-210 name=__codelineno-0-210></a><a href=#__codelineno-0-210><span class=linenos data-linenos="210 "></span></a>        <span class=n>compression_strategy</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_compression_strategy</span><span class=p>(</span><span class=n>agent_type</span><span class=p>)</span>
</span><span id=__span-0-211><a id=__codelineno-0-211 name=__codelineno-0-211></a><a href=#__codelineno-0-211><span class=linenos data-linenos="211 "></span></a>        
</span><span id=__span-0-212><a id=__codelineno-0-212 name=__codelineno-0-212></a><a href=#__codelineno-0-212><span class=linenos data-linenos="212 "></span></a>        <span class=n>compressed_files</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-0-213><a id=__codelineno-0-213 name=__codelineno-0-213></a><a href=#__codelineno-0-213><span class=linenos data-linenos="213 "></span></a>        <span class=n>total_tokens</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-214><a id=__codelineno-0-214 name=__codelineno-0-214></a><a href=#__codelineno-0-214><span class=linenos data-linenos="214 "></span></a>        
</span><span id=__span-0-215><a id=__codelineno-0-215 name=__codelineno-0-215></a><a href=#__codelineno-0-215><span class=linenos data-linenos="215 "></span></a>        <span class=c1># Process files in order of relevance</span>
</span><span id=__span-0-216><a id=__codelineno-0-216 name=__codelineno-0-216></a><a href=#__codelineno-0-216><span class=linenos data-linenos="216 "></span></a>        <span class=n>sorted_files</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>relevant_files</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>f</span><span class=p>:</span> <span class=n>f</span><span class=o>.</span><span class=n>relevance_score</span><span class=p>,</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-0-217><a id=__codelineno-0-217 name=__codelineno-0-217></a><a href=#__codelineno-0-217><span class=linenos data-linenos="217 "></span></a>        
</span><span id=__span-0-218><a id=__codelineno-0-218 name=__codelineno-0-218></a><a href=#__codelineno-0-218><span class=linenos data-linenos="218 "></span></a>        <span class=k>for</span> <span class=n>file_info</span> <span class=ow>in</span> <span class=n>sorted_files</span><span class=p>:</span>
</span><span id=__span-0-219><a id=__codelineno-0-219 name=__codelineno-0-219></a><a href=#__codelineno-0-219><span class=linenos data-linenos="219 "></span></a>            <span class=k>if</span> <span class=n>total_tokens</span> <span class=o>&gt;=</span> <span class=n>agent_budget</span> <span class=o>*</span> <span class=mf>0.9</span><span class=p>:</span>  <span class=c1># Leave 10% buffer</span>
</span><span id=__span-0-220><a id=__codelineno-0-220 name=__codelineno-0-220></a><a href=#__codelineno-0-220><span class=linenos data-linenos="220 "></span></a>                <span class=k>break</span>
</span><span id=__span-0-221><a id=__codelineno-0-221 name=__codelineno-0-221></a><a href=#__codelineno-0-221><span class=linenos data-linenos="221 "></span></a>                
</span><span id=__span-0-222><a id=__codelineno-0-222 name=__codelineno-0-222></a><a href=#__codelineno-0-222><span class=linenos data-linenos="222 "></span></a>            <span class=c1># Apply compression based on file type and agent needs</span>
</span><span id=__span-0-223><a id=__codelineno-0-223 name=__codelineno-0-223></a><a href=#__codelineno-0-223><span class=linenos data-linenos="223 "></span></a>            <span class=k>if</span> <span class=n>file_info</span><span class=o>.</span><span class=n>file_path</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>compressed_content_cache</span><span class=p>:</span>
</span><span id=__span-0-224><a id=__codelineno-0-224 name=__codelineno-0-224></a><a href=#__codelineno-0-224><span class=linenos data-linenos="224 "></span></a>                <span class=n>compressed_content</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>compressed_content_cache</span><span class=p>[</span><span class=n>file_info</span><span class=o>.</span><span class=n>file_path</span><span class=p>]</span>
</span><span id=__span-0-225><a id=__codelineno-0-225 name=__codelineno-0-225></a><a href=#__codelineno-0-225><span class=linenos data-linenos="225 "></span></a>            <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-226><a id=__codelineno-0-226 name=__codelineno-0-226></a><a href=#__codelineno-0-226><span class=linenos data-linenos="226 "></span></a>                <span class=n>compressed_content</span> <span class=o>=</span> <span class=k>await</span> <span class=n>compression_strategy</span><span class=o>.</span><span class=n>compress_file</span><span class=p>(</span>
</span><span id=__span-0-227><a id=__codelineno-0-227 name=__codelineno-0-227></a><a href=#__codelineno-0-227><span class=linenos data-linenos="227 "></span></a>                    <span class=n>file_info</span><span class=p>,</span> <span class=n>context_needs</span>
</span><span id=__span-0-228><a id=__codelineno-0-228 name=__codelineno-0-228></a><a href=#__codelineno-0-228><span class=linenos data-linenos="228 "></span></a>                <span class=p>)</span>
</span><span id=__span-0-229><a id=__codelineno-0-229 name=__codelineno-0-229></a><a href=#__codelineno-0-229><span class=linenos data-linenos="229 "></span></a>                <span class=bp>self</span><span class=o>.</span><span class=n>compressed_content_cache</span><span class=p>[</span><span class=n>file_info</span><span class=o>.</span><span class=n>file_path</span><span class=p>]</span> <span class=o>=</span> <span class=n>compressed_content</span>
</span><span id=__span-0-230><a id=__codelineno-0-230 name=__codelineno-0-230></a><a href=#__codelineno-0-230><span class=linenos data-linenos="230 "></span></a>                
</span><span id=__span-0-231><a id=__codelineno-0-231 name=__codelineno-0-231></a><a href=#__codelineno-0-231><span class=linenos data-linenos="231 "></span></a>            <span class=n>file_tokens</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_estimate_tokens</span><span class=p>(</span><span class=n>compressed_content</span><span class=p>)</span>
</span><span id=__span-0-232><a id=__codelineno-0-232 name=__codelineno-0-232></a><a href=#__codelineno-0-232><span class=linenos data-linenos="232 "></span></a>            
</span><span id=__span-0-233><a id=__codelineno-0-233 name=__codelineno-0-233></a><a href=#__codelineno-0-233><span class=linenos data-linenos="233 "></span></a>            <span class=k>if</span> <span class=n>total_tokens</span> <span class=o>+</span> <span class=n>file_tokens</span> <span class=o>&lt;=</span> <span class=n>agent_budget</span><span class=p>:</span>
</span><span id=__span-0-234><a id=__codelineno-0-234 name=__codelineno-0-234></a><a href=#__codelineno-0-234><span class=linenos data-linenos="234 "></span></a>                <span class=n>compressed_files</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>CompressedFile</span><span class=p>(</span>
</span><span id=__span-0-235><a id=__codelineno-0-235 name=__codelineno-0-235></a><a href=#__codelineno-0-235><span class=linenos data-linenos="235 "></span></a>                    <span class=n>path</span><span class=o>=</span><span class=n>file_info</span><span class=o>.</span><span class=n>file_path</span><span class=p>,</span>
</span><span id=__span-0-236><a id=__codelineno-0-236 name=__codelineno-0-236></a><a href=#__codelineno-0-236><span class=linenos data-linenos="236 "></span></a>                    <span class=n>content</span><span class=o>=</span><span class=n>compressed_content</span><span class=p>,</span>
</span><span id=__span-0-237><a id=__codelineno-0-237 name=__codelineno-0-237></a><a href=#__codelineno-0-237><span class=linenos data-linenos="237 "></span></a>                    <span class=n>original_size</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>file_info</span><span class=o>.</span><span class=n>content</span><span class=p>),</span>
</span><span id=__span-0-238><a id=__codelineno-0-238 name=__codelineno-0-238></a><a href=#__codelineno-0-238><span class=linenos data-linenos="238 "></span></a>                    <span class=n>compressed_size</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>compressed_content</span><span class=p>),</span>
</span><span id=__span-0-239><a id=__codelineno-0-239 name=__codelineno-0-239></a><a href=#__codelineno-0-239><span class=linenos data-linenos="239 "></span></a>                    <span class=n>compression_ratio</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>compressed_content</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>file_info</span><span class=o>.</span><span class=n>content</span><span class=p>),</span>
</span><span id=__span-0-240><a id=__codelineno-0-240 name=__codelineno-0-240></a><a href=#__codelineno-0-240><span class=linenos data-linenos="240 "></span></a>                    <span class=n>relevance</span><span class=o>=</span><span class=n>file_info</span><span class=o>.</span><span class=n>relevance_score</span><span class=p>,</span>
</span><span id=__span-0-241><a id=__codelineno-0-241 name=__codelineno-0-241></a><a href=#__codelineno-0-241><span class=linenos data-linenos="241 "></span></a>                    <span class=n>tokens</span><span class=o>=</span><span class=n>file_tokens</span>
</span><span id=__span-0-242><a id=__codelineno-0-242 name=__codelineno-0-242></a><a href=#__codelineno-0-242><span class=linenos data-linenos="242 "></span></a>                <span class=p>))</span>
</span><span id=__span-0-243><a id=__codelineno-0-243 name=__codelineno-0-243></a><a href=#__codelineno-0-243><span class=linenos data-linenos="243 "></span></a>                <span class=n>total_tokens</span> <span class=o>+=</span> <span class=n>file_tokens</span>
</span><span id=__span-0-244><a id=__codelineno-0-244 name=__codelineno-0-244></a><a href=#__codelineno-0-244><span class=linenos data-linenos="244 "></span></a>                
</span><span id=__span-0-245><a id=__codelineno-0-245 name=__codelineno-0-245></a><a href=#__codelineno-0-245><span class=linenos data-linenos="245 "></span></a>        <span class=k>return</span> <span class=n>CompressedContext</span><span class=p>(</span>
</span><span id=__span-0-246><a id=__codelineno-0-246 name=__codelineno-0-246></a><a href=#__codelineno-0-246><span class=linenos data-linenos="246 "></span></a>            <span class=n>files</span><span class=o>=</span><span class=n>compressed_files</span><span class=p>,</span>
</span><span id=__span-0-247><a id=__codelineno-0-247 name=__codelineno-0-247></a><a href=#__codelineno-0-247><span class=linenos data-linenos="247 "></span></a>            <span class=n>metadata</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_create_context_metadata</span><span class=p>(</span><span class=n>compressed_files</span><span class=p>),</span>
</span><span id=__span-0-248><a id=__codelineno-0-248 name=__codelineno-0-248></a><a href=#__codelineno-0-248><span class=linenos data-linenos="248 "></span></a>            <span class=n>token_count</span><span class=o>=</span><span class=n>total_tokens</span><span class=p>,</span>
</span><span id=__span-0-249><a id=__codelineno-0-249 name=__codelineno-0-249></a><a href=#__codelineno-0-249><span class=linenos data-linenos="249 "></span></a>            <span class=n>compression_stats</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_calculate_compression_stats</span><span class=p>(</span><span class=n>compressed_files</span><span class=p>),</span>
</span><span id=__span-0-250><a id=__codelineno-0-250 name=__codelineno-0-250></a><a href=#__codelineno-0-250><span class=linenos data-linenos="250 "></span></a>            <span class=n>overall_relevance</span><span class=o>=</span><span class=nb>sum</span><span class=p>(</span><span class=n>f</span><span class=o>.</span><span class=n>relevance</span> <span class=k>for</span> <span class=n>f</span> <span class=ow>in</span> <span class=n>compressed_files</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>compressed_files</span><span class=p>)</span>
</span><span id=__span-0-251><a id=__codelineno-0-251 name=__codelineno-0-251></a><a href=#__codelineno-0-251><span class=linenos data-linenos="251 "></span></a>        <span class=p>)</span>
</span></code></pre></div><h3 id=2-token-budget-management-for-parallel-execution>2. Token Budget Management for Parallel Execution<a class=headerlink href=#2-token-budget-management-for-parallel-execution title="Permanent link">&para;</a></h3><div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1></a><a href=#__codelineno-1-1><span class=linenos data-linenos="  1 "></span></a><span class=k>class</span><span class=w> </span><span class=nc>ParallelTokenBudgetManager</span><span class=p>:</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2></a><a href=#__codelineno-1-2><span class=linenos data-linenos="  2 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Intelligent token budget allocation across parallel cycles&quot;&quot;&quot;</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3></a><a href=#__codelineno-1-3><span class=linenos data-linenos="  3 "></span></a>    
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4></a><a href=#__codelineno-1-4><span class=linenos data-linenos="  4 "></span></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>total_budget</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>200000</span><span class=p>):</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5></a><a href=#__codelineno-1-5><span class=linenos data-linenos="  5 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>total_budget</span> <span class=o>=</span> <span class=n>total_budget</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6></a><a href=#__codelineno-1-6><span class=linenos data-linenos="  6 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>system_reserve</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>total_budget</span> <span class=o>*</span> <span class=mf>0.1</span><span class=p>)</span>  <span class=c1># 10% system reserve</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7></a><a href=#__codelineno-1-7><span class=linenos data-linenos="  7 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>available_budget</span> <span class=o>=</span> <span class=n>total_budget</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>system_reserve</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8></a><a href=#__codelineno-1-8><span class=linenos data-linenos="  8 "></span></a>        
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9></a><a href=#__codelineno-1-9><span class=linenos data-linenos="  9 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>allocations</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>TokenAllocation</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10></a><a href=#__codelineno-1-10><span class=linenos data-linenos=" 10 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>usage_history</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>List</span><span class=p>[</span><span class=n>TokenUsage</span><span class=p>]]</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11></a><a href=#__codelineno-1-11><span class=linenos data-linenos=" 11 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>predictive_model</span> <span class=o>=</span> <span class=n>TokenUsagePredictionModel</span><span class=p>()</span>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12></a><a href=#__codelineno-1-12><span class=linenos data-linenos=" 12 "></span></a>        
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13></a><a href=#__codelineno-1-13><span class=linenos data-linenos=" 13 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>allocate_for_cycle</span><span class=p>(</span>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14></a><a href=#__codelineno-1-14><span class=linenos data-linenos=" 14 "></span></a>        <span class=bp>self</span><span class=p>,</span> 
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15></a><a href=#__codelineno-1-15><span class=linenos data-linenos=" 15 "></span></a>        <span class=n>cycle_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> 
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16></a><a href=#__codelineno-1-16><span class=linenos data-linenos=" 16 "></span></a>        <span class=n>parallel_group</span><span class=p>:</span> <span class=n>ParallelGroup</span>
</span><span id=__span-1-17><a id=__codelineno-1-17 name=__codelineno-1-17></a><a href=#__codelineno-1-17><span class=linenos data-linenos=" 17 "></span></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>TokenAllocation</span><span class=p>:</span>
</span><span id=__span-1-18><a id=__codelineno-1-18 name=__codelineno-1-18></a><a href=#__codelineno-1-18><span class=linenos data-linenos=" 18 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Allocate optimal token budget for a cycle in parallel group&quot;&quot;&quot;</span>
</span><span id=__span-1-19><a id=__codelineno-1-19 name=__codelineno-1-19></a><a href=#__codelineno-1-19><span class=linenos data-linenos=" 19 "></span></a>        
</span><span id=__span-1-20><a id=__codelineno-1-20 name=__codelineno-1-20></a><a href=#__codelineno-1-20><span class=linenos data-linenos=" 20 "></span></a>        <span class=c1># Analyze current allocations</span>
</span><span id=__span-1-21><a id=__codelineno-1-21 name=__codelineno-1-21></a><a href=#__codelineno-1-21><span class=linenos data-linenos=" 21 "></span></a>        <span class=n>current_allocations</span> <span class=o>=</span> <span class=p>[</span><span class=n>a</span> <span class=k>for</span> <span class=n>a</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>allocations</span><span class=o>.</span><span class=n>values</span><span class=p>()</span> <span class=k>if</span> <span class=n>a</span><span class=o>.</span><span class=n>is_active</span><span class=p>()]</span>
</span><span id=__span-1-22><a id=__codelineno-1-22 name=__codelineno-1-22></a><a href=#__codelineno-1-22><span class=linenos data-linenos=" 22 "></span></a>        <span class=n>active_cycles</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>current_allocations</span><span class=p>)</span>
</span><span id=__span-1-23><a id=__codelineno-1-23 name=__codelineno-1-23></a><a href=#__codelineno-1-23><span class=linenos data-linenos=" 23 "></span></a>        
</span><span id=__span-1-24><a id=__codelineno-1-24 name=__codelineno-1-24></a><a href=#__codelineno-1-24><span class=linenos data-linenos=" 24 "></span></a>        <span class=c1># Predict usage for this cycle</span>
</span><span id=__span-1-25><a id=__codelineno-1-25 name=__codelineno-1-25></a><a href=#__codelineno-1-25><span class=linenos data-linenos=" 25 "></span></a>        <span class=n>predicted_usage</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>predictive_model</span><span class=o>.</span><span class=n>predict_cycle_usage</span><span class=p>(</span>
</span><span id=__span-1-26><a id=__codelineno-1-26 name=__codelineno-1-26></a><a href=#__codelineno-1-26><span class=linenos data-linenos=" 26 "></span></a>            <span class=n>cycle_id</span><span class=p>,</span> <span class=n>parallel_group</span>
</span><span id=__span-1-27><a id=__codelineno-1-27 name=__codelineno-1-27></a><a href=#__codelineno-1-27><span class=linenos data-linenos=" 27 "></span></a>        <span class=p>)</span>
</span><span id=__span-1-28><a id=__codelineno-1-28 name=__codelineno-1-28></a><a href=#__codelineno-1-28><span class=linenos data-linenos=" 28 "></span></a>        
</span><span id=__span-1-29><a id=__codelineno-1-29 name=__codelineno-1-29></a><a href=#__codelineno-1-29><span class=linenos data-linenos=" 29 "></span></a>        <span class=c1># Calculate base allocation</span>
</span><span id=__span-1-30><a id=__codelineno-1-30 name=__codelineno-1-30></a><a href=#__codelineno-1-30><span class=linenos data-linenos=" 30 "></span></a>        <span class=n>base_allocation</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_base_allocation</span><span class=p>(</span>
</span><span id=__span-1-31><a id=__codelineno-1-31 name=__codelineno-1-31></a><a href=#__codelineno-1-31><span class=linenos data-linenos=" 31 "></span></a>            <span class=n>active_cycles</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>predicted_usage</span>
</span><span id=__span-1-32><a id=__codelineno-1-32 name=__codelineno-1-32></a><a href=#__codelineno-1-32><span class=linenos data-linenos=" 32 "></span></a>        <span class=p>)</span>
</span><span id=__span-1-33><a id=__codelineno-1-33 name=__codelineno-1-33></a><a href=#__codelineno-1-33><span class=linenos data-linenos=" 33 "></span></a>        
</span><span id=__span-1-34><a id=__codelineno-1-34 name=__codelineno-1-34></a><a href=#__codelineno-1-34><span class=linenos data-linenos=" 34 "></span></a>        <span class=c1># Apply intelligent adjustments</span>
</span><span id=__span-1-35><a id=__codelineno-1-35 name=__codelineno-1-35></a><a href=#__codelineno-1-35><span class=linenos data-linenos=" 35 "></span></a>        <span class=n>adjusted_allocation</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_apply_intelligent_adjustments</span><span class=p>(</span>
</span><span id=__span-1-36><a id=__codelineno-1-36 name=__codelineno-1-36></a><a href=#__codelineno-1-36><span class=linenos data-linenos=" 36 "></span></a>            <span class=n>base_allocation</span><span class=p>,</span> <span class=n>cycle_id</span><span class=p>,</span> <span class=n>parallel_group</span><span class=p>,</span> <span class=n>predicted_usage</span>
</span><span id=__span-1-37><a id=__codelineno-1-37 name=__codelineno-1-37></a><a href=#__codelineno-1-37><span class=linenos data-linenos=" 37 "></span></a>        <span class=p>)</span>
</span><span id=__span-1-38><a id=__codelineno-1-38 name=__codelineno-1-38></a><a href=#__codelineno-1-38><span class=linenos data-linenos=" 38 "></span></a>        
</span><span id=__span-1-39><a id=__codelineno-1-39 name=__codelineno-1-39></a><a href=#__codelineno-1-39><span class=linenos data-linenos=" 39 "></span></a>        <span class=c1># Ensure we don&#39;t exceed available budget</span>
</span><span id=__span-1-40><a id=__codelineno-1-40 name=__codelineno-1-40></a><a href=#__codelineno-1-40><span class=linenos data-linenos=" 40 "></span></a>        <span class=n>final_allocation</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_ensure_budget_compliance</span><span class=p>(</span>
</span><span id=__span-1-41><a id=__codelineno-1-41 name=__codelineno-1-41></a><a href=#__codelineno-1-41><span class=linenos data-linenos=" 41 "></span></a>            <span class=n>adjusted_allocation</span><span class=p>,</span> <span class=n>current_allocations</span>
</span><span id=__span-1-42><a id=__codelineno-1-42 name=__codelineno-1-42></a><a href=#__codelineno-1-42><span class=linenos data-linenos=" 42 "></span></a>        <span class=p>)</span>
</span><span id=__span-1-43><a id=__codelineno-1-43 name=__codelineno-1-43></a><a href=#__codelineno-1-43><span class=linenos data-linenos=" 43 "></span></a>        
</span><span id=__span-1-44><a id=__codelineno-1-44 name=__codelineno-1-44></a><a href=#__codelineno-1-44><span class=linenos data-linenos=" 44 "></span></a>        <span class=n>allocation</span> <span class=o>=</span> <span class=n>TokenAllocation</span><span class=p>(</span>
</span><span id=__span-1-45><a id=__codelineno-1-45 name=__codelineno-1-45></a><a href=#__codelineno-1-45><span class=linenos data-linenos=" 45 "></span></a>            <span class=n>cycle_id</span><span class=o>=</span><span class=n>cycle_id</span><span class=p>,</span>
</span><span id=__span-1-46><a id=__codelineno-1-46 name=__codelineno-1-46></a><a href=#__codelineno-1-46><span class=linenos data-linenos=" 46 "></span></a>            <span class=n>allocated_tokens</span><span class=o>=</span><span class=n>final_allocation</span><span class=o>.</span><span class=n>tokens</span><span class=p>,</span>
</span><span id=__span-1-47><a id=__codelineno-1-47 name=__codelineno-1-47></a><a href=#__codelineno-1-47><span class=linenos data-linenos=" 47 "></span></a>            <span class=n>priority_multiplier</span><span class=o>=</span><span class=n>final_allocation</span><span class=o>.</span><span class=n>priority_multiplier</span><span class=p>,</span>
</span><span id=__span-1-48><a id=__codelineno-1-48 name=__codelineno-1-48></a><a href=#__codelineno-1-48><span class=linenos data-linenos=" 48 "></span></a>            <span class=n>phase_adjustments</span><span class=o>=</span><span class=n>final_allocation</span><span class=o>.</span><span class=n>phase_adjustments</span><span class=p>,</span>
</span><span id=__span-1-49><a id=__codelineno-1-49 name=__codelineno-1-49></a><a href=#__codelineno-1-49><span class=linenos data-linenos=" 49 "></span></a>            <span class=n>sharing_permissions</span><span class=o>=</span><span class=n>final_allocation</span><span class=o>.</span><span class=n>sharing_permissions</span><span class=p>,</span>
</span><span id=__span-1-50><a id=__codelineno-1-50 name=__codelineno-1-50></a><a href=#__codelineno-1-50><span class=linenos data-linenos=" 50 "></span></a>            <span class=n>allocated_at</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span>
</span><span id=__span-1-51><a id=__codelineno-1-51 name=__codelineno-1-51></a><a href=#__codelineno-1-51><span class=linenos data-linenos=" 51 "></span></a>            <span class=n>expires_at</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span> <span class=o>+</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>hours</span><span class=o>=</span><span class=mi>6</span><span class=p>)</span>
</span><span id=__span-1-52><a id=__codelineno-1-52 name=__codelineno-1-52></a><a href=#__codelineno-1-52><span class=linenos data-linenos=" 52 "></span></a>        <span class=p>)</span>
</span><span id=__span-1-53><a id=__codelineno-1-53 name=__codelineno-1-53></a><a href=#__codelineno-1-53><span class=linenos data-linenos=" 53 "></span></a>        
</span><span id=__span-1-54><a id=__codelineno-1-54 name=__codelineno-1-54></a><a href=#__codelineno-1-54><span class=linenos data-linenos=" 54 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>allocations</span><span class=p>[</span><span class=n>cycle_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>allocation</span>
</span><span id=__span-1-55><a id=__codelineno-1-55 name=__codelineno-1-55></a><a href=#__codelineno-1-55><span class=linenos data-linenos=" 55 "></span></a>        <span class=k>return</span> <span class=n>allocation</span>
</span><span id=__span-1-56><a id=__codelineno-1-56 name=__codelineno-1-56></a><a href=#__codelineno-1-56><span class=linenos data-linenos=" 56 "></span></a>        
</span><span id=__span-1-57><a id=__codelineno-1-57 name=__codelineno-1-57></a><a href=#__codelineno-1-57><span class=linenos data-linenos=" 57 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>_apply_intelligent_adjustments</span><span class=p>(</span>
</span><span id=__span-1-58><a id=__codelineno-1-58 name=__codelineno-1-58></a><a href=#__codelineno-1-58><span class=linenos data-linenos=" 58 "></span></a>        <span class=bp>self</span><span class=p>,</span>
</span><span id=__span-1-59><a id=__codelineno-1-59 name=__codelineno-1-59></a><a href=#__codelineno-1-59><span class=linenos data-linenos=" 59 "></span></a>        <span class=n>base_allocation</span><span class=p>:</span> <span class=n>BaseAllocation</span><span class=p>,</span>
</span><span id=__span-1-60><a id=__codelineno-1-60 name=__codelineno-1-60></a><a href=#__codelineno-1-60><span class=linenos data-linenos=" 60 "></span></a>        <span class=n>cycle_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span><span id=__span-1-61><a id=__codelineno-1-61 name=__codelineno-1-61></a><a href=#__codelineno-1-61><span class=linenos data-linenos=" 61 "></span></a>        <span class=n>parallel_group</span><span class=p>:</span> <span class=n>ParallelGroup</span><span class=p>,</span>
</span><span id=__span-1-62><a id=__codelineno-1-62 name=__codelineno-1-62></a><a href=#__codelineno-1-62><span class=linenos data-linenos=" 62 "></span></a>        <span class=n>predicted_usage</span><span class=p>:</span> <span class=n>PredictedUsage</span>
</span><span id=__span-1-63><a id=__codelineno-1-63 name=__codelineno-1-63></a><a href=#__codelineno-1-63><span class=linenos data-linenos=" 63 "></span></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>AdjustedAllocation</span><span class=p>:</span>
</span><span id=__span-1-64><a id=__codelineno-1-64 name=__codelineno-1-64></a><a href=#__codelineno-1-64><span class=linenos data-linenos=" 64 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Apply intelligent adjustments based on multiple factors&quot;&quot;&quot;</span>
</span><span id=__span-1-65><a id=__codelineno-1-65 name=__codelineno-1-65></a><a href=#__codelineno-1-65><span class=linenos data-linenos=" 65 "></span></a>        
</span><span id=__span-1-66><a id=__codelineno-1-66 name=__codelineno-1-66></a><a href=#__codelineno-1-66><span class=linenos data-linenos=" 66 "></span></a>        <span class=n>adjustments</span> <span class=o>=</span> <span class=n>AdjustedAllocation</span><span class=p>(</span>
</span><span id=__span-1-67><a id=__codelineno-1-67 name=__codelineno-1-67></a><a href=#__codelineno-1-67><span class=linenos data-linenos=" 67 "></span></a>            <span class=n>tokens</span><span class=o>=</span><span class=n>base_allocation</span><span class=o>.</span><span class=n>tokens</span><span class=p>,</span>
</span><span id=__span-1-68><a id=__codelineno-1-68 name=__codelineno-1-68></a><a href=#__codelineno-1-68><span class=linenos data-linenos=" 68 "></span></a>            <span class=n>priority_multiplier</span><span class=o>=</span><span class=mf>1.0</span><span class=p>,</span>
</span><span id=__span-1-69><a id=__codelineno-1-69 name=__codelineno-1-69></a><a href=#__codelineno-1-69><span class=linenos data-linenos=" 69 "></span></a>            <span class=n>phase_adjustments</span><span class=o>=</span><span class=p>{},</span>
</span><span id=__span-1-70><a id=__codelineno-1-70 name=__codelineno-1-70></a><a href=#__codelineno-1-70><span class=linenos data-linenos=" 70 "></span></a>            <span class=n>sharing_permissions</span><span class=o>=</span><span class=nb>set</span><span class=p>()</span>
</span><span id=__span-1-71><a id=__codelineno-1-71 name=__codelineno-1-71></a><a href=#__codelineno-1-71><span class=linenos data-linenos=" 71 "></span></a>        <span class=p>)</span>
</span><span id=__span-1-72><a id=__codelineno-1-72 name=__codelineno-1-72></a><a href=#__codelineno-1-72><span class=linenos data-linenos=" 72 "></span></a>        
</span><span id=__span-1-73><a id=__codelineno-1-73 name=__codelineno-1-73></a><a href=#__codelineno-1-73><span class=linenos data-linenos=" 73 "></span></a>        <span class=c1># Story complexity adjustment</span>
</span><span id=__span-1-74><a id=__codelineno-1-74 name=__codelineno-1-74></a><a href=#__codelineno-1-74><span class=linenos data-linenos=" 74 "></span></a>        <span class=n>story_complexity</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_analyze_story_complexity</span><span class=p>(</span><span class=n>cycle_id</span><span class=p>)</span>
</span><span id=__span-1-75><a id=__codelineno-1-75 name=__codelineno-1-75></a><a href=#__codelineno-1-75><span class=linenos data-linenos=" 75 "></span></a>        <span class=k>if</span> <span class=n>story_complexity</span><span class=o>.</span><span class=n>complexity_score</span> <span class=o>&gt;</span> <span class=mf>0.8</span><span class=p>:</span>
</span><span id=__span-1-76><a id=__codelineno-1-76 name=__codelineno-1-76></a><a href=#__codelineno-1-76><span class=linenos data-linenos=" 76 "></span></a>            <span class=n>adjustments</span><span class=o>.</span><span class=n>tokens</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>adjustments</span><span class=o>.</span><span class=n>tokens</span> <span class=o>*</span> <span class=mf>1.3</span><span class=p>)</span>  <span class=c1># 30% more for complex stories</span>
</span><span id=__span-1-77><a id=__codelineno-1-77 name=__codelineno-1-77></a><a href=#__codelineno-1-77><span class=linenos data-linenos=" 77 "></span></a>        <span class=k>elif</span> <span class=n>story_complexity</span><span class=o>.</span><span class=n>complexity_score</span> <span class=o>&lt;</span> <span class=mf>0.3</span><span class=p>:</span>
</span><span id=__span-1-78><a id=__codelineno-1-78 name=__codelineno-1-78></a><a href=#__codelineno-1-78><span class=linenos data-linenos=" 78 "></span></a>            <span class=n>adjustments</span><span class=o>.</span><span class=n>tokens</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>adjustments</span><span class=o>.</span><span class=n>tokens</span> <span class=o>*</span> <span class=mf>0.8</span><span class=p>)</span>  <span class=c1># 20% less for simple stories</span>
</span><span id=__span-1-79><a id=__codelineno-1-79 name=__codelineno-1-79></a><a href=#__codelineno-1-79><span class=linenos data-linenos=" 79 "></span></a>            
</span><span id=__span-1-80><a id=__codelineno-1-80 name=__codelineno-1-80></a><a href=#__codelineno-1-80><span class=linenos data-linenos=" 80 "></span></a>        <span class=c1># TDD phase adjustments</span>
</span><span id=__span-1-81><a id=__codelineno-1-81 name=__codelineno-1-81></a><a href=#__codelineno-1-81><span class=linenos data-linenos=" 81 "></span></a>        <span class=n>adjustments</span><span class=o>.</span><span class=n>phase_adjustments</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-1-82><a id=__codelineno-1-82 name=__codelineno-1-82></a><a href=#__codelineno-1-82><span class=linenos data-linenos=" 82 "></span></a>            <span class=n>TDDState</span><span class=o>.</span><span class=n>DESIGN</span><span class=p>:</span> <span class=mf>1.2</span><span class=p>,</span>      <span class=c1># Design needs more context</span>
</span><span id=__span-1-83><a id=__codelineno-1-83 name=__codelineno-1-83></a><a href=#__codelineno-1-83><span class=linenos data-linenos=" 83 "></span></a>            <span class=n>TDDState</span><span class=o>.</span><span class=n>TEST_RED</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>,</span>    <span class=c1># Standard allocation</span>
</span><span id=__span-1-84><a id=__codelineno-1-84 name=__codelineno-1-84></a><a href=#__codelineno-1-84><span class=linenos data-linenos=" 84 "></span></a>            <span class=n>TDDState</span><span class=o>.</span><span class=n>CODE_GREEN</span><span class=p>:</span> <span class=mf>1.1</span><span class=p>,</span>  <span class=c1># Implementation needs good context</span>
</span><span id=__span-1-85><a id=__codelineno-1-85 name=__codelineno-1-85></a><a href=#__codelineno-1-85><span class=linenos data-linenos=" 85 "></span></a>            <span class=n>TDDState</span><span class=o>.</span><span class=n>REFACTOR</span><span class=p>:</span> <span class=mf>0.9</span><span class=p>,</span>    <span class=c1># Refactoring needs less new context</span>
</span><span id=__span-1-86><a id=__codelineno-1-86 name=__codelineno-1-86></a><a href=#__codelineno-1-86><span class=linenos data-linenos=" 86 "></span></a>            <span class=n>TDDState</span><span class=o>.</span><span class=n>COMMIT</span><span class=p>:</span> <span class=mf>0.7</span>       <span class=c1># Minimal context for commits</span>
</span><span id=__span-1-87><a id=__codelineno-1-87 name=__codelineno-1-87></a><a href=#__codelineno-1-87><span class=linenos data-linenos=" 87 "></span></a>        <span class=p>}</span>
</span><span id=__span-1-88><a id=__codelineno-1-88 name=__codelineno-1-88></a><a href=#__codelineno-1-88><span class=linenos data-linenos=" 88 "></span></a>        
</span><span id=__span-1-89><a id=__codelineno-1-89 name=__codelineno-1-89></a><a href=#__codelineno-1-89><span class=linenos data-linenos=" 89 "></span></a>        <span class=c1># Parallel coordination adjustments</span>
</span><span id=__span-1-90><a id=__codelineno-1-90 name=__codelineno-1-90></a><a href=#__codelineno-1-90><span class=linenos data-linenos=" 90 "></span></a>        <span class=n>coordination_needs</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_analyze_coordination_needs</span><span class=p>(</span>
</span><span id=__span-1-91><a id=__codelineno-1-91 name=__codelineno-1-91></a><a href=#__codelineno-1-91><span class=linenos data-linenos=" 91 "></span></a>            <span class=n>cycle_id</span><span class=p>,</span> <span class=n>parallel_group</span>
</span><span id=__span-1-92><a id=__codelineno-1-92 name=__codelineno-1-92></a><a href=#__codelineno-1-92><span class=linenos data-linenos=" 92 "></span></a>        <span class=p>)</span>
</span><span id=__span-1-93><a id=__codelineno-1-93 name=__codelineno-1-93></a><a href=#__codelineno-1-93><span class=linenos data-linenos=" 93 "></span></a>        
</span><span id=__span-1-94><a id=__codelineno-1-94 name=__codelineno-1-94></a><a href=#__codelineno-1-94><span class=linenos data-linenos=" 94 "></span></a>        <span class=k>if</span> <span class=n>coordination_needs</span><span class=o>.</span><span class=n>requires_shared_context</span><span class=p>:</span>
</span><span id=__span-1-95><a id=__codelineno-1-95 name=__codelineno-1-95></a><a href=#__codelineno-1-95><span class=linenos data-linenos=" 95 "></span></a>            <span class=n>adjustments</span><span class=o>.</span><span class=n>sharing_permissions</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=s1>&#39;shared_state&#39;</span><span class=p>)</span>
</span><span id=__span-1-96><a id=__codelineno-1-96 name=__codelineno-1-96></a><a href=#__codelineno-1-96><span class=linenos data-linenos=" 96 "></span></a>            <span class=n>adjustments</span><span class=o>.</span><span class=n>tokens</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>adjustments</span><span class=o>.</span><span class=n>tokens</span> <span class=o>*</span> <span class=mf>0.9</span><span class=p>)</span>  <span class=c1># 10% less for individual use</span>
</span><span id=__span-1-97><a id=__codelineno-1-97 name=__codelineno-1-97></a><a href=#__codelineno-1-97><span class=linenos data-linenos=" 97 "></span></a>            
</span><span id=__span-1-98><a id=__codelineno-1-98 name=__codelineno-1-98></a><a href=#__codelineno-1-98><span class=linenos data-linenos=" 98 "></span></a>        <span class=k>if</span> <span class=n>coordination_needs</span><span class=o>.</span><span class=n>high_conflict_risk</span><span class=p>:</span>
</span><span id=__span-1-99><a id=__codelineno-1-99 name=__codelineno-1-99></a><a href=#__codelineno-1-99><span class=linenos data-linenos=" 99 "></span></a>            <span class=n>adjustments</span><span class=o>.</span><span class=n>tokens</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>adjustments</span><span class=o>.</span><span class=n>tokens</span> <span class=o>*</span> <span class=mf>1.1</span><span class=p>)</span>  <span class=c1># 10% more for conflict resolution</span>
</span><span id=__span-1-100><a id=__codelineno-1-100 name=__codelineno-1-100></a><a href=#__codelineno-1-100><span class=linenos data-linenos="100 "></span></a>            
</span><span id=__span-1-101><a id=__codelineno-1-101 name=__codelineno-1-101></a><a href=#__codelineno-1-101><span class=linenos data-linenos="101 "></span></a>        <span class=c1># Historical usage adjustment</span>
</span><span id=__span-1-102><a id=__codelineno-1-102 name=__codelineno-1-102></a><a href=#__codelineno-1-102><span class=linenos data-linenos="102 "></span></a>        <span class=n>historical_efficiency</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_historical_efficiency</span><span class=p>(</span><span class=n>cycle_id</span><span class=p>)</span>
</span><span id=__span-1-103><a id=__codelineno-1-103 name=__codelineno-1-103></a><a href=#__codelineno-1-103><span class=linenos data-linenos="103 "></span></a>        <span class=k>if</span> <span class=n>historical_efficiency</span> <span class=o>&gt;</span> <span class=mf>0.9</span><span class=p>:</span>  <span class=c1># Very efficient usage</span>
</span><span id=__span-1-104><a id=__codelineno-1-104 name=__codelineno-1-104></a><a href=#__codelineno-1-104><span class=linenos data-linenos="104 "></span></a>            <span class=n>adjustments</span><span class=o>.</span><span class=n>tokens</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>adjustments</span><span class=o>.</span><span class=n>tokens</span> <span class=o>*</span> <span class=mf>0.95</span><span class=p>)</span>  <span class=c1># Slightly reduce</span>
</span><span id=__span-1-105><a id=__codelineno-1-105 name=__codelineno-1-105></a><a href=#__codelineno-1-105><span class=linenos data-linenos="105 "></span></a>        <span class=k>elif</span> <span class=n>historical_efficiency</span> <span class=o>&lt;</span> <span class=mf>0.6</span><span class=p>:</span>  <span class=c1># Inefficient usage</span>
</span><span id=__span-1-106><a id=__codelineno-1-106 name=__codelineno-1-106></a><a href=#__codelineno-1-106><span class=linenos data-linenos="106 "></span></a>            <span class=n>adjustments</span><span class=o>.</span><span class=n>tokens</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>adjustments</span><span class=o>.</span><span class=n>tokens</span> <span class=o>*</span> <span class=mf>1.05</span><span class=p>)</span>  <span class=c1># Slightly increase</span>
</span><span id=__span-1-107><a id=__codelineno-1-107 name=__codelineno-1-107></a><a href=#__codelineno-1-107><span class=linenos data-linenos="107 "></span></a>            
</span><span id=__span-1-108><a id=__codelineno-1-108 name=__codelineno-1-108></a><a href=#__codelineno-1-108><span class=linenos data-linenos="108 "></span></a>        <span class=k>return</span> <span class=n>adjustments</span>
</span><span id=__span-1-109><a id=__codelineno-1-109 name=__codelineno-1-109></a><a href=#__codelineno-1-109><span class=linenos data-linenos="109 "></span></a>        
</span><span id=__span-1-110><a id=__codelineno-1-110 name=__codelineno-1-110></a><a href=#__codelineno-1-110><span class=linenos data-linenos="110 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>rebalance_budgets</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>RebalancingResult</span><span class=p>:</span>
</span><span id=__span-1-111><a id=__codelineno-1-111 name=__codelineno-1-111></a><a href=#__codelineno-1-111><span class=linenos data-linenos="111 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Dynamically rebalance token budgets across active cycles&quot;&quot;&quot;</span>
</span><span id=__span-1-112><a id=__codelineno-1-112 name=__codelineno-1-112></a><a href=#__codelineno-1-112><span class=linenos data-linenos="112 "></span></a>        
</span><span id=__span-1-113><a id=__codelineno-1-113 name=__codelineno-1-113></a><a href=#__codelineno-1-113><span class=linenos data-linenos="113 "></span></a>        <span class=c1># Analyze current usage patterns</span>
</span><span id=__span-1-114><a id=__codelineno-1-114 name=__codelineno-1-114></a><a href=#__codelineno-1-114><span class=linenos data-linenos="114 "></span></a>        <span class=n>usage_analysis</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_analyze_current_usage</span><span class=p>()</span>
</span><span id=__span-1-115><a id=__codelineno-1-115 name=__codelineno-1-115></a><a href=#__codelineno-1-115><span class=linenos data-linenos="115 "></span></a>        
</span><span id=__span-1-116><a id=__codelineno-1-116 name=__codelineno-1-116></a><a href=#__codelineno-1-116><span class=linenos data-linenos="116 "></span></a>        <span class=c1># Identify rebalancing opportunities</span>
</span><span id=__span-1-117><a id=__codelineno-1-117 name=__codelineno-1-117></a><a href=#__codelineno-1-117><span class=linenos data-linenos="117 "></span></a>        <span class=n>opportunities</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_identify_rebalancing_opportunities</span><span class=p>(</span><span class=n>usage_analysis</span><span class=p>)</span>
</span><span id=__span-1-118><a id=__codelineno-1-118 name=__codelineno-1-118></a><a href=#__codelineno-1-118><span class=linenos data-linenos="118 "></span></a>        
</span><span id=__span-1-119><a id=__codelineno-1-119 name=__codelineno-1-119></a><a href=#__codelineno-1-119><span class=linenos data-linenos="119 "></span></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>opportunities</span><span class=p>:</span>
</span><span id=__span-1-120><a id=__codelineno-1-120 name=__codelineno-1-120></a><a href=#__codelineno-1-120><span class=linenos data-linenos="120 "></span></a>            <span class=k>return</span> <span class=n>RebalancingResult</span><span class=p>(</span><span class=n>rebalanced</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>reason</span><span class=o>=</span><span class=s2>&quot;No opportunities found&quot;</span><span class=p>)</span>
</span><span id=__span-1-121><a id=__codelineno-1-121 name=__codelineno-1-121></a><a href=#__codelineno-1-121><span class=linenos data-linenos="121 "></span></a>            
</span><span id=__span-1-122><a id=__codelineno-1-122 name=__codelineno-1-122></a><a href=#__codelineno-1-122><span class=linenos data-linenos="122 "></span></a>        <span class=c1># Execute rebalancing</span>
</span><span id=__span-1-123><a id=__codelineno-1-123 name=__codelineno-1-123></a><a href=#__codelineno-1-123><span class=linenos data-linenos="123 "></span></a>        <span class=n>rebalancing_plan</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_create_rebalancing_plan</span><span class=p>(</span><span class=n>opportunities</span><span class=p>)</span>
</span><span id=__span-1-124><a id=__codelineno-1-124 name=__codelineno-1-124></a><a href=#__codelineno-1-124><span class=linenos data-linenos="124 "></span></a>        <span class=n>results</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_rebalancing</span><span class=p>(</span><span class=n>rebalancing_plan</span><span class=p>)</span>
</span><span id=__span-1-125><a id=__codelineno-1-125 name=__codelineno-1-125></a><a href=#__codelineno-1-125><span class=linenos data-linenos="125 "></span></a>        
</span><span id=__span-1-126><a id=__codelineno-1-126 name=__codelineno-1-126></a><a href=#__codelineno-1-126><span class=linenos data-linenos="126 "></span></a>        <span class=k>return</span> <span class=n>RebalancingResult</span><span class=p>(</span>
</span><span id=__span-1-127><a id=__codelineno-1-127 name=__codelineno-1-127></a><a href=#__codelineno-1-127><span class=linenos data-linenos="127 "></span></a>            <span class=n>rebalanced</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-1-128><a id=__codelineno-1-128 name=__codelineno-1-128></a><a href=#__codelineno-1-128><span class=linenos data-linenos="128 "></span></a>            <span class=n>cycles_adjusted</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>results</span><span class=p>),</span>
</span><span id=__span-1-129><a id=__codelineno-1-129 name=__codelineno-1-129></a><a href=#__codelineno-1-129><span class=linenos data-linenos="129 "></span></a>            <span class=n>tokens_redistributed</span><span class=o>=</span><span class=nb>sum</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>tokens_moved</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>results</span><span class=p>),</span>
</span><span id=__span-1-130><a id=__codelineno-1-130 name=__codelineno-1-130></a><a href=#__codelineno-1-130><span class=linenos data-linenos="130 "></span></a>            <span class=n>efficiency_improvement</span><span class=o>=</span><span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_efficiency_improvement</span><span class=p>(</span><span class=n>results</span><span class=p>)</span>
</span><span id=__span-1-131><a id=__codelineno-1-131 name=__codelineno-1-131></a><a href=#__codelineno-1-131><span class=linenos data-linenos="131 "></span></a>        <span class=p>)</span>
</span><span id=__span-1-132><a id=__codelineno-1-132 name=__codelineno-1-132></a><a href=#__codelineno-1-132><span class=linenos data-linenos="132 "></span></a>        
</span><span id=__span-1-133><a id=__codelineno-1-133 name=__codelineno-1-133></a><a href=#__codelineno-1-133><span class=linenos data-linenos="133 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>_identify_rebalancing_opportunities</span><span class=p>(</span>
</span><span id=__span-1-134><a id=__codelineno-1-134 name=__codelineno-1-134></a><a href=#__codelineno-1-134><span class=linenos data-linenos="134 "></span></a>        <span class=bp>self</span><span class=p>,</span> 
</span><span id=__span-1-135><a id=__codelineno-1-135 name=__codelineno-1-135></a><a href=#__codelineno-1-135><span class=linenos data-linenos="135 "></span></a>        <span class=n>usage_analysis</span><span class=p>:</span> <span class=n>UsageAnalysis</span>
</span><span id=__span-1-136><a id=__codelineno-1-136 name=__codelineno-1-136></a><a href=#__codelineno-1-136><span class=linenos data-linenos="136 "></span></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>RebalancingOpportunity</span><span class=p>]:</span>
</span><span id=__span-1-137><a id=__codelineno-1-137 name=__codelineno-1-137></a><a href=#__codelineno-1-137><span class=linenos data-linenos="137 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Identify token budget rebalancing opportunities&quot;&quot;&quot;</span>
</span><span id=__span-1-138><a id=__codelineno-1-138 name=__codelineno-1-138></a><a href=#__codelineno-1-138><span class=linenos data-linenos="138 "></span></a>        <span class=n>opportunities</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-1-139><a id=__codelineno-1-139 name=__codelineno-1-139></a><a href=#__codelineno-1-139><span class=linenos data-linenos="139 "></span></a>        
</span><span id=__span-1-140><a id=__codelineno-1-140 name=__codelineno-1-140></a><a href=#__codelineno-1-140><span class=linenos data-linenos="140 "></span></a>        <span class=k>for</span> <span class=n>cycle_id</span><span class=p>,</span> <span class=n>usage</span> <span class=ow>in</span> <span class=n>usage_analysis</span><span class=o>.</span><span class=n>cycle_usage</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span><span id=__span-1-141><a id=__codelineno-1-141 name=__codelineno-1-141></a><a href=#__codelineno-1-141><span class=linenos data-linenos="141 "></span></a>            <span class=n>allocation</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>allocations</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>cycle_id</span><span class=p>)</span>
</span><span id=__span-1-142><a id=__codelineno-1-142 name=__codelineno-1-142></a><a href=#__codelineno-1-142><span class=linenos data-linenos="142 "></span></a>            <span class=k>if</span> <span class=ow>not</span> <span class=n>allocation</span><span class=p>:</span>
</span><span id=__span-1-143><a id=__codelineno-1-143 name=__codelineno-1-143></a><a href=#__codelineno-1-143><span class=linenos data-linenos="143 "></span></a>                <span class=k>continue</span>
</span><span id=__span-1-144><a id=__codelineno-1-144 name=__codelineno-1-144></a><a href=#__codelineno-1-144><span class=linenos data-linenos="144 "></span></a>                
</span><span id=__span-1-145><a id=__codelineno-1-145 name=__codelineno-1-145></a><a href=#__codelineno-1-145><span class=linenos data-linenos="145 "></span></a>            <span class=c1># Over-allocated cycles (using much less than allocated)</span>
</span><span id=__span-1-146><a id=__codelineno-1-146 name=__codelineno-1-146></a><a href=#__codelineno-1-146><span class=linenos data-linenos="146 "></span></a>            <span class=k>if</span> <span class=n>usage</span><span class=o>.</span><span class=n>efficiency</span> <span class=o>&lt;</span> <span class=mf>0.4</span><span class=p>:</span>  <span class=c1># Using less than 40% efficiently</span>
</span><span id=__span-1-147><a id=__codelineno-1-147 name=__codelineno-1-147></a><a href=#__codelineno-1-147><span class=linenos data-linenos="147 "></span></a>                <span class=n>tokens_to_free</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>allocation</span><span class=o>.</span><span class=n>allocated_tokens</span> <span class=o>*</span> <span class=mf>0.3</span><span class=p>)</span>
</span><span id=__span-1-148><a id=__codelineno-1-148 name=__codelineno-1-148></a><a href=#__codelineno-1-148><span class=linenos data-linenos="148 "></span></a>                <span class=n>opportunities</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>RebalancingOpportunity</span><span class=p>(</span>
</span><span id=__span-1-149><a id=__codelineno-1-149 name=__codelineno-1-149></a><a href=#__codelineno-1-149><span class=linenos data-linenos="149 "></span></a>                    <span class=n>cycle_id</span><span class=o>=</span><span class=n>cycle_id</span><span class=p>,</span>
</span><span id=__span-1-150><a id=__codelineno-1-150 name=__codelineno-1-150></a><a href=#__codelineno-1-150><span class=linenos data-linenos="150 "></span></a>                    <span class=nb>type</span><span class=o>=</span><span class=n>RebalancingType</span><span class=o>.</span><span class=n>REDUCE_ALLOCATION</span><span class=p>,</span>
</span><span id=__span-1-151><a id=__codelineno-1-151 name=__codelineno-1-151></a><a href=#__codelineno-1-151><span class=linenos data-linenos="151 "></span></a>                    <span class=n>tokens_available</span><span class=o>=</span><span class=n>tokens_to_free</span><span class=p>,</span>
</span><span id=__span-1-152><a id=__codelineno-1-152 name=__codelineno-1-152></a><a href=#__codelineno-1-152><span class=linenos data-linenos="152 "></span></a>                    <span class=n>confidence</span><span class=o>=</span><span class=mf>0.8</span><span class=p>,</span>
</span><span id=__span-1-153><a id=__codelineno-1-153 name=__codelineno-1-153></a><a href=#__codelineno-1-153><span class=linenos data-linenos="153 "></span></a>                    <span class=n>reason</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;Low efficiency: </span><span class=si>{</span><span class=n>usage</span><span class=o>.</span><span class=n>efficiency</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-1-154><a id=__codelineno-1-154 name=__codelineno-1-154></a><a href=#__codelineno-1-154><span class=linenos data-linenos="154 "></span></a>                <span class=p>))</span>
</span><span id=__span-1-155><a id=__codelineno-1-155 name=__codelineno-1-155></a><a href=#__codelineno-1-155><span class=linenos data-linenos="155 "></span></a>                
</span><span id=__span-1-156><a id=__codelineno-1-156 name=__codelineno-1-156></a><a href=#__codelineno-1-156><span class=linenos data-linenos="156 "></span></a>            <span class=c1># Under-allocated cycles (running out of tokens)</span>
</span><span id=__span-1-157><a id=__codelineno-1-157 name=__codelineno-1-157></a><a href=#__codelineno-1-157><span class=linenos data-linenos="157 "></span></a>            <span class=k>elif</span> <span class=n>usage</span><span class=o>.</span><span class=n>utilization</span> <span class=o>&gt;</span> <span class=mf>0.9</span><span class=p>:</span>  <span class=c1># Using more than 90% of allocation</span>
</span><span id=__span-1-158><a id=__codelineno-1-158 name=__codelineno-1-158></a><a href=#__codelineno-1-158><span class=linenos data-linenos="158 "></span></a>                <span class=n>tokens_needed</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>allocation</span><span class=o>.</span><span class=n>allocated_tokens</span> <span class=o>*</span> <span class=mf>0.4</span><span class=p>)</span>
</span><span id=__span-1-159><a id=__codelineno-1-159 name=__codelineno-1-159></a><a href=#__codelineno-1-159><span class=linenos data-linenos="159 "></span></a>                <span class=n>opportunities</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>RebalancingOpportunity</span><span class=p>(</span>
</span><span id=__span-1-160><a id=__codelineno-1-160 name=__codelineno-1-160></a><a href=#__codelineno-1-160><span class=linenos data-linenos="160 "></span></a>                    <span class=n>cycle_id</span><span class=o>=</span><span class=n>cycle_id</span><span class=p>,</span>
</span><span id=__span-1-161><a id=__codelineno-1-161 name=__codelineno-1-161></a><a href=#__codelineno-1-161><span class=linenos data-linenos="161 "></span></a>                    <span class=nb>type</span><span class=o>=</span><span class=n>RebalancingType</span><span class=o>.</span><span class=n>INCREASE_ALLOCATION</span><span class=p>,</span>
</span><span id=__span-1-162><a id=__codelineno-1-162 name=__codelineno-1-162></a><a href=#__codelineno-1-162><span class=linenos data-linenos="162 "></span></a>                    <span class=n>tokens_needed</span><span class=o>=</span><span class=n>tokens_needed</span><span class=p>,</span>
</span><span id=__span-1-163><a id=__codelineno-1-163 name=__codelineno-1-163></a><a href=#__codelineno-1-163><span class=linenos data-linenos="163 "></span></a>                    <span class=n>confidence</span><span class=o>=</span><span class=mf>0.9</span><span class=p>,</span>
</span><span id=__span-1-164><a id=__codelineno-1-164 name=__codelineno-1-164></a><a href=#__codelineno-1-164><span class=linenos data-linenos="164 "></span></a>                    <span class=n>reason</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;High utilization: </span><span class=si>{</span><span class=n>usage</span><span class=o>.</span><span class=n>utilization</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-1-165><a id=__codelineno-1-165 name=__codelineno-1-165></a><a href=#__codelineno-1-165><span class=linenos data-linenos="165 "></span></a>                <span class=p>))</span>
</span><span id=__span-1-166><a id=__codelineno-1-166 name=__codelineno-1-166></a><a href=#__codelineno-1-166><span class=linenos data-linenos="166 "></span></a>                
</span><span id=__span-1-167><a id=__codelineno-1-167 name=__codelineno-1-167></a><a href=#__codelineno-1-167><span class=linenos data-linenos="167 "></span></a>        <span class=k>return</span> <span class=n>opportunities</span>
</span><span id=__span-1-168><a id=__codelineno-1-168 name=__codelineno-1-168></a><a href=#__codelineno-1-168><span class=linenos data-linenos="168 "></span></a>
</span><span id=__span-1-169><a id=__codelineno-1-169 name=__codelineno-1-169></a><a href=#__codelineno-1-169><span class=linenos data-linenos="169 "></span></a><span class=k>class</span><span class=w> </span><span class=nc>TokenUsagePredictionModel</span><span class=p>:</span>
</span><span id=__span-1-170><a id=__codelineno-1-170 name=__codelineno-1-170></a><a href=#__codelineno-1-170><span class=linenos data-linenos="170 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;ML-based prediction of token usage for cycles&quot;&quot;&quot;</span>
</span><span id=__span-1-171><a id=__codelineno-1-171 name=__codelineno-1-171></a><a href=#__codelineno-1-171><span class=linenos data-linenos="171 "></span></a>    
</span><span id=__span-1-172><a id=__codelineno-1-172 name=__codelineno-1-172></a><a href=#__codelineno-1-172><span class=linenos data-linenos="172 "></span></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-1-173><a id=__codelineno-1-173 name=__codelineno-1-173></a><a href=#__codelineno-1-173><span class=linenos data-linenos="173 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>usage_model</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_usage_model</span><span class=p>()</span>
</span><span id=__span-1-174><a id=__codelineno-1-174 name=__codelineno-1-174></a><a href=#__codelineno-1-174><span class=linenos data-linenos="174 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>feature_extractor</span> <span class=o>=</span> <span class=n>TokenUsageFeatureExtractor</span><span class=p>()</span>
</span><span id=__span-1-175><a id=__codelineno-1-175 name=__codelineno-1-175></a><a href=#__codelineno-1-175><span class=linenos data-linenos="175 "></span></a>        
</span><span id=__span-1-176><a id=__codelineno-1-176 name=__codelineno-1-176></a><a href=#__codelineno-1-176><span class=linenos data-linenos="176 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>predict_cycle_usage</span><span class=p>(</span>
</span><span id=__span-1-177><a id=__codelineno-1-177 name=__codelineno-1-177></a><a href=#__codelineno-1-177><span class=linenos data-linenos="177 "></span></a>        <span class=bp>self</span><span class=p>,</span> 
</span><span id=__span-1-178><a id=__codelineno-1-178 name=__codelineno-1-178></a><a href=#__codelineno-1-178><span class=linenos data-linenos="178 "></span></a>        <span class=n>cycle_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> 
</span><span id=__span-1-179><a id=__codelineno-1-179 name=__codelineno-1-179></a><a href=#__codelineno-1-179><span class=linenos data-linenos="179 "></span></a>        <span class=n>parallel_group</span><span class=p>:</span> <span class=n>ParallelGroup</span>
</span><span id=__span-1-180><a id=__codelineno-1-180 name=__codelineno-1-180></a><a href=#__codelineno-1-180><span class=linenos data-linenos="180 "></span></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>PredictedUsage</span><span class=p>:</span>
</span><span id=__span-1-181><a id=__codelineno-1-181 name=__codelineno-1-181></a><a href=#__codelineno-1-181><span class=linenos data-linenos="181 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Predict token usage for a cycle&quot;&quot;&quot;</span>
</span><span id=__span-1-182><a id=__codelineno-1-182 name=__codelineno-1-182></a><a href=#__codelineno-1-182><span class=linenos data-linenos="182 "></span></a>        
</span><span id=__span-1-183><a id=__codelineno-1-183 name=__codelineno-1-183></a><a href=#__codelineno-1-183><span class=linenos data-linenos="183 "></span></a>        <span class=c1># Extract features for prediction</span>
</span><span id=__span-1-184><a id=__codelineno-1-184 name=__codelineno-1-184></a><a href=#__codelineno-1-184><span class=linenos data-linenos="184 "></span></a>        <span class=n>features</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>feature_extractor</span><span class=o>.</span><span class=n>extract_features</span><span class=p>(</span>
</span><span id=__span-1-185><a id=__codelineno-1-185 name=__codelineno-1-185></a><a href=#__codelineno-1-185><span class=linenos data-linenos="185 "></span></a>            <span class=n>cycle_id</span><span class=p>,</span> <span class=n>parallel_group</span>
</span><span id=__span-1-186><a id=__codelineno-1-186 name=__codelineno-1-186></a><a href=#__codelineno-1-186><span class=linenos data-linenos="186 "></span></a>        <span class=p>)</span>
</span><span id=__span-1-187><a id=__codelineno-1-187 name=__codelineno-1-187></a><a href=#__codelineno-1-187><span class=linenos data-linenos="187 "></span></a>        
</span><span id=__span-1-188><a id=__codelineno-1-188 name=__codelineno-1-188></a><a href=#__codelineno-1-188><span class=linenos data-linenos="188 "></span></a>        <span class=c1># Predict different aspects of usage</span>
</span><span id=__span-1-189><a id=__codelineno-1-189 name=__codelineno-1-189></a><a href=#__codelineno-1-189><span class=linenos data-linenos="189 "></span></a>        <span class=n>total_usage</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>usage_model</span><span class=o>.</span><span class=n>total_usage</span><span class=o>.</span><span class=n>predict</span><span class=p>([</span><span class=n>features</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-1-190><a id=__codelineno-1-190 name=__codelineno-1-190></a><a href=#__codelineno-1-190><span class=linenos data-linenos="190 "></span></a>        <span class=n>peak_usage</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>usage_model</span><span class=o>.</span><span class=n>peak_usage</span><span class=o>.</span><span class=n>predict</span><span class=p>([</span><span class=n>features</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-1-191><a id=__codelineno-1-191 name=__codelineno-1-191></a><a href=#__codelineno-1-191><span class=linenos data-linenos="191 "></span></a>        <span class=n>phase_distribution</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>usage_model</span><span class=o>.</span><span class=n>phase_distribution</span><span class=o>.</span><span class=n>predict</span><span class=p>([</span><span class=n>features</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-1-192><a id=__codelineno-1-192 name=__codelineno-1-192></a><a href=#__codelineno-1-192><span class=linenos data-linenos="192 "></span></a>        
</span><span id=__span-1-193><a id=__codelineno-1-193 name=__codelineno-1-193></a><a href=#__codelineno-1-193><span class=linenos data-linenos="193 "></span></a>        <span class=k>return</span> <span class=n>PredictedUsage</span><span class=p>(</span>
</span><span id=__span-1-194><a id=__codelineno-1-194 name=__codelineno-1-194></a><a href=#__codelineno-1-194><span class=linenos data-linenos="194 "></span></a>            <span class=n>total_tokens</span><span class=o>=</span><span class=nb>int</span><span class=p>(</span><span class=n>total_usage</span><span class=p>),</span>
</span><span id=__span-1-195><a id=__codelineno-1-195 name=__codelineno-1-195></a><a href=#__codelineno-1-195><span class=linenos data-linenos="195 "></span></a>            <span class=n>peak_tokens_per_hour</span><span class=o>=</span><span class=nb>int</span><span class=p>(</span><span class=n>peak_usage</span><span class=p>),</span>
</span><span id=__span-1-196><a id=__codelineno-1-196 name=__codelineno-1-196></a><a href=#__codelineno-1-196><span class=linenos data-linenos="196 "></span></a>            <span class=n>phase_distribution</span><span class=o>=</span><span class=nb>dict</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span>
</span><span id=__span-1-197><a id=__codelineno-1-197 name=__codelineno-1-197></a><a href=#__codelineno-1-197><span class=linenos data-linenos="197 "></span></a>                <span class=p>[</span><span class=n>s</span><span class=o>.</span><span class=n>value</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>TDDState</span><span class=p>],</span> 
</span><span id=__span-1-198><a id=__codelineno-1-198 name=__codelineno-1-198></a><a href=#__codelineno-1-198><span class=linenos data-linenos="198 "></span></a>                <span class=n>phase_distribution</span>
</span><span id=__span-1-199><a id=__codelineno-1-199 name=__codelineno-1-199></a><a href=#__codelineno-1-199><span class=linenos data-linenos="199 "></span></a>            <span class=p>)),</span>
</span><span id=__span-1-200><a id=__codelineno-1-200 name=__codelineno-1-200></a><a href=#__codelineno-1-200><span class=linenos data-linenos="200 "></span></a>            <span class=n>confidence</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>usage_model</span><span class=o>.</span><span class=n>confidence_score</span><span class=p>([</span><span class=n>features</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-1-201><a id=__codelineno-1-201 name=__codelineno-1-201></a><a href=#__codelineno-1-201><span class=linenos data-linenos="201 "></span></a>        <span class=p>)</span>
</span><span id=__span-1-202><a id=__codelineno-1-202 name=__codelineno-1-202></a><a href=#__codelineno-1-202><span class=linenos data-linenos="202 "></span></a>
</span><span id=__span-1-203><a id=__codelineno-1-203 name=__codelineno-1-203></a><a href=#__codelineno-1-203><span class=linenos data-linenos="203 "></span></a><span class=k>class</span><span class=w> </span><span class=nc>TokenUsageFeatureExtractor</span><span class=p>:</span>
</span><span id=__span-1-204><a id=__codelineno-1-204 name=__codelineno-1-204></a><a href=#__codelineno-1-204><span class=linenos data-linenos="204 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Extract features for token usage prediction&quot;&quot;&quot;</span>
</span><span id=__span-1-205><a id=__codelineno-1-205 name=__codelineno-1-205></a><a href=#__codelineno-1-205><span class=linenos data-linenos="205 "></span></a>    
</span><span id=__span-1-206><a id=__codelineno-1-206 name=__codelineno-1-206></a><a href=#__codelineno-1-206><span class=linenos data-linenos="206 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>extract_features</span><span class=p>(</span>
</span><span id=__span-1-207><a id=__codelineno-1-207 name=__codelineno-1-207></a><a href=#__codelineno-1-207><span class=linenos data-linenos="207 "></span></a>        <span class=bp>self</span><span class=p>,</span> 
</span><span id=__span-1-208><a id=__codelineno-1-208 name=__codelineno-1-208></a><a href=#__codelineno-1-208><span class=linenos data-linenos="208 "></span></a>        <span class=n>cycle_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> 
</span><span id=__span-1-209><a id=__codelineno-1-209 name=__codelineno-1-209></a><a href=#__codelineno-1-209><span class=linenos data-linenos="209 "></span></a>        <span class=n>parallel_group</span><span class=p>:</span> <span class=n>ParallelGroup</span>
</span><span id=__span-1-210><a id=__codelineno-1-210 name=__codelineno-1-210></a><a href=#__codelineno-1-210><span class=linenos data-linenos="210 "></span></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span><span id=__span-1-211><a id=__codelineno-1-211 name=__codelineno-1-211></a><a href=#__codelineno-1-211><span class=linenos data-linenos="211 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Extract feature vector for usage prediction&quot;&quot;&quot;</span>
</span><span id=__span-1-212><a id=__codelineno-1-212 name=__codelineno-1-212></a><a href=#__codelineno-1-212><span class=linenos data-linenos="212 "></span></a>        <span class=n>features</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-1-213><a id=__codelineno-1-213 name=__codelineno-1-213></a><a href=#__codelineno-1-213><span class=linenos data-linenos="213 "></span></a>        
</span><span id=__span-1-214><a id=__codelineno-1-214 name=__codelineno-1-214></a><a href=#__codelineno-1-214><span class=linenos data-linenos="214 "></span></a>        <span class=c1># Story characteristics</span>
</span><span id=__span-1-215><a id=__codelineno-1-215 name=__codelineno-1-215></a><a href=#__codelineno-1-215><span class=linenos data-linenos="215 "></span></a>        <span class=n>story</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_story_for_cycle</span><span class=p>(</span><span class=n>cycle_id</span><span class=p>)</span>
</span><span id=__span-1-216><a id=__codelineno-1-216 name=__codelineno-1-216></a><a href=#__codelineno-1-216><span class=linenos data-linenos="216 "></span></a>        <span class=n>features</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span>
</span><span id=__span-1-217><a id=__codelineno-1-217 name=__codelineno-1-217></a><a href=#__codelineno-1-217><span class=linenos data-linenos="217 "></span></a>            <span class=nb>len</span><span class=p>(</span><span class=n>story</span><span class=o>.</span><span class=n>description</span><span class=p>),</span>
</span><span id=__span-1-218><a id=__codelineno-1-218 name=__codelineno-1-218></a><a href=#__codelineno-1-218><span class=linenos data-linenos="218 "></span></a>            <span class=nb>len</span><span class=p>(</span><span class=n>story</span><span class=o>.</span><span class=n>acceptance_criteria</span><span class=p>),</span>
</span><span id=__span-1-219><a id=__codelineno-1-219 name=__codelineno-1-219></a><a href=#__codelineno-1-219><span class=linenos data-linenos="219 "></span></a>            <span class=n>story</span><span class=o>.</span><span class=n>story_points</span> <span class=ow>or</span> <span class=mi>3</span><span class=p>,</span>  <span class=c1># Default to 3 if not set</span>
</span><span id=__span-1-220><a id=__codelineno-1-220 name=__codelineno-1-220></a><a href=#__codelineno-1-220><span class=linenos data-linenos="220 "></span></a>            <span class=nb>len</span><span class=p>(</span><span class=n>story</span><span class=o>.</span><span class=n>files</span> <span class=ow>or</span> <span class=p>[]),</span>
</span><span id=__span-1-221><a id=__codelineno-1-221 name=__codelineno-1-221></a><a href=#__codelineno-1-221><span class=linenos data-linenos="221 "></span></a>            <span class=n>story</span><span class=o>.</span><span class=n>priority</span>
</span><span id=__span-1-222><a id=__codelineno-1-222 name=__codelineno-1-222></a><a href=#__codelineno-1-222><span class=linenos data-linenos="222 "></span></a>        <span class=p>])</span>
</span><span id=__span-1-223><a id=__codelineno-1-223 name=__codelineno-1-223></a><a href=#__codelineno-1-223><span class=linenos data-linenos="223 "></span></a>        
</span><span id=__span-1-224><a id=__codelineno-1-224 name=__codelineno-1-224></a><a href=#__codelineno-1-224><span class=linenos data-linenos="224 "></span></a>        <span class=c1># Code complexity features</span>
</span><span id=__span-1-225><a id=__codelineno-1-225 name=__codelineno-1-225></a><a href=#__codelineno-1-225><span class=linenos data-linenos="225 "></span></a>        <span class=k>if</span> <span class=n>story</span><span class=o>.</span><span class=n>files</span><span class=p>:</span>
</span><span id=__span-1-226><a id=__codelineno-1-226 name=__codelineno-1-226></a><a href=#__codelineno-1-226><span class=linenos data-linenos="226 "></span></a>            <span class=n>complexity</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_analyze_code_complexity</span><span class=p>(</span><span class=n>story</span><span class=o>.</span><span class=n>files</span><span class=p>)</span>
</span><span id=__span-1-227><a id=__codelineno-1-227 name=__codelineno-1-227></a><a href=#__codelineno-1-227><span class=linenos data-linenos="227 "></span></a>            <span class=n>features</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span>
</span><span id=__span-1-228><a id=__codelineno-1-228 name=__codelineno-1-228></a><a href=#__codelineno-1-228><span class=linenos data-linenos="228 "></span></a>                <span class=n>complexity</span><span class=o>.</span><span class=n>cyclomatic_complexity</span><span class=p>,</span>
</span><span id=__span-1-229><a id=__codelineno-1-229 name=__codelineno-1-229></a><a href=#__codelineno-1-229><span class=linenos data-linenos="229 "></span></a>                <span class=n>complexity</span><span class=o>.</span><span class=n>lines_of_code</span><span class=p>,</span>
</span><span id=__span-1-230><a id=__codelineno-1-230 name=__codelineno-1-230></a><a href=#__codelineno-1-230><span class=linenos data-linenos="230 "></span></a>                <span class=n>complexity</span><span class=o>.</span><span class=n>function_count</span><span class=p>,</span>
</span><span id=__span-1-231><a id=__codelineno-1-231 name=__codelineno-1-231></a><a href=#__codelineno-1-231><span class=linenos data-linenos="231 "></span></a>                <span class=n>complexity</span><span class=o>.</span><span class=n>class_count</span>
</span><span id=__span-1-232><a id=__codelineno-1-232 name=__codelineno-1-232></a><a href=#__codelineno-1-232><span class=linenos data-linenos="232 "></span></a>            <span class=p>])</span>
</span><span id=__span-1-233><a id=__codelineno-1-233 name=__codelineno-1-233></a><a href=#__codelineno-1-233><span class=linenos data-linenos="233 "></span></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-1-234><a id=__codelineno-1-234 name=__codelineno-1-234></a><a href=#__codelineno-1-234><span class=linenos data-linenos="234 "></span></a>            <span class=n>features</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>])</span>  <span class=c1># Default values</span>
</span><span id=__span-1-235><a id=__codelineno-1-235 name=__codelineno-1-235></a><a href=#__codelineno-1-235><span class=linenos data-linenos="235 "></span></a>            
</span><span id=__span-1-236><a id=__codelineno-1-236 name=__codelineno-1-236></a><a href=#__codelineno-1-236><span class=linenos data-linenos="236 "></span></a>        <span class=c1># Parallel context features</span>
</span><span id=__span-1-237><a id=__codelineno-1-237 name=__codelineno-1-237></a><a href=#__codelineno-1-237><span class=linenos data-linenos="237 "></span></a>        <span class=n>features</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span>
</span><span id=__span-1-238><a id=__codelineno-1-238 name=__codelineno-1-238></a><a href=#__codelineno-1-238><span class=linenos data-linenos="238 "></span></a>            <span class=nb>len</span><span class=p>(</span><span class=n>parallel_group</span><span class=o>.</span><span class=n>cycles</span><span class=p>),</span>
</span><span id=__span-1-239><a id=__codelineno-1-239 name=__codelineno-1-239></a><a href=#__codelineno-1-239><span class=linenos data-linenos="239 "></span></a>            <span class=n>parallel_group</span><span class=o>.</span><span class=n>conflict_risk_score</span><span class=p>,</span>
</span><span id=__span-1-240><a id=__codelineno-1-240 name=__codelineno-1-240></a><a href=#__codelineno-1-240><span class=linenos data-linenos="240 "></span></a>            <span class=mi>1</span> <span class=k>if</span> <span class=n>parallel_group</span><span class=o>.</span><span class=n>requires_coordination</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span><span id=__span-1-241><a id=__codelineno-1-241 name=__codelineno-1-241></a><a href=#__codelineno-1-241><span class=linenos data-linenos="241 "></span></a>            <span class=n>parallel_group</span><span class=o>.</span><span class=n>shared_file_count</span>
</span><span id=__span-1-242><a id=__codelineno-1-242 name=__codelineno-1-242></a><a href=#__codelineno-1-242><span class=linenos data-linenos="242 "></span></a>        <span class=p>])</span>
</span><span id=__span-1-243><a id=__codelineno-1-243 name=__codelineno-1-243></a><a href=#__codelineno-1-243><span class=linenos data-linenos="243 "></span></a>        
</span><span id=__span-1-244><a id=__codelineno-1-244 name=__codelineno-1-244></a><a href=#__codelineno-1-244><span class=linenos data-linenos="244 "></span></a>        <span class=c1># Historical features</span>
</span><span id=__span-1-245><a id=__codelineno-1-245 name=__codelineno-1-245></a><a href=#__codelineno-1-245><span class=linenos data-linenos="245 "></span></a>        <span class=n>historical_usage</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_historical_usage</span><span class=p>(</span><span class=n>cycle_id</span><span class=p>)</span>
</span><span id=__span-1-246><a id=__codelineno-1-246 name=__codelineno-1-246></a><a href=#__codelineno-1-246><span class=linenos data-linenos="246 "></span></a>        <span class=n>features</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span>
</span><span id=__span-1-247><a id=__codelineno-1-247 name=__codelineno-1-247></a><a href=#__codelineno-1-247><span class=linenos data-linenos="247 "></span></a>            <span class=n>historical_usage</span><span class=o>.</span><span class=n>average_total_usage</span><span class=p>,</span>
</span><span id=__span-1-248><a id=__codelineno-1-248 name=__codelineno-1-248></a><a href=#__codelineno-1-248><span class=linenos data-linenos="248 "></span></a>            <span class=n>historical_usage</span><span class=o>.</span><span class=n>average_efficiency</span><span class=p>,</span>
</span><span id=__span-1-249><a id=__codelineno-1-249 name=__codelineno-1-249></a><a href=#__codelineno-1-249><span class=linenos data-linenos="249 "></span></a>            <span class=n>historical_usage</span><span class=o>.</span><span class=n>completion_rate</span>
</span><span id=__span-1-250><a id=__codelineno-1-250 name=__codelineno-1-250></a><a href=#__codelineno-1-250><span class=linenos data-linenos="250 "></span></a>        <span class=p>])</span>
</span><span id=__span-1-251><a id=__codelineno-1-251 name=__codelineno-1-251></a><a href=#__codelineno-1-251><span class=linenos data-linenos="251 "></span></a>        
</span><span id=__span-1-252><a id=__codelineno-1-252 name=__codelineno-1-252></a><a href=#__codelineno-1-252><span class=linenos data-linenos="252 "></span></a>        <span class=c1># Temporal features</span>
</span><span id=__span-1-253><a id=__codelineno-1-253 name=__codelineno-1-253></a><a href=#__codelineno-1-253><span class=linenos data-linenos="253 "></span></a>        <span class=n>features</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span>
</span><span id=__span-1-254><a id=__codelineno-1-254 name=__codelineno-1-254></a><a href=#__codelineno-1-254><span class=linenos data-linenos="254 "></span></a>            <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>hour</span><span class=p>,</span>  <span class=c1># Time of day</span>
</span><span id=__span-1-255><a id=__codelineno-1-255 name=__codelineno-1-255></a><a href=#__codelineno-1-255><span class=linenos data-linenos="255 "></span></a>            <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>weekday</span><span class=p>(),</span>  <span class=c1># Day of week</span>
</span><span id=__span-1-256><a id=__codelineno-1-256 name=__codelineno-1-256></a><a href=#__codelineno-1-256><span class=linenos data-linenos="256 "></span></a>            <span class=mi>1</span> <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_is_peak_usage_time</span><span class=p>()</span> <span class=k>else</span> <span class=mi>0</span>
</span><span id=__span-1-257><a id=__codelineno-1-257 name=__codelineno-1-257></a><a href=#__codelineno-1-257><span class=linenos data-linenos="257 "></span></a>        <span class=p>])</span>
</span><span id=__span-1-258><a id=__codelineno-1-258 name=__codelineno-1-258></a><a href=#__codelineno-1-258><span class=linenos data-linenos="258 "></span></a>        
</span><span id=__span-1-259><a id=__codelineno-1-259 name=__codelineno-1-259></a><a href=#__codelineno-1-259><span class=linenos data-linenos="259 "></span></a>        <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>features</span><span class=p>)</span>
</span></code></pre></div><h3 id=3-context-sharing-and-coordination>3. Context Sharing and Coordination<a class=headerlink href=#3-context-sharing-and-coordination title="Permanent link">&para;</a></h3><div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1></a><a href=#__codelineno-2-1><span class=linenos data-linenos="  1 "></span></a><span class=k>class</span><span class=w> </span><span class=nc>ContextSharingCoordinator</span><span class=p>:</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2></a><a href=#__codelineno-2-2><span class=linenos data-linenos="  2 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Coordinate context sharing between parallel cycles&quot;&quot;&quot;</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3></a><a href=#__codelineno-2-3><span class=linenos data-linenos="  3 "></span></a>    
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4></a><a href=#__codelineno-2-4><span class=linenos data-linenos="  4 "></span></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5></a><a href=#__codelineno-2-5><span class=linenos data-linenos="  5 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>shared_contexts</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>SharedContext</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6></a><a href=#__codelineno-2-6><span class=linenos data-linenos="  6 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>sharing_policies</span> <span class=o>=</span> <span class=n>ContextSharingPolicies</span><span class=p>()</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7></a><a href=#__codelineno-2-7><span class=linenos data-linenos="  7 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>conflict_detector</span> <span class=o>=</span> <span class=n>ContextConflictDetector</span><span class=p>()</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8></a><a href=#__codelineno-2-8><span class=linenos data-linenos="  8 "></span></a>        
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9></a><a href=#__codelineno-2-9><span class=linenos data-linenos="  9 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>share_context</span><span class=p>(</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10></a><a href=#__codelineno-2-10><span class=linenos data-linenos=" 10 "></span></a>        <span class=bp>self</span><span class=p>,</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11></a><a href=#__codelineno-2-11><span class=linenos data-linenos=" 11 "></span></a>        <span class=n>from_cycle</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12></a><a href=#__codelineno-2-12><span class=linenos data-linenos=" 12 "></span></a>        <span class=n>to_cycle</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13></a><a href=#__codelineno-2-13><span class=linenos data-linenos=" 13 "></span></a>        <span class=n>context_keys</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14></a><a href=#__codelineno-2-14><span class=linenos data-linenos=" 14 "></span></a>        <span class=n>sharing_mode</span><span class=p>:</span> <span class=n>SharingMode</span> <span class=o>=</span> <span class=n>SharingMode</span><span class=o>.</span><span class=n>READ_ONLY</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15></a><a href=#__codelineno-2-15><span class=linenos data-linenos=" 15 "></span></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ContextSharingResult</span><span class=p>:</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16></a><a href=#__codelineno-2-16><span class=linenos data-linenos=" 16 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Share specific context between cycles&quot;&quot;&quot;</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17></a><a href=#__codelineno-2-17><span class=linenos data-linenos=" 17 "></span></a>        
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18></a><a href=#__codelineno-2-18><span class=linenos data-linenos=" 18 "></span></a>        <span class=c1># Validate sharing is allowed</span>
</span><span id=__span-2-19><a id=__codelineno-2-19 name=__codelineno-2-19></a><a href=#__codelineno-2-19><span class=linenos data-linenos=" 19 "></span></a>        <span class=n>validation</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_validate_sharing</span><span class=p>(</span><span class=n>from_cycle</span><span class=p>,</span> <span class=n>to_cycle</span><span class=p>,</span> <span class=n>context_keys</span><span class=p>)</span>
</span><span id=__span-2-20><a id=__codelineno-2-20 name=__codelineno-2-20></a><a href=#__codelineno-2-20><span class=linenos data-linenos=" 20 "></span></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>validation</span><span class=o>.</span><span class=n>allowed</span><span class=p>:</span>
</span><span id=__span-2-21><a id=__codelineno-2-21 name=__codelineno-2-21></a><a href=#__codelineno-2-21><span class=linenos data-linenos=" 21 "></span></a>            <span class=k>return</span> <span class=n>ContextSharingResult</span><span class=p>(</span>
</span><span id=__span-2-22><a id=__codelineno-2-22 name=__codelineno-2-22></a><a href=#__codelineno-2-22><span class=linenos data-linenos=" 22 "></span></a>                <span class=n>success</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-2-23><a id=__codelineno-2-23 name=__codelineno-2-23></a><a href=#__codelineno-2-23><span class=linenos data-linenos=" 23 "></span></a>                <span class=n>reason</span><span class=o>=</span><span class=n>validation</span><span class=o>.</span><span class=n>reason</span>
</span><span id=__span-2-24><a id=__codelineno-2-24 name=__codelineno-2-24></a><a href=#__codelineno-2-24><span class=linenos data-linenos=" 24 "></span></a>            <span class=p>)</span>
</span><span id=__span-2-25><a id=__codelineno-2-25 name=__codelineno-2-25></a><a href=#__codelineno-2-25><span class=linenos data-linenos=" 25 "></span></a>            
</span><span id=__span-2-26><a id=__codelineno-2-26 name=__codelineno-2-26></a><a href=#__codelineno-2-26><span class=linenos data-linenos=" 26 "></span></a>        <span class=c1># Check for conflicts</span>
</span><span id=__span-2-27><a id=__codelineno-2-27 name=__codelineno-2-27></a><a href=#__codelineno-2-27><span class=linenos data-linenos=" 27 "></span></a>        <span class=n>conflicts</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>conflict_detector</span><span class=o>.</span><span class=n>detect_sharing_conflicts</span><span class=p>(</span>
</span><span id=__span-2-28><a id=__codelineno-2-28 name=__codelineno-2-28></a><a href=#__codelineno-2-28><span class=linenos data-linenos=" 28 "></span></a>            <span class=n>from_cycle</span><span class=p>,</span> <span class=n>to_cycle</span><span class=p>,</span> <span class=n>context_keys</span>
</span><span id=__span-2-29><a id=__codelineno-2-29 name=__codelineno-2-29></a><a href=#__codelineno-2-29><span class=linenos data-linenos=" 29 "></span></a>        <span class=p>)</span>
</span><span id=__span-2-30><a id=__codelineno-2-30 name=__codelineno-2-30></a><a href=#__codelineno-2-30><span class=linenos data-linenos=" 30 "></span></a>        
</span><span id=__span-2-31><a id=__codelineno-2-31 name=__codelineno-2-31></a><a href=#__codelineno-2-31><span class=linenos data-linenos=" 31 "></span></a>        <span class=k>if</span> <span class=n>conflicts</span><span class=p>:</span>
</span><span id=__span-2-32><a id=__codelineno-2-32 name=__codelineno-2-32></a><a href=#__codelineno-2-32><span class=linenos data-linenos=" 32 "></span></a>            <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_handle_sharing_conflicts</span><span class=p>(</span><span class=n>conflicts</span><span class=p>,</span> <span class=n>sharing_mode</span><span class=p>)</span>
</span><span id=__span-2-33><a id=__codelineno-2-33 name=__codelineno-2-33></a><a href=#__codelineno-2-33><span class=linenos data-linenos=" 33 "></span></a>            
</span><span id=__span-2-34><a id=__codelineno-2-34 name=__codelineno-2-34></a><a href=#__codelineno-2-34><span class=linenos data-linenos=" 34 "></span></a>        <span class=c1># Execute sharing</span>
</span><span id=__span-2-35><a id=__codelineno-2-35 name=__codelineno-2-35></a><a href=#__codelineno-2-35><span class=linenos data-linenos=" 35 "></span></a>        <span class=n>shared_context</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_create_shared_context</span><span class=p>(</span>
</span><span id=__span-2-36><a id=__codelineno-2-36 name=__codelineno-2-36></a><a href=#__codelineno-2-36><span class=linenos data-linenos=" 36 "></span></a>            <span class=n>from_cycle</span><span class=p>,</span> <span class=n>to_cycle</span><span class=p>,</span> <span class=n>context_keys</span><span class=p>,</span> <span class=n>sharing_mode</span>
</span><span id=__span-2-37><a id=__codelineno-2-37 name=__codelineno-2-37></a><a href=#__codelineno-2-37><span class=linenos data-linenos=" 37 "></span></a>        <span class=p>)</span>
</span><span id=__span-2-38><a id=__codelineno-2-38 name=__codelineno-2-38></a><a href=#__codelineno-2-38><span class=linenos data-linenos=" 38 "></span></a>        
</span><span id=__span-2-39><a id=__codelineno-2-39 name=__codelineno-2-39></a><a href=#__codelineno-2-39><span class=linenos data-linenos=" 39 "></span></a>        <span class=c1># Update both cycles</span>
</span><span id=__span-2-40><a id=__codelineno-2-40 name=__codelineno-2-40></a><a href=#__codelineno-2-40><span class=linenos data-linenos=" 40 "></span></a>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_update_cycle_with_shared_context</span><span class=p>(</span><span class=n>to_cycle</span><span class=p>,</span> <span class=n>shared_context</span><span class=p>)</span>
</span><span id=__span-2-41><a id=__codelineno-2-41 name=__codelineno-2-41></a><a href=#__codelineno-2-41><span class=linenos data-linenos=" 41 "></span></a>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_track_context_dependency</span><span class=p>(</span><span class=n>from_cycle</span><span class=p>,</span> <span class=n>to_cycle</span><span class=p>,</span> <span class=n>shared_context</span><span class=p>)</span>
</span><span id=__span-2-42><a id=__codelineno-2-42 name=__codelineno-2-42></a><a href=#__codelineno-2-42><span class=linenos data-linenos=" 42 "></span></a>        
</span><span id=__span-2-43><a id=__codelineno-2-43 name=__codelineno-2-43></a><a href=#__codelineno-2-43><span class=linenos data-linenos=" 43 "></span></a>        <span class=k>return</span> <span class=n>ContextSharingResult</span><span class=p>(</span>
</span><span id=__span-2-44><a id=__codelineno-2-44 name=__codelineno-2-44></a><a href=#__codelineno-2-44><span class=linenos data-linenos=" 44 "></span></a>            <span class=n>success</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-2-45><a id=__codelineno-2-45 name=__codelineno-2-45></a><a href=#__codelineno-2-45><span class=linenos data-linenos=" 45 "></span></a>            <span class=n>shared_context_id</span><span class=o>=</span><span class=n>shared_context</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-2-46><a id=__codelineno-2-46 name=__codelineno-2-46></a><a href=#__codelineno-2-46><span class=linenos data-linenos=" 46 "></span></a>            <span class=n>token_cost</span><span class=o>=</span><span class=n>shared_context</span><span class=o>.</span><span class=n>token_cost</span><span class=p>,</span>
</span><span id=__span-2-47><a id=__codelineno-2-47 name=__codelineno-2-47></a><a href=#__codelineno-2-47><span class=linenos data-linenos=" 47 "></span></a>            <span class=n>sharing_mode</span><span class=o>=</span><span class=n>sharing_mode</span>
</span><span id=__span-2-48><a id=__codelineno-2-48 name=__codelineno-2-48></a><a href=#__codelineno-2-48><span class=linenos data-linenos=" 48 "></span></a>        <span class=p>)</span>
</span><span id=__span-2-49><a id=__codelineno-2-49 name=__codelineno-2-49></a><a href=#__codelineno-2-49><span class=linenos data-linenos=" 49 "></span></a>        
</span><span id=__span-2-50><a id=__codelineno-2-50 name=__codelineno-2-50></a><a href=#__codelineno-2-50><span class=linenos data-linenos=" 50 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>_create_shared_context</span><span class=p>(</span>
</span><span id=__span-2-51><a id=__codelineno-2-51 name=__codelineno-2-51></a><a href=#__codelineno-2-51><span class=linenos data-linenos=" 51 "></span></a>        <span class=bp>self</span><span class=p>,</span>
</span><span id=__span-2-52><a id=__codelineno-2-52 name=__codelineno-2-52></a><a href=#__codelineno-2-52><span class=linenos data-linenos=" 52 "></span></a>        <span class=n>from_cycle</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span><span id=__span-2-53><a id=__codelineno-2-53 name=__codelineno-2-53></a><a href=#__codelineno-2-53><span class=linenos data-linenos=" 53 "></span></a>        <span class=n>to_cycle</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span><span id=__span-2-54><a id=__codelineno-2-54 name=__codelineno-2-54></a><a href=#__codelineno-2-54><span class=linenos data-linenos=" 54 "></span></a>        <span class=n>context_keys</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span>
</span><span id=__span-2-55><a id=__codelineno-2-55 name=__codelineno-2-55></a><a href=#__codelineno-2-55><span class=linenos data-linenos=" 55 "></span></a>        <span class=n>sharing_mode</span><span class=p>:</span> <span class=n>SharingMode</span>
</span><span id=__span-2-56><a id=__codelineno-2-56 name=__codelineno-2-56></a><a href=#__codelineno-2-56><span class=linenos data-linenos=" 56 "></span></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>SharedContext</span><span class=p>:</span>
</span><span id=__span-2-57><a id=__codelineno-2-57 name=__codelineno-2-57></a><a href=#__codelineno-2-57><span class=linenos data-linenos=" 57 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Create shared context between cycles&quot;&quot;&quot;</span>
</span><span id=__span-2-58><a id=__codelineno-2-58 name=__codelineno-2-58></a><a href=#__codelineno-2-58><span class=linenos data-linenos=" 58 "></span></a>        
</span><span id=__span-2-59><a id=__codelineno-2-59 name=__codelineno-2-59></a><a href=#__codelineno-2-59><span class=linenos data-linenos=" 59 "></span></a>        <span class=n>source_context</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_cycle_context</span><span class=p>(</span><span class=n>from_cycle</span><span class=p>)</span>
</span><span id=__span-2-60><a id=__codelineno-2-60 name=__codelineno-2-60></a><a href=#__codelineno-2-60><span class=linenos data-linenos=" 60 "></span></a>        <span class=n>target_context</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_cycle_context</span><span class=p>(</span><span class=n>to_cycle</span><span class=p>)</span>
</span><span id=__span-2-61><a id=__codelineno-2-61 name=__codelineno-2-61></a><a href=#__codelineno-2-61><span class=linenos data-linenos=" 61 "></span></a>        
</span><span id=__span-2-62><a id=__codelineno-2-62 name=__codelineno-2-62></a><a href=#__codelineno-2-62><span class=linenos data-linenos=" 62 "></span></a>        <span class=c1># Extract requested context elements</span>
</span><span id=__span-2-63><a id=__codelineno-2-63 name=__codelineno-2-63></a><a href=#__codelineno-2-63><span class=linenos data-linenos=" 63 "></span></a>        <span class=n>shared_elements</span> <span class=o>=</span> <span class=p>{}</span>
</span><span id=__span-2-64><a id=__codelineno-2-64 name=__codelineno-2-64></a><a href=#__codelineno-2-64><span class=linenos data-linenos=" 64 "></span></a>        <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>context_keys</span><span class=p>:</span>
</span><span id=__span-2-65><a id=__codelineno-2-65 name=__codelineno-2-65></a><a href=#__codelineno-2-65><span class=linenos data-linenos=" 65 "></span></a>            <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>source_context</span><span class=o>.</span><span class=n>elements</span><span class=p>:</span>
</span><span id=__span-2-66><a id=__codelineno-2-66 name=__codelineno-2-66></a><a href=#__codelineno-2-66><span class=linenos data-linenos=" 66 "></span></a>                <span class=n>element</span> <span class=o>=</span> <span class=n>source_context</span><span class=o>.</span><span class=n>elements</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>
</span><span id=__span-2-67><a id=__codelineno-2-67 name=__codelineno-2-67></a><a href=#__codelineno-2-67><span class=linenos data-linenos=" 67 "></span></a>                
</span><span id=__span-2-68><a id=__codelineno-2-68 name=__codelineno-2-68></a><a href=#__codelineno-2-68><span class=linenos data-linenos=" 68 "></span></a>                <span class=c1># Apply sharing transformations</span>
</span><span id=__span-2-69><a id=__codelineno-2-69 name=__codelineno-2-69></a><a href=#__codelineno-2-69><span class=linenos data-linenos=" 69 "></span></a>                <span class=k>if</span> <span class=n>sharing_mode</span> <span class=o>==</span> <span class=n>SharingMode</span><span class=o>.</span><span class=n>READ_ONLY</span><span class=p>:</span>
</span><span id=__span-2-70><a id=__codelineno-2-70 name=__codelineno-2-70></a><a href=#__codelineno-2-70><span class=linenos data-linenos=" 70 "></span></a>                    <span class=n>shared_element</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_create_readonly_copy</span><span class=p>(</span><span class=n>element</span><span class=p>)</span>
</span><span id=__span-2-71><a id=__codelineno-2-71 name=__codelineno-2-71></a><a href=#__codelineno-2-71><span class=linenos data-linenos=" 71 "></span></a>                <span class=k>elif</span> <span class=n>sharing_mode</span> <span class=o>==</span> <span class=n>SharingMode</span><span class=o>.</span><span class=n>SYNCHRONIZED</span><span class=p>:</span>
</span><span id=__span-2-72><a id=__codelineno-2-72 name=__codelineno-2-72></a><a href=#__codelineno-2-72><span class=linenos data-linenos=" 72 "></span></a>                    <span class=n>shared_element</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_create_synchronized_element</span><span class=p>(</span><span class=n>element</span><span class=p>)</span>
</span><span id=__span-2-73><a id=__codelineno-2-73 name=__codelineno-2-73></a><a href=#__codelineno-2-73><span class=linenos data-linenos=" 73 "></span></a>                <span class=k>else</span><span class=p>:</span>  <span class=c1># COPY</span>
</span><span id=__span-2-74><a id=__codelineno-2-74 name=__codelineno-2-74></a><a href=#__codelineno-2-74><span class=linenos data-linenos=" 74 "></span></a>                    <span class=n>shared_element</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_create_deep_copy</span><span class=p>(</span><span class=n>element</span><span class=p>)</span>
</span><span id=__span-2-75><a id=__codelineno-2-75 name=__codelineno-2-75></a><a href=#__codelineno-2-75><span class=linenos data-linenos=" 75 "></span></a>                    
</span><span id=__span-2-76><a id=__codelineno-2-76 name=__codelineno-2-76></a><a href=#__codelineno-2-76><span class=linenos data-linenos=" 76 "></span></a>                <span class=n>shared_elements</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>shared_element</span>
</span><span id=__span-2-77><a id=__codelineno-2-77 name=__codelineno-2-77></a><a href=#__codelineno-2-77><span class=linenos data-linenos=" 77 "></span></a>                
</span><span id=__span-2-78><a id=__codelineno-2-78 name=__codelineno-2-78></a><a href=#__codelineno-2-78><span class=linenos data-linenos=" 78 "></span></a>        <span class=c1># Create shared context</span>
</span><span id=__span-2-79><a id=__codelineno-2-79 name=__codelineno-2-79></a><a href=#__codelineno-2-79><span class=linenos data-linenos=" 79 "></span></a>        <span class=n>shared_context</span> <span class=o>=</span> <span class=n>SharedContext</span><span class=p>(</span>
</span><span id=__span-2-80><a id=__codelineno-2-80 name=__codelineno-2-80></a><a href=#__codelineno-2-80><span class=linenos data-linenos=" 80 "></span></a>            <span class=nb>id</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;shared_</span><span class=si>{</span><span class=n>from_cycle</span><span class=si>}</span><span class=s2>_</span><span class=si>{</span><span class=n>to_cycle</span><span class=si>}</span><span class=s2>_</span><span class=si>{</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>()</span><span class=o>.</span><span class=n>hex</span><span class=p>[:</span><span class=mi>8</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
</span><span id=__span-2-81><a id=__codelineno-2-81 name=__codelineno-2-81></a><a href=#__codelineno-2-81><span class=linenos data-linenos=" 81 "></span></a>            <span class=n>from_cycle</span><span class=o>=</span><span class=n>from_cycle</span><span class=p>,</span>
</span><span id=__span-2-82><a id=__codelineno-2-82 name=__codelineno-2-82></a><a href=#__codelineno-2-82><span class=linenos data-linenos=" 82 "></span></a>            <span class=n>to_cycle</span><span class=o>=</span><span class=n>to_cycle</span><span class=p>,</span>
</span><span id=__span-2-83><a id=__codelineno-2-83 name=__codelineno-2-83></a><a href=#__codelineno-2-83><span class=linenos data-linenos=" 83 "></span></a>            <span class=n>elements</span><span class=o>=</span><span class=n>shared_elements</span><span class=p>,</span>
</span><span id=__span-2-84><a id=__codelineno-2-84 name=__codelineno-2-84></a><a href=#__codelineno-2-84><span class=linenos data-linenos=" 84 "></span></a>            <span class=n>sharing_mode</span><span class=o>=</span><span class=n>sharing_mode</span><span class=p>,</span>
</span><span id=__span-2-85><a id=__codelineno-2-85 name=__codelineno-2-85></a><a href=#__codelineno-2-85><span class=linenos data-linenos=" 85 "></span></a>            <span class=n>created_at</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span>
</span><span id=__span-2-86><a id=__codelineno-2-86 name=__codelineno-2-86></a><a href=#__codelineno-2-86><span class=linenos data-linenos=" 86 "></span></a>            <span class=n>token_cost</span><span class=o>=</span><span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_sharing_token_cost</span><span class=p>(</span><span class=n>shared_elements</span><span class=p>)</span>
</span><span id=__span-2-87><a id=__codelineno-2-87 name=__codelineno-2-87></a><a href=#__codelineno-2-87><span class=linenos data-linenos=" 87 "></span></a>        <span class=p>)</span>
</span><span id=__span-2-88><a id=__codelineno-2-88 name=__codelineno-2-88></a><a href=#__codelineno-2-88><span class=linenos data-linenos=" 88 "></span></a>        
</span><span id=__span-2-89><a id=__codelineno-2-89 name=__codelineno-2-89></a><a href=#__codelineno-2-89><span class=linenos data-linenos=" 89 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>shared_contexts</span><span class=p>[</span><span class=n>shared_context</span><span class=o>.</span><span class=n>id</span><span class=p>]</span> <span class=o>=</span> <span class=n>shared_context</span>
</span><span id=__span-2-90><a id=__codelineno-2-90 name=__codelineno-2-90></a><a href=#__codelineno-2-90><span class=linenos data-linenos=" 90 "></span></a>        <span class=k>return</span> <span class=n>shared_context</span>
</span><span id=__span-2-91><a id=__codelineno-2-91 name=__codelineno-2-91></a><a href=#__codelineno-2-91><span class=linenos data-linenos=" 91 "></span></a>
</span><span id=__span-2-92><a id=__codelineno-2-92 name=__codelineno-2-92></a><a href=#__codelineno-2-92><span class=linenos data-linenos=" 92 "></span></a><span class=k>class</span><span class=w> </span><span class=nc>ContextConflictDetector</span><span class=p>:</span>
</span><span id=__span-2-93><a id=__codelineno-2-93 name=__codelineno-2-93></a><a href=#__codelineno-2-93><span class=linenos data-linenos=" 93 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Detect conflicts in context sharing&quot;&quot;&quot;</span>
</span><span id=__span-2-94><a id=__codelineno-2-94 name=__codelineno-2-94></a><a href=#__codelineno-2-94><span class=linenos data-linenos=" 94 "></span></a>    
</span><span id=__span-2-95><a id=__codelineno-2-95 name=__codelineno-2-95></a><a href=#__codelineno-2-95><span class=linenos data-linenos=" 95 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>detect_sharing_conflicts</span><span class=p>(</span>
</span><span id=__span-2-96><a id=__codelineno-2-96 name=__codelineno-2-96></a><a href=#__codelineno-2-96><span class=linenos data-linenos=" 96 "></span></a>        <span class=bp>self</span><span class=p>,</span>
</span><span id=__span-2-97><a id=__codelineno-2-97 name=__codelineno-2-97></a><a href=#__codelineno-2-97><span class=linenos data-linenos=" 97 "></span></a>        <span class=n>from_cycle</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span><span id=__span-2-98><a id=__codelineno-2-98 name=__codelineno-2-98></a><a href=#__codelineno-2-98><span class=linenos data-linenos=" 98 "></span></a>        <span class=n>to_cycle</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span><span id=__span-2-99><a id=__codelineno-2-99 name=__codelineno-2-99></a><a href=#__codelineno-2-99><span class=linenos data-linenos=" 99 "></span></a>        <span class=n>context_keys</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>
</span><span id=__span-2-100><a id=__codelineno-2-100 name=__codelineno-2-100></a><a href=#__codelineno-2-100><span class=linenos data-linenos="100 "></span></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>ContextConflict</span><span class=p>]:</span>
</span><span id=__span-2-101><a id=__codelineno-2-101 name=__codelineno-2-101></a><a href=#__codelineno-2-101><span class=linenos data-linenos="101 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Detect potential conflicts from context sharing&quot;&quot;&quot;</span>
</span><span id=__span-2-102><a id=__codelineno-2-102 name=__codelineno-2-102></a><a href=#__codelineno-2-102><span class=linenos data-linenos="102 "></span></a>        <span class=n>conflicts</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-2-103><a id=__codelineno-2-103 name=__codelineno-2-103></a><a href=#__codelineno-2-103><span class=linenos data-linenos="103 "></span></a>        
</span><span id=__span-2-104><a id=__codelineno-2-104 name=__codelineno-2-104></a><a href=#__codelineno-2-104><span class=linenos data-linenos="104 "></span></a>        <span class=n>source_context</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_cycle_context</span><span class=p>(</span><span class=n>from_cycle</span><span class=p>)</span>
</span><span id=__span-2-105><a id=__codelineno-2-105 name=__codelineno-2-105></a><a href=#__codelineno-2-105><span class=linenos data-linenos="105 "></span></a>        <span class=n>target_context</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_cycle_context</span><span class=p>(</span><span class=n>to_cycle</span><span class=p>)</span>
</span><span id=__span-2-106><a id=__codelineno-2-106 name=__codelineno-2-106></a><a href=#__codelineno-2-106><span class=linenos data-linenos="106 "></span></a>        
</span><span id=__span-2-107><a id=__codelineno-2-107 name=__codelineno-2-107></a><a href=#__codelineno-2-107><span class=linenos data-linenos="107 "></span></a>        <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>context_keys</span><span class=p>:</span>
</span><span id=__span-2-108><a id=__codelineno-2-108 name=__codelineno-2-108></a><a href=#__codelineno-2-108><span class=linenos data-linenos="108 "></span></a>            <span class=c1># Check for key conflicts</span>
</span><span id=__span-2-109><a id=__codelineno-2-109 name=__codelineno-2-109></a><a href=#__codelineno-2-109><span class=linenos data-linenos="109 "></span></a>            <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>target_context</span><span class=o>.</span><span class=n>elements</span><span class=p>:</span>
</span><span id=__span-2-110><a id=__codelineno-2-110 name=__codelineno-2-110></a><a href=#__codelineno-2-110><span class=linenos data-linenos="110 "></span></a>                <span class=n>existing_element</span> <span class=o>=</span> <span class=n>target_context</span><span class=o>.</span><span class=n>elements</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>
</span><span id=__span-2-111><a id=__codelineno-2-111 name=__codelineno-2-111></a><a href=#__codelineno-2-111><span class=linenos data-linenos="111 "></span></a>                <span class=n>shared_element</span> <span class=o>=</span> <span class=n>source_context</span><span class=o>.</span><span class=n>elements</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>
</span><span id=__span-2-112><a id=__codelineno-2-112 name=__codelineno-2-112></a><a href=#__codelineno-2-112><span class=linenos data-linenos="112 "></span></a>                
</span><span id=__span-2-113><a id=__codelineno-2-113 name=__codelineno-2-113></a><a href=#__codelineno-2-113><span class=linenos data-linenos="113 "></span></a>                <span class=k>if</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_elements_conflict</span><span class=p>(</span><span class=n>existing_element</span><span class=p>,</span> <span class=n>shared_element</span><span class=p>):</span>
</span><span id=__span-2-114><a id=__codelineno-2-114 name=__codelineno-2-114></a><a href=#__codelineno-2-114><span class=linenos data-linenos="114 "></span></a>                    <span class=n>conflicts</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ContextConflict</span><span class=p>(</span>
</span><span id=__span-2-115><a id=__codelineno-2-115 name=__codelineno-2-115></a><a href=#__codelineno-2-115><span class=linenos data-linenos="115 "></span></a>                        <span class=nb>type</span><span class=o>=</span><span class=n>ConflictType</span><span class=o>.</span><span class=n>KEY_COLLISION</span><span class=p>,</span>
</span><span id=__span-2-116><a id=__codelineno-2-116 name=__codelineno-2-116></a><a href=#__codelineno-2-116><span class=linenos data-linenos="116 "></span></a>                        <span class=n>key</span><span class=o>=</span><span class=n>key</span><span class=p>,</span>
</span><span id=__span-2-117><a id=__codelineno-2-117 name=__codelineno-2-117></a><a href=#__codelineno-2-117><span class=linenos data-linenos="117 "></span></a>                        <span class=n>from_cycle</span><span class=o>=</span><span class=n>from_cycle</span><span class=p>,</span>
</span><span id=__span-2-118><a id=__codelineno-2-118 name=__codelineno-2-118></a><a href=#__codelineno-2-118><span class=linenos data-linenos="118 "></span></a>                        <span class=n>to_cycle</span><span class=o>=</span><span class=n>to_cycle</span><span class=p>,</span>
</span><span id=__span-2-119><a id=__codelineno-2-119 name=__codelineno-2-119></a><a href=#__codelineno-2-119><span class=linenos data-linenos="119 "></span></a>                        <span class=n>severity</span><span class=o>=</span><span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_conflict_severity</span><span class=p>(</span>
</span><span id=__span-2-120><a id=__codelineno-2-120 name=__codelineno-2-120></a><a href=#__codelineno-2-120><span class=linenos data-linenos="120 "></span></a>                            <span class=n>existing_element</span><span class=p>,</span> <span class=n>shared_element</span>
</span><span id=__span-2-121><a id=__codelineno-2-121 name=__codelineno-2-121></a><a href=#__codelineno-2-121><span class=linenos data-linenos="121 "></span></a>                        <span class=p>)</span>
</span><span id=__span-2-122><a id=__codelineno-2-122 name=__codelineno-2-122></a><a href=#__codelineno-2-122><span class=linenos data-linenos="122 "></span></a>                    <span class=p>))</span>
</span><span id=__span-2-123><a id=__codelineno-2-123 name=__codelineno-2-123></a><a href=#__codelineno-2-123><span class=linenos data-linenos="123 "></span></a>                    
</span><span id=__span-2-124><a id=__codelineno-2-124 name=__codelineno-2-124></a><a href=#__codelineno-2-124><span class=linenos data-linenos="124 "></span></a>            <span class=c1># Check for semantic conflicts</span>
</span><span id=__span-2-125><a id=__codelineno-2-125 name=__codelineno-2-125></a><a href=#__codelineno-2-125><span class=linenos data-linenos="125 "></span></a>            <span class=n>semantic_conflicts</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_detect_semantic_conflicts</span><span class=p>(</span>
</span><span id=__span-2-126><a id=__codelineno-2-126 name=__codelineno-2-126></a><a href=#__codelineno-2-126><span class=linenos data-linenos="126 "></span></a>                <span class=n>key</span><span class=p>,</span> <span class=n>source_context</span><span class=p>,</span> <span class=n>target_context</span>
</span><span id=__span-2-127><a id=__codelineno-2-127 name=__codelineno-2-127></a><a href=#__codelineno-2-127><span class=linenos data-linenos="127 "></span></a>            <span class=p>)</span>
</span><span id=__span-2-128><a id=__codelineno-2-128 name=__codelineno-2-128></a><a href=#__codelineno-2-128><span class=linenos data-linenos="128 "></span></a>            <span class=n>conflicts</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>semantic_conflicts</span><span class=p>)</span>
</span><span id=__span-2-129><a id=__codelineno-2-129 name=__codelineno-2-129></a><a href=#__codelineno-2-129><span class=linenos data-linenos="129 "></span></a>            
</span><span id=__span-2-130><a id=__codelineno-2-130 name=__codelineno-2-130></a><a href=#__codelineno-2-130><span class=linenos data-linenos="130 "></span></a>        <span class=k>return</span> <span class=n>conflicts</span>
</span><span id=__span-2-131><a id=__codelineno-2-131 name=__codelineno-2-131></a><a href=#__codelineno-2-131><span class=linenos data-linenos="131 "></span></a>        
</span><span id=__span-2-132><a id=__codelineno-2-132 name=__codelineno-2-132></a><a href=#__codelineno-2-132><span class=linenos data-linenos="132 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>_elements_conflict</span><span class=p>(</span>
</span><span id=__span-2-133><a id=__codelineno-2-133 name=__codelineno-2-133></a><a href=#__codelineno-2-133><span class=linenos data-linenos="133 "></span></a>        <span class=bp>self</span><span class=p>,</span> 
</span><span id=__span-2-134><a id=__codelineno-2-134 name=__codelineno-2-134></a><a href=#__codelineno-2-134><span class=linenos data-linenos="134 "></span></a>        <span class=n>element1</span><span class=p>:</span> <span class=n>ContextElement</span><span class=p>,</span> 
</span><span id=__span-2-135><a id=__codelineno-2-135 name=__codelineno-2-135></a><a href=#__codelineno-2-135><span class=linenos data-linenos="135 "></span></a>        <span class=n>element2</span><span class=p>:</span> <span class=n>ContextElement</span>
</span><span id=__span-2-136><a id=__codelineno-2-136 name=__codelineno-2-136></a><a href=#__codelineno-2-136><span class=linenos data-linenos="136 "></span></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span><span id=__span-2-137><a id=__codelineno-2-137 name=__codelineno-2-137></a><a href=#__codelineno-2-137><span class=linenos data-linenos="137 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Check if two context elements conflict&quot;&quot;&quot;</span>
</span><span id=__span-2-138><a id=__codelineno-2-138 name=__codelineno-2-138></a><a href=#__codelineno-2-138><span class=linenos data-linenos="138 "></span></a>        
</span><span id=__span-2-139><a id=__codelineno-2-139 name=__codelineno-2-139></a><a href=#__codelineno-2-139><span class=linenos data-linenos="139 "></span></a>        <span class=c1># Type conflicts</span>
</span><span id=__span-2-140><a id=__codelineno-2-140 name=__codelineno-2-140></a><a href=#__codelineno-2-140><span class=linenos data-linenos="140 "></span></a>        <span class=k>if</span> <span class=n>element1</span><span class=o>.</span><span class=n>element_type</span> <span class=o>!=</span> <span class=n>element2</span><span class=o>.</span><span class=n>element_type</span><span class=p>:</span>
</span><span id=__span-2-141><a id=__codelineno-2-141 name=__codelineno-2-141></a><a href=#__codelineno-2-141><span class=linenos data-linenos="141 "></span></a>            <span class=k>return</span> <span class=kc>True</span>
</span><span id=__span-2-142><a id=__codelineno-2-142 name=__codelineno-2-142></a><a href=#__codelineno-2-142><span class=linenos data-linenos="142 "></span></a>            
</span><span id=__span-2-143><a id=__codelineno-2-143 name=__codelineno-2-143></a><a href=#__codelineno-2-143><span class=linenos data-linenos="143 "></span></a>        <span class=c1># Content conflicts (for file content)</span>
</span><span id=__span-2-144><a id=__codelineno-2-144 name=__codelineno-2-144></a><a href=#__codelineno-2-144><span class=linenos data-linenos="144 "></span></a>        <span class=k>if</span> <span class=n>element1</span><span class=o>.</span><span class=n>element_type</span> <span class=o>==</span> <span class=n>ElementType</span><span class=o>.</span><span class=n>FILE_CONTENT</span><span class=p>:</span>
</span><span id=__span-2-145><a id=__codelineno-2-145 name=__codelineno-2-145></a><a href=#__codelineno-2-145><span class=linenos data-linenos="145 "></span></a>            <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_file_contents_conflict</span><span class=p>(</span><span class=n>element1</span><span class=o>.</span><span class=n>content</span><span class=p>,</span> <span class=n>element2</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span><span id=__span-2-146><a id=__codelineno-2-146 name=__codelineno-2-146></a><a href=#__codelineno-2-146><span class=linenos data-linenos="146 "></span></a>            
</span><span id=__span-2-147><a id=__codelineno-2-147 name=__codelineno-2-147></a><a href=#__codelineno-2-147><span class=linenos data-linenos="147 "></span></a>        <span class=c1># Version conflicts</span>
</span><span id=__span-2-148><a id=__codelineno-2-148 name=__codelineno-2-148></a><a href=#__codelineno-2-148><span class=linenos data-linenos="148 "></span></a>        <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>element1</span><span class=p>,</span> <span class=s1>&#39;version&#39;</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>element2</span><span class=p>,</span> <span class=s1>&#39;version&#39;</span><span class=p>):</span>
</span><span id=__span-2-149><a id=__codelineno-2-149 name=__codelineno-2-149></a><a href=#__codelineno-2-149><span class=linenos data-linenos="149 "></span></a>            <span class=k>return</span> <span class=n>element1</span><span class=o>.</span><span class=n>version</span> <span class=o>!=</span> <span class=n>element2</span><span class=o>.</span><span class=n>version</span>
</span><span id=__span-2-150><a id=__codelineno-2-150 name=__codelineno-2-150></a><a href=#__codelineno-2-150><span class=linenos data-linenos="150 "></span></a>            
</span><span id=__span-2-151><a id=__codelineno-2-151 name=__codelineno-2-151></a><a href=#__codelineno-2-151><span class=linenos data-linenos="151 "></span></a>        <span class=k>return</span> <span class=kc>False</span>
</span><span id=__span-2-152><a id=__codelineno-2-152 name=__codelineno-2-152></a><a href=#__codelineno-2-152><span class=linenos data-linenos="152 "></span></a>        
</span><span id=__span-2-153><a id=__codelineno-2-153 name=__codelineno-2-153></a><a href=#__codelineno-2-153><span class=linenos data-linenos="153 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>_file_contents_conflict</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>content1</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>content2</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span><span id=__span-2-154><a id=__codelineno-2-154 name=__codelineno-2-154></a><a href=#__codelineno-2-154><span class=linenos data-linenos="154 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Check if file contents conflict&quot;&quot;&quot;</span>
</span><span id=__span-2-155><a id=__codelineno-2-155 name=__codelineno-2-155></a><a href=#__codelineno-2-155><span class=linenos data-linenos="155 "></span></a>        <span class=c1># Use AST comparison for code files</span>
</span><span id=__span-2-156><a id=__codelineno-2-156 name=__codelineno-2-156></a><a href=#__codelineno-2-156><span class=linenos data-linenos="156 "></span></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_is_code_file</span><span class=p>(</span><span class=n>content1</span><span class=p>):</span>
</span><span id=__span-2-157><a id=__codelineno-2-157 name=__codelineno-2-157></a><a href=#__codelineno-2-157><span class=linenos data-linenos="157 "></span></a>            <span class=k>try</span><span class=p>:</span>
</span><span id=__span-2-158><a id=__codelineno-2-158 name=__codelineno-2-158></a><a href=#__codelineno-2-158><span class=linenos data-linenos="158 "></span></a>                <span class=n>ast1</span> <span class=o>=</span> <span class=n>ast</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=n>content1</span><span class=p>)</span>
</span><span id=__span-2-159><a id=__codelineno-2-159 name=__codelineno-2-159></a><a href=#__codelineno-2-159><span class=linenos data-linenos="159 "></span></a>                <span class=n>ast2</span> <span class=o>=</span> <span class=n>ast</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=n>content2</span><span class=p>)</span>
</span><span id=__span-2-160><a id=__codelineno-2-160 name=__codelineno-2-160></a><a href=#__codelineno-2-160><span class=linenos data-linenos="160 "></span></a>                <span class=k>return</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>_asts_compatible</span><span class=p>(</span><span class=n>ast1</span><span class=p>,</span> <span class=n>ast2</span><span class=p>)</span>
</span><span id=__span-2-161><a id=__codelineno-2-161 name=__codelineno-2-161></a><a href=#__codelineno-2-161><span class=linenos data-linenos="161 "></span></a>            <span class=k>except</span> <span class=ne>SyntaxError</span><span class=p>:</span>
</span><span id=__span-2-162><a id=__codelineno-2-162 name=__codelineno-2-162></a><a href=#__codelineno-2-162><span class=linenos data-linenos="162 "></span></a>                <span class=c1># Fall back to text comparison</span>
</span><span id=__span-2-163><a id=__codelineno-2-163 name=__codelineno-2-163></a><a href=#__codelineno-2-163><span class=linenos data-linenos="163 "></span></a>                <span class=k>return</span> <span class=n>content1</span> <span class=o>!=</span> <span class=n>content2</span>
</span><span id=__span-2-164><a id=__codelineno-2-164 name=__codelineno-2-164></a><a href=#__codelineno-2-164><span class=linenos data-linenos="164 "></span></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-2-165><a id=__codelineno-2-165 name=__codelineno-2-165></a><a href=#__codelineno-2-165><span class=linenos data-linenos="165 "></span></a>            <span class=c1># Text comparison for non-code files</span>
</span><span id=__span-2-166><a id=__codelineno-2-166 name=__codelineno-2-166></a><a href=#__codelineno-2-166><span class=linenos data-linenos="166 "></span></a>            <span class=k>return</span> <span class=n>content1</span> <span class=o>!=</span> <span class=n>content2</span>
</span></code></pre></div><h3 id=4-context-optimization-for-parallel-execution>4. Context Optimization for Parallel Execution<a class=headerlink href=#4-context-optimization-for-parallel-execution title="Permanent link">&para;</a></h3><div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1></a><a href=#__codelineno-3-1><span class=linenos data-linenos="  1 "></span></a><span class=k>class</span><span class=w> </span><span class=nc>ParallelContextOptimizer</span><span class=p>:</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2></a><a href=#__codelineno-3-2><span class=linenos data-linenos="  2 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Optimize context for parallel execution efficiency&quot;&quot;&quot;</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3></a><a href=#__codelineno-3-3><span class=linenos data-linenos="  3 "></span></a>    
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4></a><a href=#__codelineno-3-4><span class=linenos data-linenos="  4 "></span></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5></a><a href=#__codelineno-3-5><span class=linenos data-linenos="  5 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>compression_strategies</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6></a><a href=#__codelineno-3-6><span class=linenos data-linenos="  6 "></span></a>            <span class=n>AgentType</span><span class=o>.</span><span class=n>DESIGN</span><span class=p>:</span> <span class=n>DesignContextCompressor</span><span class=p>(),</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7></a><a href=#__codelineno-3-7><span class=linenos data-linenos="  7 "></span></a>            <span class=n>AgentType</span><span class=o>.</span><span class=n>QA</span><span class=p>:</span> <span class=n>QAContextCompressor</span><span class=p>(),</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8></a><a href=#__codelineno-3-8><span class=linenos data-linenos="  8 "></span></a>            <span class=n>AgentType</span><span class=o>.</span><span class=n>CODE</span><span class=p>:</span> <span class=n>CodeContextCompressor</span><span class=p>(),</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9></a><a href=#__codelineno-3-9><span class=linenos data-linenos="  9 "></span></a>            <span class=n>AgentType</span><span class=o>.</span><span class=n>DATA</span><span class=p>:</span> <span class=n>DataContextCompressor</span><span class=p>()</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10></a><a href=#__codelineno-3-10><span class=linenos data-linenos=" 10 "></span></a>        <span class=p>}</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11></a><a href=#__codelineno-3-11><span class=linenos data-linenos=" 11 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>deduplication_engine</span> <span class=o>=</span> <span class=n>ContextDeduplicationEngine</span><span class=p>()</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12></a><a href=#__codelineno-3-12><span class=linenos data-linenos=" 12 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>prefetch_predictor</span> <span class=o>=</span> <span class=n>ContextPrefetchPredictor</span><span class=p>()</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13></a><a href=#__codelineno-3-13><span class=linenos data-linenos=" 13 "></span></a>        
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14></a><a href=#__codelineno-3-14><span class=linenos data-linenos=" 14 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>optimize_for_parallel</span><span class=p>(</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15></a><a href=#__codelineno-3-15><span class=linenos data-linenos=" 15 "></span></a>        <span class=bp>self</span><span class=p>,</span> 
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16></a><a href=#__codelineno-3-16><span class=linenos data-linenos=" 16 "></span></a>        <span class=n>context</span><span class=p>:</span> <span class=n>IsolatedCycleContext</span><span class=p>,</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17></a><a href=#__codelineno-3-17><span class=linenos data-linenos=" 17 "></span></a>        <span class=n>parallel_group</span><span class=p>:</span> <span class=n>ParallelGroup</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18></a><a href=#__codelineno-3-18><span class=linenos data-linenos=" 18 "></span></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>OptimizationResult</span><span class=p>:</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19></a><a href=#__codelineno-3-19><span class=linenos data-linenos=" 19 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Optimize context for parallel execution&quot;&quot;&quot;</span>
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20></a><a href=#__codelineno-3-20><span class=linenos data-linenos=" 20 "></span></a>        
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21></a><a href=#__codelineno-3-21><span class=linenos data-linenos=" 21 "></span></a>        <span class=n>optimizations</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-3-22><a id=__codelineno-3-22 name=__codelineno-3-22></a><a href=#__codelineno-3-22><span class=linenos data-linenos=" 22 "></span></a>        
</span><span id=__span-3-23><a id=__codelineno-3-23 name=__codelineno-3-23></a><a href=#__codelineno-3-23><span class=linenos data-linenos=" 23 "></span></a>        <span class=c1># Cross-cycle deduplication</span>
</span><span id=__span-3-24><a id=__codelineno-3-24 name=__codelineno-3-24></a><a href=#__codelineno-3-24><span class=linenos data-linenos=" 24 "></span></a>        <span class=n>dedup_result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>deduplication_engine</span><span class=o>.</span><span class=n>deduplicate_across_cycles</span><span class=p>(</span>
</span><span id=__span-3-25><a id=__codelineno-3-25 name=__codelineno-3-25></a><a href=#__codelineno-3-25><span class=linenos data-linenos=" 25 "></span></a>            <span class=n>context</span><span class=p>,</span> <span class=n>parallel_group</span>
</span><span id=__span-3-26><a id=__codelineno-3-26 name=__codelineno-3-26></a><a href=#__codelineno-3-26><span class=linenos data-linenos=" 26 "></span></a>        <span class=p>)</span>
</span><span id=__span-3-27><a id=__codelineno-3-27 name=__codelineno-3-27></a><a href=#__codelineno-3-27><span class=linenos data-linenos=" 27 "></span></a>        <span class=k>if</span> <span class=n>dedup_result</span><span class=o>.</span><span class=n>tokens_saved</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-3-28><a id=__codelineno-3-28 name=__codelineno-3-28></a><a href=#__codelineno-3-28><span class=linenos data-linenos=" 28 "></span></a>            <span class=n>optimizations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>dedup_result</span><span class=p>)</span>
</span><span id=__span-3-29><a id=__codelineno-3-29 name=__codelineno-3-29></a><a href=#__codelineno-3-29><span class=linenos data-linenos=" 29 "></span></a>            
</span><span id=__span-3-30><a id=__codelineno-3-30 name=__codelineno-3-30></a><a href=#__codelineno-3-30><span class=linenos data-linenos=" 30 "></span></a>        <span class=c1># Predictive prefetching</span>
</span><span id=__span-3-31><a id=__codelineno-3-31 name=__codelineno-3-31></a><a href=#__codelineno-3-31><span class=linenos data-linenos=" 31 "></span></a>        <span class=n>prefetch_result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>prefetch_predictor</span><span class=o>.</span><span class=n>prefetch_likely_context</span><span class=p>(</span>
</span><span id=__span-3-32><a id=__codelineno-3-32 name=__codelineno-3-32></a><a href=#__codelineno-3-32><span class=linenos data-linenos=" 32 "></span></a>            <span class=n>context</span><span class=p>,</span> <span class=n>parallel_group</span>
</span><span id=__span-3-33><a id=__codelineno-3-33 name=__codelineno-3-33></a><a href=#__codelineno-3-33><span class=linenos data-linenos=" 33 "></span></a>        <span class=p>)</span>
</span><span id=__span-3-34><a id=__codelineno-3-34 name=__codelineno-3-34></a><a href=#__codelineno-3-34><span class=linenos data-linenos=" 34 "></span></a>        <span class=k>if</span> <span class=n>prefetch_result</span><span class=o>.</span><span class=n>items_prefetched</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-3-35><a id=__codelineno-3-35 name=__codelineno-3-35></a><a href=#__codelineno-3-35><span class=linenos data-linenos=" 35 "></span></a>            <span class=n>optimizations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>prefetch_result</span><span class=p>)</span>
</span><span id=__span-3-36><a id=__codelineno-3-36 name=__codelineno-3-36></a><a href=#__codelineno-3-36><span class=linenos data-linenos=" 36 "></span></a>            
</span><span id=__span-3-37><a id=__codelineno-3-37 name=__codelineno-3-37></a><a href=#__codelineno-3-37><span class=linenos data-linenos=" 37 "></span></a>        <span class=c1># Compression optimization</span>
</span><span id=__span-3-38><a id=__codelineno-3-38 name=__codelineno-3-38></a><a href=#__codelineno-3-38><span class=linenos data-linenos=" 38 "></span></a>        <span class=n>compression_result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_optimize_compression</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>parallel_group</span><span class=p>)</span>
</span><span id=__span-3-39><a id=__codelineno-3-39 name=__codelineno-3-39></a><a href=#__codelineno-3-39><span class=linenos data-linenos=" 39 "></span></a>        <span class=k>if</span> <span class=n>compression_result</span><span class=o>.</span><span class=n>compression_improvement</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-3-40><a id=__codelineno-3-40 name=__codelineno-3-40></a><a href=#__codelineno-3-40><span class=linenos data-linenos=" 40 "></span></a>            <span class=n>optimizations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>compression_result</span><span class=p>)</span>
</span><span id=__span-3-41><a id=__codelineno-3-41 name=__codelineno-3-41></a><a href=#__codelineno-3-41><span class=linenos data-linenos=" 41 "></span></a>            
</span><span id=__span-3-42><a id=__codelineno-3-42 name=__codelineno-3-42></a><a href=#__codelineno-3-42><span class=linenos data-linenos=" 42 "></span></a>        <span class=k>return</span> <span class=n>OptimizationResult</span><span class=p>(</span>
</span><span id=__span-3-43><a id=__codelineno-3-43 name=__codelineno-3-43></a><a href=#__codelineno-3-43><span class=linenos data-linenos=" 43 "></span></a>            <span class=n>context_id</span><span class=o>=</span><span class=n>context</span><span class=o>.</span><span class=n>cycle_id</span><span class=p>,</span>
</span><span id=__span-3-44><a id=__codelineno-3-44 name=__codelineno-3-44></a><a href=#__codelineno-3-44><span class=linenos data-linenos=" 44 "></span></a>            <span class=n>optimizations</span><span class=o>=</span><span class=n>optimizations</span><span class=p>,</span>
</span><span id=__span-3-45><a id=__codelineno-3-45 name=__codelineno-3-45></a><a href=#__codelineno-3-45><span class=linenos data-linenos=" 45 "></span></a>            <span class=n>total_tokens_saved</span><span class=o>=</span><span class=nb>sum</span><span class=p>(</span><span class=n>opt</span><span class=o>.</span><span class=n>tokens_saved</span> <span class=k>for</span> <span class=n>opt</span> <span class=ow>in</span> <span class=n>optimizations</span><span class=p>),</span>
</span><span id=__span-3-46><a id=__codelineno-3-46 name=__codelineno-3-46></a><a href=#__codelineno-3-46><span class=linenos data-linenos=" 46 "></span></a>            <span class=n>performance_improvement</span><span class=o>=</span><span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_performance_improvement</span><span class=p>(</span>
</span><span id=__span-3-47><a id=__codelineno-3-47 name=__codelineno-3-47></a><a href=#__codelineno-3-47><span class=linenos data-linenos=" 47 "></span></a>                <span class=n>optimizations</span>
</span><span id=__span-3-48><a id=__codelineno-3-48 name=__codelineno-3-48></a><a href=#__codelineno-3-48><span class=linenos data-linenos=" 48 "></span></a>            <span class=p>)</span>
</span><span id=__span-3-49><a id=__codelineno-3-49 name=__codelineno-3-49></a><a href=#__codelineno-3-49><span class=linenos data-linenos=" 49 "></span></a>        <span class=p>)</span>
</span><span id=__span-3-50><a id=__codelineno-3-50 name=__codelineno-3-50></a><a href=#__codelineno-3-50><span class=linenos data-linenos=" 50 "></span></a>        
</span><span id=__span-3-51><a id=__codelineno-3-51 name=__codelineno-3-51></a><a href=#__codelineno-3-51><span class=linenos data-linenos=" 51 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>_optimize_compression</span><span class=p>(</span>
</span><span id=__span-3-52><a id=__codelineno-3-52 name=__codelineno-3-52></a><a href=#__codelineno-3-52><span class=linenos data-linenos=" 52 "></span></a>        <span class=bp>self</span><span class=p>,</span> 
</span><span id=__span-3-53><a id=__codelineno-3-53 name=__codelineno-3-53></a><a href=#__codelineno-3-53><span class=linenos data-linenos=" 53 "></span></a>        <span class=n>context</span><span class=p>:</span> <span class=n>IsolatedCycleContext</span><span class=p>,</span>
</span><span id=__span-3-54><a id=__codelineno-3-54 name=__codelineno-3-54></a><a href=#__codelineno-3-54><span class=linenos data-linenos=" 54 "></span></a>        <span class=n>parallel_group</span><span class=p>:</span> <span class=n>ParallelGroup</span>
</span><span id=__span-3-55><a id=__codelineno-3-55 name=__codelineno-3-55></a><a href=#__codelineno-3-55><span class=linenos data-linenos=" 55 "></span></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>CompressionOptimization</span><span class=p>:</span>
</span><span id=__span-3-56><a id=__codelineno-3-56 name=__codelineno-3-56></a><a href=#__codelineno-3-56><span class=linenos data-linenos=" 56 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Optimize compression strategies for parallel context&quot;&quot;&quot;</span>
</span><span id=__span-3-57><a id=__codelineno-3-57 name=__codelineno-3-57></a><a href=#__codelineno-3-57><span class=linenos data-linenos=" 57 "></span></a>        
</span><span id=__span-3-58><a id=__codelineno-3-58 name=__codelineno-3-58></a><a href=#__codelineno-3-58><span class=linenos data-linenos=" 58 "></span></a>        <span class=c1># Analyze context usage patterns across the group</span>
</span><span id=__span-3-59><a id=__codelineno-3-59 name=__codelineno-3-59></a><a href=#__codelineno-3-59><span class=linenos data-linenos=" 59 "></span></a>        <span class=n>usage_patterns</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_analyze_group_usage_patterns</span><span class=p>(</span><span class=n>parallel_group</span><span class=p>)</span>
</span><span id=__span-3-60><a id=__codelineno-3-60 name=__codelineno-3-60></a><a href=#__codelineno-3-60><span class=linenos data-linenos=" 60 "></span></a>        
</span><span id=__span-3-61><a id=__codelineno-3-61 name=__codelineno-3-61></a><a href=#__codelineno-3-61><span class=linenos data-linenos=" 61 "></span></a>        <span class=c1># Identify commonly used context elements</span>
</span><span id=__span-3-62><a id=__codelineno-3-62 name=__codelineno-3-62></a><a href=#__codelineno-3-62><span class=linenos data-linenos=" 62 "></span></a>        <span class=n>common_elements</span> <span class=o>=</span> <span class=n>usage_patterns</span><span class=o>.</span><span class=n>common_elements</span>
</span><span id=__span-3-63><a id=__codelineno-3-63 name=__codelineno-3-63></a><a href=#__codelineno-3-63><span class=linenos data-linenos=" 63 "></span></a>        <span class=n>unique_elements</span> <span class=o>=</span> <span class=n>usage_patterns</span><span class=o>.</span><span class=n>unique_elements</span>
</span><span id=__span-3-64><a id=__codelineno-3-64 name=__codelineno-3-64></a><a href=#__codelineno-3-64><span class=linenos data-linenos=" 64 "></span></a>        
</span><span id=__span-3-65><a id=__codelineno-3-65 name=__codelineno-3-65></a><a href=#__codelineno-3-65><span class=linenos data-linenos=" 65 "></span></a>        <span class=n>compression_improvements</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-3-66><a id=__codelineno-3-66 name=__codelineno-3-66></a><a href=#__codelineno-3-66><span class=linenos data-linenos=" 66 "></span></a>        
</span><span id=__span-3-67><a id=__codelineno-3-67 name=__codelineno-3-67></a><a href=#__codelineno-3-67><span class=linenos data-linenos=" 67 "></span></a>        <span class=c1># Apply aggressive compression to unique elements</span>
</span><span id=__span-3-68><a id=__codelineno-3-68 name=__codelineno-3-68></a><a href=#__codelineno-3-68><span class=linenos data-linenos=" 68 "></span></a>        <span class=k>for</span> <span class=n>element_key</span> <span class=ow>in</span> <span class=n>unique_elements</span><span class=p>:</span>
</span><span id=__span-3-69><a id=__codelineno-3-69 name=__codelineno-3-69></a><a href=#__codelineno-3-69><span class=linenos data-linenos=" 69 "></span></a>            <span class=k>if</span> <span class=n>element_key</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>scope</span><span class=o>.</span><span class=n>core_files</span><span class=p>:</span>
</span><span id=__span-3-70><a id=__codelineno-3-70 name=__codelineno-3-70></a><a href=#__codelineno-3-70><span class=linenos data-linenos=" 70 "></span></a>                <span class=n>current_compression</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_current_compression_ratio</span><span class=p>(</span><span class=n>element_key</span><span class=p>)</span>
</span><span id=__span-3-71><a id=__codelineno-3-71 name=__codelineno-3-71></a><a href=#__codelineno-3-71><span class=linenos data-linenos=" 71 "></span></a>                
</span><span id=__span-3-72><a id=__codelineno-3-72 name=__codelineno-3-72></a><a href=#__codelineno-3-72><span class=linenos data-linenos=" 72 "></span></a>                <span class=c1># Try more aggressive compression</span>
</span><span id=__span-3-73><a id=__codelineno-3-73 name=__codelineno-3-73></a><a href=#__codelineno-3-73><span class=linenos data-linenos=" 73 "></span></a>                <span class=n>aggressive_compression</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_apply_aggressive_compression</span><span class=p>(</span>
</span><span id=__span-3-74><a id=__codelineno-3-74 name=__codelineno-3-74></a><a href=#__codelineno-3-74><span class=linenos data-linenos=" 74 "></span></a>                    <span class=n>element_key</span><span class=p>,</span> <span class=n>context</span>
</span><span id=__span-3-75><a id=__codelineno-3-75 name=__codelineno-3-75></a><a href=#__codelineno-3-75><span class=linenos data-linenos=" 75 "></span></a>                <span class=p>)</span>
</span><span id=__span-3-76><a id=__codelineno-3-76 name=__codelineno-3-76></a><a href=#__codelineno-3-76><span class=linenos data-linenos=" 76 "></span></a>                
</span><span id=__span-3-77><a id=__codelineno-3-77 name=__codelineno-3-77></a><a href=#__codelineno-3-77><span class=linenos data-linenos=" 77 "></span></a>                <span class=k>if</span> <span class=n>aggressive_compression</span><span class=o>.</span><span class=n>ratio</span> <span class=o>&gt;</span> <span class=n>current_compression</span> <span class=o>*</span> <span class=mf>1.2</span><span class=p>:</span>
</span><span id=__span-3-78><a id=__codelineno-3-78 name=__codelineno-3-78></a><a href=#__codelineno-3-78><span class=linenos data-linenos=" 78 "></span></a>                    <span class=n>compression_improvements</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>aggressive_compression</span><span class=p>)</span>
</span><span id=__span-3-79><a id=__codelineno-3-79 name=__codelineno-3-79></a><a href=#__codelineno-3-79><span class=linenos data-linenos=" 79 "></span></a>                    
</span><span id=__span-3-80><a id=__codelineno-3-80 name=__codelineno-3-80></a><a href=#__codelineno-3-80><span class=linenos data-linenos=" 80 "></span></a>        <span class=c1># Apply lighter compression to common elements (for sharing)</span>
</span><span id=__span-3-81><a id=__codelineno-3-81 name=__codelineno-3-81></a><a href=#__codelineno-3-81><span class=linenos data-linenos=" 81 "></span></a>        <span class=k>for</span> <span class=n>element_key</span> <span class=ow>in</span> <span class=n>common_elements</span><span class=p>:</span>
</span><span id=__span-3-82><a id=__codelineno-3-82 name=__codelineno-3-82></a><a href=#__codelineno-3-82><span class=linenos data-linenos=" 82 "></span></a>            <span class=k>if</span> <span class=n>element_key</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>scope</span><span class=o>.</span><span class=n>core_files</span><span class=p>:</span>
</span><span id=__span-3-83><a id=__codelineno-3-83 name=__codelineno-3-83></a><a href=#__codelineno-3-83><span class=linenos data-linenos=" 83 "></span></a>                <span class=n>sharing_optimized</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_optimize_for_sharing</span><span class=p>(</span>
</span><span id=__span-3-84><a id=__codelineno-3-84 name=__codelineno-3-84></a><a href=#__codelineno-3-84><span class=linenos data-linenos=" 84 "></span></a>                    <span class=n>element_key</span><span class=p>,</span> <span class=n>context</span><span class=p>,</span> <span class=n>parallel_group</span>
</span><span id=__span-3-85><a id=__codelineno-3-85 name=__codelineno-3-85></a><a href=#__codelineno-3-85><span class=linenos data-linenos=" 85 "></span></a>                <span class=p>)</span>
</span><span id=__span-3-86><a id=__codelineno-3-86 name=__codelineno-3-86></a><a href=#__codelineno-3-86><span class=linenos data-linenos=" 86 "></span></a>                <span class=n>compression_improvements</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>sharing_optimized</span><span class=p>)</span>
</span><span id=__span-3-87><a id=__codelineno-3-87 name=__codelineno-3-87></a><a href=#__codelineno-3-87><span class=linenos data-linenos=" 87 "></span></a>                
</span><span id=__span-3-88><a id=__codelineno-3-88 name=__codelineno-3-88></a><a href=#__codelineno-3-88><span class=linenos data-linenos=" 88 "></span></a>        <span class=k>return</span> <span class=n>CompressionOptimization</span><span class=p>(</span>
</span><span id=__span-3-89><a id=__codelineno-3-89 name=__codelineno-3-89></a><a href=#__codelineno-3-89><span class=linenos data-linenos=" 89 "></span></a>            <span class=n>improvements</span><span class=o>=</span><span class=n>compression_improvements</span><span class=p>,</span>
</span><span id=__span-3-90><a id=__codelineno-3-90 name=__codelineno-3-90></a><a href=#__codelineno-3-90><span class=linenos data-linenos=" 90 "></span></a>            <span class=n>compression_improvement</span><span class=o>=</span><span class=nb>sum</span><span class=p>(</span>
</span><span id=__span-3-91><a id=__codelineno-3-91 name=__codelineno-3-91></a><a href=#__codelineno-3-91><span class=linenos data-linenos=" 91 "></span></a>                <span class=n>imp</span><span class=o>.</span><span class=n>improvement_ratio</span> <span class=k>for</span> <span class=n>imp</span> <span class=ow>in</span> <span class=n>compression_improvements</span>
</span><span id=__span-3-92><a id=__codelineno-3-92 name=__codelineno-3-92></a><a href=#__codelineno-3-92><span class=linenos data-linenos=" 92 "></span></a>            <span class=p>),</span>
</span><span id=__span-3-93><a id=__codelineno-3-93 name=__codelineno-3-93></a><a href=#__codelineno-3-93><span class=linenos data-linenos=" 93 "></span></a>            <span class=n>tokens_saved</span><span class=o>=</span><span class=nb>sum</span><span class=p>(</span><span class=n>imp</span><span class=o>.</span><span class=n>tokens_saved</span> <span class=k>for</span> <span class=n>imp</span> <span class=ow>in</span> <span class=n>compression_improvements</span><span class=p>)</span>
</span><span id=__span-3-94><a id=__codelineno-3-94 name=__codelineno-3-94></a><a href=#__codelineno-3-94><span class=linenos data-linenos=" 94 "></span></a>        <span class=p>)</span>
</span><span id=__span-3-95><a id=__codelineno-3-95 name=__codelineno-3-95></a><a href=#__codelineno-3-95><span class=linenos data-linenos=" 95 "></span></a>
</span><span id=__span-3-96><a id=__codelineno-3-96 name=__codelineno-3-96></a><a href=#__codelineno-3-96><span class=linenos data-linenos=" 96 "></span></a><span class=k>class</span><span class=w> </span><span class=nc>ContextDeduplicationEngine</span><span class=p>:</span>
</span><span id=__span-3-97><a id=__codelineno-3-97 name=__codelineno-3-97></a><a href=#__codelineno-3-97><span class=linenos data-linenos=" 97 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Deduplicate context across parallel cycles&quot;&quot;&quot;</span>
</span><span id=__span-3-98><a id=__codelineno-3-98 name=__codelineno-3-98></a><a href=#__codelineno-3-98><span class=linenos data-linenos=" 98 "></span></a>    
</span><span id=__span-3-99><a id=__codelineno-3-99 name=__codelineno-3-99></a><a href=#__codelineno-3-99><span class=linenos data-linenos=" 99 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>deduplicate_across_cycles</span><span class=p>(</span>
</span><span id=__span-3-100><a id=__codelineno-3-100 name=__codelineno-3-100></a><a href=#__codelineno-3-100><span class=linenos data-linenos="100 "></span></a>        <span class=bp>self</span><span class=p>,</span> 
</span><span id=__span-3-101><a id=__codelineno-3-101 name=__codelineno-3-101></a><a href=#__codelineno-3-101><span class=linenos data-linenos="101 "></span></a>        <span class=n>context</span><span class=p>:</span> <span class=n>IsolatedCycleContext</span><span class=p>,</span>
</span><span id=__span-3-102><a id=__codelineno-3-102 name=__codelineno-3-102></a><a href=#__codelineno-3-102><span class=linenos data-linenos="102 "></span></a>        <span class=n>parallel_group</span><span class=p>:</span> <span class=n>ParallelGroup</span>
</span><span id=__span-3-103><a id=__codelineno-3-103 name=__codelineno-3-103></a><a href=#__codelineno-3-103><span class=linenos data-linenos="103 "></span></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>DeduplicationResult</span><span class=p>:</span>
</span><span id=__span-3-104><a id=__codelineno-3-104 name=__codelineno-3-104></a><a href=#__codelineno-3-104><span class=linenos data-linenos="104 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Remove duplicate context across parallel cycles&quot;&quot;&quot;</span>
</span><span id=__span-3-105><a id=__codelineno-3-105 name=__codelineno-3-105></a><a href=#__codelineno-3-105><span class=linenos data-linenos="105 "></span></a>        
</span><span id=__span-3-106><a id=__codelineno-3-106 name=__codelineno-3-106></a><a href=#__codelineno-3-106><span class=linenos data-linenos="106 "></span></a>        <span class=c1># Analyze context overlap across cycles</span>
</span><span id=__span-3-107><a id=__codelineno-3-107 name=__codelineno-3-107></a><a href=#__codelineno-3-107><span class=linenos data-linenos="107 "></span></a>        <span class=n>overlap_analysis</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_analyze_context_overlap</span><span class=p>(</span>
</span><span id=__span-3-108><a id=__codelineno-3-108 name=__codelineno-3-108></a><a href=#__codelineno-3-108><span class=linenos data-linenos="108 "></span></a>            <span class=n>context</span><span class=p>,</span> <span class=n>parallel_group</span>
</span><span id=__span-3-109><a id=__codelineno-3-109 name=__codelineno-3-109></a><a href=#__codelineno-3-109><span class=linenos data-linenos="109 "></span></a>        <span class=p>)</span>
</span><span id=__span-3-110><a id=__codelineno-3-110 name=__codelineno-3-110></a><a href=#__codelineno-3-110><span class=linenos data-linenos="110 "></span></a>        
</span><span id=__span-3-111><a id=__codelineno-3-111 name=__codelineno-3-111></a><a href=#__codelineno-3-111><span class=linenos data-linenos="111 "></span></a>        <span class=n>deduplication_actions</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-3-112><a id=__codelineno-3-112 name=__codelineno-3-112></a><a href=#__codelineno-3-112><span class=linenos data-linenos="112 "></span></a>        
</span><span id=__span-3-113><a id=__codelineno-3-113 name=__codelineno-3-113></a><a href=#__codelineno-3-113><span class=linenos data-linenos="113 "></span></a>        <span class=c1># Identify exact duplicates</span>
</span><span id=__span-3-114><a id=__codelineno-3-114 name=__codelineno-3-114></a><a href=#__codelineno-3-114><span class=linenos data-linenos="114 "></span></a>        <span class=n>exact_duplicates</span> <span class=o>=</span> <span class=n>overlap_analysis</span><span class=o>.</span><span class=n>exact_matches</span>
</span><span id=__span-3-115><a id=__codelineno-3-115 name=__codelineno-3-115></a><a href=#__codelineno-3-115><span class=linenos data-linenos="115 "></span></a>        <span class=k>for</span> <span class=n>duplicate_key</span><span class=p>,</span> <span class=n>cycles</span> <span class=ow>in</span> <span class=n>exact_duplicates</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span><span id=__span-3-116><a id=__codelineno-3-116 name=__codelineno-3-116></a><a href=#__codelineno-3-116><span class=linenos data-linenos="116 "></span></a>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>cycles</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>:</span>  <span class=c1># Duplicate across multiple cycles</span>
</span><span id=__span-3-117><a id=__codelineno-3-117 name=__codelineno-3-117></a><a href=#__codelineno-3-117><span class=linenos data-linenos="117 "></span></a>                <span class=c1># Move to shared context</span>
</span><span id=__span-3-118><a id=__codelineno-3-118 name=__codelineno-3-118></a><a href=#__codelineno-3-118><span class=linenos data-linenos="118 "></span></a>                <span class=n>sharing_action</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_move_to_shared_context</span><span class=p>(</span>
</span><span id=__span-3-119><a id=__codelineno-3-119 name=__codelineno-3-119></a><a href=#__codelineno-3-119><span class=linenos data-linenos="119 "></span></a>                    <span class=n>duplicate_key</span><span class=p>,</span> <span class=n>cycles</span><span class=p>,</span> <span class=n>context</span>
</span><span id=__span-3-120><a id=__codelineno-3-120 name=__codelineno-3-120></a><a href=#__codelineno-3-120><span class=linenos data-linenos="120 "></span></a>                <span class=p>)</span>
</span><span id=__span-3-121><a id=__codelineno-3-121 name=__codelineno-3-121></a><a href=#__codelineno-3-121><span class=linenos data-linenos="121 "></span></a>                <span class=n>deduplication_actions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>sharing_action</span><span class=p>)</span>
</span><span id=__span-3-122><a id=__codelineno-3-122 name=__codelineno-3-122></a><a href=#__codelineno-3-122><span class=linenos data-linenos="122 "></span></a>                
</span><span id=__span-3-123><a id=__codelineno-3-123 name=__codelineno-3-123></a><a href=#__codelineno-3-123><span class=linenos data-linenos="123 "></span></a>        <span class=c1># Identify near-duplicates that can be merged</span>
</span><span id=__span-3-124><a id=__codelineno-3-124 name=__codelineno-3-124></a><a href=#__codelineno-3-124><span class=linenos data-linenos="124 "></span></a>        <span class=n>near_duplicates</span> <span class=o>=</span> <span class=n>overlap_analysis</span><span class=o>.</span><span class=n>near_matches</span>
</span><span id=__span-3-125><a id=__codelineno-3-125 name=__codelineno-3-125></a><a href=#__codelineno-3-125><span class=linenos data-linenos="125 "></span></a>        <span class=k>for</span> <span class=n>near_duplicate_group</span> <span class=ow>in</span> <span class=n>near_duplicates</span><span class=p>:</span>
</span><span id=__span-3-126><a id=__codelineno-3-126 name=__codelineno-3-126></a><a href=#__codelineno-3-126><span class=linenos data-linenos="126 "></span></a>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>near_duplicate_group</span><span class=o>.</span><span class=n>keys</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>:</span>
</span><span id=__span-3-127><a id=__codelineno-3-127 name=__codelineno-3-127></a><a href=#__codelineno-3-127><span class=linenos data-linenos="127 "></span></a>                <span class=n>merge_action</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_merge_near_duplicates</span><span class=p>(</span>
</span><span id=__span-3-128><a id=__codelineno-3-128 name=__codelineno-3-128></a><a href=#__codelineno-3-128><span class=linenos data-linenos="128 "></span></a>                    <span class=n>near_duplicate_group</span><span class=p>,</span> <span class=n>context</span>
</span><span id=__span-3-129><a id=__codelineno-3-129 name=__codelineno-3-129></a><a href=#__codelineno-3-129><span class=linenos data-linenos="129 "></span></a>                <span class=p>)</span>
</span><span id=__span-3-130><a id=__codelineno-3-130 name=__codelineno-3-130></a><a href=#__codelineno-3-130><span class=linenos data-linenos="130 "></span></a>                <span class=n>deduplication_actions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>merge_action</span><span class=p>)</span>
</span><span id=__span-3-131><a id=__codelineno-3-131 name=__codelineno-3-131></a><a href=#__codelineno-3-131><span class=linenos data-linenos="131 "></span></a>                
</span><span id=__span-3-132><a id=__codelineno-3-132 name=__codelineno-3-132></a><a href=#__codelineno-3-132><span class=linenos data-linenos="132 "></span></a>        <span class=k>return</span> <span class=n>DeduplicationResult</span><span class=p>(</span>
</span><span id=__span-3-133><a id=__codelineno-3-133 name=__codelineno-3-133></a><a href=#__codelineno-3-133><span class=linenos data-linenos="133 "></span></a>            <span class=n>actions</span><span class=o>=</span><span class=n>deduplication_actions</span><span class=p>,</span>
</span><span id=__span-3-134><a id=__codelineno-3-134 name=__codelineno-3-134></a><a href=#__codelineno-3-134><span class=linenos data-linenos="134 "></span></a>            <span class=n>tokens_saved</span><span class=o>=</span><span class=nb>sum</span><span class=p>(</span><span class=n>action</span><span class=o>.</span><span class=n>tokens_saved</span> <span class=k>for</span> <span class=n>action</span> <span class=ow>in</span> <span class=n>deduplication_actions</span><span class=p>),</span>
</span><span id=__span-3-135><a id=__codelineno-3-135 name=__codelineno-3-135></a><a href=#__codelineno-3-135><span class=linenos data-linenos="135 "></span></a>            <span class=n>files_deduplicated</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>deduplication_actions</span><span class=p>)</span>
</span><span id=__span-3-136><a id=__codelineno-3-136 name=__codelineno-3-136></a><a href=#__codelineno-3-136><span class=linenos data-linenos="136 "></span></a>        <span class=p>)</span>
</span><span id=__span-3-137><a id=__codelineno-3-137 name=__codelineno-3-137></a><a href=#__codelineno-3-137><span class=linenos data-linenos="137 "></span></a>        
</span><span id=__span-3-138><a id=__codelineno-3-138 name=__codelineno-3-138></a><a href=#__codelineno-3-138><span class=linenos data-linenos="138 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>_move_to_shared_context</span><span class=p>(</span>
</span><span id=__span-3-139><a id=__codelineno-3-139 name=__codelineno-3-139></a><a href=#__codelineno-3-139><span class=linenos data-linenos="139 "></span></a>        <span class=bp>self</span><span class=p>,</span>
</span><span id=__span-3-140><a id=__codelineno-3-140 name=__codelineno-3-140></a><a href=#__codelineno-3-140><span class=linenos data-linenos="140 "></span></a>        <span class=n>context_key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span><span id=__span-3-141><a id=__codelineno-3-141 name=__codelineno-3-141></a><a href=#__codelineno-3-141><span class=linenos data-linenos="141 "></span></a>        <span class=n>involved_cycles</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span>
</span><span id=__span-3-142><a id=__codelineno-3-142 name=__codelineno-3-142></a><a href=#__codelineno-3-142><span class=linenos data-linenos="142 "></span></a>        <span class=n>source_context</span><span class=p>:</span> <span class=n>IsolatedCycleContext</span>
</span><span id=__span-3-143><a id=__codelineno-3-143 name=__codelineno-3-143></a><a href=#__codelineno-3-143><span class=linenos data-linenos="143 "></span></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>DeduplicationAction</span><span class=p>:</span>
</span><span id=__span-3-144><a id=__codelineno-3-144 name=__codelineno-3-144></a><a href=#__codelineno-3-144><span class=linenos data-linenos="144 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Move duplicate context to shared space&quot;&quot;&quot;</span>
</span><span id=__span-3-145><a id=__codelineno-3-145 name=__codelineno-3-145></a><a href=#__codelineno-3-145><span class=linenos data-linenos="145 "></span></a>        
</span><span id=__span-3-146><a id=__codelineno-3-146 name=__codelineno-3-146></a><a href=#__codelineno-3-146><span class=linenos data-linenos="146 "></span></a>        <span class=c1># Create shared context entry</span>
</span><span id=__span-3-147><a id=__codelineno-3-147 name=__codelineno-3-147></a><a href=#__codelineno-3-147><span class=linenos data-linenos="147 "></span></a>        <span class=n>shared_entry</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_create_shared_entry</span><span class=p>(</span><span class=n>context_key</span><span class=p>,</span> <span class=n>source_context</span><span class=p>)</span>
</span><span id=__span-3-148><a id=__codelineno-3-148 name=__codelineno-3-148></a><a href=#__codelineno-3-148><span class=linenos data-linenos="148 "></span></a>        
</span><span id=__span-3-149><a id=__codelineno-3-149 name=__codelineno-3-149></a><a href=#__codelineno-3-149><span class=linenos data-linenos="149 "></span></a>        <span class=c1># Calculate token savings</span>
</span><span id=__span-3-150><a id=__codelineno-3-150 name=__codelineno-3-150></a><a href=#__codelineno-3-150><span class=linenos data-linenos="150 "></span></a>        <span class=n>individual_cost</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_individual_context_cost</span><span class=p>(</span><span class=n>context_key</span><span class=p>)</span>
</span><span id=__span-3-151><a id=__codelineno-3-151 name=__codelineno-3-151></a><a href=#__codelineno-3-151><span class=linenos data-linenos="151 "></span></a>        <span class=n>shared_cost</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_shared_context_cost</span><span class=p>(</span><span class=n>context_key</span><span class=p>)</span>
</span><span id=__span-3-152><a id=__codelineno-3-152 name=__codelineno-3-152></a><a href=#__codelineno-3-152><span class=linenos data-linenos="152 "></span></a>        <span class=n>tokens_saved</span> <span class=o>=</span> <span class=p>(</span><span class=n>individual_cost</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>involved_cycles</span><span class=p>))</span> <span class=o>-</span> <span class=n>shared_cost</span>
</span><span id=__span-3-153><a id=__codelineno-3-153 name=__codelineno-3-153></a><a href=#__codelineno-3-153><span class=linenos data-linenos="153 "></span></a>        
</span><span id=__span-3-154><a id=__codelineno-3-154 name=__codelineno-3-154></a><a href=#__codelineno-3-154><span class=linenos data-linenos="154 "></span></a>        <span class=k>return</span> <span class=n>DeduplicationAction</span><span class=p>(</span>
</span><span id=__span-3-155><a id=__codelineno-3-155 name=__codelineno-3-155></a><a href=#__codelineno-3-155><span class=linenos data-linenos="155 "></span></a>            <span class=nb>type</span><span class=o>=</span><span class=n>DeduplicationType</span><span class=o>.</span><span class=n>MOVE_TO_SHARED</span><span class=p>,</span>
</span><span id=__span-3-156><a id=__codelineno-3-156 name=__codelineno-3-156></a><a href=#__codelineno-3-156><span class=linenos data-linenos="156 "></span></a>            <span class=n>context_key</span><span class=o>=</span><span class=n>context_key</span><span class=p>,</span>
</span><span id=__span-3-157><a id=__codelineno-3-157 name=__codelineno-3-157></a><a href=#__codelineno-3-157><span class=linenos data-linenos="157 "></span></a>            <span class=n>involved_cycles</span><span class=o>=</span><span class=n>involved_cycles</span><span class=p>,</span>
</span><span id=__span-3-158><a id=__codelineno-3-158 name=__codelineno-3-158></a><a href=#__codelineno-3-158><span class=linenos data-linenos="158 "></span></a>            <span class=n>shared_entry_id</span><span class=o>=</span><span class=n>shared_entry</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-3-159><a id=__codelineno-3-159 name=__codelineno-3-159></a><a href=#__codelineno-3-159><span class=linenos data-linenos="159 "></span></a>            <span class=n>tokens_saved</span><span class=o>=</span><span class=n>tokens_saved</span>
</span><span id=__span-3-160><a id=__codelineno-3-160 name=__codelineno-3-160></a><a href=#__codelineno-3-160><span class=linenos data-linenos="160 "></span></a>        <span class=p>)</span>
</span><span id=__span-3-161><a id=__codelineno-3-161 name=__codelineno-3-161></a><a href=#__codelineno-3-161><span class=linenos data-linenos="161 "></span></a>
</span><span id=__span-3-162><a id=__codelineno-3-162 name=__codelineno-3-162></a><a href=#__codelineno-3-162><span class=linenos data-linenos="162 "></span></a><span class=k>class</span><span class=w> </span><span class=nc>ContextPrefetchPredictor</span><span class=p>:</span>
</span><span id=__span-3-163><a id=__codelineno-3-163 name=__codelineno-3-163></a><a href=#__codelineno-3-163><span class=linenos data-linenos="163 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Predict and prefetch likely needed context&quot;&quot;&quot;</span>
</span><span id=__span-3-164><a id=__codelineno-3-164 name=__codelineno-3-164></a><a href=#__codelineno-3-164><span class=linenos data-linenos="164 "></span></a>    
</span><span id=__span-3-165><a id=__codelineno-3-165 name=__codelineno-3-165></a><a href=#__codelineno-3-165><span class=linenos data-linenos="165 "></span></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-3-166><a id=__codelineno-3-166 name=__codelineno-3-166></a><a href=#__codelineno-3-166><span class=linenos data-linenos="166 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>usage_patterns</span> <span class=o>=</span> <span class=n>ContextUsagePatterns</span><span class=p>()</span>
</span><span id=__span-3-167><a id=__codelineno-3-167 name=__codelineno-3-167></a><a href=#__codelineno-3-167><span class=linenos data-linenos="167 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>dependency_analyzer</span> <span class=o>=</span> <span class=n>ContextDependencyAnalyzer</span><span class=p>()</span>
</span><span id=__span-3-168><a id=__codelineno-3-168 name=__codelineno-3-168></a><a href=#__codelineno-3-168><span class=linenos data-linenos="168 "></span></a>        
</span><span id=__span-3-169><a id=__codelineno-3-169 name=__codelineno-3-169></a><a href=#__codelineno-3-169><span class=linenos data-linenos="169 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>prefetch_likely_context</span><span class=p>(</span>
</span><span id=__span-3-170><a id=__codelineno-3-170 name=__codelineno-3-170></a><a href=#__codelineno-3-170><span class=linenos data-linenos="170 "></span></a>        <span class=bp>self</span><span class=p>,</span>
</span><span id=__span-3-171><a id=__codelineno-3-171 name=__codelineno-3-171></a><a href=#__codelineno-3-171><span class=linenos data-linenos="171 "></span></a>        <span class=n>context</span><span class=p>:</span> <span class=n>IsolatedCycleContext</span><span class=p>,</span>
</span><span id=__span-3-172><a id=__codelineno-3-172 name=__codelineno-3-172></a><a href=#__codelineno-3-172><span class=linenos data-linenos="172 "></span></a>        <span class=n>parallel_group</span><span class=p>:</span> <span class=n>ParallelGroup</span>
</span><span id=__span-3-173><a id=__codelineno-3-173 name=__codelineno-3-173></a><a href=#__codelineno-3-173><span class=linenos data-linenos="173 "></span></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>PrefetchResult</span><span class=p>:</span>
</span><span id=__span-3-174><a id=__codelineno-3-174 name=__codelineno-3-174></a><a href=#__codelineno-3-174><span class=linenos data-linenos="174 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Prefetch context likely to be needed&quot;&quot;&quot;</span>
</span><span id=__span-3-175><a id=__codelineno-3-175 name=__codelineno-3-175></a><a href=#__codelineno-3-175><span class=linenos data-linenos="175 "></span></a>        
</span><span id=__span-3-176><a id=__codelineno-3-176 name=__codelineno-3-176></a><a href=#__codelineno-3-176><span class=linenos data-linenos="176 "></span></a>        <span class=c1># Analyze current context usage</span>
</span><span id=__span-3-177><a id=__codelineno-3-177 name=__codelineno-3-177></a><a href=#__codelineno-3-177><span class=linenos data-linenos="177 "></span></a>        <span class=n>current_files</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>scope</span><span class=o>.</span><span class=n>core_files</span><span class=p>)</span>
</span><span id=__span-3-178><a id=__codelineno-3-178 name=__codelineno-3-178></a><a href=#__codelineno-3-178><span class=linenos data-linenos="178 "></span></a>        
</span><span id=__span-3-179><a id=__codelineno-3-179 name=__codelineno-3-179></a><a href=#__codelineno-3-179><span class=linenos data-linenos="179 "></span></a>        <span class=c1># Predict likely next files based on patterns</span>
</span><span id=__span-3-180><a id=__codelineno-3-180 name=__codelineno-3-180></a><a href=#__codelineno-3-180><span class=linenos data-linenos="180 "></span></a>        <span class=n>likely_files</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_predict_likely_files</span><span class=p>(</span>
</span><span id=__span-3-181><a id=__codelineno-3-181 name=__codelineno-3-181></a><a href=#__codelineno-3-181><span class=linenos data-linenos="181 "></span></a>            <span class=n>current_files</span><span class=p>,</span> <span class=n>context</span><span class=o>.</span><span class=n>story_id</span>
</span><span id=__span-3-182><a id=__codelineno-3-182 name=__codelineno-3-182></a><a href=#__codelineno-3-182><span class=linenos data-linenos="182 "></span></a>        <span class=p>)</span>
</span><span id=__span-3-183><a id=__codelineno-3-183 name=__codelineno-3-183></a><a href=#__codelineno-3-183><span class=linenos data-linenos="183 "></span></a>        
</span><span id=__span-3-184><a id=__codelineno-3-184 name=__codelineno-3-184></a><a href=#__codelineno-3-184><span class=linenos data-linenos="184 "></span></a>        <span class=c1># Analyze dependencies that might be needed</span>
</span><span id=__span-3-185><a id=__codelineno-3-185 name=__codelineno-3-185></a><a href=#__codelineno-3-185><span class=linenos data-linenos="185 "></span></a>        <span class=n>dependency_predictions</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>dependency_analyzer</span><span class=o>.</span><span class=n>predict_dependencies</span><span class=p>(</span>
</span><span id=__span-3-186><a id=__codelineno-3-186 name=__codelineno-3-186></a><a href=#__codelineno-3-186><span class=linenos data-linenos="186 "></span></a>            <span class=n>current_files</span><span class=p>,</span> <span class=n>context</span>
</span><span id=__span-3-187><a id=__codelineno-3-187 name=__codelineno-3-187></a><a href=#__codelineno-3-187><span class=linenos data-linenos="187 "></span></a>        <span class=p>)</span>
</span><span id=__span-3-188><a id=__codelineno-3-188 name=__codelineno-3-188></a><a href=#__codelineno-3-188><span class=linenos data-linenos="188 "></span></a>        
</span><span id=__span-3-189><a id=__codelineno-3-189 name=__codelineno-3-189></a><a href=#__codelineno-3-189><span class=linenos data-linenos="189 "></span></a>        <span class=c1># Combine predictions</span>
</span><span id=__span-3-190><a id=__codelineno-3-190 name=__codelineno-3-190></a><a href=#__codelineno-3-190><span class=linenos data-linenos="190 "></span></a>        <span class=n>prefetch_candidates</span> <span class=o>=</span> <span class=p>(</span><span class=n>likely_files</span> <span class=o>|</span> <span class=n>dependency_predictions</span><span class=o>.</span><span class=n>likely_dependencies</span><span class=p>)</span>
</span><span id=__span-3-191><a id=__codelineno-3-191 name=__codelineno-3-191></a><a href=#__codelineno-3-191><span class=linenos data-linenos="191 "></span></a>        
</span><span id=__span-3-192><a id=__codelineno-3-192 name=__codelineno-3-192></a><a href=#__codelineno-3-192><span class=linenos data-linenos="192 "></span></a>        <span class=c1># Filter candidates that fit in remaining token budget</span>
</span><span id=__span-3-193><a id=__codelineno-3-193 name=__codelineno-3-193></a><a href=#__codelineno-3-193><span class=linenos data-linenos="193 "></span></a>        <span class=n>remaining_budget</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>token_budget</span> <span class=o>-</span> <span class=n>context</span><span class=o>.</span><span class=n>tokens_used</span>
</span><span id=__span-3-194><a id=__codelineno-3-194 name=__codelineno-3-194></a><a href=#__codelineno-3-194><span class=linenos data-linenos="194 "></span></a>        <span class=n>feasible_candidates</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_filter_by_token_budget</span><span class=p>(</span>
</span><span id=__span-3-195><a id=__codelineno-3-195 name=__codelineno-3-195></a><a href=#__codelineno-3-195><span class=linenos data-linenos="195 "></span></a>            <span class=n>prefetch_candidates</span><span class=p>,</span> <span class=n>remaining_budget</span> <span class=o>*</span> <span class=mf>0.2</span>  <span class=c1># Use max 20% for prefetch</span>
</span><span id=__span-3-196><a id=__codelineno-3-196 name=__codelineno-3-196></a><a href=#__codelineno-3-196><span class=linenos data-linenos="196 "></span></a>        <span class=p>)</span>
</span><span id=__span-3-197><a id=__codelineno-3-197 name=__codelineno-3-197></a><a href=#__codelineno-3-197><span class=linenos data-linenos="197 "></span></a>        
</span><span id=__span-3-198><a id=__codelineno-3-198 name=__codelineno-3-198></a><a href=#__codelineno-3-198><span class=linenos data-linenos="198 "></span></a>        <span class=c1># Execute prefetching</span>
</span><span id=__span-3-199><a id=__codelineno-3-199 name=__codelineno-3-199></a><a href=#__codelineno-3-199><span class=linenos data-linenos="199 "></span></a>        <span class=n>prefetch_actions</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-3-200><a id=__codelineno-3-200 name=__codelineno-3-200></a><a href=#__codelineno-3-200><span class=linenos data-linenos="200 "></span></a>        <span class=k>for</span> <span class=n>candidate</span> <span class=ow>in</span> <span class=n>feasible_candidates</span><span class=p>:</span>
</span><span id=__span-3-201><a id=__codelineno-3-201 name=__codelineno-3-201></a><a href=#__codelineno-3-201><span class=linenos data-linenos="201 "></span></a>            <span class=n>action</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_prefetch_context_item</span><span class=p>(</span><span class=n>candidate</span><span class=p>,</span> <span class=n>context</span><span class=p>)</span>
</span><span id=__span-3-202><a id=__codelineno-3-202 name=__codelineno-3-202></a><a href=#__codelineno-3-202><span class=linenos data-linenos="202 "></span></a>            <span class=n>prefetch_actions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>action</span><span class=p>)</span>
</span><span id=__span-3-203><a id=__codelineno-3-203 name=__codelineno-3-203></a><a href=#__codelineno-3-203><span class=linenos data-linenos="203 "></span></a>            
</span><span id=__span-3-204><a id=__codelineno-3-204 name=__codelineno-3-204></a><a href=#__codelineno-3-204><span class=linenos data-linenos="204 "></span></a>        <span class=k>return</span> <span class=n>PrefetchResult</span><span class=p>(</span>
</span><span id=__span-3-205><a id=__codelineno-3-205 name=__codelineno-3-205></a><a href=#__codelineno-3-205><span class=linenos data-linenos="205 "></span></a>            <span class=n>items_prefetched</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>prefetch_actions</span><span class=p>),</span>
</span><span id=__span-3-206><a id=__codelineno-3-206 name=__codelineno-3-206></a><a href=#__codelineno-3-206><span class=linenos data-linenos="206 "></span></a>            <span class=n>tokens_used</span><span class=o>=</span><span class=nb>sum</span><span class=p>(</span><span class=n>action</span><span class=o>.</span><span class=n>tokens_used</span> <span class=k>for</span> <span class=n>action</span> <span class=ow>in</span> <span class=n>prefetch_actions</span><span class=p>),</span>
</span><span id=__span-3-207><a id=__codelineno-3-207 name=__codelineno-3-207></a><a href=#__codelineno-3-207><span class=linenos data-linenos="207 "></span></a>            <span class=n>predicted_time_savings</span><span class=o>=</span><span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_time_savings</span><span class=p>(</span><span class=n>prefetch_actions</span><span class=p>)</span>
</span><span id=__span-3-208><a id=__codelineno-3-208 name=__codelineno-3-208></a><a href=#__codelineno-3-208><span class=linenos data-linenos="208 "></span></a>        <span class=p>)</span>
</span></code></pre></div><h3 id=5-performance-monitoring-and-metrics>5. Performance Monitoring and Metrics<a class=headerlink href=#5-performance-monitoring-and-metrics title="Permanent link">&para;</a></h3><div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1></a><a href=#__codelineno-4-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>class</span><span class=w> </span><span class=nc>ParallelContextMetrics</span><span class=p>:</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2></a><a href=#__codelineno-4-2><span class=linenos data-linenos=" 2 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Monitor context performance in parallel execution&quot;&quot;&quot;</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3></a><a href=#__codelineno-4-3><span class=linenos data-linenos=" 3 "></span></a>    
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4></a><a href=#__codelineno-4-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5></a><a href=#__codelineno-4-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics_collector</span> <span class=o>=</span> <span class=n>ContextMetricsCollector</span><span class=p>()</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6></a><a href=#__codelineno-4-6><span class=linenos data-linenos=" 6 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>performance_analyzer</span> <span class=o>=</span> <span class=n>ContextPerformanceAnalyzer</span><span class=p>()</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7></a><a href=#__codelineno-4-7><span class=linenos data-linenos=" 7 "></span></a>        
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8></a><a href=#__codelineno-4-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>collect_parallel_metrics</span><span class=p>(</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9></a><a href=#__codelineno-4-9><span class=linenos data-linenos=" 9 "></span></a>        <span class=bp>self</span><span class=p>,</span> 
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10></a><a href=#__codelineno-4-10><span class=linenos data-linenos="10 "></span></a>        <span class=n>parallel_group</span><span class=p>:</span> <span class=n>ParallelGroup</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11></a><a href=#__codelineno-4-11><span class=linenos data-linenos="11 "></span></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ParallelContextMetrics</span><span class=p>:</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12></a><a href=#__codelineno-4-12><span class=linenos data-linenos="12 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Collect comprehensive context metrics for parallel group&quot;&quot;&quot;</span>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13></a><a href=#__codelineno-4-13><span class=linenos data-linenos="13 "></span></a>        
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14></a><a href=#__codelineno-4-14><span class=linenos data-linenos="14 "></span></a>        <span class=n>metrics</span> <span class=o>=</span> <span class=n>ParallelContextMetrics</span><span class=p>(</span>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15></a><a href=#__codelineno-4-15><span class=linenos data-linenos="15 "></span></a>            <span class=n>group_id</span><span class=o>=</span><span class=n>parallel_group</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16></a><a href=#__codelineno-4-16><span class=linenos data-linenos="16 "></span></a>            <span class=n>timestamp</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span>
</span><span id=__span-4-17><a id=__codelineno-4-17 name=__codelineno-4-17></a><a href=#__codelineno-4-17><span class=linenos data-linenos="17 "></span></a>            
</span><span id=__span-4-18><a id=__codelineno-4-18 name=__codelineno-4-18></a><a href=#__codelineno-4-18><span class=linenos data-linenos="18 "></span></a>            <span class=c1># Token usage metrics</span>
</span><span id=__span-4-19><a id=__codelineno-4-19 name=__codelineno-4-19></a><a href=#__codelineno-4-19><span class=linenos data-linenos="19 "></span></a>            <span class=n>total_tokens_allocated</span><span class=o>=</span><span class=nb>sum</span><span class=p>(</span>
</span><span id=__span-4-20><a id=__codelineno-4-20 name=__codelineno-4-20></a><a href=#__codelineno-4-20><span class=linenos data-linenos="20 "></span></a>                <span class=n>ctx</span><span class=o>.</span><span class=n>token_budget</span> <span class=k>for</span> <span class=n>ctx</span> <span class=ow>in</span> <span class=n>parallel_group</span><span class=o>.</span><span class=n>contexts</span>
</span><span id=__span-4-21><a id=__codelineno-4-21 name=__codelineno-4-21></a><a href=#__codelineno-4-21><span class=linenos data-linenos="21 "></span></a>            <span class=p>),</span>
</span><span id=__span-4-22><a id=__codelineno-4-22 name=__codelineno-4-22></a><a href=#__codelineno-4-22><span class=linenos data-linenos="22 "></span></a>            <span class=n>total_tokens_used</span><span class=o>=</span><span class=nb>sum</span><span class=p>(</span>
</span><span id=__span-4-23><a id=__codelineno-4-23 name=__codelineno-4-23></a><a href=#__codelineno-4-23><span class=linenos data-linenos="23 "></span></a>                <span class=n>ctx</span><span class=o>.</span><span class=n>tokens_used</span> <span class=k>for</span> <span class=n>ctx</span> <span class=ow>in</span> <span class=n>parallel_group</span><span class=o>.</span><span class=n>contexts</span>
</span><span id=__span-4-24><a id=__codelineno-4-24 name=__codelineno-4-24></a><a href=#__codelineno-4-24><span class=linenos data-linenos="24 "></span></a>            <span class=p>),</span>
</span><span id=__span-4-25><a id=__codelineno-4-25 name=__codelineno-4-25></a><a href=#__codelineno-4-25><span class=linenos data-linenos="25 "></span></a>            <span class=n>token_efficiency</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_calculate_token_efficiency</span><span class=p>(</span><span class=n>parallel_group</span><span class=p>),</span>
</span><span id=__span-4-26><a id=__codelineno-4-26 name=__codelineno-4-26></a><a href=#__codelineno-4-26><span class=linenos data-linenos="26 "></span></a>            
</span><span id=__span-4-27><a id=__codelineno-4-27 name=__codelineno-4-27></a><a href=#__codelineno-4-27><span class=linenos data-linenos="27 "></span></a>            <span class=c1># Context sharing metrics</span>
</span><span id=__span-4-28><a id=__codelineno-4-28 name=__codelineno-4-28></a><a href=#__codelineno-4-28><span class=linenos data-linenos="28 "></span></a>            <span class=n>shared_contexts_count</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>parallel_group</span><span class=o>.</span><span class=n>shared_contexts</span><span class=p>),</span>
</span><span id=__span-4-29><a id=__codelineno-4-29 name=__codelineno-4-29></a><a href=#__codelineno-4-29><span class=linenos data-linenos="29 "></span></a>            <span class=n>sharing_efficiency</span><span class=o>=</span><span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_sharing_efficiency</span><span class=p>(</span><span class=n>parallel_group</span><span class=p>),</span>
</span><span id=__span-4-30><a id=__codelineno-4-30 name=__codelineno-4-30></a><a href=#__codelineno-4-30><span class=linenos data-linenos="30 "></span></a>            <span class=n>deduplication_savings</span><span class=o>=</span><span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_deduplication_savings</span><span class=p>(</span><span class=n>parallel_group</span><span class=p>),</span>
</span><span id=__span-4-31><a id=__codelineno-4-31 name=__codelineno-4-31></a><a href=#__codelineno-4-31><span class=linenos data-linenos="31 "></span></a>            
</span><span id=__span-4-32><a id=__codelineno-4-32 name=__codelineno-4-32></a><a href=#__codelineno-4-32><span class=linenos data-linenos="32 "></span></a>            <span class=c1># Performance metrics</span>
</span><span id=__span-4-33><a id=__codelineno-4-33 name=__codelineno-4-33></a><a href=#__codelineno-4-33><span class=linenos data-linenos="33 "></span></a>            <span class=n>average_context_prep_time</span><span class=o>=</span><span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_avg_prep_time</span><span class=p>(</span><span class=n>parallel_group</span><span class=p>),</span>
</span><span id=__span-4-34><a id=__codelineno-4-34 name=__codelineno-4-34></a><a href=#__codelineno-4-34><span class=linenos data-linenos="34 "></span></a>            <span class=n>context_cache_hit_rate</span><span class=o>=</span><span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_cache_hit_rate</span><span class=p>(</span><span class=n>parallel_group</span><span class=p>),</span>
</span><span id=__span-4-35><a id=__codelineno-4-35 name=__codelineno-4-35></a><a href=#__codelineno-4-35><span class=linenos data-linenos="35 "></span></a>            <span class=n>compression_efficiency</span><span class=o>=</span><span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_compression_efficiency</span><span class=p>(</span><span class=n>parallel_group</span><span class=p>),</span>
</span><span id=__span-4-36><a id=__codelineno-4-36 name=__codelineno-4-36></a><a href=#__codelineno-4-36><span class=linenos data-linenos="36 "></span></a>            
</span><span id=__span-4-37><a id=__codelineno-4-37 name=__codelineno-4-37></a><a href=#__codelineno-4-37><span class=linenos data-linenos="37 "></span></a>            <span class=c1># Quality metrics</span>
</span><span id=__span-4-38><a id=__codelineno-4-38 name=__codelineno-4-38></a><a href=#__codelineno-4-38><span class=linenos data-linenos="38 "></span></a>            <span class=n>context_relevance_score</span><span class=o>=</span><span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_relevance_score</span><span class=p>(</span><span class=n>parallel_group</span><span class=p>),</span>
</span><span id=__span-4-39><a id=__codelineno-4-39 name=__codelineno-4-39></a><a href=#__codelineno-4-39><span class=linenos data-linenos="39 "></span></a>            <span class=n>context_completeness_score</span><span class=o>=</span><span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_completeness_score</span><span class=p>(</span><span class=n>parallel_group</span><span class=p>),</span>
</span><span id=__span-4-40><a id=__codelineno-4-40 name=__codelineno-4-40></a><a href=#__codelineno-4-40><span class=linenos data-linenos="40 "></span></a>            <span class=n>cross_cycle_consistency</span><span class=o>=</span><span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_consistency_score</span><span class=p>(</span><span class=n>parallel_group</span><span class=p>)</span>
</span><span id=__span-4-41><a id=__codelineno-4-41 name=__codelineno-4-41></a><a href=#__codelineno-4-41><span class=linenos data-linenos="41 "></span></a>        <span class=p>)</span>
</span><span id=__span-4-42><a id=__codelineno-4-42 name=__codelineno-4-42></a><a href=#__codelineno-4-42><span class=linenos data-linenos="42 "></span></a>        
</span><span id=__span-4-43><a id=__codelineno-4-43 name=__codelineno-4-43></a><a href=#__codelineno-4-43><span class=linenos data-linenos="43 "></span></a>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>metrics_collector</span><span class=o>.</span><span class=n>store_metrics</span><span class=p>(</span><span class=n>metrics</span><span class=p>)</span>
</span><span id=__span-4-44><a id=__codelineno-4-44 name=__codelineno-4-44></a><a href=#__codelineno-4-44><span class=linenos data-linenos="44 "></span></a>        <span class=k>return</span> <span class=n>metrics</span>
</span><span id=__span-4-45><a id=__codelineno-4-45 name=__codelineno-4-45></a><a href=#__codelineno-4-45><span class=linenos data-linenos="45 "></span></a>        
</span><span id=__span-4-46><a id=__codelineno-4-46 name=__codelineno-4-46></a><a href=#__codelineno-4-46><span class=linenos data-linenos="46 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>_calculate_token_efficiency</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>parallel_group</span><span class=p>:</span> <span class=n>ParallelGroup</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span><span id=__span-4-47><a id=__codelineno-4-47 name=__codelineno-4-47></a><a href=#__codelineno-4-47><span class=linenos data-linenos="47 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Calculate overall token usage efficiency&quot;&quot;&quot;</span>
</span><span id=__span-4-48><a id=__codelineno-4-48 name=__codelineno-4-48></a><a href=#__codelineno-4-48><span class=linenos data-linenos="48 "></span></a>        <span class=n>total_allocated</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>ctx</span><span class=o>.</span><span class=n>token_budget</span> <span class=k>for</span> <span class=n>ctx</span> <span class=ow>in</span> <span class=n>parallel_group</span><span class=o>.</span><span class=n>contexts</span><span class=p>)</span>
</span><span id=__span-4-49><a id=__codelineno-4-49 name=__codelineno-4-49></a><a href=#__codelineno-4-49><span class=linenos data-linenos="49 "></span></a>        <span class=n>total_used</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>ctx</span><span class=o>.</span><span class=n>tokens_used</span> <span class=k>for</span> <span class=n>ctx</span> <span class=ow>in</span> <span class=n>parallel_group</span><span class=o>.</span><span class=n>contexts</span><span class=p>)</span>
</span><span id=__span-4-50><a id=__codelineno-4-50 name=__codelineno-4-50></a><a href=#__codelineno-4-50><span class=linenos data-linenos="50 "></span></a>        
</span><span id=__span-4-51><a id=__codelineno-4-51 name=__codelineno-4-51></a><a href=#__codelineno-4-51><span class=linenos data-linenos="51 "></span></a>        <span class=k>if</span> <span class=n>total_allocated</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-4-52><a id=__codelineno-4-52 name=__codelineno-4-52></a><a href=#__codelineno-4-52><span class=linenos data-linenos="52 "></span></a>            <span class=k>return</span> <span class=mf>0.0</span>
</span><span id=__span-4-53><a id=__codelineno-4-53 name=__codelineno-4-53></a><a href=#__codelineno-4-53><span class=linenos data-linenos="53 "></span></a>            
</span><span id=__span-4-54><a id=__codelineno-4-54 name=__codelineno-4-54></a><a href=#__codelineno-4-54><span class=linenos data-linenos="54 "></span></a>        <span class=k>return</span> <span class=n>total_used</span> <span class=o>/</span> <span class=n>total_allocated</span>
</span><span id=__span-4-55><a id=__codelineno-4-55 name=__codelineno-4-55></a><a href=#__codelineno-4-55><span class=linenos data-linenos="55 "></span></a>        
</span><span id=__span-4-56><a id=__codelineno-4-56 name=__codelineno-4-56></a><a href=#__codelineno-4-56><span class=linenos data-linenos="56 "></span></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>analyze_performance_bottlenecks</span><span class=p>(</span>
</span><span id=__span-4-57><a id=__codelineno-4-57 name=__codelineno-4-57></a><a href=#__codelineno-4-57><span class=linenos data-linenos="57 "></span></a>        <span class=bp>self</span><span class=p>,</span> 
</span><span id=__span-4-58><a id=__codelineno-4-58 name=__codelineno-4-58></a><a href=#__codelineno-4-58><span class=linenos data-linenos="58 "></span></a>        <span class=n>parallel_group</span><span class=p>:</span> <span class=n>ParallelGroup</span>
</span><span id=__span-4-59><a id=__codelineno-4-59 name=__codelineno-4-59></a><a href=#__codelineno-4-59><span class=linenos data-linenos="59 "></span></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>PerformanceBottleneck</span><span class=p>]:</span>
</span><span id=__span-4-60><a id=__codelineno-4-60 name=__codelineno-4-60></a><a href=#__codelineno-4-60><span class=linenos data-linenos="60 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Identify context-related performance bottlenecks&quot;&quot;&quot;</span>
</span><span id=__span-4-61><a id=__codelineno-4-61 name=__codelineno-4-61></a><a href=#__codelineno-4-61><span class=linenos data-linenos="61 "></span></a>        
</span><span id=__span-4-62><a id=__codelineno-4-62 name=__codelineno-4-62></a><a href=#__codelineno-4-62><span class=linenos data-linenos="62 "></span></a>        <span class=n>bottlenecks</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-4-63><a id=__codelineno-4-63 name=__codelineno-4-63></a><a href=#__codelineno-4-63><span class=linenos data-linenos="63 "></span></a>        
</span><span id=__span-4-64><a id=__codelineno-4-64 name=__codelineno-4-64></a><a href=#__codelineno-4-64><span class=linenos data-linenos="64 "></span></a>        <span class=c1># Token allocation bottlenecks</span>
</span><span id=__span-4-65><a id=__codelineno-4-65 name=__codelineno-4-65></a><a href=#__codelineno-4-65><span class=linenos data-linenos="65 "></span></a>        <span class=n>token_analysis</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_analyze_token_bottlenecks</span><span class=p>(</span><span class=n>parallel_group</span><span class=p>)</span>
</span><span id=__span-4-66><a id=__codelineno-4-66 name=__codelineno-4-66></a><a href=#__codelineno-4-66><span class=linenos data-linenos="66 "></span></a>        <span class=n>bottlenecks</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>token_analysis</span><span class=o>.</span><span class=n>bottlenecks</span><span class=p>)</span>
</span><span id=__span-4-67><a id=__codelineno-4-67 name=__codelineno-4-67></a><a href=#__codelineno-4-67><span class=linenos data-linenos="67 "></span></a>        
</span><span id=__span-4-68><a id=__codelineno-4-68 name=__codelineno-4-68></a><a href=#__codelineno-4-68><span class=linenos data-linenos="68 "></span></a>        <span class=c1># Context preparation bottlenecks</span>
</span><span id=__span-4-69><a id=__codelineno-4-69 name=__codelineno-4-69></a><a href=#__codelineno-4-69><span class=linenos data-linenos="69 "></span></a>        <span class=n>prep_analysis</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_analyze_preparation_bottlenecks</span><span class=p>(</span><span class=n>parallel_group</span><span class=p>)</span>
</span><span id=__span-4-70><a id=__codelineno-4-70 name=__codelineno-4-70></a><a href=#__codelineno-4-70><span class=linenos data-linenos="70 "></span></a>        <span class=n>bottlenecks</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>prep_analysis</span><span class=o>.</span><span class=n>bottlenecks</span><span class=p>)</span>
</span><span id=__span-4-71><a id=__codelineno-4-71 name=__codelineno-4-71></a><a href=#__codelineno-4-71><span class=linenos data-linenos="71 "></span></a>        
</span><span id=__span-4-72><a id=__codelineno-4-72 name=__codelineno-4-72></a><a href=#__codelineno-4-72><span class=linenos data-linenos="72 "></span></a>        <span class=c1># Sharing inefficiencies</span>
</span><span id=__span-4-73><a id=__codelineno-4-73 name=__codelineno-4-73></a><a href=#__codelineno-4-73><span class=linenos data-linenos="73 "></span></a>        <span class=n>sharing_analysis</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_analyze_sharing_bottlenecks</span><span class=p>(</span><span class=n>parallel_group</span><span class=p>)</span>
</span><span id=__span-4-74><a id=__codelineno-4-74 name=__codelineno-4-74></a><a href=#__codelineno-4-74><span class=linenos data-linenos="74 "></span></a>        <span class=n>bottlenecks</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>sharing_analysis</span><span class=o>.</span><span class=n>bottlenecks</span><span class=p>)</span>
</span><span id=__span-4-75><a id=__codelineno-4-75 name=__codelineno-4-75></a><a href=#__codelineno-4-75><span class=linenos data-linenos="75 "></span></a>        
</span><span id=__span-4-76><a id=__codelineno-4-76 name=__codelineno-4-76></a><a href=#__codelineno-4-76><span class=linenos data-linenos="76 "></span></a>        <span class=k>return</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>bottlenecks</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>b</span><span class=p>:</span> <span class=n>b</span><span class=o>.</span><span class=n>impact_score</span><span class=p>,</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></code></pre></div><p>This comprehensive parallel context integration system ensures that the Context Management System works optimally with parallel TDD execution, providing intelligent token distribution, efficient context sharing, and sophisticated optimization while maintaining context quality and agent performance.</p><aside class=md-source-file><span class=md-source-file__fact><span class=md-icon title="Last update"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime" title="June 18, 2025 00:22:32 UTC">June 18, 2025 00:22:32</span></span><span class=md-source-file__fact><span class=md-icon title=Created><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime" title="June 18, 2025 00:22:32 UTC">June 18, 2025 00:22:32</span></span></aside><form class=md-feedback name=feedback hidden><fieldset><legend class=md-feedback__title> Was this page helpful? </legend><div class=md-feedback__inner><div class=md-feedback__list><button class="md-feedback__icon md-icon" type=submit title="This page was helpful" data-md-value=1><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"/></svg></button><button class="md-feedback__icon md-icon" type=submit title="This page could be improved" data-md-value=0><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"/></svg></button></div><div class=md-feedback__note><div data-md-value=1 hidden> Thanks for your feedback! </div><div data-md-value=0 hidden> Thanks for your feedback! Help us improve this page by <a href="https://github.com/jmontp/agent-workflow/issues/new/?title=[Feedback]+%F0%9F%94%97%20Context%20Integration+-+/architecture/parallel-context-integration/" target=_blank rel=noopener>telling us what you found confusing</a>. </div></div></div></fieldset></form></article></div><script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script><script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script></div><button type=button class="md-top md-icon" data-md-component=top hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button></main><footer class=md-footer><nav class="md-footer__inner md-grid" aria-label=Footer><a href=../parallel-tdd-testing-strategy/ class="md-footer__link md-footer__link--prev" aria-label="Previous: ğŸ§ª Testing Strategy"><div class="md-footer__button md-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M15.41 16.58 10.83 12l4.58-4.59L14 6l-6 6 6 6z"/></svg></div><div class=md-footer__title><span class=md-footer__direction> Previous </span><div class=md-ellipsis> ğŸ§ª Testing Strategy </div></div></a><a href=../parallel-agent-pool-management/ class="md-footer__link md-footer__link--next" aria-label="Next: ğŸ¤– Agent Pool Management"><div class=md-footer__title><span class=md-footer__direction> Next </span><div class=md-ellipsis> ğŸ¤– Agent Pool Management </div></div><div class="md-footer__button md-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg></div></a></nav><div class="md-footer-meta md-typeset"><div class="md-footer-meta__inner md-grid"><div class=md-copyright></div><div class=md-social><a href=https://github.com/jmontp/agent-workflow target=_blank rel=noopener title="GitHub Repository" class=md-social__link><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"/></svg></a><a href=https://jmontp.github.io/agent-workflow/ target=_blank rel=noopener title="Documentation Site" class=md-social__link><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m19 2-5 4.5v11l5-4.5zM6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5"/></svg></a><a href=https://discord.gg/your-discord-server target=_blank rel=noopener title="Discord Community" class=md-social__link><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 3c5.5 0 10 3.58 10 8s-4.5 8-10 8c-1.24 0-2.43-.18-3.53-.5C5.55 21 2 21 2 21c2.33-2.33 2.7-3.9 2.75-4.5C3.05 15.07 2 13.13 2 11c0-4.42 4.5-8 10-8"/></svg></a><a href=https://github.com/sponsors/jmontp target=_blank rel=noopener title=Sponsor class=md-social__link><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m12 21.35-1.45-1.32C5.4 15.36 2 12.27 2 8.5 2 5.41 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.08C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.41 22 8.5c0 3.77-3.4 6.86-8.55 11.53z"/></svg></a></div></div></div></footer></div><div class=md-dialog data-md-component=dialog><div class="md-dialog__inner md-typeset"></div></div><div class=md-progress data-md-component=progress role=progressbar></div><div class=md-consent data-md-component=consent id=__consent hidden><div class=md-consent__overlay></div><aside class=md-consent__inner><form class="md-consent__form md-grid md-typeset" name=consent><h4>Cookie consent</h4><p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p><input class=md-toggle type=checkbox id=__settings><div class=md-consent__settings><ul class=task-list><li class=task-list-item><label class=task-list-control><input type=checkbox name=analytics checked><span class=task-list-indicator></span> Google Analytics </label></li><li class=task-list-item><label class=task-list-control><input type=checkbox name=github checked><span class=task-list-indicator></span> GitHub </label></li></ul></div><div class=md-consent__controls><button class="md-button md-button--primary">Accept</button><button type=reset class="md-button md-button--primary">Reject</button><label class=md-button for=__settings>Manage settings</label></div></form></aside></div><script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script><script id=__config type=application/json>{"base": "../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.code.select", "content.footnote.tooltips", "content.tabs.link", "content.tooltips", "header.autohide", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": {"API": "api", "Architecture": "architecture", "CSS": "css", "Discord": "discord", "HTML5": "html", "JavaScript": "js", "Python": "python", "Scrum": "scrum", "TDD": "tdd"}, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "stable", "provider": "mike"}}</script><script src=../../assets/javascripts/bundle.13a4f30d.min.js></script><script src=https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mtml-chtml.js></script><script src=../../js/mermaid-zoom.js></script><script src=../../js/universal-search.js></script><script src=../../js/enhanced-navigation.js></script><script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body></html>