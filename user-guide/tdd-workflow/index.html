<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Human-In-The-Loop orchestration framework for AI-assisted software development"><meta name=author content="AI Agent Workflow Team"><link href=https://jmontp.github.io/agent-workflow/user-guide/tdd-workflow/ rel=canonical><link href=../state-machine/ rel=prev><link href=../multi-project-orchestration/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.14"><title>🧪 TDD Workflow - AI Agent TDD-Scrum Workflow</title><link rel=stylesheet href=../../assets/stylesheets/main.342714a4.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><style>:root{.md-tag{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22M5.5%207A1.5%201.5%200%200%201%204%205.5%201.5%201.5%200%200%201%205.5%204%201.5%201.5%200%200%201%207%205.5%201.5%201.5%200%200%201%205.5%207m15.91%204.58-9-9C12.05%202.22%2011.55%202%2011%202H4c-1.11%200-2%20.89-2%202v7c0%20.55.22%201.05.59%201.41l8.99%209c.37.36.87.59%201.42.59s1.05-.23%201.41-.59l7-7c.37-.36.59-.86.59-1.41%200-.56-.23-1.06-.59-1.42%22/%3E%3C/svg%3E');}.md-tag.md-tag--html{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22m12%2017.56%204.07-1.13.55-6.1H9.38L9.2%208.3h7.6l.2-1.99H7l.56%206.01h6.89l-.23%202.58-2.22.6-2.22-.6-.14-1.66h-2l.29%203.19zM4.07%203h15.86L18.5%2019.2%2012%2021l-6.5-1.8z%22/%3E%3C/svg%3E');}.md-tag.md-tag--js{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22M3%203h18v18H3zm4.73%2015.04c.4.85%201.19%201.55%202.54%201.55%201.5%200%202.53-.8%202.53-2.55v-5.78h-1.7V17c0%20.86-.35%201.08-.9%201.08-.58%200-.82-.4-1.09-.87zm5.98-.18c.5.98%201.51%201.73%203.09%201.73%201.6%200%202.8-.83%202.8-2.36%200-1.41-.81-2.04-2.25-2.66l-.42-.18c-.73-.31-1.04-.52-1.04-1.02%200-.41.31-.73.81-.73.48%200%20.8.21%201.09.73l1.31-.87c-.55-.96-1.33-1.33-2.4-1.33-1.51%200-2.48.96-2.48%202.23%200%201.38.81%202.03%202.03%202.55l.42.18c.78.34%201.24.55%201.24%201.13%200%20.48-.45.83-1.15.83-.83%200-1.31-.43-1.67-1.03z%22/%3E%3C/svg%3E');}.md-tag.md-tag--css{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22m5%203-.65%203.34h13.59L17.5%208.5H3.92l-.66%203.33h13.59l-.76%203.81-5.48%201.81-4.75-1.81.33-1.64H2.85l-.79%204%207.85%203%209.05-3%201.2-6.03.24-1.21L21.94%203z%22/%3E%3C/svg%3E');}.md-tag.md-tag--python{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22M19.14%207.5A2.86%202.86%200%200%201%2022%2010.36v3.78A2.86%202.86%200%200%201%2019.14%2017H12c0%20.39.32.96.71.96H17v1.68a2.86%202.86%200%200%201-2.86%202.86H9.86A2.86%202.86%200%200%201%207%2019.64v-3.75a2.85%202.85%200%200%201%202.86-2.85h5.25a2.85%202.85%200%200%200%202.85-2.86V7.5zm-4.28%2011.79c-.4%200-.72.3-.72.89s.32.71.72.71a.71.71%200%200%200%20.71-.71c0-.59-.32-.89-.71-.89m-10-1.79A2.86%202.86%200%200%201%202%2014.64v-3.78A2.86%202.86%200%200%201%204.86%208H12c0-.39-.32-.96-.71-.96H7V5.36A2.86%202.86%200%200%201%209.86%202.5h4.28A2.86%202.86%200%200%201%2017%205.36v3.75a2.85%202.85%200%200%201-2.86%202.85H8.89a2.85%202.85%200%200%200-2.85%202.86v2.68zM9.14%205.71c.4%200%20.72-.3.72-.89s-.32-.71-.72-.71c-.39%200-.71.12-.71.71s.32.89.71.89%22/%3E%3C/svg%3E');}}</style><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style><link rel=stylesheet href=../../stylesheets/extra.css><link rel=stylesheet href=../../stylesheets/enhanced-navigation.css><link rel=stylesheet href=../../stylesheets/color-schemes.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config",""),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script> <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head><body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=black><input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off><input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off><label class=md-overlay for=__drawer></label><div data-md-component=skip><a href=#the-tdd-adventure-building-software-with-confidence class=md-skip> Skip to content </a></div><div data-md-component=announce></div><div data-md-color-scheme=default data-md-component=outdated hidden></div><header class="md-header md-header--shadow md-header--lifted" data-md-component=header><nav class="md-header__inner md-grid" aria-label=Header><a href=../.. title="AI Agent TDD-Scrum Workflow" class="md-header__button md-logo" aria-label="AI Agent TDD-Scrum Workflow" data-md-component=logo><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m19 2-5 4.5v11l5-4.5zM6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5"/></svg></a><label class="md-header__button md-icon" for=__drawer><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg></label><div class=md-header__title data-md-component=header-title><div class=md-header__ellipsis><div class=md-header__topic><span class=md-ellipsis> AI Agent TDD-Scrum Workflow </span></div><div class=md-header__topic data-md-component=header-topic><span class=md-ellipsis> 🧪 TDD Workflow </span></div></div></div><div class=md-header__option><div class=md-select><button class="md-header__button md-icon" aria-label="Select language"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg></button><div class=md-select__inner><ul class=md-select__list><li class=md-select__item><a href=../../ hreflang=en class=md-select__link> English </a></li></ul></div></div></div><label class="md-header__button md-icon" for=__search><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg></label><div class=md-search data-md-component=search role=dialog><label class=md-search__overlay for=__search></label><div class=md-search__inner role=search><form class=md-search__form name=search><input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required><label class="md-search__icon md-icon" for=__search><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M15.41 16.58 10.83 12l4.58-4.59L14 6l-6 6 6 6z"/></svg></label><nav class=md-search__options aria-label=Search><a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg></a><button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></nav><div class=md-search__suggest data-md-component=search-suggest></div></form><div class=md-search__output><div class=md-search__scrollwrap tabindex=0 data-md-scrollfix><div class=md-search-result data-md-component=search-result><div class=md-search-result__meta> Initializing search </div><ol class=md-search-result__list role=presentation></ol></div></div></div></div></div><div class=md-header__source><a href=https://github.com/jmontp/agent-workflow title="Go to repository" class=md-source data-md-component=source><div class="md-source__icon md-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"/></svg></div><div class=md-source__repository> jmontp/agent-workflow </div></a></div></nav><nav class=md-tabs aria-label=Tabs data-md-component=tabs><div class=md-grid><ul class=md-tabs__list><li class=md-tabs__item><a href=../.. class=md-tabs__link> 🏠 Home </a></li><li class=md-tabs__item><a href=../../getting-started/ class=md-tabs__link> ⚡ Getting Started </a></li><li class="md-tabs__item md-tabs__item--active"><a href=../ class=md-tabs__link> 📊 User Guide </a></li><li class=md-tabs__item><a href=../../concepts/ class=md-tabs__link> 🎯 Core Concepts </a></li><li class=md-tabs__item><a href=../../architecture/ class=md-tabs__link> 🔥 Architecture </a></li><li class=md-tabs__item><a href=../../advanced/ class=md-tabs__link> ⚡ Advanced Topics </a></li><li class=md-tabs__item><a href=../../planning/ class=md-tabs__link> 🎨 Planning & Design </a></li><li class=md-tabs__item><a href=../../development/ class=md-tabs__link> 📊 Development </a></li><li class=md-tabs__item><a href=../../deployment/ class=md-tabs__link> 🔥 Deployment </a></li><li class=md-tabs__item><a href=../../templates/ class=md-tabs__link> 📋 Templates </a></li><li class=md-tabs__item><a href=../../theme-integration-guide/ class=md-tabs__link> 🎨 Theme Integration </a></li></ul></div></nav></header><div class=md-container data-md-component=container><main class=md-main data-md-component=main><div class="md-main__inner md-grid"><div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation><div class=md-sidebar__scrollwrap><div class=md-sidebar__inner><nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0><label class=md-nav__title for=__drawer><a href=../.. title="AI Agent TDD-Scrum Workflow" class="md-nav__button md-logo" aria-label="AI Agent TDD-Scrum Workflow" data-md-component=logo><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m19 2-5 4.5v11l5-4.5zM6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5"/></svg></a> AI Agent TDD-Scrum Workflow </label><div class=md-nav__source><a href=https://github.com/jmontp/agent-workflow title="Go to repository" class=md-source data-md-component=source><div class="md-source__icon md-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"/></svg></div><div class=md-source__repository> jmontp/agent-workflow </div></a></div><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../.. class=md-nav__link><span class=md-ellipsis> 🏠 Home </span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../../getting-started/ class=md-nav__link><span class=md-ellipsis> ⚡ Getting Started </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked><div class="md-nav__link md-nav__container"><a href=../ class="md-nav__link "><span class=md-ellipsis> 📊 User Guide </span></a><label class="md-nav__link " for=__nav_3 id=__nav_3_label tabindex><span class="md-nav__icon md-icon"></span></label></div><nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true><label class=md-nav__title for=__nav_3><span class="md-nav__icon md-icon"></span> 📊 User Guide </label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a href=../hitl-commands/ class=md-nav__link><span class=md-ellipsis> 🎮 HITL Commands </span></a></li><li class=md-nav__item><a href=../state-machine/ class=md-nav__link><span class=md-ellipsis> 🔄 State Machine </span></a></li><li class="md-nav__item md-nav__item--active"><input class="md-nav__toggle md-toggle" type=checkbox id=__toc><label class="md-nav__link md-nav__link--active" for=__toc><span class=md-ellipsis> 🧪 TDD Workflow </span><span class="md-nav__icon md-icon"></span></label><a href=./ class="md-nav__link md-nav__link--active"><span class=md-ellipsis> 🧪 TDD Workflow </span></a><nav class="md-nav md-nav--secondary" aria-label="On this page"><label class=md-nav__title for=__toc><span class="md-nav__icon md-icon"></span> On this page </label><ul class=md-nav__list data-md-component=toc data-md-scrollfix><li class=md-nav__item><a href=#chapter-1-the-three-sacred-colors-of-tdd class=md-nav__link><span class=md-ellipsis> Chapter 1: The Three Sacred Colors of TDD </span></a><nav class=md-nav aria-label="Chapter 1: The Three Sacred Colors of TDD"><ul class=md-nav__list><li class=md-nav__item><a href=#a-tale-of-two-developers class=md-nav__link><span class=md-ellipsis> A Tale of Two Developers </span></a></li><li class=md-nav__item><a href=#the-sacred-cycle-red-green-refactor class=md-nav__link><span class=md-ellipsis> The Sacred Cycle: RED-GREEN-REFACTOR </span></a></li></ul></nav></li><li class=md-nav__item><a href=#chapter-2-why-ai-and-tdd-are-perfect-partners class=md-nav__link><span class=md-ellipsis> Chapter 2: Why AI and TDD Are Perfect Partners </span></a><nav class=md-nav aria-label="Chapter 2: Why AI and TDD Are Perfect Partners"><ul class=md-nav__list><li class=md-nav__item><a href=#the-superhuman-combination class=md-nav__link><span class=md-ellipsis> The Superhuman Combination </span></a></li><li class=md-nav__item><a href=#the-numbers-dont-lie class=md-nav__link><span class=md-ellipsis> 📊 The Numbers Don't Lie </span></a></li><li class=md-nav__item><a href=#the-magic-of-cognitive-load-distribution class=md-nav__link><span class=md-ellipsis> The Magic of Cognitive Load Distribution </span></a></li><li class=md-nav__item><a href=#success-story-the-weekend-miracle class=md-nav__link><span class=md-ellipsis> Success Story: The Weekend Miracle </span></a></li><li class=md-nav__item><a href=#the-ai-tdd-advantage-matrix class=md-nav__link><span class=md-ellipsis> The AI TDD Advantage Matrix </span></a></li></ul></nav></li><li class=md-nav__item><a href=#chapter-3-your-first-tdd-adventure class=md-nav__link><span class=md-ellipsis> Chapter 3: Your First TDD Adventure </span></a><nav class=md-nav aria-label="Chapter 3: Your First TDD Adventure"><ul class=md-nav__list><li class=md-nav__item><a href=#building-a-saas-feature-in-real-time class=md-nav__link><span class=md-ellipsis> Building a SaaS Feature in Real-Time </span></a></li><li class=md-nav__item><a href=#scene-1-the-morning-kickoff-900-am class=md-nav__link><span class=md-ellipsis> 🎬 Scene 1: The Morning Kickoff (9:00 AM) </span></a></li><li class=md-nav__item><a href=#the-design-agent-takes-the-stage-905-am class=md-nav__link><span class=md-ellipsis> 🎨 The Design Agent Takes the Stage (9:05 AM) </span></a></li><li class=md-nav__item><a href=#the-qa-agent-enters-the-scene-920-am class=md-nav__link><span class=md-ellipsis> 🔴 The QA Agent Enters the Scene (9:20 AM) </span></a></li><li class=md-nav__item><a href=#the-code-agents-grand-entrance-940-am class=md-nav__link><span class=md-ellipsis> 🟢 The Code Agent's Grand Entrance (9:40 AM) </span></a></li><li class=md-nav__item><a href=#the-refactor-phase-from-working-to-beautiful-1030-am class=md-nav__link><span class=md-ellipsis> 🔵 The Refactor Phase: From Working to Beautiful (10:30 AM) </span></a></li><li class=md-nav__item><a href=#scene-4-the-victory-lap-1115-am class=md-nav__link><span class=md-ellipsis> 🎬 Scene 4: The Victory Lap (11:15 AM) </span></a></li></ul></nav></li><li class=md-nav__item><a href=#chapter-4-the-tdd-evolution-timeline class=md-nav__link><span class=md-ellipsis> Chapter 4: The TDD Evolution Timeline </span></a><nav class=md-nav aria-label="Chapter 4: The TDD Evolution Timeline"><ul class=md-nav__list><li class=md-nav__item><a href=#how-code-grows-through-tdd-cycles class=md-nav__link><span class=md-ellipsis> 📊 How Code Grows Through TDD Cycles </span></a></li></ul></nav></li><li class=md-nav__item><a href=#chapter-5-the-visual-story-of-tdd-success class=md-nav__link><span class=md-ellipsis> Chapter 5: The Visual Story of TDD Success </span></a><nav class=md-nav aria-label="Chapter 5: The Visual Story of TDD Success"><ul class=md-nav__list><li class=md-nav__item><a href=#real-time-progress-tracking class=md-nav__link><span class=md-ellipsis> 📈 Real-Time Progress Tracking </span></a></li><li class=md-nav__item><a href=#the-transformation-journey-before-vs-after class=md-nav__link><span class=md-ellipsis> The Transformation Journey: Before vs After </span></a></li></ul></nav></li><li class=md-nav__item><a href=#chapter-6-the-success-metrics-that-matter class=md-nav__link><span class=md-ellipsis> Chapter 6: The Success Metrics That Matter </span></a><nav class=md-nav aria-label="Chapter 6: The Success Metrics That Matter"><ul class=md-nav__list><li class=md-nav__item><a href=#your-tdd-victory-dashboard class=md-nav__link><span class=md-ellipsis> 🏆 Your TDD Victory Dashboard </span></a></li></ul></nav></li><li class=md-nav__item><a href=#chapter-7-meet-your-ai-dream-team class=md-nav__link><span class=md-ellipsis> Chapter 7: Meet Your AI Dream Team </span></a><nav class=md-nav aria-label="Chapter 7: Meet Your AI Dream Team"><ul class=md-nav__list><li class=md-nav__item><a href=#qa-agent-the-perfectionist-tester class=md-nav__link><span class=md-ellipsis> 🔴 QA Agent: The Perfectionist Tester </span></a></li><li class=md-nav__item><a href=#code-agent-the-implementation-virtuoso class=md-nav__link><span class=md-ellipsis> 🟢 Code Agent: The Implementation Virtuoso </span></a></li><li class=md-nav__item><a href=#design-agent-the-architecture-visionary class=md-nav__link><span class=md-ellipsis> 🎨 Design Agent: The Architecture Visionary </span></a></li><li class=md-nav__item><a href=#data-agent-the-analytics-guru class=md-nav__link><span class=md-ellipsis> 📊 Data Agent: The Analytics Guru </span></a></li></ul></nav></li><li class=md-nav__item><a href=#epilogue-your-journey-from-fear-to-confidence class=md-nav__link><span class=md-ellipsis> Epilogue: Your Journey from Fear to Confidence </span></a><nav class=md-nav aria-label="Epilogue: Your Journey from Fear to Confidence"><ul class=md-nav__list><li class=md-nav__item><a href=#the-old-way-vs-the-new-way class=md-nav__link><span class=md-ellipsis> The Old Way vs The New Way </span></a></li><li class=md-nav__item><a href=#the-three-pillars-of-tdd-mastery class=md-nav__link><span class=md-ellipsis> 🎯 The Three Pillars of TDD Mastery </span></a></li><li class=md-nav__item><a href=#your-next-steps class=md-nav__link><span class=md-ellipsis> 🚀 Your Next Steps </span></a></li><li class=md-nav__item><a href=#the-transformation-is-real class=md-nav__link><span class=md-ellipsis> 🌟 The Transformation is Real </span></a></li><li class=md-nav__item><a href=#welcome-to-the-future-of-software-development class=md-nav__link><span class=md-ellipsis> 🎉 Welcome to the Future of Software Development </span></a></li></ul></nav></li></ul></nav></li><li class=md-nav__item><a href=../multi-project-orchestration/ class=md-nav__link><span class=md-ellipsis> 🎯 Multi-Project Orchestration </span></a></li><li class=md-nav__item><a href=../project-setup/ class=md-nav__link><span class=md-ellipsis> 📂 Project Setup </span></a></li><li class=md-nav__item><a href=../workflow-sequences/ class=md-nav__link><span class=md-ellipsis> 🔗 Workflow Sequences </span></a></li><li class=md-nav__item><a href=../cli-reference/ class=md-nav__link><span class=md-ellipsis> 💻 CLI Reference </span></a></li><li class=md-nav__item><a href=../testing/ class=md-nav__link><span class=md-ellipsis> ✅ Testing </span></a></li><li class=md-nav__item><a href=../performance-optimization/ class=md-nav__link><span class=md-ellipsis> ⚡ Performance Optimization </span></a></li><li class=md-nav__item><a href=../integration-examples/ class=md-nav__link><span class=md-ellipsis> 🔌 Integration Examples </span></a></li><li class=md-nav__item><a href=../ui-portal-guide/ class=md-nav__link><span class=md-ellipsis> 🎨 UI Portal Guide </span></a></li><li class=md-nav__item><a href=../user-profile/ class=md-nav__link><span class=md-ellipsis> 👤 User Profile </span></a></li><li class=md-nav__item><a href=../troubleshooting/ class=md-nav__link><span class=md-ellipsis> 🔧 Troubleshooting </span></a></li><li class=md-nav__item><a href=../faq/ class=md-nav__link><span class=md-ellipsis> ❓ FAQ </span></a></li></ul></nav></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../../concepts/ class=md-nav__link><span class=md-ellipsis> 🎯 Core Concepts </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../../architecture/ class=md-nav__link><span class=md-ellipsis> 🔥 Architecture </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../../advanced/ class=md-nav__link><span class=md-ellipsis> ⚡ Advanced Topics </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../../planning/ class=md-nav__link><span class=md-ellipsis> 🎨 Planning & Design </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../../development/ class=md-nav__link><span class=md-ellipsis> 📊 Development </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../../deployment/ class=md-nav__link><span class=md-ellipsis> 🔥 Deployment </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../../templates/ class=md-nav__link><span class=md-ellipsis> 📋 Templates </span><span class="md-nav__icon md-icon"></span></a></li><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a href=../../theme-integration-guide/ class=md-nav__link><span class=md-ellipsis> 🎨 Theme Integration </span><span class="md-nav__icon md-icon"></span></a></li></ul></nav></div></div></div><div class=md-content data-md-component=content><article class="md-content__inner md-typeset"><a href=https://github.com/jmontp/agent-workflow/edit/master/docs/user-guide/tdd-workflow.md title="Edit this page" class="md-content__button md-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg></a><a href=https://github.com/jmontp/agent-workflow/raw/master/docs/user-guide/tdd-workflow.md title="View source of this page" class="md-content__button md-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg></a><h1 id=the-tdd-adventure-building-software-with-confidence>The TDD Adventure: Building Software with Confidence<a class=headerlink href=#the-tdd-adventure-building-software-with-confidence title="Permanent link">&para;</a></h1><blockquote><p><em>"In the beginning was the test, and the test was with the developer, and the test was good."</em><br> — Ancient TDD Proverb (probably)</p></blockquote><p>Picture this: It's Friday afternoon, and your manager drops by your desk with that look. You know the one—the "we need this feature by Monday" look. In the old days, this would mean a weekend of frantic coding, crossed fingers, and energy drinks. But not anymore.</p><p>Welcome to the world of AI-assisted Test-Driven Development, where software gets built like a well-orchestrated symphony. Each AI agent plays its part perfectly, tests guide every decision, and you ship with confidence instead of anxiety.</p><p>This isn't just another development methodology—it's a fundamental shift in how humans and AI collaborate to create software. Let's embark on this journey together, starting with a story that might sound familiar.</p><h2 id=chapter-1-the-three-sacred-colors-of-tdd>Chapter 1: The Three Sacred Colors of TDD<a class=headerlink href=#chapter-1-the-three-sacred-colors-of-tdd title="Permanent link">&para;</a></h2><h3 id=a-tale-of-two-developers>A Tale of Two Developers<a class=headerlink href=#a-tale-of-two-developers title="Permanent link">&para;</a></h3><p>Let me tell you about Sarah and Marcus, two developers working on the same startup. Both were tasked with building a user authentication system for their SaaS platform.</p><p><strong>Sarah</strong> decided to dive straight into coding. She spent three days building what she thought was a perfect authentication system. It looked clean, had all the features, and even had some unit tests. But when she deployed to staging, everything broke. Users couldn't log in, passwords weren't validating correctly, and the session management was completely broken. She spent the next week debugging, patching, and basically rewriting everything.</p><p><strong>Marcus</strong>, on the other hand, started with a single failing test. He wrote tests for every behavior he wanted to see, watched them fail (RED), then wrote just enough code to make them pass (GREEN), and finally cleaned up the implementation (REFACTOR). By the end of the week, he had a rock-solid authentication system that worked flawlessly in production.</p><p>The difference? Marcus let the tests guide his implementation. Sarah tried to guess what the code should do.</p><h3 id=the-sacred-cycle-red-green-refactor>The Sacred Cycle: RED-GREEN-REFACTOR<a class=headerlink href=#the-sacred-cycle-red-green-refactor title="Permanent link">&para;</a></h3><p>This isn't just a process—it's a philosophy. Each color represents a different mindset, a different way of thinking about your code:</p><h4 id=red-the-moment-of-truth>🔴 RED: The Moment of Truth<a class=headerlink href=#red-the-moment-of-truth title="Permanent link">&para;</a></h4><p><em>"What exactly do I want this code to do?"</em></p><p>In the RED phase, you're not a developer—you're a specification writer. You're documenting your intentions in executable form. The failing test is like a lighthouse beacon, showing you exactly where you need to go.</p><h4 id=green-the-art-of-simplicity>🟢 GREEN: The Art of Simplicity<a class=headerlink href=#green-the-art-of-simplicity title="Permanent link">&para;</a></h4><p><em>"What's the simplest thing that could possibly work?"</em></p><p>In the GREEN phase, you transform into a problem-solver with a laser focus. You're not building the perfect solution—you're building the simplest solution that makes the test pass. Elegance comes later.</p><h4 id=refactor-the-pursuit-of-beauty>🔵 REFACTOR: The Pursuit of Beauty<a class=headerlink href=#refactor-the-pursuit-of-beauty title="Permanent link">&para;</a></h4><p><em>"How can I make this code sing?"</em></p><p>In the REFACTOR phase, you become an artist. Now that you know the code works (the tests prove it), you can make it beautiful, readable, and maintainable without fear of breaking anything.</p><pre class=mermaid><code>graph TB
    subgraph "🔴 RED Phase: Intention"
        R1["📝 Write Failing Test&lt;br/&gt;&lt;i&gt;What should happen?&lt;/i&gt;"]
        R2["🎯 Define Expected Behavior&lt;br/&gt;&lt;i&gt;Specify the contract&lt;/i&gt;"]
        R3["❌ Verify Test Fails&lt;br/&gt;&lt;i&gt;Confirm we're testing the right thing&lt;/i&gt;"]
        R1 --&gt; R2 --&gt; R3
    end
    
    subgraph "🟢 GREEN Phase: Implementation"
        G1["⚡ Write Minimal Code&lt;br/&gt;&lt;i&gt;Make it work, don't make it perfect&lt;/i&gt;"]
        G2["✅ Make Test Pass&lt;br/&gt;&lt;i&gt;Focus on solving the specific problem&lt;/i&gt;"]
        G3["🧪 Run All Tests&lt;br/&gt;&lt;i&gt;Ensure nothing else broke&lt;/i&gt;"]
        G1 --&gt; G2 --&gt; G3
    end
    
    subgraph "🔵 REFACTOR Phase: Refinement"
        F1["✨ Improve Code Quality&lt;br/&gt;&lt;i&gt;Make it readable and maintainable&lt;/i&gt;"]
        F2["🔄 Remove Duplication&lt;br/&gt;&lt;i&gt;DRY principle application&lt;/i&gt;"]
        F3["🔒 Maintain Green Tests&lt;br/&gt;&lt;i&gt;Safety net stays intact&lt;/i&gt;"]
        F1 --&gt; F2 --&gt; F3
    end
    
    R3 --&gt; G1
    G3 --&gt; F1
    F3 --&gt; R1
    
    QA["🤖 QA Agent&lt;br/&gt;Test Creator"] -.-&gt; R1
    CA["🤖 Code Agent&lt;br/&gt;Implementation"] -.-&gt; G1
    CA -.-&gt; F1
    DA["🤖 Design Agent&lt;br/&gt;Architecture"] -.-&gt; R2
    
    style R1 fill:#ffcccc
    style R2 fill:#ffcccc  
    style R3 fill:#ffcccc
    style G1 fill:#ccffcc
    style G2 fill:#ccffcc
    style G3 fill:#ccffcc
    style F1 fill:#ccccff
    style F2 fill:#ccccff
    style F3 fill:#ccccff</code></pre><h2 id=chapter-2-why-ai-and-tdd-are-perfect-partners>Chapter 2: Why AI and TDD Are Perfect Partners<a class=headerlink href=#chapter-2-why-ai-and-tdd-are-perfect-partners title="Permanent link">&para;</a></h2><h3 id=the-superhuman-combination>The Superhuman Combination<a class=headerlink href=#the-superhuman-combination title="Permanent link">&para;</a></h3><p>Here's the secret: TDD isn't just better with AI—it's <em>transformed</em> by AI. Let me show you why with a real story.</p><h3 id=the-numbers-dont-lie>📊 The Numbers Don't Lie<a class=headerlink href=#the-numbers-dont-lie title="Permanent link">&para;</a></h3><p>Remember Marcus from our earlier story? Let's look at what happened when he started using AI-assisted TDD:</p><div class="language-text highlight"><span class=filename>Text Only</span><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1></a><a href=#__codelineno-0-1><span class=linenos data-linenos=" 1 "></span></a>Traditional TDD (Marcus alone):
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2></a><a href=#__codelineno-0-2><span class=linenos data-linenos=" 2 "></span></a>- Authentication system: 5 days
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3></a><a href=#__codelineno-0-3><span class=linenos data-linenos=" 3 "></span></a>- Test coverage: 78%
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4></a><a href=#__codelineno-0-4><span class=linenos data-linenos=" 4 "></span></a>- Bugs found in production: 3
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5></a><a href=#__codelineno-0-5><span class=linenos data-linenos=" 5 "></span></a>- Time spent debugging: 8 hours
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6></a><a href=#__codelineno-0-6><span class=linenos data-linenos=" 6 "></span></a>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7></a><a href=#__codelineno-0-7><span class=linenos data-linenos=" 7 "></span></a>AI-Assisted TDD (Marcus + AI agents):
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8></a><a href=#__codelineno-0-8><span class=linenos data-linenos=" 8 "></span></a>- Authentication system: 6 hours
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9></a><a href=#__codelineno-0-9><span class=linenos data-linenos=" 9 "></span></a>- Test coverage: 96%
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10></a><a href=#__codelineno-0-10><span class=linenos data-linenos="10 "></span></a>- Bugs found in production: 0
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11></a><a href=#__codelineno-0-11><span class=linenos data-linenos="11 "></span></a>- Time spent debugging: 0 hours
</span></code></pre></div><h3 id=the-magic-of-cognitive-load-distribution>The Magic of Cognitive Load Distribution<a class=headerlink href=#the-magic-of-cognitive-load-distribution title="Permanent link">&para;</a></h3><p>Think of your brain as a high-performance sports car. In traditional development, you're trying to: - Navigate the road (understand requirements) - Watch for obstacles (think about edge cases) - Monitor the engine (write implementation code) - Check the mirrors (consider architectural implications) - Adjust the radio (handle deployment concerns)</p><p>No wonder you're exhausted! With AI-assisted TDD:</p><ul><li><strong>You</strong> focus on the destination (requirements and business logic)</li><li><strong>QA Agent</strong> watches for obstacles (comprehensive test coverage)</li><li><strong>Code Agent</strong> monitors the engine (clean implementation)</li><li><strong>Design Agent</strong> checks the mirrors (architectural consistency)</li><li><strong>Data Agent</strong> tunes the radio (metrics and performance)</li></ul><h3 id=success-story-the-weekend-miracle>Success Story: The Weekend Miracle<a class=headerlink href=#success-story-the-weekend-miracle title="Permanent link">&para;</a></h3><blockquote><p><em>"I got the call on Friday at 5 PM. Our biggest client needed a complete reporting dashboard by Monday morning for their board meeting. In the old days, I would have called in sick on Monday. Instead, I set up the AI agents, wrote the initial story, and went home for dinner. By Sunday evening, I had a fully tested, production-ready dashboard with 94% test coverage. The client was so impressed they signed a 3-year extension."</em><br> — Sarah Chen, Full-Stack Developer at DataCorp</p></blockquote><h3 id=the-ai-tdd-advantage-matrix>The AI TDD Advantage Matrix<a class=headerlink href=#the-ai-tdd-advantage-matrix title="Permanent link">&para;</a></h3><table><thead><tr><th>Challenge</th><th>Traditional TDD</th><th>AI-Assisted TDD</th></tr></thead><tbody><tr><td><strong>Test Coverage</strong></td><td>60-80% (human fatigue)</td><td>90-98% (AI thoroughness)</td></tr><tr><td><strong>Edge Cases</strong></td><td>Often missed</td><td>Systematically identified</td></tr><tr><td><strong>Refactoring Confidence</strong></td><td>Medium (fear of breaking)</td><td>High (comprehensive test suite)</td></tr><tr><td><strong>Documentation</strong></td><td>Often outdated</td><td>Always current (living tests)</td></tr><tr><td><strong>Team Onboarding</strong></td><td>Weeks of learning</td><td>Hours of understanding</td></tr><tr><td><strong>Technical Debt</strong></td><td>Accumulates over time</td><td>Continuously reduced</td></tr></tbody></table><h2 id=chapter-3-your-first-tdd-adventure>Chapter 3: Your First TDD Adventure<a class=headerlink href=#chapter-3-your-first-tdd-adventure title="Permanent link">&para;</a></h2><h3 id=building-a-saas-feature-in-real-time>Building a SaaS Feature in Real-Time<a class=headerlink href=#building-a-saas-feature-in-real-time title="Permanent link">&para;</a></h3><p>Let's follow along as we build a real feature using AI-assisted TDD. You're going to watch the entire process unfold, from the initial user story to production deployment. This isn't theory—this is exactly what happens when you work with AI agents.</p><p><strong>The Challenge</strong>: Your startup's customers are asking for a way to invite team members to their workspace. It sounds simple, but we need email invitations, permission levels, expiration handling, and security measures.</p><p><strong>The Stakes</strong>: This feature could make or break your enterprise sales. Get it wrong, and you lose credibility. Get it right, and you unlock a new revenue stream.</p><p><strong>The Timeline</strong>: You have one day.</p><p>Ready? Let's dive in.</p><h3 id=scene-1-the-morning-kickoff-900-am>🎬 Scene 1: The Morning Kickoff (9:00 AM)<a class=headerlink href=#scene-1-the-morning-kickoff-900-am title="Permanent link">&para;</a></h3><p>You start your day with a cup of coffee and a user story:</p><div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1></a><a href=#__codelineno-1-1><span class=linenos data-linenos="1 "></span></a><span class=c1># Your fingers dance across the keyboard</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2></a><a href=#__codelineno-1-2><span class=linenos data-linenos="2 "></span></a>/backlog<span class=w> </span>add_story<span class=w> </span><span class=s2>&quot;As a workspace admin, I want to invite team members via email so they can collaborate on projects&quot;</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3></a><a href=#__codelineno-1-3><span class=linenos data-linenos="3 "></span></a>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4></a><a href=#__codelineno-1-4><span class=linenos data-linenos="4 "></span></a><span class=c1># The orchestrator springs into action</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5></a><a href=#__codelineno-1-5><span class=linenos data-linenos="5 "></span></a>/sprint<span class=w> </span>start
</span></code></pre></div><p><strong>⚡ What just happened?</strong> The orchestrator immediately dispatched your AI agents. Think of it like calling in the A-Team, but for software development.</p><h3 id=the-design-agent-takes-the-stage-905-am>🎨 The Design Agent Takes the Stage (9:05 AM)<a class=headerlink href=#the-design-agent-takes-the-stage-905-am title="Permanent link">&para;</a></h3><p>The Design Agent is like that friend who thinks through every detail before acting. Within minutes, it produces a comprehensive specification:</p><div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1></a><a href=#__codelineno-2-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1># Generated by Design Agent in 3 minutes</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2></a><a href=#__codelineno-2-2><span class=linenos data-linenos=" 2 "></span></a><span class=c1># specs/invitations/team_invite_spec.py</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3></a><a href=#__codelineno-2-3><span class=linenos data-linenos=" 3 "></span></a><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4></a><a href=#__codelineno-2-4><span class=linenos data-linenos=" 4 "></span></a><span class=sd>Team Invitation Feature Specification</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5></a><a href=#__codelineno-2-5><span class=linenos data-linenos=" 5 "></span></a>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6></a><a href=#__codelineno-2-6><span class=linenos data-linenos=" 6 "></span></a><span class=sd>🎯 CORE FUNCTIONALITY:</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7></a><a href=#__codelineno-2-7><span class=linenos data-linenos=" 7 "></span></a><span class=sd>Endpoints:</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8></a><a href=#__codelineno-2-8><span class=linenos data-linenos=" 8 "></span></a><span class=sd>- POST /api/invitations/send</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9></a><a href=#__codelineno-2-9><span class=linenos data-linenos=" 9 "></span></a><span class=sd>  - Input: { email: string, role: string, message?: string }</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10></a><a href=#__codelineno-2-10><span class=linenos data-linenos="10 "></span></a><span class=sd>  - Success: { invitation_id: string, expires_at: datetime }</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11></a><a href=#__codelineno-2-11><span class=linenos data-linenos="11 "></span></a><span class=sd>  - Failure: { error: string, code: number }</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12></a><a href=#__codelineno-2-12><span class=linenos data-linenos="12 "></span></a>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13></a><a href=#__codelineno-2-13><span class=linenos data-linenos="13 "></span></a><span class=sd>- GET /api/invitations/accept/{token}</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14></a><a href=#__codelineno-2-14><span class=linenos data-linenos="14 "></span></a><span class=sd>  - Success: Creates user account and workspace membership</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15></a><a href=#__codelineno-2-15><span class=linenos data-linenos="15 "></span></a><span class=sd>  - Failure: { error: string, code: number }</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16></a><a href=#__codelineno-2-16><span class=linenos data-linenos="16 "></span></a>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17></a><a href=#__codelineno-2-17><span class=linenos data-linenos="17 "></span></a><span class=sd>🔒 SECURITY REQUIREMENTS:</span>
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18></a><a href=#__codelineno-2-18><span class=linenos data-linenos="18 "></span></a><span class=sd>- Invitations expire after 7 days</span>
</span><span id=__span-2-19><a id=__codelineno-2-19 name=__codelineno-2-19></a><a href=#__codelineno-2-19><span class=linenos data-linenos="19 "></span></a><span class=sd>- Tokens are cryptographically secure (256-bit)</span>
</span><span id=__span-2-20><a id=__codelineno-2-20 name=__codelineno-2-20></a><a href=#__codelineno-2-20><span class=linenos data-linenos="20 "></span></a><span class=sd>- Rate limiting: 10 invitations per hour per admin</span>
</span><span id=__span-2-21><a id=__codelineno-2-21 name=__codelineno-2-21></a><a href=#__codelineno-2-21><span class=linenos data-linenos="21 "></span></a><span class=sd>- Email validation with domain checking</span>
</span><span id=__span-2-22><a id=__codelineno-2-22 name=__codelineno-2-22></a><a href=#__codelineno-2-22><span class=linenos data-linenos="22 "></span></a><span class=sd>- Role validation against workspace permissions</span>
</span><span id=__span-2-23><a id=__codelineno-2-23 name=__codelineno-2-23></a><a href=#__codelineno-2-23><span class=linenos data-linenos="23 "></span></a>
</span><span id=__span-2-24><a id=__codelineno-2-24 name=__codelineno-2-24></a><a href=#__codelineno-2-24><span class=linenos data-linenos="24 "></span></a><span class=sd>📧 EMAIL INTEGRATION:</span>
</span><span id=__span-2-25><a id=__codelineno-2-25 name=__codelineno-2-25></a><a href=#__codelineno-2-25><span class=linenos data-linenos="25 "></span></a><span class=sd>- Transactional email service</span>
</span><span id=__span-2-26><a id=__codelineno-2-26 name=__codelineno-2-26></a><a href=#__codelineno-2-26><span class=linenos data-linenos="26 "></span></a><span class=sd>- Branded invitation templates</span>
</span><span id=__span-2-27><a id=__codelineno-2-27 name=__codelineno-2-27></a><a href=#__codelineno-2-27><span class=linenos data-linenos="27 "></span></a><span class=sd>- Unsubscribe handling</span>
</span><span id=__span-2-28><a id=__codelineno-2-28 name=__codelineno-2-28></a><a href=#__codelineno-2-28><span class=linenos data-linenos="28 "></span></a><span class=sd>- Bounce tracking</span>
</span><span id=__span-2-29><a id=__codelineno-2-29 name=__codelineno-2-29></a><a href=#__codelineno-2-29><span class=linenos data-linenos="29 "></span></a>
</span><span id=__span-2-30><a id=__codelineno-2-30 name=__codelineno-2-30></a><a href=#__codelineno-2-30><span class=linenos data-linenos="30 "></span></a><span class=sd>🎭 USER ROLES:</span>
</span><span id=__span-2-31><a id=__codelineno-2-31 name=__codelineno-2-31></a><a href=#__codelineno-2-31><span class=linenos data-linenos="31 "></span></a><span class=sd>- Admin: Full workspace access</span>
</span><span id=__span-2-32><a id=__codelineno-2-32 name=__codelineno-2-32></a><a href=#__codelineno-2-32><span class=linenos data-linenos="32 "></span></a><span class=sd>- Editor: Can create/edit projects  </span>
</span><span id=__span-2-33><a id=__codelineno-2-33 name=__codelineno-2-33></a><a href=#__codelineno-2-33><span class=linenos data-linenos="33 "></span></a><span class=sd>- Viewer: Read-only access</span>
</span><span id=__span-2-34><a id=__codelineno-2-34 name=__codelineno-2-34></a><a href=#__codelineno-2-34><span class=linenos data-linenos="34 "></span></a><span class=sd>- Guest: Limited project access</span>
</span><span id=__span-2-35><a id=__codelineno-2-35 name=__codelineno-2-35></a><a href=#__codelineno-2-35><span class=linenos data-linenos="35 "></span></a>
</span><span id=__span-2-36><a id=__codelineno-2-36 name=__codelineno-2-36></a><a href=#__codelineno-2-36><span class=linenos data-linenos="36 "></span></a><span class=sd>💾 DATA PERSISTENCE:</span>
</span><span id=__span-2-37><a id=__codelineno-2-37 name=__codelineno-2-37></a><a href=#__codelineno-2-37><span class=linenos data-linenos="37 "></span></a><span class=sd>- Invitation records with audit trail</span>
</span><span id=__span-2-38><a id=__codelineno-2-38 name=__codelineno-2-38></a><a href=#__codelineno-2-38><span class=linenos data-linenos="38 "></span></a><span class=sd>- User onboarding workflow tracking</span>
</span><span id=__span-2-39><a id=__codelineno-2-39 name=__codelineno-2-39></a><a href=#__codelineno-2-39><span class=linenos data-linenos="39 "></span></a><span class=sd>- Analytics for invitation conversion rates</span>
</span><span id=__span-2-40><a id=__codelineno-2-40 name=__codelineno-2-40></a><a href=#__codelineno-2-40><span class=linenos data-linenos="40 "></span></a><span class=sd>&quot;&quot;&quot;</span>
</span></code></pre></div><p><strong>👀 Your reaction</strong>: "Wow, the Design Agent thought of things I hadn't even considered!" This is why you sleep well at night with AI agents on your team.</p><h3 id=the-qa-agent-enters-the-scene-920-am>🔴 The QA Agent Enters the Scene (9:20 AM)<a class=headerlink href=#the-qa-agent-enters-the-scene-920-am title="Permanent link">&para;</a></h3><p>While you're still processing the Design Agent's thorough specification, the QA Agent has already started crafting tests. This agent is obsessed with one thing: making sure your feature works perfectly in every possible scenario.</p><p><strong>The QA Agent's Internal Monologue</strong>: <em>"Okay, team invitations... what could go wrong? Invalid emails, expired tokens, duplicate invitations, malicious users trying to invite themselves to workspaces they don't own, rate limiting bypasses, SQL injection attempts... I'll test ALL of it."</em></p><div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1></a><a href=#__codelineno-3-1><span class=linenos data-linenos="  1 "></span></a><span class=c1># Generated by QA Agent - 47 comprehensive tests in 15 minutes</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2></a><a href=#__codelineno-3-2><span class=linenos data-linenos="  2 "></span></a><span class=c1># tests/test_team_invitations.py</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3></a><a href=#__codelineno-3-3><span class=linenos data-linenos="  3 "></span></a><span class=kn>import</span> <span class=nn>pytest</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4></a><a href=#__codelineno-3-4><span class=linenos data-linenos="  4 "></span></a><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5></a><a href=#__codelineno-3-5><span class=linenos data-linenos="  5 "></span></a><span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>patch</span><span class=p>,</span> <span class=n>MagicMock</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6></a><a href=#__codelineno-3-6><span class=linenos data-linenos="  6 "></span></a><span class=kn>from</span> <span class=nn>app.invitations</span> <span class=kn>import</span> <span class=n>InvitationService</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7></a><a href=#__codelineno-3-7><span class=linenos data-linenos="  7 "></span></a><span class=kn>from</span> <span class=nn>app.models</span> <span class=kn>import</span> <span class=n>User</span><span class=p>,</span> <span class=n>Workspace</span><span class=p>,</span> <span class=n>Invitation</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8></a><a href=#__codelineno-3-8><span class=linenos data-linenos="  8 "></span></a>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9></a><a href=#__codelineno-3-9><span class=linenos data-linenos="  9 "></span></a><span class=k>class</span> <span class=nc>TestTeamInvitationFeature</span><span class=p>:</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10></a><a href=#__codelineno-3-10><span class=linenos data-linenos=" 10 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Comprehensive test suite for team invitation functionality&quot;&quot;&quot;</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11></a><a href=#__codelineno-3-11><span class=linenos data-linenos=" 11 "></span></a>    
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12></a><a href=#__codelineno-3-12><span class=linenos data-linenos=" 12 "></span></a>    <span class=c1># 🎯 HAPPY PATH TESTS</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13></a><a href=#__codelineno-3-13><span class=linenos data-linenos=" 13 "></span></a>    <span class=k>def</span> <span class=nf>test_admin_can_invite_new_team_member</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>db</span><span class=p>,</span> <span class=n>workspace_admin</span><span class=p>):</span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14></a><a href=#__codelineno-3-14><span class=linenos data-linenos=" 14 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Admin successfully invites a new team member&quot;&quot;&quot;</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15></a><a href=#__codelineno-3-15><span class=linenos data-linenos=" 15 "></span></a>        <span class=c1># Arrange</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16></a><a href=#__codelineno-3-16><span class=linenos data-linenos=" 16 "></span></a>        <span class=n>invite_data</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17></a><a href=#__codelineno-3-17><span class=linenos data-linenos=" 17 "></span></a>            <span class=s2>&quot;email&quot;</span><span class=p>:</span> <span class=s2>&quot;newbie@example.com&quot;</span><span class=p>,</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18></a><a href=#__codelineno-3-18><span class=linenos data-linenos=" 18 "></span></a>            <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;editor&quot;</span><span class=p>,</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19></a><a href=#__codelineno-3-19><span class=linenos data-linenos=" 19 "></span></a>            <span class=s2>&quot;message&quot;</span><span class=p>:</span> <span class=s2>&quot;Welcome to our team!&quot;</span>
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20></a><a href=#__codelineno-3-20><span class=linenos data-linenos=" 20 "></span></a>        <span class=p>}</span>
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21></a><a href=#__codelineno-3-21><span class=linenos data-linenos=" 21 "></span></a>        
</span><span id=__span-3-22><a id=__codelineno-3-22 name=__codelineno-3-22></a><a href=#__codelineno-3-22><span class=linenos data-linenos=" 22 "></span></a>        <span class=c1># Act</span>
</span><span id=__span-3-23><a id=__codelineno-3-23 name=__codelineno-3-23></a><a href=#__codelineno-3-23><span class=linenos data-linenos=" 23 "></span></a>        <span class=n>result</span> <span class=o>=</span> <span class=n>InvitationService</span><span class=o>.</span><span class=n>send_invitation</span><span class=p>(</span>
</span><span id=__span-3-24><a id=__codelineno-3-24 name=__codelineno-3-24></a><a href=#__codelineno-3-24><span class=linenos data-linenos=" 24 "></span></a>            <span class=n>admin_user</span><span class=o>=</span><span class=n>workspace_admin</span><span class=p>,</span>
</span><span id=__span-3-25><a id=__codelineno-3-25 name=__codelineno-3-25></a><a href=#__codelineno-3-25><span class=linenos data-linenos=" 25 "></span></a>            <span class=n>workspace_id</span><span class=o>=</span><span class=n>workspace_admin</span><span class=o>.</span><span class=n>workspace</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-3-26><a id=__codelineno-3-26 name=__codelineno-3-26></a><a href=#__codelineno-3-26><span class=linenos data-linenos=" 26 "></span></a>            <span class=o>**</span><span class=n>invite_data</span>
</span><span id=__span-3-27><a id=__codelineno-3-27 name=__codelineno-3-27></a><a href=#__codelineno-3-27><span class=linenos data-linenos=" 27 "></span></a>        <span class=p>)</span>
</span><span id=__span-3-28><a id=__codelineno-3-28 name=__codelineno-3-28></a><a href=#__codelineno-3-28><span class=linenos data-linenos=" 28 "></span></a>        
</span><span id=__span-3-29><a id=__codelineno-3-29 name=__codelineno-3-29></a><a href=#__codelineno-3-29><span class=linenos data-linenos=" 29 "></span></a>        <span class=c1># Assert</span>
</span><span id=__span-3-30><a id=__codelineno-3-30 name=__codelineno-3-30></a><a href=#__codelineno-3-30><span class=linenos data-linenos=" 30 "></span></a>        <span class=k>assert</span> <span class=n>result</span><span class=o>.</span><span class=n>success</span> <span class=ow>is</span> <span class=kc>True</span>
</span><span id=__span-3-31><a id=__codelineno-3-31 name=__codelineno-3-31></a><a href=#__codelineno-3-31><span class=linenos data-linenos=" 31 "></span></a>        <span class=k>assert</span> <span class=n>result</span><span class=o>.</span><span class=n>invitation_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
</span><span id=__span-3-32><a id=__codelineno-3-32 name=__codelineno-3-32></a><a href=#__codelineno-3-32><span class=linenos data-linenos=" 32 "></span></a>        <span class=k>assert</span> <span class=n>result</span><span class=o>.</span><span class=n>expires_at</span> <span class=o>&gt;</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span>
</span><span id=__span-3-33><a id=__codelineno-3-33 name=__codelineno-3-33></a><a href=#__codelineno-3-33><span class=linenos data-linenos=" 33 "></span></a>        <span class=k>assert</span> <span class=n>Invitation</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>count</span><span class=p>()</span> <span class=o>==</span> <span class=mi>1</span>
</span><span id=__span-3-34><a id=__codelineno-3-34 name=__codelineno-3-34></a><a href=#__codelineno-3-34><span class=linenos data-linenos=" 34 "></span></a>        
</span><span id=__span-3-35><a id=__codelineno-3-35 name=__codelineno-3-35></a><a href=#__codelineno-3-35><span class=linenos data-linenos=" 35 "></span></a>        <span class=n>invitation</span> <span class=o>=</span> <span class=n>Invitation</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</span><span id=__span-3-36><a id=__codelineno-3-36 name=__codelineno-3-36></a><a href=#__codelineno-3-36><span class=linenos data-linenos=" 36 "></span></a>        <span class=k>assert</span> <span class=n>invitation</span><span class=o>.</span><span class=n>status</span> <span class=o>==</span> <span class=s2>&quot;pending&quot;</span>
</span><span id=__span-3-37><a id=__codelineno-3-37 name=__codelineno-3-37></a><a href=#__codelineno-3-37><span class=linenos data-linenos=" 37 "></span></a>        <span class=k>assert</span> <span class=n>invitation</span><span class=o>.</span><span class=n>email</span> <span class=o>==</span> <span class=s2>&quot;newbie@example.com&quot;</span>
</span><span id=__span-3-38><a id=__codelineno-3-38 name=__codelineno-3-38></a><a href=#__codelineno-3-38><span class=linenos data-linenos=" 38 "></span></a>        <span class=k>assert</span> <span class=n>invitation</span><span class=o>.</span><span class=n>role</span> <span class=o>==</span> <span class=s2>&quot;editor&quot;</span>
</span><span id=__span-3-39><a id=__codelineno-3-39 name=__codelineno-3-39></a><a href=#__codelineno-3-39><span class=linenos data-linenos=" 39 "></span></a>    
</span><span id=__span-3-40><a id=__codelineno-3-40 name=__codelineno-3-40></a><a href=#__codelineno-3-40><span class=linenos data-linenos=" 40 "></span></a>    <span class=k>def</span> <span class=nf>test_invited_user_can_accept_valid_invitation</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>db</span><span class=p>,</span> <span class=n>pending_invitation</span><span class=p>):</span>
</span><span id=__span-3-41><a id=__codelineno-3-41 name=__codelineno-3-41></a><a href=#__codelineno-3-41><span class=linenos data-linenos=" 41 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;User can accept a valid invitation and join workspace&quot;&quot;&quot;</span>
</span><span id=__span-3-42><a id=__codelineno-3-42 name=__codelineno-3-42></a><a href=#__codelineno-3-42><span class=linenos data-linenos=" 42 "></span></a>        <span class=c1># Act</span>
</span><span id=__span-3-43><a id=__codelineno-3-43 name=__codelineno-3-43></a><a href=#__codelineno-3-43><span class=linenos data-linenos=" 43 "></span></a>        <span class=n>result</span> <span class=o>=</span> <span class=n>InvitationService</span><span class=o>.</span><span class=n>accept_invitation</span><span class=p>(</span>
</span><span id=__span-3-44><a id=__codelineno-3-44 name=__codelineno-3-44></a><a href=#__codelineno-3-44><span class=linenos data-linenos=" 44 "></span></a>            <span class=n>token</span><span class=o>=</span><span class=n>pending_invitation</span><span class=o>.</span><span class=n>token</span><span class=p>,</span>
</span><span id=__span-3-45><a id=__codelineno-3-45 name=__codelineno-3-45></a><a href=#__codelineno-3-45><span class=linenos data-linenos=" 45 "></span></a>            <span class=n>user_data</span><span class=o>=</span><span class=p>{</span>
</span><span id=__span-3-46><a id=__codelineno-3-46 name=__codelineno-3-46></a><a href=#__codelineno-3-46><span class=linenos data-linenos=" 46 "></span></a>                <span class=s2>&quot;name&quot;</span><span class=p>:</span> <span class=s2>&quot;New Team Member&quot;</span><span class=p>,</span>
</span><span id=__span-3-47><a id=__codelineno-3-47 name=__codelineno-3-47></a><a href=#__codelineno-3-47><span class=linenos data-linenos=" 47 "></span></a>                <span class=s2>&quot;password&quot;</span><span class=p>:</span> <span class=s2>&quot;SecurePass123!&quot;</span>
</span><span id=__span-3-48><a id=__codelineno-3-48 name=__codelineno-3-48></a><a href=#__codelineno-3-48><span class=linenos data-linenos=" 48 "></span></a>            <span class=p>}</span>
</span><span id=__span-3-49><a id=__codelineno-3-49 name=__codelineno-3-49></a><a href=#__codelineno-3-49><span class=linenos data-linenos=" 49 "></span></a>        <span class=p>)</span>
</span><span id=__span-3-50><a id=__codelineno-3-50 name=__codelineno-3-50></a><a href=#__codelineno-3-50><span class=linenos data-linenos=" 50 "></span></a>        
</span><span id=__span-3-51><a id=__codelineno-3-51 name=__codelineno-3-51></a><a href=#__codelineno-3-51><span class=linenos data-linenos=" 51 "></span></a>        <span class=c1># Assert  </span>
</span><span id=__span-3-52><a id=__codelineno-3-52 name=__codelineno-3-52></a><a href=#__codelineno-3-52><span class=linenos data-linenos=" 52 "></span></a>        <span class=k>assert</span> <span class=n>result</span><span class=o>.</span><span class=n>success</span> <span class=ow>is</span> <span class=kc>True</span>
</span><span id=__span-3-53><a id=__codelineno-3-53 name=__codelineno-3-53></a><a href=#__codelineno-3-53><span class=linenos data-linenos=" 53 "></span></a>        <span class=k>assert</span> <span class=n>User</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>count</span><span class=p>()</span> <span class=o>==</span> <span class=mi>2</span>  <span class=c1># Admin + new user</span>
</span><span id=__span-3-54><a id=__codelineno-3-54 name=__codelineno-3-54></a><a href=#__codelineno-3-54><span class=linenos data-linenos=" 54 "></span></a>        
</span><span id=__span-3-55><a id=__codelineno-3-55 name=__codelineno-3-55></a><a href=#__codelineno-3-55><span class=linenos data-linenos=" 55 "></span></a>        <span class=n>new_user</span> <span class=o>=</span> <span class=n>User</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>filter_by</span><span class=p>(</span><span class=n>email</span><span class=o>=</span><span class=n>pending_invitation</span><span class=o>.</span><span class=n>email</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</span><span id=__span-3-56><a id=__codelineno-3-56 name=__codelineno-3-56></a><a href=#__codelineno-3-56><span class=linenos data-linenos=" 56 "></span></a>        <span class=k>assert</span> <span class=n>new_user</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
</span><span id=__span-3-57><a id=__codelineno-3-57 name=__codelineno-3-57></a><a href=#__codelineno-3-57><span class=linenos data-linenos=" 57 "></span></a>        <span class=k>assert</span> <span class=n>new_user</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&quot;New Team Member&quot;</span>
</span><span id=__span-3-58><a id=__codelineno-3-58 name=__codelineno-3-58></a><a href=#__codelineno-3-58><span class=linenos data-linenos=" 58 "></span></a>        <span class=k>assert</span> <span class=n>new_user</span><span class=o>.</span><span class=n>workspaces</span><span class=o>.</span><span class=n>count</span><span class=p>()</span> <span class=o>==</span> <span class=mi>1</span>
</span><span id=__span-3-59><a id=__codelineno-3-59 name=__codelineno-3-59></a><a href=#__codelineno-3-59><span class=linenos data-linenos=" 59 "></span></a>        
</span><span id=__span-3-60><a id=__codelineno-3-60 name=__codelineno-3-60></a><a href=#__codelineno-3-60><span class=linenos data-linenos=" 60 "></span></a>        <span class=c1># Invitation should be marked as accepted</span>
</span><span id=__span-3-61><a id=__codelineno-3-61 name=__codelineno-3-61></a><a href=#__codelineno-3-61><span class=linenos data-linenos=" 61 "></span></a>        <span class=k>assert</span> <span class=n>pending_invitation</span><span class=o>.</span><span class=n>status</span> <span class=o>==</span> <span class=s2>&quot;accepted&quot;</span>
</span><span id=__span-3-62><a id=__codelineno-3-62 name=__codelineno-3-62></a><a href=#__codelineno-3-62><span class=linenos data-linenos=" 62 "></span></a>        <span class=k>assert</span> <span class=n>pending_invitation</span><span class=o>.</span><span class=n>accepted_at</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
</span><span id=__span-3-63><a id=__codelineno-3-63 name=__codelineno-3-63></a><a href=#__codelineno-3-63><span class=linenos data-linenos=" 63 "></span></a>    
</span><span id=__span-3-64><a id=__codelineno-3-64 name=__codelineno-3-64></a><a href=#__codelineno-3-64><span class=linenos data-linenos=" 64 "></span></a>    <span class=c1># 🚨 SECURITY TESTS</span>
</span><span id=__span-3-65><a id=__codelineno-3-65 name=__codelineno-3-65></a><a href=#__codelineno-3-65><span class=linenos data-linenos=" 65 "></span></a>    <span class=k>def</span> <span class=nf>test_cannot_invite_to_workspace_without_admin_role</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>db</span><span class=p>,</span> <span class=n>workspace_editor</span><span class=p>):</span>
</span><span id=__span-3-66><a id=__codelineno-3-66 name=__codelineno-3-66></a><a href=#__codelineno-3-66><span class=linenos data-linenos=" 66 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Non-admin users cannot send invitations&quot;&quot;&quot;</span>
</span><span id=__span-3-67><a id=__codelineno-3-67 name=__codelineno-3-67></a><a href=#__codelineno-3-67><span class=linenos data-linenos=" 67 "></span></a>        <span class=c1># Act</span>
</span><span id=__span-3-68><a id=__codelineno-3-68 name=__codelineno-3-68></a><a href=#__codelineno-3-68><span class=linenos data-linenos=" 68 "></span></a>        <span class=n>result</span> <span class=o>=</span> <span class=n>InvitationService</span><span class=o>.</span><span class=n>send_invitation</span><span class=p>(</span>
</span><span id=__span-3-69><a id=__codelineno-3-69 name=__codelineno-3-69></a><a href=#__codelineno-3-69><span class=linenos data-linenos=" 69 "></span></a>            <span class=n>admin_user</span><span class=o>=</span><span class=n>workspace_editor</span><span class=p>,</span>  <span class=c1># Editor, not admin</span>
</span><span id=__span-3-70><a id=__codelineno-3-70 name=__codelineno-3-70></a><a href=#__codelineno-3-70><span class=linenos data-linenos=" 70 "></span></a>            <span class=n>workspace_id</span><span class=o>=</span><span class=n>workspace_editor</span><span class=o>.</span><span class=n>workspace</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-3-71><a id=__codelineno-3-71 name=__codelineno-3-71></a><a href=#__codelineno-3-71><span class=linenos data-linenos=" 71 "></span></a>            <span class=n>email</span><span class=o>=</span><span class=s2>&quot;hacker@example.com&quot;</span><span class=p>,</span>
</span><span id=__span-3-72><a id=__codelineno-3-72 name=__codelineno-3-72></a><a href=#__codelineno-3-72><span class=linenos data-linenos=" 72 "></span></a>            <span class=n>role</span><span class=o>=</span><span class=s2>&quot;admin&quot;</span>
</span><span id=__span-3-73><a id=__codelineno-3-73 name=__codelineno-3-73></a><a href=#__codelineno-3-73><span class=linenos data-linenos=" 73 "></span></a>        <span class=p>)</span>
</span><span id=__span-3-74><a id=__codelineno-3-74 name=__codelineno-3-74></a><a href=#__codelineno-3-74><span class=linenos data-linenos=" 74 "></span></a>        
</span><span id=__span-3-75><a id=__codelineno-3-75 name=__codelineno-3-75></a><a href=#__codelineno-3-75><span class=linenos data-linenos=" 75 "></span></a>        <span class=c1># Assert</span>
</span><span id=__span-3-76><a id=__codelineno-3-76 name=__codelineno-3-76></a><a href=#__codelineno-3-76><span class=linenos data-linenos=" 76 "></span></a>        <span class=k>assert</span> <span class=n>result</span><span class=o>.</span><span class=n>success</span> <span class=ow>is</span> <span class=kc>False</span>
</span><span id=__span-3-77><a id=__codelineno-3-77 name=__codelineno-3-77></a><a href=#__codelineno-3-77><span class=linenos data-linenos=" 77 "></span></a>        <span class=k>assert</span> <span class=n>result</span><span class=o>.</span><span class=n>error</span> <span class=o>==</span> <span class=s2>&quot;Insufficient permissions&quot;</span>
</span><span id=__span-3-78><a id=__codelineno-3-78 name=__codelineno-3-78></a><a href=#__codelineno-3-78><span class=linenos data-linenos=" 78 "></span></a>        <span class=k>assert</span> <span class=n>result</span><span class=o>.</span><span class=n>code</span> <span class=o>==</span> <span class=mi>403</span>
</span><span id=__span-3-79><a id=__codelineno-3-79 name=__codelineno-3-79></a><a href=#__codelineno-3-79><span class=linenos data-linenos=" 79 "></span></a>        <span class=k>assert</span> <span class=n>Invitation</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>count</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span>
</span><span id=__span-3-80><a id=__codelineno-3-80 name=__codelineno-3-80></a><a href=#__codelineno-3-80><span class=linenos data-linenos=" 80 "></span></a>    
</span><span id=__span-3-81><a id=__codelineno-3-81 name=__codelineno-3-81></a><a href=#__codelineno-3-81><span class=linenos data-linenos=" 81 "></span></a>    <span class=k>def</span> <span class=nf>test_cannot_accept_expired_invitation</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>db</span><span class=p>,</span> <span class=n>expired_invitation</span><span class=p>):</span>
</span><span id=__span-3-82><a id=__codelineno-3-82 name=__codelineno-3-82></a><a href=#__codelineno-3-82><span class=linenos data-linenos=" 82 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Expired invitations cannot be accepted&quot;&quot;&quot;</span>
</span><span id=__span-3-83><a id=__codelineno-3-83 name=__codelineno-3-83></a><a href=#__codelineno-3-83><span class=linenos data-linenos=" 83 "></span></a>        <span class=c1># Act</span>
</span><span id=__span-3-84><a id=__codelineno-3-84 name=__codelineno-3-84></a><a href=#__codelineno-3-84><span class=linenos data-linenos=" 84 "></span></a>        <span class=n>result</span> <span class=o>=</span> <span class=n>InvitationService</span><span class=o>.</span><span class=n>accept_invitation</span><span class=p>(</span>
</span><span id=__span-3-85><a id=__codelineno-3-85 name=__codelineno-3-85></a><a href=#__codelineno-3-85><span class=linenos data-linenos=" 85 "></span></a>            <span class=n>token</span><span class=o>=</span><span class=n>expired_invitation</span><span class=o>.</span><span class=n>token</span><span class=p>,</span>
</span><span id=__span-3-86><a id=__codelineno-3-86 name=__codelineno-3-86></a><a href=#__codelineno-3-86><span class=linenos data-linenos=" 86 "></span></a>            <span class=n>user_data</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;name&quot;</span><span class=p>:</span> <span class=s2>&quot;Late User&quot;</span><span class=p>,</span> <span class=s2>&quot;password&quot;</span><span class=p>:</span> <span class=s2>&quot;SecurePass123!&quot;</span><span class=p>}</span>
</span><span id=__span-3-87><a id=__codelineno-3-87 name=__codelineno-3-87></a><a href=#__codelineno-3-87><span class=linenos data-linenos=" 87 "></span></a>        <span class=p>)</span>
</span><span id=__span-3-88><a id=__codelineno-3-88 name=__codelineno-3-88></a><a href=#__codelineno-3-88><span class=linenos data-linenos=" 88 "></span></a>        
</span><span id=__span-3-89><a id=__codelineno-3-89 name=__codelineno-3-89></a><a href=#__codelineno-3-89><span class=linenos data-linenos=" 89 "></span></a>        <span class=c1># Assert</span>
</span><span id=__span-3-90><a id=__codelineno-3-90 name=__codelineno-3-90></a><a href=#__codelineno-3-90><span class=linenos data-linenos=" 90 "></span></a>        <span class=k>assert</span> <span class=n>result</span><span class=o>.</span><span class=n>success</span> <span class=ow>is</span> <span class=kc>False</span>
</span><span id=__span-3-91><a id=__codelineno-3-91 name=__codelineno-3-91></a><a href=#__codelineno-3-91><span class=linenos data-linenos=" 91 "></span></a>        <span class=k>assert</span> <span class=n>result</span><span class=o>.</span><span class=n>error</span> <span class=o>==</span> <span class=s2>&quot;Invitation has expired&quot;</span>
</span><span id=__span-3-92><a id=__codelineno-3-92 name=__codelineno-3-92></a><a href=#__codelineno-3-92><span class=linenos data-linenos=" 92 "></span></a>        <span class=k>assert</span> <span class=n>result</span><span class=o>.</span><span class=n>code</span> <span class=o>==</span> <span class=mi>410</span>
</span><span id=__span-3-93><a id=__codelineno-3-93 name=__codelineno-3-93></a><a href=#__codelineno-3-93><span class=linenos data-linenos=" 93 "></span></a>        <span class=k>assert</span> <span class=n>User</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>count</span><span class=p>()</span> <span class=o>==</span> <span class=mi>1</span>  <span class=c1># Only admin exists</span>
</span><span id=__span-3-94><a id=__codelineno-3-94 name=__codelineno-3-94></a><a href=#__codelineno-3-94><span class=linenos data-linenos=" 94 "></span></a>    
</span><span id=__span-3-95><a id=__codelineno-3-95 name=__codelineno-3-95></a><a href=#__codelineno-3-95><span class=linenos data-linenos=" 95 "></span></a>    <span class=k>def</span> <span class=nf>test_rate_limiting_prevents_spam_invitations</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>db</span><span class=p>,</span> <span class=n>workspace_admin</span><span class=p>):</span>
</span><span id=__span-3-96><a id=__codelineno-3-96 name=__codelineno-3-96></a><a href=#__codelineno-3-96><span class=linenos data-linenos=" 96 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Admins cannot send more than 10 invitations per hour&quot;&quot;&quot;</span>
</span><span id=__span-3-97><a id=__codelineno-3-97 name=__codelineno-3-97></a><a href=#__codelineno-3-97><span class=linenos data-linenos=" 97 "></span></a>        <span class=c1># Arrange - Send 10 invitations (at the limit)</span>
</span><span id=__span-3-98><a id=__codelineno-3-98 name=__codelineno-3-98></a><a href=#__codelineno-3-98><span class=linenos data-linenos=" 98 "></span></a>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span>
</span><span id=__span-3-99><a id=__codelineno-3-99 name=__codelineno-3-99></a><a href=#__codelineno-3-99><span class=linenos data-linenos=" 99 "></span></a>            <span class=n>InvitationService</span><span class=o>.</span><span class=n>send_invitation</span><span class=p>(</span>
</span><span id=__span-3-100><a id=__codelineno-3-100 name=__codelineno-3-100></a><a href=#__codelineno-3-100><span class=linenos data-linenos="100 "></span></a>                <span class=n>admin_user</span><span class=o>=</span><span class=n>workspace_admin</span><span class=p>,</span>
</span><span id=__span-3-101><a id=__codelineno-3-101 name=__codelineno-3-101></a><a href=#__codelineno-3-101><span class=linenos data-linenos="101 "></span></a>                <span class=n>workspace_id</span><span class=o>=</span><span class=n>workspace_admin</span><span class=o>.</span><span class=n>workspace</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-3-102><a id=__codelineno-3-102 name=__codelineno-3-102></a><a href=#__codelineno-3-102><span class=linenos data-linenos="102 "></span></a>                <span class=n>email</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;user</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>@example.com&quot;</span><span class=p>,</span> 
</span><span id=__span-3-103><a id=__codelineno-3-103 name=__codelineno-3-103></a><a href=#__codelineno-3-103><span class=linenos data-linenos="103 "></span></a>                <span class=n>role</span><span class=o>=</span><span class=s2>&quot;viewer&quot;</span>
</span><span id=__span-3-104><a id=__codelineno-3-104 name=__codelineno-3-104></a><a href=#__codelineno-3-104><span class=linenos data-linenos="104 "></span></a>            <span class=p>)</span>
</span><span id=__span-3-105><a id=__codelineno-3-105 name=__codelineno-3-105></a><a href=#__codelineno-3-105><span class=linenos data-linenos="105 "></span></a>        
</span><span id=__span-3-106><a id=__codelineno-3-106 name=__codelineno-3-106></a><a href=#__codelineno-3-106><span class=linenos data-linenos="106 "></span></a>        <span class=c1># Act - Try to send 11th invitation</span>
</span><span id=__span-3-107><a id=__codelineno-3-107 name=__codelineno-3-107></a><a href=#__codelineno-3-107><span class=linenos data-linenos="107 "></span></a>        <span class=n>result</span> <span class=o>=</span> <span class=n>InvitationService</span><span class=o>.</span><span class=n>send_invitation</span><span class=p>(</span>
</span><span id=__span-3-108><a id=__codelineno-3-108 name=__codelineno-3-108></a><a href=#__codelineno-3-108><span class=linenos data-linenos="108 "></span></a>            <span class=n>admin_user</span><span class=o>=</span><span class=n>workspace_admin</span><span class=p>,</span>
</span><span id=__span-3-109><a id=__codelineno-3-109 name=__codelineno-3-109></a><a href=#__codelineno-3-109><span class=linenos data-linenos="109 "></span></a>            <span class=n>workspace_id</span><span class=o>=</span><span class=n>workspace_admin</span><span class=o>.</span><span class=n>workspace</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-3-110><a id=__codelineno-3-110 name=__codelineno-3-110></a><a href=#__codelineno-3-110><span class=linenos data-linenos="110 "></span></a>            <span class=n>email</span><span class=o>=</span><span class=s2>&quot;spam@example.com&quot;</span><span class=p>,</span>
</span><span id=__span-3-111><a id=__codelineno-3-111 name=__codelineno-3-111></a><a href=#__codelineno-3-111><span class=linenos data-linenos="111 "></span></a>            <span class=n>role</span><span class=o>=</span><span class=s2>&quot;viewer&quot;</span>
</span><span id=__span-3-112><a id=__codelineno-3-112 name=__codelineno-3-112></a><a href=#__codelineno-3-112><span class=linenos data-linenos="112 "></span></a>        <span class=p>)</span>
</span><span id=__span-3-113><a id=__codelineno-3-113 name=__codelineno-3-113></a><a href=#__codelineno-3-113><span class=linenos data-linenos="113 "></span></a>        
</span><span id=__span-3-114><a id=__codelineno-3-114 name=__codelineno-3-114></a><a href=#__codelineno-3-114><span class=linenos data-linenos="114 "></span></a>        <span class=c1># Assert</span>
</span><span id=__span-3-115><a id=__codelineno-3-115 name=__codelineno-3-115></a><a href=#__codelineno-3-115><span class=linenos data-linenos="115 "></span></a>        <span class=k>assert</span> <span class=n>result</span><span class=o>.</span><span class=n>success</span> <span class=ow>is</span> <span class=kc>False</span>
</span><span id=__span-3-116><a id=__codelineno-3-116 name=__codelineno-3-116></a><a href=#__codelineno-3-116><span class=linenos data-linenos="116 "></span></a>        <span class=k>assert</span> <span class=n>result</span><span class=o>.</span><span class=n>error</span> <span class=o>==</span> <span class=s2>&quot;Rate limit exceeded&quot;</span>
</span><span id=__span-3-117><a id=__codelineno-3-117 name=__codelineno-3-117></a><a href=#__codelineno-3-117><span class=linenos data-linenos="117 "></span></a>        <span class=k>assert</span> <span class=n>result</span><span class=o>.</span><span class=n>code</span> <span class=o>==</span> <span class=mi>429</span>
</span><span id=__span-3-118><a id=__codelineno-3-118 name=__codelineno-3-118></a><a href=#__codelineno-3-118><span class=linenos data-linenos="118 "></span></a>        <span class=k>assert</span> <span class=n>Invitation</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>count</span><span class=p>()</span> <span class=o>==</span> <span class=mi>10</span>  <span class=c1># Only 10 invitations exist</span>
</span><span id=__span-3-119><a id=__codelineno-3-119 name=__codelineno-3-119></a><a href=#__codelineno-3-119><span class=linenos data-linenos="119 "></span></a>    
</span><span id=__span-3-120><a id=__codelineno-3-120 name=__codelineno-3-120></a><a href=#__codelineno-3-120><span class=linenos data-linenos="120 "></span></a>    <span class=c1># 🔍 EDGE CASES</span>
</span><span id=__span-3-121><a id=__codelineno-3-121 name=__codelineno-3-121></a><a href=#__codelineno-3-121><span class=linenos data-linenos="121 "></span></a>    <span class=k>def</span> <span class=nf>test_duplicate_invitation_updates_existing</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>db</span><span class=p>,</span> <span class=n>workspace_admin</span><span class=p>):</span>
</span><span id=__span-3-122><a id=__codelineno-3-122 name=__codelineno-3-122></a><a href=#__codelineno-3-122><span class=linenos data-linenos="122 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Sending invitation to same email updates existing invitation&quot;&quot;&quot;</span>
</span><span id=__span-3-123><a id=__codelineno-3-123 name=__codelineno-3-123></a><a href=#__codelineno-3-123><span class=linenos data-linenos="123 "></span></a>        <span class=c1># Arrange - Send first invitation</span>
</span><span id=__span-3-124><a id=__codelineno-3-124 name=__codelineno-3-124></a><a href=#__codelineno-3-124><span class=linenos data-linenos="124 "></span></a>        <span class=n>email</span> <span class=o>=</span> <span class=s2>&quot;duplicate@example.com&quot;</span>
</span><span id=__span-3-125><a id=__codelineno-3-125 name=__codelineno-3-125></a><a href=#__codelineno-3-125><span class=linenos data-linenos="125 "></span></a>        <span class=n>first_invite</span> <span class=o>=</span> <span class=n>InvitationService</span><span class=o>.</span><span class=n>send_invitation</span><span class=p>(</span>
</span><span id=__span-3-126><a id=__codelineno-3-126 name=__codelineno-3-126></a><a href=#__codelineno-3-126><span class=linenos data-linenos="126 "></span></a>            <span class=n>admin_user</span><span class=o>=</span><span class=n>workspace_admin</span><span class=p>,</span>
</span><span id=__span-3-127><a id=__codelineno-3-127 name=__codelineno-3-127></a><a href=#__codelineno-3-127><span class=linenos data-linenos="127 "></span></a>            <span class=n>workspace_id</span><span class=o>=</span><span class=n>workspace_admin</span><span class=o>.</span><span class=n>workspace</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-3-128><a id=__codelineno-3-128 name=__codelineno-3-128></a><a href=#__codelineno-3-128><span class=linenos data-linenos="128 "></span></a>            <span class=n>email</span><span class=o>=</span><span class=n>email</span><span class=p>,</span>
</span><span id=__span-3-129><a id=__codelineno-3-129 name=__codelineno-3-129></a><a href=#__codelineno-3-129><span class=linenos data-linenos="129 "></span></a>            <span class=n>role</span><span class=o>=</span><span class=s2>&quot;viewer&quot;</span>
</span><span id=__span-3-130><a id=__codelineno-3-130 name=__codelineno-3-130></a><a href=#__codelineno-3-130><span class=linenos data-linenos="130 "></span></a>        <span class=p>)</span>
</span><span id=__span-3-131><a id=__codelineno-3-131 name=__codelineno-3-131></a><a href=#__codelineno-3-131><span class=linenos data-linenos="131 "></span></a>        
</span><span id=__span-3-132><a id=__codelineno-3-132 name=__codelineno-3-132></a><a href=#__codelineno-3-132><span class=linenos data-linenos="132 "></span></a>        <span class=c1># Act - Send second invitation to same email</span>
</span><span id=__span-3-133><a id=__codelineno-3-133 name=__codelineno-3-133></a><a href=#__codelineno-3-133><span class=linenos data-linenos="133 "></span></a>        <span class=n>second_invite</span> <span class=o>=</span> <span class=n>InvitationService</span><span class=o>.</span><span class=n>send_invitation</span><span class=p>(</span>
</span><span id=__span-3-134><a id=__codelineno-3-134 name=__codelineno-3-134></a><a href=#__codelineno-3-134><span class=linenos data-linenos="134 "></span></a>            <span class=n>admin_user</span><span class=o>=</span><span class=n>workspace_admin</span><span class=p>,</span>
</span><span id=__span-3-135><a id=__codelineno-3-135 name=__codelineno-3-135></a><a href=#__codelineno-3-135><span class=linenos data-linenos="135 "></span></a>            <span class=n>workspace_id</span><span class=o>=</span><span class=n>workspace_admin</span><span class=o>.</span><span class=n>workspace</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-3-136><a id=__codelineno-3-136 name=__codelineno-3-136></a><a href=#__codelineno-3-136><span class=linenos data-linenos="136 "></span></a>            <span class=n>email</span><span class=o>=</span><span class=n>email</span><span class=p>,</span>
</span><span id=__span-3-137><a id=__codelineno-3-137 name=__codelineno-3-137></a><a href=#__codelineno-3-137><span class=linenos data-linenos="137 "></span></a>            <span class=n>role</span><span class=o>=</span><span class=s2>&quot;editor&quot;</span>  <span class=c1># Different role</span>
</span><span id=__span-3-138><a id=__codelineno-3-138 name=__codelineno-3-138></a><a href=#__codelineno-3-138><span class=linenos data-linenos="138 "></span></a>        <span class=p>)</span>
</span><span id=__span-3-139><a id=__codelineno-3-139 name=__codelineno-3-139></a><a href=#__codelineno-3-139><span class=linenos data-linenos="139 "></span></a>        
</span><span id=__span-3-140><a id=__codelineno-3-140 name=__codelineno-3-140></a><a href=#__codelineno-3-140><span class=linenos data-linenos="140 "></span></a>        <span class=c1># Assert</span>
</span><span id=__span-3-141><a id=__codelineno-3-141 name=__codelineno-3-141></a><a href=#__codelineno-3-141><span class=linenos data-linenos="141 "></span></a>        <span class=k>assert</span> <span class=n>second_invite</span><span class=o>.</span><span class=n>success</span> <span class=ow>is</span> <span class=kc>True</span>
</span><span id=__span-3-142><a id=__codelineno-3-142 name=__codelineno-3-142></a><a href=#__codelineno-3-142><span class=linenos data-linenos="142 "></span></a>        <span class=k>assert</span> <span class=n>Invitation</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>count</span><span class=p>()</span> <span class=o>==</span> <span class=mi>1</span>  <span class=c1># Only one invitation exists</span>
</span><span id=__span-3-143><a id=__codelineno-3-143 name=__codelineno-3-143></a><a href=#__codelineno-3-143><span class=linenos data-linenos="143 "></span></a>        
</span><span id=__span-3-144><a id=__codelineno-3-144 name=__codelineno-3-144></a><a href=#__codelineno-3-144><span class=linenos data-linenos="144 "></span></a>        <span class=n>invitation</span> <span class=o>=</span> <span class=n>Invitation</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</span><span id=__span-3-145><a id=__codelineno-3-145 name=__codelineno-3-145></a><a href=#__codelineno-3-145><span class=linenos data-linenos="145 "></span></a>        <span class=k>assert</span> <span class=n>invitation</span><span class=o>.</span><span class=n>role</span> <span class=o>==</span> <span class=s2>&quot;editor&quot;</span>  <span class=c1># Updated to new role</span>
</span><span id=__span-3-146><a id=__codelineno-3-146 name=__codelineno-3-146></a><a href=#__codelineno-3-146><span class=linenos data-linenos="146 "></span></a>        <span class=k>assert</span> <span class=n>invitation</span><span class=o>.</span><span class=n>created_at</span> <span class=o>&gt;</span> <span class=n>first_invite</span><span class=o>.</span><span class=n>created_at</span>
</span><span id=__span-3-147><a id=__codelineno-3-147 name=__codelineno-3-147></a><a href=#__codelineno-3-147><span class=linenos data-linenos="147 "></span></a>    
</span><span id=__span-3-148><a id=__codelineno-3-148 name=__codelineno-3-148></a><a href=#__codelineno-3-148><span class=linenos data-linenos="148 "></span></a>    <span class=k>def</span> <span class=nf>test_malformed_email_addresses_rejected</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>db</span><span class=p>,</span> <span class=n>workspace_admin</span><span class=p>):</span>
</span><span id=__span-3-149><a id=__codelineno-3-149 name=__codelineno-3-149></a><a href=#__codelineno-3-149><span class=linenos data-linenos="149 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Invalid email formats are rejected&quot;&quot;&quot;</span>
</span><span id=__span-3-150><a id=__codelineno-3-150 name=__codelineno-3-150></a><a href=#__codelineno-3-150><span class=linenos data-linenos="150 "></span></a>        <span class=n>invalid_emails</span> <span class=o>=</span> <span class=p>[</span>
</span><span id=__span-3-151><a id=__codelineno-3-151 name=__codelineno-3-151></a><a href=#__codelineno-3-151><span class=linenos data-linenos="151 "></span></a>            <span class=s2>&quot;not-an-email&quot;</span><span class=p>,</span>
</span><span id=__span-3-152><a id=__codelineno-3-152 name=__codelineno-3-152></a><a href=#__codelineno-3-152><span class=linenos data-linenos="152 "></span></a>            <span class=s2>&quot;@example.com&quot;</span><span class=p>,</span> 
</span><span id=__span-3-153><a id=__codelineno-3-153 name=__codelineno-3-153></a><a href=#__codelineno-3-153><span class=linenos data-linenos="153 "></span></a>            <span class=s2>&quot;user@&quot;</span><span class=p>,</span>
</span><span id=__span-3-154><a id=__codelineno-3-154 name=__codelineno-3-154></a><a href=#__codelineno-3-154><span class=linenos data-linenos="154 "></span></a>            <span class=s2>&quot;user@.com&quot;</span><span class=p>,</span>
</span><span id=__span-3-155><a id=__codelineno-3-155 name=__codelineno-3-155></a><a href=#__codelineno-3-155><span class=linenos data-linenos="155 "></span></a>            <span class=s2>&quot;user@example&quot;</span><span class=p>,</span>
</span><span id=__span-3-156><a id=__codelineno-3-156 name=__codelineno-3-156></a><a href=#__codelineno-3-156><span class=linenos data-linenos="156 "></span></a>            <span class=s2>&quot;&quot;</span><span class=p>,</span>
</span><span id=__span-3-157><a id=__codelineno-3-157 name=__codelineno-3-157></a><a href=#__codelineno-3-157><span class=linenos data-linenos="157 "></span></a>            <span class=kc>None</span>
</span><span id=__span-3-158><a id=__codelineno-3-158 name=__codelineno-3-158></a><a href=#__codelineno-3-158><span class=linenos data-linenos="158 "></span></a>        <span class=p>]</span>
</span><span id=__span-3-159><a id=__codelineno-3-159 name=__codelineno-3-159></a><a href=#__codelineno-3-159><span class=linenos data-linenos="159 "></span></a>        
</span><span id=__span-3-160><a id=__codelineno-3-160 name=__codelineno-3-160></a><a href=#__codelineno-3-160><span class=linenos data-linenos="160 "></span></a>        <span class=k>for</span> <span class=n>email</span> <span class=ow>in</span> <span class=n>invalid_emails</span><span class=p>:</span>
</span><span id=__span-3-161><a id=__codelineno-3-161 name=__codelineno-3-161></a><a href=#__codelineno-3-161><span class=linenos data-linenos="161 "></span></a>            <span class=n>result</span> <span class=o>=</span> <span class=n>InvitationService</span><span class=o>.</span><span class=n>send_invitation</span><span class=p>(</span>
</span><span id=__span-3-162><a id=__codelineno-3-162 name=__codelineno-3-162></a><a href=#__codelineno-3-162><span class=linenos data-linenos="162 "></span></a>                <span class=n>admin_user</span><span class=o>=</span><span class=n>workspace_admin</span><span class=p>,</span>
</span><span id=__span-3-163><a id=__codelineno-3-163 name=__codelineno-3-163></a><a href=#__codelineno-3-163><span class=linenos data-linenos="163 "></span></a>                <span class=n>workspace_id</span><span class=o>=</span><span class=n>workspace_admin</span><span class=o>.</span><span class=n>workspace</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-3-164><a id=__codelineno-3-164 name=__codelineno-3-164></a><a href=#__codelineno-3-164><span class=linenos data-linenos="164 "></span></a>                <span class=n>email</span><span class=o>=</span><span class=n>email</span><span class=p>,</span>
</span><span id=__span-3-165><a id=__codelineno-3-165 name=__codelineno-3-165></a><a href=#__codelineno-3-165><span class=linenos data-linenos="165 "></span></a>                <span class=n>role</span><span class=o>=</span><span class=s2>&quot;viewer&quot;</span>
</span><span id=__span-3-166><a id=__codelineno-3-166 name=__codelineno-3-166></a><a href=#__codelineno-3-166><span class=linenos data-linenos="166 "></span></a>            <span class=p>)</span>
</span><span id=__span-3-167><a id=__codelineno-3-167 name=__codelineno-3-167></a><a href=#__codelineno-3-167><span class=linenos data-linenos="167 "></span></a>            
</span><span id=__span-3-168><a id=__codelineno-3-168 name=__codelineno-3-168></a><a href=#__codelineno-3-168><span class=linenos data-linenos="168 "></span></a>            <span class=k>assert</span> <span class=n>result</span><span class=o>.</span><span class=n>success</span> <span class=ow>is</span> <span class=kc>False</span>
</span><span id=__span-3-169><a id=__codelineno-3-169 name=__codelineno-3-169></a><a href=#__codelineno-3-169><span class=linenos data-linenos="169 "></span></a>            <span class=k>assert</span> <span class=s2>&quot;Invalid email&quot;</span> <span class=ow>in</span> <span class=n>result</span><span class=o>.</span><span class=n>error</span>
</span><span id=__span-3-170><a id=__codelineno-3-170 name=__codelineno-3-170></a><a href=#__codelineno-3-170><span class=linenos data-linenos="170 "></span></a>            <span class=k>assert</span> <span class=n>result</span><span class=o>.</span><span class=n>code</span> <span class=o>==</span> <span class=mi>400</span>
</span><span id=__span-3-171><a id=__codelineno-3-171 name=__codelineno-3-171></a><a href=#__codelineno-3-171><span class=linenos data-linenos="171 "></span></a>        
</span><span id=__span-3-172><a id=__codelineno-3-172 name=__codelineno-3-172></a><a href=#__codelineno-3-172><span class=linenos data-linenos="172 "></span></a>        <span class=c1># No invitations should be created</span>
</span><span id=__span-3-173><a id=__codelineno-3-173 name=__codelineno-3-173></a><a href=#__codelineno-3-173><span class=linenos data-linenos="173 "></span></a>        <span class=k>assert</span> <span class=n>Invitation</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>count</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span>
</span><span id=__span-3-174><a id=__codelineno-3-174 name=__codelineno-3-174></a><a href=#__codelineno-3-174><span class=linenos data-linenos="174 "></span></a>    
</span><span id=__span-3-175><a id=__codelineno-3-175 name=__codelineno-3-175></a><a href=#__codelineno-3-175><span class=linenos data-linenos="175 "></span></a>    <span class=c1># 📧 EMAIL INTEGRATION TESTS</span>
</span><span id=__span-3-176><a id=__codelineno-3-176 name=__codelineno-3-176></a><a href=#__codelineno-3-176><span class=linenos data-linenos="176 "></span></a>    <span class=nd>@patch</span><span class=p>(</span><span class=s1>&#39;app.email.send_invitation_email&#39;</span><span class=p>)</span>
</span><span id=__span-3-177><a id=__codelineno-3-177 name=__codelineno-3-177></a><a href=#__codelineno-3-177><span class=linenos data-linenos="177 "></span></a>    <span class=k>def</span> <span class=nf>test_invitation_email_sent_with_correct_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>mock_send_email</span><span class=p>,</span> <span class=n>db</span><span class=p>,</span> <span class=n>workspace_admin</span><span class=p>):</span>
</span><span id=__span-3-178><a id=__codelineno-3-178 name=__codelineno-3-178></a><a href=#__codelineno-3-178><span class=linenos data-linenos="178 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Invitation email is sent with proper template data&quot;&quot;&quot;</span>
</span><span id=__span-3-179><a id=__codelineno-3-179 name=__codelineno-3-179></a><a href=#__codelineno-3-179><span class=linenos data-linenos="179 "></span></a>        <span class=c1># Act</span>
</span><span id=__span-3-180><a id=__codelineno-3-180 name=__codelineno-3-180></a><a href=#__codelineno-3-180><span class=linenos data-linenos="180 "></span></a>        <span class=n>result</span> <span class=o>=</span> <span class=n>InvitationService</span><span class=o>.</span><span class=n>send_invitation</span><span class=p>(</span>
</span><span id=__span-3-181><a id=__codelineno-3-181 name=__codelineno-3-181></a><a href=#__codelineno-3-181><span class=linenos data-linenos="181 "></span></a>            <span class=n>admin_user</span><span class=o>=</span><span class=n>workspace_admin</span><span class=p>,</span>
</span><span id=__span-3-182><a id=__codelineno-3-182 name=__codelineno-3-182></a><a href=#__codelineno-3-182><span class=linenos data-linenos="182 "></span></a>            <span class=n>workspace_id</span><span class=o>=</span><span class=n>workspace_admin</span><span class=o>.</span><span class=n>workspace</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-3-183><a id=__codelineno-3-183 name=__codelineno-3-183></a><a href=#__codelineno-3-183><span class=linenos data-linenos="183 "></span></a>            <span class=n>email</span><span class=o>=</span><span class=s2>&quot;newbie@example.com&quot;</span><span class=p>,</span>
</span><span id=__span-3-184><a id=__codelineno-3-184 name=__codelineno-3-184></a><a href=#__codelineno-3-184><span class=linenos data-linenos="184 "></span></a>            <span class=n>role</span><span class=o>=</span><span class=s2>&quot;editor&quot;</span><span class=p>,</span>
</span><span id=__span-3-185><a id=__codelineno-3-185 name=__codelineno-3-185></a><a href=#__codelineno-3-185><span class=linenos data-linenos="185 "></span></a>            <span class=n>message</span><span class=o>=</span><span class=s2>&quot;Welcome to our amazing team!&quot;</span>
</span><span id=__span-3-186><a id=__codelineno-3-186 name=__codelineno-3-186></a><a href=#__codelineno-3-186><span class=linenos data-linenos="186 "></span></a>        <span class=p>)</span>
</span><span id=__span-3-187><a id=__codelineno-3-187 name=__codelineno-3-187></a><a href=#__codelineno-3-187><span class=linenos data-linenos="187 "></span></a>        
</span><span id=__span-3-188><a id=__codelineno-3-188 name=__codelineno-3-188></a><a href=#__codelineno-3-188><span class=linenos data-linenos="188 "></span></a>        <span class=c1># Assert</span>
</span><span id=__span-3-189><a id=__codelineno-3-189 name=__codelineno-3-189></a><a href=#__codelineno-3-189><span class=linenos data-linenos="189 "></span></a>        <span class=k>assert</span> <span class=n>result</span><span class=o>.</span><span class=n>success</span> <span class=ow>is</span> <span class=kc>True</span>
</span><span id=__span-3-190><a id=__codelineno-3-190 name=__codelineno-3-190></a><a href=#__codelineno-3-190><span class=linenos data-linenos="190 "></span></a>        <span class=n>mock_send_email</span><span class=o>.</span><span class=n>assert_called_once</span><span class=p>()</span>
</span><span id=__span-3-191><a id=__codelineno-3-191 name=__codelineno-3-191></a><a href=#__codelineno-3-191><span class=linenos data-linenos="191 "></span></a>        
</span><span id=__span-3-192><a id=__codelineno-3-192 name=__codelineno-3-192></a><a href=#__codelineno-3-192><span class=linenos data-linenos="192 "></span></a>        <span class=n>call_args</span> <span class=o>=</span> <span class=n>mock_send_email</span><span class=o>.</span><span class=n>call_args</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-3-193><a id=__codelineno-3-193 name=__codelineno-3-193></a><a href=#__codelineno-3-193><span class=linenos data-linenos="193 "></span></a>        <span class=k>assert</span> <span class=n>call_args</span><span class=p>[</span><span class=s1>&#39;to_email&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&quot;newbie@example.com&quot;</span>
</span><span id=__span-3-194><a id=__codelineno-3-194 name=__codelineno-3-194></a><a href=#__codelineno-3-194><span class=linenos data-linenos="194 "></span></a>        <span class=k>assert</span> <span class=n>call_args</span><span class=p>[</span><span class=s1>&#39;template&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&quot;team_invitation&quot;</span>
</span><span id=__span-3-195><a id=__codelineno-3-195 name=__codelineno-3-195></a><a href=#__codelineno-3-195><span class=linenos data-linenos="195 "></span></a>        <span class=k>assert</span> <span class=n>call_args</span><span class=p>[</span><span class=s1>&#39;context&#39;</span><span class=p>][</span><span class=s1>&#39;workspace_name&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>workspace_admin</span><span class=o>.</span><span class=n>workspace</span><span class=o>.</span><span class=n>name</span>
</span><span id=__span-3-196><a id=__codelineno-3-196 name=__codelineno-3-196></a><a href=#__codelineno-3-196><span class=linenos data-linenos="196 "></span></a>        <span class=k>assert</span> <span class=n>call_args</span><span class=p>[</span><span class=s1>&#39;context&#39;</span><span class=p>][</span><span class=s1>&#39;admin_name&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>workspace_admin</span><span class=o>.</span><span class=n>name</span>
</span><span id=__span-3-197><a id=__codelineno-3-197 name=__codelineno-3-197></a><a href=#__codelineno-3-197><span class=linenos data-linenos="197 "></span></a>        <span class=k>assert</span> <span class=n>call_args</span><span class=p>[</span><span class=s1>&#39;context&#39;</span><span class=p>][</span><span class=s1>&#39;role&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&quot;editor&quot;</span>
</span><span id=__span-3-198><a id=__codelineno-3-198 name=__codelineno-3-198></a><a href=#__codelineno-3-198><span class=linenos data-linenos="198 "></span></a>        <span class=k>assert</span> <span class=n>call_args</span><span class=p>[</span><span class=s1>&#39;context&#39;</span><span class=p>][</span><span class=s1>&#39;message&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&quot;Welcome to our amazing team!&quot;</span>
</span><span id=__span-3-199><a id=__codelineno-3-199 name=__codelineno-3-199></a><a href=#__codelineno-3-199><span class=linenos data-linenos="199 "></span></a>        <span class=k>assert</span> <span class=s1>&#39;invitation_url&#39;</span> <span class=ow>in</span> <span class=n>call_args</span><span class=p>[</span><span class=s1>&#39;context&#39;</span><span class=p>]</span>
</span><span id=__span-3-200><a id=__codelineno-3-200 name=__codelineno-3-200></a><a href=#__codelineno-3-200><span class=linenos data-linenos="200 "></span></a>    
</span><span id=__span-3-201><a id=__codelineno-3-201 name=__codelineno-3-201></a><a href=#__codelineno-3-201><span class=linenos data-linenos="201 "></span></a>    <span class=c1># 🏃‍♂️ PERFORMANCE TESTS</span>
</span><span id=__span-3-202><a id=__codelineno-3-202 name=__codelineno-3-202></a><a href=#__codelineno-3-202><span class=linenos data-linenos="202 "></span></a>    <span class=k>def</span> <span class=nf>test_bulk_invitation_performance</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>db</span><span class=p>,</span> <span class=n>workspace_admin</span><span class=p>):</span>
</span><span id=__span-3-203><a id=__codelineno-3-203 name=__codelineno-3-203></a><a href=#__codelineno-3-203><span class=linenos data-linenos="203 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;System can handle bulk invitations efficiently&quot;&quot;&quot;</span>
</span><span id=__span-3-204><a id=__codelineno-3-204 name=__codelineno-3-204></a><a href=#__codelineno-3-204><span class=linenos data-linenos="204 "></span></a>        <span class=c1># Arrange</span>
</span><span id=__span-3-205><a id=__codelineno-3-205 name=__codelineno-3-205></a><a href=#__codelineno-3-205><span class=linenos data-linenos="205 "></span></a>        <span class=n>emails</span> <span class=o>=</span> <span class=p>[</span><span class=sa>f</span><span class=s2>&quot;user</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>@example.com&quot;</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>50</span><span class=p>)]</span>
</span><span id=__span-3-206><a id=__codelineno-3-206 name=__codelineno-3-206></a><a href=#__codelineno-3-206><span class=linenos data-linenos="206 "></span></a>        
</span><span id=__span-3-207><a id=__codelineno-3-207 name=__codelineno-3-207></a><a href=#__codelineno-3-207><span class=linenos data-linenos="207 "></span></a>        <span class=c1># Act &amp; Assert</span>
</span><span id=__span-3-208><a id=__codelineno-3-208 name=__codelineno-3-208></a><a href=#__codelineno-3-208><span class=linenos data-linenos="208 "></span></a>        <span class=n>start_time</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span>
</span><span id=__span-3-209><a id=__codelineno-3-209 name=__codelineno-3-209></a><a href=#__codelineno-3-209><span class=linenos data-linenos="209 "></span></a>        
</span><span id=__span-3-210><a id=__codelineno-3-210 name=__codelineno-3-210></a><a href=#__codelineno-3-210><span class=linenos data-linenos="210 "></span></a>        <span class=n>results</span> <span class=o>=</span> <span class=n>InvitationService</span><span class=o>.</span><span class=n>send_bulk_invitations</span><span class=p>(</span>
</span><span id=__span-3-211><a id=__codelineno-3-211 name=__codelineno-3-211></a><a href=#__codelineno-3-211><span class=linenos data-linenos="211 "></span></a>            <span class=n>admin_user</span><span class=o>=</span><span class=n>workspace_admin</span><span class=p>,</span>
</span><span id=__span-3-212><a id=__codelineno-3-212 name=__codelineno-3-212></a><a href=#__codelineno-3-212><span class=linenos data-linenos="212 "></span></a>            <span class=n>workspace_id</span><span class=o>=</span><span class=n>workspace_admin</span><span class=o>.</span><span class=n>workspace</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-3-213><a id=__codelineno-3-213 name=__codelineno-3-213></a><a href=#__codelineno-3-213><span class=linenos data-linenos="213 "></span></a>            <span class=n>emails</span><span class=o>=</span><span class=n>emails</span><span class=p>,</span>
</span><span id=__span-3-214><a id=__codelineno-3-214 name=__codelineno-3-214></a><a href=#__codelineno-3-214><span class=linenos data-linenos="214 "></span></a>            <span class=n>role</span><span class=o>=</span><span class=s2>&quot;viewer&quot;</span>
</span><span id=__span-3-215><a id=__codelineno-3-215 name=__codelineno-3-215></a><a href=#__codelineno-3-215><span class=linenos data-linenos="215 "></span></a>        <span class=p>)</span>
</span><span id=__span-3-216><a id=__codelineno-3-216 name=__codelineno-3-216></a><a href=#__codelineno-3-216><span class=linenos data-linenos="216 "></span></a>        
</span><span id=__span-3-217><a id=__codelineno-3-217 name=__codelineno-3-217></a><a href=#__codelineno-3-217><span class=linenos data-linenos="217 "></span></a>        <span class=n>end_time</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span>
</span><span id=__span-3-218><a id=__codelineno-3-218 name=__codelineno-3-218></a><a href=#__codelineno-3-218><span class=linenos data-linenos="218 "></span></a>        <span class=n>processing_time</span> <span class=o>=</span> <span class=p>(</span><span class=n>end_time</span> <span class=o>-</span> <span class=n>start_time</span><span class=p>)</span><span class=o>.</span><span class=n>total_seconds</span><span class=p>()</span>
</span><span id=__span-3-219><a id=__codelineno-3-219 name=__codelineno-3-219></a><a href=#__codelineno-3-219><span class=linenos data-linenos="219 "></span></a>        
</span><span id=__span-3-220><a id=__codelineno-3-220 name=__codelineno-3-220></a><a href=#__codelineno-3-220><span class=linenos data-linenos="220 "></span></a>        <span class=c1># Should complete within 5 seconds</span>
</span><span id=__span-3-221><a id=__codelineno-3-221 name=__codelineno-3-221></a><a href=#__codelineno-3-221><span class=linenos data-linenos="221 "></span></a>        <span class=k>assert</span> <span class=n>processing_time</span> <span class=o>&lt;</span> <span class=mf>5.0</span>
</span><span id=__span-3-222><a id=__codelineno-3-222 name=__codelineno-3-222></a><a href=#__codelineno-3-222><span class=linenos data-linenos="222 "></span></a>        <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>results</span><span class=p>)</span> <span class=o>==</span> <span class=mi>50</span>
</span><span id=__span-3-223><a id=__codelineno-3-223 name=__codelineno-3-223></a><a href=#__codelineno-3-223><span class=linenos data-linenos="223 "></span></a>        <span class=k>assert</span> <span class=nb>all</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>success</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>results</span><span class=p>)</span>
</span></code></pre></div><p><strong>⏱️ The Clock Reads 9:35 AM</strong></p><p>You lean back in your chair, amazed. The QA Agent has written 47 comprehensive tests covering every scenario you can imagine (and several you hadn't thought of). Each test is clearly named, well-documented, and follows the Arrange-Act-Assert pattern.</p><p><strong>🔥 The Failing Tests</strong></p><p>Of course, all tests are failing right now—there's no implementation yet! But that's the beauty of TDD. These failing tests are like a GPS for your code, showing you exactly where to go.</p><p><strong>Test execution shows beautiful RED state:</strong><div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1></a><a href=#__codelineno-4-1><span class=linenos data-linenos=" 1 "></span></a>$<span class=w> </span>pytest<span class=w> </span>tests/test_team_invitations.py<span class=w> </span>-v
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2></a><a href=#__codelineno-4-2><span class=linenos data-linenos=" 2 "></span></a><span class=o>==================</span><span class=w> </span><span class=nb>test</span><span class=w> </span>session<span class=w> </span><span class=nv>starts</span><span class=w> </span><span class=o>==================</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3></a><a href=#__codelineno-4-3><span class=linenos data-linenos=" 3 "></span></a>tests/test_team_invitations.py::TestTeamInvitationFeature::test_admin_can_invite_new_team_member<span class=w> </span>FAILED
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4></a><a href=#__codelineno-4-4><span class=linenos data-linenos=" 4 "></span></a>tests/test_team_invitations.py::TestTeamInvitationFeature::test_invited_user_can_accept_valid_invitation<span class=w> </span>FAILED
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5></a><a href=#__codelineno-4-5><span class=linenos data-linenos=" 5 "></span></a>...
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6></a><a href=#__codelineno-4-6><span class=linenos data-linenos=" 6 "></span></a>tests/test_team_invitations.py::TestTeamInvitationFeature::test_bulk_invitation_performance<span class=w> </span><span class=nv>FAILED</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7></a><a href=#__codelineno-4-7><span class=linenos data-linenos=" 7 "></span></a>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8></a><a href=#__codelineno-4-8><span class=linenos data-linenos=" 8 "></span></a><span class=o>==================</span><span class=w> </span><span class=nv>FAILURES</span><span class=w> </span><span class=o>==================</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9></a><a href=#__codelineno-4-9><span class=linenos data-linenos=" 9 "></span></a>______<span class=w> </span>TestTeamInvitationFeature.test_admin_can_invite_new_team_member<span class=w> </span>______
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10></a><a href=#__codelineno-4-10><span class=linenos data-linenos="10 "></span></a>ImportError:<span class=w> </span>cannot<span class=w> </span>import<span class=w> </span>name<span class=w> </span><span class=s1>&#39;InvitationService&#39;</span><span class=w> </span>from<span class=w> </span><span class=s1>&#39;app.invitations&#39;</span>
</span></code></pre></div></p><p><strong>🎉 Perfect!</strong> All 47 tests are failing exactly as expected. This is what RED looks like—every failing test is a specification for what needs to be built.</p><h3 id=the-code-agents-grand-entrance-940-am>🟢 The Code Agent's Grand Entrance (9:40 AM)<a class=headerlink href=#the-code-agents-grand-entrance-940-am title="Permanent link">&para;</a></h3><p>Now comes the magic. The Code Agent is like a surgical precision coder who can implement features faster than you can say "minimum viable product." But here's the kicker—it doesn't try to build everything at once. It follows the sacred TDD rule: <em>make the test pass with the simplest possible solution.</em></p><p><strong>The Code Agent's Strategy</strong>: "I see 47 failing tests. I'm not going to build a perfect invitation system right away. I'm going to build the <em>simplest</em> invitation system that makes these tests pass. Then I'll refactor it into something beautiful."</p><h4 id=first-implementation-the-minimalist-approach>💡 First Implementation: The Minimalist Approach<a class=headerlink href=#first-implementation-the-minimalist-approach title="Permanent link">&para;</a></h4><div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1></a><a href=#__codelineno-5-1><span class=linenos data-linenos="  1 "></span></a><span class=c1># Generated by Code Agent - First Pass (9:40-10:15 AM)</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2></a><a href=#__codelineno-5-2><span class=linenos data-linenos="  2 "></span></a><span class=c1># app/invitations.py</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3></a><a href=#__codelineno-5-3><span class=linenos data-linenos="  3 "></span></a><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4></a><a href=#__codelineno-5-4><span class=linenos data-linenos="  4 "></span></a><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>List</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5></a><a href=#__codelineno-5-5><span class=linenos data-linenos="  5 "></span></a><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6></a><a href=#__codelineno-5-6><span class=linenos data-linenos="  6 "></span></a><span class=kn>import</span> <span class=nn>secrets</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7></a><a href=#__codelineno-5-7><span class=linenos data-linenos="  7 "></span></a><span class=kn>import</span> <span class=nn>re</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8></a><a href=#__codelineno-5-8><span class=linenos data-linenos="  8 "></span></a><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>current_app</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9></a><a href=#__codelineno-5-9><span class=linenos data-linenos="  9 "></span></a><span class=kn>from</span> <span class=nn>app.models</span> <span class=kn>import</span> <span class=n>User</span><span class=p>,</span> <span class=n>Workspace</span><span class=p>,</span> <span class=n>Invitation</span><span class=p>,</span> <span class=n>db</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10></a><a href=#__codelineno-5-10><span class=linenos data-linenos=" 10 "></span></a><span class=kn>from</span> <span class=nn>app.email</span> <span class=kn>import</span> <span class=n>send_invitation_email</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11></a><a href=#__codelineno-5-11><span class=linenos data-linenos=" 11 "></span></a>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12></a><a href=#__codelineno-5-12><span class=linenos data-linenos=" 12 "></span></a><span class=nd>@dataclass</span>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13></a><a href=#__codelineno-5-13><span class=linenos data-linenos=" 13 "></span></a><span class=k>class</span> <span class=nc>InvitationResult</span><span class=p>:</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14></a><a href=#__codelineno-5-14><span class=linenos data-linenos=" 14 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Simple result object for invitation operations&quot;&quot;&quot;</span>
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15></a><a href=#__codelineno-5-15><span class=linenos data-linenos=" 15 "></span></a>    <span class=n>success</span><span class=p>:</span> <span class=nb>bool</span>
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16></a><a href=#__codelineno-5-16><span class=linenos data-linenos=" 16 "></span></a>    <span class=n>invitation_id</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-5-17><a id=__codelineno-5-17 name=__codelineno-5-17></a><a href=#__codelineno-5-17><span class=linenos data-linenos=" 17 "></span></a>    <span class=n>expires_at</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>datetime</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-5-18><a id=__codelineno-5-18 name=__codelineno-5-18></a><a href=#__codelineno-5-18><span class=linenos data-linenos=" 18 "></span></a>    <span class=n>error</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-5-19><a id=__codelineno-5-19 name=__codelineno-5-19></a><a href=#__codelineno-5-19><span class=linenos data-linenos=" 19 "></span></a>    <span class=n>code</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-5-20><a id=__codelineno-5-20 name=__codelineno-5-20></a><a href=#__codelineno-5-20><span class=linenos data-linenos=" 20 "></span></a>    <span class=n>created_at</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>datetime</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-5-21><a id=__codelineno-5-21 name=__codelineno-5-21></a><a href=#__codelineno-5-21><span class=linenos data-linenos=" 21 "></span></a>
</span><span id=__span-5-22><a id=__codelineno-5-22 name=__codelineno-5-22></a><a href=#__codelineno-5-22><span class=linenos data-linenos=" 22 "></span></a><span class=k>class</span> <span class=nc>InvitationService</span><span class=p>:</span>
</span><span id=__span-5-23><a id=__codelineno-5-23 name=__codelineno-5-23></a><a href=#__codelineno-5-23><span class=linenos data-linenos=" 23 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Basic invitation service - just enough to make tests pass&quot;&quot;&quot;</span>
</span><span id=__span-5-24><a id=__codelineno-5-24 name=__codelineno-5-24></a><a href=#__codelineno-5-24><span class=linenos data-linenos=" 24 "></span></a>    
</span><span id=__span-5-25><a id=__codelineno-5-25 name=__codelineno-5-25></a><a href=#__codelineno-5-25><span class=linenos data-linenos=" 25 "></span></a>    <span class=n>EXPIRY_DAYS</span> <span class=o>=</span> <span class=mi>7</span>
</span><span id=__span-5-26><a id=__codelineno-5-26 name=__codelineno-5-26></a><a href=#__codelineno-5-26><span class=linenos data-linenos=" 26 "></span></a>    <span class=n>MAX_INVITATIONS_PER_HOUR</span> <span class=o>=</span> <span class=mi>10</span>
</span><span id=__span-5-27><a id=__codelineno-5-27 name=__codelineno-5-27></a><a href=#__codelineno-5-27><span class=linenos data-linenos=" 27 "></span></a>    
</span><span id=__span-5-28><a id=__codelineno-5-28 name=__codelineno-5-28></a><a href=#__codelineno-5-28><span class=linenos data-linenos=" 28 "></span></a>    <span class=nd>@classmethod</span>
</span><span id=__span-5-29><a id=__codelineno-5-29 name=__codelineno-5-29></a><a href=#__codelineno-5-29><span class=linenos data-linenos=" 29 "></span></a>    <span class=k>def</span> <span class=nf>send_invitation</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>admin_user</span><span class=p>:</span> <span class=n>User</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> 
</span><span id=__span-5-30><a id=__codelineno-5-30 name=__codelineno-5-30></a><a href=#__codelineno-5-30><span class=linenos data-linenos=" 30 "></span></a>                       <span class=n>email</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>role</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>message</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>InvitationResult</span><span class=p>:</span>
</span><span id=__span-5-31><a id=__codelineno-5-31 name=__codelineno-5-31></a><a href=#__codelineno-5-31><span class=linenos data-linenos=" 31 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Send invitation - minimal implementation&quot;&quot;&quot;</span>
</span><span id=__span-5-32><a id=__codelineno-5-32 name=__codelineno-5-32></a><a href=#__codelineno-5-32><span class=linenos data-linenos=" 32 "></span></a>        
</span><span id=__span-5-33><a id=__codelineno-5-33 name=__codelineno-5-33></a><a href=#__codelineno-5-33><span class=linenos data-linenos=" 33 "></span></a>        <span class=c1># Check admin permissions (make security test pass)</span>
</span><span id=__span-5-34><a id=__codelineno-5-34 name=__codelineno-5-34></a><a href=#__codelineno-5-34><span class=linenos data-linenos=" 34 "></span></a>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>cls</span><span class=o>.</span><span class=n>_is_workspace_admin</span><span class=p>(</span><span class=n>admin_user</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>):</span>
</span><span id=__span-5-35><a id=__codelineno-5-35 name=__codelineno-5-35></a><a href=#__codelineno-5-35><span class=linenos data-linenos=" 35 "></span></a>            <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span>
</span><span id=__span-5-36><a id=__codelineno-5-36 name=__codelineno-5-36></a><a href=#__codelineno-5-36><span class=linenos data-linenos=" 36 "></span></a>                <span class=n>success</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> 
</span><span id=__span-5-37><a id=__codelineno-5-37 name=__codelineno-5-37></a><a href=#__codelineno-5-37><span class=linenos data-linenos=" 37 "></span></a>                <span class=n>error</span><span class=o>=</span><span class=s2>&quot;Insufficient permissions&quot;</span><span class=p>,</span> 
</span><span id=__span-5-38><a id=__codelineno-5-38 name=__codelineno-5-38></a><a href=#__codelineno-5-38><span class=linenos data-linenos=" 38 "></span></a>                <span class=n>code</span><span class=o>=</span><span class=mi>403</span>
</span><span id=__span-5-39><a id=__codelineno-5-39 name=__codelineno-5-39></a><a href=#__codelineno-5-39><span class=linenos data-linenos=" 39 "></span></a>            <span class=p>)</span>
</span><span id=__span-5-40><a id=__codelineno-5-40 name=__codelineno-5-40></a><a href=#__codelineno-5-40><span class=linenos data-linenos=" 40 "></span></a>        
</span><span id=__span-5-41><a id=__codelineno-5-41 name=__codelineno-5-41></a><a href=#__codelineno-5-41><span class=linenos data-linenos=" 41 "></span></a>        <span class=c1># Validate email (make validation tests pass)</span>
</span><span id=__span-5-42><a id=__codelineno-5-42 name=__codelineno-5-42></a><a href=#__codelineno-5-42><span class=linenos data-linenos=" 42 "></span></a>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>cls</span><span class=o>.</span><span class=n>_is_valid_email</span><span class=p>(</span><span class=n>email</span><span class=p>):</span>
</span><span id=__span-5-43><a id=__codelineno-5-43 name=__codelineno-5-43></a><a href=#__codelineno-5-43><span class=linenos data-linenos=" 43 "></span></a>            <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span>
</span><span id=__span-5-44><a id=__codelineno-5-44 name=__codelineno-5-44></a><a href=#__codelineno-5-44><span class=linenos data-linenos=" 44 "></span></a>                <span class=n>success</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> 
</span><span id=__span-5-45><a id=__codelineno-5-45 name=__codelineno-5-45></a><a href=#__codelineno-5-45><span class=linenos data-linenos=" 45 "></span></a>                <span class=n>error</span><span class=o>=</span><span class=s2>&quot;Invalid email format&quot;</span><span class=p>,</span> 
</span><span id=__span-5-46><a id=__codelineno-5-46 name=__codelineno-5-46></a><a href=#__codelineno-5-46><span class=linenos data-linenos=" 46 "></span></a>                <span class=n>code</span><span class=o>=</span><span class=mi>400</span>
</span><span id=__span-5-47><a id=__codelineno-5-47 name=__codelineno-5-47></a><a href=#__codelineno-5-47><span class=linenos data-linenos=" 47 "></span></a>            <span class=p>)</span>
</span><span id=__span-5-48><a id=__codelineno-5-48 name=__codelineno-5-48></a><a href=#__codelineno-5-48><span class=linenos data-linenos=" 48 "></span></a>        
</span><span id=__span-5-49><a id=__codelineno-5-49 name=__codelineno-5-49></a><a href=#__codelineno-5-49><span class=linenos data-linenos=" 49 "></span></a>        <span class=c1># Check rate limiting (make rate limit test pass)</span>
</span><span id=__span-5-50><a id=__codelineno-5-50 name=__codelineno-5-50></a><a href=#__codelineno-5-50><span class=linenos data-linenos=" 50 "></span></a>        <span class=k>if</span> <span class=bp>cls</span><span class=o>.</span><span class=n>_is_rate_limited</span><span class=p>(</span><span class=n>admin_user</span><span class=p>):</span>
</span><span id=__span-5-51><a id=__codelineno-5-51 name=__codelineno-5-51></a><a href=#__codelineno-5-51><span class=linenos data-linenos=" 51 "></span></a>            <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span>
</span><span id=__span-5-52><a id=__codelineno-5-52 name=__codelineno-5-52></a><a href=#__codelineno-5-52><span class=linenos data-linenos=" 52 "></span></a>                <span class=n>success</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> 
</span><span id=__span-5-53><a id=__codelineno-5-53 name=__codelineno-5-53></a><a href=#__codelineno-5-53><span class=linenos data-linenos=" 53 "></span></a>                <span class=n>error</span><span class=o>=</span><span class=s2>&quot;Rate limit exceeded&quot;</span><span class=p>,</span> 
</span><span id=__span-5-54><a id=__codelineno-5-54 name=__codelineno-5-54></a><a href=#__codelineno-5-54><span class=linenos data-linenos=" 54 "></span></a>                <span class=n>code</span><span class=o>=</span><span class=mi>429</span>
</span><span id=__span-5-55><a id=__codelineno-5-55 name=__codelineno-5-55></a><a href=#__codelineno-5-55><span class=linenos data-linenos=" 55 "></span></a>            <span class=p>)</span>
</span><span id=__span-5-56><a id=__codelineno-5-56 name=__codelineno-5-56></a><a href=#__codelineno-5-56><span class=linenos data-linenos=" 56 "></span></a>        
</span><span id=__span-5-57><a id=__codelineno-5-57 name=__codelineno-5-57></a><a href=#__codelineno-5-57><span class=linenos data-linenos=" 57 "></span></a>        <span class=c1># Handle duplicates (update existing)</span>
</span><span id=__span-5-58><a id=__codelineno-5-58 name=__codelineno-5-58></a><a href=#__codelineno-5-58><span class=linenos data-linenos=" 58 "></span></a>        <span class=n>existing</span> <span class=o>=</span> <span class=bp>cls</span><span class=o>.</span><span class=n>_find_existing_invitation</span><span class=p>(</span><span class=n>email</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>)</span>
</span><span id=__span-5-59><a id=__codelineno-5-59 name=__codelineno-5-59></a><a href=#__codelineno-5-59><span class=linenos data-linenos=" 59 "></span></a>        <span class=k>if</span> <span class=n>existing</span><span class=p>:</span>
</span><span id=__span-5-60><a id=__codelineno-5-60 name=__codelineno-5-60></a><a href=#__codelineno-5-60><span class=linenos data-linenos=" 60 "></span></a>            <span class=n>existing</span><span class=o>.</span><span class=n>role</span> <span class=o>=</span> <span class=n>role</span>
</span><span id=__span-5-61><a id=__codelineno-5-61 name=__codelineno-5-61></a><a href=#__codelineno-5-61><span class=linenos data-linenos=" 61 "></span></a>            <span class=n>existing</span><span class=o>.</span><span class=n>message</span> <span class=o>=</span> <span class=n>message</span>
</span><span id=__span-5-62><a id=__codelineno-5-62 name=__codelineno-5-62></a><a href=#__codelineno-5-62><span class=linenos data-linenos=" 62 "></span></a>            <span class=n>existing</span><span class=o>.</span><span class=n>created_at</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span>
</span><span id=__span-5-63><a id=__codelineno-5-63 name=__codelineno-5-63></a><a href=#__codelineno-5-63><span class=linenos data-linenos=" 63 "></span></a>            <span class=n>existing</span><span class=o>.</span><span class=n>expires_at</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span> <span class=o>+</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=bp>cls</span><span class=o>.</span><span class=n>EXPIRY_DAYS</span><span class=p>)</span>
</span><span id=__span-5-64><a id=__codelineno-5-64 name=__codelineno-5-64></a><a href=#__codelineno-5-64><span class=linenos data-linenos=" 64 "></span></a>            <span class=n>existing</span><span class=o>.</span><span class=n>token</span> <span class=o>=</span> <span class=bp>cls</span><span class=o>.</span><span class=n>_generate_token</span><span class=p>()</span>
</span><span id=__span-5-65><a id=__codelineno-5-65 name=__codelineno-5-65></a><a href=#__codelineno-5-65><span class=linenos data-linenos=" 65 "></span></a>            <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span><span id=__span-5-66><a id=__codelineno-5-66 name=__codelineno-5-66></a><a href=#__codelineno-5-66><span class=linenos data-linenos=" 66 "></span></a>            
</span><span id=__span-5-67><a id=__codelineno-5-67 name=__codelineno-5-67></a><a href=#__codelineno-5-67><span class=linenos data-linenos=" 67 "></span></a>            <span class=c1># Send email</span>
</span><span id=__span-5-68><a id=__codelineno-5-68 name=__codelineno-5-68></a><a href=#__codelineno-5-68><span class=linenos data-linenos=" 68 "></span></a>            <span class=bp>cls</span><span class=o>.</span><span class=n>_send_invitation_email</span><span class=p>(</span><span class=n>existing</span><span class=p>,</span> <span class=n>admin_user</span><span class=p>)</span>
</span><span id=__span-5-69><a id=__codelineno-5-69 name=__codelineno-5-69></a><a href=#__codelineno-5-69><span class=linenos data-linenos=" 69 "></span></a>            
</span><span id=__span-5-70><a id=__codelineno-5-70 name=__codelineno-5-70></a><a href=#__codelineno-5-70><span class=linenos data-linenos=" 70 "></span></a>            <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span>
</span><span id=__span-5-71><a id=__codelineno-5-71 name=__codelineno-5-71></a><a href=#__codelineno-5-71><span class=linenos data-linenos=" 71 "></span></a>                <span class=n>success</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-5-72><a id=__codelineno-5-72 name=__codelineno-5-72></a><a href=#__codelineno-5-72><span class=linenos data-linenos=" 72 "></span></a>                <span class=n>invitation_id</span><span class=o>=</span><span class=n>existing</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-5-73><a id=__codelineno-5-73 name=__codelineno-5-73></a><a href=#__codelineno-5-73><span class=linenos data-linenos=" 73 "></span></a>                <span class=n>expires_at</span><span class=o>=</span><span class=n>existing</span><span class=o>.</span><span class=n>expires_at</span><span class=p>,</span>
</span><span id=__span-5-74><a id=__codelineno-5-74 name=__codelineno-5-74></a><a href=#__codelineno-5-74><span class=linenos data-linenos=" 74 "></span></a>                <span class=n>created_at</span><span class=o>=</span><span class=n>existing</span><span class=o>.</span><span class=n>created_at</span>
</span><span id=__span-5-75><a id=__codelineno-5-75 name=__codelineno-5-75></a><a href=#__codelineno-5-75><span class=linenos data-linenos=" 75 "></span></a>            <span class=p>)</span>
</span><span id=__span-5-76><a id=__codelineno-5-76 name=__codelineno-5-76></a><a href=#__codelineno-5-76><span class=linenos data-linenos=" 76 "></span></a>        
</span><span id=__span-5-77><a id=__codelineno-5-77 name=__codelineno-5-77></a><a href=#__codelineno-5-77><span class=linenos data-linenos=" 77 "></span></a>        <span class=c1># Create new invitation</span>
</span><span id=__span-5-78><a id=__codelineno-5-78 name=__codelineno-5-78></a><a href=#__codelineno-5-78><span class=linenos data-linenos=" 78 "></span></a>        <span class=n>invitation</span> <span class=o>=</span> <span class=n>Invitation</span><span class=p>(</span>
</span><span id=__span-5-79><a id=__codelineno-5-79 name=__codelineno-5-79></a><a href=#__codelineno-5-79><span class=linenos data-linenos=" 79 "></span></a>            <span class=n>email</span><span class=o>=</span><span class=n>email</span><span class=p>,</span>
</span><span id=__span-5-80><a id=__codelineno-5-80 name=__codelineno-5-80></a><a href=#__codelineno-5-80><span class=linenos data-linenos=" 80 "></span></a>            <span class=n>role</span><span class=o>=</span><span class=n>role</span><span class=p>,</span>
</span><span id=__span-5-81><a id=__codelineno-5-81 name=__codelineno-5-81></a><a href=#__codelineno-5-81><span class=linenos data-linenos=" 81 "></span></a>            <span class=n>message</span><span class=o>=</span><span class=n>message</span><span class=p>,</span>
</span><span id=__span-5-82><a id=__codelineno-5-82 name=__codelineno-5-82></a><a href=#__codelineno-5-82><span class=linenos data-linenos=" 82 "></span></a>            <span class=n>workspace_id</span><span class=o>=</span><span class=n>workspace_id</span><span class=p>,</span>
</span><span id=__span-5-83><a id=__codelineno-5-83 name=__codelineno-5-83></a><a href=#__codelineno-5-83><span class=linenos data-linenos=" 83 "></span></a>            <span class=n>invited_by_id</span><span class=o>=</span><span class=n>admin_user</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-5-84><a id=__codelineno-5-84 name=__codelineno-5-84></a><a href=#__codelineno-5-84><span class=linenos data-linenos=" 84 "></span></a>            <span class=n>token</span><span class=o>=</span><span class=bp>cls</span><span class=o>.</span><span class=n>_generate_token</span><span class=p>(),</span>
</span><span id=__span-5-85><a id=__codelineno-5-85 name=__codelineno-5-85></a><a href=#__codelineno-5-85><span class=linenos data-linenos=" 85 "></span></a>            <span class=n>status</span><span class=o>=</span><span class=s2>&quot;pending&quot;</span><span class=p>,</span>
</span><span id=__span-5-86><a id=__codelineno-5-86 name=__codelineno-5-86></a><a href=#__codelineno-5-86><span class=linenos data-linenos=" 86 "></span></a>            <span class=n>created_at</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>(),</span>
</span><span id=__span-5-87><a id=__codelineno-5-87 name=__codelineno-5-87></a><a href=#__codelineno-5-87><span class=linenos data-linenos=" 87 "></span></a>            <span class=n>expires_at</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span> <span class=o>+</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=bp>cls</span><span class=o>.</span><span class=n>EXPIRY_DAYS</span><span class=p>)</span>
</span><span id=__span-5-88><a id=__codelineno-5-88 name=__codelineno-5-88></a><a href=#__codelineno-5-88><span class=linenos data-linenos=" 88 "></span></a>        <span class=p>)</span>
</span><span id=__span-5-89><a id=__codelineno-5-89 name=__codelineno-5-89></a><a href=#__codelineno-5-89><span class=linenos data-linenos=" 89 "></span></a>        
</span><span id=__span-5-90><a id=__codelineno-5-90 name=__codelineno-5-90></a><a href=#__codelineno-5-90><span class=linenos data-linenos=" 90 "></span></a>        <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>invitation</span><span class=p>)</span>
</span><span id=__span-5-91><a id=__codelineno-5-91 name=__codelineno-5-91></a><a href=#__codelineno-5-91><span class=linenos data-linenos=" 91 "></span></a>        <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span><span id=__span-5-92><a id=__codelineno-5-92 name=__codelineno-5-92></a><a href=#__codelineno-5-92><span class=linenos data-linenos=" 92 "></span></a>        
</span><span id=__span-5-93><a id=__codelineno-5-93 name=__codelineno-5-93></a><a href=#__codelineno-5-93><span class=linenos data-linenos=" 93 "></span></a>        <span class=c1># Send email</span>
</span><span id=__span-5-94><a id=__codelineno-5-94 name=__codelineno-5-94></a><a href=#__codelineno-5-94><span class=linenos data-linenos=" 94 "></span></a>        <span class=bp>cls</span><span class=o>.</span><span class=n>_send_invitation_email</span><span class=p>(</span><span class=n>invitation</span><span class=p>,</span> <span class=n>admin_user</span><span class=p>)</span>
</span><span id=__span-5-95><a id=__codelineno-5-95 name=__codelineno-5-95></a><a href=#__codelineno-5-95><span class=linenos data-linenos=" 95 "></span></a>        
</span><span id=__span-5-96><a id=__codelineno-5-96 name=__codelineno-5-96></a><a href=#__codelineno-5-96><span class=linenos data-linenos=" 96 "></span></a>        <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span>
</span><span id=__span-5-97><a id=__codelineno-5-97 name=__codelineno-5-97></a><a href=#__codelineno-5-97><span class=linenos data-linenos=" 97 "></span></a>            <span class=n>success</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-5-98><a id=__codelineno-5-98 name=__codelineno-5-98></a><a href=#__codelineno-5-98><span class=linenos data-linenos=" 98 "></span></a>            <span class=n>invitation_id</span><span class=o>=</span><span class=n>invitation</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-5-99><a id=__codelineno-5-99 name=__codelineno-5-99></a><a href=#__codelineno-5-99><span class=linenos data-linenos=" 99 "></span></a>            <span class=n>expires_at</span><span class=o>=</span><span class=n>invitation</span><span class=o>.</span><span class=n>expires_at</span><span class=p>,</span>
</span><span id=__span-5-100><a id=__codelineno-5-100 name=__codelineno-5-100></a><a href=#__codelineno-5-100><span class=linenos data-linenos="100 "></span></a>            <span class=n>created_at</span><span class=o>=</span><span class=n>invitation</span><span class=o>.</span><span class=n>created_at</span>
</span><span id=__span-5-101><a id=__codelineno-5-101 name=__codelineno-5-101></a><a href=#__codelineno-5-101><span class=linenos data-linenos="101 "></span></a>        <span class=p>)</span>
</span><span id=__span-5-102><a id=__codelineno-5-102 name=__codelineno-5-102></a><a href=#__codelineno-5-102><span class=linenos data-linenos="102 "></span></a>    
</span><span id=__span-5-103><a id=__codelineno-5-103 name=__codelineno-5-103></a><a href=#__codelineno-5-103><span class=linenos data-linenos="103 "></span></a>    <span class=nd>@classmethod</span>  
</span><span id=__span-5-104><a id=__codelineno-5-104 name=__codelineno-5-104></a><a href=#__codelineno-5-104><span class=linenos data-linenos="104 "></span></a>    <span class=k>def</span> <span class=nf>accept_invitation</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>token</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>user_data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>InvitationResult</span><span class=p>:</span>
</span><span id=__span-5-105><a id=__codelineno-5-105 name=__codelineno-5-105></a><a href=#__codelineno-5-105><span class=linenos data-linenos="105 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Accept invitation and create user&quot;&quot;&quot;</span>
</span><span id=__span-5-106><a id=__codelineno-5-106 name=__codelineno-5-106></a><a href=#__codelineno-5-106><span class=linenos data-linenos="106 "></span></a>        
</span><span id=__span-5-107><a id=__codelineno-5-107 name=__codelineno-5-107></a><a href=#__codelineno-5-107><span class=linenos data-linenos="107 "></span></a>        <span class=n>invitation</span> <span class=o>=</span> <span class=n>Invitation</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>filter_by</span><span class=p>(</span><span class=n>token</span><span class=o>=</span><span class=n>token</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</span><span id=__span-5-108><a id=__codelineno-5-108 name=__codelineno-5-108></a><a href=#__codelineno-5-108><span class=linenos data-linenos="108 "></span></a>        
</span><span id=__span-5-109><a id=__codelineno-5-109 name=__codelineno-5-109></a><a href=#__codelineno-5-109><span class=linenos data-linenos="109 "></span></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>invitation</span><span class=p>:</span>
</span><span id=__span-5-110><a id=__codelineno-5-110 name=__codelineno-5-110></a><a href=#__codelineno-5-110><span class=linenos data-linenos="110 "></span></a>            <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span>
</span><span id=__span-5-111><a id=__codelineno-5-111 name=__codelineno-5-111></a><a href=#__codelineno-5-111><span class=linenos data-linenos="111 "></span></a>                <span class=n>success</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> 
</span><span id=__span-5-112><a id=__codelineno-5-112 name=__codelineno-5-112></a><a href=#__codelineno-5-112><span class=linenos data-linenos="112 "></span></a>                <span class=n>error</span><span class=o>=</span><span class=s2>&quot;Invalid invitation&quot;</span><span class=p>,</span> 
</span><span id=__span-5-113><a id=__codelineno-5-113 name=__codelineno-5-113></a><a href=#__codelineno-5-113><span class=linenos data-linenos="113 "></span></a>                <span class=n>code</span><span class=o>=</span><span class=mi>404</span>
</span><span id=__span-5-114><a id=__codelineno-5-114 name=__codelineno-5-114></a><a href=#__codelineno-5-114><span class=linenos data-linenos="114 "></span></a>            <span class=p>)</span>
</span><span id=__span-5-115><a id=__codelineno-5-115 name=__codelineno-5-115></a><a href=#__codelineno-5-115><span class=linenos data-linenos="115 "></span></a>        
</span><span id=__span-5-116><a id=__codelineno-5-116 name=__codelineno-5-116></a><a href=#__codelineno-5-116><span class=linenos data-linenos="116 "></span></a>        <span class=c1># Check expiration</span>
</span><span id=__span-5-117><a id=__codelineno-5-117 name=__codelineno-5-117></a><a href=#__codelineno-5-117><span class=linenos data-linenos="117 "></span></a>        <span class=k>if</span> <span class=n>invitation</span><span class=o>.</span><span class=n>expires_at</span> <span class=o>&lt;</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>():</span>
</span><span id=__span-5-118><a id=__codelineno-5-118 name=__codelineno-5-118></a><a href=#__codelineno-5-118><span class=linenos data-linenos="118 "></span></a>            <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span>
</span><span id=__span-5-119><a id=__codelineno-5-119 name=__codelineno-5-119></a><a href=#__codelineno-5-119><span class=linenos data-linenos="119 "></span></a>                <span class=n>success</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> 
</span><span id=__span-5-120><a id=__codelineno-5-120 name=__codelineno-5-120></a><a href=#__codelineno-5-120><span class=linenos data-linenos="120 "></span></a>                <span class=n>error</span><span class=o>=</span><span class=s2>&quot;Invitation has expired&quot;</span><span class=p>,</span> 
</span><span id=__span-5-121><a id=__codelineno-5-121 name=__codelineno-5-121></a><a href=#__codelineno-5-121><span class=linenos data-linenos="121 "></span></a>                <span class=n>code</span><span class=o>=</span><span class=mi>410</span>
</span><span id=__span-5-122><a id=__codelineno-5-122 name=__codelineno-5-122></a><a href=#__codelineno-5-122><span class=linenos data-linenos="122 "></span></a>            <span class=p>)</span>
</span><span id=__span-5-123><a id=__codelineno-5-123 name=__codelineno-5-123></a><a href=#__codelineno-5-123><span class=linenos data-linenos="123 "></span></a>        
</span><span id=__span-5-124><a id=__codelineno-5-124 name=__codelineno-5-124></a><a href=#__codelineno-5-124><span class=linenos data-linenos="124 "></span></a>        <span class=c1># Create user</span>
</span><span id=__span-5-125><a id=__codelineno-5-125 name=__codelineno-5-125></a><a href=#__codelineno-5-125><span class=linenos data-linenos="125 "></span></a>        <span class=n>user</span> <span class=o>=</span> <span class=n>User</span><span class=p>(</span>
</span><span id=__span-5-126><a id=__codelineno-5-126 name=__codelineno-5-126></a><a href=#__codelineno-5-126><span class=linenos data-linenos="126 "></span></a>            <span class=n>email</span><span class=o>=</span><span class=n>invitation</span><span class=o>.</span><span class=n>email</span><span class=p>,</span>
</span><span id=__span-5-127><a id=__codelineno-5-127 name=__codelineno-5-127></a><a href=#__codelineno-5-127><span class=linenos data-linenos="127 "></span></a>            <span class=n>name</span><span class=o>=</span><span class=n>user_data</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>],</span>
</span><span id=__span-5-128><a id=__codelineno-5-128 name=__codelineno-5-128></a><a href=#__codelineno-5-128><span class=linenos data-linenos="128 "></span></a>            <span class=n>password_hash</span><span class=o>=</span><span class=bp>cls</span><span class=o>.</span><span class=n>_hash_password</span><span class=p>(</span><span class=n>user_data</span><span class=p>[</span><span class=s1>&#39;password&#39;</span><span class=p>])</span>
</span><span id=__span-5-129><a id=__codelineno-5-129 name=__codelineno-5-129></a><a href=#__codelineno-5-129><span class=linenos data-linenos="129 "></span></a>        <span class=p>)</span>
</span><span id=__span-5-130><a id=__codelineno-5-130 name=__codelineno-5-130></a><a href=#__codelineno-5-130><span class=linenos data-linenos="130 "></span></a>        
</span><span id=__span-5-131><a id=__codelineno-5-131 name=__codelineno-5-131></a><a href=#__codelineno-5-131><span class=linenos data-linenos="131 "></span></a>        <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>
</span><span id=__span-5-132><a id=__codelineno-5-132 name=__codelineno-5-132></a><a href=#__codelineno-5-132><span class=linenos data-linenos="132 "></span></a>        
</span><span id=__span-5-133><a id=__codelineno-5-133 name=__codelineno-5-133></a><a href=#__codelineno-5-133><span class=linenos data-linenos="133 "></span></a>        <span class=c1># Add to workspace</span>
</span><span id=__span-5-134><a id=__codelineno-5-134 name=__codelineno-5-134></a><a href=#__codelineno-5-134><span class=linenos data-linenos="134 "></span></a>        <span class=n>workspace</span> <span class=o>=</span> <span class=n>Workspace</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>invitation</span><span class=o>.</span><span class=n>workspace_id</span><span class=p>)</span>
</span><span id=__span-5-135><a id=__codelineno-5-135 name=__codelineno-5-135></a><a href=#__codelineno-5-135><span class=linenos data-linenos="135 "></span></a>        <span class=n>user</span><span class=o>.</span><span class=n>workspaces</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>workspace</span><span class=p>)</span>
</span><span id=__span-5-136><a id=__codelineno-5-136 name=__codelineno-5-136></a><a href=#__codelineno-5-136><span class=linenos data-linenos="136 "></span></a>        
</span><span id=__span-5-137><a id=__codelineno-5-137 name=__codelineno-5-137></a><a href=#__codelineno-5-137><span class=linenos data-linenos="137 "></span></a>        <span class=c1># Mark invitation as accepted</span>
</span><span id=__span-5-138><a id=__codelineno-5-138 name=__codelineno-5-138></a><a href=#__codelineno-5-138><span class=linenos data-linenos="138 "></span></a>        <span class=n>invitation</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=s2>&quot;accepted&quot;</span>
</span><span id=__span-5-139><a id=__codelineno-5-139 name=__codelineno-5-139></a><a href=#__codelineno-5-139><span class=linenos data-linenos="139 "></span></a>        <span class=n>invitation</span><span class=o>.</span><span class=n>accepted_at</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span>
</span><span id=__span-5-140><a id=__codelineno-5-140 name=__codelineno-5-140></a><a href=#__codelineno-5-140><span class=linenos data-linenos="140 "></span></a>        
</span><span id=__span-5-141><a id=__codelineno-5-141 name=__codelineno-5-141></a><a href=#__codelineno-5-141><span class=linenos data-linenos="141 "></span></a>        <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span><span id=__span-5-142><a id=__codelineno-5-142 name=__codelineno-5-142></a><a href=#__codelineno-5-142><span class=linenos data-linenos="142 "></span></a>        
</span><span id=__span-5-143><a id=__codelineno-5-143 name=__codelineno-5-143></a><a href=#__codelineno-5-143><span class=linenos data-linenos="143 "></span></a>        <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span><span class=n>success</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-5-144><a id=__codelineno-5-144 name=__codelineno-5-144></a><a href=#__codelineno-5-144><span class=linenos data-linenos="144 "></span></a>    
</span><span id=__span-5-145><a id=__codelineno-5-145 name=__codelineno-5-145></a><a href=#__codelineno-5-145><span class=linenos data-linenos="145 "></span></a>    <span class=nd>@classmethod</span>
</span><span id=__span-5-146><a id=__codelineno-5-146 name=__codelineno-5-146></a><a href=#__codelineno-5-146><span class=linenos data-linenos="146 "></span></a>    <span class=k>def</span> <span class=nf>send_bulk_invitations</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>admin_user</span><span class=p>:</span> <span class=n>User</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> 
</span><span id=__span-5-147><a id=__codelineno-5-147 name=__codelineno-5-147></a><a href=#__codelineno-5-147><span class=linenos data-linenos="147 "></span></a>                            <span class=n>emails</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span> <span class=n>role</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>InvitationResult</span><span class=p>]:</span>
</span><span id=__span-5-148><a id=__codelineno-5-148 name=__codelineno-5-148></a><a href=#__codelineno-5-148><span class=linenos data-linenos="148 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Bulk invitation sending for performance test&quot;&quot;&quot;</span>
</span><span id=__span-5-149><a id=__codelineno-5-149 name=__codelineno-5-149></a><a href=#__codelineno-5-149><span class=linenos data-linenos="149 "></span></a>        <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-5-150><a id=__codelineno-5-150 name=__codelineno-5-150></a><a href=#__codelineno-5-150><span class=linenos data-linenos="150 "></span></a>        <span class=k>for</span> <span class=n>email</span> <span class=ow>in</span> <span class=n>emails</span><span class=p>:</span>
</span><span id=__span-5-151><a id=__codelineno-5-151 name=__codelineno-5-151></a><a href=#__codelineno-5-151><span class=linenos data-linenos="151 "></span></a>            <span class=n>result</span> <span class=o>=</span> <span class=bp>cls</span><span class=o>.</span><span class=n>send_invitation</span><span class=p>(</span><span class=n>admin_user</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>,</span> <span class=n>email</span><span class=p>,</span> <span class=n>role</span><span class=p>)</span>
</span><span id=__span-5-152><a id=__codelineno-5-152 name=__codelineno-5-152></a><a href=#__codelineno-5-152><span class=linenos data-linenos="152 "></span></a>            <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span><span id=__span-5-153><a id=__codelineno-5-153 name=__codelineno-5-153></a><a href=#__codelineno-5-153><span class=linenos data-linenos="153 "></span></a>        <span class=k>return</span> <span class=n>results</span>
</span><span id=__span-5-154><a id=__codelineno-5-154 name=__codelineno-5-154></a><a href=#__codelineno-5-154><span class=linenos data-linenos="154 "></span></a>    
</span><span id=__span-5-155><a id=__codelineno-5-155 name=__codelineno-5-155></a><a href=#__codelineno-5-155><span class=linenos data-linenos="155 "></span></a>    <span class=c1># Helper methods to make tests pass</span>
</span><span id=__span-5-156><a id=__codelineno-5-156 name=__codelineno-5-156></a><a href=#__codelineno-5-156><span class=linenos data-linenos="156 "></span></a>    <span class=nd>@staticmethod</span>
</span><span id=__span-5-157><a id=__codelineno-5-157 name=__codelineno-5-157></a><a href=#__codelineno-5-157><span class=linenos data-linenos="157 "></span></a>    <span class=k>def</span> <span class=nf>_is_workspace_admin</span><span class=p>(</span><span class=n>user</span><span class=p>:</span> <span class=n>User</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span><span id=__span-5-158><a id=__codelineno-5-158 name=__codelineno-5-158></a><a href=#__codelineno-5-158><span class=linenos data-linenos="158 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Check if user is admin of workspace&quot;&quot;&quot;</span>
</span><span id=__span-5-159><a id=__codelineno-5-159 name=__codelineno-5-159></a><a href=#__codelineno-5-159><span class=linenos data-linenos="159 "></span></a>        <span class=k>return</span> <span class=n>user</span><span class=o>.</span><span class=n>role</span> <span class=o>==</span> <span class=s2>&quot;admin&quot;</span> <span class=ow>and</span> <span class=nb>str</span><span class=p>(</span><span class=n>user</span><span class=o>.</span><span class=n>workspace</span><span class=o>.</span><span class=n>id</span><span class=p>)</span> <span class=o>==</span> <span class=n>workspace_id</span>
</span><span id=__span-5-160><a id=__codelineno-5-160 name=__codelineno-5-160></a><a href=#__codelineno-5-160><span class=linenos data-linenos="160 "></span></a>    
</span><span id=__span-5-161><a id=__codelineno-5-161 name=__codelineno-5-161></a><a href=#__codelineno-5-161><span class=linenos data-linenos="161 "></span></a>    <span class=nd>@staticmethod</span>  
</span><span id=__span-5-162><a id=__codelineno-5-162 name=__codelineno-5-162></a><a href=#__codelineno-5-162><span class=linenos data-linenos="162 "></span></a>    <span class=k>def</span> <span class=nf>_is_valid_email</span><span class=p>(</span><span class=n>email</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span><span id=__span-5-163><a id=__codelineno-5-163 name=__codelineno-5-163></a><a href=#__codelineno-5-163><span class=linenos data-linenos="163 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Basic email validation&quot;&quot;&quot;</span>
</span><span id=__span-5-164><a id=__codelineno-5-164 name=__codelineno-5-164></a><a href=#__codelineno-5-164><span class=linenos data-linenos="164 "></span></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>email</span><span class=p>:</span>
</span><span id=__span-5-165><a id=__codelineno-5-165 name=__codelineno-5-165></a><a href=#__codelineno-5-165><span class=linenos data-linenos="165 "></span></a>            <span class=k>return</span> <span class=kc>False</span>
</span><span id=__span-5-166><a id=__codelineno-5-166 name=__codelineno-5-166></a><a href=#__codelineno-5-166><span class=linenos data-linenos="166 "></span></a>        <span class=n>pattern</span> <span class=o>=</span> <span class=sa>r</span><span class=s1>&#39;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$&#39;</span>
</span><span id=__span-5-167><a id=__codelineno-5-167 name=__codelineno-5-167></a><a href=#__codelineno-5-167><span class=linenos data-linenos="167 "></span></a>        <span class=k>return</span> <span class=n>re</span><span class=o>.</span><span class=n>match</span><span class=p>(</span><span class=n>pattern</span><span class=p>,</span> <span class=n>email</span><span class=p>)</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
</span><span id=__span-5-168><a id=__codelineno-5-168 name=__codelineno-5-168></a><a href=#__codelineno-5-168><span class=linenos data-linenos="168 "></span></a>    
</span><span id=__span-5-169><a id=__codelineno-5-169 name=__codelineno-5-169></a><a href=#__codelineno-5-169><span class=linenos data-linenos="169 "></span></a>    <span class=nd>@staticmethod</span>
</span><span id=__span-5-170><a id=__codelineno-5-170 name=__codelineno-5-170></a><a href=#__codelineno-5-170><span class=linenos data-linenos="170 "></span></a>    <span class=k>def</span> <span class=nf>_is_rate_limited</span><span class=p>(</span><span class=n>user</span><span class=p>:</span> <span class=n>User</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span><span id=__span-5-171><a id=__codelineno-5-171 name=__codelineno-5-171></a><a href=#__codelineno-5-171><span class=linenos data-linenos="171 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Check rate limiting&quot;&quot;&quot;</span>
</span><span id=__span-5-172><a id=__codelineno-5-172 name=__codelineno-5-172></a><a href=#__codelineno-5-172><span class=linenos data-linenos="172 "></span></a>        <span class=n>one_hour_ago</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span> <span class=o>-</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>hours</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-5-173><a id=__codelineno-5-173 name=__codelineno-5-173></a><a href=#__codelineno-5-173><span class=linenos data-linenos="173 "></span></a>        <span class=n>recent_invitations</span> <span class=o>=</span> <span class=n>Invitation</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span>
</span><span id=__span-5-174><a id=__codelineno-5-174 name=__codelineno-5-174></a><a href=#__codelineno-5-174><span class=linenos data-linenos="174 "></span></a>            <span class=n>Invitation</span><span class=o>.</span><span class=n>invited_by_id</span> <span class=o>==</span> <span class=n>user</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-5-175><a id=__codelineno-5-175 name=__codelineno-5-175></a><a href=#__codelineno-5-175><span class=linenos data-linenos="175 "></span></a>            <span class=n>Invitation</span><span class=o>.</span><span class=n>created_at</span> <span class=o>&gt;</span> <span class=n>one_hour_ago</span>
</span><span id=__span-5-176><a id=__codelineno-5-176 name=__codelineno-5-176></a><a href=#__codelineno-5-176><span class=linenos data-linenos="176 "></span></a>        <span class=p>)</span><span class=o>.</span><span class=n>count</span><span class=p>()</span>
</span><span id=__span-5-177><a id=__codelineno-5-177 name=__codelineno-5-177></a><a href=#__codelineno-5-177><span class=linenos data-linenos="177 "></span></a>        <span class=k>return</span> <span class=n>recent_invitations</span> <span class=o>&gt;=</span> <span class=n>InvitationService</span><span class=o>.</span><span class=n>MAX_INVITATIONS_PER_HOUR</span>
</span><span id=__span-5-178><a id=__codelineno-5-178 name=__codelineno-5-178></a><a href=#__codelineno-5-178><span class=linenos data-linenos="178 "></span></a>    
</span><span id=__span-5-179><a id=__codelineno-5-179 name=__codelineno-5-179></a><a href=#__codelineno-5-179><span class=linenos data-linenos="179 "></span></a>    <span class=nd>@staticmethod</span>
</span><span id=__span-5-180><a id=__codelineno-5-180 name=__codelineno-5-180></a><a href=#__codelineno-5-180><span class=linenos data-linenos="180 "></span></a>    <span class=k>def</span> <span class=nf>_find_existing_invitation</span><span class=p>(</span><span class=n>email</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Invitation</span><span class=p>]:</span>
</span><span id=__span-5-181><a id=__codelineno-5-181 name=__codelineno-5-181></a><a href=#__codelineno-5-181><span class=linenos data-linenos="181 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Find existing pending invitation&quot;&quot;&quot;</span>
</span><span id=__span-5-182><a id=__codelineno-5-182 name=__codelineno-5-182></a><a href=#__codelineno-5-182><span class=linenos data-linenos="182 "></span></a>        <span class=k>return</span> <span class=n>Invitation</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>filter_by</span><span class=p>(</span>
</span><span id=__span-5-183><a id=__codelineno-5-183 name=__codelineno-5-183></a><a href=#__codelineno-5-183><span class=linenos data-linenos="183 "></span></a>            <span class=n>email</span><span class=o>=</span><span class=n>email</span><span class=p>,</span>
</span><span id=__span-5-184><a id=__codelineno-5-184 name=__codelineno-5-184></a><a href=#__codelineno-5-184><span class=linenos data-linenos="184 "></span></a>            <span class=n>workspace_id</span><span class=o>=</span><span class=n>workspace_id</span><span class=p>,</span>
</span><span id=__span-5-185><a id=__codelineno-5-185 name=__codelineno-5-185></a><a href=#__codelineno-5-185><span class=linenos data-linenos="185 "></span></a>            <span class=n>status</span><span class=o>=</span><span class=s2>&quot;pending&quot;</span>
</span><span id=__span-5-186><a id=__codelineno-5-186 name=__codelineno-5-186></a><a href=#__codelineno-5-186><span class=linenos data-linenos="186 "></span></a>        <span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</span><span id=__span-5-187><a id=__codelineno-5-187 name=__codelineno-5-187></a><a href=#__codelineno-5-187><span class=linenos data-linenos="187 "></span></a>    
</span><span id=__span-5-188><a id=__codelineno-5-188 name=__codelineno-5-188></a><a href=#__codelineno-5-188><span class=linenos data-linenos="188 "></span></a>    <span class=nd>@staticmethod</span>
</span><span id=__span-5-189><a id=__codelineno-5-189 name=__codelineno-5-189></a><a href=#__codelineno-5-189><span class=linenos data-linenos="189 "></span></a>    <span class=k>def</span> <span class=nf>_generate_token</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span><span id=__span-5-190><a id=__codelineno-5-190 name=__codelineno-5-190></a><a href=#__codelineno-5-190><span class=linenos data-linenos="190 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Generate secure token&quot;&quot;&quot;</span>
</span><span id=__span-5-191><a id=__codelineno-5-191 name=__codelineno-5-191></a><a href=#__codelineno-5-191><span class=linenos data-linenos="191 "></span></a>        <span class=k>return</span> <span class=n>secrets</span><span class=o>.</span><span class=n>token_urlsafe</span><span class=p>(</span><span class=mi>32</span><span class=p>)</span>
</span><span id=__span-5-192><a id=__codelineno-5-192 name=__codelineno-5-192></a><a href=#__codelineno-5-192><span class=linenos data-linenos="192 "></span></a>    
</span><span id=__span-5-193><a id=__codelineno-5-193 name=__codelineno-5-193></a><a href=#__codelineno-5-193><span class=linenos data-linenos="193 "></span></a>    <span class=nd>@staticmethod</span>  
</span><span id=__span-5-194><a id=__codelineno-5-194 name=__codelineno-5-194></a><a href=#__codelineno-5-194><span class=linenos data-linenos="194 "></span></a>    <span class=k>def</span> <span class=nf>_hash_password</span><span class=p>(</span><span class=n>password</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span><span id=__span-5-195><a id=__codelineno-5-195 name=__codelineno-5-195></a><a href=#__codelineno-5-195><span class=linenos data-linenos="195 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Hash password for new user&quot;&quot;&quot;</span>
</span><span id=__span-5-196><a id=__codelineno-5-196 name=__codelineno-5-196></a><a href=#__codelineno-5-196><span class=linenos data-linenos="196 "></span></a>        <span class=kn>import</span> <span class=nn>bcrypt</span>
</span><span id=__span-5-197><a id=__codelineno-5-197 name=__codelineno-5-197></a><a href=#__codelineno-5-197><span class=linenos data-linenos="197 "></span></a>        <span class=k>return</span> <span class=n>bcrypt</span><span class=o>.</span><span class=n>hashpw</span><span class=p>(</span><span class=n>password</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>),</span> <span class=n>bcrypt</span><span class=o>.</span><span class=n>gensalt</span><span class=p>())</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
</span><span id=__span-5-198><a id=__codelineno-5-198 name=__codelineno-5-198></a><a href=#__codelineno-5-198><span class=linenos data-linenos="198 "></span></a>    
</span><span id=__span-5-199><a id=__codelineno-5-199 name=__codelineno-5-199></a><a href=#__codelineno-5-199><span class=linenos data-linenos="199 "></span></a>    <span class=nd>@staticmethod</span>
</span><span id=__span-5-200><a id=__codelineno-5-200 name=__codelineno-5-200></a><a href=#__codelineno-5-200><span class=linenos data-linenos="200 "></span></a>    <span class=k>def</span> <span class=nf>_send_invitation_email</span><span class=p>(</span><span class=n>invitation</span><span class=p>:</span> <span class=n>Invitation</span><span class=p>,</span> <span class=n>admin_user</span><span class=p>:</span> <span class=n>User</span><span class=p>):</span>
</span><span id=__span-5-201><a id=__codelineno-5-201 name=__codelineno-5-201></a><a href=#__codelineno-5-201><span class=linenos data-linenos="201 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Send invitation email&quot;&quot;&quot;</span>
</span><span id=__span-5-202><a id=__codelineno-5-202 name=__codelineno-5-202></a><a href=#__codelineno-5-202><span class=linenos data-linenos="202 "></span></a>        <span class=n>invitation_url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>current_app</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;BASE_URL&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>/invitations/accept/</span><span class=si>{</span><span class=n>invitation</span><span class=o>.</span><span class=n>token</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-5-203><a id=__codelineno-5-203 name=__codelineno-5-203></a><a href=#__codelineno-5-203><span class=linenos data-linenos="203 "></span></a>        
</span><span id=__span-5-204><a id=__codelineno-5-204 name=__codelineno-5-204></a><a href=#__codelineno-5-204><span class=linenos data-linenos="204 "></span></a>        <span class=n>send_invitation_email</span><span class=p>(</span>
</span><span id=__span-5-205><a id=__codelineno-5-205 name=__codelineno-5-205></a><a href=#__codelineno-5-205><span class=linenos data-linenos="205 "></span></a>            <span class=n>to_email</span><span class=o>=</span><span class=n>invitation</span><span class=o>.</span><span class=n>email</span><span class=p>,</span>
</span><span id=__span-5-206><a id=__codelineno-5-206 name=__codelineno-5-206></a><a href=#__codelineno-5-206><span class=linenos data-linenos="206 "></span></a>            <span class=n>template</span><span class=o>=</span><span class=s2>&quot;team_invitation&quot;</span><span class=p>,</span>
</span><span id=__span-5-207><a id=__codelineno-5-207 name=__codelineno-5-207></a><a href=#__codelineno-5-207><span class=linenos data-linenos="207 "></span></a>            <span class=n>context</span><span class=o>=</span><span class=p>{</span>
</span><span id=__span-5-208><a id=__codelineno-5-208 name=__codelineno-5-208></a><a href=#__codelineno-5-208><span class=linenos data-linenos="208 "></span></a>                <span class=s1>&#39;workspace_name&#39;</span><span class=p>:</span> <span class=n>admin_user</span><span class=o>.</span><span class=n>workspace</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
</span><span id=__span-5-209><a id=__codelineno-5-209 name=__codelineno-5-209></a><a href=#__codelineno-5-209><span class=linenos data-linenos="209 "></span></a>                <span class=s1>&#39;admin_name&#39;</span><span class=p>:</span> <span class=n>admin_user</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
</span><span id=__span-5-210><a id=__codelineno-5-210 name=__codelineno-5-210></a><a href=#__codelineno-5-210><span class=linenos data-linenos="210 "></span></a>                <span class=s1>&#39;role&#39;</span><span class=p>:</span> <span class=n>invitation</span><span class=o>.</span><span class=n>role</span><span class=p>,</span>
</span><span id=__span-5-211><a id=__codelineno-5-211 name=__codelineno-5-211></a><a href=#__codelineno-5-211><span class=linenos data-linenos="211 "></span></a>                <span class=s1>&#39;message&#39;</span><span class=p>:</span> <span class=n>invitation</span><span class=o>.</span><span class=n>message</span><span class=p>,</span>
</span><span id=__span-5-212><a id=__codelineno-5-212 name=__codelineno-5-212></a><a href=#__codelineno-5-212><span class=linenos data-linenos="212 "></span></a>                <span class=s1>&#39;invitation_url&#39;</span><span class=p>:</span> <span class=n>invitation_url</span>
</span><span id=__span-5-213><a id=__codelineno-5-213 name=__codelineno-5-213></a><a href=#__codelineno-5-213><span class=linenos data-linenos="213 "></span></a>            <span class=p>}</span>
</span><span id=__span-5-214><a id=__codelineno-5-214 name=__codelineno-5-214></a><a href=#__codelineno-5-214><span class=linenos data-linenos="214 "></span></a>        <span class=p>)</span>
</span></code></pre></div><p><strong>⏰ 10:15 AM - The Moment of Truth</strong></p><p>The Code Agent has spent 35 minutes building what looks like a complete invitation system. But here's the beautiful part—it's not trying to be perfect. It's trying to be <em>correct</em>. Every line of code exists for one reason: to make a failing test pass.</p><p><strong>🎊 The Magic Moment - All Tests Pass!</strong></p><div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1></a><a href=#__codelineno-6-1><span class=linenos data-linenos=" 1 "></span></a>$<span class=w> </span>pytest<span class=w> </span>tests/test_team_invitations.py<span class=w> </span>-v
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2></a><a href=#__codelineno-6-2><span class=linenos data-linenos=" 2 "></span></a><span class=o>==================</span><span class=w> </span><span class=nb>test</span><span class=w> </span>session<span class=w> </span><span class=nv>starts</span><span class=w> </span><span class=o>==================</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3></a><a href=#__codelineno-6-3><span class=linenos data-linenos=" 3 "></span></a>tests/test_team_invitations.py::TestTeamInvitationFeature::test_admin_can_invite_new_team_member<span class=w> </span>PASSED
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4></a><a href=#__codelineno-6-4><span class=linenos data-linenos=" 4 "></span></a>tests/test_team_invitations.py::TestTeamInvitationFeature::test_invited_user_can_accept_valid_invitation<span class=w> </span>PASSED
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5></a><a href=#__codelineno-6-5><span class=linenos data-linenos=" 5 "></span></a>tests/test_team_invitations.py::TestTeamInvitationFeature::test_cannot_invite_to_workspace_without_admin_role<span class=w> </span>PASSED
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6></a><a href=#__codelineno-6-6><span class=linenos data-linenos=" 6 "></span></a>tests/test_team_invitations.py::TestTeamInvitationFeature::test_cannot_accept_expired_invitation<span class=w> </span>PASSED
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7></a><a href=#__codelineno-6-7><span class=linenos data-linenos=" 7 "></span></a>tests/test_team_invitations.py::TestTeamInvitationFeature::test_rate_limiting_prevents_spam_invitations<span class=w> </span>PASSED
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8></a><a href=#__codelineno-6-8><span class=linenos data-linenos=" 8 "></span></a>tests/test_team_invitations.py::TestTeamInvitationFeature::test_duplicate_invitation_updates_existing<span class=w> </span>PASSED
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9></a><a href=#__codelineno-6-9><span class=linenos data-linenos=" 9 "></span></a>tests/test_team_invitations.py::TestTeamInvitationFeature::test_malformed_email_addresses_rejected<span class=w> </span>PASSED
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10></a><a href=#__codelineno-6-10><span class=linenos data-linenos="10 "></span></a>tests/test_team_invitations.py::TestTeamInvitationFeature::test_invitation_email_sent_with_correct_data<span class=w> </span>PASSED
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11></a><a href=#__codelineno-6-11><span class=linenos data-linenos="11 "></span></a>tests/test_team_invitations.py::TestTeamInvitationFeature::test_bulk_invitation_performance<span class=w> </span>PASSED
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12></a><a href=#__codelineno-6-12><span class=linenos data-linenos="12 "></span></a>...
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13></a><a href=#__codelineno-6-13><span class=linenos data-linenos="13 "></span></a><span class=o>==================</span><span class=w> </span><span class=m>47</span><span class=w> </span>passed<span class=w> </span><span class=k>in</span><span class=w> </span><span class=m>2</span>.34s<span class=w> </span><span class=o>==================</span>
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14></a><a href=#__codelineno-6-14><span class=linenos data-linenos="14 "></span></a>
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15></a><a href=#__codelineno-6-15><span class=linenos data-linenos="15 "></span></a>Coverage<span class=w> </span>Report:
</span><span id=__span-6-16><a id=__codelineno-6-16 name=__codelineno-6-16></a><a href=#__codelineno-6-16><span class=linenos data-linenos="16 "></span></a>Name<span class=w>                    </span>Stmts<span class=w>   </span>Miss<span class=w>  </span>Cover
</span><span id=__span-6-17><a id=__codelineno-6-17 name=__codelineno-6-17></a><a href=#__codelineno-6-17><span class=linenos data-linenos="17 "></span></a>------------------------------------------
</span><span id=__span-6-18><a id=__codelineno-6-18 name=__codelineno-6-18></a><a href=#__codelineno-6-18><span class=linenos data-linenos="18 "></span></a>app/invitations.py<span class=w>        </span><span class=m>156</span><span class=w>      </span><span class=m>0</span><span class=w>   </span><span class=m>100</span>%
</span></code></pre></div><p><strong>🎉 You did it!</strong> In just 35 minutes, you've gone from 0 to 47 passing tests with 100% coverage. But we're not done yet—now comes the artistry.</p><h3 id=the-refactor-phase-from-working-to-beautiful-1030-am>🔵 The Refactor Phase: From Working to Beautiful (10:30 AM)<a class=headerlink href=#the-refactor-phase-from-working-to-beautiful-1030-am title="Permanent link">&para;</a></h3><p>The Code Agent looks at the working implementation and thinks: <em>"This code works, but it's not beautiful. I can make it more maintainable, more readable, and more elegant—all while keeping every single test green."</em></p><p>This is where the magic of TDD really shines. Because you have a comprehensive test suite, you can refactor with confidence. You're not guessing whether your changes broke something—the tests will tell you instantly.</p><h4 id=the-refactored-masterpiece>✨ The Refactored Masterpiece<a class=headerlink href=#the-refactored-masterpiece title="Permanent link">&para;</a></h4><div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1></a><a href=#__codelineno-7-1><span class=linenos data-linenos="  1 "></span></a><span class=c1># Generated by Code Agent - Refactored Beauty (10:30-11:00 AM)</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2></a><a href=#__codelineno-7-2><span class=linenos data-linenos="  2 "></span></a><span class=c1># app/invitations.py</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3></a><a href=#__codelineno-7-3><span class=linenos data-linenos="  3 "></span></a><span class=kn>from</span> <span class=nn>abc</span> <span class=kn>import</span> <span class=n>ABC</span><span class=p>,</span> <span class=n>abstractmethod</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4></a><a href=#__codelineno-7-4><span class=linenos data-linenos="  4 "></span></a><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span><span class=p>,</span> <span class=n>field</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5></a><a href=#__codelineno-7-5><span class=linenos data-linenos="  5 "></span></a><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6></a><a href=#__codelineno-7-6><span class=linenos data-linenos="  6 "></span></a><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7></a><a href=#__codelineno-7-7><span class=linenos data-linenos="  7 "></span></a><span class=kn>from</span> <span class=nn>enum</span> <span class=kn>import</span> <span class=n>Enum</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8></a><a href=#__codelineno-7-8><span class=linenos data-linenos="  8 "></span></a><span class=kn>import</span> <span class=nn>secrets</span>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9></a><a href=#__codelineno-7-9><span class=linenos data-linenos="  9 "></span></a><span class=kn>import</span> <span class=nn>logging</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10></a><a href=#__codelineno-7-10><span class=linenos data-linenos=" 10 "></span></a><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>contextmanager</span>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11></a><a href=#__codelineno-7-11><span class=linenos data-linenos=" 11 "></span></a>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12></a><a href=#__codelineno-7-12><span class=linenos data-linenos=" 12 "></span></a><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>current_app</span>
</span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13></a><a href=#__codelineno-7-13><span class=linenos data-linenos=" 13 "></span></a><span class=kn>from</span> <span class=nn>sqlalchemy.exc</span> <span class=kn>import</span> <span class=n>IntegrityError</span>
</span><span id=__span-7-14><a id=__codelineno-7-14 name=__codelineno-7-14></a><a href=#__codelineno-7-14><span class=linenos data-linenos=" 14 "></span></a><span class=kn>from</span> <span class=nn>app.models</span> <span class=kn>import</span> <span class=n>User</span><span class=p>,</span> <span class=n>Workspace</span><span class=p>,</span> <span class=n>Invitation</span><span class=p>,</span> <span class=n>db</span>
</span><span id=__span-7-15><a id=__codelineno-7-15 name=__codelineno-7-15></a><a href=#__codelineno-7-15><span class=linenos data-linenos=" 15 "></span></a><span class=kn>from</span> <span class=nn>app.email</span> <span class=kn>import</span> <span class=n>EmailService</span>
</span><span id=__span-7-16><a id=__codelineno-7-16 name=__codelineno-7-16></a><a href=#__codelineno-7-16><span class=linenos data-linenos=" 16 "></span></a><span class=kn>from</span> <span class=nn>app.utils.validators</span> <span class=kn>import</span> <span class=n>EmailValidator</span>
</span><span id=__span-7-17><a id=__codelineno-7-17 name=__codelineno-7-17></a><a href=#__codelineno-7-17><span class=linenos data-linenos=" 17 "></span></a><span class=kn>from</span> <span class=nn>app.utils.security</span> <span class=kn>import</span> <span class=n>TokenGenerator</span>
</span><span id=__span-7-18><a id=__codelineno-7-18 name=__codelineno-7-18></a><a href=#__codelineno-7-18><span class=linenos data-linenos=" 18 "></span></a><span class=kn>from</span> <span class=nn>app.utils.rate_limiter</span> <span class=kn>import</span> <span class=n>RateLimiter</span>
</span><span id=__span-7-19><a id=__codelineno-7-19 name=__codelineno-7-19></a><a href=#__codelineno-7-19><span class=linenos data-linenos=" 19 "></span></a><span class=kn>from</span> <span class=nn>app.exceptions</span> <span class=kn>import</span> <span class=p>(</span>
</span><span id=__span-7-20><a id=__codelineno-7-20 name=__codelineno-7-20></a><a href=#__codelineno-7-20><span class=linenos data-linenos=" 20 "></span></a>    <span class=n>InvitationError</span><span class=p>,</span> <span class=ne>PermissionError</span><span class=p>,</span> <span class=n>ValidationError</span><span class=p>,</span>
</span><span id=__span-7-21><a id=__codelineno-7-21 name=__codelineno-7-21></a><a href=#__codelineno-7-21><span class=linenos data-linenos=" 21 "></span></a>    <span class=n>RateLimitError</span><span class=p>,</span> <span class=n>ExpiredInvitationError</span>
</span><span id=__span-7-22><a id=__codelineno-7-22 name=__codelineno-7-22></a><a href=#__codelineno-7-22><span class=linenos data-linenos=" 22 "></span></a><span class=p>)</span>
</span><span id=__span-7-23><a id=__codelineno-7-23 name=__codelineno-7-23></a><a href=#__codelineno-7-23><span class=linenos data-linenos=" 23 "></span></a>
</span><span id=__span-7-24><a id=__codelineno-7-24 name=__codelineno-7-24></a><a href=#__codelineno-7-24><span class=linenos data-linenos=" 24 "></span></a><span class=k>class</span> <span class=nc>InvitationStatus</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span><span id=__span-7-25><a id=__codelineno-7-25 name=__codelineno-7-25></a><a href=#__codelineno-7-25><span class=linenos data-linenos=" 25 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Enum for invitation statuses&quot;&quot;&quot;</span>
</span><span id=__span-7-26><a id=__codelineno-7-26 name=__codelineno-7-26></a><a href=#__codelineno-7-26><span class=linenos data-linenos=" 26 "></span></a>    <span class=n>PENDING</span> <span class=o>=</span> <span class=s2>&quot;pending&quot;</span>
</span><span id=__span-7-27><a id=__codelineno-7-27 name=__codelineno-7-27></a><a href=#__codelineno-7-27><span class=linenos data-linenos=" 27 "></span></a>    <span class=n>ACCEPTED</span> <span class=o>=</span> <span class=s2>&quot;accepted&quot;</span>
</span><span id=__span-7-28><a id=__codelineno-7-28 name=__codelineno-7-28></a><a href=#__codelineno-7-28><span class=linenos data-linenos=" 28 "></span></a>    <span class=n>EXPIRED</span> <span class=o>=</span> <span class=s2>&quot;expired&quot;</span>
</span><span id=__span-7-29><a id=__codelineno-7-29 name=__codelineno-7-29></a><a href=#__codelineno-7-29><span class=linenos data-linenos=" 29 "></span></a>    <span class=n>REVOKED</span> <span class=o>=</span> <span class=s2>&quot;revoked&quot;</span>
</span><span id=__span-7-30><a id=__codelineno-7-30 name=__codelineno-7-30></a><a href=#__codelineno-7-30><span class=linenos data-linenos=" 30 "></span></a>
</span><span id=__span-7-31><a id=__codelineno-7-31 name=__codelineno-7-31></a><a href=#__codelineno-7-31><span class=linenos data-linenos=" 31 "></span></a><span class=k>class</span> <span class=nc>UserRole</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span><span id=__span-7-32><a id=__codelineno-7-32 name=__codelineno-7-32></a><a href=#__codelineno-7-32><span class=linenos data-linenos=" 32 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Enum for user roles with permission levels&quot;&quot;&quot;</span>
</span><span id=__span-7-33><a id=__codelineno-7-33 name=__codelineno-7-33></a><a href=#__codelineno-7-33><span class=linenos data-linenos=" 33 "></span></a>    <span class=n>ADMIN</span> <span class=o>=</span> <span class=p>(</span><span class=s2>&quot;admin&quot;</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>
</span><span id=__span-7-34><a id=__codelineno-7-34 name=__codelineno-7-34></a><a href=#__codelineno-7-34><span class=linenos data-linenos=" 34 "></span></a>    <span class=n>EDITOR</span> <span class=o>=</span> <span class=p>(</span><span class=s2>&quot;editor&quot;</span><span class=p>,</span> <span class=mi>50</span><span class=p>)</span>
</span><span id=__span-7-35><a id=__codelineno-7-35 name=__codelineno-7-35></a><a href=#__codelineno-7-35><span class=linenos data-linenos=" 35 "></span></a>    <span class=n>VIEWER</span> <span class=o>=</span> <span class=p>(</span><span class=s2>&quot;viewer&quot;</span><span class=p>,</span> <span class=mi>25</span><span class=p>)</span>
</span><span id=__span-7-36><a id=__codelineno-7-36 name=__codelineno-7-36></a><a href=#__codelineno-7-36><span class=linenos data-linenos=" 36 "></span></a>    <span class=n>GUEST</span> <span class=o>=</span> <span class=p>(</span><span class=s2>&quot;guest&quot;</span><span class=p>,</span> <span class=mi>10</span><span class=p>)</span>
</span><span id=__span-7-37><a id=__codelineno-7-37 name=__codelineno-7-37></a><a href=#__codelineno-7-37><span class=linenos data-linenos=" 37 "></span></a>    
</span><span id=__span-7-38><a id=__codelineno-7-38 name=__codelineno-7-38></a><a href=#__codelineno-7-38><span class=linenos data-linenos=" 38 "></span></a>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>role_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>permission_level</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span><span id=__span-7-39><a id=__codelineno-7-39 name=__codelineno-7-39></a><a href=#__codelineno-7-39><span class=linenos data-linenos=" 39 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>role_name</span> <span class=o>=</span> <span class=n>role_name</span>
</span><span id=__span-7-40><a id=__codelineno-7-40 name=__codelineno-7-40></a><a href=#__codelineno-7-40><span class=linenos data-linenos=" 40 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>permission_level</span> <span class=o>=</span> <span class=n>permission_level</span>
</span><span id=__span-7-41><a id=__codelineno-7-41 name=__codelineno-7-41></a><a href=#__codelineno-7-41><span class=linenos data-linenos=" 41 "></span></a>    
</span><span id=__span-7-42><a id=__codelineno-7-42 name=__codelineno-7-42></a><a href=#__codelineno-7-42><span class=linenos data-linenos=" 42 "></span></a>    <span class=k>def</span> <span class=nf>can_invite_role</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>target_role</span><span class=p>:</span> <span class=s1>&#39;UserRole&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span><span id=__span-7-43><a id=__codelineno-7-43 name=__codelineno-7-43></a><a href=#__codelineno-7-43><span class=linenos data-linenos=" 43 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Check if this role can invite users with target role&quot;&quot;&quot;</span>
</span><span id=__span-7-44><a id=__codelineno-7-44 name=__codelineno-7-44></a><a href=#__codelineno-7-44><span class=linenos data-linenos=" 44 "></span></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>permission_level</span> <span class=o>&gt;=</span> <span class=n>target_role</span><span class=o>.</span><span class=n>permission_level</span>
</span><span id=__span-7-45><a id=__codelineno-7-45 name=__codelineno-7-45></a><a href=#__codelineno-7-45><span class=linenos data-linenos=" 45 "></span></a>
</span><span id=__span-7-46><a id=__codelineno-7-46 name=__codelineno-7-46></a><a href=#__codelineno-7-46><span class=linenos data-linenos=" 46 "></span></a><span class=nd>@dataclass</span>
</span><span id=__span-7-47><a id=__codelineno-7-47 name=__codelineno-7-47></a><a href=#__codelineno-7-47><span class=linenos data-linenos=" 47 "></span></a><span class=k>class</span> <span class=nc>InvitationResult</span><span class=p>:</span>
</span><span id=__span-7-48><a id=__codelineno-7-48 name=__codelineno-7-48></a><a href=#__codelineno-7-48><span class=linenos data-linenos=" 48 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Rich result object with metadata and debugging info&quot;&quot;&quot;</span>
</span><span id=__span-7-49><a id=__codelineno-7-49 name=__codelineno-7-49></a><a href=#__codelineno-7-49><span class=linenos data-linenos=" 49 "></span></a>    <span class=n>success</span><span class=p>:</span> <span class=nb>bool</span>
</span><span id=__span-7-50><a id=__codelineno-7-50 name=__codelineno-7-50></a><a href=#__codelineno-7-50><span class=linenos data-linenos=" 50 "></span></a>    <span class=n>invitation_id</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-7-51><a id=__codelineno-7-51 name=__codelineno-7-51></a><a href=#__codelineno-7-51><span class=linenos data-linenos=" 51 "></span></a>    <span class=n>expires_at</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>datetime</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-7-52><a id=__codelineno-7-52 name=__codelineno-7-52></a><a href=#__codelineno-7-52><span class=linenos data-linenos=" 52 "></span></a>    <span class=n>error</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-7-53><a id=__codelineno-7-53 name=__codelineno-7-53></a><a href=#__codelineno-7-53><span class=linenos data-linenos=" 53 "></span></a>    <span class=n>code</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-7-54><a id=__codelineno-7-54 name=__codelineno-7-54></a><a href=#__codelineno-7-54><span class=linenos data-linenos=" 54 "></span></a>    <span class=n>created_at</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>datetime</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-7-55><a id=__codelineno-7-55 name=__codelineno-7-55></a><a href=#__codelineno-7-55><span class=linenos data-linenos=" 55 "></span></a>    <span class=n>metadata</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=n>field</span><span class=p>(</span><span class=n>default_factory</span><span class=o>=</span><span class=nb>dict</span><span class=p>)</span>
</span><span id=__span-7-56><a id=__codelineno-7-56 name=__codelineno-7-56></a><a href=#__codelineno-7-56><span class=linenos data-linenos=" 56 "></span></a>
</span><span id=__span-7-57><a id=__codelineno-7-57 name=__codelineno-7-57></a><a href=#__codelineno-7-57><span class=linenos data-linenos=" 57 "></span></a><span class=k>class</span> <span class=nc>InvitationStrategy</span><span class=p>(</span><span class=n>ABC</span><span class=p>):</span>
</span><span id=__span-7-58><a id=__codelineno-7-58 name=__codelineno-7-58></a><a href=#__codelineno-7-58><span class=linenos data-linenos=" 58 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Strategy pattern for different invitation types&quot;&quot;&quot;</span>
</span><span id=__span-7-59><a id=__codelineno-7-59 name=__codelineno-7-59></a><a href=#__codelineno-7-59><span class=linenos data-linenos=" 59 "></span></a>    
</span><span id=__span-7-60><a id=__codelineno-7-60 name=__codelineno-7-60></a><a href=#__codelineno-7-60><span class=linenos data-linenos=" 60 "></span></a>    <span class=nd>@abstractmethod</span>
</span><span id=__span-7-61><a id=__codelineno-7-61 name=__codelineno-7-61></a><a href=#__codelineno-7-61><span class=linenos data-linenos=" 61 "></span></a>    <span class=k>def</span> <span class=nf>validate</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>invitation_data</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span><span id=__span-7-62><a id=__codelineno-7-62 name=__codelineno-7-62></a><a href=#__codelineno-7-62><span class=linenos data-linenos=" 62 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Validate invitation data for this strategy&quot;&quot;&quot;</span>
</span><span id=__span-7-63><a id=__codelineno-7-63 name=__codelineno-7-63></a><a href=#__codelineno-7-63><span class=linenos data-linenos=" 63 "></span></a>        <span class=k>pass</span>
</span><span id=__span-7-64><a id=__codelineno-7-64 name=__codelineno-7-64></a><a href=#__codelineno-7-64><span class=linenos data-linenos=" 64 "></span></a>    
</span><span id=__span-7-65><a id=__codelineno-7-65 name=__codelineno-7-65></a><a href=#__codelineno-7-65><span class=linenos data-linenos=" 65 "></span></a>    <span class=nd>@abstractmethod</span>
</span><span id=__span-7-66><a id=__codelineno-7-66 name=__codelineno-7-66></a><a href=#__codelineno-7-66><span class=linenos data-linenos=" 66 "></span></a>    <span class=k>def</span> <span class=nf>create_invitation</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>invitation_data</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Invitation</span><span class=p>:</span>
</span><span id=__span-7-67><a id=__codelineno-7-67 name=__codelineno-7-67></a><a href=#__codelineno-7-67><span class=linenos data-linenos=" 67 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Create invitation using this strategy&quot;&quot;&quot;</span>
</span><span id=__span-7-68><a id=__codelineno-7-68 name=__codelineno-7-68></a><a href=#__codelineno-7-68><span class=linenos data-linenos=" 68 "></span></a>        <span class=k>pass</span>
</span><span id=__span-7-69><a id=__codelineno-7-69 name=__codelineno-7-69></a><a href=#__codelineno-7-69><span class=linenos data-linenos=" 69 "></span></a>
</span><span id=__span-7-70><a id=__codelineno-7-70 name=__codelineno-7-70></a><a href=#__codelineno-7-70><span class=linenos data-linenos=" 70 "></span></a><span class=k>class</span> <span class=nc>StandardInvitationStrategy</span><span class=p>(</span><span class=n>InvitationStrategy</span><span class=p>):</span>
</span><span id=__span-7-71><a id=__codelineno-7-71 name=__codelineno-7-71></a><a href=#__codelineno-7-71><span class=linenos data-linenos=" 71 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Standard email-based invitation strategy&quot;&quot;&quot;</span>
</span><span id=__span-7-72><a id=__codelineno-7-72 name=__codelineno-7-72></a><a href=#__codelineno-7-72><span class=linenos data-linenos=" 72 "></span></a>    
</span><span id=__span-7-73><a id=__codelineno-7-73 name=__codelineno-7-73></a><a href=#__codelineno-7-73><span class=linenos data-linenos=" 73 "></span></a>    <span class=k>def</span> <span class=nf>validate</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>invitation_data</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span><span id=__span-7-74><a id=__codelineno-7-74 name=__codelineno-7-74></a><a href=#__codelineno-7-74><span class=linenos data-linenos=" 74 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Validate standard invitation data&quot;&quot;&quot;</span>
</span><span id=__span-7-75><a id=__codelineno-7-75 name=__codelineno-7-75></a><a href=#__codelineno-7-75><span class=linenos data-linenos=" 75 "></span></a>        <span class=k>return</span> <span class=p>(</span>
</span><span id=__span-7-76><a id=__codelineno-7-76 name=__codelineno-7-76></a><a href=#__codelineno-7-76><span class=linenos data-linenos=" 76 "></span></a>            <span class=n>EmailValidator</span><span class=o>.</span><span class=n>is_valid</span><span class=p>(</span><span class=n>invitation_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;email&#39;</span><span class=p>))</span> <span class=ow>and</span>
</span><span id=__span-7-77><a id=__codelineno-7-77 name=__codelineno-7-77></a><a href=#__codelineno-7-77><span class=linenos data-linenos=" 77 "></span></a>            <span class=n>invitation_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;role&#39;</span><span class=p>)</span> <span class=ow>in</span> <span class=p>[</span><span class=n>r</span><span class=o>.</span><span class=n>role_name</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>UserRole</span><span class=p>]</span>
</span><span id=__span-7-78><a id=__codelineno-7-78 name=__codelineno-7-78></a><a href=#__codelineno-7-78><span class=linenos data-linenos=" 78 "></span></a>        <span class=p>)</span>
</span><span id=__span-7-79><a id=__codelineno-7-79 name=__codelineno-7-79></a><a href=#__codelineno-7-79><span class=linenos data-linenos=" 79 "></span></a>    
</span><span id=__span-7-80><a id=__codelineno-7-80 name=__codelineno-7-80></a><a href=#__codelineno-7-80><span class=linenos data-linenos=" 80 "></span></a>    <span class=k>def</span> <span class=nf>create_invitation</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>invitation_data</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Invitation</span><span class=p>:</span>
</span><span id=__span-7-81><a id=__codelineno-7-81 name=__codelineno-7-81></a><a href=#__codelineno-7-81><span class=linenos data-linenos=" 81 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Create standard invitation&quot;&quot;&quot;</span>
</span><span id=__span-7-82><a id=__codelineno-7-82 name=__codelineno-7-82></a><a href=#__codelineno-7-82><span class=linenos data-linenos=" 82 "></span></a>        <span class=k>return</span> <span class=n>Invitation</span><span class=p>(</span>
</span><span id=__span-7-83><a id=__codelineno-7-83 name=__codelineno-7-83></a><a href=#__codelineno-7-83><span class=linenos data-linenos=" 83 "></span></a>            <span class=n>email</span><span class=o>=</span><span class=n>invitation_data</span><span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>],</span>
</span><span id=__span-7-84><a id=__codelineno-7-84 name=__codelineno-7-84></a><a href=#__codelineno-7-84><span class=linenos data-linenos=" 84 "></span></a>            <span class=n>role</span><span class=o>=</span><span class=n>invitation_data</span><span class=p>[</span><span class=s1>&#39;role&#39;</span><span class=p>],</span>
</span><span id=__span-7-85><a id=__codelineno-7-85 name=__codelineno-7-85></a><a href=#__codelineno-7-85><span class=linenos data-linenos=" 85 "></span></a>            <span class=n>message</span><span class=o>=</span><span class=n>invitation_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;message&#39;</span><span class=p>),</span>
</span><span id=__span-7-86><a id=__codelineno-7-86 name=__codelineno-7-86></a><a href=#__codelineno-7-86><span class=linenos data-linenos=" 86 "></span></a>            <span class=n>workspace_id</span><span class=o>=</span><span class=n>invitation_data</span><span class=p>[</span><span class=s1>&#39;workspace_id&#39;</span><span class=p>],</span>
</span><span id=__span-7-87><a id=__codelineno-7-87 name=__codelineno-7-87></a><a href=#__codelineno-7-87><span class=linenos data-linenos=" 87 "></span></a>            <span class=n>invited_by_id</span><span class=o>=</span><span class=n>invitation_data</span><span class=p>[</span><span class=s1>&#39;admin_user_id&#39;</span><span class=p>],</span>
</span><span id=__span-7-88><a id=__codelineno-7-88 name=__codelineno-7-88></a><a href=#__codelineno-7-88><span class=linenos data-linenos=" 88 "></span></a>            <span class=n>token</span><span class=o>=</span><span class=n>TokenGenerator</span><span class=o>.</span><span class=n>generate_secure_token</span><span class=p>(),</span>
</span><span id=__span-7-89><a id=__codelineno-7-89 name=__codelineno-7-89></a><a href=#__codelineno-7-89><span class=linenos data-linenos=" 89 "></span></a>            <span class=n>status</span><span class=o>=</span><span class=n>InvitationStatus</span><span class=o>.</span><span class=n>PENDING</span><span class=o>.</span><span class=n>value</span><span class=p>,</span>
</span><span id=__span-7-90><a id=__codelineno-7-90 name=__codelineno-7-90></a><a href=#__codelineno-7-90><span class=linenos data-linenos=" 90 "></span></a>            <span class=n>created_at</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>(),</span>
</span><span id=__span-7-91><a id=__codelineno-7-91 name=__codelineno-7-91></a><a href=#__codelineno-7-91><span class=linenos data-linenos=" 91 "></span></a>            <span class=n>expires_at</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span> <span class=o>+</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>7</span><span class=p>)</span>
</span><span id=__span-7-92><a id=__codelineno-7-92 name=__codelineno-7-92></a><a href=#__codelineno-7-92><span class=linenos data-linenos=" 92 "></span></a>        <span class=p>)</span>
</span><span id=__span-7-93><a id=__codelineno-7-93 name=__codelineno-7-93></a><a href=#__codelineno-7-93><span class=linenos data-linenos=" 93 "></span></a>
</span><span id=__span-7-94><a id=__codelineno-7-94 name=__codelineno-7-94></a><a href=#__codelineno-7-94><span class=linenos data-linenos=" 94 "></span></a><span class=k>class</span> <span class=nc>BulkInvitationStrategy</span><span class=p>(</span><span class=n>InvitationStrategy</span><span class=p>):</span>
</span><span id=__span-7-95><a id=__codelineno-7-95 name=__codelineno-7-95></a><a href=#__codelineno-7-95><span class=linenos data-linenos=" 95 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Optimized strategy for bulk invitations&quot;&quot;&quot;</span>
</span><span id=__span-7-96><a id=__codelineno-7-96 name=__codelineno-7-96></a><a href=#__codelineno-7-96><span class=linenos data-linenos=" 96 "></span></a>    
</span><span id=__span-7-97><a id=__codelineno-7-97 name=__codelineno-7-97></a><a href=#__codelineno-7-97><span class=linenos data-linenos=" 97 "></span></a>    <span class=k>def</span> <span class=nf>validate</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>invitation_data</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span><span id=__span-7-98><a id=__codelineno-7-98 name=__codelineno-7-98></a><a href=#__codelineno-7-98><span class=linenos data-linenos=" 98 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Validate bulk invitation data&quot;&quot;&quot;</span>
</span><span id=__span-7-99><a id=__codelineno-7-99 name=__codelineno-7-99></a><a href=#__codelineno-7-99><span class=linenos data-linenos=" 99 "></span></a>        <span class=n>emails</span> <span class=o>=</span> <span class=n>invitation_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;emails&#39;</span><span class=p>,</span> <span class=p>[])</span>
</span><span id=__span-7-100><a id=__codelineno-7-100 name=__codelineno-7-100></a><a href=#__codelineno-7-100><span class=linenos data-linenos="100 "></span></a>        <span class=k>return</span> <span class=p>(</span>
</span><span id=__span-7-101><a id=__codelineno-7-101 name=__codelineno-7-101></a><a href=#__codelineno-7-101><span class=linenos data-linenos="101 "></span></a>            <span class=nb>isinstance</span><span class=p>(</span><span class=n>emails</span><span class=p>,</span> <span class=nb>list</span><span class=p>)</span> <span class=ow>and</span>
</span><span id=__span-7-102><a id=__codelineno-7-102 name=__codelineno-7-102></a><a href=#__codelineno-7-102><span class=linenos data-linenos="102 "></span></a>            <span class=nb>len</span><span class=p>(</span><span class=n>emails</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>100</span> <span class=ow>and</span>  <span class=c1># Reasonable bulk limit</span>
</span><span id=__span-7-103><a id=__codelineno-7-103 name=__codelineno-7-103></a><a href=#__codelineno-7-103><span class=linenos data-linenos="103 "></span></a>            <span class=nb>all</span><span class=p>(</span><span class=n>EmailValidator</span><span class=o>.</span><span class=n>is_valid</span><span class=p>(</span><span class=n>email</span><span class=p>)</span> <span class=k>for</span> <span class=n>email</span> <span class=ow>in</span> <span class=n>emails</span><span class=p>)</span>
</span><span id=__span-7-104><a id=__codelineno-7-104 name=__codelineno-7-104></a><a href=#__codelineno-7-104><span class=linenos data-linenos="104 "></span></a>        <span class=p>)</span>
</span><span id=__span-7-105><a id=__codelineno-7-105 name=__codelineno-7-105></a><a href=#__codelineno-7-105><span class=linenos data-linenos="105 "></span></a>    
</span><span id=__span-7-106><a id=__codelineno-7-106 name=__codelineno-7-106></a><a href=#__codelineno-7-106><span class=linenos data-linenos="106 "></span></a>    <span class=k>def</span> <span class=nf>create_invitation</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>invitation_data</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Invitation</span><span class=p>]:</span>
</span><span id=__span-7-107><a id=__codelineno-7-107 name=__codelineno-7-107></a><a href=#__codelineno-7-107><span class=linenos data-linenos="107 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Create multiple invitations efficiently&quot;&quot;&quot;</span>
</span><span id=__span-7-108><a id=__codelineno-7-108 name=__codelineno-7-108></a><a href=#__codelineno-7-108><span class=linenos data-linenos="108 "></span></a>        <span class=n>base_data</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-7-109><a id=__codelineno-7-109 name=__codelineno-7-109></a><a href=#__codelineno-7-109><span class=linenos data-linenos="109 "></span></a>            <span class=s1>&#39;role&#39;</span><span class=p>:</span> <span class=n>invitation_data</span><span class=p>[</span><span class=s1>&#39;role&#39;</span><span class=p>],</span>
</span><span id=__span-7-110><a id=__codelineno-7-110 name=__codelineno-7-110></a><a href=#__codelineno-7-110><span class=linenos data-linenos="110 "></span></a>            <span class=s1>&#39;workspace_id&#39;</span><span class=p>:</span> <span class=n>invitation_data</span><span class=p>[</span><span class=s1>&#39;workspace_id&#39;</span><span class=p>],</span>
</span><span id=__span-7-111><a id=__codelineno-7-111 name=__codelineno-7-111></a><a href=#__codelineno-7-111><span class=linenos data-linenos="111 "></span></a>            <span class=s1>&#39;invited_by_id&#39;</span><span class=p>:</span> <span class=n>invitation_data</span><span class=p>[</span><span class=s1>&#39;admin_user_id&#39;</span><span class=p>],</span>
</span><span id=__span-7-112><a id=__codelineno-7-112 name=__codelineno-7-112></a><a href=#__codelineno-7-112><span class=linenos data-linenos="112 "></span></a>            <span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=n>InvitationStatus</span><span class=o>.</span><span class=n>PENDING</span><span class=o>.</span><span class=n>value</span><span class=p>,</span>
</span><span id=__span-7-113><a id=__codelineno-7-113 name=__codelineno-7-113></a><a href=#__codelineno-7-113><span class=linenos data-linenos="113 "></span></a>            <span class=s1>&#39;created_at&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>(),</span>
</span><span id=__span-7-114><a id=__codelineno-7-114 name=__codelineno-7-114></a><a href=#__codelineno-7-114><span class=linenos data-linenos="114 "></span></a>            <span class=s1>&#39;expires_at&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span> <span class=o>+</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>7</span><span class=p>)</span>
</span><span id=__span-7-115><a id=__codelineno-7-115 name=__codelineno-7-115></a><a href=#__codelineno-7-115><span class=linenos data-linenos="115 "></span></a>        <span class=p>}</span>
</span><span id=__span-7-116><a id=__codelineno-7-116 name=__codelineno-7-116></a><a href=#__codelineno-7-116><span class=linenos data-linenos="116 "></span></a>        
</span><span id=__span-7-117><a id=__codelineno-7-117 name=__codelineno-7-117></a><a href=#__codelineno-7-117><span class=linenos data-linenos="117 "></span></a>        <span class=n>invitations</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-7-118><a id=__codelineno-7-118 name=__codelineno-7-118></a><a href=#__codelineno-7-118><span class=linenos data-linenos="118 "></span></a>        <span class=k>for</span> <span class=n>email</span> <span class=ow>in</span> <span class=n>invitation_data</span><span class=p>[</span><span class=s1>&#39;emails&#39;</span><span class=p>]:</span>
</span><span id=__span-7-119><a id=__codelineno-7-119 name=__codelineno-7-119></a><a href=#__codelineno-7-119><span class=linenos data-linenos="119 "></span></a>            <span class=n>invitation</span> <span class=o>=</span> <span class=n>Invitation</span><span class=p>(</span>
</span><span id=__span-7-120><a id=__codelineno-7-120 name=__codelineno-7-120></a><a href=#__codelineno-7-120><span class=linenos data-linenos="120 "></span></a>                <span class=n>email</span><span class=o>=</span><span class=n>email</span><span class=p>,</span>
</span><span id=__span-7-121><a id=__codelineno-7-121 name=__codelineno-7-121></a><a href=#__codelineno-7-121><span class=linenos data-linenos="121 "></span></a>                <span class=n>token</span><span class=o>=</span><span class=n>TokenGenerator</span><span class=o>.</span><span class=n>generate_secure_token</span><span class=p>(),</span>
</span><span id=__span-7-122><a id=__codelineno-7-122 name=__codelineno-7-122></a><a href=#__codelineno-7-122><span class=linenos data-linenos="122 "></span></a>                <span class=o>**</span><span class=n>base_data</span>
</span><span id=__span-7-123><a id=__codelineno-7-123 name=__codelineno-7-123></a><a href=#__codelineno-7-123><span class=linenos data-linenos="123 "></span></a>            <span class=p>)</span>
</span><span id=__span-7-124><a id=__codelineno-7-124 name=__codelineno-7-124></a><a href=#__codelineno-7-124><span class=linenos data-linenos="124 "></span></a>            <span class=n>invitations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>invitation</span><span class=p>)</span>
</span><span id=__span-7-125><a id=__codelineno-7-125 name=__codelineno-7-125></a><a href=#__codelineno-7-125><span class=linenos data-linenos="125 "></span></a>        
</span><span id=__span-7-126><a id=__codelineno-7-126 name=__codelineno-7-126></a><a href=#__codelineno-7-126><span class=linenos data-linenos="126 "></span></a>        <span class=k>return</span> <span class=n>invitations</span>
</span><span id=__span-7-127><a id=__codelineno-7-127 name=__codelineno-7-127></a><a href=#__codelineno-7-127><span class=linenos data-linenos="127 "></span></a>
</span><span id=__span-7-128><a id=__codelineno-7-128 name=__codelineno-7-128></a><a href=#__codelineno-7-128><span class=linenos data-linenos="128 "></span></a><span class=k>class</span> <span class=nc>InvitationService</span><span class=p>:</span>
</span><span id=__span-7-129><a id=__codelineno-7-129 name=__codelineno-7-129></a><a href=#__codelineno-7-129><span class=linenos data-linenos="129 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-7-130><a id=__codelineno-7-130 name=__codelineno-7-130></a><a href=#__codelineno-7-130><span class=linenos data-linenos="130 "></span></a><span class=sd>    Production-ready invitation service with comprehensive features:</span>
</span><span id=__span-7-131><a id=__codelineno-7-131 name=__codelineno-7-131></a><a href=#__codelineno-7-131><span class=linenos data-linenos="131 "></span></a><span class=sd>    - Strategy pattern for different invitation types</span>
</span><span id=__span-7-132><a id=__codelineno-7-132 name=__codelineno-7-132></a><a href=#__codelineno-7-132><span class=linenos data-linenos="132 "></span></a><span class=sd>    - Comprehensive error handling and logging  </span>
</span><span id=__span-7-133><a id=__codelineno-7-133 name=__codelineno-7-133></a><a href=#__codelineno-7-133><span class=linenos data-linenos="133 "></span></a><span class=sd>    - Rate limiting and security controls</span>
</span><span id=__span-7-134><a id=__codelineno-7-134 name=__codelineno-7-134></a><a href=#__codelineno-7-134><span class=linenos data-linenos="134 "></span></a><span class=sd>    - Performance optimization for bulk operations</span>
</span><span id=__span-7-135><a id=__codelineno-7-135 name=__codelineno-7-135></a><a href=#__codelineno-7-135><span class=linenos data-linenos="135 "></span></a><span class=sd>    - Extensive monitoring and metrics</span>
</span><span id=__span-7-136><a id=__codelineno-7-136 name=__codelineno-7-136></a><a href=#__codelineno-7-136><span class=linenos data-linenos="136 "></span></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-7-137><a id=__codelineno-7-137 name=__codelineno-7-137></a><a href=#__codelineno-7-137><span class=linenos data-linenos="137 "></span></a>    
</span><span id=__span-7-138><a id=__codelineno-7-138 name=__codelineno-7-138></a><a href=#__codelineno-7-138><span class=linenos data-linenos="138 "></span></a>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-7-139><a id=__codelineno-7-139 name=__codelineno-7-139></a><a href=#__codelineno-7-139><span class=linenos data-linenos="139 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span><span id=__span-7-140><a id=__codelineno-7-140 name=__codelineno-7-140></a><a href=#__codelineno-7-140><span class=linenos data-linenos="140 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>email_service</span> <span class=o>=</span> <span class=n>EmailService</span><span class=p>()</span>
</span><span id=__span-7-141><a id=__codelineno-7-141 name=__codelineno-7-141></a><a href=#__codelineno-7-141><span class=linenos data-linenos="141 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>rate_limiter</span> <span class=o>=</span> <span class=n>RateLimiter</span><span class=p>()</span>
</span><span id=__span-7-142><a id=__codelineno-7-142 name=__codelineno-7-142></a><a href=#__codelineno-7-142><span class=linenos data-linenos="142 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>strategies</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-7-143><a id=__codelineno-7-143 name=__codelineno-7-143></a><a href=#__codelineno-7-143><span class=linenos data-linenos="143 "></span></a>            <span class=s1>&#39;standard&#39;</span><span class=p>:</span> <span class=n>StandardInvitationStrategy</span><span class=p>(),</span>
</span><span id=__span-7-144><a id=__codelineno-7-144 name=__codelineno-7-144></a><a href=#__codelineno-7-144><span class=linenos data-linenos="144 "></span></a>            <span class=s1>&#39;bulk&#39;</span><span class=p>:</span> <span class=n>BulkInvitationStrategy</span><span class=p>()</span>
</span><span id=__span-7-145><a id=__codelineno-7-145 name=__codelineno-7-145></a><a href=#__codelineno-7-145><span class=linenos data-linenos="145 "></span></a>        <span class=p>}</span>
</span><span id=__span-7-146><a id=__codelineno-7-146 name=__codelineno-7-146></a><a href=#__codelineno-7-146><span class=linenos data-linenos="146 "></span></a>    
</span><span id=__span-7-147><a id=__codelineno-7-147 name=__codelineno-7-147></a><a href=#__codelineno-7-147><span class=linenos data-linenos="147 "></span></a>    <span class=k>def</span> <span class=nf>send_invitation</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>admin_user</span><span class=p>:</span> <span class=n>User</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> 
</span><span id=__span-7-148><a id=__codelineno-7-148 name=__codelineno-7-148></a><a href=#__codelineno-7-148><span class=linenos data-linenos="148 "></span></a>                       <span class=n>email</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>role</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>message</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span><span id=__span-7-149><a id=__codelineno-7-149 name=__codelineno-7-149></a><a href=#__codelineno-7-149><span class=linenos data-linenos="149 "></span></a>                       <span class=n>strategy</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;standard&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>InvitationResult</span><span class=p>:</span>
</span><span id=__span-7-150><a id=__codelineno-7-150 name=__codelineno-7-150></a><a href=#__codelineno-7-150><span class=linenos data-linenos="150 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-7-151><a id=__codelineno-7-151 name=__codelineno-7-151></a><a href=#__codelineno-7-151><span class=linenos data-linenos="151 "></span></a><span class=sd>        Send invitation with comprehensive error handling and logging</span>
</span><span id=__span-7-152><a id=__codelineno-7-152 name=__codelineno-7-152></a><a href=#__codelineno-7-152><span class=linenos data-linenos="152 "></span></a><span class=sd>        </span>
</span><span id=__span-7-153><a id=__codelineno-7-153 name=__codelineno-7-153></a><a href=#__codelineno-7-153><span class=linenos data-linenos="153 "></span></a><span class=sd>        Args:</span>
</span><span id=__span-7-154><a id=__codelineno-7-154 name=__codelineno-7-154></a><a href=#__codelineno-7-154><span class=linenos data-linenos="154 "></span></a><span class=sd>            admin_user: User sending the invitation (must have admin role)</span>
</span><span id=__span-7-155><a id=__codelineno-7-155 name=__codelineno-7-155></a><a href=#__codelineno-7-155><span class=linenos data-linenos="155 "></span></a><span class=sd>            workspace_id: Target workspace ID</span>
</span><span id=__span-7-156><a id=__codelineno-7-156 name=__codelineno-7-156></a><a href=#__codelineno-7-156><span class=linenos data-linenos="156 "></span></a><span class=sd>            email: Recipient email address</span>
</span><span id=__span-7-157><a id=__codelineno-7-157 name=__codelineno-7-157></a><a href=#__codelineno-7-157><span class=linenos data-linenos="157 "></span></a><span class=sd>            role: Role to assign to invited user</span>
</span><span id=__span-7-158><a id=__codelineno-7-158 name=__codelineno-7-158></a><a href=#__codelineno-7-158><span class=linenos data-linenos="158 "></span></a><span class=sd>            message: Optional custom message</span>
</span><span id=__span-7-159><a id=__codelineno-7-159 name=__codelineno-7-159></a><a href=#__codelineno-7-159><span class=linenos data-linenos="159 "></span></a><span class=sd>            strategy: Invitation strategy to use</span>
</span><span id=__span-7-160><a id=__codelineno-7-160 name=__codelineno-7-160></a><a href=#__codelineno-7-160><span class=linenos data-linenos="160 "></span></a><span class=sd>            </span>
</span><span id=__span-7-161><a id=__codelineno-7-161 name=__codelineno-7-161></a><a href=#__codelineno-7-161><span class=linenos data-linenos="161 "></span></a><span class=sd>        Returns:</span>
</span><span id=__span-7-162><a id=__codelineno-7-162 name=__codelineno-7-162></a><a href=#__codelineno-7-162><span class=linenos data-linenos="162 "></span></a><span class=sd>            InvitationResult with success status and metadata</span>
</span><span id=__span-7-163><a id=__codelineno-7-163 name=__codelineno-7-163></a><a href=#__codelineno-7-163><span class=linenos data-linenos="163 "></span></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-7-164><a id=__codelineno-7-164 name=__codelineno-7-164></a><a href=#__codelineno-7-164><span class=linenos data-linenos="164 "></span></a>        
</span><span id=__span-7-165><a id=__codelineno-7-165 name=__codelineno-7-165></a><a href=#__codelineno-7-165><span class=linenos data-linenos="165 "></span></a>        <span class=n>start_time</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span>
</span><span id=__span-7-166><a id=__codelineno-7-166 name=__codelineno-7-166></a><a href=#__codelineno-7-166><span class=linenos data-linenos="166 "></span></a>        
</span><span id=__span-7-167><a id=__codelineno-7-167 name=__codelineno-7-167></a><a href=#__codelineno-7-167><span class=linenos data-linenos="167 "></span></a>        <span class=k>try</span><span class=p>:</span>
</span><span id=__span-7-168><a id=__codelineno-7-168 name=__codelineno-7-168></a><a href=#__codelineno-7-168><span class=linenos data-linenos="168 "></span></a>            <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>_invitation_transaction</span><span class=p>():</span>
</span><span id=__span-7-169><a id=__codelineno-7-169 name=__codelineno-7-169></a><a href=#__codelineno-7-169><span class=linenos data-linenos="169 "></span></a>                <span class=c1># Comprehensive validation</span>
</span><span id=__span-7-170><a id=__codelineno-7-170 name=__codelineno-7-170></a><a href=#__codelineno-7-170><span class=linenos data-linenos="170 "></span></a>                <span class=bp>self</span><span class=o>.</span><span class=n>_validate_invitation_request</span><span class=p>(</span><span class=n>admin_user</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>,</span> <span class=n>email</span><span class=p>,</span> <span class=n>role</span><span class=p>)</span>
</span><span id=__span-7-171><a id=__codelineno-7-171 name=__codelineno-7-171></a><a href=#__codelineno-7-171><span class=linenos data-linenos="171 "></span></a>                
</span><span id=__span-7-172><a id=__codelineno-7-172 name=__codelineno-7-172></a><a href=#__codelineno-7-172><span class=linenos data-linenos="172 "></span></a>                <span class=c1># Check rate limiting with user context</span>
</span><span id=__span-7-173><a id=__codelineno-7-173 name=__codelineno-7-173></a><a href=#__codelineno-7-173><span class=linenos data-linenos="173 "></span></a>                <span class=bp>self</span><span class=o>.</span><span class=n>rate_limiter</span><span class=o>.</span><span class=n>check_rate_limit</span><span class=p>(</span>
</span><span id=__span-7-174><a id=__codelineno-7-174 name=__codelineno-7-174></a><a href=#__codelineno-7-174><span class=linenos data-linenos="174 "></span></a>                    <span class=n>user_id</span><span class=o>=</span><span class=n>admin_user</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-7-175><a id=__codelineno-7-175 name=__codelineno-7-175></a><a href=#__codelineno-7-175><span class=linenos data-linenos="175 "></span></a>                    <span class=n>action</span><span class=o>=</span><span class=s1>&#39;send_invitation&#39;</span><span class=p>,</span>
</span><span id=__span-7-176><a id=__codelineno-7-176 name=__codelineno-7-176></a><a href=#__codelineno-7-176><span class=linenos data-linenos="176 "></span></a>                    <span class=n>limit</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>
</span><span id=__span-7-177><a id=__codelineno-7-177 name=__codelineno-7-177></a><a href=#__codelineno-7-177><span class=linenos data-linenos="177 "></span></a>                    <span class=n>window_hours</span><span class=o>=</span><span class=mi>1</span>
</span><span id=__span-7-178><a id=__codelineno-7-178 name=__codelineno-7-178></a><a href=#__codelineno-7-178><span class=linenos data-linenos="178 "></span></a>                <span class=p>)</span>
</span><span id=__span-7-179><a id=__codelineno-7-179 name=__codelineno-7-179></a><a href=#__codelineno-7-179><span class=linenos data-linenos="179 "></span></a>                
</span><span id=__span-7-180><a id=__codelineno-7-180 name=__codelineno-7-180></a><a href=#__codelineno-7-180><span class=linenos data-linenos="180 "></span></a>                <span class=c1># Handle existing invitations elegantly</span>
</span><span id=__span-7-181><a id=__codelineno-7-181 name=__codelineno-7-181></a><a href=#__codelineno-7-181><span class=linenos data-linenos="181 "></span></a>                <span class=n>existing_invitation</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_find_existing_invitation</span><span class=p>(</span><span class=n>email</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>)</span>
</span><span id=__span-7-182><a id=__codelineno-7-182 name=__codelineno-7-182></a><a href=#__codelineno-7-182><span class=linenos data-linenos="182 "></span></a>                <span class=k>if</span> <span class=n>existing_invitation</span><span class=p>:</span>
</span><span id=__span-7-183><a id=__codelineno-7-183 name=__codelineno-7-183></a><a href=#__codelineno-7-183><span class=linenos data-linenos="183 "></span></a>                    <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_update_existing_invitation</span><span class=p>(</span>
</span><span id=__span-7-184><a id=__codelineno-7-184 name=__codelineno-7-184></a><a href=#__codelineno-7-184><span class=linenos data-linenos="184 "></span></a>                        <span class=n>existing_invitation</span><span class=p>,</span> <span class=n>role</span><span class=p>,</span> <span class=n>message</span><span class=p>,</span> <span class=n>admin_user</span>
</span><span id=__span-7-185><a id=__codelineno-7-185 name=__codelineno-7-185></a><a href=#__codelineno-7-185><span class=linenos data-linenos="185 "></span></a>                    <span class=p>)</span>
</span><span id=__span-7-186><a id=__codelineno-7-186 name=__codelineno-7-186></a><a href=#__codelineno-7-186><span class=linenos data-linenos="186 "></span></a>                
</span><span id=__span-7-187><a id=__codelineno-7-187 name=__codelineno-7-187></a><a href=#__codelineno-7-187><span class=linenos data-linenos="187 "></span></a>                <span class=c1># Create invitation using strategy pattern</span>
</span><span id=__span-7-188><a id=__codelineno-7-188 name=__codelineno-7-188></a><a href=#__codelineno-7-188><span class=linenos data-linenos="188 "></span></a>                <span class=n>invitation_data</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-7-189><a id=__codelineno-7-189 name=__codelineno-7-189></a><a href=#__codelineno-7-189><span class=linenos data-linenos="189 "></span></a>                    <span class=s1>&#39;email&#39;</span><span class=p>:</span> <span class=n>email</span><span class=p>,</span>
</span><span id=__span-7-190><a id=__codelineno-7-190 name=__codelineno-7-190></a><a href=#__codelineno-7-190><span class=linenos data-linenos="190 "></span></a>                    <span class=s1>&#39;role&#39;</span><span class=p>:</span> <span class=n>role</span><span class=p>,</span>
</span><span id=__span-7-191><a id=__codelineno-7-191 name=__codelineno-7-191></a><a href=#__codelineno-7-191><span class=linenos data-linenos="191 "></span></a>                    <span class=s1>&#39;message&#39;</span><span class=p>:</span> <span class=n>message</span><span class=p>,</span>
</span><span id=__span-7-192><a id=__codelineno-7-192 name=__codelineno-7-192></a><a href=#__codelineno-7-192><span class=linenos data-linenos="192 "></span></a>                    <span class=s1>&#39;workspace_id&#39;</span><span class=p>:</span> <span class=n>workspace_id</span><span class=p>,</span>
</span><span id=__span-7-193><a id=__codelineno-7-193 name=__codelineno-7-193></a><a href=#__codelineno-7-193><span class=linenos data-linenos="193 "></span></a>                    <span class=s1>&#39;admin_user_id&#39;</span><span class=p>:</span> <span class=n>admin_user</span><span class=o>.</span><span class=n>id</span>
</span><span id=__span-7-194><a id=__codelineno-7-194 name=__codelineno-7-194></a><a href=#__codelineno-7-194><span class=linenos data-linenos="194 "></span></a>                <span class=p>}</span>
</span><span id=__span-7-195><a id=__codelineno-7-195 name=__codelineno-7-195></a><a href=#__codelineno-7-195><span class=linenos data-linenos="195 "></span></a>                
</span><span id=__span-7-196><a id=__codelineno-7-196 name=__codelineno-7-196></a><a href=#__codelineno-7-196><span class=linenos data-linenos="196 "></span></a>                <span class=n>strategy_handler</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>strategies</span><span class=p>[</span><span class=n>strategy</span><span class=p>]</span>
</span><span id=__span-7-197><a id=__codelineno-7-197 name=__codelineno-7-197></a><a href=#__codelineno-7-197><span class=linenos data-linenos="197 "></span></a>                <span class=k>if</span> <span class=ow>not</span> <span class=n>strategy_handler</span><span class=o>.</span><span class=n>validate</span><span class=p>(</span><span class=n>invitation_data</span><span class=p>):</span>
</span><span id=__span-7-198><a id=__codelineno-7-198 name=__codelineno-7-198></a><a href=#__codelineno-7-198><span class=linenos data-linenos="198 "></span></a>                    <span class=k>raise</span> <span class=n>ValidationError</span><span class=p>(</span><span class=s2>&quot;Invalid invitation data&quot;</span><span class=p>)</span>
</span><span id=__span-7-199><a id=__codelineno-7-199 name=__codelineno-7-199></a><a href=#__codelineno-7-199><span class=linenos data-linenos="199 "></span></a>                
</span><span id=__span-7-200><a id=__codelineno-7-200 name=__codelineno-7-200></a><a href=#__codelineno-7-200><span class=linenos data-linenos="200 "></span></a>                <span class=n>invitation</span> <span class=o>=</span> <span class=n>strategy_handler</span><span class=o>.</span><span class=n>create_invitation</span><span class=p>(</span><span class=n>invitation_data</span><span class=p>)</span>
</span><span id=__span-7-201><a id=__codelineno-7-201 name=__codelineno-7-201></a><a href=#__codelineno-7-201><span class=linenos data-linenos="201 "></span></a>                <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>invitation</span><span class=p>)</span>
</span><span id=__span-7-202><a id=__codelineno-7-202 name=__codelineno-7-202></a><a href=#__codelineno-7-202><span class=linenos data-linenos="202 "></span></a>                <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>flush</span><span class=p>()</span>  <span class=c1># Get ID without committing</span>
</span><span id=__span-7-203><a id=__codelineno-7-203 name=__codelineno-7-203></a><a href=#__codelineno-7-203><span class=linenos data-linenos="203 "></span></a>                
</span><span id=__span-7-204><a id=__codelineno-7-204 name=__codelineno-7-204></a><a href=#__codelineno-7-204><span class=linenos data-linenos="204 "></span></a>                <span class=c1># Send email asynchronously</span>
</span><span id=__span-7-205><a id=__codelineno-7-205 name=__codelineno-7-205></a><a href=#__codelineno-7-205><span class=linenos data-linenos="205 "></span></a>                <span class=bp>self</span><span class=o>.</span><span class=n>_send_invitation_email_async</span><span class=p>(</span><span class=n>invitation</span><span class=p>,</span> <span class=n>admin_user</span><span class=p>)</span>
</span><span id=__span-7-206><a id=__codelineno-7-206 name=__codelineno-7-206></a><a href=#__codelineno-7-206><span class=linenos data-linenos="206 "></span></a>                
</span><span id=__span-7-207><a id=__codelineno-7-207 name=__codelineno-7-207></a><a href=#__codelineno-7-207><span class=linenos data-linenos="207 "></span></a>                <span class=c1># Record metrics</span>
</span><span id=__span-7-208><a id=__codelineno-7-208 name=__codelineno-7-208></a><a href=#__codelineno-7-208><span class=linenos data-linenos="208 "></span></a>                <span class=bp>self</span><span class=o>.</span><span class=n>_record_invitation_metrics</span><span class=p>(</span><span class=n>admin_user</span><span class=p>,</span> <span class=n>invitation</span><span class=p>,</span> <span class=n>start_time</span><span class=p>)</span>
</span><span id=__span-7-209><a id=__codelineno-7-209 name=__codelineno-7-209></a><a href=#__codelineno-7-209><span class=linenos data-linenos="209 "></span></a>                
</span><span id=__span-7-210><a id=__codelineno-7-210 name=__codelineno-7-210></a><a href=#__codelineno-7-210><span class=linenos data-linenos="210 "></span></a>                <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span>
</span><span id=__span-7-211><a id=__codelineno-7-211 name=__codelineno-7-211></a><a href=#__codelineno-7-211><span class=linenos data-linenos="211 "></span></a>                    <span class=n>success</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-7-212><a id=__codelineno-7-212 name=__codelineno-7-212></a><a href=#__codelineno-7-212><span class=linenos data-linenos="212 "></span></a>                    <span class=n>invitation_id</span><span class=o>=</span><span class=n>invitation</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-7-213><a id=__codelineno-7-213 name=__codelineno-7-213></a><a href=#__codelineno-7-213><span class=linenos data-linenos="213 "></span></a>                    <span class=n>expires_at</span><span class=o>=</span><span class=n>invitation</span><span class=o>.</span><span class=n>expires_at</span><span class=p>,</span>
</span><span id=__span-7-214><a id=__codelineno-7-214 name=__codelineno-7-214></a><a href=#__codelineno-7-214><span class=linenos data-linenos="214 "></span></a>                    <span class=n>created_at</span><span class=o>=</span><span class=n>invitation</span><span class=o>.</span><span class=n>created_at</span><span class=p>,</span>
</span><span id=__span-7-215><a id=__codelineno-7-215 name=__codelineno-7-215></a><a href=#__codelineno-7-215><span class=linenos data-linenos="215 "></span></a>                    <span class=n>metadata</span><span class=o>=</span><span class=p>{</span>
</span><span id=__span-7-216><a id=__codelineno-7-216 name=__codelineno-7-216></a><a href=#__codelineno-7-216><span class=linenos data-linenos="216 "></span></a>                        <span class=s1>&#39;processing_time_ms&#39;</span><span class=p>:</span> <span class=p>(</span><span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span><span class=p>)</span><span class=o>.</span><span class=n>total_seconds</span><span class=p>()</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>,</span>
</span><span id=__span-7-217><a id=__codelineno-7-217 name=__codelineno-7-217></a><a href=#__codelineno-7-217><span class=linenos data-linenos="217 "></span></a>                        <span class=s1>&#39;strategy_used&#39;</span><span class=p>:</span> <span class=n>strategy</span><span class=p>,</span>
</span><span id=__span-7-218><a id=__codelineno-7-218 name=__codelineno-7-218></a><a href=#__codelineno-7-218><span class=linenos data-linenos="218 "></span></a>                        <span class=s1>&#39;workspace_name&#39;</span><span class=p>:</span> <span class=n>admin_user</span><span class=o>.</span><span class=n>workspace</span><span class=o>.</span><span class=n>name</span>
</span><span id=__span-7-219><a id=__codelineno-7-219 name=__codelineno-7-219></a><a href=#__codelineno-7-219><span class=linenos data-linenos="219 "></span></a>                    <span class=p>}</span>
</span><span id=__span-7-220><a id=__codelineno-7-220 name=__codelineno-7-220></a><a href=#__codelineno-7-220><span class=linenos data-linenos="220 "></span></a>                <span class=p>)</span>
</span><span id=__span-7-221><a id=__codelineno-7-221 name=__codelineno-7-221></a><a href=#__codelineno-7-221><span class=linenos data-linenos="221 "></span></a>                
</span><span id=__span-7-222><a id=__codelineno-7-222 name=__codelineno-7-222></a><a href=#__codelineno-7-222><span class=linenos data-linenos="222 "></span></a>        <span class=k>except</span> <span class=n>InvitationError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-7-223><a id=__codelineno-7-223 name=__codelineno-7-223></a><a href=#__codelineno-7-223><span class=linenos data-linenos="223 "></span></a>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Invitation failed: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span> <span class=n>extra</span><span class=o>=</span><span class=p>{</span>
</span><span id=__span-7-224><a id=__codelineno-7-224 name=__codelineno-7-224></a><a href=#__codelineno-7-224><span class=linenos data-linenos="224 "></span></a>                <span class=s1>&#39;admin_user_id&#39;</span><span class=p>:</span> <span class=n>admin_user</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-7-225><a id=__codelineno-7-225 name=__codelineno-7-225></a><a href=#__codelineno-7-225><span class=linenos data-linenos="225 "></span></a>                <span class=s1>&#39;email&#39;</span><span class=p>:</span> <span class=n>email</span><span class=p>,</span>
</span><span id=__span-7-226><a id=__codelineno-7-226 name=__codelineno-7-226></a><a href=#__codelineno-7-226><span class=linenos data-linenos="226 "></span></a>                <span class=s1>&#39;workspace_id&#39;</span><span class=p>:</span> <span class=n>workspace_id</span>
</span><span id=__span-7-227><a id=__codelineno-7-227 name=__codelineno-7-227></a><a href=#__codelineno-7-227><span class=linenos data-linenos="227 "></span></a>            <span class=p>})</span>
</span><span id=__span-7-228><a id=__codelineno-7-228 name=__codelineno-7-228></a><a href=#__codelineno-7-228><span class=linenos data-linenos="228 "></span></a>            <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span>
</span><span id=__span-7-229><a id=__codelineno-7-229 name=__codelineno-7-229></a><a href=#__codelineno-7-229><span class=linenos data-linenos="229 "></span></a>                <span class=n>success</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-7-230><a id=__codelineno-7-230 name=__codelineno-7-230></a><a href=#__codelineno-7-230><span class=linenos data-linenos="230 "></span></a>                <span class=n>error</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>),</span>
</span><span id=__span-7-231><a id=__codelineno-7-231 name=__codelineno-7-231></a><a href=#__codelineno-7-231><span class=linenos data-linenos="231 "></span></a>                <span class=n>code</span><span class=o>=</span><span class=n>e</span><span class=o>.</span><span class=n>code</span><span class=p>,</span>
</span><span id=__span-7-232><a id=__codelineno-7-232 name=__codelineno-7-232></a><a href=#__codelineno-7-232><span class=linenos data-linenos="232 "></span></a>                <span class=n>metadata</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;error_type&#39;</span><span class=p>:</span> <span class=nb>type</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=o>.</span><span class=vm>__name__</span><span class=p>}</span>
</span><span id=__span-7-233><a id=__codelineno-7-233 name=__codelineno-7-233></a><a href=#__codelineno-7-233><span class=linenos data-linenos="233 "></span></a>            <span class=p>)</span>
</span><span id=__span-7-234><a id=__codelineno-7-234 name=__codelineno-7-234></a><a href=#__codelineno-7-234><span class=linenos data-linenos="234 "></span></a>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-7-235><a id=__codelineno-7-235 name=__codelineno-7-235></a><a href=#__codelineno-7-235><span class=linenos data-linenos="235 "></span></a>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Invitation system error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span> <span class=n>extra</span><span class=o>=</span><span class=p>{</span>
</span><span id=__span-7-236><a id=__codelineno-7-236 name=__codelineno-7-236></a><a href=#__codelineno-7-236><span class=linenos data-linenos="236 "></span></a>                <span class=s1>&#39;admin_user_id&#39;</span><span class=p>:</span> <span class=n>admin_user</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-7-237><a id=__codelineno-7-237 name=__codelineno-7-237></a><a href=#__codelineno-7-237><span class=linenos data-linenos="237 "></span></a>                <span class=s1>&#39;email&#39;</span><span class=p>:</span> <span class=n>email</span><span class=p>,</span>
</span><span id=__span-7-238><a id=__codelineno-7-238 name=__codelineno-7-238></a><a href=#__codelineno-7-238><span class=linenos data-linenos="238 "></span></a>                <span class=s1>&#39;workspace_id&#39;</span><span class=p>:</span> <span class=n>workspace_id</span>
</span><span id=__span-7-239><a id=__codelineno-7-239 name=__codelineno-7-239></a><a href=#__codelineno-7-239><span class=linenos data-linenos="239 "></span></a>            <span class=p>},</span> <span class=n>exc_info</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-7-240><a id=__codelineno-7-240 name=__codelineno-7-240></a><a href=#__codelineno-7-240><span class=linenos data-linenos="240 "></span></a>            <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span>
</span><span id=__span-7-241><a id=__codelineno-7-241 name=__codelineno-7-241></a><a href=#__codelineno-7-241><span class=linenos data-linenos="241 "></span></a>                <span class=n>success</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-7-242><a id=__codelineno-7-242 name=__codelineno-7-242></a><a href=#__codelineno-7-242><span class=linenos data-linenos="242 "></span></a>                <span class=n>error</span><span class=o>=</span><span class=s2>&quot;Invitation system temporarily unavailable&quot;</span><span class=p>,</span>
</span><span id=__span-7-243><a id=__codelineno-7-243 name=__codelineno-7-243></a><a href=#__codelineno-7-243><span class=linenos data-linenos="243 "></span></a>                <span class=n>code</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span>
</span><span id=__span-7-244><a id=__codelineno-7-244 name=__codelineno-7-244></a><a href=#__codelineno-7-244><span class=linenos data-linenos="244 "></span></a>                <span class=n>metadata</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;error_type&#39;</span><span class=p>:</span> <span class=s1>&#39;SystemError&#39;</span><span class=p>}</span>
</span><span id=__span-7-245><a id=__codelineno-7-245 name=__codelineno-7-245></a><a href=#__codelineno-7-245><span class=linenos data-linenos="245 "></span></a>            <span class=p>)</span>
</span><span id=__span-7-246><a id=__codelineno-7-246 name=__codelineno-7-246></a><a href=#__codelineno-7-246><span class=linenos data-linenos="246 "></span></a>    
</span><span id=__span-7-247><a id=__codelineno-7-247 name=__codelineno-7-247></a><a href=#__codelineno-7-247><span class=linenos data-linenos="247 "></span></a>    <span class=k>def</span> <span class=nf>accept_invitation</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>token</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>user_data</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>InvitationResult</span><span class=p>:</span>
</span><span id=__span-7-248><a id=__codelineno-7-248 name=__codelineno-7-248></a><a href=#__codelineno-7-248><span class=linenos data-linenos="248 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-7-249><a id=__codelineno-7-249 name=__codelineno-7-249></a><a href=#__codelineno-7-249><span class=linenos data-linenos="249 "></span></a><span class=sd>        Accept invitation with comprehensive user onboarding</span>
</span><span id=__span-7-250><a id=__codelineno-7-250 name=__codelineno-7-250></a><a href=#__codelineno-7-250><span class=linenos data-linenos="250 "></span></a><span class=sd>        </span>
</span><span id=__span-7-251><a id=__codelineno-7-251 name=__codelineno-7-251></a><a href=#__codelineno-7-251><span class=linenos data-linenos="251 "></span></a><span class=sd>        Args:</span>
</span><span id=__span-7-252><a id=__codelineno-7-252 name=__codelineno-7-252></a><a href=#__codelineno-7-252><span class=linenos data-linenos="252 "></span></a><span class=sd>            token: Secure invitation token</span>
</span><span id=__span-7-253><a id=__codelineno-7-253 name=__codelineno-7-253></a><a href=#__codelineno-7-253><span class=linenos data-linenos="253 "></span></a><span class=sd>            user_data: New user registration data</span>
</span><span id=__span-7-254><a id=__codelineno-7-254 name=__codelineno-7-254></a><a href=#__codelineno-7-254><span class=linenos data-linenos="254 "></span></a><span class=sd>            </span>
</span><span id=__span-7-255><a id=__codelineno-7-255 name=__codelineno-7-255></a><a href=#__codelineno-7-255><span class=linenos data-linenos="255 "></span></a><span class=sd>        Returns:</span>
</span><span id=__span-7-256><a id=__codelineno-7-256 name=__codelineno-7-256></a><a href=#__codelineno-7-256><span class=linenos data-linenos="256 "></span></a><span class=sd>            InvitationResult with success status and user info</span>
</span><span id=__span-7-257><a id=__codelineno-7-257 name=__codelineno-7-257></a><a href=#__codelineno-7-257><span class=linenos data-linenos="257 "></span></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-7-258><a id=__codelineno-7-258 name=__codelineno-7-258></a><a href=#__codelineno-7-258><span class=linenos data-linenos="258 "></span></a>        
</span><span id=__span-7-259><a id=__codelineno-7-259 name=__codelineno-7-259></a><a href=#__codelineno-7-259><span class=linenos data-linenos="259 "></span></a>        <span class=k>try</span><span class=p>:</span>
</span><span id=__span-7-260><a id=__codelineno-7-260 name=__codelineno-7-260></a><a href=#__codelineno-7-260><span class=linenos data-linenos="260 "></span></a>            <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>_invitation_transaction</span><span class=p>():</span>
</span><span id=__span-7-261><a id=__codelineno-7-261 name=__codelineno-7-261></a><a href=#__codelineno-7-261><span class=linenos data-linenos="261 "></span></a>                <span class=n>invitation</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_validate_invitation_token</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span><span id=__span-7-262><a id=__codelineno-7-262 name=__codelineno-7-262></a><a href=#__codelineno-7-262><span class=linenos data-linenos="262 "></span></a>                
</span><span id=__span-7-263><a id=__codelineno-7-263 name=__codelineno-7-263></a><a href=#__codelineno-7-263><span class=linenos data-linenos="263 "></span></a>                <span class=c1># Create user with proper onboarding workflow</span>
</span><span id=__span-7-264><a id=__codelineno-7-264 name=__codelineno-7-264></a><a href=#__codelineno-7-264><span class=linenos data-linenos="264 "></span></a>                <span class=n>new_user</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_create_user_from_invitation</span><span class=p>(</span><span class=n>invitation</span><span class=p>,</span> <span class=n>user_data</span><span class=p>)</span>
</span><span id=__span-7-265><a id=__codelineno-7-265 name=__codelineno-7-265></a><a href=#__codelineno-7-265><span class=linenos data-linenos="265 "></span></a>                
</span><span id=__span-7-266><a id=__codelineno-7-266 name=__codelineno-7-266></a><a href=#__codelineno-7-266><span class=linenos data-linenos="266 "></span></a>                <span class=c1># Add to workspace with proper role assignment</span>
</span><span id=__span-7-267><a id=__codelineno-7-267 name=__codelineno-7-267></a><a href=#__codelineno-7-267><span class=linenos data-linenos="267 "></span></a>                <span class=bp>self</span><span class=o>.</span><span class=n>_add_user_to_workspace</span><span class=p>(</span><span class=n>new_user</span><span class=p>,</span> <span class=n>invitation</span><span class=p>)</span>
</span><span id=__span-7-268><a id=__codelineno-7-268 name=__codelineno-7-268></a><a href=#__codelineno-7-268><span class=linenos data-linenos="268 "></span></a>                
</span><span id=__span-7-269><a id=__codelineno-7-269 name=__codelineno-7-269></a><a href=#__codelineno-7-269><span class=linenos data-linenos="269 "></span></a>                <span class=c1># Mark invitation as accepted</span>
</span><span id=__span-7-270><a id=__codelineno-7-270 name=__codelineno-7-270></a><a href=#__codelineno-7-270><span class=linenos data-linenos="270 "></span></a>                <span class=n>invitation</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=n>InvitationStatus</span><span class=o>.</span><span class=n>ACCEPTED</span><span class=o>.</span><span class=n>value</span>
</span><span id=__span-7-271><a id=__codelineno-7-271 name=__codelineno-7-271></a><a href=#__codelineno-7-271><span class=linenos data-linenos="271 "></span></a>                <span class=n>invitation</span><span class=o>.</span><span class=n>accepted_at</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span>
</span><span id=__span-7-272><a id=__codelineno-7-272 name=__codelineno-7-272></a><a href=#__codelineno-7-272><span class=linenos data-linenos="272 "></span></a>                <span class=n>invitation</span><span class=o>.</span><span class=n>accepted_by_id</span> <span class=o>=</span> <span class=n>new_user</span><span class=o>.</span><span class=n>id</span>
</span><span id=__span-7-273><a id=__codelineno-7-273 name=__codelineno-7-273></a><a href=#__codelineno-7-273><span class=linenos data-linenos="273 "></span></a>                
</span><span id=__span-7-274><a id=__codelineno-7-274 name=__codelineno-7-274></a><a href=#__codelineno-7-274><span class=linenos data-linenos="274 "></span></a>                <span class=c1># Trigger onboarding workflow</span>
</span><span id=__span-7-275><a id=__codelineno-7-275 name=__codelineno-7-275></a><a href=#__codelineno-7-275><span class=linenos data-linenos="275 "></span></a>                <span class=bp>self</span><span class=o>.</span><span class=n>_trigger_user_onboarding</span><span class=p>(</span><span class=n>new_user</span><span class=p>,</span> <span class=n>invitation</span><span class=p>)</span>
</span><span id=__span-7-276><a id=__codelineno-7-276 name=__codelineno-7-276></a><a href=#__codelineno-7-276><span class=linenos data-linenos="276 "></span></a>                
</span><span id=__span-7-277><a id=__codelineno-7-277 name=__codelineno-7-277></a><a href=#__codelineno-7-277><span class=linenos data-linenos="277 "></span></a>                <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span>
</span><span id=__span-7-278><a id=__codelineno-7-278 name=__codelineno-7-278></a><a href=#__codelineno-7-278><span class=linenos data-linenos="278 "></span></a>                    <span class=n>success</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-7-279><a id=__codelineno-7-279 name=__codelineno-7-279></a><a href=#__codelineno-7-279><span class=linenos data-linenos="279 "></span></a>                    <span class=n>metadata</span><span class=o>=</span><span class=p>{</span>
</span><span id=__span-7-280><a id=__codelineno-7-280 name=__codelineno-7-280></a><a href=#__codelineno-7-280><span class=linenos data-linenos="280 "></span></a>                        <span class=s1>&#39;user_id&#39;</span><span class=p>:</span> <span class=n>new_user</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span><span id=__span-7-281><a id=__codelineno-7-281 name=__codelineno-7-281></a><a href=#__codelineno-7-281><span class=linenos data-linenos="281 "></span></a>                        <span class=s1>&#39;workspace_name&#39;</span><span class=p>:</span> <span class=n>invitation</span><span class=o>.</span><span class=n>workspace</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
</span><span id=__span-7-282><a id=__codelineno-7-282 name=__codelineno-7-282></a><a href=#__codelineno-7-282><span class=linenos data-linenos="282 "></span></a>                        <span class=s1>&#39;role_assigned&#39;</span><span class=p>:</span> <span class=n>invitation</span><span class=o>.</span><span class=n>role</span>
</span><span id=__span-7-283><a id=__codelineno-7-283 name=__codelineno-7-283></a><a href=#__codelineno-7-283><span class=linenos data-linenos="283 "></span></a>                    <span class=p>}</span>
</span><span id=__span-7-284><a id=__codelineno-7-284 name=__codelineno-7-284></a><a href=#__codelineno-7-284><span class=linenos data-linenos="284 "></span></a>                <span class=p>)</span>
</span><span id=__span-7-285><a id=__codelineno-7-285 name=__codelineno-7-285></a><a href=#__codelineno-7-285><span class=linenos data-linenos="285 "></span></a>                
</span><span id=__span-7-286><a id=__codelineno-7-286 name=__codelineno-7-286></a><a href=#__codelineno-7-286><span class=linenos data-linenos="286 "></span></a>        <span class=k>except</span> <span class=n>ExpiredInvitationError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-7-287><a id=__codelineno-7-287 name=__codelineno-7-287></a><a href=#__codelineno-7-287><span class=linenos data-linenos="287 "></span></a>            <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span>
</span><span id=__span-7-288><a id=__codelineno-7-288 name=__codelineno-7-288></a><a href=#__codelineno-7-288><span class=linenos data-linenos="288 "></span></a>                <span class=n>success</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-7-289><a id=__codelineno-7-289 name=__codelineno-7-289></a><a href=#__codelineno-7-289><span class=linenos data-linenos="289 "></span></a>                <span class=n>error</span><span class=o>=</span><span class=s2>&quot;Invitation has expired&quot;</span><span class=p>,</span>
</span><span id=__span-7-290><a id=__codelineno-7-290 name=__codelineno-7-290></a><a href=#__codelineno-7-290><span class=linenos data-linenos="290 "></span></a>                <span class=n>code</span><span class=o>=</span><span class=mi>410</span>
</span><span id=__span-7-291><a id=__codelineno-7-291 name=__codelineno-7-291></a><a href=#__codelineno-7-291><span class=linenos data-linenos="291 "></span></a>            <span class=p>)</span>
</span><span id=__span-7-292><a id=__codelineno-7-292 name=__codelineno-7-292></a><a href=#__codelineno-7-292><span class=linenos data-linenos="292 "></span></a>        <span class=k>except</span> <span class=n>ValidationError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-7-293><a id=__codelineno-7-293 name=__codelineno-7-293></a><a href=#__codelineno-7-293><span class=linenos data-linenos="293 "></span></a>            <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span>
</span><span id=__span-7-294><a id=__codelineno-7-294 name=__codelineno-7-294></a><a href=#__codelineno-7-294><span class=linenos data-linenos="294 "></span></a>                <span class=n>success</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-7-295><a id=__codelineno-7-295 name=__codelineno-7-295></a><a href=#__codelineno-7-295><span class=linenos data-linenos="295 "></span></a>                <span class=n>error</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>),</span>
</span><span id=__span-7-296><a id=__codelineno-7-296 name=__codelineno-7-296></a><a href=#__codelineno-7-296><span class=linenos data-linenos="296 "></span></a>                <span class=n>code</span><span class=o>=</span><span class=mi>400</span>
</span><span id=__span-7-297><a id=__codelineno-7-297 name=__codelineno-7-297></a><a href=#__codelineno-7-297><span class=linenos data-linenos="297 "></span></a>            <span class=p>)</span>
</span><span id=__span-7-298><a id=__codelineno-7-298 name=__codelineno-7-298></a><a href=#__codelineno-7-298><span class=linenos data-linenos="298 "></span></a>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-7-299><a id=__codelineno-7-299 name=__codelineno-7-299></a><a href=#__codelineno-7-299><span class=linenos data-linenos="299 "></span></a>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Invitation acceptance error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span> <span class=n>exc_info</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-7-300><a id=__codelineno-7-300 name=__codelineno-7-300></a><a href=#__codelineno-7-300><span class=linenos data-linenos="300 "></span></a>            <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span>
</span><span id=__span-7-301><a id=__codelineno-7-301 name=__codelineno-7-301></a><a href=#__codelineno-7-301><span class=linenos data-linenos="301 "></span></a>                <span class=n>success</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-7-302><a id=__codelineno-7-302 name=__codelineno-7-302></a><a href=#__codelineno-7-302><span class=linenos data-linenos="302 "></span></a>                <span class=n>error</span><span class=o>=</span><span class=s2>&quot;Unable to accept invitation&quot;</span><span class=p>,</span>
</span><span id=__span-7-303><a id=__codelineno-7-303 name=__codelineno-7-303></a><a href=#__codelineno-7-303><span class=linenos data-linenos="303 "></span></a>                <span class=n>code</span><span class=o>=</span><span class=mi>500</span>
</span><span id=__span-7-304><a id=__codelineno-7-304 name=__codelineno-7-304></a><a href=#__codelineno-7-304><span class=linenos data-linenos="304 "></span></a>            <span class=p>)</span>
</span><span id=__span-7-305><a id=__codelineno-7-305 name=__codelineno-7-305></a><a href=#__codelineno-7-305><span class=linenos data-linenos="305 "></span></a>    
</span><span id=__span-7-306><a id=__codelineno-7-306 name=__codelineno-7-306></a><a href=#__codelineno-7-306><span class=linenos data-linenos="306 "></span></a>    <span class=k>def</span> <span class=nf>send_bulk_invitations</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>admin_user</span><span class=p>:</span> <span class=n>User</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> 
</span><span id=__span-7-307><a id=__codelineno-7-307 name=__codelineno-7-307></a><a href=#__codelineno-7-307><span class=linenos data-linenos="307 "></span></a>                            <span class=n>emails</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span> <span class=n>role</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>InvitationResult</span><span class=p>]:</span>
</span><span id=__span-7-308><a id=__codelineno-7-308 name=__codelineno-7-308></a><a href=#__codelineno-7-308><span class=linenos data-linenos="308 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-7-309><a id=__codelineno-7-309 name=__codelineno-7-309></a><a href=#__codelineno-7-309><span class=linenos data-linenos="309 "></span></a><span class=sd>        Efficiently send multiple invitations with batch processing</span>
</span><span id=__span-7-310><a id=__codelineno-7-310 name=__codelineno-7-310></a><a href=#__codelineno-7-310><span class=linenos data-linenos="310 "></span></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-7-311><a id=__codelineno-7-311 name=__codelineno-7-311></a><a href=#__codelineno-7-311><span class=linenos data-linenos="311 "></span></a>        
</span><span id=__span-7-312><a id=__codelineno-7-312 name=__codelineno-7-312></a><a href=#__codelineno-7-312><span class=linenos data-linenos="312 "></span></a>        <span class=k>try</span><span class=p>:</span>
</span><span id=__span-7-313><a id=__codelineno-7-313 name=__codelineno-7-313></a><a href=#__codelineno-7-313><span class=linenos data-linenos="313 "></span></a>            <span class=c1># Use bulk strategy for performance</span>
</span><span id=__span-7-314><a id=__codelineno-7-314 name=__codelineno-7-314></a><a href=#__codelineno-7-314><span class=linenos data-linenos="314 "></span></a>            <span class=n>invitation_data</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-7-315><a id=__codelineno-7-315 name=__codelineno-7-315></a><a href=#__codelineno-7-315><span class=linenos data-linenos="315 "></span></a>                <span class=s1>&#39;emails&#39;</span><span class=p>:</span> <span class=n>emails</span><span class=p>,</span>
</span><span id=__span-7-316><a id=__codelineno-7-316 name=__codelineno-7-316></a><a href=#__codelineno-7-316><span class=linenos data-linenos="316 "></span></a>                <span class=s1>&#39;role&#39;</span><span class=p>:</span> <span class=n>role</span><span class=p>,</span>
</span><span id=__span-7-317><a id=__codelineno-7-317 name=__codelineno-7-317></a><a href=#__codelineno-7-317><span class=linenos data-linenos="317 "></span></a>                <span class=s1>&#39;workspace_id&#39;</span><span class=p>:</span> <span class=n>workspace_id</span><span class=p>,</span>
</span><span id=__span-7-318><a id=__codelineno-7-318 name=__codelineno-7-318></a><a href=#__codelineno-7-318><span class=linenos data-linenos="318 "></span></a>                <span class=s1>&#39;admin_user_id&#39;</span><span class=p>:</span> <span class=n>admin_user</span><span class=o>.</span><span class=n>id</span>
</span><span id=__span-7-319><a id=__codelineno-7-319 name=__codelineno-7-319></a><a href=#__codelineno-7-319><span class=linenos data-linenos="319 "></span></a>            <span class=p>}</span>
</span><span id=__span-7-320><a id=__codelineno-7-320 name=__codelineno-7-320></a><a href=#__codelineno-7-320><span class=linenos data-linenos="320 "></span></a>            
</span><span id=__span-7-321><a id=__codelineno-7-321 name=__codelineno-7-321></a><a href=#__codelineno-7-321><span class=linenos data-linenos="321 "></span></a>            <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-7-322><a id=__codelineno-7-322 name=__codelineno-7-322></a><a href=#__codelineno-7-322><span class=linenos data-linenos="322 "></span></a>            <span class=n>batch_size</span> <span class=o>=</span> <span class=mi>10</span>  <span class=c1># Process in batches to avoid overwhelming email service</span>
</span><span id=__span-7-323><a id=__codelineno-7-323 name=__codelineno-7-323></a><a href=#__codelineno-7-323><span class=linenos data-linenos="323 "></span></a>            
</span><span id=__span-7-324><a id=__codelineno-7-324 name=__codelineno-7-324></a><a href=#__codelineno-7-324><span class=linenos data-linenos="324 "></span></a>            <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>emails</span><span class=p>),</span> <span class=n>batch_size</span><span class=p>):</span>
</span><span id=__span-7-325><a id=__codelineno-7-325 name=__codelineno-7-325></a><a href=#__codelineno-7-325><span class=linenos data-linenos="325 "></span></a>                <span class=n>batch_emails</span> <span class=o>=</span> <span class=n>emails</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span> <span class=o>+</span> <span class=n>batch_size</span><span class=p>]</span>
</span><span id=__span-7-326><a id=__codelineno-7-326 name=__codelineno-7-326></a><a href=#__codelineno-7-326><span class=linenos data-linenos="326 "></span></a>                <span class=n>batch_results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_process_invitation_batch</span><span class=p>(</span>
</span><span id=__span-7-327><a id=__codelineno-7-327 name=__codelineno-7-327></a><a href=#__codelineno-7-327><span class=linenos data-linenos="327 "></span></a>                    <span class=n>admin_user</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>,</span> <span class=n>batch_emails</span><span class=p>,</span> <span class=n>role</span>
</span><span id=__span-7-328><a id=__codelineno-7-328 name=__codelineno-7-328></a><a href=#__codelineno-7-328><span class=linenos data-linenos="328 "></span></a>                <span class=p>)</span>
</span><span id=__span-7-329><a id=__codelineno-7-329 name=__codelineno-7-329></a><a href=#__codelineno-7-329><span class=linenos data-linenos="329 "></span></a>                <span class=n>results</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>batch_results</span><span class=p>)</span>
</span><span id=__span-7-330><a id=__codelineno-7-330 name=__codelineno-7-330></a><a href=#__codelineno-7-330><span class=linenos data-linenos="330 "></span></a>            
</span><span id=__span-7-331><a id=__codelineno-7-331 name=__codelineno-7-331></a><a href=#__codelineno-7-331><span class=linenos data-linenos="331 "></span></a>            <span class=k>return</span> <span class=n>results</span>
</span><span id=__span-7-332><a id=__codelineno-7-332 name=__codelineno-7-332></a><a href=#__codelineno-7-332><span class=linenos data-linenos="332 "></span></a>            
</span><span id=__span-7-333><a id=__codelineno-7-333 name=__codelineno-7-333></a><a href=#__codelineno-7-333><span class=linenos data-linenos="333 "></span></a>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-7-334><a id=__codelineno-7-334 name=__codelineno-7-334></a><a href=#__codelineno-7-334><span class=linenos data-linenos="334 "></span></a>            <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Bulk invitation error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span> <span class=n>exc_info</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span><span id=__span-7-335><a id=__codelineno-7-335 name=__codelineno-7-335></a><a href=#__codelineno-7-335><span class=linenos data-linenos="335 "></span></a>            <span class=c1># Return error result for each email</span>
</span><span id=__span-7-336><a id=__codelineno-7-336 name=__codelineno-7-336></a><a href=#__codelineno-7-336><span class=linenos data-linenos="336 "></span></a>            <span class=k>return</span> <span class=p>[</span>
</span><span id=__span-7-337><a id=__codelineno-7-337 name=__codelineno-7-337></a><a href=#__codelineno-7-337><span class=linenos data-linenos="337 "></span></a>                <span class=n>InvitationResult</span><span class=p>(</span>
</span><span id=__span-7-338><a id=__codelineno-7-338 name=__codelineno-7-338></a><a href=#__codelineno-7-338><span class=linenos data-linenos="338 "></span></a>                    <span class=n>success</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-7-339><a id=__codelineno-7-339 name=__codelineno-7-339></a><a href=#__codelineno-7-339><span class=linenos data-linenos="339 "></span></a>                    <span class=n>error</span><span class=o>=</span><span class=s2>&quot;Bulk invitation failed&quot;</span><span class=p>,</span>
</span><span id=__span-7-340><a id=__codelineno-7-340 name=__codelineno-7-340></a><a href=#__codelineno-7-340><span class=linenos data-linenos="340 "></span></a>                    <span class=n>code</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span>
</span><span id=__span-7-341><a id=__codelineno-7-341 name=__codelineno-7-341></a><a href=#__codelineno-7-341><span class=linenos data-linenos="341 "></span></a>                    <span class=n>metadata</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;email&#39;</span><span class=p>:</span> <span class=n>email</span><span class=p>}</span>
</span><span id=__span-7-342><a id=__codelineno-7-342 name=__codelineno-7-342></a><a href=#__codelineno-7-342><span class=linenos data-linenos="342 "></span></a>                <span class=p>)</span>
</span><span id=__span-7-343><a id=__codelineno-7-343 name=__codelineno-7-343></a><a href=#__codelineno-7-343><span class=linenos data-linenos="343 "></span></a>                <span class=k>for</span> <span class=n>email</span> <span class=ow>in</span> <span class=n>emails</span>
</span><span id=__span-7-344><a id=__codelineno-7-344 name=__codelineno-7-344></a><a href=#__codelineno-7-344><span class=linenos data-linenos="344 "></span></a>            <span class=p>]</span>
</span><span id=__span-7-345><a id=__codelineno-7-345 name=__codelineno-7-345></a><a href=#__codelineno-7-345><span class=linenos data-linenos="345 "></span></a>    
</span><span id=__span-7-346><a id=__codelineno-7-346 name=__codelineno-7-346></a><a href=#__codelineno-7-346><span class=linenos data-linenos="346 "></span></a>    <span class=c1># Private helper methods for clean separation of concerns</span>
</span><span id=__span-7-347><a id=__codelineno-7-347 name=__codelineno-7-347></a><a href=#__codelineno-7-347><span class=linenos data-linenos="347 "></span></a>    <span class=nd>@contextmanager</span>
</span><span id=__span-7-348><a id=__codelineno-7-348 name=__codelineno-7-348></a><a href=#__codelineno-7-348><span class=linenos data-linenos="348 "></span></a>    <span class=k>def</span> <span class=nf>_invitation_transaction</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-7-349><a id=__codelineno-7-349 name=__codelineno-7-349></a><a href=#__codelineno-7-349><span class=linenos data-linenos="349 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Database transaction context manager&quot;&quot;&quot;</span>
</span><span id=__span-7-350><a id=__codelineno-7-350 name=__codelineno-7-350></a><a href=#__codelineno-7-350><span class=linenos data-linenos="350 "></span></a>        <span class=k>try</span><span class=p>:</span>
</span><span id=__span-7-351><a id=__codelineno-7-351 name=__codelineno-7-351></a><a href=#__codelineno-7-351><span class=linenos data-linenos="351 "></span></a>            <span class=k>yield</span>
</span><span id=__span-7-352><a id=__codelineno-7-352 name=__codelineno-7-352></a><a href=#__codelineno-7-352><span class=linenos data-linenos="352 "></span></a>            <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span><span id=__span-7-353><a id=__codelineno-7-353 name=__codelineno-7-353></a><a href=#__codelineno-7-353><span class=linenos data-linenos="353 "></span></a>        <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span><span id=__span-7-354><a id=__codelineno-7-354 name=__codelineno-7-354></a><a href=#__codelineno-7-354><span class=linenos data-linenos="354 "></span></a>            <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span><span id=__span-7-355><a id=__codelineno-7-355 name=__codelineno-7-355></a><a href=#__codelineno-7-355><span class=linenos data-linenos="355 "></span></a>            <span class=k>raise</span>
</span><span id=__span-7-356><a id=__codelineno-7-356 name=__codelineno-7-356></a><a href=#__codelineno-7-356><span class=linenos data-linenos="356 "></span></a>    
</span><span id=__span-7-357><a id=__codelineno-7-357 name=__codelineno-7-357></a><a href=#__codelineno-7-357><span class=linenos data-linenos="357 "></span></a>    <span class=k>def</span> <span class=nf>_validate_invitation_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>admin_user</span><span class=p>:</span> <span class=n>User</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> 
</span><span id=__span-7-358><a id=__codelineno-7-358 name=__codelineno-7-358></a><a href=#__codelineno-7-358><span class=linenos data-linenos="358 "></span></a>                                   <span class=n>email</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>role</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span><span id=__span-7-359><a id=__codelineno-7-359 name=__codelineno-7-359></a><a href=#__codelineno-7-359><span class=linenos data-linenos="359 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Comprehensive validation of invitation request&quot;&quot;&quot;</span>
</span><span id=__span-7-360><a id=__codelineno-7-360 name=__codelineno-7-360></a><a href=#__codelineno-7-360><span class=linenos data-linenos="360 "></span></a>        
</span><span id=__span-7-361><a id=__codelineno-7-361 name=__codelineno-7-361></a><a href=#__codelineno-7-361><span class=linenos data-linenos="361 "></span></a>        <span class=c1># Permission validation</span>
</span><span id=__span-7-362><a id=__codelineno-7-362 name=__codelineno-7-362></a><a href=#__codelineno-7-362><span class=linenos data-linenos="362 "></span></a>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>_is_workspace_admin</span><span class=p>(</span><span class=n>admin_user</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>):</span>
</span><span id=__span-7-363><a id=__codelineno-7-363 name=__codelineno-7-363></a><a href=#__codelineno-7-363><span class=linenos data-linenos="363 "></span></a>            <span class=k>raise</span> <span class=ne>PermissionError</span><span class=p>(</span><span class=s2>&quot;Insufficient permissions to send invitations&quot;</span><span class=p>)</span>
</span><span id=__span-7-364><a id=__codelineno-7-364 name=__codelineno-7-364></a><a href=#__codelineno-7-364><span class=linenos data-linenos="364 "></span></a>        
</span><span id=__span-7-365><a id=__codelineno-7-365 name=__codelineno-7-365></a><a href=#__codelineno-7-365><span class=linenos data-linenos="365 "></span></a>        <span class=c1># Role validation with permission hierarchy</span>
</span><span id=__span-7-366><a id=__codelineno-7-366 name=__codelineno-7-366></a><a href=#__codelineno-7-366><span class=linenos data-linenos="366 "></span></a>        <span class=n>admin_role</span> <span class=o>=</span> <span class=n>UserRole</span><span class=p>(</span><span class=n>admin_user</span><span class=o>.</span><span class=n>role</span><span class=p>)</span>
</span><span id=__span-7-367><a id=__codelineno-7-367 name=__codelineno-7-367></a><a href=#__codelineno-7-367><span class=linenos data-linenos="367 "></span></a>        <span class=n>target_role</span> <span class=o>=</span> <span class=n>UserRole</span><span class=p>(</span><span class=n>role</span><span class=p>)</span>
</span><span id=__span-7-368><a id=__codelineno-7-368 name=__codelineno-7-368></a><a href=#__codelineno-7-368><span class=linenos data-linenos="368 "></span></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>admin_role</span><span class=o>.</span><span class=n>can_invite_role</span><span class=p>(</span><span class=n>target_role</span><span class=p>):</span>
</span><span id=__span-7-369><a id=__codelineno-7-369 name=__codelineno-7-369></a><a href=#__codelineno-7-369><span class=linenos data-linenos="369 "></span></a>            <span class=k>raise</span> <span class=ne>PermissionError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Cannot invite users with </span><span class=si>{</span><span class=n>role</span><span class=si>}</span><span class=s2> role&quot;</span><span class=p>)</span>
</span><span id=__span-7-370><a id=__codelineno-7-370 name=__codelineno-7-370></a><a href=#__codelineno-7-370><span class=linenos data-linenos="370 "></span></a>        
</span><span id=__span-7-371><a id=__codelineno-7-371 name=__codelineno-7-371></a><a href=#__codelineno-7-371><span class=linenos data-linenos="371 "></span></a>        <span class=c1># Email validation</span>
</span><span id=__span-7-372><a id=__codelineno-7-372 name=__codelineno-7-372></a><a href=#__codelineno-7-372><span class=linenos data-linenos="372 "></span></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>EmailValidator</span><span class=o>.</span><span class=n>is_valid</span><span class=p>(</span><span class=n>email</span><span class=p>):</span>
</span><span id=__span-7-373><a id=__codelineno-7-373 name=__codelineno-7-373></a><a href=#__codelineno-7-373><span class=linenos data-linenos="373 "></span></a>            <span class=k>raise</span> <span class=n>ValidationError</span><span class=p>(</span><span class=s2>&quot;Invalid email address format&quot;</span><span class=p>)</span>
</span><span id=__span-7-374><a id=__codelineno-7-374 name=__codelineno-7-374></a><a href=#__codelineno-7-374><span class=linenos data-linenos="374 "></span></a>        
</span><span id=__span-7-375><a id=__codelineno-7-375 name=__codelineno-7-375></a><a href=#__codelineno-7-375><span class=linenos data-linenos="375 "></span></a>        <span class=c1># Domain validation (if configured)</span>
</span><span id=__span-7-376><a id=__codelineno-7-376 name=__codelineno-7-376></a><a href=#__codelineno-7-376><span class=linenos data-linenos="376 "></span></a>        <span class=k>if</span> <span class=n>current_app</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;RESTRICTED_EMAIL_DOMAINS&#39;</span><span class=p>):</span>
</span><span id=__span-7-377><a id=__codelineno-7-377 name=__codelineno-7-377></a><a href=#__codelineno-7-377><span class=linenos data-linenos="377 "></span></a>            <span class=k>if</span> <span class=ow>not</span> <span class=n>EmailValidator</span><span class=o>.</span><span class=n>is_allowed_domain</span><span class=p>(</span><span class=n>email</span><span class=p>):</span>
</span><span id=__span-7-378><a id=__codelineno-7-378 name=__codelineno-7-378></a><a href=#__codelineno-7-378><span class=linenos data-linenos="378 "></span></a>                <span class=k>raise</span> <span class=n>ValidationError</span><span class=p>(</span><span class=s2>&quot;Email domain not allowed&quot;</span><span class=p>)</span>
</span><span id=__span-7-379><a id=__codelineno-7-379 name=__codelineno-7-379></a><a href=#__codelineno-7-379><span class=linenos data-linenos="379 "></span></a>    
</span><span id=__span-7-380><a id=__codelineno-7-380 name=__codelineno-7-380></a><a href=#__codelineno-7-380><span class=linenos data-linenos="380 "></span></a>    <span class=k>def</span> <span class=nf>_validate_invitation_token</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>token</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Invitation</span><span class=p>:</span>
</span><span id=__span-7-381><a id=__codelineno-7-381 name=__codelineno-7-381></a><a href=#__codelineno-7-381><span class=linenos data-linenos="381 "></span></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Validate invitation token and return invitation&quot;&quot;&quot;</span>
</span><span id=__span-7-382><a id=__codelineno-7-382 name=__codelineno-7-382></a><a href=#__codelineno-7-382><span class=linenos data-linenos="382 "></span></a>        
</span><span id=__span-7-383><a id=__codelineno-7-383 name=__codelineno-7-383></a><a href=#__codelineno-7-383><span class=linenos data-linenos="383 "></span></a>        <span class=n>invitation</span> <span class=o>=</span> <span class=n>Invitation</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>filter_by</span><span class=p>(</span><span class=n>token</span><span class=o>=</span><span class=n>token</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
</span><span id=__span-7-384><a id=__codelineno-7-384 name=__codelineno-7-384></a><a href=#__codelineno-7-384><span class=linenos data-linenos="384 "></span></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>invitation</span><span class=p>:</span>
</span><span id=__span-7-385><a id=__codelineno-7-385 name=__codelineno-7-385></a><a href=#__codelineno-7-385><span class=linenos data-linenos="385 "></span></a>            <span class=k>raise</span> <span class=n>ValidationError</span><span class=p>(</span><span class=s2>&quot;Invalid invitation token&quot;</span><span class=p>)</span>
</span><span id=__span-7-386><a id=__codelineno-7-386 name=__codelineno-7-386></a><a href=#__codelineno-7-386><span class=linenos data-linenos="386 "></span></a>        
</span><span id=__span-7-387><a id=__codelineno-7-387 name=__codelineno-7-387></a><a href=#__codelineno-7-387><span class=linenos data-linenos="387 "></span></a>        <span class=k>if</span> <span class=n>invitation</span><span class=o>.</span><span class=n>expires_at</span> <span class=o>&lt;</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>():</span>
</span><span id=__span-7-388><a id=__codelineno-7-388 name=__codelineno-7-388></a><a href=#__codelineno-7-388><span class=linenos data-linenos="388 "></span></a>            <span class=k>raise</span> <span class=n>ExpiredInvitationError</span><span class=p>(</span><span class=s2>&quot;Invitation has expired&quot;</span><span class=p>)</span>
</span><span id=__span-7-389><a id=__codelineno-7-389 name=__codelineno-7-389></a><a href=#__codelineno-7-389><span class=linenos data-linenos="389 "></span></a>        
</span><span id=__span-7-390><a id=__codelineno-7-390 name=__codelineno-7-390></a><a href=#__codelineno-7-390><span class=linenos data-linenos="390 "></span></a>        <span class=k>if</span> <span class=n>invitation</span><span class=o>.</span><span class=n>status</span> <span class=o>!=</span> <span class=n>InvitationStatus</span><span class=o>.</span><span class=n>PENDING</span><span class=o>.</span><span class=n>value</span><span class=p>:</span>
</span><span id=__span-7-391><a id=__codelineno-7-391 name=__codelineno-7-391></a><a href=#__codelineno-7-391><span class=linenos data-linenos="391 "></span></a>            <span class=k>raise</span> <span class=n>ValidationError</span><span class=p>(</span><span class=s2>&quot;Invitation is no longer valid&quot;</span><span class=p>)</span>
</span><span id=__span-7-392><a id=__codelineno-7-392 name=__codelineno-7-392></a><a href=#__codelineno-7-392><span class=linenos data-linenos="392 "></span></a>        
</span><span id=__span-7-393><a id=__codelineno-7-393 name=__codelineno-7-393></a><a href=#__codelineno-7-393><span class=linenos data-linenos="393 "></span></a>        <span class=k>return</span> <span class=n>invitation</span>
</span><span id=__span-7-394><a id=__codelineno-7-394 name=__codelineno-7-394></a><a href=#__codelineno-7-394><span class=linenos data-linenos="394 "></span></a>    
</span><span id=__span-7-395><a id=__codelineno-7-395 name=__codelineno-7-395></a><a href=#__codelineno-7-395><span class=linenos data-linenos="395 "></span></a>    <span class=c1># ... Additional helper methods for email sending, user creation, etc.</span>
</span><span id=__span-7-396><a id=__codelineno-7-396 name=__codelineno-7-396></a><a href=#__codelineno-7-396><span class=linenos data-linenos="396 "></span></a>
</span><span id=__span-7-397><a id=__codelineno-7-397 name=__codelineno-7-397></a><a href=#__codelineno-7-397><span class=linenos data-linenos="397 "></span></a><span class=c1># Factory function for dependency injection</span>
</span><span id=__span-7-398><a id=__codelineno-7-398 name=__codelineno-7-398></a><a href=#__codelineno-7-398><span class=linenos data-linenos="398 "></span></a><span class=k>def</span> <span class=nf>create_invitation_service</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=n>InvitationService</span><span class=p>:</span>
</span><span id=__span-7-399><a id=__codelineno-7-399 name=__codelineno-7-399></a><a href=#__codelineno-7-399><span class=linenos data-linenos="399 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Create configured invitation service instance&quot;&quot;&quot;</span>
</span><span id=__span-7-400><a id=__codelineno-7-400 name=__codelineno-7-400></a><a href=#__codelineno-7-400><span class=linenos data-linenos="400 "></span></a>    <span class=k>return</span> <span class=n>InvitationService</span><span class=p>()</span>
</span><span id=__span-7-401><a id=__codelineno-7-401 name=__codelineno-7-401></a><a href=#__codelineno-7-401><span class=linenos data-linenos="401 "></span></a>
</span><span id=__span-7-402><a id=__codelineno-7-402 name=__codelineno-7-402></a><a href=#__codelineno-7-402><span class=linenos data-linenos="402 "></span></a><span class=c1># Backward compatibility - simple API that uses the service</span>
</span><span id=__span-7-403><a id=__codelineno-7-403 name=__codelineno-7-403></a><a href=#__codelineno-7-403><span class=linenos data-linenos="403 "></span></a><span class=k>def</span> <span class=nf>send_invitation</span><span class=p>(</span><span class=n>admin_user</span><span class=p>:</span> <span class=n>User</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>email</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>role</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> 
</span><span id=__span-7-404><a id=__codelineno-7-404 name=__codelineno-7-404></a><a href=#__codelineno-7-404><span class=linenos data-linenos="404 "></span></a>                   <span class=n>message</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>InvitationResult</span><span class=p>:</span>
</span><span id=__span-7-405><a id=__codelineno-7-405 name=__codelineno-7-405></a><a href=#__codelineno-7-405><span class=linenos data-linenos="405 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Simple API for sending invitations&quot;&quot;&quot;</span>
</span><span id=__span-7-406><a id=__codelineno-7-406 name=__codelineno-7-406></a><a href=#__codelineno-7-406><span class=linenos data-linenos="406 "></span></a>    <span class=n>service</span> <span class=o>=</span> <span class=n>create_invitation_service</span><span class=p>()</span>
</span><span id=__span-7-407><a id=__codelineno-7-407 name=__codelineno-7-407></a><a href=#__codelineno-7-407><span class=linenos data-linenos="407 "></span></a>    <span class=k>return</span> <span class=n>service</span><span class=o>.</span><span class=n>send_invitation</span><span class=p>(</span><span class=n>admin_user</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>,</span> <span class=n>email</span><span class=p>,</span> <span class=n>role</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span></code></pre></div><p><strong>⏰ 11:00 AM - The Transformation is Complete</strong></p><p>Look what just happened. The Code Agent took working code and transformed it into production-ready, enterprise-grade software. Notice how:</p><ul><li><strong>Strategy Pattern</strong> makes it easy to add new invitation types</li><li><strong>Comprehensive Error Handling</strong> provides clear feedback for every scenario </li><li><strong>Logging and Metrics</strong> give you visibility into system behavior</li><li><strong>Rate Limiting</strong> prevents abuse while maintaining good UX</li><li><strong>Transaction Management</strong> ensures data consistency</li><li><strong>Performance Optimization</strong> handles bulk operations efficiently</li></ul><p>And the most beautiful part? <strong>All 47 tests are still passing.</strong> The refactoring didn't break a single piece of functionality.</p><p><strong>🎊 All Tests Still Pass After Refactoring!</strong></p><div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1></a><a href=#__codelineno-8-1><span class=linenos data-linenos=" 1 "></span></a>$<span class=w> </span>pytest<span class=w> </span>tests/test_team_invitations.py<span class=w> </span>--cov<span class=o>=</span>app.invitations<span class=w> </span>-v
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2></a><a href=#__codelineno-8-2><span class=linenos data-linenos=" 2 "></span></a><span class=o>==================</span><span class=w> </span><span class=nb>test</span><span class=w> </span>session<span class=w> </span><span class=nv>starts</span><span class=w> </span><span class=o>==================</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3></a><a href=#__codelineno-8-3><span class=linenos data-linenos=" 3 "></span></a>tests/test_team_invitations.py::TestTeamInvitationFeature::test_admin_can_invite_new_team_member<span class=w> </span>PASSED
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4></a><a href=#__codelineno-8-4><span class=linenos data-linenos=" 4 "></span></a>tests/test_team_invitations.py::TestTeamInvitationFeature::test_invited_user_can_accept_valid_invitation<span class=w> </span>PASSED
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5></a><a href=#__codelineno-8-5><span class=linenos data-linenos=" 5 "></span></a>...
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6></a><a href=#__codelineno-8-6><span class=linenos data-linenos=" 6 "></span></a>tests/test_team_invitations.py::TestTeamInvitationFeature::test_bulk_invitation_performance<span class=w> </span><span class=nv>PASSED</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7></a><a href=#__codelineno-8-7><span class=linenos data-linenos=" 7 "></span></a>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8></a><a href=#__codelineno-8-8><span class=linenos data-linenos=" 8 "></span></a><span class=o>==================</span><span class=w> </span><span class=m>47</span><span class=w> </span>passed<span class=w> </span><span class=k>in</span><span class=w> </span><span class=m>1</span>.89s<span class=w> </span><span class=o>==================</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9></a><a href=#__codelineno-8-9><span class=linenos data-linenos=" 9 "></span></a>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10></a><a href=#__codelineno-8-10><span class=linenos data-linenos="10 "></span></a>----------<span class=w> </span>coverage<span class=w> </span>report<span class=w> </span>----------
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11></a><a href=#__codelineno-8-11><span class=linenos data-linenos="11 "></span></a>Name<span class=w>                     </span>Stmts<span class=w>   </span>Miss<span class=w>  </span>Cover
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12></a><a href=#__codelineno-8-12><span class=linenos data-linenos="12 "></span></a>--------------------------------------------
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13></a><a href=#__codelineno-8-13><span class=linenos data-linenos="13 "></span></a>app/invitations.py<span class=w>         </span><span class=m>298</span><span class=w>      </span><span class=m>0</span><span class=w>   </span><span class=m>100</span>%
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14></a><a href=#__codelineno-8-14><span class=linenos data-linenos="14 "></span></a>app/utils/validators.py<span class=w>     </span><span class=m>45</span><span class=w>      </span><span class=m>0</span><span class=w>   </span><span class=m>100</span>%
</span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15></a><a href=#__codelineno-8-15><span class=linenos data-linenos="15 "></span></a>app/utils/security.py<span class=w>       </span><span class=m>23</span><span class=w>      </span><span class=m>0</span><span class=w>   </span><span class=m>100</span>%
</span><span id=__span-8-16><a id=__codelineno-8-16 name=__codelineno-8-16></a><a href=#__codelineno-8-16><span class=linenos data-linenos="16 "></span></a>app/email.py<span class=w>                </span><span class=m>67</span><span class=w>      </span><span class=m>0</span><span class=w>   </span><span class=m>100</span>%
</span><span id=__span-8-17><a id=__codelineno-8-17 name=__codelineno-8-17></a><a href=#__codelineno-8-17><span class=linenos data-linenos="17 "></span></a><span class=o>============================================</span>
</span><span id=__span-8-18><a id=__codelineno-8-18 name=__codelineno-8-18></a><a href=#__codelineno-8-18><span class=linenos data-linenos="18 "></span></a>TOTAL<span class=w>                       </span><span class=m>433</span><span class=w>      </span><span class=m>0</span><span class=w>   </span><span class=m>100</span>%
</span></code></pre></div><p><strong>📈 The Final Scorecard (11:15 AM)</strong></p><p>In just over 2 hours, you've built a complete, production-ready team invitation system:</p><div class="language-text highlight"><span class=filename>Text Only</span><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1></a><a href=#__codelineno-9-1><span class=linenos data-linenos="1 "></span></a>✅ Feature Complete: 100%
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2></a><a href=#__codelineno-9-2><span class=linenos data-linenos="2 "></span></a>✅ Test Coverage: 100% (47 comprehensive tests)
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3></a><a href=#__codelineno-9-3><span class=linenos data-linenos="3 "></span></a>✅ Security Validated: All attack vectors covered
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4></a><a href=#__codelineno-9-4><span class=linenos data-linenos="4 "></span></a>✅ Performance Optimized: Bulk operations under 5 seconds
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5></a><a href=#__codelineno-9-5><span class=linenos data-linenos="5 "></span></a>✅ Production Ready: Comprehensive error handling &amp; logging
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6></a><a href=#__codelineno-9-6><span class=linenos data-linenos="6 "></span></a>✅ Maintainable: Clean architecture with design patterns
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7></a><a href=#__codelineno-9-7><span class=linenos data-linenos="7 "></span></a>✅ Documented: Every method has clear documentation
</span></code></pre></div><h3 id=scene-4-the-victory-lap-1115-am>🎬 Scene 4: The Victory Lap (11:15 AM)<a class=headerlink href=#scene-4-the-victory-lap-1115-am title="Permanent link">&para;</a></h3><p>You lean back in your chair and smile. What would have taken a week of stressed coding, debugging, and hair-pulling with traditional methods just took you a relaxing morning with AI-assisted TDD.</p><p>But the real victory isn't the speed—it's the <strong>confidence</strong>. You know this code works because: - Every behavior is specified by a test - Every edge case is covered - Every security concern is validated<br> - Every performance requirement is met - Every line of code has a reason to exist</p><p>When your manager asks "How confident are you that this feature works?", you can say with absolute certainty: <strong>"100% confident. I have 47 tests that prove it."</strong></p><h2 id=chapter-4-the-tdd-evolution-timeline>Chapter 4: The TDD Evolution Timeline<a class=headerlink href=#chapter-4-the-tdd-evolution-timeline title="Permanent link">&para;</a></h2><h3 id=how-code-grows-through-tdd-cycles>📊 How Code Grows Through TDD Cycles<a class=headerlink href=#how-code-grows-through-tdd-cycles title="Permanent link">&para;</a></h3><p>Let's trace the evolution of our invitation system through each TDD cycle. This isn't just theory—this is exactly how the code evolved during our morning adventure:</p><h4 id=cycle-1-the-seed-940-am>🌱 Cycle 1: The Seed (9:40 AM)<a class=headerlink href=#cycle-1-the-seed-940-am title="Permanent link">&para;</a></h4><p><em>"Just make the first test pass"</em></p><div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1></a><a href=#__codelineno-10-1><span class=linenos data-linenos="1 "></span></a><span class=k>def</span> <span class=nf>send_invitation</span><span class=p>(</span><span class=n>admin_user</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>,</span> <span class=n>email</span><span class=p>,</span> <span class=n>role</span><span class=p>):</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2></a><a href=#__codelineno-10-2><span class=linenos data-linenos="2 "></span></a>    <span class=c1># Absolute minimum to make test pass</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3></a><a href=#__codelineno-10-3><span class=linenos data-linenos="3 "></span></a>    <span class=k>if</span> <span class=n>email</span> <span class=o>==</span> <span class=s2>&quot;newbie@example.com&quot;</span><span class=p>:</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4></a><a href=#__codelineno-10-4><span class=linenos data-linenos="4 "></span></a>        <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span><span class=n>success</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>invitation_id</span><span class=o>=</span><span class=s2>&quot;123&quot;</span><span class=p>)</span>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5></a><a href=#__codelineno-10-5><span class=linenos data-linenos="5 "></span></a>    <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span><span class=n>success</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></code></pre></div><p><strong>What the Code Agent was thinking</strong>: <em>"I don't need to solve the whole problem. I just need to make ONE test pass. The other tests will guide me to the full solution."</em></p><h4 id=cycle-2-growing-roots-950-am>🌿 Cycle 2: Growing Roots (9:50 AM)<a class=headerlink href=#cycle-2-growing-roots-950-am title="Permanent link">&para;</a></h4><p><em>"Handle the basic cases"</em></p><div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1></a><a href=#__codelineno-11-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>def</span> <span class=nf>send_invitation</span><span class=p>(</span><span class=n>admin_user</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>,</span> <span class=n>email</span><span class=p>,</span> <span class=n>role</span><span class=p>):</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2></a><a href=#__codelineno-11-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=c1># Basic email validation</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3></a><a href=#__codelineno-11-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=k>if</span> <span class=s2>&quot;@&quot;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>email</span><span class=p>:</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4></a><a href=#__codelineno-11-4><span class=linenos data-linenos=" 4 "></span></a>        <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span><span class=n>success</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>error</span><span class=o>=</span><span class=s2>&quot;Invalid email&quot;</span><span class=p>)</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5></a><a href=#__codelineno-11-5><span class=linenos data-linenos=" 5 "></span></a>    
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6></a><a href=#__codelineno-11-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=c1># Create invitation</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7></a><a href=#__codelineno-11-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=n>invitation</span> <span class=o>=</span> <span class=n>Invitation</span><span class=p>(</span><span class=n>email</span><span class=o>=</span><span class=n>email</span><span class=p>,</span> <span class=n>role</span><span class=o>=</span><span class=n>role</span><span class=p>)</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8></a><a href=#__codelineno-11-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>invitation</span><span class=p>)</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9></a><a href=#__codelineno-11-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10></a><a href=#__codelineno-11-10><span class=linenos data-linenos="10 "></span></a>    
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11></a><a href=#__codelineno-11-11><span class=linenos data-linenos="11 "></span></a>    <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span><span class=n>success</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>invitation_id</span><span class=o>=</span><span class=n>invitation</span><span class=o>.</span><span class=n>id</span><span class=p>)</span>
</span></code></pre></div><p><strong>Tests passing</strong>: 5/47 ✅</p><h4 id=cycle-3-branching-out-1000-am>🌳 Cycle 3: Branching Out (10:00 AM)<a class=headerlink href=#cycle-3-branching-out-1000-am title="Permanent link">&para;</a></h4><p><em>"Add security and validation"</em></p><div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1></a><a href=#__codelineno-12-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>def</span> <span class=nf>send_invitation</span><span class=p>(</span><span class=n>admin_user</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>,</span> <span class=n>email</span><span class=p>,</span> <span class=n>role</span><span class=p>):</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2></a><a href=#__codelineno-12-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=c1># Security checks</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3></a><a href=#__codelineno-12-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=k>if</span> <span class=n>admin_user</span><span class=o>.</span><span class=n>role</span> <span class=o>!=</span> <span class=s2>&quot;admin&quot;</span><span class=p>:</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4></a><a href=#__codelineno-12-4><span class=linenos data-linenos=" 4 "></span></a>        <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span><span class=n>success</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>error</span><span class=o>=</span><span class=s2>&quot;Insufficient permissions&quot;</span><span class=p>)</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5></a><a href=#__codelineno-12-5><span class=linenos data-linenos=" 5 "></span></a>    
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6></a><a href=#__codelineno-12-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=c1># Rate limiting</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7></a><a href=#__codelineno-12-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=k>if</span> <span class=n>too_many_recent_invitations</span><span class=p>(</span><span class=n>admin_user</span><span class=p>):</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8></a><a href=#__codelineno-12-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span><span class=n>success</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>error</span><span class=o>=</span><span class=s2>&quot;Rate limit exceeded&quot;</span><span class=p>)</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9></a><a href=#__codelineno-12-9><span class=linenos data-linenos=" 9 "></span></a>    
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10></a><a href=#__codelineno-12-10><span class=linenos data-linenos="10 "></span></a>    <span class=c1># Email validation with regex</span>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11></a><a href=#__codelineno-12-11><span class=linenos data-linenos="11 "></span></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>is_valid_email</span><span class=p>(</span><span class=n>email</span><span class=p>):</span>
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12></a><a href=#__codelineno-12-12><span class=linenos data-linenos="12 "></span></a>        <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span><span class=n>success</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>error</span><span class=o>=</span><span class=s2>&quot;Invalid email format&quot;</span><span class=p>)</span>
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13></a><a href=#__codelineno-12-13><span class=linenos data-linenos="13 "></span></a>    
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14></a><a href=#__codelineno-12-14><span class=linenos data-linenos="14 "></span></a>    <span class=c1># Create invitation with expiration</span>
</span><span id=__span-12-15><a id=__codelineno-12-15 name=__codelineno-12-15></a><a href=#__codelineno-12-15><span class=linenos data-linenos="15 "></span></a>    <span class=n>invitation</span> <span class=o>=</span> <span class=n>Invitation</span><span class=p>(</span>
</span><span id=__span-12-16><a id=__codelineno-12-16 name=__codelineno-12-16></a><a href=#__codelineno-12-16><span class=linenos data-linenos="16 "></span></a>        <span class=n>email</span><span class=o>=</span><span class=n>email</span><span class=p>,</span> 
</span><span id=__span-12-17><a id=__codelineno-12-17 name=__codelineno-12-17></a><a href=#__codelineno-12-17><span class=linenos data-linenos="17 "></span></a>        <span class=n>role</span><span class=o>=</span><span class=n>role</span><span class=p>,</span> 
</span><span id=__span-12-18><a id=__codelineno-12-18 name=__codelineno-12-18></a><a href=#__codelineno-12-18><span class=linenos data-linenos="18 "></span></a>        <span class=n>expires_at</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span> <span class=o>+</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>7</span><span class=p>)</span>
</span><span id=__span-12-19><a id=__codelineno-12-19 name=__codelineno-12-19></a><a href=#__codelineno-12-19><span class=linenos data-linenos="19 "></span></a>    <span class=p>)</span>
</span><span id=__span-12-20><a id=__codelineno-12-20 name=__codelineno-12-20></a><a href=#__codelineno-12-20><span class=linenos data-linenos="20 "></span></a>    <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>invitation</span><span class=p>)</span>
</span><span id=__span-12-21><a id=__codelineno-12-21 name=__codelineno-12-21></a><a href=#__codelineno-12-21><span class=linenos data-linenos="21 "></span></a>    <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span><span id=__span-12-22><a id=__codelineno-12-22 name=__codelineno-12-22></a><a href=#__codelineno-12-22><span class=linenos data-linenos="22 "></span></a>    
</span><span id=__span-12-23><a id=__codelineno-12-23 name=__codelineno-12-23></a><a href=#__codelineno-12-23><span class=linenos data-linenos="23 "></span></a>    <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span><span class=n>success</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>invitation_id</span><span class=o>=</span><span class=n>invitation</span><span class=o>.</span><span class=n>id</span><span class=p>)</span>
</span></code></pre></div><p><strong>Tests passing</strong>: 23/47 ✅</p><h4 id=cycle-4-full-bloom-1015-am>🌺 Cycle 4: Full Bloom (10:15 AM)<a class=headerlink href=#cycle-4-full-bloom-1015-am title="Permanent link">&para;</a></h4><p><em>"Complete functionality"</em></p><div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1></a><a href=#__codelineno-13-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>class</span> <span class=nc>InvitationService</span><span class=p>:</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2></a><a href=#__codelineno-13-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=k>def</span> <span class=nf>send_invitation</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>admin_user</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>,</span> <span class=n>email</span><span class=p>,</span> <span class=n>role</span><span class=p>,</span> <span class=n>message</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3></a><a href=#__codelineno-13-3><span class=linenos data-linenos=" 3 "></span></a>        <span class=c1># Comprehensive validation</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4></a><a href=#__codelineno-13-4><span class=linenos data-linenos=" 4 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_validate_permissions</span><span class=p>(</span><span class=n>admin_user</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>)</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5></a><a href=#__codelineno-13-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_validate_email</span><span class=p>(</span><span class=n>email</span><span class=p>)</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6></a><a href=#__codelineno-13-6><span class=linenos data-linenos=" 6 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_check_rate_limits</span><span class=p>(</span><span class=n>admin_user</span><span class=p>)</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7></a><a href=#__codelineno-13-7><span class=linenos data-linenos=" 7 "></span></a>        
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8></a><a href=#__codelineno-13-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=c1># Handle duplicates</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9></a><a href=#__codelineno-13-9><span class=linenos data-linenos=" 9 "></span></a>        <span class=n>existing</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_find_existing_invitation</span><span class=p>(</span><span class=n>email</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>)</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10></a><a href=#__codelineno-13-10><span class=linenos data-linenos="10 "></span></a>        <span class=k>if</span> <span class=n>existing</span><span class=p>:</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11></a><a href=#__codelineno-13-11><span class=linenos data-linenos="11 "></span></a>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_update_existing_invitation</span><span class=p>(</span><span class=n>existing</span><span class=p>,</span> <span class=n>role</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12></a><a href=#__codelineno-13-12><span class=linenos data-linenos="12 "></span></a>        
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13></a><a href=#__codelineno-13-13><span class=linenos data-linenos="13 "></span></a>        <span class=c1># Create new invitation</span>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14></a><a href=#__codelineno-13-14><span class=linenos data-linenos="14 "></span></a>        <span class=n>invitation</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_create_invitation</span><span class=p>(</span><span class=n>admin_user</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>,</span> <span class=n>email</span><span class=p>,</span> <span class=n>role</span><span class=p>,</span> <span class=n>message</span><span class=p>)</span>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15></a><a href=#__codelineno-13-15><span class=linenos data-linenos="15 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_send_email</span><span class=p>(</span><span class=n>invitation</span><span class=p>,</span> <span class=n>admin_user</span><span class=p>)</span>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16></a><a href=#__codelineno-13-16><span class=linenos data-linenos="16 "></span></a>        
</span><span id=__span-13-17><a id=__codelineno-13-17 name=__codelineno-13-17></a><a href=#__codelineno-13-17><span class=linenos data-linenos="17 "></span></a>        <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span><span class=n>success</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>invitation_id</span><span class=o>=</span><span class=n>invitation</span><span class=o>.</span><span class=n>id</span><span class=p>)</span>
</span></code></pre></div><p><strong>Tests passing</strong>: 47/47 ✅</p><h4 id=cycle-5-the-masterpiece-1030-1100-am>💎 Cycle 5: The Masterpiece (10:30-11:00 AM)<a class=headerlink href=#cycle-5-the-masterpiece-1030-1100-am title="Permanent link">&para;</a></h4><p><em>"Refactor for beauty and maintainability"</em></p><div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1></a><a href=#__codelineno-14-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>class</span> <span class=nc>InvitationService</span><span class=p>:</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2></a><a href=#__codelineno-14-2><span class=linenos data-linenos=" 2 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Production-ready service with strategy pattern, comprehensive error handling,</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3></a><a href=#__codelineno-14-3><span class=linenos data-linenos=" 3 "></span></a><span class=sd>    performance optimization, and enterprise-grade features&quot;&quot;&quot;</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4></a><a href=#__codelineno-14-4><span class=linenos data-linenos=" 4 "></span></a>    
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5></a><a href=#__codelineno-14-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=k>def</span> <span class=nf>send_invitation</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>admin_user</span><span class=p>:</span> <span class=n>User</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> 
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6></a><a href=#__codelineno-14-6><span class=linenos data-linenos=" 6 "></span></a>                       <span class=n>email</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>role</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>message</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7></a><a href=#__codelineno-14-7><span class=linenos data-linenos=" 7 "></span></a>                       <span class=n>strategy</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;standard&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>InvitationResult</span><span class=p>:</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8></a><a href=#__codelineno-14-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=c1># Clean, well-organized, beautifully documented code</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9></a><a href=#__codelineno-14-9><span class=linenos data-linenos=" 9 "></span></a>        <span class=c1># Strategy pattern for extensibility</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10></a><a href=#__codelineno-14-10><span class=linenos data-linenos="10 "></span></a>        <span class=c1># Comprehensive error handling</span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11></a><a href=#__codelineno-14-11><span class=linenos data-linenos="11 "></span></a>        <span class=c1># Performance optimization</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12></a><a href=#__codelineno-14-12><span class=linenos data-linenos="12 "></span></a>        <span class=c1># Extensive logging and metrics</span>
</span></code></pre></div><p><strong>Tests passing</strong>: 47/47 ✅ (with 100% coverage)</p><h2 id=chapter-5-the-visual-story-of-tdd-success>Chapter 5: The Visual Story of TDD Success<a class=headerlink href=#chapter-5-the-visual-story-of-tdd-success title="Permanent link">&para;</a></h2><h3 id=real-time-progress-tracking>📈 Real-Time Progress Tracking<a class=headerlink href=#real-time-progress-tracking title="Permanent link">&para;</a></h3><p>As you worked through your morning TDD adventure, here's what the progress looked like in real-time:</p><h4 id=the-tdd-dashboard-throughout-the-day>The TDD Dashboard Throughout the Day<a class=headerlink href=#the-tdd-dashboard-throughout-the-day title="Permanent link">&para;</a></h4><p><strong>9:00 AM - The Beginning</strong><div class="language-text highlight"><span class=filename>Text Only</span><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1></a><a href=#__codelineno-15-1><span class=linenos data-linenos=" 1 "></span></a>┌─────────────────────────────────────────────────────────┐
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2></a><a href=#__codelineno-15-2><span class=linenos data-linenos=" 2 "></span></a>│                TDD Progress Dashboard                    │
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3></a><a href=#__codelineno-15-3><span class=linenos data-linenos=" 3 "></span></a>├─────────────────────────────────────────────────────────┤
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4></a><a href=#__codelineno-15-4><span class=linenos data-linenos=" 4 "></span></a>│ Feature: Team Invitations (Starting...)                 │
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5></a><a href=#__codelineno-15-5><span class=linenos data-linenos=" 5 "></span></a>│                                                         │
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6></a><a href=#__codelineno-15-6><span class=linenos data-linenos=" 6 "></span></a>│ Story Progress:                                         │
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7></a><a href=#__codelineno-15-7><span class=linenos data-linenos=" 7 "></span></a>│ INV-1 Send Invites [░░░░░░░░░░░░░░░░░░░░] 0%  PLANNING  │
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8></a><a href=#__codelineno-15-8><span class=linenos data-linenos=" 8 "></span></a>│ INV-2 Accept       [░░░░░░░░░░░░░░░░░░░░] 0%  PENDING   │
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9></a><a href=#__codelineno-15-9><span class=linenos data-linenos=" 9 "></span></a>│ INV-3 Security     [░░░░░░░░░░░░░░░░░░░░] 0%  PENDING   │
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10></a><a href=#__codelineno-15-10><span class=linenos data-linenos="10 "></span></a>│                                                         │
</span><span id=__span-15-11><a id=__codelineno-15-11 name=__codelineno-15-11></a><a href=#__codelineno-15-11><span class=linenos data-linenos="11 "></span></a>│ Test Coverage:  [░░░░░░░░░░░░░░░░░░░░] 0%               │
</span><span id=__span-15-12><a id=__codelineno-15-12 name=__codelineno-15-12></a><a href=#__codelineno-15-12><span class=linenos data-linenos="12 "></span></a>│ Code Quality:   [░░░░░░░░░░░░░░░░░░░░] 0%               │
</span><span id=__span-15-13><a id=__codelineno-15-13 name=__codelineno-15-13></a><a href=#__codelineno-15-13><span class=linenos data-linenos="13 "></span></a>│                                                         │
</span><span id=__span-15-14><a id=__codelineno-15-14 name=__codelineno-15-14></a><a href=#__codelineno-15-14><span class=linenos data-linenos="14 "></span></a>│ Agent Activity:                                         │
</span><span id=__span-15-15><a id=__codelineno-15-15 name=__codelineno-15-15></a><a href=#__codelineno-15-15><span class=linenos data-linenos="15 "></span></a>│ 🎨 Design Agent: Creating specification...              │
</span><span id=__span-15-16><a id=__codelineno-15-16 name=__codelineno-15-16></a><a href=#__codelineno-15-16><span class=linenos data-linenos="16 "></span></a>│ 🔴 QA Agent:     Waiting for specs...                  │
</span><span id=__span-15-17><a id=__codelineno-15-17 name=__codelineno-15-17></a><a href=#__codelineno-15-17><span class=linenos data-linenos="17 "></span></a>│ 🟢 Code Agent:   Waiting for tests...                  │
</span><span id=__span-15-18><a id=__codelineno-15-18 name=__codelineno-15-18></a><a href=#__codelineno-15-18><span class=linenos data-linenos="18 "></span></a>└─────────────────────────────────────────────────────────┘
</span></code></pre></div></p><p><strong>9:35 AM - Tests Created (RED Phase)</strong><div class="language-text highlight"><span class=filename>Text Only</span><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1></a><a href=#__codelineno-16-1><span class=linenos data-linenos=" 1 "></span></a>┌─────────────────────────────────────────────────────────┐
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2></a><a href=#__codelineno-16-2><span class=linenos data-linenos=" 2 "></span></a>│                TDD Progress Dashboard                    │
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3></a><a href=#__codelineno-16-3><span class=linenos data-linenos=" 3 "></span></a>├─────────────────────────────────────────────────────────┤
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4></a><a href=#__codelineno-16-4><span class=linenos data-linenos=" 4 "></span></a>│ Feature: Team Invitations (RED Phase)                   │
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5></a><a href=#__codelineno-16-5><span class=linenos data-linenos=" 5 "></span></a>│                                                         │
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6></a><a href=#__codelineno-16-6><span class=linenos data-linenos=" 6 "></span></a>│ Story Progress:                                         │
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7></a><a href=#__codelineno-16-7><span class=linenos data-linenos=" 7 "></span></a>│ INV-1 Send Invites [████░░░░░░░░░░░░░░░░] 20%  RED     │
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8></a><a href=#__codelineno-16-8><span class=linenos data-linenos=" 8 "></span></a>│ INV-2 Accept       [░░░░░░░░░░░░░░░░░░░░] 0%   PENDING  │
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9></a><a href=#__codelineno-16-9><span class=linenos data-linenos=" 9 "></span></a>│ INV-3 Security     [░░░░░░░░░░░░░░░░░░░░] 0%   PENDING  │
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10></a><a href=#__codelineno-16-10><span class=linenos data-linenos="10 "></span></a>│                                                         │
</span><span id=__span-16-11><a id=__codelineno-16-11 name=__codelineno-16-11></a><a href=#__codelineno-16-11><span class=linenos data-linenos="11 "></span></a>│ Test Coverage:  [████████████████████] 100% (47 tests) │
</span><span id=__span-16-12><a id=__codelineno-16-12 name=__codelineno-16-12></a><a href=#__codelineno-16-12><span class=linenos data-linenos="12 "></span></a>│ Code Coverage:  [░░░░░░░░░░░░░░░░░░░░] 0% (no impl)     │
</span><span id=__span-16-13><a id=__codelineno-16-13 name=__codelineno-16-13></a><a href=#__codelineno-16-13><span class=linenos data-linenos="13 "></span></a>│                                                         │
</span><span id=__span-16-14><a id=__codelineno-16-14 name=__codelineno-16-14></a><a href=#__codelineno-16-14><span class=linenos data-linenos="14 "></span></a>│ Agent Activity:                                         │
</span><span id=__span-16-15><a id=__codelineno-16-15 name=__codelineno-16-15></a><a href=#__codelineno-16-15><span class=linenos data-linenos="15 "></span></a>│ 🔴 QA Agent:     47 comprehensive tests created ✅      │
</span><span id=__span-16-16><a id=__codelineno-16-16 name=__codelineno-16-16></a><a href=#__codelineno-16-16><span class=linenos data-linenos="16 "></span></a>│ 🟢 Code Agent:   Starting implementation...             │
</span><span id=__span-16-17><a id=__codelineno-16-17 name=__codelineno-16-17></a><a href=#__codelineno-16-17><span class=linenos data-linenos="17 "></span></a>│ 📊 Data Agent:   Analyzing test complexity...          │
</span><span id=__span-16-18><a id=__codelineno-16-18 name=__codelineno-16-18></a><a href=#__codelineno-16-18><span class=linenos data-linenos="18 "></span></a>└─────────────────────────────────────────────────────────┘
</span></code></pre></div></p><p><strong>10:15 AM - Implementation Complete (GREEN Phase)</strong><div class="language-text highlight"><span class=filename>Text Only</span><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1></a><a href=#__codelineno-17-1><span class=linenos data-linenos=" 1 "></span></a>┌─────────────────────────────────────────────────────────┐
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2></a><a href=#__codelineno-17-2><span class=linenos data-linenos=" 2 "></span></a>│                TDD Progress Dashboard                    │
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3></a><a href=#__codelineno-17-3><span class=linenos data-linenos=" 3 "></span></a>├─────────────────────────────────────────────────────────┤
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4></a><a href=#__codelineno-17-4><span class=linenos data-linenos=" 4 "></span></a>│ Feature: Team Invitations (GREEN Phase)                 │
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5></a><a href=#__codelineno-17-5><span class=linenos data-linenos=" 5 "></span></a>│                                                         │
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6></a><a href=#__codelineno-17-6><span class=linenos data-linenos=" 6 "></span></a>│ Story Progress:                                         │
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7></a><a href=#__codelineno-17-7><span class=linenos data-linenos=" 7 "></span></a>│ INV-1 Send Invites [████████████████████] 100% GREEN   │
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8></a><a href=#__codelineno-17-8><span class=linenos data-linenos=" 8 "></span></a>│ INV-2 Accept       [████████████████████] 100% GREEN   │
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9></a><a href=#__codelineno-17-9><span class=linenos data-linenos=" 9 "></span></a>│ INV-3 Security     [████████████████████] 100% GREEN   │
</span><span id=__span-17-10><a id=__codelineno-17-10 name=__codelineno-17-10></a><a href=#__codelineno-17-10><span class=linenos data-linenos="10 "></span></a>│                                                         │
</span><span id=__span-17-11><a id=__codelineno-17-11 name=__codelineno-17-11></a><a href=#__codelineno-17-11><span class=linenos data-linenos="11 "></span></a>│ Test Coverage:  [████████████████████] 100% (47/47 ✅) │
</span><span id=__span-17-12><a id=__codelineno-17-12 name=__codelineno-17-12></a><a href=#__codelineno-17-12><span class=linenos data-linenos="12 "></span></a>│ Code Coverage:  [████████████████████] 100%            │
</span><span id=__span-17-13><a id=__codelineno-17-13 name=__codelineno-17-13></a><a href=#__codelineno-17-13><span class=linenos data-linenos="13 "></span></a>│                                                         │
</span><span id=__span-17-14><a id=__codelineno-17-14 name=__codelineno-17-14></a><a href=#__codelineno-17-14><span class=linenos data-linenos="14 "></span></a>│ Agent Activity:                                         │
</span><span id=__span-17-15><a id=__codelineno-17-15 name=__codelineno-17-15></a><a href=#__codelineno-17-15><span class=linenos data-linenos="15 "></span></a>│ 🟢 Code Agent:   All tests passing! Ready to refactor  │
</span><span id=__span-17-16><a id=__codelineno-17-16 name=__codelineno-17-16></a><a href=#__codelineno-17-16><span class=linenos data-linenos="16 "></span></a>│ 📊 Data Agent:   Analyzing performance metrics...      │
</span><span id=__span-17-17><a id=__codelineno-17-17 name=__codelineno-17-17></a><a href=#__codelineno-17-17><span class=linenos data-linenos="17 "></span></a>│ 🔵 Code Agent:   Preparing refactoring plan...         │
</span><span id=__span-17-18><a id=__codelineno-17-18 name=__codelineno-17-18></a><a href=#__codelineno-17-18><span class=linenos data-linenos="18 "></span></a>└─────────────────────────────────────────────────────────┘
</span></code></pre></div></p><p><strong>11:00 AM - Refactoring Complete (REFACTOR Phase)</strong><div class="language-text highlight"><span class=filename>Text Only</span><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1></a><a href=#__codelineno-18-1><span class=linenos data-linenos=" 1 "></span></a>┌─────────────────────────────────────────────────────────┐
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2></a><a href=#__codelineno-18-2><span class=linenos data-linenos=" 2 "></span></a>│                TDD Progress Dashboard                    │
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3></a><a href=#__codelineno-18-3><span class=linenos data-linenos=" 3 "></span></a>├─────────────────────────────────────────────────────────┤
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4></a><a href=#__codelineno-18-4><span class=linenos data-linenos=" 4 "></span></a>│ Feature: Team Invitations (COMPLETE!)                   │
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5></a><a href=#__codelineno-18-5><span class=linenos data-linenos=" 5 "></span></a>│                                                         │
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6></a><a href=#__codelineno-18-6><span class=linenos data-linenos=" 6 "></span></a>│ Story Progress:                                         │
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7></a><a href=#__codelineno-18-7><span class=linenos data-linenos=" 7 "></span></a>│ INV-1 Send Invites [████████████████████] 100% DONE ✨ │
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8></a><a href=#__codelineno-18-8><span class=linenos data-linenos=" 8 "></span></a>│ INV-2 Accept       [████████████████████] 100% DONE ✨ │
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9></a><a href=#__codelineno-18-9><span class=linenos data-linenos=" 9 "></span></a>│ INV-3 Security     [████████████████████] 100% DONE ✨ │
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10></a><a href=#__codelineno-18-10><span class=linenos data-linenos="10 "></span></a>│                                                         │
</span><span id=__span-18-11><a id=__codelineno-18-11 name=__codelineno-18-11></a><a href=#__codelineno-18-11><span class=linenos data-linenos="11 "></span></a>│ Test Coverage:  [████████████████████] 100% (47/47 ✅) │
</span><span id=__span-18-12><a id=__codelineno-18-12 name=__codelineno-18-12></a><a href=#__codelineno-18-12><span class=linenos data-linenos="12 "></span></a>│ Code Quality:   [████████████████████] 100% (refactored)│
</span><span id=__span-18-13><a id=__codelineno-18-13 name=__codelineno-18-13></a><a href=#__codelineno-18-13><span class=linenos data-linenos="13 "></span></a>│                                                         │
</span><span id=__span-18-14><a id=__codelineno-18-14 name=__codelineno-18-14></a><a href=#__codelineno-18-14><span class=linenos data-linenos="14 "></span></a>│ Agent Activity:                                         │
</span><span id=__span-18-15><a id=__codelineno-18-15 name=__codelineno-18-15></a><a href=#__codelineno-18-15><span class=linenos data-linenos="15 "></span></a>│ 🎉 All Agents:   FEATURE COMPLETE! 🚀                  │
</span><span id=__span-18-16><a id=__codelineno-18-16 name=__codelineno-18-16></a><a href=#__codelineno-18-16><span class=linenos data-linenos="16 "></span></a>│ 📊 Data Agent:   Generating success metrics...         │
</span><span id=__span-18-17><a id=__codelineno-18-17 name=__codelineno-18-17></a><a href=#__codelineno-18-17><span class=linenos data-linenos="17 "></span></a>│ 🔒 Security:     All security tests passing ✅         │
</span><span id=__span-18-18><a id=__codelineno-18-18 name=__codelineno-18-18></a><a href=#__codelineno-18-18><span class=linenos data-linenos="18 "></span></a>└─────────────────────────────────────────────────────────┘
</span></code></pre></div></p><h3 id=the-transformation-journey-before-vs-after>The Transformation Journey: Before vs After<a class=headerlink href=#the-transformation-journey-before-vs-after title="Permanent link">&para;</a></h3><p><strong>Traditional Development Journey</strong><pre class=mermaid><code>graph TD
    A[📋 Requirements] --&gt; B[🤔 Guess Implementation]
    B --&gt; C[💻 Write Code]
    C --&gt; D[🐛 Find Bugs]
    D --&gt; E[😰 Fix Bugs]
    E --&gt; F[🔍 More Bugs Found]
    F --&gt; E
    E --&gt; G[😅 Deploy &amp; Pray]
    G --&gt; H[🚨 Production Issues]
    H --&gt; I[😭 Weekend Debugging]
    
    style H fill:#ff6b6b,stroke:#333,stroke-width:3px
    style I fill:#ff6b6b,stroke:#333,stroke-width:3px</code></pre></p><p><strong>AI-Assisted TDD Journey</strong><br><pre class=mermaid><code>graph TD
    A[📋 Requirements] --&gt; B[🎨 Design Agent: Specs]
    B --&gt; C[🔴 QA Agent: Comprehensive Tests]
    C --&gt; D[🟢 Code Agent: Minimal Implementation]
    D --&gt; E[✅ All Tests Pass]
    E --&gt; F[🔵 Code Agent: Beautiful Refactor]
    F --&gt; G[💎 Production-Ready Code]
    G --&gt; H[🚀 Confident Deployment]
    H --&gt; I[😌 Peaceful Sleep]
    
    style G fill:#51cf66,stroke:#333,stroke-width:3px
    style H fill:#51cf66,stroke:#333,stroke-width:3px
    style I fill:#51cf66,stroke:#333,stroke-width:3px</code></pre></p><h2 id=chapter-6-the-success-metrics-that-matter>Chapter 6: The Success Metrics That Matter<a class=headerlink href=#chapter-6-the-success-metrics-that-matter title="Permanent link">&para;</a></h2><h3 id=your-tdd-victory-dashboard>🏆 Your TDD Victory Dashboard<a class=headerlink href=#your-tdd-victory-dashboard title="Permanent link">&para;</a></h3><div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1></a><a href=#__codelineno-19-1><span class=linenos data-linenos="1 "></span></a>/tdd<span class=w> </span>metrics<span class=w> </span>--today
</span></code></pre></div><div class="language-text highlight"><span class=filename>Text Only</span><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1></a><a href=#__codelineno-20-1><span class=linenos data-linenos=" 1 "></span></a>┌─────────────────────────────────────────────────────────┐
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2></a><a href=#__codelineno-20-2><span class=linenos data-linenos=" 2 "></span></a>│            🎯 Today&#39;s TDD Achievement Report            │
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3></a><a href=#__codelineno-20-3><span class=linenos data-linenos=" 3 "></span></a>├─────────────────────────────────────────────────────────┤
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4></a><a href=#__codelineno-20-4><span class=linenos data-linenos=" 4 "></span></a>│ Feature: Team Invitations System                        │
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5></a><a href=#__codelineno-20-5><span class=linenos data-linenos=" 5 "></span></a>│ Time Investment: 2.25 hours                            │
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6></a><a href=#__codelineno-20-6><span class=linenos data-linenos=" 6 "></span></a>│ Traditional Estimate: 1-2 weeks                        │
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7></a><a href=#__codelineno-20-7><span class=linenos data-linenos=" 7 "></span></a>│                                                         │
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8></a><a href=#__codelineno-20-8><span class=linenos data-linenos=" 8 "></span></a>│ 📊 Quality Metrics:                                    │
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9></a><a href=#__codelineno-20-9><span class=linenos data-linenos=" 9 "></span></a>│ ✅ Test Coverage: 100% (47 comprehensive tests)        │
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10></a><a href=#__codelineno-20-10><span class=linenos data-linenos="10 "></span></a>│ ✅ Code Coverage: 100% (433 lines covered)             │
</span><span id=__span-20-11><a id=__codelineno-20-11 name=__codelineno-20-11></a><a href=#__codelineno-20-11><span class=linenos data-linenos="11 "></span></a>│ ✅ Security Tests: 100% (all attack vectors covered)   │
</span><span id=__span-20-12><a id=__codelineno-20-12 name=__codelineno-20-12></a><a href=#__codelineno-20-12><span class=linenos data-linenos="12 "></span></a>│ ✅ Performance: Sub-5s for bulk operations             │
</span><span id=__span-20-13><a id=__codelineno-20-13 name=__codelineno-20-13></a><a href=#__codelineno-20-13><span class=linenos data-linenos="13 "></span></a>│ ✅ Documentation: Every method documented               │
</span><span id=__span-20-14><a id=__codelineno-20-14 name=__codelineno-20-14></a><a href=#__codelineno-20-14><span class=linenos data-linenos="14 "></span></a>│                                                         │
</span><span id=__span-20-15><a id=__codelineno-20-15 name=__codelineno-20-15></a><a href=#__codelineno-20-15><span class=linenos data-linenos="15 "></span></a>│ 🚀 Productivity Gains:                                 │
</span><span id=__span-20-16><a id=__codelineno-20-16 name=__codelineno-20-16></a><a href=#__codelineno-20-16><span class=linenos data-linenos="16 "></span></a>│ Speed Improvement: 20x faster than traditional         │
</span><span id=__span-20-17><a id=__codelineno-20-17 name=__codelineno-20-17></a><a href=#__codelineno-20-17><span class=linenos data-linenos="17 "></span></a>│ Bug Prevention: 47 potential issues caught pre-prod    │
</span><span id=__span-20-18><a id=__codelineno-20-18 name=__codelineno-20-18></a><a href=#__codelineno-20-18><span class=linenos data-linenos="18 "></span></a>│ Refactor Confidence: 100% (comprehensive test safety)  │
</span><span id=__span-20-19><a id=__codelineno-20-19 name=__codelineno-20-19></a><a href=#__codelineno-20-19><span class=linenos data-linenos="19 "></span></a>│ Code Quality: Enterprise-grade from day one            │
</span><span id=__span-20-20><a id=__codelineno-20-20 name=__codelineno-20-20></a><a href=#__codelineno-20-20><span class=linenos data-linenos="20 "></span></a>│                                                         │
</span><span id=__span-20-21><a id=__codelineno-20-21 name=__codelineno-20-21></a><a href=#__codelineno-20-21><span class=linenos data-linenos="21 "></span></a>│ 💰 Business Value:                                     │
</span><span id=__span-20-22><a id=__codelineno-20-22 name=__codelineno-20-22></a><a href=#__codelineno-20-22><span class=linenos data-linenos="22 "></span></a>│ Feature Delivery: On-time (2 hours vs 2 weeks)        │
</span><span id=__span-20-23><a id=__codelineno-20-23 name=__codelineno-20-23></a><a href=#__codelineno-20-23><span class=linenos data-linenos="23 "></span></a>│ Risk Mitigation: Zero production bugs predicted        │
</span><span id=__span-20-24><a id=__codelineno-20-24 name=__codelineno-20-24></a><a href=#__codelineno-20-24><span class=linenos data-linenos="24 "></span></a>│ Team Confidence: High (100% test coverage)             │
</span><span id=__span-20-25><a id=__codelineno-20-25 name=__codelineno-20-25></a><a href=#__codelineno-20-25><span class=linenos data-linenos="25 "></span></a>│ Customer Impact: Immediate enterprise feature delivery  │
</span><span id=__span-20-26><a id=__codelineno-20-26 name=__codelineno-20-26></a><a href=#__codelineno-20-26><span class=linenos data-linenos="26 "></span></a>└─────────────────────────────────────────────────────────┘
</span></code></pre></div><h2 id=chapter-7-meet-your-ai-dream-team>Chapter 7: Meet Your AI Dream Team<a class=headerlink href=#chapter-7-meet-your-ai-dream-team title="Permanent link">&para;</a></h2><h3 id=qa-agent-the-perfectionist-tester>🔴 QA Agent: The Perfectionist Tester<a class=headerlink href=#qa-agent-the-perfectionist-tester title="Permanent link">&para;</a></h3><p><strong>Personality</strong>: <em>"If it can break, I'll find a way to break it."</em></p><p>The QA Agent approaches every feature like a security auditor, quality inspector, and performance engineer rolled into one. It doesn't just write happy path tests—it writes tests for every conceivable way things could go wrong.</p><p><strong>Superpowers:</strong> - <strong>Comprehensive Coverage</strong>: Identifies edge cases you never thought of - <strong>Security Mindset</strong>: Tests for injection attacks, authorization bypasses, rate limiting - <strong>Performance Focus</strong>: Includes load tests and timeout scenarios<br> - <strong>Usability Testing</strong>: Considers user experience and error messaging</p><p><strong>Real Example from Our Morning Adventure:</strong><div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1></a><a href=#__codelineno-21-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1># The QA Agent didn&#39;t just test basic invitation sending.</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2></a><a href=#__codelineno-21-2><span class=linenos data-linenos=" 2 "></span></a><span class=c1># It also tested:</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3></a><a href=#__codelineno-21-3><span class=linenos data-linenos=" 3 "></span></a>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4></a><a href=#__codelineno-21-4><span class=linenos data-linenos=" 4 "></span></a><span class=k>def</span> <span class=nf>test_rate_limiting_prevents_spam_invitations</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5></a><a href=#__codelineno-21-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Admins cannot send more than 10 invitations per hour&quot;&quot;&quot;</span>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6></a><a href=#__codelineno-21-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=c1># This test prevents abuse and protects your email reputation</span>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7></a><a href=#__codelineno-21-7><span class=linenos data-linenos=" 7 "></span></a>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8></a><a href=#__codelineno-21-8><span class=linenos data-linenos=" 8 "></span></a><span class=k>def</span> <span class=nf>test_malformed_email_addresses_rejected</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9></a><a href=#__codelineno-21-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Invalid email formats are rejected&quot;&quot;&quot;</span>
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10></a><a href=#__codelineno-21-10><span class=linenos data-linenos="10 "></span></a>    <span class=n>invalid_emails</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;not-an-email&quot;</span><span class=p>,</span> <span class=s2>&quot;@example.com&quot;</span><span class=p>,</span> <span class=s2>&quot;user@&quot;</span><span class=p>,</span> <span class=o>...</span><span class=p>]</span>
</span><span id=__span-21-11><a id=__codelineno-21-11 name=__codelineno-21-11></a><a href=#__codelineno-21-11><span class=linenos data-linenos="11 "></span></a>    <span class=c1># This test prevents runtime errors and data corruption</span>
</span><span id=__span-21-12><a id=__codelineno-21-12 name=__codelineno-21-12></a><a href=#__codelineno-21-12><span class=linenos data-linenos="12 "></span></a>
</span><span id=__span-21-13><a id=__codelineno-21-13 name=__codelineno-21-13></a><a href=#__codelineno-21-13><span class=linenos data-linenos="13 "></span></a><span class=k>def</span> <span class=nf>test_cannot_invite_to_workspace_without_admin_role</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-21-14><a id=__codelineno-21-14 name=__codelineno-21-14></a><a href=#__codelineno-21-14><span class=linenos data-linenos="14 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Non-admin users cannot send invitations&quot;&quot;&quot;</span>
</span><span id=__span-21-15><a id=__codelineno-21-15 name=__codelineno-21-15></a><a href=#__codelineno-21-15><span class=linenos data-linenos="15 "></span></a>    <span class=c1># This test prevents privilege escalation attacks</span>
</span><span id=__span-21-16><a id=__codelineno-21-16 name=__codelineno-21-16></a><a href=#__codelineno-21-16><span class=linenos data-linenos="16 "></span></a>
</span><span id=__span-21-17><a id=__codelineno-21-17 name=__codelineno-21-17></a><a href=#__codelineno-21-17><span class=linenos data-linenos="17 "></span></a><span class=k>def</span> <span class=nf>test_bulk_invitation_performance</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-21-18><a id=__codelineno-21-18 name=__codelineno-21-18></a><a href=#__codelineno-21-18><span class=linenos data-linenos="18 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;System can handle bulk invitations efficiently&quot;&quot;&quot;</span>
</span><span id=__span-21-19><a id=__codelineno-21-19 name=__codelineno-21-19></a><a href=#__codelineno-21-19><span class=linenos data-linenos="19 "></span></a>    <span class=c1># This test ensures your system scales under load</span>
</span></code></pre></div></p><p><strong>The QA Agent's Secret</strong>: It learns from millions of real-world failures and automatically applies that knowledge to your specific feature.</p><h3 id=code-agent-the-implementation-virtuoso>🟢 Code Agent: The Implementation Virtuoso<a class=headerlink href=#code-agent-the-implementation-virtuoso title="Permanent link">&para;</a></h3><p><strong>Personality</strong>: <em>"Make it work, then make it beautiful."</em></p><p>The Code Agent is a surgical precision coder with an interesting philosophy: it never tries to build the perfect solution immediately. Instead, it follows the TDD principle of making tests pass with the simplest possible implementation, then refactoring to perfection.</p><p><strong>The Code Agent's Two-Phase Approach:</strong></p><p><strong>Phase 1: GREEN - Make It Work</strong><div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1></a><a href=#__codelineno-22-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1># Code Agent&#39;s first implementation - minimal but correct</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2></a><a href=#__codelineno-22-2><span class=linenos data-linenos=" 2 "></span></a><span class=k>def</span> <span class=nf>send_invitation</span><span class=p>(</span><span class=n>admin_user</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>,</span> <span class=n>email</span><span class=p>,</span> <span class=n>role</span><span class=p>):</span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3></a><a href=#__codelineno-22-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=c1># Absolute minimum to make tests pass</span>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4></a><a href=#__codelineno-22-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>admin_user</span><span class=o>.</span><span class=n>is_admin</span><span class=p>:</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5></a><a href=#__codelineno-22-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span><span class=n>success</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>error</span><span class=o>=</span><span class=s2>&quot;Insufficient permissions&quot;</span><span class=p>)</span>
</span><span id=__span-22-6><a id=__codelineno-22-6 name=__codelineno-22-6></a><a href=#__codelineno-22-6><span class=linenos data-linenos=" 6 "></span></a>    
</span><span id=__span-22-7><a id=__codelineno-22-7 name=__codelineno-22-7></a><a href=#__codelineno-22-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=k>if</span> <span class=s2>&quot;@&quot;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>email</span><span class=p>:</span>
</span><span id=__span-22-8><a id=__codelineno-22-8 name=__codelineno-22-8></a><a href=#__codelineno-22-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span><span class=n>success</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>error</span><span class=o>=</span><span class=s2>&quot;Invalid email&quot;</span><span class=p>)</span>
</span><span id=__span-22-9><a id=__codelineno-22-9 name=__codelineno-22-9></a><a href=#__codelineno-22-9><span class=linenos data-linenos=" 9 "></span></a>    
</span><span id=__span-22-10><a id=__codelineno-22-10 name=__codelineno-22-10></a><a href=#__codelineno-22-10><span class=linenos data-linenos="10 "></span></a>    <span class=n>invitation</span> <span class=o>=</span> <span class=n>Invitation</span><span class=p>(</span><span class=n>email</span><span class=o>=</span><span class=n>email</span><span class=p>,</span> <span class=n>role</span><span class=o>=</span><span class=n>role</span><span class=p>,</span> <span class=n>workspace_id</span><span class=o>=</span><span class=n>workspace_id</span><span class=p>)</span>
</span><span id=__span-22-11><a id=__codelineno-22-11 name=__codelineno-22-11></a><a href=#__codelineno-22-11><span class=linenos data-linenos="11 "></span></a>    <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>invitation</span><span class=p>)</span>
</span><span id=__span-22-12><a id=__codelineno-22-12 name=__codelineno-22-12></a><a href=#__codelineno-22-12><span class=linenos data-linenos="12 "></span></a>    <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span><span id=__span-22-13><a id=__codelineno-22-13 name=__codelineno-22-13></a><a href=#__codelineno-22-13><span class=linenos data-linenos="13 "></span></a>    
</span><span id=__span-22-14><a id=__codelineno-22-14 name=__codelineno-22-14></a><a href=#__codelineno-22-14><span class=linenos data-linenos="14 "></span></a>    <span class=k>return</span> <span class=n>InvitationResult</span><span class=p>(</span><span class=n>success</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>invitation_id</span><span class=o>=</span><span class=n>invitation</span><span class=o>.</span><span class=n>id</span><span class=p>)</span>
</span></code></pre></div></p><p><strong>Phase 2: REFACTOR - Make It Beautiful</strong><div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1></a><a href=#__codelineno-23-1><span class=linenos data-linenos="1 "></span></a><span class=c1># Code Agent&#39;s refactored implementation - enterprise-grade</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2></a><a href=#__codelineno-23-2><span class=linenos data-linenos="2 "></span></a><span class=k>class</span> <span class=nc>InvitationService</span><span class=p>:</span>
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3></a><a href=#__codelineno-23-3><span class=linenos data-linenos="3 "></span></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Production-ready invitation service with comprehensive features&quot;&quot;&quot;</span>
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4></a><a href=#__codelineno-23-4><span class=linenos data-linenos="4 "></span></a>    
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5></a><a href=#__codelineno-23-5><span class=linenos data-linenos="5 "></span></a>    <span class=k>def</span> <span class=nf>send_invitation</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>admin_user</span><span class=p>:</span> <span class=n>User</span><span class=p>,</span> <span class=n>workspace_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> 
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6></a><a href=#__codelineno-23-6><span class=linenos data-linenos="6 "></span></a>                       <span class=n>email</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>role</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>message</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span><span id=__span-23-7><a id=__codelineno-23-7 name=__codelineno-23-7></a><a href=#__codelineno-23-7><span class=linenos data-linenos="7 "></span></a>                       <span class=n>strategy</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;standard&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>InvitationResult</span><span class=p>:</span>
</span><span id=__span-23-8><a id=__codelineno-23-8 name=__codelineno-23-8></a><a href=#__codelineno-23-8><span class=linenos data-linenos="8 "></span></a>        <span class=c1># Strategy pattern, comprehensive error handling, logging,</span>
</span><span id=__span-23-9><a id=__codelineno-23-9 name=__codelineno-23-9></a><a href=#__codelineno-23-9><span class=linenos data-linenos="9 "></span></a>        <span class=c1># metrics, rate limiting, security controls, etc.</span>
</span></code></pre></div></p><p><strong>The Code Agent's Superpower</strong>: It can refactor fearlessly because the tests act as a safety net. No matter how drastically it restructures the code, if all tests still pass, the behavior is preserved.</p><h3 id=design-agent-the-architecture-visionary>🎨 Design Agent: The Architecture Visionary<a class=headerlink href=#design-agent-the-architecture-visionary title="Permanent link">&para;</a></h3><p><strong>Personality</strong>: <em>"Let's build this right from the start."</em></p><p>The Design Agent thinks like a senior architect with years of experience. Before any code is written, it creates comprehensive specifications that consider scalability, security, maintainability, and performance.</p><p><strong>The Design Agent's Magic</strong>: It anticipates future requirements and designs systems that can evolve gracefully. When the QA Agent says "we need rate limiting," the Design Agent has already planned for it.</p><p><strong>Real Example from Our Adventure:</strong><div class="language-yaml highlight"><span class=filename>YAML</span><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1></a><a href=#__codelineno-24-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1># The Design Agent didn&#39;t just plan for basic invitations.</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2></a><a href=#__codelineno-24-2><span class=linenos data-linenos=" 2 "></span></a><span class=c1># It designed for enterprise features from day one:</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3></a><a href=#__codelineno-24-3><span class=linenos data-linenos=" 3 "></span></a>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4></a><a href=#__codelineno-24-4><span class=linenos data-linenos=" 4 "></span></a><span class=nt>Team Invitation System Architecture</span><span class=p>:</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5></a><a href=#__codelineno-24-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>  </span><span class=nt>core_patterns</span><span class=p>:</span>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6></a><a href=#__codelineno-24-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>Strategy Pattern</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Multiple invitation types (email, SMS, Slack)</span>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7></a><a href=#__codelineno-24-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>Factory Pattern</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Different user onboarding workflows</span><span class=w>  </span>
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8></a><a href=#__codelineno-24-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>Observer Pattern</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Real-time invitation status updates</span>
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9></a><a href=#__codelineno-24-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span>
</span><span id=__span-24-10><a id=__codelineno-24-10 name=__codelineno-24-10></a><a href=#__codelineno-24-10><span class=linenos data-linenos="10 "></span></a><span class=w>  </span><span class=nt>scalability_features</span><span class=p>:</span>
</span><span id=__span-24-11><a id=__codelineno-24-11 name=__codelineno-24-11></a><a href=#__codelineno-24-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Bulk operations for enterprise customers</span>
</span><span id=__span-24-12><a id=__codelineno-24-12 name=__codelineno-24-12></a><a href=#__codelineno-24-12><span class=linenos data-linenos="12 "></span></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Rate limiting to prevent abuse</span>
</span><span id=__span-24-13><a id=__codelineno-24-13 name=__codelineno-24-13></a><a href=#__codelineno-24-13><span class=linenos data-linenos="13 "></span></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Async email processing to handle load</span>
</span><span id=__span-24-14><a id=__codelineno-24-14 name=__codelineno-24-14></a><a href=#__codelineno-24-14><span class=linenos data-linenos="14 "></span></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Database indexes for fast lookups</span>
</span><span id=__span-24-15><a id=__codelineno-24-15 name=__codelineno-24-15></a><a href=#__codelineno-24-15><span class=linenos data-linenos="15 "></span></a><span class=w>    </span>
</span><span id=__span-24-16><a id=__codelineno-24-16 name=__codelineno-24-16></a><a href=#__codelineno-24-16><span class=linenos data-linenos="16 "></span></a><span class=w>  </span><span class=nt>security_controls</span><span class=p>:</span>
</span><span id=__span-24-17><a id=__codelineno-24-17 name=__codelineno-24-17></a><a href=#__codelineno-24-17><span class=linenos data-linenos="17 "></span></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Token-based authentication with expiration</span>
</span><span id=__span-24-18><a id=__codelineno-24-18 name=__codelineno-24-18></a><a href=#__codelineno-24-18><span class=linenos data-linenos="18 "></span></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Role-based permission validation</span>
</span><span id=__span-24-19><a id=__codelineno-24-19 name=__codelineno-24-19></a><a href=#__codelineno-24-19><span class=linenos data-linenos="19 "></span></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Audit trail for compliance</span>
</span><span id=__span-24-20><a id=__codelineno-24-20 name=__codelineno-24-20></a><a href=#__codelineno-24-20><span class=linenos data-linenos="20 "></span></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Input sanitization for XSS prevention</span>
</span><span id=__span-24-21><a id=__codelineno-24-21 name=__codelineno-24-21></a><a href=#__codelineno-24-21><span class=linenos data-linenos="21 "></span></a><span class=w>    </span>
</span><span id=__span-24-22><a id=__codelineno-24-22 name=__codelineno-24-22></a><a href=#__codelineno-24-22><span class=linenos data-linenos="22 "></span></a><span class=w>  </span><span class=nt>monitoring_and_ops</span><span class=p>:</span>
</span><span id=__span-24-23><a id=__codelineno-24-23 name=__codelineno-24-23></a><a href=#__codelineno-24-23><span class=linenos data-linenos="23 "></span></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Comprehensive logging for debugging</span>
</span><span id=__span-24-24><a id=__codelineno-24-24 name=__codelineno-24-24></a><a href=#__codelineno-24-24><span class=linenos data-linenos="24 "></span></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Metrics collection for performance analysis</span>
</span><span id=__span-24-25><a id=__codelineno-24-25 name=__codelineno-24-25></a><a href=#__codelineno-24-25><span class=linenos data-linenos="25 "></span></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Error tracking for proactive issue resolution</span>
</span><span id=__span-24-26><a id=__codelineno-24-26 name=__codelineno-24-26></a><a href=#__codelineno-24-26><span class=linenos data-linenos="26 "></span></a><span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Health checks for system monitoring</span>
</span></code></pre></div></p><p>The beauty is that this architectural thinking happens <em>before</em> any code is written, ensuring your implementation follows enterprise-grade patterns from the start.</p><h3 id=data-agent-the-analytics-guru>📊 Data Agent: The Analytics Guru<a class=headerlink href=#data-agent-the-analytics-guru title="Permanent link">&para;</a></h3><p><strong>Personality</strong>: <em>"Numbers don't lie, and I love telling their story."</em></p><p>The Data Agent is your TDD performance coach. It tracks every metric, identifies patterns, and provides insights that make you better at TDD over time.</p><p><strong>Real Insights from Our Morning Adventure:</strong><div class="language-text highlight"><span class=filename>Text Only</span><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1></a><a href=#__codelineno-25-1><span class=linenos data-linenos=" 1 "></span></a>📈 TDD Performance Analysis - Team Invitations Feature
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2></a><a href=#__codelineno-25-2><span class=linenos data-linenos=" 2 "></span></a>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3></a><a href=#__codelineno-25-3><span class=linenos data-linenos=" 3 "></span></a>🎯 Cycle Efficiency:
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4></a><a href=#__codelineno-25-4><span class=linenos data-linenos=" 4 "></span></a>- RED Phase: 15 minutes (QA Agent created 47 tests)
</span><span id=__span-25-5><a id=__codelineno-25-5 name=__codelineno-25-5></a><a href=#__codelineno-25-5><span class=linenos data-linenos=" 5 "></span></a>- GREEN Phase: 35 minutes (Code Agent implemented full functionality)  
</span><span id=__span-25-6><a id=__codelineno-25-6 name=__codelineno-25-6></a><a href=#__codelineno-25-6><span class=linenos data-linenos=" 6 "></span></a>- REFACTOR Phase: 30 minutes (Code Agent applied enterprise patterns)
</span><span id=__span-25-7><a id=__codelineno-25-7 name=__codelineno-25-7></a><a href=#__codelineno-25-7><span class=linenos data-linenos=" 7 "></span></a>- Total Time: 1h 20m (Traditional estimate: 1-2 weeks)
</span><span id=__span-25-8><a id=__codelineno-25-8 name=__codelineno-25-8></a><a href=#__codelineno-25-8><span class=linenos data-linenos=" 8 "></span></a>
</span><span id=__span-25-9><a id=__codelineno-25-9 name=__codelineno-25-9></a><a href=#__codelineno-25-9><span class=linenos data-linenos=" 9 "></span></a>📊 Quality Indicators:
</span><span id=__span-25-10><a id=__codelineno-25-10 name=__codelineno-25-10></a><a href=#__codelineno-25-10><span class=linenos data-linenos="10 "></span></a>- Test Coverage: 100% (industry average: 65%)
</span><span id=__span-25-11><a id=__codelineno-25-11 name=__codelineno-25-11></a><a href=#__codelineno-25-11><span class=linenos data-linenos="11 "></span></a>- Defect Prediction: 0 production bugs (based on test quality analysis)
</span><span id=__span-25-12><a id=__codelineno-25-12 name=__codelineno-25-12></a><a href=#__codelineno-25-12><span class=linenos data-linenos="12 "></span></a>- Code Complexity: Low (refactoring phase reduced cyclomatic complexity by 40%)
</span><span id=__span-25-13><a id=__codelineno-25-13 name=__codelineno-25-13></a><a href=#__codelineno-25-13><span class=linenos data-linenos="13 "></span></a>- Maintainability Index: 98/100 (excellent for long-term maintenance)
</span><span id=__span-25-14><a id=__codelineno-25-14 name=__codelineno-25-14></a><a href=#__codelineno-25-14><span class=linenos data-linenos="14 "></span></a>
</span><span id=__span-25-15><a id=__codelineno-25-15 name=__codelineno-25-15></a><a href=#__codelineno-25-15><span class=linenos data-linenos="15 "></span></a>🚀 Productivity Insights:
</span><span id=__span-25-16><a id=__codelineno-25-16 name=__codelineno-25-16></a><a href=#__codelineno-25-16><span class=linenos data-linenos="16 "></span></a>- Speed Factor: 20x faster than traditional development
</span><span id=__span-25-17><a id=__codelineno-25-17 name=__codelineno-25-17></a><a href=#__codelineno-25-17><span class=linenos data-linenos="17 "></span></a>- Quality Factor: 3x higher test coverage than team average
</span><span id=__span-25-18><a id=__codelineno-25-18 name=__codelineno-25-18></a><a href=#__codelineno-25-18><span class=linenos data-linenos="18 "></span></a>- Risk Factor: 95% lower chance of production issues
</span><span id=__span-25-19><a id=__codelineno-25-19 name=__codelineno-25-19></a><a href=#__codelineno-25-19><span class=linenos data-linenos="19 "></span></a>- Learning Factor: Applied 15 enterprise patterns automatically
</span><span id=__span-25-20><a id=__codelineno-25-20 name=__codelineno-25-20></a><a href=#__codelineno-25-20><span class=linenos data-linenos="20 "></span></a>
</span><span id=__span-25-21><a id=__codelineno-25-21 name=__codelineno-25-21></a><a href=#__codelineno-25-21><span class=linenos data-linenos="21 "></span></a>💡 AI Agent Performance:
</span><span id=__span-25-22><a id=__codelineno-25-22 name=__codelineno-25-22></a><a href=#__codelineno-25-22><span class=linenos data-linenos="22 "></span></a>- QA Agent: Identified 23 edge cases human testers typically miss
</span><span id=__span-25-23><a id=__codelineno-25-23 name=__codelineno-25-23></a><a href=#__codelineno-25-23><span class=linenos data-linenos="23 "></span></a>- Code Agent: Applied 7 design patterns during refactoring
</span><span id=__span-25-24><a id=__codelineno-25-24 name=__codelineno-25-24></a><a href=#__codelineno-25-24><span class=linenos data-linenos="24 "></span></a>- Design Agent: Anticipated 12 future requirements in initial spec
</span><span id=__span-25-25><a id=__codelineno-25-25 name=__codelineno-25-25></a><a href=#__codelineno-25-25><span class=linenos data-linenos="25 "></span></a>- Orchestrator: Managed parallel execution saving 45 minutes
</span><span id=__span-25-26><a id=__codelineno-25-26 name=__codelineno-25-26></a><a href=#__codelineno-25-26><span class=linenos data-linenos="26 "></span></a>
</span><span id=__span-25-27><a id=__codelineno-25-27 name=__codelineno-25-27></a><a href=#__codelineno-25-27><span class=linenos data-linenos="27 "></span></a>🎉 Business Impact:
</span><span id=__span-25-28><a id=__codelineno-25-28 name=__codelineno-25-28></a><a href=#__codelineno-25-28><span class=linenos data-linenos="28 "></span></a>- Feature Delivery: On-time (vs 67% team average)
</span><span id=__span-25-29><a id=__codelineno-25-29 name=__codelineno-25-29></a><a href=#__codelineno-25-29><span class=linenos data-linenos="29 "></span></a>- Customer Satisfaction: High confidence in quality
</span><span id=__span-25-30><a id=__codelineno-25-30 name=__codelineno-25-30></a><a href=#__codelineno-25-30><span class=linenos data-linenos="30 "></span></a>- Technical Debt: Zero added (actually reduced existing debt)
</span><span id=__span-25-31><a id=__codelineno-25-31 name=__codelineno-25-31></a><a href=#__codelineno-25-31><span class=linenos data-linenos="31 "></span></a>- Team Velocity: 3.2x improvement for similar features
</span></code></pre></div></p><p>The Data Agent doesn't just report what happened—it provides actionable insights that make your next TDD cycle even better.</p><h2 id=epilogue-your-journey-from-fear-to-confidence>Epilogue: Your Journey from Fear to Confidence<a class=headerlink href=#epilogue-your-journey-from-fear-to-confidence title="Permanent link">&para;</a></h2><h3 id=the-old-way-vs-the-new-way>The Old Way vs The New Way<a class=headerlink href=#the-old-way-vs-the-new-way title="Permanent link">&para;</a></h3><p><strong>Before AI-Assisted TDD (The Friday Afternoon Horror Story):</strong></p><blockquote><p><em>It's 4:30 PM on Friday. Your manager drops by with "just a small feature request" that needs to be ready by Monday. Your stomach sinks. You know this means a weekend of:</em> - <em>Frantic coding without proper planning</em><br> - <em>Praying the code works as you write it</em> - <em>Discovering bugs at the worst possible moments</em> - <em>Stress-induced debugging sessions</em> - <em>Delivering features you're not confident about</em></p></blockquote><p><strong>After AI-Assisted TDD (The Friday Afternoon Victory):</strong></p><blockquote><p><em>It's 4:30 PM on Friday. Your manager drops by with "just a small feature request" that needs to be ready by Monday. You smile and say "No problem." You know this means:</em> - <em>Letting AI agents create comprehensive specifications and tests</em> - <em>Watching all tests pass as the feature comes together</em> - <em>Refactoring to enterprise-grade quality with confidence</em> - <em>Delivering production-ready features in hours</em> - <em>Going home early with complete confidence in your work</em></p></blockquote><h3 id=the-three-pillars-of-tdd-mastery>🎯 The Three Pillars of TDD Mastery<a class=headerlink href=#the-three-pillars-of-tdd-mastery title="Permanent link">&para;</a></h3><p>Through our morning adventure, you've learned that AI-assisted TDD rests on three fundamental pillars:</p><h4 id=1-specification-through-tests>1. <strong>Specification Through Tests</strong><a class=headerlink href=#1-specification-through-tests title="Permanent link">&para;</a></h4><p>Tests aren't just verification—they're executable specifications. When the QA Agent writes 47 tests, it's not just checking if your code works. It's defining exactly what "working" means.</p><h4 id=2-incremental-implementation>2. <strong>Incremental Implementation</strong><a class=headerlink href=#2-incremental-implementation title="Permanent link">&para;</a></h4><p>The Code Agent doesn't try to build the perfect solution immediately. It builds the <em>correct</em> solution incrementally, letting tests guide every decision.</p><h4 id=3-fearless-refactoring>3. <strong>Fearless Refactoring</strong><a class=headerlink href=#3-fearless-refactoring title="Permanent link">&para;</a></h4><p>With comprehensive tests as your safety net, refactoring becomes an art form instead of a dangerous necessity. You can transform working code into beautiful code with complete confidence.</p><h3 id=your-next-steps>🚀 Your Next Steps<a class=headerlink href=#your-next-steps title="Permanent link">&para;</a></h3><p><strong>Week 1: Start Small</strong><div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1></a><a href=#__codelineno-26-1><span class=linenos data-linenos="1 "></span></a><span class=c1># Pick a simple feature for your first AI-TDD experience</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2></a><a href=#__codelineno-26-2><span class=linenos data-linenos="2 "></span></a>/backlog<span class=w> </span>add_story<span class=w> </span><span class=s2>&quot;Add user email validation&quot;</span>
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3></a><a href=#__codelineno-26-3><span class=linenos data-linenos="3 "></span></a>/sprint<span class=w> </span>start
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4></a><a href=#__codelineno-26-4><span class=linenos data-linenos="4 "></span></a><span class=c1># Watch the magic happen</span>
</span></code></pre></div></p><p><strong>Week 2: Build Confidence</strong><div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1></a><a href=#__codelineno-27-1><span class=linenos data-linenos="1 "></span></a><span class=c1># Try a more complex feature</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2></a><a href=#__codelineno-27-2><span class=linenos data-linenos="2 "></span></a>/backlog<span class=w> </span>add_story<span class=w> </span><span class=s2>&quot;Implement password reset flow&quot;</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3></a><a href=#__codelineno-27-3><span class=linenos data-linenos="3 "></span></a>/sprint<span class=w> </span>start
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4></a><a href=#__codelineno-27-4><span class=linenos data-linenos="4 "></span></a><span class=c1># Notice how much easier it is than traditional development</span>
</span></code></pre></div></p><p><strong>Week 3: Scale Up</strong><div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1></a><a href=#__codelineno-28-1><span class=linenos data-linenos="1 "></span></a><span class=c1># Take on a significant feature</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2></a><a href=#__codelineno-28-2><span class=linenos data-linenos="2 "></span></a>/backlog<span class=w> </span>add_story<span class=w> </span><span class=s2>&quot;Build multi-tenant workspace system&quot;</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3></a><a href=#__codelineno-28-3><span class=linenos data-linenos="3 "></span></a>/sprint<span class=w> </span>start<span class=w>  </span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4></a><a href=#__codelineno-28-4><span class=linenos data-linenos="4 "></span></a><span class=c1># Experience the power of AI-assisted TDD at scale</span>
</span></code></pre></div></p><p><strong>Month 2: Become the TDD Champion</strong> - Share your success stories with your team - Introduce AI-assisted TDD to new projects - Mentor others in the TDD mindset - Measure and celebrate your quality improvements</p><h3 id=the-transformation-is-real>🌟 The Transformation is Real<a class=headerlink href=#the-transformation-is-real title="Permanent link">&para;</a></h3><p>Six months from now, you'll look back at traditional development the way we now look back at writing code without version control—as something we can't imagine doing anymore.</p><p>Your code will be: - <strong>More reliable</strong> (comprehensive test coverage) - <strong>More maintainable</strong> (clean architecture from refactoring) - <strong>More scalable</strong> (thoughtful design from the start) - <strong>More secure</strong> (AI agents test security scenarios you'd miss)</p><p>Your development process will be: - <strong>Faster</strong> (parallel AI execution) - <strong>Less stressful</strong> (confidence from tests) - <strong>More predictable</strong> (clear metrics and progress tracking) - <strong>More enjoyable</strong> (focus on creativity instead of debugging)</p><h3 id=welcome-to-the-future-of-software-development>🎉 Welcome to the Future of Software Development<a class=headerlink href=#welcome-to-the-future-of-software-development title="Permanent link">&para;</a></h3><p>You've just learned how to develop software the way it was always meant to be developed: with confidence, clarity, and quality built in from the start.</p><p>The age of "code and pray" is over. The age of "test, implement, and ship with confidence" has begun.</p><p>Now go forth and build amazing software. Your AI agents are ready when you are.</p><hr><blockquote><p><em>"The best time to plant a tree was 20 years ago. The second best time is now."</em><br><em>The best time to start practicing TDD was when you first learned to code. The second best time is right now.</em></p></blockquote><p><strong>Start your first AI-assisted TDD cycle today:</strong></p><div class="language-bash highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1></a><a href=#__codelineno-29-1><span class=linenos data-linenos="1 "></span></a>/epic<span class=w> </span><span class=s2>&quot;Building the future with confidence&quot;</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2></a><a href=#__codelineno-29-2><span class=linenos data-linenos="2 "></span></a>/backlog<span class=w> </span>add_story<span class=w> </span><span class=s2>&quot;My first perfectly tested feature&quot;</span>
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3></a><a href=#__codelineno-29-3><span class=linenos data-linenos="3 "></span></a>/sprint<span class=w> </span>start
</span></code></pre></div><p><strong>The adventure begins now. 🚀</strong></p><aside class=md-source-file><span class=md-source-file__fact><span class=md-icon title="Last update"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime" title="June 19, 2025 03:12:57 UTC">June 19, 2025 03:12:57</span></span><span class=md-source-file__fact><span class=md-icon title=Created><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime" title="June 17, 2025 21:28:50 UTC">June 17, 2025 21:28:50</span></span></aside><form class=md-feedback name=feedback hidden><fieldset><legend class=md-feedback__title> Was this page helpful? </legend><div class=md-feedback__inner><div class=md-feedback__list><button class="md-feedback__icon md-icon" type=submit title="This page was helpful" data-md-value=1><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"/></svg></button><button class="md-feedback__icon md-icon" type=submit title="This page could be improved" data-md-value=0><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"/></svg></button></div><div class=md-feedback__note><div data-md-value=1 hidden> Thanks for your feedback! </div><div data-md-value=0 hidden> Thanks for your feedback! Help us improve this page by <a href="https://github.com/jmontp/agent-workflow/issues/new/?title=[Feedback]+%F0%9F%A7%AA%20TDD%20Workflow+-+/user-guide/tdd-workflow/" target=_blank rel=noopener>telling us what you found confusing</a>. </div></div></div></fieldset></form></article></div><script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script><script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script></div><button type=button class="md-top md-icon" data-md-component=top hidden><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button></main><footer class=md-footer><nav class="md-footer__inner md-grid" aria-label=Footer><a href=../state-machine/ class="md-footer__link md-footer__link--prev" aria-label="Previous: 🔄 State Machine"><div class="md-footer__button md-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M15.41 16.58 10.83 12l4.58-4.59L14 6l-6 6 6 6z"/></svg></div><div class=md-footer__title><span class=md-footer__direction> Previous </span><div class=md-ellipsis> 🔄 State Machine </div></div></a><a href=../multi-project-orchestration/ class="md-footer__link md-footer__link--next" aria-label="Next: 🎯 Multi-Project Orchestration"><div class=md-footer__title><span class=md-footer__direction> Next </span><div class=md-ellipsis> 🎯 Multi-Project Orchestration </div></div><div class="md-footer__button md-icon"><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58 13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg></div></a></nav><div class="md-footer-meta md-typeset"><div class="md-footer-meta__inner md-grid"><div class=md-copyright></div><div class=md-social><a href=https://github.com/jmontp/agent-workflow target=_blank rel=noopener title="GitHub Repository" class=md-social__link><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"/></svg></a><a href=https://jmontp.github.io/agent-workflow/ target=_blank rel=noopener title="Documentation Site" class=md-social__link><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m19 2-5 4.5v11l5-4.5zM6.5 5C4.55 5 2.45 5.4 1 6.5v14.66c0 .25.25.5.5.5.1 0 .15-.07.25-.07 1.35-.65 3.3-1.09 4.75-1.09 1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.31 4.75 1.06.1.05.15.03.25.03.25 0 .5-.25.5-.5V6.5c-.6-.45-1.25-.75-2-1V19c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V6.5C10.55 5.4 8.45 5 6.5 5"/></svg></a><a href=https://discord.gg/your-discord-server target=_blank rel=noopener title="Discord Community" class=md-social__link><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 3c5.5 0 10 3.58 10 8s-4.5 8-10 8c-1.24 0-2.43-.18-3.53-.5C5.55 21 2 21 2 21c2.33-2.33 2.7-3.9 2.75-4.5C3.05 15.07 2 13.13 2 11c0-4.42 4.5-8 10-8"/></svg></a><a href=https://github.com/sponsors/jmontp target=_blank rel=noopener title=Sponsor class=md-social__link><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m12 21.35-1.45-1.32C5.4 15.36 2 12.27 2 8.5 2 5.41 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.08C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.41 22 8.5c0 3.77-3.4 6.86-8.55 11.53z"/></svg></a></div></div></div></footer></div><div class=md-dialog data-md-component=dialog><div class="md-dialog__inner md-typeset"></div></div><div class=md-progress data-md-component=progress role=progressbar></div><div class=md-consent data-md-component=consent id=__consent hidden><div class=md-consent__overlay></div><aside class=md-consent__inner><form class="md-consent__form md-grid md-typeset" name=consent><h4>Cookie consent</h4><p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p><input class=md-toggle type=checkbox id=__settings><div class=md-consent__settings><ul class=task-list><li class=task-list-item><label class=task-list-control><input type=checkbox name=analytics checked><span class=task-list-indicator></span> Google Analytics </label></li><li class=task-list-item><label class=task-list-control><input type=checkbox name=github checked><span class=task-list-indicator></span> GitHub </label></li></ul></div><div class=md-consent__controls><button class="md-button md-button--primary">Accept</button><button type=reset class="md-button md-button--primary">Reject</button><label class=md-button for=__settings>Manage settings</label></div></form></aside></div><script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script><script id=__config type=application/json>{"base": "../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.code.select", "content.footnote.tooltips", "content.tabs.link", "content.tooltips", "header.autohide", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": {"API": "api", "Architecture": "architecture", "CSS": "css", "Discord": "discord", "HTML5": "html", "JavaScript": "js", "Python": "python", "Scrum": "scrum", "TDD": "tdd"}, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "stable", "provider": "mike"}}</script><script src=../../assets/javascripts/bundle.13a4f30d.min.js></script><script src=https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mtml-chtml.js></script><script src=../../js/mermaid-zoom.js></script><script src=../../js/universal-search.js></script><script src=../../js/enhanced-navigation.js></script><script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body></html>